- en: 24\. Creating KVM Virtual Machines on Ubuntu 23.04 using Cockpit
  prefs: []
  type: TYPE_NORMAL
- en: KVM-based virtual machines can easily be configured on Ubuntu using the virt-install
    command-line tool, the virt-manager GUI tool, or the Virtual Machines module of
    the Cockpit web console. This chapter will use Cockpit to install an operating
    system as a KVM guest on an Ubuntu host. The chapter titled [“Creating KVM Virtual
    Machines on Ubuntu 23.04 using virt-manager”](KVM_virt-manager.xhtml#_idTextAnchor389)
    will cover using the virt-manager tool to create new virtual machines.
  prefs: []
  type: TYPE_NORMAL
- en: The next chapter, [“Creating KVM Virtual Machines with virt-install and virsh”](KVM_Create_VM_Command-line.xhtml#_idTextAnchor400)
    will cover the command-line approach to virtual machine creation.
  prefs: []
  type: TYPE_NORMAL
- en: 24.1 Installing the Cockpit Virtual Machines Module
  prefs: []
  type: TYPE_NORMAL
- en: 'The virtual machines module may not be included in a standard Cockpit installation
    by default. Assuming that Cockpit is installed and configured, the virtual machines
    module may be installed as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: apt install cockpit-machines
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Once installed, the Virtual Machines option (marked A in [Figure 24-1](KVM_Create_VM.xhtml#_idTextAnchor377))
    will appear in the navigation panel the next time you log into the Cockpit interface:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cockpit_virtual_machines.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-1
  prefs: []
  type: TYPE_NORMAL
- en: 24.2 Creating a Virtual Machine in Cockpit
  prefs: []
  type: TYPE_NORMAL
- en: To create a virtual machine in Cockpit, click the Create VM button marked B
    in [Figure 24-1](KVM_Create_VM.xhtml#_idTextAnchor377) to display the creation
    dialog.
  prefs: []
  type: TYPE_NORMAL
- en: Within the dialog, enter a name for the machine and choose whether the installation
    media is in the form of an ISO accessible via a URL or a local filesystem path,
    or select the vendor and operating system type information for the guest request
    and choose the Download an OS option to have the installation image downloaded
    automatically during the installation process.
  prefs: []
  type: TYPE_NORMAL
- en: 'Also, specify the size of the virtual disk drive to be used for the operating
    system installation and the amount of memory to be allocated to the virtual machine:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ubuntu_cockpit_create_vm.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-2
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on the Create and edit button to build the virtual machine. After the
    creation process is complete, select the new VM from the list to display the configuration
    details, as shown in [Figure 24-3](KVM_Create_VM.xhtml#_idTextAnchor380):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_cockpit_vm_overview.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-3
  prefs: []
  type: TYPE_NORMAL
- en: 'As described in [“An Overview of Virtualization Techniques”](Virtualization_Overview.xhtml#_idTextAnchor361)
    KVM provides virtual machines with several options in terms of network configuration.
    To view and change the network settings of a virtual machine, scroll down to the
    Network interfaces section of the VM Overview screen and click the Edit button:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ubuntu_cockpit_vm_network_interfaces.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-4
  prefs: []
  type: TYPE_NORMAL
- en: In the resulting dialog, the Network Type menu may be used to change the type
    of network connection, for example, from Virtual network (NAT) to direct attachment
    (MacVTap) or Bridge to LAN.
  prefs: []
  type: TYPE_NORMAL
- en: 24.3 Starting the Installation
  prefs: []
  type: TYPE_NORMAL
- en: 'To start the new virtual machine and install the guest operating system from
    the designated installation media, click the Install button at the top of the
    overview page. Cockpit will start the virtual machine and update Console view
    where the guest OS screen will appear:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ubuntu_cockpit_vm_running.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-5
  prefs: []
  type: TYPE_NORMAL
- en: 'If the installation fails, check the message to see if an error occurred when
    opening the installation image. This usually occurs because the QEMU emulator
    runs as a user named qemu, which does not have access to the directory in which
    the ISO installation image is located. To resolve this issue, open a terminal
    window (or connect with SSH if the system is remote), change directory to the
    location of the ISO image file, and add the libvirt-qemu user to the access control
    list (ACL) of the parent directory as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: cd /path/to/iso/directory
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: setfacl -m u:libvirt-qemu:x ..
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'After making this change, check the setting as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: getfacl ..
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'file: ..'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'owner: demo'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'group: demo'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: user::rwx
  prefs: []
  type: TYPE_NORMAL
- en: user:libvirt-qemu:--x
  prefs: []
  type: TYPE_NORMAL
- en: group::r-x
  prefs: []
  type: TYPE_NORMAL
- en: mask::r-x
  prefs: []
  type: TYPE_NORMAL
- en: other::---
  prefs: []
  type: TYPE_NORMAL
- en: Once these changes have been made, click the Install button again to complete
    the installation.
  prefs: []
  type: TYPE_NORMAL
- en: To complete the installation, interact with the screen in the Consoles view
    just as you would if you were installing the operating system on physical hardware.
    If the console is too small to accommodate the entire guest operating system screen,
    click the Expand button in the top right-hand corner.
  prefs: []
  type: TYPE_NORMAL
- en: 'It is also possible to connect with and display the graphical console for the
    VM from outside the Cockpit browser session using the virt-viewer tool. To install
    virt-viewer on an Ubuntu system, run the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: apt install virt-viewer
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The virt-viewer tool is also available for Windows systems and can be downloaded
    from the following URL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[https://virt-manager.org/download/](https://virt-manager.org/download/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'To connect with a virtual machine running on the local host, run virt-viewer
    and select the virtual machine to which you wish to connect from the resulting
    dialog:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ubuntu-virt-viewer_vm_list.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-6
  prefs: []
  type: TYPE_NORMAL
- en: 'The above command will list system-based virtual machines. To list and access
    session-based guests, launch virt-viewer as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: $ virt-viewer --connect qemu:///session
  prefs: []
  type: TYPE_NORMAL
- en: 'Alternatively, it is also possible to specify the virtual machine name and
    bypass the selection dialog entirely, for example:'
  prefs: []
  type: TYPE_NORMAL
- en: virt-viewer demo-vm-guest
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To connect a virt-viewer instance to a virtual machine running on a remote
    host using SSH, the following command can be used:'
  prefs: []
  type: TYPE_NORMAL
- en: $ virt-viewer --connect qemu+ssh://<user>@<host>/system <guest name>
  prefs: []
  type: TYPE_NORMAL
- en: 'For example:'
  prefs: []
  type: TYPE_NORMAL
- en: $ virt-viewer --connect qemu+ssh://root@192.168.1.122/system demo_vm_guest
  prefs: []
  type: TYPE_NORMAL
- en: When using this technique, it is important to note that you will be prompted
    twice for the user password before the connection is fully established.
  prefs: []
  type: TYPE_NORMAL
- en: Once the virtual machine has been created, the Cockpit interface can monitor
    the machine and perform tasks such as rebooting, shutting down, or deleting the
    guest system. An option is also included on the Disks panel to add disks to the
    virtual machine configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 24.4 Working with Storage Volumes and Storage Pools
  prefs: []
  type: TYPE_NORMAL
- en: When a virtual machine is created, it will usually have at least one virtual
    disk drive. The images that represent these virtual disk drives are stored in
    storage pools. A storage pool can be an existing directory on a local filesystem,
    a filesystem partition, a physical disk device, Logical Volume Management (LVM)
    volume group, or even a remote network file system (NFS).
  prefs: []
  type: TYPE_NORMAL
- en: Each storage pool is divided into one or more storage volumes. Storage volumes
    are typically individual image files, each representing a single virtual disk
    drive, but they can also take the form of physical disk partitions, entire disk
    drives, or LVM volume groups.
  prefs: []
  type: TYPE_NORMAL
- en: When a virtual machine was created using the previous steps, a default storage
    pool was created to store virtual machine images. This default storage pool occupies
    space on the root filesystem and can be reviewed from within the Cockpit Virtual
    Machine interface by selecting the Storage Pools option at the top of the panel
    marked C in [Figure 24-1](KVM_Create_VM.xhtml#_idTextAnchor377) above.
  prefs: []
  type: TYPE_NORMAL
- en: 'When selected, the screen shown in [Figure 24-7](KVM_Create_VM.xhtml#_idTextAnchor384)
    below will appear containing a list of storage pools currently configured on the
    system:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_cockpit_vm_storage_pools.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-7
  prefs: []
  type: TYPE_NORMAL
- en: 'In the above example, the default storage pool is located on the root filesystem
    and stores the virtual machine image in the /var/lib/libvirtd/images directory.
    To view the storage volumes contained within the pool, select the Storage Volumes
    tab highlighted in [Figure 24-8](KVM_Create_VM.xhtml#_idTextAnchor385):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cockpit_virtual_machines_storage_pools.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-8
  prefs: []
  type: TYPE_NORMAL
- en: 'In the case of the demo guest, the storage volume takes the form of an image
    file named demo-vm-guest.qcow2\. In addition, the pool also includes a storage
    volume containing the installation ISO image. To find out which storage volume
    a particular virtual machine uses, return to the main Virtual Machine Cockpit
    screen, select the virtual machine, and scroll to the Disks panel, as shown in
    [Figure 24-9](KVM_Create_VM.xhtml#_idTextAnchor386):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ubuntu_cockpit_vm_disks.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-9
  prefs: []
  type: TYPE_NORMAL
- en: 'Although using the default storage pool is acceptable for testing purposes
    and early experimentation, it is recommended that additional pools be created
    for general virtualization use. To create a new storage pool, display the Storage
    Pools screen within Cockpit and click on the Create storage pool button to display
    the dialog shown in [Figure 24-10](KVM_Create_VM.xhtml#_idTextAnchor387):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_cockpit_vm_create_pool.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 24-10
  prefs: []
  type: TYPE_NORMAL
- en: In the above example, a new storage pool is being created named MyPool using
    a file system partition mounted as /MyPool within the local filesystem (the topic
    of disk drives, partitions, and mount points is covered later in the chapter entitled
    [“Adding a New Disk Drive to an Ubuntu 23.04 System”](Adding_New_DIsk.xhtml#_idTextAnchor494)).
    Once created, the pool will be listed within the Cockpit storage pool screen and
    can contain storage volumes as new virtual machines are created.
  prefs: []
  type: TYPE_NORMAL
- en: 24.5 Summary
  prefs: []
  type: TYPE_NORMAL
- en: This chapter has outlined using the Cockpit web-based interface to create and
    manage KVM-based virtual machines. The Cockpit interface has the advantage of
    not requiring access to a desktop environment running on the host system. An alternative
    option is using the virt-manager graphical tool outlined in the next chapter.
  prefs: []
  type: TYPE_NORMAL
