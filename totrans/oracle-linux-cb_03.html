<html><head></head><body>
<div id="_idContainer083">
<h1 class="chapter-number" id="_idParaDest-70"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 id="_idParaDest-71"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.2.1">Exploring the Various Boot Options and Kernels in Oracle Linux</span></h1>
<p><a id="_idTextAnchor077"/><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.3.1">This chapter will teach you about </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">boot</span></strong><span class="koboSpan" id="kobo.5.1"> and its options, kernels, and more. </span><span class="koboSpan" id="kobo.5.2">You will also learn about many exciting opportunities, tools, and applications to make your life easier and more enjoyable. </span><span class="koboSpan" id="kobo.5.3">For example, you will learn how to change your booting kernel and remove and reinstall a kernel on your system. </span><span class="koboSpan" id="kobo.5.4">You will even learn how to use the boot process to switch between </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">Linux kernels.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">Booting involves more than just loading the operating system; it also helps secure the system using Secure Boot </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">or TrenchBoot.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">This chapter has the </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Kernel basics – UEK </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">and RHCK</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Playing </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">with UEFI</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Playing with </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">Secure Boot</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">TrenchBoot – improving boot security </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">and integrity</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Removing </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">the RHCK</span></span></li>
</ul>
<h1 id="_idParaDest-72"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.21.1">Kernel basics – UEK and RHCK</span></h1>
<p><span class="koboSpan" id="kobo.22.1">Before we get started with UEK and RHCK, let's understand what is a Linux kernel. </span><span class="koboSpan" id="kobo.22.2">A Linux kernel </span><a id="_idIndexMarker158"/><span class="koboSpan" id="kobo.23.1">release refers to an updated version of the core component of</span><a id="_idIndexMarker159"/><span class="koboSpan" id="kobo.24.1"> the Linux operating system. </span><span class="koboSpan" id="kobo.24.2">Its main function is to act as a bridge between the hardware and software layers of a computer system. </span><span class="koboSpan" id="kobo.24.3">The Linux kernel is a collaborative development effort by a large community of developers worldwide, with Linus Torvalds as the original creator and official maintainer of the mainline kernel. </span><span class="koboSpan" id="kobo.24.4">These kernel updates are introduced periodically to provide new features, improvements, bug fixes, security patches, and </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">hardware support.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">Linux kernel releases are assigned a version number that consists of three components: major version, minor version, and patch level. </span><span class="koboSpan" id="kobo.26.2">For instance, a kernel version is represented as X.Y.Z, where X represents the major version, Y is the minor version, and Z is the patch level. </span><span class="koboSpan" id="kobo.26.3">The major version is usually incremented for significant changes that may affect compatibility, while the minor version and patch level represent incremental updates and </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">bug fixes.</span></span></p>
<p><span class="koboSpan" id="kobo.28.1">Linux kernel </span><a id="_idIndexMarker160"/><span class="koboSpan" id="kobo.29.1">releases are distributed as source code, and various distributions</span><a id="_idIndexMarker161"/><span class="koboSpan" id="kobo.30.1"> or operating systems based on Linux typically package and distribute their own versions of the kernel, incorporating it into their respective releases. </span><span class="koboSpan" id="kobo.30.2">In addition, users who want to compile and install the kernel directly on their systems can access the source code. </span><span class="koboSpan" id="kobo.30.3">The following table shows the Linux kernel mainline releases for Linux 7, 8, </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">and 9.</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-3">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.32.1">OS Version</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.33.1">RHCK Release</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.34.1">Latest </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.35.1">UEK Release</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.36.1">Linux 7</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.37.1">Linux 3.x</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.38.1">UEK </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">6/Linux 5.4</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.40.1">Linux 8</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.41.1">Linux 4.x</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.42.1">UEK </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">7/Linux 5.15</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.44.1">Linux 9</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.45.1">Linux 5.14</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.46.1">UEK </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">7/Linux 5.15</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.48.1">Table 3.1 – Available Kernel options by release</span></p>
<h1 id="_idParaDest-73"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.49.1">Kernel basics – UEK and RHCK</span></h1>
<p><span class="koboSpan" id="kobo.50.1">With a fresh</span><a id="_idIndexMarker162"/><span class="koboSpan" id="kobo.51.1"> installation of</span><a id="_idIndexMarker163"/><span class="koboSpan" id="kobo.52.1"> Oracle Linux, the </span><strong class="bold"><span class="koboSpan" id="kobo.53.1">Unbreakable Enterprise Kernel</span></strong><span class="koboSpan" id="kobo.54.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.55.1">UEK</span></strong><span class="koboSpan" id="kobo.56.1">) is the default. </span><span class="koboSpan" id="kobo.56.2">However, in some cases, you may want to </span><a id="_idIndexMarker164"/><span class="koboSpan" id="kobo.57.1">switch to the </span><strong class="bold"><span class="koboSpan" id="kobo.58.1">Red Hat Compatible </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.59.1">Kernel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.60.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.61.1">RHCK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">The default </span><a id="_idIndexMarker165"/><span class="koboSpan" id="kobo.64.1">kernel might not be the correct version to use in </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">some scenarios:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.66.1">UEK releases are based on newer kernel releases than the </span><strong class="bold"><span class="koboSpan" id="kobo.67.1">RHCK</span></strong><span class="koboSpan" id="kobo.68.1"> version, which is the standard for Red Hat servers. </span><span class="koboSpan" id="kobo.68.2">With Oracle Linux, you have the option to use the UEK, which provides a more up-to-date </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">kernel release.</span></span></li>
<li><span class="koboSpan" id="kobo.70.1">The current kernel version might be incompatible with your particular hardware. </span><span class="koboSpan" id="kobo.70.2">A UEK system will boot on new hardware, while the older RHCK will not. </span><span class="koboSpan" id="kobo.70.3">An example of this is UEK 7, which supports the </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">Microsoft Azure Network Adapter</span></strong><span class="koboSpan" id="kobo.72.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.73.1">MANA</span></strong><span class="koboSpan" id="kobo.74.1">), whereas UEK 6 </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">does not.</span></span></li>
<li><span class="koboSpan" id="kobo.76.1">Suppose a </span><a id="_idIndexMarker166"/><span class="koboSpan" id="kobo.77.1">UEK beta or technical preview release is installed on the system. </span><span class="koboSpan" id="kobo.77.2">In that case, UEK needs to be demoted to ensure that the kernel is used only if intentionally and manually selected as the boot kernel by </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">an administra</span><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.79.1">tor.</span></span></li>
<li><span class="koboSpan" id="kobo.80.1">The UEK for Oracle Linux provides many advantages, such as significant performance improvements and new features. </span><span class="koboSpan" id="kobo.80.2">The Linux operating system is a modular system in which the kernel interacts with the hardware and controls and schedules access to resources on behalf of applications. </span><span class="koboSpan" id="kobo.80.3">Most applications run in what is called user space and call only a stable set of system libraries to ask for kernel services. </span><span class="koboSpan" id="kobo.80.4">The exceptions are applications that directly access the kernel, most commonly </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">security applications.</span></span></li>
<li><span class="koboSpan" id="kobo.82.1">Installing the UEK does not change system libraries such as glibc, which is the interface</span><a id="_idIndexMarker167"/><span class="koboSpan" id="kobo.83.1"> that nearly all applications, including Oracle</span><a id="_idIndexMarker168"/><span class="koboSpan" id="kobo.84.1"> Database, use. </span><span class="koboSpan" id="kobo.84.2">The glibc version</span><a id="_idIndexMarker169"/><span class="koboSpan" id="kobo.85.1"> is the same whether you run Oracle Linux with the UEK or with the RHCK. </span><span class="koboSpan" id="kobo.85.2">This is not limited to just gloc, but is the case for all system libraries, such as libssl, libcurl, </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">and libcrypt.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.87.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.88.1">Multiple versions of the UEK may be available for any baseline operating system release. </span><span class="koboSpan" id="kobo.88.2">Choosing the version of the UEK is up to the application team and must reflect any </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">compatibility requirements.</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">These examples and similar cases require you to switch between kernel types. </span><span class="koboSpan" id="kobo.90.2">In older releases, managing the default kernel was performed by configuring the GRUB boot loader. </span><span class="koboSpan" id="kobo.90.3">However, with Oracle Linux 8 and later, you should use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">grubby</span></strong><span class="koboSpan" id="kobo.92.1"> command to control and manage the configuration for booting the kernel. </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">grubby</span></strong><span class="koboSpan" id="kobo.94.1"> is part of the </span><strong class="bold"><span class="koboSpan" id="kobo.95.1">Grand Unified Bootloader version 2</span></strong><span class="koboSpan" id="kobo.96.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.97.1">GRUB 2</span></strong><span class="koboSpan" id="kobo.98.1">) boot loader, which is available from the </span><a id="_idIndexMarker170"/><span class="koboSpan" id="kobo.99.1">GNU project. </span><span class="koboSpan" id="kobo.99.2">GRUB is the default bootloader for many Linux distributions on the market. </span><span class="koboSpan" id="kobo.99.3">After loading it into memory, it transfers control to the operating </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">system kernel.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">GRUB 2 is the default bootloader program used on Oracle Linux, and it can load many different operating systems, including </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">Microsoft Windows.</span></span></p>
<h2 id="_idParaDest-74"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.103.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.104.1">Let’s start by looking deeper at the boot process to better </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">understand it.</span></span></p>
<h3><span class="koboSpan" id="kobo.106.1">The boot process</span></h3>
<p><span class="koboSpan" id="kobo.107.1">You</span><a id="_idIndexMarker171"/><span class="koboSpan" id="kobo.108.1"> have an understanding of how Oracle Linux boot options help you troubleshoot problems encountered when booting the system. </span><span class="koboSpan" id="kobo.108.2">This knowledge is beneficial when using new hardware or </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">cloud environments.</span></span></p>
<p><span class="koboSpan" id="kobo.110.1">As an Oracle Linux system boots, it performs many tasks that may change depending on the type of firmware your hardware uses to handle the system boot. </span><span class="koboSpan" id="kobo.110.2">It could be </span><strong class="bold"><span class="koboSpan" id="kobo.111.1">Unified Extensible Firmware Interface</span></strong><span class="koboSpan" id="kobo.112.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.113.1">UEFI</span></strong><span class="koboSpan" id="kobo.114.1">) firmware or legacy BIOS firmware. </span><span class="koboSpan" id="kobo.114.2">The legacy</span><strong class="bold"><span class="koboSpan" id="kobo.115.1"> Basic Input/Output System</span></strong><span class="koboSpan" id="kobo.116.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.117.1">BIOS</span></strong><span class="koboSpan" id="kobo.118.1">) firmware is a legacy </span><a id="_idIndexMarker172"/><span class="koboSpan" id="kobo.119.1">boot process that uses BIOS firmware. </span><span class="koboSpan" id="kobo.119.2">The BIOS maintains a list of bootable devices and the order of devices from which a boot is attempted. </span><span class="koboSpan" id="kobo.119.3">This</span><a id="_idIndexMarker173"/><span class="koboSpan" id="kobo.120.1"> data is stored in a </span><strong class="bold"><span class="koboSpan" id="kobo.121.1">Complementary Metal-Oxide Semiconductor </span></strong><span class="koboSpan" id="kobo.122.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.123.1">CMOS</span></strong><span class="koboSpan" id="kobo.124.1">) chip on the system, requiring a battery to keep the settings when the system is not powered. </span><span class="koboSpan" id="kobo.124.2">Systems using a BIOS boot process are generally old systems, although even a modern system may still use a BIOS. </span><span class="koboSpan" id="kobo.124.3">A more popular option on modern servers is UEFI-based firmware. </span><span class="koboSpan" id="kobo.124.4">It also manages the boot process on a server but stores the boot process (initialization and startup) in a boot loader executable </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">.efi</span></strong><span class="koboSpan" id="kobo.126.1"> file in a particular partition on the system’s drive. </span><span class="koboSpan" id="kobo.126.2">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">.efi</span></strong><span class="koboSpan" id="kobo.128.1"> file gives a user more control of the boot process, including the ability to take advantage of new security features. </span><span class="koboSpan" id="kobo.128.2">An example of a new security feature is Secure Boot, which is covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">this chapter.</span></span></p>
<h3><span class="koboSpan" id="kobo.130.1">The UEFI-based booting sequence</span></h3>
<p><span class="koboSpan" id="kobo.131.1">The following </span><a id="_idIndexMarker174"/><span class="koboSpan" id="kobo.132.1">sequence order is used by UEFI-based </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">booti</span><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.134.1">ng hardware:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.135.1">The system first</span><a id="_idIndexMarker175"/><span class="koboSpan" id="kobo.136.1"> performs a </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">power-on self-test</span></strong><span class="koboSpan" id="kobo.138.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.139.1">POST</span></strong><span class="koboSpan" id="kobo.140.1">), which identifies the system’s configuration and all possible </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">boot identifiers.</span></span></li>
<li><span class="koboSpan" id="kobo.142.1">UEFI searches </span><a id="_idIndexMarker176"/><span class="koboSpan" id="kobo.143.1">for a </span><strong class="bold"><span class="koboSpan" id="kobo.144.1">GUID Partition Table</span></strong><span class="koboSpan" id="kobo.145.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.146.1">GPT</span></strong><span class="koboSpan" id="kobo.147.1">) partition with a </span><a id="_idIndexMarker177"/><span class="koboSpan" id="kobo.148.1">specific </span><strong class="bold"><span class="koboSpan" id="kobo.149.1">Globally Unique Identifier</span></strong><span class="koboSpan" id="kobo.150.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.151.1">GUID</span></strong><span class="koboSpan" id="kobo.152.1">) that identifies it as the </span><strong class="bold"><span class="koboSpan" id="kobo.153.1">EFI System Partition</span></strong><span class="koboSpan" id="kobo.154.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.155.1">ESP</span></strong><span class="koboSpan" id="kobo.156.1">), containing</span><a id="_idIndexMarker178"/> <strong class="bold"><span class="koboSpan" id="kobo.157.1">Extensible Firmware Interface</span></strong><span class="koboSpan" id="kobo.158.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.159.1">EFI</span></strong><span class="koboSpan" id="kobo.160.1">) applications such as booters. </span><span class="koboSpan" id="kobo.160.2">If there are multiple boot devices, the UEFI boot manager determines the appropriate ESP based on the order defined in the boot manager. </span><span class="koboSpan" id="kobo.160.3">With the </span><strong class="bold"><span class="koboSpan" id="kobo.161.1">efibootmgr</span></strong><span class="koboSpan" id="kobo.162.1"> tool, you</span><a id="_idIndexMarker179"/><span class="koboSpan" id="kobo.163.1"> can specify a different order if you do not use the </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">default definition.</span></span></li>
<li><span class="koboSpan" id="kobo.165.1">The</span><a id="_idIndexMarker180"/><span class="koboSpan" id="kobo.166.1"> UEFI boot manager checks whether Secure Boot is enabled. </span><span class="koboSpan" id="kobo.166.2">If Secure Boot is not enabled, the boot manager runs the GRUB 2 boot loader on the ESP. </span><span class="koboSpan" id="kobo.166.3">Otherwise, the boot manager requests a certificate from the boot loader and validates this against keys stored in the UEFI Secure Boot key database. </span><span class="koboSpan" id="kobo.166.4">The environment is configured to perform a two-stage boot process, and the shim to handle the certificate validation </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">process.efi</span></strong><span class="koboSpan" id="kobo.168.1"> application that is responsible for the certification is loaded first before loading the GRUB 2 boot loader. </span><span class="koboSpan" id="kobo.168.2">If the certificate is valid, the boot loader runs and, in turn, validates the kernel that it is configured </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">to load.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.170.1">The boot loader first loads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">vmlinuz</span></strong><span class="koboSpan" id="kobo.172.1"> kernel image into memory and then creates a temporary RAM-based filesystem called </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">tmpfs</span></strong><span class="koboSpan" id="kobo.174.1">. </span><span class="koboSpan" id="kobo.174.2">This is then used to extract the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">initramfs</span></strong><span class="koboSpan" id="kobo.176.1"> image file. </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">vmlinuz</span></strong><span class="koboSpan" id="kobo.178.1"> is the name of the bootable compressed Linux kernel executable. </span><span class="koboSpan" id="kobo.178.2">The root filesystem embedded into the Linux kernel and loaded early in the boot process is </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">initramfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">.</span></span></p></li>
<li><span class="koboSpan" id="kobo.182.1">Driver modules are then loaded from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">initramfs</span></strong><span class="koboSpan" id="kobo.184.1"> filesystem. </span><span class="koboSpan" id="kobo.184.2">These are needed to allow the kernel to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">root filesystem.</span></span></li>
<li><span class="koboSpan" id="kobo.186.1">The system then starts with the first process, systemd. </span><span class="koboSpan" id="kobo.186.2">All future processes spawn from this process. </span><span class="koboSpan" id="kobo.186.3">The systemd process will always have a process ID </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">of 1.</span></span></li>
<li><span class="koboSpan" id="kobo.188.1">The systemd process </span><a id="_idIndexMarker181"/><span class="koboSpan" id="kobo.189.1">will run any additional processes defined for it. </span><span class="koboSpan" id="kobo.189.2">You can specify any other actions to be processed during the boot process by defining your systemd unit. </span><span class="koboSpan" id="kobo.189.3">This method is advised to be used instead of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">/etc/rc. </span><span class="koboSpan" id="kobo.190.2">local</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.191.1">file approach.</span></span></li>
</ol>
<h3><span class="koboSpan" id="kobo.192.1">The legacy BIOS sequence</span></h3>
<p><span class="koboSpan" id="kobo.193.1">Legacy</span><a id="_idIndexMarker182"/><span class="koboSpan" id="kobo.194.1"> BIOS booting hardware uses the following </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">sequence order:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.196.1">The system first performs a POST, which identifies the configuration of the system, tests memory, and identifies all possible </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">boot devices.</span></span></li>
<li><span class="koboSpan" id="kobo.198.1">Once the BIOS has identified the boot device, it reads the first sector of the device, which is</span><a id="_idIndexMarker183"/><span class="koboSpan" id="kobo.199.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.200.1">Master Boot Record</span></strong><span class="koboSpan" id="kobo.201.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.202.1">MBR</span></strong><span class="koboSpan" id="kobo.203.1">). </span><span class="koboSpan" id="kobo.203.2">The MBR contains the boot loader, which is a small program that is responsible for loading the operating system. </span><span class="koboSpan" id="kobo.203.3">The MBR reads the partition table, to determine the boot partition. </span><span class="koboSpan" id="kobo.203.4">Additionally, the MBR includes the pointer to the boot loader program called GRUB 2. </span><span class="koboSpan" id="kobo.203.5">GRUB can then run a boot on the same device that GRUB is installed on or a separate device. </span><span class="koboSpan" id="kobo.203.6">This is helpful when multi-booting the same system with both Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">and Windows.</span></span></li>
<li><span class="koboSpan" id="kobo.205.1">The boot loader first loads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">vmlinuz</span></strong><span class="koboSpan" id="kobo.207.1"> kernel image into memory and then creates a temporary RAM-based filesystem called </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">tmpfs</span></strong><span class="koboSpan" id="kobo.209.1">. </span><span class="koboSpan" id="kobo.209.2">This is then used to extract the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">initramfs</span></strong><span class="koboSpan" id="kobo.211.1"> image file. </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">vmlinuz</span></strong><span class="koboSpan" id="kobo.213.1"> is the name of the bootable compressed Linux kernel executable. </span><span class="koboSpan" id="kobo.213.2">The root filesystem embedded in the Linux kernel and loaded early in the boot process is </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">called initramfs.</span></span></li>
<li><span class="koboSpan" id="kobo.215.1">Driver modules are then loaded from the initramfs filesystem. </span><span class="koboSpan" id="kobo.215.2">These modules are needed to allow the kernel to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">root filesystem.</span></span></li>
<li><span class="koboSpan" id="kobo.217.1">The kernel then starts the </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">systemd process.</span></span></li>
<li><span class="koboSpan" id="kobo.219.1">The systemd process runs any other processes defined for it. </span><span class="koboSpan" id="kobo.219.2">You can specify any additional actions to be processed during the boot process by defining your systemd unit. </span><span class="koboSpan" id="kobo.219.3">This method</span><a id="_idIndexMarker184"/><span class="koboSpan" id="kobo.220.1"> is recommended instead of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">/etc/rc. </span><span class="koboSpan" id="kobo.221.2">local</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.222.1">file approach.</span></span></li>
</ol>
<h2 id="_idParaDest-75"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.223.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.224.1">Now that we have discussed the basics, we can leave behind all the boring parts and get to the action. </span><span class="koboSpan" id="kobo.224.2">It is time to play </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">and learn!</span></span></p>
<p><span class="koboSpan" id="kobo.226.1">One of the first things we can do is determine the currently loaded kernel in our system. </span><span class="koboSpan" id="kobo.226.2">The following command will display all kernels that are installed and configured within our Linux system (please run </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">as root):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.228.1">
# grubby -–info=ALL</span></pre> <p><span class="koboSpan" id="kobo.229.1">Here is one</span><a id="_idIndexMarker185"/><span class="koboSpan" id="kobo.230.1"> example of </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.232.1"><img alt="Figure 3.1 – grubby output" src="image/B18349_03_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.233.1">Figure 3.1 – grubby output</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.234.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.235.1">The sample is done using an Arm system, hence the </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">aarch64</span></strong><span class="koboSpan" id="kobo.237.1"> suffix. </span><span class="koboSpan" id="kobo.237.2">x86_64 systems will show </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">x86_64</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.239.1"> suffixes.</span></span></p>
<p><span class="koboSpan" id="kobo.240.1">We can also determine the default kernel in use by executing the </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.242.1">
#grubby -–info=DEFAULT</span></pre> <p><span class="koboSpan" id="kobo.243.1">Here is one example of </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">an output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<span class="koboSpan" id="kobo.245.1"><img alt="Figure 3.2 – grubby default kernel" src="image/B18349_03_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.246.1">Figure 3.2 – grubby default kernel</span></p>
<p><span class="koboSpan" id="kobo.247.1">We can configure</span><a id="_idIndexMarker186"/><span class="koboSpan" id="kobo.248.1"> a specific kernel to be used as the default boot kernel by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.250.1">
#grubby –-set-default &lt;Kernel&gt;</span></pre> <p><span class="koboSpan" id="kobo.251.1">Here is one example of using the preceding command to change the default kernel in use. </span><span class="koboSpan" id="kobo.251.2">Knowing that RHCK is going to be a version 4 kernel, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">4.18.0-425.13.1.el8_7.x86_64</span></strong><span class="koboSpan" id="kobo.253.1">. </span><span class="koboSpan" id="kobo.253.2">Next, we need to point to the file in </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">/boot</span></strong><span class="koboSpan" id="kobo.255.1">, adding </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">vmlinuz-</span></strong><span class="koboSpan" id="kobo.257.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">the name.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer061">
<span class="koboSpan" id="kobo.259.1"><img alt="Figure 3.3 – Changing the default kernel with grubby" src="image/B18349_03_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.260.1">Figure 3.3 – Changing the default kernel with grubby</span></p>
<p><span class="koboSpan" id="kobo.261.1">Another</span><a id="_idIndexMarker187"/><span class="koboSpan" id="kobo.262.1"> possible use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">grubby</span></strong><span class="koboSpan" id="kobo.264.1"> command is to use it to update a kernel configuration entry or to add or remove boot arguments that should be passed to the kernel by default; the following is one example of it. </span><span class="koboSpan" id="kobo.264.2">But first, we will show all the information about a specific kernel in </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">the system:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.266.1">
[root@ol8 # grubby --info=/boot/vmlinuz-0-rescue-c32316cc4b5241b8adb312707ae46458</span></pre> <p><span class="koboSpan" id="kobo.267.1">This will show the details for the specified kernel, including the patch to the kernel and </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">any arguments:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer062">
<span class="koboSpan" id="kobo.269.1"><img alt="Figure 3.4 – grubby kernel info" src="image/B18349_03_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.270.1">Figure 3.4 – grubby kernel info</span></p>
<p><span class="koboSpan" id="kobo.271.1">With these </span><a id="_idIndexMarker188"/><span class="koboSpan" id="kobo.272.1">kernel details, we remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">rhgb quiet</span></strong><span class="koboSpan" id="kobo.274.1"> configuration from the kernel arguments and add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">test</span></strong><span class="koboSpan" id="kobo.276.1"> by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.278.1">
grubby --remove-args="rhgb quiet" --args=test --update-kernel /boot/vmlinuz-0-rescue-3f1be2edc0d247d9b6bb392429792aa1</span></pre> <p><span class="koboSpan" id="kobo.279.1">As you can see, we used the kernel name to update the arguments on that kernel (we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">–-remove-args</span></strong><span class="koboSpan" id="kobo.281.1"> attribute to remove an argument configuration and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">--args</span></strong><span class="koboSpan" id="kobo.283.1"> attribute to add a new one). </span><span class="koboSpan" id="kobo.283.2">Now, we can check whether the argument’s structure changed by running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">grubby –-info=$BOOTENV</span></strong><span class="koboSpan" id="kobo.285.1"> command with the boot environment as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">following figure.</span></span></p>
<p><span class="koboSpan" id="kobo.287.1">Note that you can always use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">man grubby</span></strong><span class="koboSpan" id="kobo.289.1"> command to review all the options available within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">grubby</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer063">
<span class="koboSpan" id="kobo.292.1"><img alt="Figure 3.5 – grubby info after making the change" src="image/B18349_03_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.293.1">Figure 3.5 – grubby info after making the change</span></p>
<h2 id="_idParaDest-76"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.294.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.295.1">As mentioned</span><a id="_idIndexMarker189"/><span class="koboSpan" id="kobo.296.1"> before, Oracle Linux comes with two flavors</span><a id="_idIndexMarker190"/><span class="koboSpan" id="kobo.297.1"> of kernels: the UEK, which is Oracle’s default flavor of Linux kernel, and the RHCK, which is compatible with the RHEL kernel. </span><span class="koboSpan" id="kobo.297.2">Regardless of what kernel is used, the rest of the operating system is the same; that is, it has the same applications, libraries, and </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">file locations.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">This section will teach you how to switch the default kernel (UEK) to the RHCK and vice versa. </span><span class="koboSpan" id="kobo.299.2">So, let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">get started.</span></span></p>
<p><span class="koboSpan" id="kobo.301.1">First, once again, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">grubby</span></strong><span class="koboSpan" id="kobo.303.1"> command to check the default kernel in use and, again, to check all kernels available within your system by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">grubby -–info=DEFAULT</span></strong><span class="koboSpan" id="kobo.305.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">grubby –-info=ALL</span></strong><span class="koboSpan" id="kobo.307.1"> commands. </span><span class="koboSpan" id="kobo.307.2">The difference between the two commands is with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">DEFAULT</span></strong><span class="koboSpan" id="kobo.309.1"> option, only the booting info is shown. </span><span class="koboSpan" id="kobo.309.2">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">ALL</span></strong><span class="koboSpan" id="kobo.311.1"> option, all available kernels </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">are shown:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<span class="koboSpan" id="kobo.313.1"><img alt="Figure 3.6 – Kernel version before swapping to RHCK" src="image/B18349_03_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.314.1">Figure 3.6 – Kernel version before swapping to RHCK</span></p>
<p><span class="koboSpan" id="kobo.315.1">In the </span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.316.1">preceding example, you can see that, in this case, the default</span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.317.1"> kernel in use is </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">/boot/vmlinuz-5.15.0-8.91.4.1.el8uek.x86_64</span></strong><span class="koboSpan" id="kobo.319.1">, which is a UEK flavor of the kernel. </span><span class="koboSpan" id="kobo.319.2">A UEK system should always have </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">uek</span></strong><span class="koboSpan" id="kobo.321.1"> after </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">el#</span></strong><span class="koboSpan" id="kobo.323.1">. </span><span class="koboSpan" id="kobo.323.2">You can also check the current kernel using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">uname -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">a</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.326.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer065">
<span class="koboSpan" id="kobo.327.1"><img alt="Figure 3.7 – uname -a before swapping to the RHCK" src="image/B18349_03_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.328.1">Figure 3.7 – uname -a before swapping to the RHCK</span></p>
<p><span class="koboSpan" id="kobo.329.1">To check all the kernels available on the system, we could use the data from the previously run </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">grubby –info</span></strong><span class="koboSpan" id="kobo.331.1"> command, or use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">rpm -qa </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">kernel*core*</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.334.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer066">
<span class="koboSpan" id="kobo.335.1"><img alt="Figure 3.8 – Checking the kernels using the rpm command" src="image/B18349_03_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.336.1">Figure 3.8 – Checking the kernels using the rpm command</span></p>
<p><span class="koboSpan" id="kobo.337.1">When checking all available kernels, we can quickly identify two versions of the UEK and two versions of the RHCK. </span><span class="koboSpan" id="kobo.337.2">For this example, we will use the RHCK version called </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">4.18.0-425.13.1.el8_7</span></strong><span class="koboSpan" id="kobo.339.1">, which is found in </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">boot</span></strong><span class="koboSpan" id="kobo.341.1"> at </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">/boot/vmlinuz-</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.343.1">4.18.0-425.13.1.el8_7</span></strong><span class="koboSpan" id="kobo.344.1">. </span><span class="koboSpan" id="kobo.344.2">So now, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">grubby –-set-default</span></strong><span class="koboSpan" id="kobo.346.1"> command to make the selected RHCK the new default. </span><span class="koboSpan" id="kobo.346.2">We then check the default kernel using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">grubby --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">info=DEFAULT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.349.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer067">
<span class="koboSpan" id="kobo.350.1"><img alt="Figure 3.9 – Switching to the RHCK" src="image/B18349_03_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.351.1">Figure 3.9 – Switching to the RHCK</span></p>
<p><span class="koboSpan" id="kobo.352.1">And that’s it. </span><span class="koboSpan" id="kobo.352.2">Now</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.353.1"> all we need to do is reboot the system to reflect</span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.354.1"> the kernel change. </span><span class="koboSpan" id="kobo.354.2">Then, if you want to switch it back to the previous RHCK flavor of the kernel, all you need to do is run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">grubby –-set-default</span></strong><span class="koboSpan" id="kobo.356.1"> command again, but this time specify the name of the RHCK version that </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">you want.</span></span></p>
<h1 id="_idParaDest-77"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.358.1">Playing with UEFI</span></h1>
<p><span class="koboSpan" id="kobo.359.1">One way hackers </span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.360.1">can compromise systems is by attacking the system before it boots. </span><span class="koboSpan" id="kobo.360.2">In order to prevent this, you must secure the operating system by enabling security in UEFI. </span><span class="koboSpan" id="kobo.360.3">In other words, you cannot run software if it cannot be trusted to execute code correctly because untrusted software can tamper with your bootloader or, even worse, compromise your firmware. </span><span class="koboSpan" id="kobo.360.4">To solve this, a new, secure method is required to boot systems, called UEFI. </span><span class="koboSpan" id="kobo.360.5">UEFI is implemented in the firmware and has become the interface between your hardware and the operating system, replacing the legacy BIOS firmware that was previously the industry default. </span><span class="koboSpan" id="kobo.360.6">A feature of UEFI is Secure Boot, which ensures that your system boots by only using software trusted by the hardware manufacturer of your system. </span><span class="koboSpan" id="kobo.360.7">In addition, it provides a verification mechanism (by verifying each piece of boot software by using cryptographic checksums and signatures) to ensure that the code that is launched is trusted by validating the boot loader before executing it (even before loading the operating system). </span><span class="koboSpan" id="kobo.360.8">If th</span><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.361.1">e feature is available, UEFI </span><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.362.1">systems can also boot in legacy BIOS mode via a compatibility </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">support module.</span></span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.364.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.365.1">To boot in UEFI mode, Oracle Linux requires the UEFI firmware to be present during the system installation as it is detected at installation time. </span><span class="koboSpan" id="kobo.365.2">Next, a GPT is automatically</span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.366.1"> set up, creating an ESP on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">/boot/efi</span></strong><span class="koboSpan" id="kobo.368.1"> mount, which contains the files needed for the UEFI booting. </span><span class="koboSpan" id="kobo.368.2">GPT is a way of storing partitioning information on a drive that includes information such as where partitions begin and end on a physical disk. </span><span class="koboSpan" id="kobo.368.3">GPT is a new standard that gradually replaces the MBR standard</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.369.1"> previously widely used. </span><span class="koboSpan" id="kobo.369.2">GPT doesn’t suffer from MBR’s limits, such as the number of partitions and the drivers’ size, with size limits depending on the operating system and its filesystems. </span><span class="koboSpan" id="kobo.369.3">Note that GPT is the type of partition table required by UEFI and was initiated </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">by Intel.</span></span></p>
<h3><span class="koboSpan" id="kobo.371.1">MBR versus GPT</span></h3>
<p><span class="koboSpan" id="kobo.372.1">When it </span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.373.1">comes to partitioning schemes</span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.374.1"> on storage devices such</span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.375.1"> as hard drives and solid-state drives, MBR and GPT are two distinct options. </span><span class="koboSpan" id="kobo.375.2">To help distinguish between the two, here are the primary differences to keep </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">in mind.</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.377.1">Partitioning capacity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.379.1">MBR</span></strong><span class="koboSpan" id="kobo.380.1">: Your computer’s MBR allows either four primary partitions or three primary partitions and one extended partition, which can be further divided into multiple logical partitions. </span><span class="koboSpan" id="kobo.380.2">However, it does have a capacity restriction of a maximum disk size of </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">2 TB.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.382.1">GPT</span></strong><span class="koboSpan" id="kobo.383.1">: By default, GPT can support up to 128 partitions and it is not limited in terms of partition count. </span><span class="koboSpan" id="kobo.383.2">Additionally, it can accommodate larger disk sizes of up to </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">9.4 ZB.</span></span></li></ul></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.385.1">Compatibility</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.387.1">MBR</span></strong><span class="koboSpan" id="kobo.388.1">: MBR provides improved compatibility with legacy systems and operating systems. </span><span class="koboSpan" id="kobo.388.2">It is widely supported by BIOS-based computers, as well as old versions of Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">and Linux.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.390.1">GPT</span></strong><span class="koboSpan" id="kobo.391.1">: Modern systems, especially those utilizing UEFI instead of BIOS, exhibit better compatibility with GPT. </span><span class="koboSpan" id="kobo.391.2">This partitioning scheme is backed by most contemporary</span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.392.1"> operating systems, such</span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.393.1"> as Windows, macOS, </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">and Linux.</span></span></li></ul></li>
</ul>
<p><span class="koboSpan" id="kobo.395.1">When deciding</span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.396.1"> whether to use MBR or GPT, it’s important to take into account factors such as disk size, desired partition count, compatibility needs, and the specific system or operating system you plan to use. </span><span class="koboSpan" id="kobo.396.2">For large disks and new systems, GPT is usually the better choice, while MBR remains viable for old systems or small disks that require compatibility with the older </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">booting partition.</span></span></p>
<h2 id="_idParaDest-79"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.398.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.399.1">Let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">df -h</span></strong><span class="koboSpan" id="kobo.401.1"> command </span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.402.1">to view the partitions in the system. </span><span class="koboSpan" id="kobo.402.2">Please notice that </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">/boot/efi</span></strong><span class="koboSpan" id="kobo.404.1"> is mounted on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">/dev/sda1</span></strong><span class="koboSpan" id="kobo.406.1"> partition in </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">this example:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer068">
<span class="koboSpan" id="kobo.408.1"><img alt="Figure 3.10 – df -h command" src="image/B18349_03_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.409.1">Figure 3.10 – df -h command</span></p>
<p><span class="koboSpan" id="kobo.410.1">If you</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.411.1"> run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">ls -l /boot/efi/EFI/redhat</span></strong><span class="koboSpan" id="kobo.413.1"> command, this directory contains a first-stage bootloader called </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">shimx64.efi</span></strong><span class="koboSpan" id="kobo.415.1">, a GRUB 2 bootloader called </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">grubx64.efi</span></strong><span class="koboSpan" id="kobo.417.1">, and a GRUB 2 configuration file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">grub.cfg</span></strong><span class="koboSpan" id="kobo.419.1">. </span><span class="koboSpan" id="kobo.419.2">The location of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">grub.cfg</span></strong><span class="koboSpan" id="kobo.421.1"> file is different in BIOS mode as it resides </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">/boot/grub2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.425.1">
[root@demo2 ~]# ls -l /boot/efi/EFI/redhat
total 4112
-rwx------. </span><span class="koboSpan" id="kobo.425.2">1 root root     134 Aug 27 15:51 BOOTX64.CSV
drwx------. </span><span class="koboSpan" id="kobo.425.3">2 root root    4096 Oct 15 19:59 fonts
-rwx------. </span><span class="koboSpan" id="kobo.425.4">1 root root    6545 Feb 14 20:45 grub.cfg
-rwx------. </span><span class="koboSpan" id="kobo.425.5">1 root root    1024 Feb 14 22:31 grubenv
-rwx------. </span><span class="koboSpan" id="kobo.425.6">1 root root    1024 Feb 14 21:15 grubenvRvxfzJ
-rwx------. </span><span class="koboSpan" id="kobo.425.7">1 root root 2288320 Oct 15 19:59 grubx64.efi
-rwx------. </span><span class="koboSpan" id="kobo.425.8">1 root root  905400 Aug 27 15:51 mmx64.efi
-rwx------. </span><span class="koboSpan" id="kobo.425.9">1 root root  984688 Aug 27 15:51 shimx64.efi
[root@localhost falvarez]#</span></pre> <p><span class="koboSpan" id="kobo.426.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">/etc/default/grub</span></strong><span class="koboSpan" id="kobo.428.1"> file is responsible for containing the user settings for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">grub.cfg</span></strong><span class="koboSpan" id="kobo.430.1"> file. </span><span class="koboSpan" id="kobo.430.2">Note that this file is also located in the same location when in BIOS mode. </span><span class="koboSpan" id="kobo.430.3">Furthermore, if you make any changes to this file, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">grub.cfg</span></strong><span class="koboSpan" id="kobo.432.1"> file will need to </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">be rebuilt:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.434.1">
[root@demo2 ~]# cat /etc/default/grub
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="crashkernel=auto resume=/dev/mapper/ol-swap rd.lvm.lv=ol/root rd.lvm.lv=ol/swap rhgb quiet"
GRUB_DISABLE_RECOVERY="true"
GRUB_ENABLE_BLSCFG=true</span></pre> <p><span class="koboSpan" id="kobo.435.1">To </span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.436.1">rebuild the </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">grub.cfg</span></strong><span class="koboSpan" id="kobo.438.1"> file, please use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">grub2-mkconfig</span></strong><span class="koboSpan" id="kobo.440.1"> command specifying the output file, using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">-o</span></strong><span class="koboSpan" id="kobo.442.1"> option, such </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">/boot/efi/EFI/redhat/grub.cfg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.446.1">
[root@demo2 ~]# grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
Generating grub configuration file ...
</span><span class="koboSpan" id="kobo.446.2">Adding boot menu entry for EFI firmware configuration
done</span></pre> <p><span class="koboSpan" id="kobo.447.1">The utility used to manage the UEFI boot process is called </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">efibootmgr</span></strong><span class="koboSpan" id="kobo.449.1"> (it provides a boot menu showing the boot entries). </span><span class="koboSpan" id="kobo.449.2">It also allows us to manipulate boot entries by doing </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.451.1">Altering the </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">boot order</span></span></li>
<li><span class="koboSpan" id="kobo.453.1">Creating </span><span class="No-Break"><span class="koboSpan" id="kobo.454.1">boot entries</span></span></li>
<li><span class="koboSpan" id="kobo.455.1">Removing </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">boot entries</span></span></li>
<li><span class="koboSpan" id="kobo.457.1">Specifying the boot entry for the </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">next boot</span></span></li>
</ul>
<h2 id="_idParaDest-80"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.459.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.460.1">You can </span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.461.1">view a summary of boot entries by running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">efibootmgr</span></strong><span class="koboSpan" id="kobo.463.1"> command with no options. </span><span class="koboSpan" id="kobo.463.2">For more details, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">-v</span></strong><span class="koboSpan" id="kobo.465.1"> option </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">to it:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.467.1">
[root@demo2 ~]# efibootmgr -v
BootCurrent: 0004
Timeout: 0 seconds
BootOrder: 0004,0000,0001,0002,0003
Boot0000* UiApp
Boot0001* UEFI VBOX CD-ROM VB2-01700376
Boot0002* UEFI VBOX HARDDISK VB2d5be0c5-80049c5d
Boot0003* EFI Internal Shell
Boot0004* Oracle Linux
[root@demo2 ~]# efibootmgr -v
BootCurrent: 0004
Timeout: 0 seconds
BootOrder: 0004,0000,0001,0002,0003
Boot0000* UiApp FvVol(7cb8bdc9-f8eb-4f34-aaea-3ee4af6516a1)/FvFile(462caa21-7614-4503-836e-8ab6f4662331)
Boot0001* UEFI VBOX CD-ROM VB2-01700376      PciRoot(0x0)/Pci(0x1,0x1)/Ata(1,0,0)N.....YM....R,Y.
</span><span class="koboSpan" id="kobo.467.2">Boot0002* UEFI VBOX HARDDISK VB2d5be0c5-80049c5d      PciRoot(0x0)/Pci(0xd,0x0)/Sata(0,65535,0)N.....YM....R,Y.
</span><span class="koboSpan" id="kobo.467.3">Boot0003* EFI Internal Shell    FvVol(7cb8bdc9-f8eb-4f34-aaea-3ee4af6516a1)/FvFile(7c04a583-9e3e-4f1c-ad65-e05268d0b4d1)
Boot0004* Oracle Linux    HD(1,GPT,dff50c5d-96ed-406c-9823-212649b405bd,0x800,0x12c000)/File(\EFI\redhat\shimx64.efi)</span></pre> <p><span class="koboSpan" id="kobo.468.1">As you can see in the preceding example, boot </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">0004</span></strong><span class="koboSpan" id="kobo.470.1"> (Oracle Linux) is the boot entry used to start the currently running system, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">BootCurrent</span></strong><span class="koboSpan" id="kobo.472.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">BootOrder</span></strong><span class="koboSpan" id="kobo.474.1"> is the boot order used in the boot manager; consequently, the boot manager will boot the first active entry in the list. </span><span class="koboSpan" id="kobo.474.2">If it’s not successful, it will try the next entry, and so on. </span><span class="koboSpan" id="kobo.474.3">If you’re using UEFI on your system, </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">efibootmgr</span></strong><span class="koboSpan" id="kobo.476.1"> is a handy</span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.477.1"> command-line tool that enables you to manage your EFI boot entries. </span><span class="koboSpan" id="kobo.477.2">With this utility, you can easily view, create, modify, and delete boot entries in the EFI </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">boot manager.</span></span></p>
<p><span class="koboSpan" id="kobo.479.1">If you want to delete a boot entry, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">-B</span></strong><span class="koboSpan" id="kobo.481.1"> option. </span><span class="koboSpan" id="kobo.481.2">In this case, we will delete the CDROM record (</span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">0001</span></strong><span class="koboSpan" id="kobo.483.1">) option using the </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.485.1">
efibootmgr -b 0001 -B</span></pre> <p><span class="koboSpan" id="kobo.486.1">You can also change the boot order with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">-o</span></strong><span class="koboSpan" id="kobo.488.1"> option. </span><span class="koboSpan" id="kobo.488.2">In the following command, we will change the boot order to make the UFEI shell the </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">default boot:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.490.1">
efibootmgr -o 0003,0004,0002,0003</span></pre> <p><span class="koboSpan" id="kobo.491.1">Please use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">man</span></strong><span class="koboSpan" id="kobo.493.1"> command</span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.494.1"> to learn more about the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">efibootmgr</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.496.1"> command.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.497.1">Warning</span></p>
<p class="callout"><span class="koboSpan" id="kobo.498.1">Be very careful when changing the config. </span><span class="koboSpan" id="kobo.498.2">Accidentally changing the boot order to a device that is not bootable can put you in a situation where you are recovering the system. </span><span class="koboSpan" id="kobo.498.3">This is even more important if you are running in an environment where you do not have access to </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">the console.</span></span></p>
<h1 id="_idParaDest-81"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.500.1">Playing with Secure Boot</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.501.1">Secure Boot</span></strong><span class="koboSpan" id="kobo.502.1"> is an </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.503.1">additional optional feature implemented in UEFI intended to help prevent malware execution during a boot process. </span><span class="koboSpan" id="kobo.503.2">To enable or disable Secure Boot, you need to access your specific UEFI setup program. </span><span class="koboSpan" id="kobo.503.3">This is different for each system manufacturer. </span><span class="koboSpan" id="kobo.503.4">Check your system documentation to see how to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">UEFI configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.505.1">The Secure Boot </span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.506.1">steps are identical to the regular UEFI booting but an important exception is that it requires the components to be signed and authenticated to be loaded and executed (private and public key pairs are used for authentication). </span><span class="koboSpan" id="kobo.506.2">It consists of two</span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.507.1"> launch </span><strong class="bold"><span class="koboSpan" id="kobo.508.1">Roots of Trust</span></strong><span class="koboSpan" id="kobo.509.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.510.1">RoT</span></strong><span class="koboSpan" id="kobo.511.1">) to build the transitive </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">trust chains:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.513.1">The verification RoT is responsible for the signature verification. </span><span class="koboSpan" id="kobo.513.2">The verification RoT is the launch RoT, which is what most are referring to when speaking about Secure Boot, and it will lie on the boot flash drive as the RoT for storage to protect the key database. </span><span class="koboSpan" id="kobo.513.3">Verify </span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.514.1">only after the </span><strong class="bold"><span class="koboSpan" id="kobo.515.1">Driver eXecution Environment</span></strong><span class="koboSpan" id="kobo.516.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.517.1">DXE</span></strong><span class="koboSpan" id="kobo.518.1">) phase, not </span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.519.1">during the </span><strong class="bold"><span class="koboSpan" id="kobo.520.1">SECurity</span></strong><span class="koboSpan" id="kobo.521.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.522.1">SEC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">) phase.</span></span></li>
<li><span class="koboSpan" id="kobo.524.1">The measurement RoT is responsible for the </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">measurement collection.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.526.1">Secure Boot will establish a chain of trust by following </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">this process:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.528.1">First, the first-stage bootloader (shim) signed by Oracle and Microsoft is authenticated; then, it loads the GRUB </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">2 loader.</span></span></li>
<li><span class="koboSpan" id="kobo.530.1">The GRUB 2 bootloader validates the kernel signature signed by Oracle and authenticates it before loading and executing </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">the kernel.</span></span></li>
<li><span class="koboSpan" id="kobo.532.1">The kernel signed by Oracle is authenticated and executed. </span><span class="koboSpan" id="kobo.532.2">Secure Boot loads signed/authenticated kernel modules only (for example, all kernel modules included with the kernel RPM and those used with Oracle Ksplice have the corresponding Oracle signatures and the signed/authenticated kernel module running validated, or they would not </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">be loaded).</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.534.1">Now that we have covered some basics of Secure Boot, let’s learn how to sign kernel modules with it. </span><span class="koboSpan" id="kobo.534.2">First, before you can sign a module, you will need to install several required packages, including the source for the kernel. </span><span class="koboSpan" id="kobo.534.3">Furthermore, you will need to create a signing certificate for a key pair. </span><span class="koboSpan" id="kobo.534.4">The private key is used to sign the kernel module, and a public key is added to Secure Boot to a kernel keyring to allow the system to verify </span><span class="No-Break"><span class="koboSpan" id="kobo.535.1">the signature.</span></span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor093"/><span class="koboSpan" id="kobo.536.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.537.1">The first step is to</span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.538.1"> install the UEK development libraries. </span><span class="koboSpan" id="kobo.538.2">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.540.1">
[root@demo2 ~]# dnf -y  install kernel-uek-devel-`uname -r`</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.541.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.542.1">While you can just run </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">dnf install kernel-uek-devel</span></strong><span class="koboSpan" id="kobo.544.1">, adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">uname</span></strong><span class="koboSpan" id="kobo.546.1"> option to the command makes sure that you install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">devel</span></strong><span class="koboSpan" id="kobo.548.1"> packages for the kernel you are currently running. </span><span class="koboSpan" id="kobo.548.2">Also, don’t forget to make sure your </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">devel</span></strong><span class="koboSpan" id="kobo.550.1"> packages are updated after </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">you patch.</span></span></p>
<p><span class="koboSpan" id="kobo.552.1">As a good practice, it is always recommended to update the system to ensure that you have the most recent kernel and related </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">packages available:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.554.1">
[root@@demo2 ~]# dnf  -y update</span></pre> <p><span class="koboSpan" id="kobo.555.1">This update can take some time, depending on when you last patched </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">the system.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">If you are using the UEK, the kernel headers required to compile kernel modules are available in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">kernel-uek-devel</span></strong><span class="koboSpan" id="kobo.559.1"> package. </span><span class="koboSpan" id="kobo.559.2">When using the UEFI Secure Boot functionality, Oracle recommends installing and using the UEK. </span><span class="koboSpan" id="kobo.559.3">When installing the UEK, also install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">devel</span></strong><span class="koboSpan" id="kobo.561.1"> packages. </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">uname -r</span></strong><span class="koboSpan" id="kobo.563.1"> is added to the command to make sure the correct headers are installed. </span><span class="koboSpan" id="kobo.563.2">This is important if you are not running on the latest kernel version. </span><span class="koboSpan" id="kobo.563.3">If you are using the RHCK, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">kernel-devel</span></strong><span class="koboSpan" id="kobo.565.1"> instead </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">kernel-uek-devel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.569.1">It is time to install the utilities required to perform the module signing operations (</span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">openssl</span></strong><span class="koboSpan" id="kobo.571.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">keyutils</span></strong><span class="koboSpan" id="kobo.573.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">mokutil</span></strong><span class="koboSpan" id="kobo.575.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.576.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">pesign</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.579.1">
[root@demo2 ~]# dnf -y  install openssl keyutils mokutil pesign</span></pre> <p><span class="koboSpan" id="kobo.580.1">If you require building a module from a source, you can optionally install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">Development Tools</span></strong><span class="koboSpan" id="kobo.582.1"> group to ensure the option to create tools </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">is available:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.584.1">
[root@demo2 ~]# dnf -y  group install "Development Tools"</span></pre> <h2 id="_idParaDest-83"><a id="_idTextAnchor094"/><span class="koboSpan" id="kobo.585.1">How to do it…</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.586.1">Create a </span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.587.1">configuration file that OpenSSL can use to obtain default values when generating your certificates. </span><span class="koboSpan" id="kobo.587.2">You can create this file at any location, but it is useful to keep it with the rest of your OpenSSL configuration in </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">/etc/ssl/x509.conf</span></strong><span class="koboSpan" id="kobo.589.1">. </span><span class="koboSpan" id="kobo.589.2">The file should look similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.591.1">
[ req ]
default_bits = 4096
distinguished_name = req_distinguished_name
prompt = no
string_mask = utf8only
x509_extensions = extensions
[ req_distinguished_name ]
O = Module Signing Example
CN = Module Signing Example Key
emailAddress = first.last@example.com
[ extensions ]
basicConstraints=critical,CA:FALSE
keyUsage=digitalSignature
extendedKeyUsage = codeSigning
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.592.1">You should edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">O</span></strong><span class="koboSpan" id="kobo.594.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">CN</span></strong><span class="koboSpan" id="kobo.596.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">emailAddress</span></strong><span class="koboSpan" id="kobo.598.1"> fields to be more appropriate. </span><span class="koboSpan" id="kobo.598.2">Note that in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">extensions</span></strong><span class="koboSpan" id="kobo.600.1"> section of the configuration, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">keyUsage</span></strong><span class="koboSpan" id="kobo.602.1"> field is set as </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">digitalSignature</span></strong><span class="koboSpan" id="kobo.604.1">. </span><span class="koboSpan" id="kobo.604.2">Additionally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">extendedKeyUsage</span></strong><span class="koboSpan" id="kobo.606.1"> option is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">codeSigning</span></strong><span class="koboSpan" id="kobo.608.1"> for compatibility with key </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">verification tools.</span></span></p></li> <li><span class="koboSpan" id="kobo.610.1">Generate</span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.611.1"> a new key pair using this </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">configuration file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.613.1">[root@demo2 ~]# openssl req -x509 -new -nodes -utf8 -sha512 -days 3650 -batch -config /etc/ssl/x509.conf -outform DER -out /etc/ssl/certs/pubkey.der -keyout /etc/ssl/certs/priv.key</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.614.1">Generating a RSA private key</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.615.1">........++++</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.616.1">.......++++</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.617.1">writing new private key to '/etc/ssl/certs/priv.key'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.618.1">-----</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.619.1">[root@demo2 ~]#</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.620.1">This signing certificate is valid for 10 years (3,650 days). </span><span class="koboSpan" id="kobo.620.2">Ensure that the keys are adequately protected. </span><span class="koboSpan" id="kobo.620.3">This can be done by copying the keys off the server and storing them in a secure location. </span><span class="koboSpan" id="kobo.620.4">Placing the keys on a USB stick and putting that in a desk drawer is </span><em class="italic"><span class="koboSpan" id="kobo.621.1">not</span></em><span class="koboSpan" id="kobo.622.1"> a secure location. </span><span class="koboSpan" id="kobo.622.2">Use a locked location, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">a safe.</span></span></p></li> <li><span class="koboSpan" id="kobo.624.1">Export the certificate in </span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">PEM format:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.626.1">[root@demo2 ~]# openssl x509 -inform DER -in /etc/ssl/certs/pubkey.der -out /etc/ssl/certs/pubkey.pem</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.627.1">[root@demo2 ~]#</span></strong></pre></li> </ol>
<h3><span class="koboSpan" id="kobo.628.1">Signing the module</span></h3>
<p><span class="koboSpan" id="kobo.629.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">sign-file</span></strong><span class="koboSpan" id="kobo.631.1"> utility</span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.632.1"> ensures that the module is signed correctly for the kernel. </span><span class="koboSpan" id="kobo.632.2">This utility is provided within the kernel source. </span><span class="koboSpan" id="kobo.632.3">The following instructions assume that you are signing a module for the currently running kernel. </span><span class="koboSpan" id="kobo.632.4">If you intend to sign a module for a different kernel, you must provide the path to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">sign-file</span></strong><span class="koboSpan" id="kobo.634.1"> utility within the correct kernel version source. </span><span class="koboSpan" id="kobo.634.2">If you do not use the right utility, the signature type for your module may not align correctly with the expected </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">signature type.</span></span></p>
<p><span class="koboSpan" id="kobo.636.1">To sign the</span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.637.1"> module, run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">sign-file</span></strong><span class="koboSpan" id="kobo.639.1"> utility for your currently running kernel and provide it with the path to your private key and the public key that you created for the purpose of signing your modules (for this example, I've used a public module </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">hello</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.643.1">
[root@demo2 ~]# sudo /usr/src/kernels/$(uname -r)/scripts/sign-file sha512 /etc/ssl/certs/priv.key \
&gt; /etc/ssl/certs/pubkey.der /lib/modules/$(uname -r)/extra/hello.ko</span></pre> <p><span class="koboSpan" id="kobo.644.1">Note that the module should already be installed into </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">/lib/modules/</span></strong><span class="koboSpan" id="kobo.646.1">, and you need to provide the correct path to </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1">the module.</span></span></p>
<h3><span class="koboSpan" id="kobo.648.1">Updating the Machine Owner Key database</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.649.1">Machine Owner Key</span></strong><span class="koboSpan" id="kobo.650.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.651.1">MOK</span></strong><span class="koboSpan" id="kobo.652.1">) is a </span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.653.1">security </span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.654.1">feature designed to protect the boot process of a computer system from unauthorized modifications or attacks. </span><span class="koboSpan" id="kobo.654.2">It is typically used in systems that support </span><strong class="bold"><span class="koboSpan" id="kobo.655.1">UEFI</span></strong><span class="koboSpan" id="kobo.656.1"> and Secure Boot, which require all bootloaders and kernel</span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.657.1"> modules to be signed by </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">trusted entities.</span></span></p>
<p><span class="koboSpan" id="kobo.659.1">The MOK database is stored in a non-volatile memory location within the system’s firmware and contains a list of public keys that are allowed to sign the bootloaders and kernel modules. </span><span class="koboSpan" id="kobo.659.2">Each key in the MOK database is associated with a unique identifier and is used to verify the digital signature of the bootloaders and kernel modules. </span><span class="koboSpan" id="kobo.659.3">If a digital signature is valid, the boot process continues and the software is loaded. </span><span class="koboSpan" id="kobo.659.4">If a digital signature is not valid or the key used to sign the software is not in the MOK database, the boot process is halted and the system will </span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">not boot.</span></span></p>
<p><span class="koboSpan" id="kobo.661.1">To enroll an MOK key, you must manually do so on each target system using the UEFI </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">system console.</span></span></p>
<p><span class="koboSpan" id="kobo.663.1">Because the key that you created is not included in the UEFI Secure Boot key database, you must enroll in the MOK database in the shim by using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">mokutil</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.665.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.666.1">
mokutil --import /etc/ssl/certs/pubkey.der</span></pre> <p><span class="koboSpan" id="kobo.667.1">The previous </span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.668.1">command prompts you for a single-use password</span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.669.1"> that you use when the MOK management service enrolls the key after you reboot </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">the system.</span></span></p>
<h4><span class="koboSpan" id="kobo.671.1">Reboot the system</span></h4>
<ol>
<li><span class="koboSpan" id="kobo.672.1">The</span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.673.1"> UEFI shim should automatically start the shim UEFI key manager at boot, as shown in the following figure. </span><span class="koboSpan" id="kobo.673.2">If you do not hit any key within 10 seconds, you will be unable to enroll your </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">MOK key:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer069">
<span class="koboSpan" id="kobo.675.1"><img alt="Figure 3.11 – Shim utility" src="image/B18349_03_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.676.1">Figure 3.11 – Shim utility</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.677.1">Press any key </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">to continue.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.679.1">Then you should</span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.680.1"> see the shim main menu. </span><span class="koboSpan" id="kobo.680.2">Select </span><strong class="bold"><span class="koboSpan" id="kobo.681.1">Enroll MOK</span></strong><span class="koboSpan" id="kobo.682.1"> from </span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">the menu.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer070">
<span class="koboSpan" id="kobo.684.1"><img alt="Figure 3.12 – Shim main menu" src="image/B18349_03_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.685.1">Figure 3.12 – Shim main menu</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.686.1">This will let</span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.687.1"> you continue to enroll the key or view </span><span class="No-Break"><span class="koboSpan" id="kobo.688.1">the key.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.689.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.690.1">View key 0</span></strong><span class="koboSpan" id="kobo.691.1"> from the menu (as shown in the following figure) to display the </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">key details.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer071">
<span class="koboSpan" id="kobo.693.1"><img alt="Figure 3.13 – View key" src="image/B18349_03_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.694.1">Figure 3.13 – View key</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.695.1">This will then display the key details. </span><span class="koboSpan" id="kobo.695.2">Verify that the values presented match the key you used to sign the module and that you inserted into the </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">kernel image:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer072">
<span class="koboSpan" id="kobo.697.1"><img alt="Figure 3.14 – Key details" src="image/B18349_03_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.698.1">Figure 3.14 – Key details</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.699.1">Then </span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.700.1">press any key to return to the </span><strong class="bold"><span class="koboSpan" id="kobo.701.1">Enroll </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.702.1">MOK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.703.1"> menu.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.704.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.705.1">Continue</span></strong><span class="koboSpan" id="kobo.706.1"> from </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">the menu.</span></span></li>
<li><span class="koboSpan" id="kobo.708.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.709.1">Enroll the key(s)?</span></strong><span class="koboSpan" id="kobo.710.1"> screen is displayed, and you can now select </span><strong class="bold"><span class="koboSpan" id="kobo.711.1">Yes</span></strong><span class="koboSpan" id="kobo.712.1"> from the menu (as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">following figure).</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer073">
<span class="koboSpan" id="kobo.714.1"><img alt="Figure 3.15 – Enrolling the key" src="image/B18349_03_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.715.1">Figure 3.15 – Enrolling the key</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.716.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.717.1">Yes</span></strong><span class="koboSpan" id="kobo.718.1"> to enroll </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">the key.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.720.1">You will</span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.721.1"> then be prompted for a password. </span><span class="koboSpan" id="kobo.721.2">Enter the password you used when you imported the key using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">mokutil</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.723.1"> command.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.724.1">The key is enrolled within the UEFI Secure Boot </span><span class="No-Break"><span class="koboSpan" id="kobo.725.1">key database.</span></span></p></li>
<li><span class="koboSpan" id="kobo.726.1">You are now redirected to the main menu. </span><span class="koboSpan" id="kobo.726.2">Select </span><strong class="bold"><span class="koboSpan" id="kobo.727.1">Reboot</span></strong><span class="koboSpan" id="kobo.728.1"> from </span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">the menu.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer074">
<span class="koboSpan" id="kobo.730.1"><img alt="Figure 3.16 – Reboot when done" src="image/B18349_03_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.731.1">Figure 3.16 – Reboot when done</span></p>
<h2 id="_idParaDest-84"><a id="_idTextAnchor095"/><span class="koboSpan" id="kobo.732.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.733.1">After </span><a id="_idIndexMarker230"/><span class="koboSpan" id="kobo.734.1">booting the system, you can validate whether a key is included in the appropriate kernel keyring. </span><span class="koboSpan" id="kobo.734.2">Validation depends on the kernel version that you are running. </span><span class="koboSpan" id="kobo.734.3">Also, the keyring name that you need to check varies, as the implementation has changed across </span><span class="No-Break"><span class="koboSpan" id="kobo.735.1">kernel versions.</span></span></p>
<p><span class="koboSpan" id="kobo.736.1">If the key generated for signing custom modules is listed within the correct keyring, you can load modules signed with this key while in Secure </span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">Boot mode.</span></span></p>
<p><span class="koboSpan" id="kobo.738.1">For RHCK on Oracle Linux 8 and UEK R6U3 kernels or later, keys within both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">builtin_trusted_keys</span></strong><span class="koboSpan" id="kobo.740.1"> keyring and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">platform</span></strong><span class="koboSpan" id="kobo.742.1"> keyring are trusted for both module signing and for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">kexec</span></strong><span class="koboSpan" id="kobo.744.1"> tools, which means you can follow the standard procedure to sign a module and add it to the MOK database for the key to appear in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">platform</span></strong><span class="koboSpan" id="kobo.746.1"> keyring, and it is </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">automatically trusted.</span></span></p>
<p><span class="koboSpan" id="kobo.748.1">Because a key can be loaded into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">builtin_trusted_keys</span></strong><span class="koboSpan" id="kobo.750.1"> keyring, you should check both keyrings for the module signing key. </span><span class="koboSpan" id="kobo.750.2">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">an example:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.752.1">
[root@demo2 ~]# keyctl show %:.builtin_trusted_keys
Keyring
 718980051 ---lswrv      0     0  keyring: .builtin_trusted_keys
 889527021 ---lswrv      0     0   \_ asymmetric: Oracle CA Server: 23652876a2ec7c7794eb905265a1145e5ad5b873
 643918572 ---lswrv      0     0   \_ asymmetric: Oracle IMA signing CA: a2f28976a05984028f7d1a4904ae14e8e468e551
 668816900 ---lswrv      0     0   \_ asymmetric: Oracle America, Inc.: Ksplice Kernel Module Signing Key: 09010ebef5545fa7c54b626ef518e077b5b1ee4c
  35441076 ---lswrv      0     0   \_ asymmetric: Oracle Linux Kernel Module Signing Key: 2bb352412969a3653f0eb6021763408ebb9bb5ab
[root@demo2 ~]# keyctl show %:.platform
Keyring
 858046056 ---lswrv      0     0  keyring: .platform
 886150219 ---lswrv      0     0   \_ asymmetric: Oracle America, Inc.: 430c85cb8b531c3d7b8c44adfafc2e5d49bb89d4
 698748825 ---lswrv      0     0   \_ asymmetric: Oracle America Inc.: 2e7c1720d1c5df5254cc93d6decaa75e49620cf8
 790695213 ---lswrv      0     0   \_ asymmetric: Oracle America, Inc.: 795c5945e7cb2b6773b7797571413e3695062514
 227851788 ---lswrv      0     0   \_ asymmetric: Oracle America, Inc.: f9aec43f7480c408d681db3d6f19f54d6e396ff4</span></pre> <h1 id="_idParaDest-85"><a id="_idTextAnchor096"/><span class="koboSpan" id="kobo.753.1">TrenchBoot – improving boot security and integrity</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.754.1">TrenchBoot</span></strong><span class="koboSpan" id="kobo.755.1"> is a </span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.756.1">GitHub cross-community and cross-platform framework integration that grew from an idea by Apertus Solutions that originated in 2014 to deal with the limitations of using tboot to launch Xen for the OpenXT project and other contributors, such as Oracle (Intel), 3mdep (AMD), and Citrix (</span><a href="https://github.com/TrenchBoot"><span class="koboSpan" id="kobo.757.1">https://github.com/TrenchBoot</span></a><span class="koboSpan" id="kobo.758.1">). </span><span class="koboSpan" id="kobo.758.2">Its primary purpose is to expand the mechanism of security and the integrity of the boot process by using a standard and unified approach (between Xen, KVM, Linux, BSDs, and potentially proprietary kernels). </span><span class="koboSpan" id="kobo.758.3">A common location where you will see this being used is Oracle Cloud’s </span><span class="No-Break"><span class="koboSpan" id="kobo.759.1">shielded instances.</span></span></p>
<h3><span class="koboSpan" id="kobo.760.1">Getting ready</span></h3>
<p><span class="koboSpan" id="kobo.761.1">One of the </span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.762.1">main capabilities of TrenchBoot is securely launching Linux. </span><span class="koboSpan" id="kobo.762.2">This feature enables the Linux kernel to be dynamically launched by AMD and Intel by introducing an intermediate phase to the boot launch. </span><span class="koboSpan" id="kobo.762.3">Unlike traditional first-launch scenarios, such as the bootstrap phase used by open source dynamic launch tools such as XMHF, OSLO, OpenText Secure Boot, and tboot, TrenchBoot provides the ability to launch kernel upgrades through a key exec. </span><span class="koboSpan" id="kobo.762.4">You could then launch an integrity kernel that could dynamically inspect the system and establish the integrity of the platform before persisting everything to a diskless embedded environment during a shutdown. </span><span class="koboSpan" id="kobo.762.5">Note that the newly</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.763.1"> introduced </span><strong class="bold"><span class="koboSpan" id="kobo.764.1">intermediate p</span></strong><strong class="bold"><span class="koboSpan" id="kobo.765.1">hase</span></strong><span class="koboSpan" id="kobo.766.1"> includes </span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.767.1">an </span><strong class="bold"><span class="koboSpan" id="kobo.768.1">intermediate loader</span></strong><span class="koboSpan" id="kobo.769.1"> called </span><strong class="bold"><span class="koboSpan" id="kobo.770.1">TrenchBoot Loader</span></strong><span class="koboSpan" id="kobo.771.1"> that </span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.772.1">various bootstrap solutions can launch. </span><span class="koboSpan" id="kobo.772.2">TrenchBoot Loader contains the </span><strong class="bold"><span class="koboSpan" id="kobo.773.1">TrenchBoot Security Engine</span></strong><span class="koboSpan" id="kobo.774.1">, which</span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.775.1"> implements </span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.776.1">integrity processing. </span><span class="koboSpan" id="kobo.776.2">Please refer to the </span><span class="No-Break"><span class="koboSpan" id="kobo.777.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer075">
<span class="koboSpan" id="kobo.778.1"><img alt="Figure 3.17 – TrenchBoot process overview" src="image/B18349_03_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.779.1">Figure 3.17 – TrenchBoot process overview</span></p>
<p><span class="koboSpan" id="kobo.780.1">Oracle has added more TrenchBoot support to the Oracle Linux kernel to enable a Secure Boot protocol for the Linux kernel for multiple </span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.781.1">use cases, such as </span><strong class="bold"><span class="koboSpan" id="kobo.782.1">two-factor authentication</span></strong><span class="koboSpan" id="kobo.783.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.784.1">2FA</span></strong><span class="koboSpan" id="kobo.785.1">) for</span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.786.1"> laptops or crowdsourcing integrity handling; this option is the </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">best choice.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.788.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.789.1">You can see some of Oracle’s efforts by reading the kernel.org archive </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">at </span></span><a href="mailto:https://lore.kernel.org/lkml/20230504145023.835096-1-ross.philipson@oracle.com/"><span class="No-Break"><span class="koboSpan" id="kobo.791.1">https://lore.kernel.org/lkml/20230504145023.835096-1-ross.philipson@oracle.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.792.1">.</span></span></p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.793.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.794.1">The</span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.795.1"> TrenchBoot Loader is composed of well-known components such as Linux and u-root. </span><span class="koboSpan" id="kobo.795.2">Let’s</span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.796.1"> take a closer look at the main components </span><span class="No-Break"><span class="koboSpan" id="kobo.797.1">within it:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.798.1">A TrenchBoot-enabled kernel with integrated TrenchBoot </span><span class="No-Break"><span class="koboSpan" id="kobo.799.1">u-root initramfs</span></span></li>
<li><span class="koboSpan" id="kobo.800.1">Integrated TrenchBoot Security Engine as an extension </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1">to u-root</span></span></li>
<li><span class="koboSpan" id="kobo.802.1">A new image that can be launched by the </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">boot loader</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.804.1">This build process is shown in th</span><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.805.1">e </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer076">
<span class="koboSpan" id="kobo.807.1"><img alt="Figure 3.18 – TrenchBoot image process" src="image/B18349_03_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.808.1">Figure 3.18 – TrenchBoot image process</span></p>
<p><span class="koboSpan" id="kobo.809.1">The main benefits of </span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.810.1">using TrenchBoot are </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.812.1">Secure boot</span></strong><span class="koboSpan" id="kobo.813.1">: TrenchBoot </span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.814.1">provides a Secure Boot process that ensures that only trusted software is executed on the system. </span><span class="koboSpan" id="kobo.814.2">This prevents the execution of malicious software that could compromise </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1">the system.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.816.1">Runtime integrity</span></strong><span class="koboSpan" id="kobo.817.1">: TrenchBoot </span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.818.1">ensures that the system remains secure even after booting by verifying the integrity of the software and data at runtime. </span><span class="koboSpan" id="kobo.818.2">It uses technologies such as Intel SGX and AMD SEV to provide</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.819.1"> hardware-based isolation </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">and attestation.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.821.1">Protection against attacks</span></strong><span class="koboSpan" id="kobo.822.1">: TrenchBoot </span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.823.1">provides protection against various types of attacks, including firmware attacks, malware, and </span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">kernel rootkits.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.825.1">Platform-agnostic</span></strong><span class="koboSpan" id="kobo.826.1">: TrenchBoot </span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.827.1">is platform-agnostic and can be used on different hardware platforms, including x86, Arm, </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">and RISC-V.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.829.1">Open source</span></strong><span class="koboSpan" id="kobo.830.1">: TrenchBoot is an</span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.831.1"> open source project, which means that anyone can inspect the code and contribute to its </span><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.832.1">development. </span><span class="koboSpan" id="kobo.832.2">This makes TrenchBoot more transparent </span><span class="No-Break"><span class="koboSpan" id="kobo.833.1">and trustworthy.</span></span></li>
</ul>
<h1 id="_idParaDest-87"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.834.1">Removing the RHCK</span></h1>
<p><span class="koboSpan" id="kobo.835.1">In this recipe, you</span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.836.1"> will learn how to remove RHCK and its unique package dependencies while keeping all of UEK dependencies. </span><span class="koboSpan" id="kobo.836.2">Remember that when installing Oracle Linux, the installer automatically installs the Oracle UEK as the default kernel, but you can install RHCK for </span><span class="No-Break"><span class="koboSpan" id="kobo.837.1">compatibility purposes.</span></span></p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.838.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.839.1">Old versions of Oracle Linux required a special tool called the </span><strong class="source-inline"><span class="koboSpan" id="kobo.840.1">kernel-transition</span></strong><span class="koboSpan" id="kobo.841.1"> package to manage dependencies. </span><span class="koboSpan" id="kobo.841.2">With new versions of Oracle Linux, a much easier process is available. </span><span class="koboSpan" id="kobo.841.3">For example, with Oracle Linux 8, this requirement is obsolete. </span><span class="koboSpan" id="kobo.841.4">All packages are purposely built to avoid any dependencies with regard to the system running on a UEK or RHCK. </span><span class="koboSpan" id="kobo.841.5">This makes it significantly easier to remove the UEK or RHCK from </span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">the system.</span></span></p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.843.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.844.1">Let’s see how to remove RHCK from </span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">our system:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.846.1">First, let’s check all kernels running within our system by using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">grubby</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.848.1"> command:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer077">
<span class="koboSpan" id="kobo.849.1"><img alt="Figure 3.19 – Checking the kernels" src="image/B18349_03_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.850.1">Figure 3.19 – Checking the kernels</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.851.1">We can </span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.852.1">see in the preceding output that the default kernel in use is </span><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">/boot/vmlinuz-5.15.0-8.91.4.1.el8uek.x86_64</span></strong><span class="koboSpan" id="kobo.854.1">, which is a UEK; also, we can see that we have a couple of RHCKs installed, </span><strong class="source-inline"><span class="koboSpan" id="kobo.855.1">/boot/vmlinuz-4.18.0-425.13.1.el8_7.x86_64 </span></strong><span class="koboSpan" id="kobo.856.1">and </span><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">/boot/vmlinuz-4.18.0-425.3.1.el8.x86_64</span></strong><span class="koboSpan" id="kobo.858.1">, that we can </span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">safely remove.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.860.1">Now that we know that we are using a UEK, we can safely remove the desired RHCK using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">dnf remove kernel</span></strong><span class="koboSpan" id="kobo.862.1"> command as recommended in the Oracle Linux manual. </span><span class="koboSpan" id="kobo.862.2">It will detect the unused kernels and show the</span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.863.1"> dependencies </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">within them.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer078">
<span class="koboSpan" id="kobo.865.1"><img alt="Figure 3.20 – dnf remove kernel" src="image/B18349_03_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.866.1">Figure 3.20 – dnf remove kernel</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.867.1">As you can see in the preceding screenshot, both installed RHCKs were detected and deleted from the system. </span><span class="koboSpan" id="kobo.867.2">Now, let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">grubby</span></strong><span class="koboSpan" id="kobo.869.1"> command again to see whether the RHCKs were really removed from our system </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">boot options.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.871.1">Warning</span></p>
<p class="callout"><span class="koboSpan" id="kobo.872.1">Do not run </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">dnf remove kernel</span></strong><span class="koboSpan" id="kobo.874.1"> a second time. </span><span class="koboSpan" id="kobo.874.2">This may accidentally remove the booting kernel, resulting in a system that will no </span><span class="No-Break"><span class="koboSpan" id="kobo.875.1">longer boot.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer079">
<span class="koboSpan" id="kobo.876.1"><img alt="Figure 3.21 – RHCK removed" src="image/B18349_03_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.877.1">Figure 3.21 – RHCK removed</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.878.1">Sadly, both </span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.879.1">kernels are still there. </span><span class="koboSpan" id="kobo.879.2">The RHCK </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">kernel-&lt;version&gt;</span></strong><span class="koboSpan" id="kobo.881.1"> package is merely a metadata package containing no files. </span><span class="koboSpan" id="kobo.881.2">It is intended to ensure all dependent kernel packages are correctly installed. </span><span class="koboSpan" id="kobo.881.3">So, in other words, removing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">"kernel-&lt;version&gt;.el8"</span></strong><span class="koboSpan" id="kobo.883.1"> RPM does not remove any of the kernel-subpackages, which includes the package</span><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.884.1">s that update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.885.1">/boot</span></strong><span class="koboSpan" id="kobo.886.1"> associated files and the boot </span><span class="No-Break"><span class="koboSpan" id="kobo.887.1">loader entries.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.888.1">To solve this situation, we need to remove the corresponding </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">kernel-core-&lt;version&gt;</span></strong><span class="koboSpan" id="kobo.890.1"> packages containing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">/boot/</span></strong><span class="koboSpan" id="kobo.892.1"> and all </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">kernel-related files/directories.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.894.1">As shown</span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.895.1"> in the following screenshot, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">dnf erase kernel-core</span></strong><span class="koboSpan" id="kobo.897.1"> command to remove all related </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">kernel-core</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.899.1"> packages:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer080">
<span class="koboSpan" id="kobo.900.1"><img alt="Figure 3.22 – dnf erase kernel-core" src="image/B18349_03_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.901.1">Figure 3.22 – dnf erase kernel-core</span></p>
<p><span class="koboSpan" id="kobo.902.1">Now, let’s rerun the </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">grubby</span></strong><span class="koboSpan" id="kobo.904.1"> command to see whether the RHCKs were removed this time from </span><span class="No-Break"><span class="koboSpan" id="kobo.905.1">our system:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer081">
<span class="koboSpan" id="kobo.906.1"><img alt="Figure 3.23 –  grubby post RHCK removal" src="image/B18349_03_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.907.1">Figure 3.23 –  grubby post RHCK removal</span></p>
<p><span class="koboSpan" id="kobo.908.1">As you can now see, all RHCKs were removed from </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">our system.</span></span></p>
<p><span class="koboSpan" id="kobo.910.1">Furthermore, if you later decide to restore the deleted RHCKs, you can quickly restore them using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">dnf install </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">kernel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.913.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer082">
<span class="koboSpan" id="kobo.914.1"><img alt="Figure 3.24 – Reinstalling the RHCK" src="image/B18349_03_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.915.1">Figure 3.24 – Reinstalling the RHCK</span></p>
<p><span class="koboSpan" id="kobo.916.1">As you can see, with Oracle Linux, switching kernels is a simple task, as is removing kernels from the operating system. </span><span class="koboSpan" id="kobo.916.2">When you have a chance, compare the system performance between the RHCK</span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.917.1"> and UEKs; you will be pleasantly surprised how much faster tasks such as I/O are with the more </span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">modern UEK.</span></span></p>
</div>
</body></html>