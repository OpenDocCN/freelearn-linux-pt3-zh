<html><head></head><body>
<div id="_idContainer135">
<h1 class="chapter-number" id="_idParaDest-101"><a id="_idTextAnchor129"/><span class="koboSpan" id="kobo.1.1">10</span></h1>
<h1 id="_idParaDest-102"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.2.1">Debugging with the Yocto Project</span></h1>
<p><span class="koboSpan" id="kobo.3.1">The debug process</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.4.1"> is an essential step in every development cycle. </span><span class="koboSpan" id="kobo.4.2">In this chapter, we will learn how to configure Poky to help us with the debugging process; for example, how we can configure our system to provide the tools needed for a remote debug </span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.5.1">using the </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">Gnu DeBugger</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.8.1">GDB</span></strong><span class="koboSpan" id="kobo.9.1">), how we can track our changes using </span><strong class="source-inline"><span class="koboSpan" id="kobo.10.1">buildhistory</span></strong><span class="koboSpan" id="kobo.11.1">, and how we can use handy debug tools, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">oe-pkgdata-util</span></strong><span class="koboSpan" id="kobo.13.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.14.1">bitbake-getvar</span></strong><span class="koboSpan" id="kobo.15.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.17.1">devshell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">.</span></span></p>
<h1 id="_idParaDest-103"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.19.1">Differentiating metadata and application debugging</span></h1>
<p><span class="koboSpan" id="kobo.20.1">Before we delve into the details of debugging, we need to realize that there are different types of debugging, such as metadata and runtime </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">code debugging.</span></span></p>
<p><span class="koboSpan" id="kobo.22.1">Metadata debugging</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.23.1"> is needed to ensure that the behavior of BitBake’s tasks aligns with our goals and to identify the culprit when it’s not aligned. </span><span class="koboSpan" id="kobo.23.2">For example, a recipe may need to be fixed to enable a feature. </span><span class="koboSpan" id="kobo.23.3">In such a case, we can use several log files generated by BitBake in the host to help trace the execution path of the </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">involved task.</span></span></p>
<p><span class="koboSpan" id="kobo.25.1">On the other hand, debugging</span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.26.1"> runtime code is more natural as it is essentially the same as the typical development cycle of an application, a library, or a kernel. </span><span class="koboSpan" id="kobo.26.2">Depending on the issue we are seeking to resolve, the right tool to help may vary from a debugger to code instrumentation (for example, adding </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">debug prints).</span></span></p>
<h1 id="_idParaDest-104"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.28.1">Tracking image, package, and SDK contents</span></h1>
<p><span class="koboSpan" id="kobo.29.1">The easiest</span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.30.1"> way to ensure </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.31.1">we have the image, packages, and </span><strong class="bold"><span class="koboSpan" id="kobo.32.1">software development kit</span></strong><span class="koboSpan" id="kobo.33.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.34.1">SDK</span></strong><span class="koboSpan" id="kobo.35.1">), along with the expected</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.36.1"> contents, is to</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.37.1"> use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">buildhistory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.39.1"> mechanism.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">When a recipe is updated for a new version or has its code changed, it may influence the contents of the generated packages and, consequently, the image </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">or SDK.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">Poky deals with many </span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.43.1">recipes and images or SDKs frequently have tens or </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.44.1">hundreds of packages. </span><span class="koboSpan" id="kobo.44.2">Therefore, it may be</span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.45.1"> challenging to track the package contents. </span><span class="koboSpan" id="kobo.45.2">The</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.46.1"> Poky tool that helps in </span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.47.1">this task </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">buildhistory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">buildhistory</span></strong><span class="koboSpan" id="kobo.52.1">, as the name suggests, keeps a history of the contents of several artifacts built during the use of Poky. </span><span class="koboSpan" id="kobo.52.2">It tracks package, image, and SDK building and </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">their contents.</span></span></p>
<p><span class="koboSpan" id="kobo.54.1">To enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">buildhistory</span></strong><span class="koboSpan" id="kobo.56.1"> in our system, we need to add the following lines of code in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.58.1"> file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.59.1"><img alt="Figure 10.1 – How to enable ﻿buildhistory support" src="image/Figure_10.01_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.60.1">Figure 10.1 – How to enable buildhistory support</span></p>
<p><span class="koboSpan" id="kobo.61.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">INHERIT</span></strong><span class="koboSpan" id="kobo.63.1"> method includes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">buildhistory</span></strong><span class="koboSpan" id="kobo.65.1"> class hooks in the building process. </span><span class="koboSpan" id="kobo.65.2">At the same time, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">BUILDHISTORY_COMMIT</span></strong><span class="koboSpan" id="kobo.67.1"> line enables BitBake to create a new Git commit in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">buildhistory</span></strong><span class="koboSpan" id="kobo.69.1"> repository for every new package, image, or SDK build. </span><span class="koboSpan" id="kobo.69.2">The Git commit makes tracking as simple as using </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">git diff</span></strong><span class="koboSpan" id="kobo.71.1"> between two commits. </span><span class="koboSpan" id="kobo.71.2">The data is stored under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">build/buildhistory</span></strong><span class="koboSpan" id="kobo.73.1"> directory as text files for ease </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">of use.</span></span></p>
<p><span class="koboSpan" id="kobo.75.1">Poky provides a utility that outputs the</span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.76.1"> difference between two </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">buildhistory</span></strong><span class="koboSpan" id="kobo.78.1"> states, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">buildhistory-diff</span></strong><span class="koboSpan" id="kobo.80.1">, in a more concise way, which is very useful when checking for changes. </span><span class="koboSpan" id="kobo.80.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">buildhistory-diff</span></strong><span class="koboSpan" id="kobo.82.1"> utility</span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.83.1"> outputs the difference between any two Git revisions </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">more meaningfully.</span></span></p>
<p><span class="koboSpan" id="kobo.85.1">For example, suppose we add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">strace</span></strong><span class="koboSpan" id="kobo.87.1"> package in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">core-image-minimal</span></strong><span class="koboSpan" id="kobo.89.1"> image and build it. </span><span class="koboSpan" id="kobo.89.2">In that case, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">buildhistory-diff</span></strong><span class="koboSpan" id="kobo.91.1"> command can be used to check the resultant changes, as in the </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer125">
<span class="koboSpan" id="kobo.93.1"><img alt="Figure 10.2 – The result of buildhistory-diff" src="image/Figure_10.02_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.94.1">Figure 10.2 – The result of buildhistory-diff</span></p>
<p><span class="koboSpan" id="kobo.95.1">For every package build, </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">buildhistory</span></strong><span class="koboSpan" id="kobo.97.1"> creates a </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.98.1">list of generated sub-packages, installation scripts, a list of file ownership and sizes, the dependency relation, and more. </span><span class="koboSpan" id="kobo.98.2">In addition, the dependency relationship between the packages, filesystem files, and dependency graph is created for images </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">and SDKs.</span></span></p>
<p><span class="koboSpan" id="kobo.100.1">To better understand the</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.101.1"> capabilities and features provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">buildhistory</span></strong><span class="koboSpan" id="kobo.103.1">, refer to </span><em class="italic"><span class="koboSpan" id="kobo.104.1">Maintaining Build Output Quality in Yocto Project Development Tasks </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.105.1">Manual</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.106.1"> (</span></span><a href="https://docs.yoctoproject.org/4.0.4/dev-manual/common-tasks.html#maintaining-build-output-quality"><span class="No-Break"><span class="koboSpan" id="kobo.107.1">https://docs.yoctoproject.org/4.0.4/dev-manual/common-tasks.html#maintaining-build-output-quality</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.108.1">).</span></span></p>
<h1 id="_idParaDest-105"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.109.1">Debugging packaging</span></h1>
<p><span class="koboSpan" id="kobo.110.1">In more sophisticated recipes, we split </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.111.1">the installed contents into several sub-packages. </span><span class="koboSpan" id="kobo.111.2">The sub-packages can be optional features, modules, or any other set of files that is optional </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">to install.</span></span></p>
<p><span class="koboSpan" id="kobo.113.1">To inspect how the recipe’s content has been split, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">build/tmp/work/&lt;arch&gt;/&lt;recipe name&gt;/&lt;software version&gt;/packages-split</span></strong><span class="koboSpan" id="kobo.115.1"> directory. </span><span class="koboSpan" id="kobo.115.2">It contains a sub-directory for every sub-package and has its contents in </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">the sub-tree.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">Among the possible reasons for a mistaken content split, we have defined </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.119.1">The contents not being installed (for example, an error in </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">installation scripts)</span></span></li>
<li><span class="koboSpan" id="kobo.121.1">An application or library configuration error (for example, a </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">disabled feature)</span></span></li>
<li><span class="koboSpan" id="kobo.123.1">Metadata errors (for example, the wrong </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">package order)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.125.1">Another common issue for build failure is lacking the required artifacts in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">sysroot</span></strong><span class="koboSpan" id="kobo.127.1"> directory (for example, headers or dynamic libraries). </span><span class="koboSpan" id="kobo.127.2">The counterpart of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">sysroot</span></strong><span class="koboSpan" id="kobo.129.1"> generation can be seen </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">build/tmp/work/&lt;arch&gt;/&lt;recipe_name&gt;/&lt;software_version&gt;/sysroot-destdir</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.133.1">If this is not enough, we </span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.134.1">can instrument the task code with these logging functions to determine the logical error or bug that has caused the </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">unexpected result.</span></span></p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.136.1">Inspecting packages</span></h2>
<p><span class="koboSpan" id="kobo.137.1">A central aspect of the </span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.138.1">Yocto Project is dealing with the packages. </span><span class="koboSpan" id="kobo.138.2">Therefore, the project has designed </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">oe-pkgdata-util</span></strong><span class="koboSpan" id="kobo.140.1"> to help us to inspect the built packages and related data. </span><span class="koboSpan" id="kobo.140.2">For example, after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">bitbake bluez5</span></strong><span class="koboSpan" id="kobo.142.1">, we can use the following command to find all the packages related </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">bluez</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer126">
<span class="koboSpan" id="kobo.146.1"><img alt="Figure 10.3 – Listing all the available packages and filtering those related with bluez" src="image/Figure_10.03_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.147.1">Figure 10.3 – Listing all the available packages and filtering those related with bluez</span></p>
<p><span class="koboSpan" id="kobo.148.1">Sometimes, we need to find the package that includes this specific file. </span><span class="koboSpan" id="kobo.148.2">We can inquire about the packages database using the </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer127">
<span class="koboSpan" id="kobo.150.1"><img alt="Figure 10.4 – Finding which package provides /usr/bin/rfcomm" src="image/Figure_10.04_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.151.1">Figure 10.4 – Finding which package provides /usr/bin/rfcomm</span></p>
<p><span class="koboSpan" id="kobo.152.1">Another use case is when we need to find out the current version of a package. </span><span class="koboSpan" id="kobo.152.2">This can be done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer128">
<span class="koboSpan" id="kobo.154.1"><img alt="Figure 10.5 – Listing the package info for bluez5" src="image/Figure_10.05_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">Figure 10.5 – Listing the package info for bluez5</span></p>
<p><span class="koboSpan" id="kobo.156.1">We can also list all </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.157.1">the files for the given package using the </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer129">
<span class="koboSpan" id="kobo.159.1"><img alt="Figure 10.6 – Listing the files from the bluez5 package" src="image/Figure_10.06_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.160.1">Figure 10.6 – Listing the files from the bluez5 package</span></p>
<p><span class="koboSpan" id="kobo.161.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">oe-pkgdata-util</span></strong><span class="koboSpan" id="kobo.163.1"> script</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.164.1"> is </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.165.1">a handy tool to help us </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">debug packaging.</span></span></p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.167.1">Logging information during task execution</span></h1>
<p><span class="koboSpan" id="kobo.168.1">The logging utilities provided by BitBake are handy for tracing the code execution path. </span><span class="koboSpan" id="kobo.168.2">BitBake provides logging functions for use in </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.169.1">Python and Shell Script code, described </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.171.1">Python</span></strong><span class="koboSpan" id="kobo.172.1">: For use within </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.173.1">Python functions, BitBake supports several log levels such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">bb.fatal</span></strong><span class="koboSpan" id="kobo.175.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">bb.error</span></strong><span class="koboSpan" id="kobo.177.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">bb.warn</span></strong><span class="koboSpan" id="kobo.179.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">bb.note</span></strong><span class="koboSpan" id="kobo.181.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">bb.plain</span></strong><span class="koboSpan" id="kobo.183.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">bb.debug</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.187.1">Shell Script</span></strong><span class="koboSpan" id="kobo.188.1">: For use in Shell Script</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.189.1"> functions, the same set of log levels exists and is accessed with a similar syntax: </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">bbfatal</span></strong><span class="koboSpan" id="kobo.191.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">bberror</span></strong><span class="koboSpan" id="kobo.193.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">bbwarn</span></strong><span class="koboSpan" id="kobo.195.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">bbnote</span></strong><span class="koboSpan" id="kobo.197.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">bbplain</span></strong><span class="koboSpan" id="kobo.199.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">bbdebug</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.203.1">These logging functions are very similar to each other but have minor differences, described </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">bb.fatal</span></strong><span class="koboSpan" id="kobo.206.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">bbfatal</span></strong><span class="koboSpan" id="kobo.208.1">: These have the highest priority for logging messages as they print the message and terminate the processing. </span><span class="koboSpan" id="kobo.208.2">They cause the build to </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">be interrupted.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">bb.error</span></strong><span class="koboSpan" id="kobo.211.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">bberror</span></strong><span class="koboSpan" id="kobo.213.1">: These display an error but do not force the build </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">to stop.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">bb.warn</span></strong><span class="koboSpan" id="kobo.216.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">bbwarn</span></strong><span class="koboSpan" id="kobo.218.1">: These warn the users </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">about something.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">bb.note</span></strong><span class="koboSpan" id="kobo.221.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">bbnote</span></strong><span class="koboSpan" id="kobo.223.1">: These add a note to the user. </span><span class="koboSpan" id="kobo.223.2">They are </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">only informative.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">bb.plain</span></strong><span class="koboSpan" id="kobo.226.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">bbplain</span></strong><span class="koboSpan" id="kobo.228.1">: These output </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">a message.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">bb.debug</span></strong><span class="koboSpan" id="kobo.231.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">bbdebug</span></strong><span class="koboSpan" id="kobo.233.1">: These add debugging information that is shown depending on the debug </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">level used.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.235.1">There is one subtle difference between using the logging functions in Python and Shell Script. </span><span class="koboSpan" id="kobo.235.2">The logging functions in Python are directly handled by BitBake, seen on the console, and stored in the execution log inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">build/tmp/log/cooker/&lt;machine&gt;</span></strong><span class="koboSpan" id="kobo.237.1">. </span><span class="koboSpan" id="kobo.237.2">When the logging functions are used in Shell Script, the information is outputted to an individual task log file, which is available in </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">build/tmp/work/&lt;arch&gt;/&lt;recipe </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">name&gt;/&lt;software version&gt;/temp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.241.1">Inside the temp directory, we can inspect the scripts for every task with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">run.&lt;task&gt;.&lt;pid&gt;</span></strong><span class="koboSpan" id="kobo.243.1"> pattern and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">log.&lt;task&gt;.&lt;pid&gt;</span></strong><span class="koboSpan" id="kobo.245.1"> pattern for its output. </span><span class="koboSpan" id="kobo.245.2">Symbolic links point to the last log files using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">log.&lt;task&gt;</span></strong><span class="koboSpan" id="kobo.247.1"> pattern. </span><span class="koboSpan" id="kobo.247.2">For example, we can check for </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">log.do_compile</span></strong><span class="koboSpan" id="kobo.249.1"> to verify whether the right files were used during the </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">build</span></span><span class="No-Break"><a id="_idIndexMarker327"/></span><span class="No-Break"><span class="koboSpan" id="kobo.251.1"> process.</span></span></p>
<p><span class="koboSpan" id="kobo.252.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">build/tmp/work</span></strong><span class="koboSpan" id="kobo.254.1"> directory is detailed in </span><a href="B19361_06.xhtml#_idTextAnchor089"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.255.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.256.1">, </span><em class="italic"><span class="koboSpan" id="kobo.257.1">Detailing the Temporary </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.258.1">Build Directory</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">.</span></span></p>
<h1 id="_idParaDest-108"><a id="_idTextAnchor136"/><span class="koboSpan" id="kobo.260.1">Debugging metadata variables</span></h1>
<p><span class="koboSpan" id="kobo.261.1">To debug the </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.262.1">metadata variables, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">bitbake-getvar</span></strong><span class="koboSpan" id="kobo.264.1"> script. </span><span class="koboSpan" id="kobo.264.2">It uses the BitBake internal data to get a specific variable value and its </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">attribution history.</span></span></p>
<p><span class="koboSpan" id="kobo.266.1">For example, to inspect the </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">PACKAGECONFIG</span></strong><span class="koboSpan" id="kobo.268.1"> variable for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">procps</span></strong><span class="koboSpan" id="kobo.270.1"> recipe, we can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer130">
<span class="koboSpan" id="kobo.272.1"><img alt="Figure 10.7 – The result of bitbake-getvar -r procps PACKAGECONFIG" src="image/Figure_10.07_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.273.1">Figure 10.7 – The result of bitbake-getvar -r procps PACKAGECONFIG</span></p>
<p><span class="koboSpan" id="kobo.274.1">From </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.275.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.276.1">.7</span></em><span class="koboSpan" id="kobo.277.1">, we can see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">PACKAGECONFIG</span></strong><span class="koboSpan" id="kobo.279.1"> at the end is empty. </span><span class="koboSpan" id="kobo.279.2">We can also see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">defaultval</span></strong><span class="koboSpan" id="kobo.281.1"> was set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">"${@bb.utils.filter('DISTRO_FEATURES', 'systemd', d)}"</span></strong><span class="koboSpan" id="kobo.283.1"> at line 33 from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">meta/recipes-extended/procps/procps_3.3.17.bb</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.285.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.286.1">We can see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">procps</span></strong><span class="koboSpan" id="kobo.288.1"> recipe lines 33 and 34 in the </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer131">
<span class="koboSpan" id="kobo.290.1"><img alt="Figure 10.8 - The procps recipe 33 and 34 lines" src="image/Figure_10.08_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.291.1">Figure 10.8 - The procps recipe 33 and 34 lines</span></p>
<p><span class="koboSpan" id="kobo.292.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">bitbake-getvar</span></strong><span class="koboSpan" id="kobo.294.1"> script</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.295.1"> can be used to check whether a feature is enabled or to be sure a variable has been expanded as </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">we expect.</span></span></p>
<h1 id="_idParaDest-109"><a id="_idTextAnchor137"/><span class="koboSpan" id="kobo.297.1">Utilizing a development shell</span></h1>
<p><span class="koboSpan" id="kobo.298.1">A development shell</span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.299.1"> can be a helpful tool when editing packages or debugging build failures. </span><span class="koboSpan" id="kobo.299.2">The </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.300.1">following steps take place when we</span><a id="_idIndexMarker332"/> <span class="No-Break"><span class="koboSpan" id="kobo.301.1">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">devshell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.304.1">Source files are extracted into the </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">working directory.</span></span></li>
<li><span class="koboSpan" id="kobo.306.1">Patches </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">are applied.</span></span></li>
<li><span class="koboSpan" id="kobo.308.1">A new terminal is opened in the </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">working directory.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.310.1">All the environment variables needed for the build are available in the new terminal, so we can use commands such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">configure</span></strong><span class="koboSpan" id="kobo.312.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">make</span></strong><span class="koboSpan" id="kobo.314.1">. </span><span class="koboSpan" id="kobo.314.2">The commands execute just as if the build system were </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">running them.</span></span></p>
<p><span class="koboSpan" id="kobo.316.1">The following command is an example that uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">devshell</span></strong><span class="koboSpan" id="kobo.318.1"> on a target </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">linux-yocto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer132">
<span class="koboSpan" id="kobo.322.1"><img alt="Figure 10.9 – Running devshell for the linux-yocto recipe" src="image/Figure_10.09_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.323.1">Figure 10.9 – Running devshell for the linux-yocto recipe</span></p>
<p><span class="koboSpan" id="kobo.324.1">The command from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.325.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.326.1">.9</span></em><span class="koboSpan" id="kobo.327.1"> allows us to rework the Linux kernel source code, build it, and change its code as needed. </span><span class="koboSpan" id="kobo.327.2">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.328.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.329.1">.10</span></em><span class="koboSpan" id="kobo.330.1">, you can see the log after executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">bitbake linux-yocto -c </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">devshell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.333.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer133">
<span class="koboSpan" id="kobo.334.1"><img alt="Figure 10.10 – The log for bitbake linux-yocto -c devshell" src="image/Figure_10.10_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.335.1">Figure 10.10 – The log for bitbake linux-yocto -c devshell</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.336.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.337.1">It is crucial to remember that changes made inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">devshell</span></strong><span class="koboSpan" id="kobo.339.1"> do not persist between builds; thus, we must be careful to record any critical change before </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">leaving it.</span></span></p>
<p><span class="koboSpan" id="kobo.341.1">Since we have </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.342.1">the source at our disposal, we can use it to generate extra patches. </span><span class="koboSpan" id="kobo.342.2">A convenient way of doing that is using Git and </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">git format-patch</span></strong><span class="koboSpan" id="kobo.344.1"> to create the patch </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.345.1">to be included in the </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">recipe afterward.</span></span></p>
<p><span class="koboSpan" id="kobo.347.1">The following screenshot shows the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">devshell</span></strong><span class="koboSpan" id="kobo.349.1"> window open after calling the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">devshell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.351.1"> task:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer134">
<span class="koboSpan" id="kobo.352.1"><img alt="Figure 10.11 – The list of files inside the WORKDIR directory" src="image/Figure_10.11_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.353.1">Figure 10.11 – The list of files inside the WORKDIR directory</span></p>
<p><span class="koboSpan" id="kobo.354.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">devshell</span></strong><span class="koboSpan" id="kobo.356.1"> command</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.357.1"> is convenient for small tasks. </span><span class="koboSpan" id="kobo.357.2">But when a more involved change is needed, using an external</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.358.1"> toolchain or </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">devtool</span></strong><span class="koboSpan" id="kobo.360.1"> might be a </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">better option.</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">To include the generated patch in the recipe and make it persistent, see </span><a href="B19361_13.xhtml#_idTextAnchor158"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.363.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.364.1">, </span><em class="italic"><span class="koboSpan" id="kobo.365.1">Customizing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.366.1">Existing Recipes</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">.</span></span></p>
<h1 id="_idParaDest-110"><a id="_idTextAnchor138"/><span class="koboSpan" id="kobo.368.1">Using the GNU Debugger for debugging</span></h1>
<p><span class="koboSpan" id="kobo.369.1">While developing any project, from </span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.370.1">time to time, we end up struggling </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.371.1">to understand subtle bugs. </span><span class="koboSpan" id="kobo.371.2">The GDB is available as a package in Poky. </span><span class="koboSpan" id="kobo.371.3">It is installed in SDK images by default, as was detailed in </span><a href="B19361_09.xhtml#_idTextAnchor115"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.372.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.373.1">, </span><em class="italic"><span class="koboSpan" id="kobo.374.1">Developing with the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.375.1">Yocto Project</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.377.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.378.1">To install debugging packages containing the debug symbols and tools in an image, add </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">IMAGE_FEATURES += "dbg-pkgs tools-debug"</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.380.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.383.1">Using the SDK or an image with the debugging packages and tools installed allows us to debug applications directly in the target, replicating the same development workflow we usually do on </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">our machine.</span></span></p>
<p><span class="koboSpan" id="kobo.385.1">The GDB may not be usable on some targets because of memory or disk space constraints. </span><span class="koboSpan" id="kobo.385.2">The main reason for this limitation is that the GDB needs to load the debugging information and the binaries of the debugging process before starting the </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">debugging process.</span></span></p>
<p><span class="koboSpan" id="kobo.387.1">To overcome these constraints, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">gdbserver</span></strong><span class="koboSpan" id="kobo.389.1">, included by default when using </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">tools-debug</span></strong><span class="koboSpan" id="kobo.391.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">IMAGE_FEATURES</span></strong><span class="koboSpan" id="kobo.393.1">. </span><span class="koboSpan" id="kobo.393.2">It runs on the target and doesn’t load any debugging information from the debugged process. </span><span class="koboSpan" id="kobo.393.3">Instead, a GDB instance processes the debugging information on the build host. </span><span class="koboSpan" id="kobo.393.4">The host GDB sends control commands to </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">gdbserver</span></strong><span class="koboSpan" id="kobo.395.1"> to control the debugged application, so the target does not need to have the debugging </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">symbols installed.</span></span></p>
<p><span class="koboSpan" id="kobo.397.1">However, we </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.398.1">must ensure the host can access the </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.399.1">binaries with their debugging information. </span><span class="koboSpan" id="kobo.399.2">Therefore, it is recommended that the target binaries are compiled with no optimization to facilitate the </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">debugging process.</span></span></p>
<p><span class="koboSpan" id="kobo.401.1">The process for using </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">gdbserver</span></strong><span class="koboSpan" id="kobo.403.1"> and adequately configuring the host and target is detailed in the </span><em class="italic"><span class="koboSpan" id="kobo.404.1">Debugging With the GNU Project Debugger (GDB) Remotely section in Yocto Project Development Tasks </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.405.1">Manual</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.406.1"> (</span></span><a href="https://docs.yoctoproject.org/4.0.4/dev-manual/common-tasks.html#debugging-with-the-gnu-project-debugger-gdb-remotely"><span class="No-Break"><span class="koboSpan" id="kobo.407.1">https://docs.yoctoproject.org/4.0.4/dev-manual/common-tasks.html#debugging-with-the-gnu-project-debugger-gdb-remotely</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.408.1">).</span></span></p>
<h1 id="_idParaDest-111"><a id="_idTextAnchor139"/><span class="koboSpan" id="kobo.409.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.410.1">In this chapter, we learned how to configure Poky to help us with the debugging process. </span><span class="koboSpan" id="kobo.410.2">We learned about the contents of deployed directories that can be used for debugging and how we can track our changes using </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">buildhistory</span></strong><span class="koboSpan" id="kobo.412.1">. </span><span class="koboSpan" id="kobo.412.2">We also covered the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">oe-pkgdata-util</span></strong><span class="koboSpan" id="kobo.414.1"> to inspect package information, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">bitbake-getvar</span></strong><span class="koboSpan" id="kobo.416.1"> to debug variable expansion, how we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">devshell</span></strong><span class="koboSpan" id="kobo.418.1"> to emulate the same build environment found by BitBake, and how we configure our system to provide the tools needed for </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">GDB debugging.</span></span></p>
<p><span class="koboSpan" id="kobo.420.1">In the next chapter, we will learn how to expand the Poky source code using external layers. </span><span class="koboSpan" id="kobo.420.2">First, we will introduce the concept of layering. </span><span class="koboSpan" id="kobo.420.3">Then, we will learn in detail about the directory structure and the content of each </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">layer type.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer136">
</div>
</div>
</body></html>