<html><head></head><body>
<div class="_idGenObjectStyleOverride-1" id="_idContainer359">
<p class="Chapter-Title" id="_idParaDest-240" lang="en-US" xml:lang="en-US"><span class="ChapterMarker"><span class="koboSpan" id="kobo.1.1">27. </span></span><a id="_idTextAnchor407"/><span class="koboSpan" id="kobo.2.1">Creating an Ubuntu 23.04 KVM </span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.3.1">Networked Bridge Interface</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.4.1">By default, the KVM virtualization environment on Ubuntu creates a virtual network to which virtual machines may connect. </span><span class="koboSpan" id="kobo.4.2">It is also possible to configure a direct connection using a MacVTap driver. </span><span class="koboSpan" id="kobo.4.3">However, as outlined in the chapter entitled </span><a href="Virtualization_Overview.xhtml#_idTextAnchor361"><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.5.1">“An Overview of Virtualization Techniques”</span></span></a><span class="koboSpan" id="kobo.6.1">, this approach does not allow the host and guest systems to communicate. </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.7.1">This chapter will cover the steps involved in creating a network bridge on Ubuntu, enabling guest systems to share one or more of the host system’s physical network connections while still allowing the guest and host systems to communicate.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.8.1">In the remainder of this chapter, we will explain how to configure an Ubuntu network bridge for KVM-based guest operating systems.</span></p>
<p class="Heading-1-1" id="_idParaDest-241" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.9.1">27.1 </span></span><a id="_idTextAnchor408"/><span class="koboSpan" id="kobo.10.1">Getting the Current Network Manager Settings</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.11.1">A network bridge can be created using the NetworkManager command-line interface tool (nmcli). </span><span class="koboSpan" id="kobo.11.2">The NetworkManager is installed and enabled by default on Ubuntu systems and is responsible for detecting and connecting to network devices and providing an interface for managing networking configurations.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.12.1">A list of current network connections on the host system can be displayed as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.13.1"># nmcli con show</span></p>
<p class="Code"><span class="koboSpan" id="kobo.14.1">NAME                UUID                                  TYPE      DEVICE </span></p>
<p class="Code"><span class="koboSpan" id="kobo.15.1">Wired connection 1  daae7adc-2a52-3fa0-9085-25748531e1b6  ethernet  eno1   </span></p>
<p class="Code"><span class="koboSpan" id="kobo.16.1">virbr0              299e0d95-4f39-4e65-aace-c7abbd8b018d  bridge    virbr0 </span></p>
<p class="Code"><span class="koboSpan" id="kobo.17.1">vnet2               bcb3cd6e-dae4-4545-b98b-e8f90c86dadb  tun       vnet2 </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.18.1">The above output shows that the host has an Ethernet network connection established via a device named eno1 and the default bridge interface named </span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.19.1">virbr0, which provides access to the NAT-based virtual network to which KVM guest systems are connected by default.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.20.1">Similarly, the following command can be used to identify the devices (both virtual and physical) that are currently configured on the system:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.21.1"># nmcli device show</span></p>
<p class="Code"><span class="koboSpan" id="kobo.22.1">GENERAL.DEVICE:                         eno1</span></p>
<p class="Code"><span class="koboSpan" id="kobo.23.1">GENERAL.TYPE:                           ethernet</span></p>
<p class="Code"><span class="koboSpan" id="kobo.24.1">GENERAL.HWADDR:                         00:23:24:52:52:57</span></p>
<p class="Code"><span class="koboSpan" id="kobo.25.1">GENERAL.MTU:                            1500</span></p>
<p class="Code"><span class="koboSpan" id="kobo.26.1">GENERAL.STATE:                          100 (connected)</span></p>
<p class="Code"><span class="koboSpan" id="kobo.27.1">GENERAL.CONNECTION:                     Wired connection 1</span></p>
<p class="Code"><span class="koboSpan" id="kobo.28.1">GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveC&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.29.1">WIRED-PROPERTIES.CARRIER:               on</span></p>
<p class="Code"><span class="koboSpan" id="kobo.30.1">IP4.ADDRESS[1]:                         192.168.86.39/24</span></p>
<p class="Code"><span class="koboSpan" id="kobo.31.1">IP4.GATEWAY:                            192.168.86.1</span></p>
<p class="Code"><span class="koboSpan" id="kobo.32.1">IP4.ROUTE[1]:                           dst = 169.254.0.0/16, nh = 0.0.0.0, mt &gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.33.1">IP4.ROUTE[2]:                           dst = 192.168.86.0/24, nh = 0.0.0.0, mt&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.34.1">IP4.ROUTE[3]:                           dst = 0.0.0.0/0, nh = 192.168.86.1, mt &gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.35.1">IP4.DNS[1]:                             192.168.86.1</span></p>
<p class="Code"><span class="koboSpan" id="kobo.36.1">IP4.DOMAIN[1]:                          lan</span></p>
<p class="Code"><span class="koboSpan" id="kobo.37.1">IP6.ADDRESS[1]:                         fda8:b48c:1079:0:5f:670e:a693:9ae2/64</span></p>
<p class="Code"><span class="koboSpan" id="kobo.38.1">IP6.ADDRESS[2]:                         fda8:b48c:1079:0:c734:89bd:8384:992d/64</span></p>
<p class="Code"><span class="koboSpan" id="kobo.39.1">IP6.ADDRESS[3]:                         fda8:b48c:1079:0:ec7b:35d8:8253:3739/64</span></p>
<p class="Code"><span class="koboSpan" id="kobo.40.1">IP6.ADDRESS[4]:                         fe80::1e40:b04c:3de4:5fe0/64</span></p>
<p class="Code"><span class="koboSpan" id="kobo.41.1">IP6.GATEWAY:                            --</span></p>
<p class="Code"><span class="koboSpan" id="kobo.42.1">IP6.ROUTE[1]:                           dst = fda8:b48c:1079::/64, nh = ::, mt &gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.43.1">IP6.ROUTE[2]:                           dst = fe80::/64, nh = ::, mt = 1024</span></p>
<p class="Code"><span class="koboSpan" id="kobo.44.1">IP6.ROUTE[3]:                           dst = fd56:6a14:af59:1::/64, nh = fe80:&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.45.1">GENERAL.DEVICE:                         virbr0</span></p>
<p class="Code"><span class="koboSpan" id="kobo.46.1">GENERAL.TYPE:                           bridge</span></p>
<p class="Code"><span class="koboSpan" id="kobo.47.1">GENERAL.HWADDR:                         52:54:00:00:A8:CA</span></p>
<p class="Code"><span class="koboSpan" id="kobo.48.1">GENERAL.MTU:                            1500</span></p>
<p class="Code"><span class="koboSpan" id="kobo.49.1">GENERAL.STATE:                          100 (connected (externally))</span></p>
<p class="Code"><span class="koboSpan" id="kobo.50.1">GENERAL.CONNECTION:                     virbr0</span></p>
<p class="Code"><span class="koboSpan" id="kobo.51.1">GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveC&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.52.1">IP4.ADDRESS[1]:                         192.168.122.1/24</span></p>
<p class="Code"><span class="koboSpan" id="kobo.53.1">IP4.GATEWAY:                            --</span></p>
<p class="Code"><span class="koboSpan" id="kobo.54.1">IP4.ROUTE[1]:                           dst = 192.168.122.0/24, nh = 0.0.0.0, m&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.55.1">IP6.GATEWAY:                            --</span></p>
<p class="Code"><span class="koboSpan" id="kobo.56.1">.</span></p>
<p class="Code"><span class="koboSpan" id="kobo.57.1">.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.58.1">The above partial output indicates that the host system on which the command was executed contains a physical Ethernet device (eno1) and a virtual bridge (</span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.59.1">virbr0).</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.60.1">The virsh command may also be used to list the virtual networks currently configured on the system:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.61.1"># virsh net-list --all</span></p>
<p class="Code"><span class="koboSpan" id="kobo.62.1"> Name                 State      Autostart     Persistent</span></p>
<p class="Code"><span class="koboSpan" id="kobo.63.1">----------------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.64.1"> default              active     yes           yes</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.65.1">Currently, the only virtual network present is the default network provided by virbr0. </span><span class="koboSpan" id="kobo.65.2">Now that some basic information about the current network configuration has been obtained, the next step is to create a network bridge connected to the physical network device (in this case, eno1).</span></p>
<p class="Heading-1-1" id="_idParaDest-242" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.66.1">27.2 </span></span><a id="_idTextAnchor409"/><span class="koboSpan" id="kobo.67.1">Creating a Network Manager Bridge from the Command-Line</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.68.1">The first step in creating the network bridge is adding a new connection to the configuration. </span><span class="koboSpan" id="kobo.68.2">This can be achieved using the </span><a id="_idIndexMarker619"/><a id="_idIndexMarker620"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.69.1">nmcli</span></span><span class="koboSpan" id="kobo.70.1"> tool, specifying that the connection is to be a bridge and providing names for both the connection and the interface:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.71.1"># nmcli con add ifname br0 type bridge con-name br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.72.1">Once the connection has been added, a bridge slave interface needs to be established between physical device eno1 (the slave) and the bridge connection br0 (the master) as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.73.1"># nmcli con add type bridge-slave ifname eno1 master br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.74.1">At this point, the NetworkManager connection list should read as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.75.1"># nmcli con show</span></p>
<p class="Code"><span class="koboSpan" id="kobo.76.1">br0                 8680c281-6d49-4f76-93b1-902c42514ca5  bridge    br0    </span></p>
<p class="Code"><span class="koboSpan" id="kobo.77.1">Wired connection 1  126ab0e8-d4d3-3326-bd5e-1fea169c5635  ethernet  eno1   </span></p>
<p class="Code"><span class="koboSpan" id="kobo.78.1">virbr0              556042d4-2e5d-45fe-9c78-a24259e07265  bridge    virbr0 </span></p>
<p class="Code"><span class="koboSpan" id="kobo.79.1">bridge-slave-eno1   e6ba8ead-8fa9-4434-a884-d39225ecda20  ethernet  --</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">The next step is to start up the bridge interface. </span><span class="koboSpan" id="kobo.80.2">If the steps to configure the bridge are being performed over a network connection (i.e., via SSH) this step can be problematic because the current "Wired connection 1" connection must be closed down before the bridge connection can be brought up. </span><span class="koboSpan" id="kobo.80.3">This means the current connection will be lost before the bridge connection can be enabled to replace it, potentially leaving the remote host unreachable.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.81.1">If you are accessing the host system remotely, this problem can be avoided by creating a shell script to perform the network changes. </span><span class="koboSpan" id="kobo.81.2">This will ensure that the bridge interface is enabled after the ”Wired connection 1” interface is brought down, allowing you to reconnect to the host after the changes are complete. </span><span class="koboSpan" id="kobo.81.3">Begin by creating a shell script file named </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.82.1">bridge.sh </span></span><span class="koboSpan" id="kobo.83.1">containing the following commands:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.84.1">#!/bin/bash</span></p>
<p class="Code"><span class="koboSpan" id="kobo.85.1">nmcli con down "Wired connection 1"</span></p>
<p class="Code"><span class="koboSpan" id="kobo.86.1">nmcli con up br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.87.1">Once the script has been created, execute it as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.88.1"># sh ./bridge.sh</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.89.1">When the script executes, the connection will be lost when the ”Wired connection 1” connection is brought down. </span><span class="koboSpan" id="kobo.89.2">After waiting a few seconds, however, it should be possible to reconnect to the host once the br0 connection has been activated. </span><span class="koboSpan" id="kobo.89.3">Note that in some cases, the bridge interface may be assigned a different IP address than the one previously assigned to the system. </span><span class="koboSpan" id="kobo.89.4">Keep this in mind while attempting to reconnect via ssh.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.90.1">If you are working locally on the host, the two </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.91.1">nmcli</span></span><span class="koboSpan" id="kobo.92.1"> commands can be run within a terminal window without any risk of losing connectivity:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.93.1"># nmcli con down "Wired connection 1"</span></p>
<p class="Code"><span class="koboSpan" id="kobo.94.1"># nmcli con up br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.95.1">Once the bridge is up and running, the connection list should now include both the bridge and the bridge-slave connections:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.96.1"># nmcli con show</span></p>
<p class="Code"><span class="koboSpan" id="kobo.97.1">NAME                UUID                                  TYPE      DEVICE </span></p>
<p class="Code"><span class="koboSpan" id="kobo.98.1">br0                 8680c281-6d49-4f76-93b1-902c42514ca5  bridge    br0    </span></p>
<p class="Code"><span class="koboSpan" id="kobo.99.1">virbr0              556042d4-2e5d-45fe-9c78-a24259e07265  bridge    virbr0 </span></p>
<p class="Code"><span class="koboSpan" id="kobo.100.1">bridge-slave-eno1   e6ba8ead-8fa9-4434-a884-d39225ecda20  ethernet  eno1   </span></p>
<p class="Code"><span class="koboSpan" id="kobo.101.1">Wired connection 1  126ab0e8-d4d3-3326-bd5e-1fea169c5635  ethernet  -- </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.102.1">Note that the ”Wired connection 1” connection is still listed but is no longer active. </span><span class="koboSpan" id="kobo.102.2">To exclude inactive connections from the list, use the --active flag when requesting the list:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.103.1"># nmcli con show --active</span></p>
<p class="Code"><span class="koboSpan" id="kobo.104.1">NAME               UUID                                  TYPE      DEVICE </span></p>
<p class="Code"><span class="koboSpan" id="kobo.105.1">br0                8680c281-6d49-4f76-93b1-902c42514ca5  bridge    br0    </span></p>
<p class="Code"><span class="koboSpan" id="kobo.106.1">virbr0             556042d4-2e5d-45fe-9c78-a24259e07265  bridge    virbr0 </span></p>
<p class="Code"><span class="koboSpan" id="kobo.107.1">bridge-slave-eno1  e6ba8ead-8fa9-4434-a884-d39225ecda20  ethernet  eno1</span></p>
<p class="Heading-1-1" id="_idParaDest-243" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.108.1">27.3 </span></span><a id="_idTextAnchor410"/><span class="koboSpan" id="kobo.109.1">Declaring the KVM Bridged Network</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.110.1">At this point, the bridge connection is on the system but is not visible to the KVM environment. </span><span class="koboSpan" id="kobo.110.2">Running the virsh command should still list the default network as being the only available network option:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.111.1"># virsh net-list --all</span></p>
<p class="Code"><span class="koboSpan" id="kobo.112.1"> Name                 State      Autostart     Persistent</span></p>
<p class="Code"><span class="koboSpan" id="kobo.113.1">----------------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.114.1"> default              active     yes           yes</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.115.1">Before a virtual machine can use the bridge, it must be declared and added to the KVM network configuration. </span><span class="koboSpan" id="kobo.115.2">This involves the creation of a definition file and, once again, using the </span><a id="_idIndexMarker621"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.116.1">virsh </span></span><span class="koboSpan" id="kobo.117.1">command-line tool.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.118.1">Begin by creating a definition file for the bridge network named </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.119.1">bridge.xml</span></span><span class="koboSpan" id="kobo.120.1"> that reads as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.121.1">&lt;network&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.122.1">  &lt;name&gt;br0&lt;/name&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.123.1">  &lt;forward mode="bridge"/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.124.1">  &lt;bridge name="br0" /&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.125.1">&lt;/network&gt;</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.126.1">Next, use the file to define the new network:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.127.1"># virsh net-define ./bridge.xml</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.128.1">Once the network has been defined, start it and, if required, configure it to autostart each time the system reboots:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.129.1"># virsh net-start br0</span></p>
<p class="Code"><span class="koboSpan" id="kobo.130.1"># virsh net-autostart br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.131.1">Once again, list the networks to verify that the bridge network is now accessible within the KVM environment:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.132.1"># virsh net-list --all</span></p>
<p class="Code"><span class="koboSpan" id="kobo.133.1"> Name                 State      Autostart     Persistent</span></p>
<p class="Code"><span class="koboSpan" id="kobo.134.1">----------------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.135.1"> br0                  active     yes           yes</span></p>
<p class="Code"><span class="koboSpan" id="kobo.136.1"> default              active     yes           yes</span></p>
<p class="Heading-1-1" id="_idParaDest-244" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.137.1">27.4 </span></span><a id="_idTextAnchor411"/><span class="koboSpan" id="kobo.138.1">Using a Bridge Network in a Virtual Machine</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.139.1">To create a virtual machine that uses the bridge network, use the </span><a id="_idIndexMarker622"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.140.1">virt-install --network</span></span><span class="koboSpan" id="kobo.141.1"> option and specify the br0 bridge name. </span><span class="koboSpan" id="kobo.141.2">For example:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.142.1"># virt-install --name demo_vm_guest --memory 1024 --disk path=/tmp/demo_vm_guest.img,size=10 --network network=br0 --cdrom /home/demo/ubuntu-23.04-desktop-amd64.iso</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.143.1">When the guest operating system runs, it will appear on the same physical network as the host system and will no longer be on the NAT-based virtual network.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.144.1">The bridge may also be selected for virtual machines within the </span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.145.1">Cockpit interface by editing the virtual machine, locating the Network interfaces section, and clicking the Edit button as highlighted in </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor412"><span class="koboSpan" id="kobo.146.1">Figure 27-1</span></a><span class="koboSpan" id="kobo.147.1"> below:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.148.1"><img alt="" class="_idGenObjectAttribute-1" src="image/ubuntu_cockpit_edit_network.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.149.1">Figure 27-1</span></span><a id="_idTextAnchor412"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.150.1">Within the resulting interface settings dialog, change the Interface type menu to Bridge to LAN and set the Source to br0 as shown in </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor413"><span class="koboSpan" id="kobo.151.1">Figure 27-2</span></a><span class="koboSpan" id="kobo.152.1">:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.153.1"><img alt="" class="_idGenObjectAttribute-2" src="image/cockpit_kvm_bridge.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.154.1">Figure 27-2</span></span><a id="_idTextAnchor413"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">Similarly, when creating a new virtual machine using the </span><a id="_idIndexMarker624"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.156.1">virt-manager</span></span><span class="koboSpan" id="kobo.157.1"> tool, the bridge will be available within the Network selection menu:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.158.1"><img alt="" class="_idGenObjectAttribute-3" src="image/ubuntu_virt-manager_bridge.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.159.1">Figure 27-3</span></span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.160.1">To modify an existing virtual machine so that it uses the bridge, use the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.161.1">virsh edit</span></span><span class="koboSpan" id="kobo.162.1"> command. </span><span class="koboSpan" id="kobo.162.2">This command loads the XML definition file into an editor where changes can be made and saved: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.163.1"># </span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.164.1">virsh edit GuestName</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.165.1">By default, the file will be loaded into the vi editor. </span><span class="koboSpan" id="kobo.165.2">To use a different editor, change the $EDITOR environment variable, for example:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.166.1"># export EDITOR=gedit</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.167.1">To change from the default virtual network, locate the &lt;interface&gt; section of the file, which will read as follows for a NAT-based configuration:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.168.1">&lt;interface type='network'&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.169.1">      &lt;mac address='&lt;your mac address here&gt;'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.170.1">      &lt;source network='default'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.171.1">      &lt;model type='virtio'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.172.1">      &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.173.1">&lt;/interface&gt;</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.174.1">Alternatively, if the virtual machine was using a direct connection, the entry may read as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.175.1">&lt;interface type='direct'&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.176.1">      &lt;mac address='&lt;your mac address here&gt;'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.177.1">      &lt;source dev='eno1' mode='vepa'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.178.1">      &lt;model type='virtio'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.179.1">      &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.180.1">To use the bridge, change the source network property to read as follows before saving the file:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.181.1">&lt;interface type='network'&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.182.1">      &lt;mac address='&lt;your mac address here&gt;'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.183.1">      &lt;source network='br0'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.184.1">      &lt;model type='virtio'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.185.1">      &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.186.1">&lt;/interface&gt;</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.187.1">If the virtual machine is already running, the change will not take effect until it is restarted.</span></p>
<p class="Heading-1-1" id="_idParaDest-245" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.188.1">27.5 </span></span><a id="_idTextAnchor414"/><span class="koboSpan" id="kobo.189.1">Creating a Bridge Network using </span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.190.1">nm-connection-editor</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.191.1">If either local or remote desktop access is available on the host system, much of the bridge configuration process can be performed using the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.192.1">nm-connection-editor</span></span><span class="koboSpan" id="kobo.193.1"> graphical tool. </span><span class="koboSpan" id="kobo.193.2">To use this tool, open a Terminal window within the desktop and enter the following command:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.194.1"># nm-connection-editor</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.195.1">When the tool has loaded, the window shown in </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor415"><span class="koboSpan" id="kobo.196.1">Figure 27-4</span></a><span class="koboSpan" id="kobo.197.1"> will appear, listing the currently configured network connections (essentially the same output as that generated by the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.198.1">nmcli con show </span></span><span class="koboSpan" id="kobo.199.1">command):</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.200.1"><img alt="" class="_idGenObjectAttribute-4" src="image/ubuntu_nm-connection_editor_home.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.201.1">Figure 27-4</span></span><a id="_idTextAnchor415"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.202.1">To create a new connection, click on the ‘+’ button in the window’s bottom left-hand corner. </span><span class="koboSpan" id="kobo.202.2">Then, from the resulting dialog (</span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor416"><span class="koboSpan" id="kobo.203.1">Figure 27-5</span></a><span class="koboSpan" id="kobo.204.1">), select the Bridge option from the menu:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.205.1"><img alt="" class="_idGenObjectAttribute-5" src="image/ubuntu_new_bridge.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.206.1">Figure 27-5</span></span><a id="_idTextAnchor416"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.207.1">With the bridge option selected, click the Create button to proceed to the bridge configuration screen. </span><span class="koboSpan" id="kobo.207.2">Begin by changing both the connection and interface name fields to br0 before clicking on the Add button located to the right of the Bridge connections list, as highlighted in </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor417"><span class="koboSpan" id="kobo.208.1">Figure 27-6</span></a><span class="koboSpan" id="kobo.209.1">:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.210.1"><img alt="" class="_idGenObjectAttribute-6" src="image/ubuntu_edit_bridge.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.211.1">Figure 27-6</span></span><a id="_idTextAnchor417"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.212.1">From the connection type dialog (</span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor418"><span class="koboSpan" id="kobo.213.1">Figure 27-7</span></a><span class="koboSpan" id="kobo.214.1">), change the menu setting to Ethernet before clicking on the Create button:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.215.1"><img alt="" class="_idGenObjectAttribute-7" src="image/ubuntu_new_ethernet.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.216.1">Figure 27-7</span></span><a id="_idTextAnchor418"/></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.217.1">Another dialog will now appear in which the bridge slave connection needs to be configured. </span><span class="koboSpan" id="kobo.217.2">Within this dialog, select the physical network to which the bridge is to connect (for example, eno1) from the Device menu:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.218.1"><img alt="" class="_idGenObjectAttribute-8" src="image/ubuntu_edit_ethernet.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.219.1">Figure 27-8</span></span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.220.1">Click on the Save button to apply the changes and return to the Editing br0 dialog (as illustrated in </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor417"><span class="koboSpan" id="kobo.221.1">Figure 27-6</span></a><span class="koboSpan" id="kobo.222.1"> above). </span><span class="koboSpan" id="kobo.222.2">Within this dialog, click on the Save button to create the bridge. </span><span class="koboSpan" id="kobo.222.3">On returning to the main window, the new bridge and slave connections should now be listed:</span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.223.1"><img alt="" class="_idGenObjectAttribute-9" src="image/ubuntu_br0_ready.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US" xml:lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.224.1">Figure 27-9</span></span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.225.1">All that remains is to bring down the original ”Wired connection 1” connection and bring up the br0 connection using the steps outlined in the previous chapter (remembering to perform these steps in a shell script if the host is being accessed remotely):</span></p>
<p class="Code"><span class="koboSpan" id="kobo.226.1"># nmcli con down "Wired connection 1"</span></p>
<p class="Code"><span class="koboSpan" id="kobo.227.1"># nmcli con up br0</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.228.1">It will also be necessary, as it was when creating the bridge using the command-line tool, to add this bridge to the KVM network configuration. </span><span class="koboSpan" id="kobo.228.2">To do so, repeat the steps outlined in the </span><a href="KVM_Network_Bridge.xhtml#_idTextAnchor410"><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.229.1">“Declaring the KVM Bridged Network”</span></span></a><span class="koboSpan" id="kobo.230.1"> section above. </span><span class="koboSpan" id="kobo.230.2">Once this step has been taken, the bridge is ready to be used by guest virtual machines.</span></p>
<p class="Heading-1-1" id="_idParaDest-246" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.231.1">27.6 </span></span><a id="_idTextAnchor419"/><span class="koboSpan" id="kobo.232.1">Summary</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.233.1">By default, KVM virtual machines are connected to a virtual network that uses NAT to provide access to the network to which the host system is connected. </span><span class="koboSpan" id="kobo.233.2">If the guests are required to appear on the network with their own IP addresses, they need to be configured to share the physical network interface of the host system. </span><span class="koboSpan" id="kobo.233.3">This chapter outlines that this can be achieved using the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.234.1">nmcli</span></span><span class="koboSpan" id="kobo.235.1"> or </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.236.1">nm-connection-editor</span></span><span class="koboSpan" id="kobo.237.1"> tools to create a networked bridge interface.</span></p>
</div>
</body></html>