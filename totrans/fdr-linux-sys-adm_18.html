<html><head></head><body>
<div id="_idContainer493" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-175"><a id="_idTextAnchor240" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-176" class="calibre5"><a id="_idTextAnchor241" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.2.1">Untangling Security with SELinux</span></h1>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.3.1">Security</span></em><span class="kobospan" id="kobo.4.1">, </span><em class="italic"><span class="kobospan" id="kobo.5.1">Hardening</span></em><span class="kobospan" id="kobo.6.1">, </span><em class="italic"><span class="kobospan" id="kobo.7.1">Compliance</span></em><span class="kobospan" id="kobo.8.1">, and </span><em class="italic"><span class="kobospan" id="kobo.9.1">Policy</span></em><span class="kobospan" id="kobo.10.1">: these are the four horsemen of the SysAdmin apocalypse. </span><span class="kobospan" id="kobo.10.2">One of the big battles is maintaining the security of the systems. </span><span class="kobospan" id="kobo.10.3">Besides the daily tasks, the security of the systems is part of the job, even those systems where the third-party provider asks us to deactivate the </span><em class="italic"><span class="kobospan" id="kobo.11.1">enhanced security</span></em><span class="kobospan" id="kobo.12.1">. </span><span class="kobospan" id="kobo.12.2">In most of these cases, an analysis </span><a id="_idIndexMarker950" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.13.1">is enough to find the right troubleshooting method or </span><span><span class="kobospan" id="kobo.14.1">a workaround.</span></span></p>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.15.1">Security-Enhanced Linux</span></strong><span class="kobospan" id="kobo.16.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.17.1">SELinux</span></strong><span class="kobospan" id="kobo.18.1">) is a code that runs in the user space, leveraging </span><a id="_idIndexMarker951" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.19.1">kernel code (</span><strong class="bold"><span class="kobospan" id="kobo.20.1">Linux Security Modules</span></strong><span class="kobospan" id="kobo.21.1">) to provide </span><strong class="bold"><span class="kobospan" id="kobo.22.1">mandatory access control</span></strong><span class="kobospan" id="kobo.23.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.24.1">MAC</span></strong><span class="kobospan" id="kobo.25.1">) over system resources. </span><span class="kobospan" id="kobo.25.2">The access to system objects </span><a id="_idIndexMarker952" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.26.1">and features takes place on a per-domain basis following the principle of </span><span><em class="italic"><span class="kobospan" id="kobo.27.1">least privilege</span></em></span><span><span class="kobospan" id="kobo.28.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.29.1">In this chapter, we are going to learn how to take advantage of the benefits of SELinux to secure managed systems, covering the following </span><span><span class="kobospan" id="kobo.30.1">main topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.31.1">Learning about mandatory </span><span><span class="kobospan" id="kobo.32.1">access control</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.33.1">Labeling and </span><span><span class="kobospan" id="kobo.34.1">type enforcement</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.35.1">How to troubleshoot </span><span><span class="kobospan" id="kobo.36.1">SELinux issues</span></span></li>
</ul>
<h1 id="_idParaDest-177" class="calibre5"><a id="_idTextAnchor242" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.37.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.38.1">For the development of the topics in this chapter, it is necessary to install the packages indicated in each section. </span><span class="kobospan" id="kobo.38.2">In each section, you will find the instructions for the different types of installation of each package </span><span><span class="kobospan" id="kobo.39.1">as required.</span></span></p>
<h1 id="_idParaDest-178" class="calibre5"><a id="_idTextAnchor243" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.40.1">Learning about mandatory access control</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.41.1">Linux file </span><a id="_idIndexMarker953" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.42.1">permissions control which users or groups of users access specific files. </span><span class="kobospan" id="kobo.42.2">But a user with read or write access to a specific file could use that file in any way desired, even if that use is not what the file should be </span><span><span class="kobospan" id="kobo.43.1">used for.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.44.1">Linux </span><em class="italic"><span class="kobospan" id="kobo.45.1">standard file permissions</span></em><span class="kobospan" id="kobo.46.1"> succeed when files get used by a single owner and a single designated group </span><span><span class="kobospan" id="kobo.47.1">of people.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.48.1">File permissions fail to prevent some forms of unwanted access. </span><span class="kobospan" id="kobo.48.2">They were not designed to control </span><a id="_idIndexMarker954" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.49.1">how a file gets used, but only who to allow to read, write, or run </span><span><span class="kobospan" id="kobo.50.1">a file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.51.1">Linux standard </span><a id="_idIndexMarker955" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.52.1">file permissions are ownership-based, also known as </span><strong class="bold"><span class="kobospan" id="kobo.53.1">discretionary access </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.54.1">control</span></strong></span><span><span class="kobospan" id="kobo.55.1"> (</span></span><span><strong class="bold"><span class="kobospan" id="kobo.56.1">DAC</span></strong></span><span><span class="kobospan" id="kobo.57.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.58.1">The MAC rules are </span><em class="italic"><span class="kobospan" id="kobo.59.1">policy</span></em><span class="kobospan" id="kobo.60.1"> based, not </span><span><span class="kobospan" id="kobo.61.1">by ownership.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.62.1">There are two types </span><span><span class="kobospan" id="kobo.63.1">of MAC:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.64.1">Multi-level security systems</span></strong><span class="kobospan" id="kobo.65.1">: The original and simplest form of MAC consists </span><a id="_idIndexMarker956" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.66.1">of a vertical </span><a id="_idIndexMarker957" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.67.1">structure of protection and security levels. </span><span class="kobospan" id="kobo.67.2">Information only flows within this area. </span><span class="kobospan" id="kobo.67.3">A level of protection is also assigned to users, who can thus only access the same or </span><span><span class="kobospan" id="kobo.68.1">lower levels.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.69.1">Multi-lateral security systems</span></strong><span class="kobospan" id="kobo.70.1">: These systems are more complex and assign access </span><a id="_idIndexMarker958" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.71.1">based on segments. </span><span class="kobospan" id="kobo.71.2">Those segments form associations, which in turn consist of protection </span><a id="_idIndexMarker959" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.72.1">levels and code words. </span><span class="kobospan" id="kobo.72.2">This results in a horizontal security system that also includes vertical levels </span><span><span class="kobospan" id="kobo.73.1">of protection.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.74.1">SELinux is an example of a MAC application </span><span><span class="kobospan" id="kobo.75.1">on Linux.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.76.1">SELinux offers a special security architecture based on the principles of MAC. </span><span class="kobospan" id="kobo.76.2">SELinux </span><em class="italic"><span class="kobospan" id="kobo.77.1">minimizes access</span></em><span class="kobospan" id="kobo.78.1"> to operating system processes and files through strict access control methods and corresponding security measures. </span><span class="kobospan" id="kobo.78.2">The module aims to ensure data confidentiality and integrity. </span><span class="kobospan" id="kobo.78.3">Furthermore, with SELinux, the operating system and user programs </span><span><span class="kobospan" id="kobo.79.1">remain delimited.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.80.1">SELinux </span><a id="_idIndexMarker960" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.81.1">also relies on two other implementations: </span><strong class="bold"><span class="kobospan" id="kobo.82.1">type enforcement</span></strong><span class="kobospan" id="kobo.83.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.84.1">TE</span></strong><span class="kobospan" id="kobo.85.1">) and </span><strong class="bold"><span class="kobospan" id="kobo.86.1">role-based access control</span></strong><span class="kobospan" id="kobo.87.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.88.1">RBAC</span></strong><span class="kobospan" id="kobo.89.1">). </span><span class="kobospan" id="kobo.89.2">With RBAC, access rights map </span><a id="_idIndexMarker961" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.90.1">according to a defined role model. </span><span class="kobospan" id="kobo.90.2">The defined user roles abstract the work processes of an organization. </span><span class="kobospan" id="kobo.90.3">On a MAC model, TE is the notion that access gets governed through clearance based on a </span><em class="italic"><span class="kobospan" id="kobo.91.1">subject-access-object set </span></em><span><em class="italic"><span class="kobospan" id="kobo.92.1">of rules</span></em></span><span><span class="kobospan" id="kobo.93.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.94.1">SELinux defines security measures and sets extra attributes that state under what conditions and in what situations a rights holder could access certain operating system processes or files. </span><span class="kobospan" id="kobo.94.2">If these conditions or relationships (i.e., attributes) are not met, access </span><span><span class="kobospan" id="kobo.95.1">is denied.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.96.1">SELinux consists </span><a id="_idIndexMarker962" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.97.1">of sets of policies that declare exactly what </span><em class="italic"><span class="kobospan" id="kobo.98.1">actions and accesses</span></em><span class="kobospan" id="kobo.99.1"> are allowed for each object used by an application. </span><span class="kobospan" id="kobo.99.2">It is also known as a </span><em class="italic"><span class="kobospan" id="kobo.100.1">targeted policy</span></em><span class="kobospan" id="kobo.101.1"> since the policy covers the activities of a single application. </span><span class="kobospan" id="kobo.101.2">Policies declare predefined labels that apply to individual programs, files, and </span><span><span class="kobospan" id="kobo.102.1">network ports.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.103.1">SELinux enforces a set of access rules that prevent a security flaw in one application from affecting other applications or the system itself. </span><span class="kobospan" id="kobo.103.2">SELinux provides an extra layer of security, but it also adds a level of complexity that might seem confusing to those unfamiliar </span><span><span class="kobospan" id="kobo.104.1">with it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.105.1">To better understand how it works, let’s walk through the basic concepts that SELinux </span><span><span class="kobospan" id="kobo.106.1">works with.</span></span></p>
<h1 id="_idParaDest-179" class="calibre5"><a id="_idTextAnchor244" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.107.1">Labeling and type enforcement</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.108.1">SELinux is a </span><em class="italic"><span class="kobospan" id="kobo.109.1">labeling system</span></em><span class="kobospan" id="kobo.110.1">, which tells us that each file, directory, or object in the system has a </span><a id="_idIndexMarker963" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.111.1">corresponding label. </span><span class="kobospan" id="kobo.111.2">Each file, process, directory, and port has a </span><em class="italic"><span class="kobospan" id="kobo.112.1">special security label</span></em><span class="kobospan" id="kobo.113.1"> called </span><a id="_idIndexMarker964" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.114.1">an SELinux context. </span><span class="kobospan" id="kobo.114.2">A </span><strong class="bold"><span class="kobospan" id="kobo.115.1">context</span></strong><span class="kobospan" id="kobo.116.1"> is a tag name used </span><a id="_idIndexMarker965" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.117.1">by the SELinux policy to determine whether a process can access a file, directory, or port. </span><span class="kobospan" id="kobo.117.2">Policies control the interaction between these elements. </span><span class="kobospan" id="kobo.117.3">By default, the policy </span><a id="_idIndexMarker966" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.118.1">does not allow any interaction unless an explicit rule grants access. </span><span class="kobospan" id="kobo.118.2">If no permission rule exists, access is not allowed. </span><span class="kobospan" id="kobo.118.3">The Linux kernel enforces </span><span><span class="kobospan" id="kobo.119.1">these rules.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.120.1">SELinux contexts have different labels in their format, separated by colons: </span><em class="italic"><span class="kobospan" id="kobo.121.1">user</span></em><span class="kobospan" id="kobo.122.1">, </span><em class="italic"><span class="kobospan" id="kobo.123.1">role</span></em><span class="kobospan" id="kobo.124.1">, </span><em class="italic"><span class="kobospan" id="kobo.125.1">type</span></em><span class="kobospan" id="kobo.126.1">, and </span><em class="italic"><span class="kobospan" id="kobo.127.1">sensitivity level</span></em><span class="kobospan" id="kobo.128.1">. </span><span class="kobospan" id="kobo.128.2">They are formed </span><span><span class="kobospan" id="kobo.129.1">as follows:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.130.1">user</span></strong><span class="kobospan1" id="kobo.131.1">:</span><strong class="bold1"><span class="kobospan1" id="kobo.132.1">role</span></strong><span class="kobospan1" id="kobo.133.1">:</span><strong class="bold1"><span class="kobospan1" id="kobo.134.1">type</span></strong><span class="kobospan1" id="kobo.135.1">:</span><strong class="bold1"><span class="kobospan1" id="kobo.136.1">level</span></strong><span class="kobospan1" id="kobo.137.1"> (optional)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.138.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.139.1">The </span><em class="italic"><span class="kobospan" id="kobo.140.1">sensitivity level</span></em><span class="kobospan" id="kobo.141.1"> is the part that </span><span><span class="kobospan" id="kobo.142.1">is optional.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.143.1">The targeted policy bases its rules on the third context component: the </span><em class="italic"><span class="kobospan" id="kobo.144.1">type</span></em><span class="kobospan" id="kobo.145.1"> context. </span><span class="kobospan" id="kobo.145.2">Type context names usually end </span><span><span class="kobospan" id="kobo.146.1">with </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.147.1">_t</span></strong></span><span><span class="kobospan" id="kobo.148.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.149.1">Let’s look </span><a id="_idIndexMarker967" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.150.1">at the </span><span><span class="kobospan" id="kobo.151.1">following example:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer484">
<span class="kobospan" id="kobo.152.1"><img alt="Figure 12.1 – SELinux label example" src="image/12.1.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.153.1">Figure 12.1 – SELinux label example</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.154.1">In the </span><a id="_idIndexMarker968" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.155.1">preceding example, the </span><strong class="source-inline"><span class="kobospan" id="kobo.156.1">/var/www/html/file</span></strong><span class="kobospan" id="kobo.157.1"> file has the following context components: </span><strong class="source-inline"><span class="kobospan" id="kobo.158.1">unconfined_u</span></strong><span class="kobospan" id="kobo.159.1"> is the SELinux user, the role is </span><strong class="source-inline"><span class="kobospan" id="kobo.160.1">object_r</span></strong><span class="kobospan" id="kobo.161.1">, the type is </span><strong class="source-inline"><span class="kobospan" id="kobo.162.1">httpd_sys_content_t</span></strong><span class="kobospan" id="kobo.163.1">, and the sensitivity level is </span><strong class="source-inline"><span class="kobospan" id="kobo.164.1">s0</span></strong><span class="kobospan" id="kobo.165.1">. </span><span class="kobospan" id="kobo.165.2">So, the context on which the access of this file depends </span><span><span class="kobospan" id="kobo.166.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.167.1">httpd_sys_content_t</span></strong></span><span><span class="kobospan" id="kobo.168.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.169.1">Let’s use a demo example with this file to learn how the SELinux </span><span><span class="kobospan" id="kobo.170.1">policy works.</span></span></p>
<h2 id="_idParaDest-180" class="calibre7"><a id="_idTextAnchor245" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.171.1">How SELinux works</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.172.1">Before </span><a id="_idIndexMarker969" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.173.1">analyzing the operation of SELinux, let’s determine how SELinux is running on </span><span><span class="kobospan" id="kobo.174.1">the system.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.175.1">SELinux runs in </span><span><span class="kobospan" id="kobo.176.1">three modes:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.177.1">Enforcing</span></strong><span class="kobospan" id="kobo.178.1">: SELinux </span><a id="_idIndexMarker970" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.179.1">enforces access control rules. </span><span class="kobospan" id="kobo.179.2">This is the Fedora Linux default </span><span><span class="kobospan" id="kobo.180.1">enabled mode.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.181.1">Permissive</span></strong><span class="kobospan" id="kobo.182.1">: SELinux </span><a id="_idIndexMarker971" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.183.1">is active but instead of enforcing access control rules, it </span><em class="italic"><span class="kobospan" id="kobo.184.1">logs warnings</span></em><span class="kobospan" id="kobo.185.1"> of rules violated. </span><span class="kobospan" id="kobo.185.2">This mode gets used for testing </span><span><span class="kobospan" id="kobo.186.1">and troubleshooting.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.187.1">Disabled</span></strong><span class="kobospan" id="kobo.188.1">: SELinux </span><a id="_idIndexMarker972" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.189.1">is completely </span><em class="italic"><span class="kobospan" id="kobo.190.1">disabled</span></em><span class="kobospan" id="kobo.191.1">; no SELinux violations are denied or even logged. </span><em class="italic"><span class="kobospan" id="kobo.192.1">This is not recommended under </span></em><span><em class="italic"><span class="kobospan" id="kobo.193.1">any circumstances</span></em></span><span><span class="kobospan" id="kobo.194.1">.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.195.1">To find out how SELinux is running, use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.196.1">sestatus</span></strong></span><span><span class="kobospan" id="kobo.197.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.198.1">
$ </span><strong class="bold1"><span class="kobospan1" id="kobo.199.1">sestatus</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.200.1">SELinux status:                 enabled</span></strong><span class="kobospan1" id="kobo.201.1">
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
</span><strong class="bold1"><span class="kobospan1" id="kobo.202.1">Loaded policy name:             targeted</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.203.1">Current mode:                   enforcing</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.204.1">Mode from config file:          enforcing</span></strong><span class="kobospan1" id="kobo.205.1">
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Memory protection checking:     actual (secure)
Max kernel policy version:      33</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.206.1">The SELinux </span><a id="_idIndexMarker973" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.207.1">running mode gets configured in the </span><strong class="source-inline"><span class="kobospan" id="kobo.208.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.209.1">etc/selinux/config</span></strong></span><span><span class="kobospan" id="kobo.210.1"> file:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer485">
<span class="kobospan" id="kobo.211.1"><img alt="Figure 12.2 – SELinux config file" src="image/12.2.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.212.1">Figure 12.2 – SELinux config file</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.213.1">During execution, for testing, the SELinux mode could change. </span><span class="kobospan" id="kobo.213.2">But upon </span><em class="italic"><span class="kobospan" id="kobo.214.1">rebooting</span></em><span class="kobospan" id="kobo.215.1"> the system, it will again take the mode configured in the configuration file to set it. </span><span class="kobospan" id="kobo.215.2">Use the </span><strong class="source-inline"><span class="kobospan" id="kobo.216.1">getenforce</span></strong><span class="kobospan" id="kobo.217.1"> command to find out the mode SELinux is running in and the </span><strong class="source-inline"><span class="kobospan" id="kobo.218.1">setenforce</span></strong><span class="kobospan" id="kobo.219.1"> command to change the mode, as the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.220.1">root</span></strong></span><span><span class="kobospan" id="kobo.221.1"> user:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer486">
<span class="kobospan" id="kobo.222.1"><img alt="Figure 12.3 – Changing the SELinux run mode" src="image/12.3.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.223.1">Figure 12.3 – Changing the SELinux run mode</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.224.1">Now, let us see how </span><span><span class="kobospan" id="kobo.225.1">SELinux works.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.226.1">So, how does SELinux work?</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.227.1">Linux was </span><a id="_idIndexMarker974" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.228.1">born in the early days of the operating system’s usefulness. </span><span class="kobospan" id="kobo.228.2">It’s used as the main operating system running a </span><span><span class="kobospan" id="kobo.229.1">web server.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.230.1">The Apache web server (</span><strong class="source-inline"><span class="kobospan" id="kobo.231.1">httpd</span></strong><span class="kobospan" id="kobo.232.1">) is not insecure, but its </span><em class="italic"><span class="kobospan" id="kobo.233.1">access range</span></em><span class="kobospan" id="kobo.234.1"> is very wide so it is very important to </span><span><span class="kobospan" id="kobo.235.1">secure it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.236.1">So, let’s start with this example to understand how SELinux works. </span><span class="kobospan" id="kobo.236.2">Follow the </span><span><span class="kobospan" id="kobo.237.1">subsequent steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.238.1">Verify that the </span><strong class="source-inline1"><span class="kobospan" id="kobo.239.1">httpd</span></strong><span class="kobospan" id="kobo.240.1"> service is installed and active on </span><span><span class="kobospan" id="kobo.241.1">the system:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer487">
<span class="kobospan" id="kobo.242.1"><img alt="Figure 12.4 – Status of the httpd service" src="image/12.4.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.243.1">Figure 12.4 – Status of the httpd service</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.244.1">If not, use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.245.1">dnf</span></strong><span class="kobospan" id="kobo.246.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.247.1">systemctl</span></strong><span class="kobospan" id="kobo.248.1"> commands to </span><span><span class="kobospan" id="kobo.249.1">perform this:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.250.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.251.1">dnf install httpd</span></strong><span class="kobospan1" id="kobo.252.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.253.1">systemctl enable --now httpd</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.254.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.255.1">httpd</span></strong><span class="kobospan" id="kobo.256.1"> service runs a binary file to start. </span><span class="kobospan" id="kobo.256.2">This file launches </span><span><span class="kobospan" id="kobo.257.1">from </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.258.1">/usr/sbin/</span></strong></span><span><span class="kobospan" id="kobo.259.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.260.1">The Linux </span><a id="_idIndexMarker975" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.261.1">kernel integrates an option, in most commands, to know the SELinux context type. </span><span class="kobospan" id="kobo.261.2">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.262.1">ls</span></strong><span class="kobospan" id="kobo.263.1"> command with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.264.1">-Z</span></strong><span class="kobospan" id="kobo.265.1"> (or </span><strong class="source-inline1"><span class="kobospan" id="kobo.266.1">–context</span></strong><span class="kobospan" id="kobo.267.1">) option to identify the SELinux context type of the </span><span><span class="kobospan" id="kobo.268.1">binary file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.269.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.270.1">ls -Z /usr/sbin/httpd</span></strong><span class="kobospan1" id="kobo.271.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.272.1">httpd_exec_t</span></strong><span class="kobospan1" id="kobo.273.1">:s0 /usr/sbin/httpd</span></pre><p class="calibre3"><span class="kobospan" id="kobo.274.1">The context type of the binary file </span><span><span class="kobospan" id="kobo.275.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.276.1">httpd_exec_t</span></strong></span><span><span class="kobospan" id="kobo.277.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.278.1">The configuration files for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.279.1">httpd</span></strong><span class="kobospan" id="kobo.280.1"> service are found in </span><strong class="source-inline1"><span class="kobospan" id="kobo.281.1">/etc/httpd</span></strong><span class="kobospan" id="kobo.282.1">. </span><span class="kobospan" id="kobo.282.2">Let’s see what context type </span><span><span class="kobospan" id="kobo.283.1">they have:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.284.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.285.1">ls -dZ /etc/httpd/</span></strong><span class="kobospan1" id="kobo.286.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.287.1">httpd_config_t</span></strong><span class="kobospan1" id="kobo.288.1">:s0 /etc/httpd/</span></pre><p class="calibre3"><span class="kobospan" id="kobo.289.1">The context type of the configuration files </span><span><span class="kobospan" id="kobo.290.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.291.1">httpd_config_t</span></strong></span><span><span class="kobospan" id="kobo.292.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.293.1">The logs of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.294.1">httpd</span></strong><span class="kobospan" id="kobo.295.1"> service are found in </span><strong class="source-inline1"><span class="kobospan" id="kobo.296.1">/var/log/httpd</span></strong><span class="kobospan" id="kobo.297.1">. </span><span class="kobospan" id="kobo.297.2">Find their context type using </span><span><span class="kobospan" id="kobo.298.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.299.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.300.1">ls -dZ /var/log/httpd</span></strong><span class="kobospan1" id="kobo.301.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.302.1">httpd_log_t</span></strong><span class="kobospan1" id="kobo.303.1">:s0 /var/log/httpd</span></pre><p class="calibre3"><span class="kobospan" id="kobo.304.1">The context type of the logs </span><span><span class="kobospan" id="kobo.305.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.306.1">httpd_log_t</span></strong></span><span><span class="kobospan" id="kobo.307.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.308.1">The content type directory of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.309.1">httpd</span></strong><span class="kobospan" id="kobo.310.1"> service is found in </span><strong class="source-inline1"><span class="kobospan" id="kobo.311.1">/var/www/html</span></strong><span class="kobospan" id="kobo.312.1">. </span><span class="kobospan" id="kobo.312.2">Find their context using </span><span><span class="kobospan" id="kobo.313.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.314.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.315.1">ls -dZ /var/www/html</span></strong><span class="kobospan1" id="kobo.316.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.317.1">httpd_sys_content_t</span></strong><span class="kobospan1" id="kobo.318.1">:s0 /var/www/html</span></pre><p class="calibre3"><span class="kobospan" id="kobo.319.1">The context type of the content directory </span><span><span class="kobospan" id="kobo.320.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.321.1">httpd_sys_content_t</span></strong></span><span><span class="kobospan" id="kobo.322.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.323.1">The unit </span><a id="_idIndexMarker976" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.324.1">file for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.325.1">httpd</span></strong><span class="kobospan" id="kobo.326.1"> service startup is found in </span><strong class="source-inline1"><span class="kobospan" id="kobo.327.1">/usr/lib/systemd/system/</span></strong><span class="kobospan" id="kobo.328.1">. </span><span class="kobospan" id="kobo.328.2">Find its context type using </span><span><span class="kobospan" id="kobo.329.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.330.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.331.1">ls -Z /usr/lib/systemd/system/httpd.service</span></strong><span class="kobospan1" id="kobo.332.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.333.1">httpd_unit_file_t</span></strong><span class="kobospan1" id="kobo.334.1">:s0 /usr/lib/systemd/system/httpd.service</span></pre><p class="calibre3"><span class="kobospan" id="kobo.335.1">The context type of the unit file </span><span><span class="kobospan" id="kobo.336.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.337.1">httpd_unit_file_t</span></strong></span><span><span class="kobospan" id="kobo.338.1">.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.339.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.340.1">ps</span></strong><span class="kobospan" id="kobo.341.1"> command to find the context type of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.342.1">httpd</span></strong><span class="kobospan" id="kobo.343.1"> service daemon while it </span><span><span class="kobospan" id="kobo.344.1">is running:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.345.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.346.1">ps auxfZ | grep httpd</span></strong></pre></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer488">
<span class="kobospan" id="kobo.347.1"><img alt="Figure 12.5 – Finding the context of the httpd daemon" src="image/12.5.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.348.1">Figure 12.5 – Finding the context of the httpd daemon</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.349.1">The context type of the service daemon </span><span><span class="kobospan" id="kobo.350.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.351.1">httpd_t</span></strong></span><span><span class="kobospan" id="kobo.352.1">.</span></span></p>
<ol class="calibre13">
<li value="9" class="calibre14"><span class="kobospan" id="kobo.353.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.354.1">netstat</span></strong><span class="kobospan" id="kobo.355.1"> command to find the context type of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.356.1">httpd</span></strong><span class="kobospan" id="kobo.357.1"> service port while it </span><span><span class="kobospan" id="kobo.358.1">is running:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.359.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.360.1">netstat -tulpnZ | grep httpd</span></strong></pre></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer489">
<span class="kobospan" id="kobo.361.1"><img alt="Figure 12.6 – Finding the context of the httpd port" src="image/12.6.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.362.1">Figure 12.6 – Finding the context of the httpd port</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.363.1">The context type of the service port </span><span><span class="kobospan" id="kobo.364.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.365.1">httpd_t</span></strong></span><span><span class="kobospan" id="kobo.366.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.367.1">The preceding </span><a id="_idIndexMarker977" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.368.1">example can be summarized in the </span><span><span class="kobospan" id="kobo.369.1">following table:</span></span></p>
<table class="no-table-style" id="table001-6">
<colgroup class="calibre10">
<col class="calibre11"/>
<col class="calibre11"/>
</colgroup>
<tbody class="calibre12">
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.370.1">Type</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.371.1">Context type</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.372.1">Binary file</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.373.1">httpd_exec_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.374.1">Config files</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.375.1">httpd_config_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.376.1">Logs</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.377.1">httpd_log_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.378.1">Content directory</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.379.1">httpd_sys_content_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.380.1">Unit file</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.381.1">httpd_unit_file_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.382.1">Process</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="source-inline"><span class="kobospan" id="kobo.383.1">httpd_t</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.384.1">Port</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.385.1">httpd_t </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.386.1">or http_port_t</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.387.1">Table 12.1 – The httpd service contexts</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.388.1">Note the relation of contexts; all belong to the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.389.1">httpd_t</span></strong></span><span><span class="kobospan" id="kobo.390.1"> domain.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.391.1">Thus, type enforcement is the concept under which it makes sense for a process running in the </span><strong class="source-inline"><span class="kobospan" id="kobo.392.1">httpd_t</span></strong><span class="kobospan" id="kobo.393.1"> context to interact with a file labeled </span><span><span class="kobospan" id="kobo.394.1">as </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.395.1">httpd_sys_content_t</span></strong></span><span><span class="kobospan" id="kobo.396.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.397.1">Let’s see what context the </span><strong class="source-inline"><span class="kobospan" id="kobo.398.1">/etc/shadow</span></strong><span class="kobospan" id="kobo.399.1"> file has, where user passwords </span><span><span class="kobospan" id="kobo.400.1">are stored:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.401.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.402.1">ls -Z /etc/shadow</span></strong><span class="kobospan1" id="kobo.403.1">
system_u:object_r:</span><strong class="bold1"><span class="kobospan1" id="kobo.404.1">shadow_t</span></strong><span class="kobospan1" id="kobo.405.1">:s0 /etc/shadow</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.406.1">The context of the </span><strong class="source-inline"><span class="kobospan" id="kobo.407.1">/etc/shadow</span></strong><span class="kobospan" id="kobo.408.1"> file </span><span><span class="kobospan" id="kobo.409.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.410.1">shadow_t</span></strong></span><span><span class="kobospan" id="kobo.411.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.412.1">From a basic functional perspective, the web server (</span><strong class="source-inline"><span class="kobospan" id="kobo.413.1">httpd</span></strong><span class="kobospan" id="kobo.414.1">) </span><em class="italic"><span class="kobospan" id="kobo.415.1">reads and publishes</span></em><span class="kobospan" id="kobo.416.1"> documents that live within it. </span><span class="kobospan" id="kobo.416.2">Besides the file’s proprietary permissions, security could enhance this through the SELinux policy. </span><span class="kobospan" id="kobo.416.3">With proper proprietary permissions, there would be nothing to prevent the </span><strong class="source-inline"><span class="kobospan" id="kobo.417.1">httpd</span></strong><span class="kobospan" id="kobo.418.1"> service from publishing the file with </span><span><span class="kobospan" id="kobo.419.1">user passwords.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.420.1">With SELinux </span><a id="_idIndexMarker978" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.421.1">policies enabled, no matter what permission level the file has, the policy would </span><em class="italic"><span class="kobospan" id="kobo.422.1">prevent</span></em><span class="kobospan" id="kobo.423.1"> it from </span><span><span class="kobospan" id="kobo.424.1">doing so.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.425.1">Files with the </span><strong class="source-inline"><span class="kobospan" id="kobo.426.1">httpd_t</span></strong><span class="kobospan" id="kobo.427.1"> context type can only interact with files </span><em class="italic"><span class="kobospan" id="kobo.428.1">under the same context type</span></em><span class="kobospan" id="kobo.429.1">. </span><span class="kobospan" id="kobo.429.2">The password file belongs to a different context type than </span><strong class="source-inline"><span class="kobospan" id="kobo.430.1">httpd_t</span></strong><span class="kobospan" id="kobo.431.1">; its context is </span><strong class="source-inline"><span class="kobospan" id="kobo.432.1">shadow_t</span></strong><span class="kobospan" id="kobo.433.1">, thus their </span><em class="italic"><span class="kobospan" id="kobo.434.1">interaction </span></em><span><em class="italic"><span class="kobospan" id="kobo.435.1">is denied</span></em></span><span><span class="kobospan" id="kobo.436.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.437.1">This is the most basic way SELinux works, and the way the policy works. </span><span class="kobospan" id="kobo.437.2">It is not free of issues, but these are also limited by </span><span><span class="kobospan" id="kobo.438.1">its nature.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.439.1">Let’s see how to determine </span><span><span class="kobospan" id="kobo.440.1">SELinux errors.</span></span></p>
<h1 id="_idParaDest-181" class="calibre5"><a id="_idTextAnchor246" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.441.1">How to troubleshoot SELinux issues</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.442.1">The popular belief is that it is very difficult to determine and fix SELinux issues. </span><span class="kobospan" id="kobo.442.2">This stems </span><a id="_idIndexMarker979" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.443.1">from the fact that the </span><em class="italic"><span class="kobospan" id="kobo.444.1">logs</span></em><span class="kobospan" id="kobo.445.1"> get logged with the system audit. </span><span class="kobospan" id="kobo.445.2">This log reading is not intuitive and, in fact, to the human eye is quite complex; but </span><span><span class="kobospan" id="kobo.446.1">it isn’t.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.447.1">Carrying on with the example of the </span><strong class="source-inline"><span class="kobospan" id="kobo.448.1">httpd</span></strong><span class="kobospan" id="kobo.449.1"> web server, consider the following sequence </span><span><span class="kobospan" id="kobo.450.1">of commands:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.451.1">As the </span><strong class="source-inline1"><span class="kobospan" id="kobo.452.1">root</span></strong><span class="kobospan" id="kobo.453.1"> user, create the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.454.1">myfile</span></strong></span><span><span class="kobospan" id="kobo.455.1"> file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.456.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.457.1">touch myfile</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.458.1">Move the </span><strong class="source-inline1"><span class="kobospan" id="kobo.459.1">myfile</span></strong><span class="kobospan" id="kobo.460.1"> file to the </span><em class="italic"><span class="kobospan" id="kobo.461.1">web </span></em><span><em class="italic"><span class="kobospan" id="kobo.462.1">content directory</span></em></span><span><span class="kobospan" id="kobo.463.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.464.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.465.1">mv myfile /var/www/html/</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.466.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.467.1">curl</span></strong><span class="kobospan" id="kobo.468.1"> command to get the contents of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.469.1">myfile</span></strong><span class="kobospan" id="kobo.470.1"> file published by the </span><span><span class="kobospan" id="kobo.471.1">web server:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.472.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.473.1">curl http://localhost/myfile</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.474.1">Observe </span><span><span class="kobospan" id="kobo.475.1">the output:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer490">
<span class="kobospan" id="kobo.476.1"><img alt="Figure 12.7 – Creating the myfile web file" src="image/12.7.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.477.1">Figure 12.7 – Creating the myfile web file</span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.478.1">Use </span><a id="_idIndexMarker980" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.479.1">the </span><strong class="source-inline1"><span class="kobospan" id="kobo.480.1">grep</span></strong><span class="kobospan" id="kobo.481.1"> command to search for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.482.1">myfile</span></strong><span class="kobospan" id="kobo.483.1"> string in the </span><em class="italic"><span class="kobospan" id="kobo.484.1">system </span></em><span><em class="italic"><span class="kobospan" id="kobo.485.1">audit log</span></em></span><span><span class="kobospan" id="kobo.486.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.487.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.488.1">grep myfile /var/log/audit/audit.log</span></strong><span class="kobospan1" id="kobo.489.1">
...
</span><span class="kobospan1" id="kobo.489.2">type=AVC msg=audit(1689045662.823:264): avc:  denied  { getattr } for  pid=1035 comm="httpd" path="/var/www/html/myfile" dev="vda3" ino=769948 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:admin_home_t:s0 tclass=file permissive=0</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.490.1">At first glance, it is not very easy to read, but let’s analyze it </span><span><span class="kobospan" id="kobo.491.1">in parts:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.492.1">type=AVC</span></strong><span class="kobospan" id="kobo.493.1">: </span><strong class="bold"><span class="kobospan" id="kobo.494.1">AVC Audit Events</span></strong><span class="kobospan" id="kobo.495.1"> generated </span><a id="_idIndexMarker981" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.496.1">by the </span><em class="italic"><span class="kobospan" id="kobo.497.1">AVC subsystem</span></em><span class="kobospan" id="kobo.498.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.499.1">AVC</span></strong><span class="kobospan" id="kobo.500.1"> means </span><strong class="bold"><span class="kobospan" id="kobo.501.1">Access Vector Cache</span></strong><span class="kobospan" id="kobo.502.1">) as a result of access denials, or where specific events have requested an </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.503.1">audit</span></strong></span><span><span class="kobospan" id="kobo.504.1"> message.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.505.1">msg=audit(1689045662.823:264)</span></strong><span class="kobospan" id="kobo.506.1">: The </span><em class="italic"><span class="kobospan" id="kobo.507.1">timestamp</span></em><span class="kobospan" id="kobo.508.1"> of the message in </span><strong class="bold"><span class="kobospan" id="kobo.509.1">Unix format</span></strong><span class="kobospan" id="kobo.510.1"> (epoch); use </span><a id="_idIndexMarker982" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.511.1">the </span><strong class="source-inline1"><span class="kobospan" id="kobo.512.1">date</span></strong><span class="kobospan" id="kobo.513.1"> command to determine </span><span><span class="kobospan" id="kobo.514.1">the time:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.515.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.516.1">date -d @1689045662.823</span></strong><span class="kobospan1" id="kobo.517.1">
Mon Jul 10 09:21:02 PM CST 2023</span></pre></li> <li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.518.1">avc:  denied  { getattr } for  pid=1035</span></strong><span class="kobospan" id="kobo.519.1">: The result of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.520.1">avc</span></strong><span class="kobospan" id="kobo.521.1"> audit event called </span><strong class="source-inline1"><span class="kobospan" id="kobo.522.1">denied for </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.523.1">pid 1035</span></strong></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.524.1">comm="httpd"</span></strong><span class="kobospan" id="kobo.525.1">: The </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.526.1">httpd</span></strong></span><span><span class="kobospan" id="kobo.527.1"> command</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.528.1">path="/var/www/html/myfile"</span></strong><span class="kobospan" id="kobo.529.1">: The </span><strong class="source-inline1"><span class="kobospan" id="kobo.530.1">var/www/html/myfile</span></strong> <span><span class="kobospan" id="kobo.531.1">file path</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.532.1">dev="vda3"</span></strong><span class="kobospan" id="kobo.533.1">: The </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.534.1">vda3</span></strong></span><span><span class="kobospan" id="kobo.535.1"> device</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.536.1">ino=769948</span></strong><span class="kobospan" id="kobo.537.1">: </span><span><span class="kobospan" id="kobo.538.1">Inode identifier</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.539.1">scontext=system_u:system_r:</span></strong><strong class="bold"><span class="kobospan" id="kobo.540.1">httpd_t</span></strong><strong class="source-inline1"><span class="kobospan" id="kobo.541.1">:s0</span></strong><span class="kobospan" id="kobo.542.1">: </span><span><em class="italic"><span class="kobospan" id="kobo.543.1">Source</span></em></span><span><span class="kobospan" id="kobo.544.1"> context</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.545.1">tcontext=unconfined_u:object_r:</span></strong><strong class="bold"><span class="kobospan" id="kobo.546.1">admin_home_t</span></strong><strong class="source-inline1"><span class="kobospan" id="kobo.547.1">:s0</span></strong><span class="kobospan" id="kobo.548.1">: </span><span><span class="kobospan" id="kobo.549.1">Target context</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.550.1">tclass=file</span></strong><span class="kobospan" id="kobo.551.1">: Target class is </span><span><span class="kobospan" id="kobo.552.1">a file</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.553.1">permissive=0</span></strong><span class="kobospan" id="kobo.554.1">: SELinux permissive </span><span><span class="kobospan" id="kobo.555.1">mode disabled</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.556.1">Then, the </span><a id="_idIndexMarker983" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.557.1">audit message reads </span><span><span class="kobospan" id="kobo.558.1">as follows:</span></span></p>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.559.1">At the described timestamp, an </span></em><span class="kobospan" id="kobo.560.1">AVC</span><em class="italic"><span class="kobospan" id="kobo.561.1"> event resulted as denied for pid </span></em><strong class="source-inline"><span class="kobospan" id="kobo.562.1">1035</span></strong><em class="italic"><span class="kobospan" id="kobo.563.1"> of the </span></em><strong class="source-inline"><span class="kobospan" id="kobo.564.1">httpd</span></strong><em class="italic"><span class="kobospan" id="kobo.565.1"> command on the </span></em><strong class="source-inline"><span class="kobospan" id="kobo.566.1">/var/www/html/myfile</span></strong><em class="italic"><span class="kobospan" id="kobo.567.1"> file, located on the device and the described inode. </span><span class="kobospan" id="kobo.567.2">The source context type is </span></em><strong class="source-inline"><span class="kobospan" id="kobo.568.1">httpd_t</span></strong><em class="italic"><span class="kobospan" id="kobo.569.1"> and the target context type is </span></em><strong class="source-inline"><span class="kobospan" id="kobo.570.1">admin_home_t</span></strong><em class="italic"><span class="kobospan" id="kobo.571.1">. </span><span class="kobospan" id="kobo.571.2">The permissive mode is set </span></em><span><em class="italic"><span class="kobospan" id="kobo.572.1">as disabled.</span></em></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.573.1">This indicates that it is an error of the SELinux contexts since they do not correspond and cannot interact with each other. </span><span class="kobospan" id="kobo.573.2">That is, the web server is not allowed to read that file, as indicated by the output of the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.574.1">curl</span></strong></span><span><span class="kobospan" id="kobo.575.1"> command.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.576.1">At first, it looked very complicated, but when analyzing the log, the error stands out at </span><span><span class="kobospan" id="kobo.577.1">a glance.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.578.1">This is the </span><a id="_idIndexMarker984" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.579.1">most common error with SELinux, about contexts that </span><em class="italic"><span class="kobospan" id="kobo.580.1">cannot interact</span></em><span class="kobospan" id="kobo.581.1"> and whose access </span><span><span class="kobospan" id="kobo.582.1">is </span></span><span><em class="italic"><span class="kobospan" id="kobo.583.1">denied</span></em></span><span><span class="kobospan" id="kobo.584.1">.</span></span></p>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.585.1">What is SELinux trying to </span></em><span><em class="italic"><span class="kobospan" id="kobo.586.1">tell me?</span></em></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.587.1">Let’s analyze each of them and their solutions </span><span><span class="kobospan" id="kobo.588.1">or workarounds.</span></span></p>
<h2 id="_idParaDest-182" class="calibre7"><a id="_idTextAnchor247" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.589.1">Labeling</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.590.1">As we observed, every process and object in the system has a </span><em class="italic"><span class="kobospan" id="kobo.591.1">label</span></em><span class="kobospan" id="kobo.592.1"> associated with it. </span><span class="kobospan" id="kobo.592.2">If files are </span><a id="_idIndexMarker985" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.593.1">not labeled in the right context, access may be denied. </span><span class="kobospan" id="kobo.593.2">Or, if </span><em class="italic"><span class="kobospan" id="kobo.594.1">alternate or custom paths</span></em><span class="kobospan" id="kobo.595.1"> get used for confined domains, SELinux needs to know </span><span><span class="kobospan" id="kobo.596.1">about it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.597.1">Let’s use the following </span><span><span class="kobospan" id="kobo.598.1">illustrative example.</span></span></p>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.599.1">Labeling issue</span></strong><span class="kobospan" id="kobo.600.1">: The files in </span><strong class="source-inline"><span class="kobospan" id="kobo.601.1">/srv/myweb</span></strong><span class="kobospan" id="kobo.602.1"> are not labeled correctly and the web server </span><a id="_idIndexMarker986" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.603.1">cannot </span><span><span class="kobospan" id="kobo.604.1">access them.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.605.1">In this particular case, a </span><em class="italic"><span class="kobospan" id="kobo.606.1">custom path</span></em><span class="kobospan" id="kobo.607.1"> to the web server’s content directory appears to be used. </span><span class="kobospan" id="kobo.607.2">To assign the correct label, there are </span><span><span class="kobospan" id="kobo.608.1">two ways:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.609.1">If you know the correct label, use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.610.1">semanage</span></strong><span class="kobospan" id="kobo.611.1"> command to assign it to </span><span><span class="kobospan" id="kobo.612.1">the policy:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.613.1"># semanage fcontext -a -t httpd_sys_content_t '/srv/myweb(/.*)?'</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.614.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.615.1">semanage</span></strong><span class="kobospan" id="kobo.616.1"> command applies the </span><strong class="source-inline"><span class="kobospan" id="kobo.617.1">httpd_sys_content_t</span></strong><span class="kobospan" id="kobo.618.1"> label to the entire contents of the </span><strong class="source-inline"><span class="kobospan" id="kobo.619.1">/srv/myweb</span></strong><span class="kobospan" id="kobo.620.1"> directory and inherits it to the new files created in it. </span><span class="kobospan" id="kobo.620.2">This means the </span><strong class="source-inline"><span class="kobospan" id="kobo.621.1">(/.*)?</span></strong><span class="kobospan" id="kobo.622.1"> characters appear at the end of </span><span><span class="kobospan" id="kobo.623.1">the command.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.624.1">If you don’t know the correct label, but know a file with the correct label, use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.625.1">semanage</span></strong><span class="kobospan" id="kobo.626.1"> command to </span><span><span class="kobospan" id="kobo.627.1">assign it:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.628.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.629.1">semanage fcontext -a -e /srv/myweb /var/www</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.630.1">With the </span><strong class="source-inline"><span class="kobospan" id="kobo.631.1">-e</span></strong><span class="kobospan" id="kobo.632.1"> option of the </span><strong class="source-inline"><span class="kobospan" id="kobo.633.1">semanage</span></strong><span class="kobospan" id="kobo.634.1"> command, assign the label with reference to another known file with the </span><span><span class="kobospan" id="kobo.635.1">correct label.</span></span></p></li> </ul>
<p class="calibre3"><span class="kobospan" id="kobo.636.1">In both cases, to restore the context from the policy, use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.637.1">restorecon</span></strong></span><span><span class="kobospan" id="kobo.638.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.639.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.640.1">restorecon -vR /srv/myweb</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.641.1">Using the </span><a id="_idIndexMarker987" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.642.1">example from the previous section, let’s solve </span><span><span class="kobospan" id="kobo.643.1">the issue.</span></span></p>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.644.1">Labeling issue</span></strong><span class="kobospan" id="kobo.645.1">: If a file moves, instead of copying it, it keeps its </span><span><span class="kobospan" id="kobo.646.1">original context.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.647.1">To fix this, use the </span><strong class="source-inline"><span class="kobospan" id="kobo.648.1">chcon</span></strong><span class="kobospan" id="kobo.649.1"> command to change </span><span><span class="kobospan" id="kobo.650.1">the context:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.651.1">Change the context to the </span><span><span class="kobospan" id="kobo.652.1">correct label:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.653.1"># chcon -t httpd_system_content_t /var/www/html/myfile</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.654.1">Change the context with a </span><span><span class="kobospan" id="kobo.655.1">reference label:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.656.1"># chcon --reference /var/www/html/ /var/www/html/myfile</span></strong></pre></li> </ul>
<p class="calibre3"><span class="kobospan" id="kobo.657.1">In the same way as before, for both cases, to restore the context from the policy, use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.658.1">restorecon</span></strong></span><span><span class="kobospan" id="kobo.659.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.660.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.661.1">restorecon -vR /var/www/html</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.662.1">As shown, the main cause of error with SELinux is in the labeling. </span><span class="kobospan" id="kobo.662.2">To correct the context, change the file context with the </span><strong class="source-inline"><span class="kobospan" id="kobo.663.1">chcon</span></strong><span class="kobospan" id="kobo.664.1"> command. </span><span class="kobospan" id="kobo.664.2">This is the easiest way to </span><span><span class="kobospan" id="kobo.665.1">fix it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.666.1">If there is a custom path, it is necessary to inform SELinux that an alternate directory to the policy is going to be used. </span><span class="kobospan" id="kobo.666.2">To change the policy, use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.667.1">semanage</span></strong></span><span><span class="kobospan" id="kobo.668.1"> command.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.669.1">To save context changes in the policy, use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.670.1">restorecon</span></strong></span><span><span class="kobospan" id="kobo.671.1"> command.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.672.1">When there is a customization that modifies the policy, this falls into the second case of SELinux failures. </span><span class="kobospan" id="kobo.672.2">If the standard usage of a task changes, then SELinux must </span><span><span class="kobospan" id="kobo.673.1">be informed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.674.1">Let’s look at </span><span><span class="kobospan" id="kobo.675.1">these cases.</span></span></p>
<h2 id="_idParaDest-183" class="calibre7"><a id="_idTextAnchor248" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.676.1">SELinux needs to know</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.677.1">Following </span><a id="_idIndexMarker988" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.678.1">the web server configuration, in the case of using a port other than the standard port (</span><strong class="source-inline"><span class="kobospan" id="kobo.679.1">80</span></strong><span class="kobospan" id="kobo.680.1">) – for example, </span><strong class="source-inline"><span class="kobospan" id="kobo.681.1">8585</span></strong><span class="kobospan" id="kobo.682.1"> – let’s start by finding out the </span><em class="italic"><span class="kobospan" id="kobo.683.1">port label</span></em><span class="kobospan" id="kobo.684.1">. </span><span class="kobospan" id="kobo.684.2">Use the </span><strong class="source-inline"><span class="kobospan" id="kobo.685.1">semanage</span></strong><span class="kobospan" id="kobo.686.1"> command to ask the policy about the </span><span><span class="kobospan" id="kobo.687.1">configured label:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.688.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.689.1">semanage port --list | grep -w 80</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.690.1">http_port_t</span></strong><span class="kobospan1" id="kobo.691.1">     tcp      </span><strong class="bold1"><span class="kobospan1" id="kobo.692.1">80</span></strong><span class="kobospan1" id="kobo.693.1">, 81, 443, 488, 8008, 8009, 8443, 9000</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.694.1">The context type of the </span><strong class="source-inline"><span class="kobospan" id="kobo.695.1">httpd</span></strong><span class="kobospan" id="kobo.696.1"> port </span><span><span class="kobospan" id="kobo.697.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.698.1">httpd_port_t</span></strong></span><span><span class="kobospan" id="kobo.699.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.700.1">Then, use the </span><strong class="source-inline"><span class="kobospan" id="kobo.701.1">semanage</span></strong><span class="kobospan" id="kobo.702.1"> command to add the </span><strong class="source-inline"><span class="kobospan" id="kobo.703.1">8585</span></strong><span class="kobospan" id="kobo.704.1"> port to the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.705.1">httpd</span></strong></span><span><span class="kobospan" id="kobo.706.1"> policy:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.707.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.708.1">semanage port -a -t http_port_t -p tcp 8585</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.709.1">Besides these custom configurations, SELinux also offers to change pre-loaded configurations in the policy, turning them on </span><span><span class="kobospan" id="kobo.710.1">and off.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.711.1">These </span><a id="_idIndexMarker989" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.712.1">configurations, known as </span><em class="italic"><span class="kobospan" id="kobo.713.1">Booleans</span></em><span class="kobospan" id="kobo.714.1">, allow parts of SELinux policies to get modified at runtime without the need to rewrite </span><span><span class="kobospan" id="kobo.715.1">the policy.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.716.1">For example, if we want to allow the web server to send mail with the </span><strong class="source-inline"><span class="kobospan" id="kobo.717.1">sendmail</span></strong><span class="kobospan" id="kobo.718.1"> service, </span><em class="italic"><span class="kobospan" id="kobo.719.1">turn on</span></em><span class="kobospan" id="kobo.720.1"> the Boolean with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.721.1">setsebool</span></strong></span><span><span class="kobospan" id="kobo.722.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.723.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.724.1">setsebool -P httpd_can_sendmail 1</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.725.1">With the </span><strong class="source-inline"><span class="kobospan" id="kobo.726.1">-P</span></strong><span class="kobospan" id="kobo.727.1"> option, the Boolean change persists on </span><span><span class="kobospan" id="kobo.728.1">system restart.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.729.1">To see all Booleans, use the </span><strong class="source-inline"><span class="kobospan" id="kobo.730.1">getsebool</span></strong><span class="kobospan" id="kobo.731.1"> command with the </span><strong class="source-inline"><span class="kobospan" id="kobo.732.1">-</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.733.1">a</span></strong></span><span><span class="kobospan" id="kobo.734.1"> option:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.735.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.736.1">getsebool -a</span></strong></pre> <div class="calibre2">
<div class="img---figure" id="_idContainer491">
<span class="kobospan" id="kobo.737.1"><img alt="Figure 12.8 – SELinux Booleans" src="image/12.8.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.738.1">Figure 12.8 – SELinux Booleans</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.739.1">To review </span><a id="_idIndexMarker990" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.740.1">the Boolean description, use the </span><strong class="source-inline"><span class="kobospan" id="kobo.741.1">semanage boolean</span></strong><span class="kobospan" id="kobo.742.1"> command with the </span><strong class="source-inline"><span class="kobospan" id="kobo.743.1">-</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.744.1">l</span></strong></span><span><span class="kobospan" id="kobo.745.1"> option:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.746.1">
# </span><strong class="bold1"><span class="kobospan1" id="kobo.747.1">semanage boolean -l</span></strong></pre> <div class="calibre2">
<div class="img---figure" id="_idContainer492">
<span class="kobospan" id="kobo.748.1"><img alt="Figure 12.9 – Reviewing the Boolean description" src="image/12.9.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.749.1">Figure 12.9 – Reviewing the Boolean description</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.750.1">These two cases, incorrect labeling and custom configuration, are the most common causes of errors </span><span><span class="kobospan" id="kobo.751.1">with SELinux.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.752.1">There are two other cases that, although not as common, </span><span><span class="kobospan" id="kobo.753.1">could happen.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.754.1">Let’s look at the </span><span><span class="kobospan" id="kobo.755.1">first one.</span></span></p>
<h2 id="_idParaDest-184" class="calibre7"><a id="_idTextAnchor249" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.756.1">Policy bugs</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.757.1">In some events, the </span><a id="_idIndexMarker991" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.758.1">policy might not work when the behavior fails to meet expectations, as in the </span><span><span class="kobospan" id="kobo.759.1">following cases:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span><span class="kobospan" id="kobo.760.1">Configurations</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.761.1">Redirection </span><span><span class="kobospan" id="kobo.762.1">of stdout</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.763.1">Filtered </span><span><span class="kobospan" id="kobo.764.1">file descriptors</span></span></li>
<li class="calibre14"><span><span class="kobospan" id="kobo.765.1">Executable memory</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.766.1">Libraries </span><span><span class="kobospan" id="kobo.767.1">built wrongly</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.768.1">Unusual paths in </span><span><span class="kobospan" id="kobo.769.1">the code</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.770.1">There is a high likelihood that the policy or application has bugs. </span><span class="kobospan" id="kobo.770.2">These bugs or behavioral flaws should be reported to the developers to get </span><span><span class="kobospan" id="kobo.771.1">them fixed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.772.1">This is an unusual situation as developers pay close attention to SELinux policies , but do not rule out the possibility of </span><span><span class="kobospan" id="kobo.773.1">it happening.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.774.1">A less common situation is that the system might be </span><em class="italic"><span class="kobospan" id="kobo.775.1">compromised</span></em><span class="kobospan" id="kobo.776.1">, and the behavior of the policies changes to grant the escape of information or </span><span><span class="kobospan" id="kobo.777.1">an intrusion.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.778.1">Let’s look at this last case of failure </span><span><span class="kobospan" id="kobo.779.1">with SELinux.</span></span></p>
<h2 id="_idParaDest-185" class="calibre7"><a id="_idTextAnchor250" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.780.1">Hack attack</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.781.1">There is </span><a id="_idIndexMarker992" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.782.1">a risk of a hack attack if the current tools </span><em class="italic"><span class="kobospan" id="kobo.783.1">don’t do a good job</span></em><span class="kobospan" id="kobo.784.1"> of differentiating contexts, or if you detect the case where </span><em class="italic"><span class="kobospan" id="kobo.785.1">confined domains</span></em><span class="kobospan" id="kobo.786.1"> attempt to do </span><span><span class="kobospan" id="kobo.787.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.788.1">Load </span><span><span class="kobospan" id="kobo.789.1">kernel modules</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.790.1">Turn off SELinux </span><span><span class="kobospan" id="kobo.791.1">enforcing mode</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.792.1">Write </span><span><span class="kobospan" id="kobo.793.1">to </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.794.1">etc_t</span></strong></span><span><span class="kobospan" id="kobo.795.1">/</span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.796.1">shadow_t</span></strong></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.797.1">Change </span><span><span class="kobospan" id="kobo.798.1">firewall rules</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.799.1">If this happens, then be careful, because the system could become compromised and your information could be </span><span><span class="kobospan" id="kobo.800.1">in danger.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.801.1">Hacker attacks </span><a id="_idIndexMarker993" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.802.1">are not that common, but rest assured that hackers know how to use SELinux. </span><span class="kobospan" id="kobo.802.2">Don’t trust, and follow your instinct. </span><span class="kobospan" id="kobo.802.3">If you notice </span><em class="italic"><span class="kobospan" id="kobo.803.1">unexpected behavior</span></em><span class="kobospan" id="kobo.804.1"> and it is not related to the other SELinux failures, there is a possibility that your system might </span><span><span class="kobospan" id="kobo.805.1">be hacked.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.806.1">Take it </span><em class="italic"><span class="kobospan" id="kobo.807.1">seriously</span></em><span class="kobospan" id="kobo.808.1">, and </span><em class="italic"><span class="kobospan" id="kobo.809.1">thoroughly</span></em><span class="kobospan" id="kobo.810.1"> inspect </span><span><span class="kobospan" id="kobo.811.1">your system.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.812.1">You never know when you might be a target for </span><span><span class="kobospan" id="kobo.813.1">security attacks.</span></span></p>
<h1 id="_idParaDest-186" class="calibre5"><a id="_idTextAnchor251" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.814.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.815.1">In this chapter, we gave an overview of the use of SELinux and differentiated the types of access control: </span><em class="italic"><span class="kobospan" id="kobo.816.1">discretionary</span></em><span class="kobospan" id="kobo.817.1"> and </span><em class="italic"><span class="kobospan" id="kobo.818.1">mandatory</span></em><span class="kobospan" id="kobo.819.1">. </span><span class="kobospan" id="kobo.819.2">SELinux, as a mandatory access control could help us to harden the security of </span><span><span class="kobospan" id="kobo.820.1">our systems.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.821.1">The use of SELinux is considered very complex, but we gave several examples that simplify how it works. </span><span class="kobospan" id="kobo.821.2">SELinux is a </span><span><em class="italic"><span class="kobospan" id="kobo.822.1">labeling system</span></em></span><span><span class="kobospan" id="kobo.823.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.824.1">We learned how to read the error logs with SELinux and found that there are only </span><em class="italic"><span class="kobospan" id="kobo.825.1">four</span></em><span class="kobospan" id="kobo.826.1"> scenarios where SELinux could fail, as looked at their solutions. </span><span class="kobospan" id="kobo.826.2">The most common failures are with labels or when using custom configurations </span><span><span class="kobospan" id="kobo.827.1">for services.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.828.1">Also, policies could have errors and they should be reported to </span><span><span class="kobospan" id="kobo.829.1">their developers.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.830.1">In a less common case, we analyzed that the change of behavior of the policies could be due to an </span><em class="italic"><span class="kobospan" id="kobo.831.1">attack</span></em><span class="kobospan" id="kobo.832.1"> on </span><span><span class="kobospan" id="kobo.833.1">our system.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.834.1">In the next chapter, we will take an in-depth look at how to virtualize complete systems or take them to their smallest expression </span><span><span class="kobospan" id="kobo.835.1">using containers.</span></span></p>
<h1 id="_idParaDest-187" class="calibre5"><a id="_idTextAnchor252" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.836.1">Further reading</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.837.1">To learn more about the topics covered in this chapter, you can visit the </span><span><span class="kobospan" id="kobo.838.1">following links:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.839.1">A sysadmin’s guide to SELinux: 42 answers to the big </span></em><span><em class="italic"><span class="kobospan" id="kobo.840.1">questions</span></em></span><span><span class="kobospan" id="kobo.841.1">: </span></span><a href="https://opensource.com/article/18/7/sysadmin-guide-selinux" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.842.1">https://opensource.com/article/18/7/sysadmin-guide-selinux</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.843.1">A sysadmin’s handy cheat sheet for </span></em><span><em class="italic"><span class="kobospan" id="kobo.844.1">SELinux</span></em></span><span><span class="kobospan" id="kobo.845.1">: </span></span><a href="https://opensource.com/article/18/8/cheat-sheet-selinux" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.846.1">https://opensource.com/article/18/8/cheat-sheet-selinux</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.847.1">SELinux troubleshooting and </span></em><span><em class="italic"><span class="kobospan" id="kobo.848.1">pitfalls</span></em></span><span><span class="kobospan" id="kobo.849.1">: </span></span><a href="https://www.redhat.com/sysadmin/selinux-troubleshooting" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.850.1">https://www.redhat.com/sysadmin/selinux-troubleshooting</span></span></a></li>
</ul>
</div>
</body></html>