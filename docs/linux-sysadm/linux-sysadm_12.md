

# 集中式身份验证

用户访问控制是信息安全中至关重要的一部分。在单一计算机上，跟踪用户并确保只有授权人员能够访问是简单的，但随着网络规模的增大，在所有计算机上保持用户账户同步变得越来越困难，这也是为什么大型网络使用集中式身份验证机制的原因。历史上，类 UNIX 系统通常使用**网络信息服务**（**NIS**），该协议由 Sun Microsystems 开发，曾广泛使用，但现在基本不再使用。如今，选择更加多样，包括独立的 LDAP 目录、Kerberos 域，或提供目录服务用于存储用户信息并支持单点登录协议的身份验证解决方案，例如 FreeIPA 和 Microsoft Active Directory。

本章我们将学习以下内容：

+   Linux 中的身份验证与用户信息查找框架

+   **名称服务切换**（**NSS**）框架、**可插拔身份验证模块**（**PAM**）和**系统安全服务守护进程**（**SSSD**）的作用

+   如何设置与 Microsoft Active Directory 兼容的域控制器并将客户端计算机连接到该域控制器

# AAA 框架

访问控制框架通常被称为*AAA*，因为它包括三个组件：*身份验证*、*授权*和*审计*。

**身份验证**负责验证用户的身份——通常通过检查用户是否拥有某些知识（如密码）、数据（如加密密钥或基于时间的身份验证算法的正确种子）、物理项（如硬件密钥存储）或属性（如指纹）来完成。

**授权**是检查尝试执行某个操作的用户是否有权限执行该操作的过程。由于在 UNIX 系统中，许多实体（如硬件设备和套接字）被表示为文件，因此许多时候，文件访问权限被用作授权框架。

最后，**审计**过程确保用户的操作被记录，以便能够将操作归属给用户、监控用户活动中的异常情况，并调查安全事件。由于对于通用操作系统来说，无法列出所有用户操作的详尽清单，因此无法制定通用的审计框架。syslog 机制是记录日志信息的常用方式，但每个应用程序的日志信息格式各不相同。

在用户访问控制组件中，Linux 的身份验证具有独特性，因为它拥有一个广泛使用且通用的框架，该框架由三个部分组成：**NSS**、**PAM**，以及在更新的 Linux 发行版中使用的 **SSSD**。它们之间的关系较为复杂，因为它们的功能广泛且部分重叠，许多任务可以在不同层次上解决。

这个框架的两个较旧部分，NSS 和 PAM，起源于名为 Solaris 的操作系统，该操作系统由 Sun Microsystems（后来被 Oracle 收购）开发，并很快被几乎所有类 UNIX 系统采纳。然而，两个机制都没有成为 POSIX 标准的一部分，而且它们在不同操作系统中的实现略有不同。SSSD 是在 2000 年代末为 Linux 开发的，现在广泛被 Linux 发行版使用，但其他类 UNIX 系统并未使用。

让我们详细探讨一下这些子系统的目的和功能。

# Linux 中的认证机制

在我们了解集中式认证机制之前，我们需要先了解 Linux 中身份验证的基本工作原理。在系统检查用户凭证之前，它需要先获取用户信息——让我们来看一下信息查询是如何工作的。

## 信息查询

用户和组的信息对于身份验证是必要的，但它还有许多其他用途。例如，文件所有权信息通常以人类可读的方式显示，但内部，文件系统存储的是数值化的用户和组标识符，因此即使是与安全无关的程序，如 `ls`，也可能需要查找用户和组的信息，以将它们的标识符映射到名称。

POSIX API 标准包括多个查询用户、组和主机等各种实体信息的函数。例如，`gethostbyname(name)` 检索与域名关联的网络地址，`getgrpnam(name)` 检索用户组的信息。对于应用程序而言，这些函数是黑盒子，它们既不了解也无法控制这个过程——底层系统如何获取这些数据以及在哪里获取这些数据并不是应用程序开发人员关心的问题。通过保持该过程对应用程序不透明，操作系统开发人员可以确保所有应用程序从查询调用中获得一致的数据。

在 GNU/Linux 系统中，这些函数是由 GNU C 库（`glibc`）实现的。然而，这个库并没有固定的支持查询机制和数据源，而是使用 **NSS** 机制作为一个抽象层。

## 名称服务切换

NSS 子系统允许管理员将 *数据库* 与不同类型的信息映射到 *数据源*。让我们查看一个 Fedora 安装的配置文件，以了解它的功能：

```
$ cat /etc/nsswitch.conf
# Generated by authselect on Tue May 31 00:21:30 2022
# Do not modify this file manually, use authselect instead. Any user changes will be overwritten.
# You can stop authselect from managing your configuration by calling 'authselect opt-out'.
# See authselect(8) for more details.
# In order of likelihood of use to accelerate lookup.
passwd:     files sss systemd
shadow:     files
group:      files sss systemd
hosts:      files myhostname mdns4_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] dns
services:   files sss
netgroup:   files sss
automount:  files sss
aliases:    files
ethers:     files
gshadow:    files
networks:   files dns
protocols:  files
publickey:  files
rpc:        files
```

NSS 不仅限于身份验证数据查询，它的功能要广泛得多。NSS 数据库和数据源的概念在一个非身份验证的例子中更容易展示：主机名查询。负责网络主机名解析的 `hosts` 数据库被设置为使用多个数据源，包括 `files` 和 `dns`。

数据源的顺序决定了查找的顺序。在这种情况下，`hosts` 条目指示系统首先查找本地文件，然后再转向网络源，例如零配置网络发现机制（多播 DNS），最后才是全局 DNS 系统。在这个特定的案例中，`files` 关键字指的是 `/etc/hosts` 文件，该文件在*第六章*中有讨论，属于 *基本* *系统设置*。

数据源通常按照从最快和最可靠的顺序排列。本地源排在前面，因为即使网络中断，它们始终可用，而且读取本地文件是一个非常快速的操作。远程源排在后面，因为访问它们总是至少涉及一些延迟，并且它们可能由于网络或服务器故障而变得无法访问。有时，比如在主机名查找的情况下，顺序还有安全性上的影响：确保系统在向 DNS 服务器发出请求之前首先查找 `/etc/hosts` 中的名称，确保传统名称如 `localhost` 始终指向本地主机（IPv4 为 `127.0.0.1`，IPv6 为 `::1`）。如果先查询 DNS，一个恶意或配置错误的服务器可能返回不同的地址，进而将 `ping localhost` 等命令的流量重定向到任意地址。

`passwd` 数据库用于查找用户信息。它的 `files` 数据源就是熟悉的 `/etc/passwd` —— 这也是它名字的来源。

在不同数据源中的查找是通过动态加载的库（共享对象）实现的，例如 `/usr/lib/libnss_files.so.2` 和 `/usr/lib/libnss_dns.so.2`。

当然，使用 NSS 独立实现对不同身份验证信息数据库的支持并重新使用最旧的登录处理代码是完全可能的 —— NSS 的目标是让这样的客户端代码与任何数据源兼容，这样代码甚至不会知道它现在是从远程源（例如 RADIUS 或 LDAP 服务器）获取用户信息和密码哈希，而不是从 `/etc/passwd` 和 `/etc/shadow` 获取。这在过去曾经实现过，LDAP 的 NSS 模块至今仍可在互联网上找到。

然而，存在多个理由来支持一个更灵活的用户身份验证框架，以及提供身份验证和查找功能的抽象层。

# 可插拔身份验证模块

NSS 帮助程序检索各种信息，包括用户名、组成员信息和密码哈希值。然而，身份验证的逻辑仍然必须存在于某处。例如，要进行基于密码的身份验证，必须有代码计算用户输入的明文密码的哈希值，并与存储在身份验证数据库中的哈希值进行对比。

然而，认证策略不仅仅是拥有密码并检查它们是否正确。管理员可能希望强制执行密码强度规则，或使用多因素认证来提高安全性。例如，使用远程数据库进行认证也带来了一些挑战，比如凭证缓存，以确保在远程数据库暂时不可用时，用户不会被锁定在他们的机器之外。

为了让开发者和管理员能够创建并设置灵活的认证策略工具，并增加新的认证算法，Linux 发行版使用了一个名为**PAM**的框架。

PAM 为应用程序提供了一个 API，以便进行用户认证，并供安全工具开发者实现认证机制。PAM 模块可以依赖 NSS 层来查找它们需要的信息进行用户认证，或者提供自己的查找机制和配置文件。

在 Fedora 和 Red Hat 系统中，PAM 模块可以在`/usr/lib64/security/`找到，而在 Debian（x86 机器）中，它们可以在`/usr/lib/x86_64-linux-gnu/security/`中找到。模块通常会带有自己的手册页面，因此可以通过运行`man pam_unix`或`man pam_empty`来获取简要描述。

例如，`pam_empty`是最简单的模块，它总是返回认证失败——它仅作为一个守卫模块，用于确保当多个回退机制都失败时，用户将被拒绝访问。

`pam_unix`模块实现了常规的密码认证，通常使用`/etc/passwd`和`/etc/shadow`文件，除非 NSS 被配置为使用其他方式。

一些模块并不实现任何认证机制，而是执行辅助操作。例如，`pam_motd`在登录后显示消息（通常位于`/etc/motd`）；`pam_mail`负责检查本地邮件并显示；`pam_pwquality`和`pam_pwhistory`有助于确保用户不使用弱密码，并且不重复使用旧密码。

## PAM 配置

尽管手动配置 PAM 通常不是一个好主意，大多数 Linux 发行版也不鼓励这样做，并提供了高层次的配置工具，然而，了解其配置文件如何工作仍然很重要。

首先，PAM 不是一个程序，而是一个框架和一组 API，供其他程序使用。Linux 中没有单一的登录程序，因此也没有单一的全局认证配置文件。相反，有多个具备登录功能的程序，它们共享大部分但不是全部配置。这些程序包括处理本地虚拟控制台登录尝试的`/bin/login`可执行文件，但 PAM 也被图形登录管理器（如 GDM 或 LightDM）、屏幕保护程序和网络访问服务（如 OpenSSH）独立使用。

配置文件存储在 `/etc/pam.d/` 中，但它们本身没有任何特殊意义——它们都由不同的程序读取和使用。例如，名为 `/etc/pam.d/login` 的文件由 `/bin/login` 使用，因此仅应用于本地虚拟控制台。

这些应用程序特定文件的名称是硬编码在使用它们的程序中的，但共享配置存储在独立的文件中，这些文件的名称在不同的发行版之间有所不同。

让我们比较 Fedora 和 Debian 中 OpenSSH 守护进程使用 PAM 的默认配置文件。如果你没有安装 OpenSSH，你可以查看其他文件，比如 `/etc/pam.d/login`。

这个文件来自 Fedora：

```
$ cat /etc/pam.d/sshd
#%PAM-1.0
auth       substack     password-auth
auth       include      postlogin
account    required     pam_sepermit.so
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open env_params
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    optional     pam_motd.so
session    include      password-auth
session    include      postlogin
```

这个来自 Debian 系统：

```
$ cat /etc/pam.d/sshd
# PAM configuration for the Secure Shell service
# Standard Un*x authentication.
@include common-auth
# Disallow non-root logins when /etc/nologin exists.
account    required     pam_nologin.so
# Uncomment and edit /etc/security/access.conf if you need to set complex
# access limits that are hard to express in sshd_config.
# account  required     pam_access.so
# Standard Un*x authorization.
@include common-account
# SELinux needs to be the first session rule.  This ensures that any
# lingering context has been cleared.  Without this it is possible
# that a module could execute code in the wrong domain.
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so close
# Set the loginuid process attribute.
session    required     pam_loginuid.so
# Create a new session keyring.
session    optional     pam_keyinit.so force revoke
# Standard Un*x session setup and teardown.
@include common-session
# Print the message of the day upon successful login.
# This includes a dynamically generated part from /run/motd.dynamic
# and a static (admin-editable) part from /etc/motd.
session    optional     pam_motd.so  motd=/run/motd.dynamic
session    optional     pam_motd.so noupdate
# Print the status of the user's mailbox upon successful login.
session    optional     pam_mail.so standard noenv # [1]
# Set up user limits from /etc/security/limits.conf.
session    required     pam_limits.so
# Read environment variables from /etc/environment and
# /etc/security/pam_env.conf.
session    required     pam_env.so # [1]
# In Debian 4.0 (etch), locale-related environment variables were 
# moved to
# /etc/default/locale, so read that as well.
session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale
# SELinux needs to intervene at login time to ensure that the process # starts
# in the proper default security context.  Only sessions which are 
# intended
# to run in the user's context should be run after this.
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so open
# Standard Un*x password updating.
@include common-password
```

如你所见，它们的功能几乎相同，但组织方式不同。例如，Debian 广泛使用 `@include` 指令，它加载来自不同文件的所有行。例如，`@include common-auth` 指示 PAM 加载 `/etc/pam.d/common-auth` ——所有此类文件引用都是相对于 `/etc/pam.d` 的。

Fedora 文件的作者选择使用模块接口调用，而不是：`auth substack system-auth`。在这样的行中，最后一个选项要么是模块名称，要么是配置文件引用。如果以 `.so` 结尾（这是共享对象文件的常见扩展名——动态加载的库文件），那么它就是一个模块；否则，它是 `/etc/pam.d` 中的配置文件。因此，当你看到 `substack system-auth` 时，它意味着加载来自 `/etc/pam.d/system-auth` 的行（`include` 和 `substack` 选项的工作方式类似）。

所有此类行的第一部分是模块接口名称。有些模块仅提供一种接口类型（例如，`pam_unix` 仅处理密码认证），而其他模块可能提供多种类型。`auth` 接口用于执行身份验证。其他接口类型表明 *可插拔认证模块* 的名称在某些情况下并不准确。`account` 接口处理授权并检查用户账户是否允许登录——例如，`pam_time` 模块可以让特定用户仅在某些时间段或某些日期访问系统。`password` 接口处理密码更改。最后，`session` 接口处理与认证无关的辅助任务，例如在用户第一次登录时为其创建主目录或通过网络挂载目录。

## PAM 的局限性

PAM 仅关注认证和相关活动；例如，配置一个正确的 LDAP 服务器和选项的 `pam_ldap` 模块并不会自动使 LDAP 中的用户和组信息对所有需要将数字标识符映射到名称的应用程序可用。在这种情况下，为了提供无缝体验，管理员还需要配置一个 NSS 模块。独立配置两个模块并提供相同的信息会带来显著的维护负担，而且将信息从远程源传递给像 `pam_unix` 这样的简单模块对于需要发放和验证会话令牌而非简单密码哈希检查的单点登录协议（如 Kerberos）不起作用。历史上，这个问题通过定制守护进程如 `winbind` 来解决，用于与 Microsoft Active Directory 或 Samba 域交互。如今，大多数 Linux 发行版通过通用抽象层——**SSSD** 解决了这个问题。

# 系统安全服务守护进程

NSS 和 PAM 的结合提供了很大的灵活性，但也可能使常见场景的配置和维护变得困难。SSSD 项目努力通过协调 PAM 和 NSS 与远程数据库的交互来简化这一过程。

单点登录方案的配置复杂性之一在于它们通常涉及多个组件和协议，例如用于存储用户信息的 LDAP 和用于发放及检查加密认证票证的 Kerberos，以及发现这些服务的方式，通常通过特殊的 DNS 记录。SSSD 内置支持流行的单点登录方案，如 Microsoft Active Directory 和 FreeIPA，这大大简化了过程。

在本示范中，我们将在 Linux 上使用 Samba 项目设置与 Microsoft Active Directory 兼容的域控制器，并将客户端计算机加入该域。我们将使用 Fedora Linux，但其他发行版在包安装命令上大多有所不同。

# 使用 Samba 4 进行 Active Directory 认证

Samba 是一个开源实现，支持与 Microsoft Windows 机器互操作所需的多个协议，包括 SMB 文件共享协议（Samba 名字的来源）。除了文件共享外，它还实现了认证和用户管理——最初，它只支持 Windows NT 域，但自 4.0.0 版本以来，它完全支持与 Windows Server 2008 兼容的 Active Directory，并且还包括内建的 LDAP 和 DNS 后端，使得小规模安装变得非常简单。

## 设置域控制器

首先，您需要安装 Samba 域控制器软件包：

```
$ sudo dnf install samba-dc
```

然后，您可能需要删除 Samba 和 Kerberos 守护进程的所有配置文件，以确保清洁状态：

```
$ sudo rm -f /etc/samba/smb.conf
$ sudo rm -f /etc/krb5.conf
```

Samba 包含一个用于自动配置域控制器的命令，因此无需手动编写配置文件。该命令支持交互式和非交互式模式，并且还可以通过命令行选项指定一些参数，但其余部分可以交互式输入。例如，如果你计划在 VirtualBox 虚拟机中运行客户端系统，你可以设置控制器只监听虚拟机网络接口，使用`--option="interfaces=vboxnet0" --option="bind interfaces only=yes"`。你可能还希望在控制器使用的 LDAP 模式中包含 UNIX 用户的字段 —— 它们由 RFC2307 定义，因此该选项是`--use-rfc2307`。

最重要的必需参数是领域名称，必须是用大写字母书写的域名 —— 这是 Kerberos 协议的要求，小写的领域名称将被拒绝。我们将使用 `AD.EXAMPLE.COM`，其中 `example.com` 是为示例和文档保留的域之一，保证不会属于任何真实的个人或组织。大多数现代客户端软件主要或专门使用领域名称，但配置工具也会要求输入域名（以 NetBIOS 而非 DNS 的形式） —— 一个最多 15 个字符长的字符串。由于 Active Directory 及其兼容实现依赖于 DNS SRV 记录来查找控制器并与其通信，控制器还将提供这些 DNS 记录，但我们将限制其只监听虚拟机网络接口 —— 在此情况下，使用 `192.168.56.1`（这是 VirtualBox 中仅主机网络适配器的默认地址）。它还将要求输入域管理员密码 —— 你需要记住它以便从客户端机器加入该域：

```
$ sudo samba-tool domain provision --option="interfaces=vboxnet0" --option="bind interfaces only=yes" --use-rfc2307 --interactive
Realm:  AD.EXAMPLE.COM
Domain [AD]:  AD
Server Role (dc, member, standalone) [dc]:
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
DNS forwarder IP address (write 'none' to disable forwarding) [127.0.0.53]:  192.168.56.1
Administrator password:
Retype password:
INFO 2022-12-07 16:25:13,958 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2108: Looking up IPv4 addresses
INFO 2022-12-07 16:25:17,450 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2017: Fixing provision GUIDs
...
INFO 2022-12-07 16:25:17,784 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2342: The Kerberos KDC configuration for Samba AD is located at /var/lib/samba/private/kdc.conf
INFO 2022-12-07 16:25:17,785 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2348: A Kerberos configuration suitable for Samba AD has been generated at /var/lib/samba/private/krb5.conf
INFO 2022-12-07 16:25:17,785 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2350: Merge the contents of this file with your system krb5.conf or replace it with this one. Do not create a symlink!
INFO 2022-12-07 16:25:17,948 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #2082: Setting up fake yp server settings
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #487: Once the above files are installed, your Samba AD server will be ready to use
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #492: Server Role:           active directory domain controller
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #493: Hostname:              mizar
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #494: NetBIOS Domain:        AD
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #495: DNS Domain:            ad.example.com
INFO 2022-12-07 16:25:18,002 pid:54185 /usr/lib64/python3.10/site-packages/samba/provision/__init__.py #496: DOMAIN SID:            S-1-5-21-2070738055-845390856-828010526
```

请注意，配置脚本会生成 Kerberos 配置文件，但不会自动部署 —— 你需要手动将其复制到目标位置：

```
$ sudo cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
```

现在，我们只需要启动 Samba 服务：

```
$ sudo systemctl start samba
```

我们还将创建一个名为`testuser`的用户，以验证身份验证是否按预期工作。我们在控制器中创建新用户的命令是`sudo samba-tool user create test-user`（它会提示你输入密码）。

使用`sudo samba-tool user show testuser`，你可以查看该用户账户的 LDAP 字段：

```
$ samba-tool user show testuser
dn: CN=testuser,CN=Users,DC=ad,DC=example,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: testuser
instanceType: 4
whenCreated: 20221207171435.0Z
uSNCreated: 4103
name: testuser
objectGUID: 773d2799-e08c-41fb-9768-675dd59edbbb
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
primaryGroupID: 513
objectSid: S-1-5-21-2070738055-845390856-828010526-1103
accountExpires: 9223372036854775807
sAMAccountName: testuser
sAMAccountType: 805306368
userPrincipalName: testuser@ad.example.com
objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=ad,DC=example,DC=com
pwdLastSet: 133149068751598230
userAccountControl: 512
lastLogonTimestamp: 133149085286105320
lockoutTime: 0
whenChanged: 20221207180044.0Z
uSNChanged: 4111
logonCount: 0
distinguishedName: CN=testuser,CN=Users,DC=ad,DC=example,DC=com
```

服务器现在已经准备好接收身份验证请求。

## 设置客户端

既然域控制器已经准备就绪，我们可以设置客户端机器以便验证用户。由于我们同样使用 Fedora 作为客户端，因此它很可能默认安装了 SSSD 和 `realmd` —— 一个用于配置认证领域的工具。

我们可以使用 `realm discover` 命令验证控制器是否工作正常，如下所示：

```
$ realm discover ad.example.com
ad.example.com
  type: kerberos
  realm-name: AD.EXAMPLE.COM
  domain-name: ad.example.com
  configured: no
  server-software: active-directory
  client-software: sssd
  required-package: oddjob
  required-package: oddjob-mkhomedir
  required-package: sssd
  required-package: adcli
  required-package: samba-common-tools
```

从此输出中，我们可以看到这台机器尚未加入该域（`configured: no`）。它还显示了需要安装的加入域的包列表——如果某些包尚未安装，你可以使用如`sudo dnf install samba-common-tools`的 DNF 命令进行安装。

加入域也非常简单。一旦运行`sudo realm join ad.example.com`，它将要求你输入域管理员密码（即你在配置过程中在控制器上输入的密码），并生成 SSSD 的配置文件：

```
$ sudo realm join ad.example.com
Password for Administrator:
```

你需要通过`sudo systemctl restart sssd`重启 SSSD 以应用更改。

生成的 SSSD 配置将如下所示：

```
$ sudo cat /etc/sssd/sssd.conf
[sssd]
domains = ad.example.com
config_file_version = 2
services = nss, pam
[domain/ad.example.com]
default_shell = /bin/bash
krb5_store_password_if_offline = True
cache_credentials = True
krb5_realm = AD.EXAMPLE.COM
realmd_tags = manages-system joined-with-adcli
id_provider = ad
fallback_homedir = /home/%u@%d
ad_domain = ad.example.com
use_fully_qualified_names = True
ldap_id_mapping = True
access_provider = ad
```

由于 SSSD 充当 NSS 提供程序，并且在 Fedora 中`passwd`的默认`nssswitch.conf`值为`files sss`，我们可以使用常规的`id`命令查询`testuser`账户的信息，尽管在我们的配置中，我们需要指定其完整的域名：

```
$ id testuser@ad.example.com
uid=1505601103(testuser@ad.example.com) gid=1505600513(domain users@ad.example.com) groups=1505600513(domain users@ad.example.com)
```

通过输入`testuser@ad.example.com`以及我们之前在控制器上设置的密码，也可以立即登录到控制台。

如你所见，使用 Samba 设置与 Microsoft Active Directory 兼容的域控制器是一个简单且大部分自动化的过程。

# 概述

在本章中，我们学习了基于 Linux 的系统如何通过 PAM、NSS 和 SSSD 实现认证过程和用户信息查找。我们还学习了集中认证的解决方案，并演示了如何使用 Samba 软件设置与 Microsoft Active Directory 兼容的域控制器，并从另一台 Linux 机器加入该域。

在下一章中，我们将学习 Linux 中的高可用性机制。

# 进一步阅读

要了解更多关于本章所涵盖的主题，请查看以下资源：

+   SSSD 文档: [`sssd.io/docs/introduction.xhtml`](https://sssd.io/docs/introduction.xhtml%0D)

+   Samba 项目: [`www.samba.org/`](https://www.samba.org/%0D)

+   FreeIPA 项目: [`www.freeipa.org/`](https://www.freeipa.org/%0D)

+   Kerberos: [`en.wikipedia.org/wiki/Kerberos_(protocol)`](https://en.wikipedia.org/wiki/Kerberos_(protocol)%0D)

+   LDAP: [`en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol`](https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol%0D)

+   Microsoft Active Directory: [`en.wikipedia.org/wiki/Active_Directory`](https://en.wikipedia.org/wiki/Active_Directory)
