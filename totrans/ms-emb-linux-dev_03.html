<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer021" class="Basic-Text-Frame">
    <h1 class="chapterNumber"><a id="_idTextAnchor035"/>2</h1>
    <h1 id="_idParaDest-31" class="chapterTitle"><a id="_idTextAnchor036"/>Learning about Toolchains</h1>
    <p class="normal">The toolchain is the first element of embedded Linux and the starting point of your project. You will use it to compile all the code that will run on your device. The choices you make at this early stage will have a profound impact on the final outcome.</p>
    <p class="normal">Your toolchain should be capable of making effective use of your hardware by using the optimum instruction set for your processor. It should support the languages that you require and have a <a id="_idIndexMarker053"/>solid implementation of the <strong class="keyWord">Portable Operating System Interface</strong> (<strong class="keyWord">POSIX</strong>) and other system interfaces.</p>
    <p class="normal">Your toolchain should remain constant throughout the project. In other words, once you have chosen your toolchain, it is important to stick with it. Changing compilers and development libraries inconsistently during a project will lead to subtle bugs. That being said, it is still best to update your toolchain when security flaws or bugs are found.</p>
    <p class="normal">Obtaining a toolchain can be as simple as downloading and installing a TAR file or it can be as complex as building the whole thing from source code. In this chapter, we take the first approach. Later on, in <a href="Chapter_04.xhtml#_idTextAnchor110"><em class="italic">Chapter 6</em></a>,<em class="italic"> </em>we will switch to using the toolchain generated by the build system. This is the more usual means of obtaining a toolchain.</p>
    <p class="normal">In this chapter, we will cover the following topics:</p>
    <ul>
      <li class="bulletList">Introducing toolchains</li>
      <li class="bulletList">Finding a toolchain</li>
      <li class="bulletList">Anatomy of a toolchain</li>
      <li class="bulletList">Linking with libraries ‒ static and dynamic linking</li>
      <li class="bulletList">Art of cross-compiling</li>
    </ul>
    <h1 id="_idParaDest-32" class="heading-1"><a id="_idTextAnchor037"/>Technical requirements</h1>
    <p class="normal">I recommend using Ubuntu 24.04 or a later LTS release since the exercises in this chapter were all tested against that Linux distro at the time of writing.</p>
    <p class="normal">Here is the command to install all the packages required for this chapter on Ubuntu 24.04 LTS:</p>
    <pre class="programlisting con"><code class="hljs-con">$ sudo apt-get install autoconf automake bison bzip2 cmake flex g++ gawk gcc gettext git gperf help2man libstdc++6 libtool libtool-bin make patch texinfo unzip wget xz-utils
</code></pre>
    <p class="normal">The code used in this chapter can be found in the chapter folder in this book’s GitHub repository: <a href="https://github.com/PacktPublishing/Mastering-Embedded-Linux-Development/tree/main/Chapter02"><span class="url">https://github.com/PacktPublishing/Mastering-Embedded-Linux-Development/tree/main/Chapter02</span></a>.</p>
    <h1 id="_idParaDest-33" class="heading-1"><a id="_idTextAnchor038"/>Introducing toolchains</h1>
    <p class="normal">A toolchain is a set <a id="_idIndexMarker054"/>of tools that compiles source code into executables that can run on your target device. It includes a compiler, a linker, and runtime libraries. You need a toolchain to build the other three elements of an embedded Linux system:</p>
    <ul>
      <li class="bulletList">Bootloader</li>
      <li class="bulletList">Kernel</li>
      <li class="bulletList">Root filesystem</li>
    </ul>
    <p class="normal">It has to be able to compile code written in C, C++, and an assembly language since these are the languages used in the base open source packages.</p>
    <p class="normal">Usually, toolchains for Linux are based on components from the GNU project and that is still true at <a id="_idIndexMarker055"/>the time of writing. However, over the past few years, the <strong class="keyWord">Clang</strong> compiler and the associated <strong class="keyWord">Low-Level Virtual Machine</strong> (<strong class="keyWord">LLVM</strong>) project have progressed <a id="_idIndexMarker056"/>to the point that LLVM is now a viable alternative to a GNU toolchain. One major distinction between LLVM and GNU-based toolchains is the licensing; LLVM has the Apache License v2.0 with LLVM Exceptions while GNU has the GPL.</p>
    <p class="normal">There are some technical advantages to Clang as well, such as faster compilation, better diagnostics, and more <a id="_idIndexMarker057"/>support for the latest C and C++ standards. But <strong class="keyWord">GCC</strong> (<strong class="keyWord">GNU C Compiler</strong>) has the advantage of compatibility with the existing code base and support for a wider range of architectures and <strong class="keyWord">Operating</strong> <strong class="keyWord">Systems</strong> (<strong class="keyWord">OS</strong>). While it took some years to get there, Clang can now compile all the components needed for embedded Linux and is a viable alternative to GCC. To learn more, see <a href="https://docs.kernel.org/kbuild/llvm.html"><span class="url">https://docs.kernel.org/kbuild/llvm.html</span></a>.</p>
    <p class="normal">There is a good description of how to use Clang for cross-compilation at <a href="https://clang.llvm.org/docs/CrossCompilation.html"><span class="url">https://clang.llvm.org/docs/CrossCompilation.html</span></a>. If you would like to use it as part of an embedded Linux build system, various people are working on using Clang with Buildroot and The Yocto Project. I will cover embedded build systems in <a href="Chapter_04.xhtml#_idTextAnchor110"><em class="italic">Chapter 6</em></a>. Meanwhile, this chapter focuses on the GNU toolchain as it is still the most popular and mature toolchain for Linux.</p>
    <p class="normal">A standard GNU toolchain consists of three main components:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Binutils</strong>: A set of <a id="_idIndexMarker058"/>binary utilities including the assembler <a id="_idIndexMarker059"/>and the linker.</li>
      <li class="bulletList"><strong class="keyWord">GCC</strong>: Compilers <a id="_idIndexMarker060"/>for C and other languages, which include <a id="_idIndexMarker061"/>C++, Objective-C, Objective-C++, Java, Fortran, Ada, Go, and D. They all use a common backend that produces assembler code that is fed to the GNU assembler.</li>
      <li class="bulletList"><strong class="keyWord">C library</strong>: A <a id="_idIndexMarker062"/>standardized <strong class="keyWord">Application Program Interface</strong> (<strong class="keyWord">API</strong>) based <a id="_idIndexMarker063"/>on the POSIX <a id="_idIndexMarker064"/>specification, which is the main interface to the OS kernel for applications. There are several C libraries to consider, as we shall see later in this chapter.</li>
    </ul>
    <p class="normal">Along with these, you will also <a id="_idIndexMarker065"/>need a copy of the Linux kernel headers. The kernel headers contain definitions and constants that are needed when accessing the kernel directly. You need the kernel headers to compile the C library, programs, and libraries. This <strong class="keyWord">user space</strong> code interacts <a id="_idIndexMarker066"/>indirectly with Linux devices, for example, to display graphics via the Linux frame buffer driver. This is in stark contrast to kernel modules/drivers inside <strong class="keyWord">kernel space</strong> with direct <a id="_idIndexMarker067"/>access to peripheral hardware.</p>
    <p class="normal">This is not simply a question of making a copy of the header files in the include directory of your kernel source code. Those headers are intended for use in the kernel only and contain definitions that will cause conflicts if used in their raw state to compile regular Linux applications. Instead, you will need to generate a set of sanitized kernel headers, which I have illustrated in <a href="Chapter_05.xhtml#_idTextAnchor138"><em class="italic">Chapter 5</em></a>.</p>
    <p class="normal">When compiling for user space, the kernel headers do not need to be generated from the exact version of Linux you are going to be running on. Since the kernel interfaces are always backward compatible, it is only necessary that the headers are from a kernel that is the same as or older than the one you are using on the target.</p>
    <p class="normal">Most people <a id="_idIndexMarker068"/>consider the <strong class="keyWord">GNU Debugger</strong> (<strong class="keyWord">GDB</strong>) to be part of the toolchain as well since it is also normally built at this point. When building a cross compiler, you also need to build a corresponding cross debugger to debug code on the target remotely from your host machine. I will talk about GDB in <a href="Chapter_19.xhtml#_idTextAnchor611"><em class="italic">Chapter 19</em></a>.</p>
    <p class="normal">Now that we’ve talked about kernel headers and seen what the components of a toolchain are, let’s look at the different types of toolchains.</p>
    <h2 id="_idParaDest-34" class="heading-2"><a id="_idTextAnchor039"/>Types of toolchains</h2>
    <p class="normal">For our <a id="_idIndexMarker069"/>purposes, there are two types of toolchains:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Native</strong>: A toolchain that runs on the same type of system (or even the actual system) as the <a id="_idIndexMarker070"/>programs it generates. This is usually the <a id="_idIndexMarker071"/>case for desktops and servers, and it is becoming popular on certain classes of embedded devices. For example, the Raspberry Pi 4 running Debian for ARM has self-hosted native compilers.</li>
      <li class="bulletList"><strong class="keyWord">Cross</strong>: A toolchain <a id="_idIndexMarker072"/>that runs on a different type of system <a id="_idIndexMarker073"/>than the target allowing development to be done on a fast desktop PC and then loaded onto the embedded target for execution.</li>
    </ul>
    <p class="normal">Almost all embedded Linux development is done using a cross-development toolchain. This is partly because most embedded devices are not well suited for development since they lack computing power, memory, and storage, but also because it keeps the host and target environments separate. The latter point is especially important when the host and the target are using the same architecture, x86_64, for example. In this case, it is tempting to compile natively on the host and simply copy the binaries to the target.</p>
    <p class="normal">This works up to a point. However, it is likely that the host distribution will receive updates more often than the target or that different engineers building code for the target will have slightly different versions of the host development libraries. Over time, the development and target systems will diverge. You can upgrade the toolchain if you ensure that the host and the target build environments are in lockstep with each other. However, a much better approach is to keep the host and the target separate, and a cross toolchain is the way to do that.</p>
    <p class="normal">There is a counterargument in favor of native development. Cross-development creates the burden of having to cross-compile all the libraries and tools that you need for your target. We will see later, in the section titled <em class="italic">Art of cross-compiling</em>, that cross-development is not always simple because many open source packages are not designed to be built in this way.</p>
    <p class="normal">Integrated build tools like Buildroot and The Yocto Project help by encapsulating the rules for cross-compiling a range of packages needed by most embedded systems. But if you want to compile lots of additional packages, then it is better to compile them natively. For example, building a Debian distribution for the Raspberry Pi 4 or BeaglePlay using a cross compiler is very hard. Instead, they are natively compiled.</p>
    <p class="normal">Creating a native build environment from scratch is not easy. You still need a cross compiler at first to create <a id="_idIndexMarker074"/>the native build environment on the target, which you then use to build the packages. Then, to perform the native build in a reasonable amount of time, you need <a id="_idIndexMarker075"/>a build farm of well-provisioned target boards or <strong class="keyWord">Quick Emulator</strong> (<strong class="keyWord">QEMU</strong>) to emulate the target.</p>
    <p class="normal">In this chapter, we will focus on a pre-built cross-compiler environment that is relatively easy to set up and administer. We will start by looking at what distinguishes one target CPU architecture from another.</p>
    <h2 id="_idParaDest-35" class="heading-2"><a id="_idTextAnchor040"/>CPU architectures</h2>
    <p class="normal">The toolchain must <a id="_idIndexMarker076"/>be built according to the capabilities of the target CPU, which includes:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">CPU architecture</strong>: ARM, RISC-V, PowerPC, <strong class="keyWord">Microprocessor without Interlocked Pipelined Stages</strong> (<strong class="keyWord">MIPS</strong>), or <a id="_idIndexMarker077"/>x86_64.</li>
      <li class="bulletList"><strong class="keyWord">Big- or little-endian operation</strong>: Some CPUs can operate in both modes, but the machine code is different for each.</li>
      <li class="bulletList"><strong class="keyWord">Floating point support</strong>: Not all versions of embedded processors implement a hardware floating point unit. In these cases, the toolchain must be configured to call a software floating point library instead.</li>
      <li class="bulletList"><strong class="keyWord">Application Binary Interface (ABI)</strong>: The calling convention used for passing parameters between function calls.</li>
    </ul>
    <p class="normal">With many architectures, the ABI is constant across the family of processors. One notable exception is ARM. The ARM <a id="_idIndexMarker078"/>architecture transitioned to the <strong class="keyWord">Extended Application Binary Interface</strong> (<strong class="keyWord">EABI</strong>) in the late 2000s resulting in the <a id="_idIndexMarker079"/>previous ABI being named the <strong class="keyWord">Old Application Binary Interface</strong> (<strong class="keyWord">OABI</strong>). While the OABI is now obsolete, you continue to see references to EABI. Since then, the EABI has split into three based on the way floating point parameters are passed: softfloat, softfp, and hardfp.</p>
    <p class="normal">The original EABI uses software emulation (softfloat) or general-purpose integer registers (softfp), while <a id="_idIndexMarker080"/>the newer <strong class="keyWord">Extended Application Binary Interface Hard-Float</strong> (<strong class="keyWord">EABIHF</strong>) uses floating point registers (hardfp). The original <a id="_idIndexMarker081"/>EABI’s softfloat and softfp modes are ABI-compatible. In <strong class="keyWord">softfloat</strong> mode, the compiler does not generate <strong class="keyWord">Floating Point Unit </strong>(<strong class="keyWord">FPU</strong>) instructions. All floating point operations <a id="_idIndexMarker082"/>are done in software, resulting in <a id="_idIndexMarker083"/>suboptimal performance. In <strong class="keyWord">softfp</strong> mode, float values are passed via the stack or integer registers for better performance. EABIHF is significantly faster at <a id="_idIndexMarker084"/>floating point operations since <strong class="keyWord">hardfp</strong> mode removes the need for copying between integer and floating point registers. </p>
    <p class="normal">The downside of EABIHF is that hardfp mode is incompatible with CPUs that do not have a floating point unit. The choice then is between two incompatible ABIs. You cannot mix and match the two, so you must decide at this stage.</p>
    <p class="normal">GNU adds a <a id="_idIndexMarker085"/>prefix to the name of each tool in the toolchain that identifies the various combinations that can be generated. This prefix consists of a tuple of three or four components separated by dashes, as described here:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">CPU</strong>: The CPU architecture such as ARM, RISC-V, PowerPC, MIPS, or x86_64. If the CPU has both endian modes, they may be differentiated by adding <code class="inlineCode">el</code> for little-endian or <code class="inlineCode">eb</code> for big-endian. Good examples are little-endian MIPS (<code class="inlineCode">mipsel</code>) and big-endian ARM (<code class="inlineCode">armeb</code>).</li>
      <li class="bulletList"><strong class="keyWord">Vendor</strong>: Identifies the provider of the toolchain. Examples include <code class="inlineCode">buildroot</code>, <code class="inlineCode">poky</code>, and just <code class="inlineCode">unknown</code>. Sometimes, it is left out altogether.</li>
      <li class="bulletList"><strong class="keyWord">OS</strong>: For our purposes, it is always <code class="inlineCode">linux</code>.</li>
      <li class="bulletList"><strong class="keyWord">User space</strong>: A name for the user space component, which might be <code class="inlineCode">gnu</code> or <code class="inlineCode">musl</code>. The ABI may be appended here as well. So, for ARM toolchains, you may see <code class="inlineCode">gnueabi</code>, <code class="inlineCode">gnueabihf</code>, <code class="inlineCode">musleabi</code>, or <code class="inlineCode">musleabihf</code>.</li>
    </ul>
    <p class="normal">You can find the tuple used when building the toolchain by using the <code class="inlineCode">-dumpmachine</code> option of <code class="inlineCode">gcc</code>. For example, you may see the following on the host computer:</p>
    <pre class="programlisting con"><code class="hljs-con">$ gcc -dumpmachine
x86_64-linux-gnu
</code></pre>
    <p class="normal">This tuple indicates a CPU of <code class="inlineCode">x86_64</code>, a kernel of <code class="inlineCode">linux</code>, and a user space of <code class="inlineCode">gnu</code>.</p>
    <div class="note">
      <p class="normal"><strong class="keyWord">IMPORTANT NOTE</strong></p>
      <p class="normal">When a native compiler is installed on a machine it is normal to create links to each of the tools in the toolchain with no prefixes so that you can call the C compiler with the <code class="inlineCode">gcc</code> command.</p>
    </div>
    <p class="normal">Here is an example using a cross compiler:</p>
    <pre class="programlisting con"><code class="hljs-con">$ mipsel-unknown-linux-gnu-gcc -dumpmachine
mipsel-unknown-linux-gnu
</code></pre>
    <p class="normal">This tuple <a id="_idIndexMarker086"/>indicates a CPU of little-endian MIPS, an <code class="inlineCode">unknown</code> vendor, a kernel of <code class="inlineCode">linux</code>, and a user space of <code class="inlineCode">gnu</code>. Your choice of user space (<code class="inlineCode">gnu</code> or <code class="inlineCode">musl</code>) determines which C library (glibc or musl) your programs are linked with.</p>
    <h2 id="_idParaDest-36" class="heading-2"><a id="_idTextAnchor041"/>Choosing the C library</h2>
    <p class="normal">The programming interface to the Unix OS is defined in the C language in adherence to POSIX standards. The <strong class="keyWord">C library</strong> is the <a id="_idIndexMarker087"/>implementation of that interface. It is the gateway <a id="_idIndexMarker088"/>to the kernel for Linux programs. Even if you are writing programs in another language like Go or Python, the respective runtime support libraries will eventually have to call the C library, as shown here:</p>
    <figure class="mediaobject"><img src="../Images/B18466_02_01.png" alt="Figure 2.1 – C library" width="370" height="471"/></figure>
    <p class="packt_figref">Figure 2.1 – C library</p>
    <p class="normal">Whenever the C library needs the services of the kernel, it will use the kernel system call interface to transition between user space and kernel space. It is possible to bypass the C library by making the kernel system calls directly but that is a lot of trouble and almost never necessary.</p>
    <p class="normal">There are several C libraries to choose from. The main options are as follows:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">glibc</strong>: This is the standard GNU C library available at <a href="https://gnu.org/software/libc/"><span class="url">https://gnu.org/software/libc/</span></a>. It <a id="_idIndexMarker089"/>is big and, until recently, not very configurable, but it <a id="_idIndexMarker090"/>is the most complete <a id="_idIndexMarker091"/>implementation of the POSIX API. The license is LGPL 2.1.</li>
      <li class="bulletList"><strong class="keyWord">musl libc</strong>: This is <a id="_idIndexMarker092"/>comparatively new but has been gaining a lot of attention <a id="_idIndexMarker093"/>as a small and standards-compliant alternative <a id="_idIndexMarker094"/>to glibc. It is a good choice for systems with a limited amount of RAM and storage. It has an MIT license and is available at <a href="https://musl.libc.org"><span class="url">https://musl.libc.org</span></a>.</li>
      <li class="bulletList"><strong class="keyWord">uClibc-ng</strong>: <em class="italic">u</em> is really the Greek <em class="italic">mu</em> character, indicating that this is the microcontroller <a id="_idIndexMarker095"/>C library. uClibc-ng is available at <a href="https://uclibc-ng.org"><span class="url">https://uclibc-ng.org</span></a>. It was <a id="_idIndexMarker096"/>first developed to work <a id="_idIndexMarker097"/>with uClinux (Linux for microcontrollers without a memory management unit) but has since been adapted to be used with full Linux. The uClibc-ng library is a fork of the original uClibc project, which has fallen into disrepair. Both are licensed with LGPL 2.1.</li>
    </ul>
    <p class="normal">So, which to choose? My advice is to use uClibc-ng only if you are using uClinux. If you have a very limited <a id="_idIndexMarker098"/>amount of storage or RAM, then musl libc is a good choice. Otherwise, use glibc, as shown in this flow chart:</p>
    <figure class="mediaobject"><img src="../Images/B18466_02_02.png" alt="Figure 2.2 – Choosing a C library" width="826" height="635"/></figure>
    <p class="packt_figref">Figure 2.2 – Choosing a C library</p>
    <p class="normal">Your choice of C library could limit your choice of toolchain since not all pre-built toolchains support all C libraries. Once you know what you need in a toolchain, where do you find one?</p>
    <h1 id="_idParaDest-37" class="heading-1"><a id="_idTextAnchor042"/>Finding a toolchain</h1>
    <p class="normal">You have three choices for your cross-development toolchain: you may find a ready-built toolchain that <a id="_idIndexMarker099"/>matches your needs, you can use the one generated by an embedded build tool (which is covered in <a href="Chapter_04.xhtml#_idTextAnchor110"><em class="italic">Chapter 6</em></a>), or you can create one yourself.</p>
    <p class="normal">A pre-built cross toolchain is an attractive option in that you only have to download and install it. But you are limited to the configuration of that particular toolchain, and you are dependent on the person or organization you got it from. Most likely, it will be one of these:</p>
    <ul>
      <li class="bulletList">An SoC or board vendor. Most vendors offer a Linux toolchain.</li>
      <li class="bulletList">A consortium dedicated to providing system-level support for a given architecture. For <a id="_idIndexMarker100"/>example, Linaro (<a href="https://www.linaro.org"><span class="url">https://www.linaro.org</span></a>) has pre-built toolchains for the ARM architecture.</li>
      <li class="bulletList">A third-party Linux tool vendor such as Siemens, Timesys, or Wind River.</li>
      <li class="bulletList">The cross-tool <a id="_idIndexMarker101"/>packages for your desktop Linux distribution. For example, Debian-based distributions have packages for cross-compiling for ARM, PowerPC, and MIPS targets.</li>
      <li class="bulletList">A binary SDK <a id="_idIndexMarker102"/>produced by one of the integrated embedded build tools. The Yocto Project has some available for download at <a href="https://downloads.yoctoproject.org/releases/yocto/yocto-version/toolchain/"><span class="url">https://downloads.yoctoproject.org/releases/yocto/yocto-&lt;version&gt;/toolchain/</span></a>. (replace <code class="inlineCode">&lt;version&gt;</code> with a valid Yocto Project version such as <code class="inlineCode">5.0</code> in the preceding URL).</li>
      <li class="bulletList">A link from <a id="_idIndexMarker103"/>a forum that you can’t find anymore.<div class="note">
          <p class="normal"><strong class="keyWord">IMPORTANT NOTE</strong></p>
          <p class="normal">In all these cases, you must decide whether the pre-built toolchain on offer meets your requirements. Does it use the C library you prefer? Will the provider give you updates for security fixes and bugs? Bear in mind my comments on support and updates from <a href="Chapter_01.xhtml#_idTextAnchor016"><em class="italic">Chapter 1</em></a>. If your answer is no to any of these, then you should consider creating your own.</p>
        </div>
      </li>
    </ul>
    <p class="normal">Unfortunately, building a toolchain is no easy task. If you truly want to do the whole thing yourself, take a look <a id="_idIndexMarker104"/>at Cross Linux From Scratch (<a href="https://trac.clfs.org"><span class="url">https://trac.clfs.org</span></a>). There, you will find step-by-step instructions on how to create each component.</p>
    <p class="normal">A simpler <a id="_idIndexMarker105"/>alternative is to use crosstool-NG, which encapsulates the process into a set of scripts and has a menu-driven frontend. You still need a fair degree of knowledge though just to make the right choices.</p>
    <p class="normal">It is simpler still to use a build system such as Buildroot or The Yocto Project since they generate a toolchain as part of the build process. This is my preferred solution, as we shall see in <a href="Chapter_04.xhtml#_idTextAnchor110"><em class="italic">Chapter 6</em></a>.</p>
    <p class="normal">You will need a working cross toolchain to complete the exercises in the next section. We will employ a pre-built toolchain from Bootlin. Bootlin’s toolchains are built using Buildroot.</p>
    <p class="normal">To download the pre-built cross toolchain needed for <em class="italic">Chapters 2</em> through <em class="italic">5</em>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ wget https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2024.02-1.tar.bz2
</code></pre>
    <p class="normal">To download the latest version of this toolchain, visit <a href="https://toolchains.bootlin.com"><span class="url">https://toolchains.bootlin.com</span></a>. Select <em class="italic">aarch64</em> for architecture and <em class="italic">glibc</em> for libc. Once these choices have been made, download the stable version of the toolchain.</p>
    <p class="normal">Install the <a id="_idIndexMarker106"/>pre-built toolchain on your Linux host machine by extracting and decompressing it to your home directory:</p>
    <pre class="programlisting con"><code class="hljs-con">$ bzip2 -d aarch64--glibc--stable-2024.02-1.tar.bz2
$ tar -xvf aarch64--glibc--stable-2024.02-1.tar
&lt;…&gt;
</code></pre>
    <p class="normal">You will use this toolchain for the remainder of this chapter. Let’s start by looking at its internals.</p>
    <h1 id="_idParaDest-38" class="heading-1"><a id="_idTextAnchor043"/>Anatomy of a toolchain</h1>
    <p class="normal">To get an idea of what is in a typical toolchain, let’s examine the toolchain you downloaded from Bootlin. The examples <a id="_idIndexMarker107"/>use the aarch64 toolchain, which has the prefix <code class="inlineCode">aarch64-buildroot-linux-gnu</code>.</p>
    <p class="normal">The aarch64 toolchain is in the directory <code class="inlineCode">~/aarch64--glibc--stable-2024.02-1/bin</code>. In there, you will find the cross compiler <code class="inlineCode">aarch64-buildroot-linux-gnu-gcc</code>. To make use of it, you need to add the directory to your path using the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">$ PATH=~/aarch64--glibc--stable-2024.02-1/bin:$PATH
</code></pre>
    <p class="normal">If you downloaded a different version, make sure to replace <code class="inlineCode">2024.02-1</code> with the actual version of the stable toolchain.</p>
    <p class="normal">Now you can take a simple <code class="inlineCode">helloworld</code> program, which, in the C language, looks like this:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">#</span><span class="hljs-keyword">include</span><span class="hljs-meta"> </span><span class="hljs-string">&lt;stdio.h&gt;</span>
<span class="hljs-meta">#</span><span class="hljs-keyword">include</span><span class="hljs-meta"> </span><span class="hljs-string">&lt;stdlib.h&gt;</span>
<span class="hljs-type">int</span><span class="hljs-function"> </span><span class="hljs-title">main</span><span class="hljs-function"> </span><span class="hljs-params">(</span><span class="hljs-type">int</span><span class="hljs-params"> argc, </span><span class="hljs-type">char</span><span class="hljs-params"> *argv[])</span>
{
    <span class="hljs-built_in">printf</span> (<span class="hljs-string">"Hello, World!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
    <p class="normal">And compile it like this:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc helloworld.c -o helloworld
</code></pre>
    <p class="normal">Confirm that it <a id="_idIndexMarker108"/>has been cross-compiled by using the <code class="inlineCode">file</code> command to print the type of the file:</p>
    <pre class="programlisting con"><code class="hljs-con">$ file helloworld
helloworld: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, for GNU/Linux 3.7.0,  not stripped
</code></pre>
    <p class="normal">Now that you’ve verified that your cross compiler works, let’s take a closer look at it.</p>
    <h2 id="_idParaDest-39" class="heading-2"><a id="_idTextAnchor044"/>Finding out about your cross compiler</h2>
    <p class="normal">Imagine that you have just received a toolchain and that you would like to know more about how it was <a id="_idIndexMarker109"/>configured. You can find out a lot by querying <code class="inlineCode">gcc</code>. For example, to find the version, you use <code class="inlineCode">--version</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc --version
aarch64-buildroot-linux-gnu-gcc.br_real (Buildroot 2021.11-11272-ge2962af) 12.3.0
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre>
    <p class="normal">To find how it was configured, use <code class="inlineCode">-v</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -v
Using built-in specs.
COLLECT_GCC=/home/frank/aarch64--glibc--stable-2024.02-1/bin/aarch64-buildroot-linux-gnu-gcc.br_real
COLLECT_LTO_WRAPPER=/home/frank/aarch64--glibc--stable-2024.02-1/bin/../libexec/gcc/aarch64-buildroot-linux-gnu/12.3.0/lto-wrapper
Target: aarch64-buildroot-linux-gnu
Configured with: ./configure --prefix=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1 --sysconfdir=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1/etc --enable-static --target=aarch64-buildroot-linux-gnu --with-sysroot=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1/aarch64-buildroot-linux-gnu/sysroot --enable-__cxa_atexit --with-gnu-ld --disable-libssp --disable-multilib --disable-decimal-float --enable-plugins --enable-lto --with-gmp=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1 --with-mpc=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1 --with-mpfr=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1 --with-pkgversion='Buildroot 2021.11-11272-ge2962af' --with-bugurl=http://bugs.buildroot.net/ --without-zstd --disable-libquadmath --disable-libquadmath-support --enable-tls --enable-threads --without-isl --without-cloog --with-abi=lp64 --with-cpu=cortex-a53 --enable-languages=c,c++,fortran --with-build-time-tools=/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1/aarch64-buildroot-linux-gnu/bin --enable-shared --enable-libgomp
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 12.3.0 (Buildroot 2021.11-11272-ge2962af)
&lt;…&gt;
</code></pre>
    <p class="normal">There is a lot <a id="_idIndexMarker110"/>of output there but the interesting things to note are:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">--with-sysroot</code>=<code class="inlineCode">/builds/buildroot.org/toolchains-builder/build/aarch64--glibc--stable-2024.02-1/aarch64-buildroot-linux-gnu/sysroot</code>: The location of the <code class="inlineCode">sysroot</code> directory at build time. See the following section for an explanation.</li>
      <li class="bulletList"><code class="inlineCode">--enable-languages=c,c++,fortran</code>: Both the C and C++ languages are enabled.</li>
      <li class="bulletList"><code class="inlineCode">--with-cpu=cortex-a53</code>: Generates code for an ARM Cortex-A53 core.</li>
      <li class="bulletList"><code class="inlineCode">--enable-threads</code>: Enables POSIX threads.</li>
    </ul>
    <p class="normal">These are the default settings for the compiler. You can override most of them on the <code class="inlineCode">gcc</code> command line. For example, if you want to compile for a different CPU, you can override the configured setting <code class="inlineCode">--with-cpu</code> by adding <code class="inlineCode">-mcpu=cortex-a72</code> to the command line, as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -mcpu=cortex-a72 helloworld.c -o helloworld
</code></pre>
    <p class="normal">You can print out the range of architecture-specific options available using <code class="inlineCode">--target-help</code>, as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc --target-help
</code></pre>
    <p class="normal">You may be wondering if it matters that you get the configuration exactly right at this point since you can always change it. The answer depends on the way you anticipate using it. If you plan to create a new toolchain for each target, then it makes sense to set everything up at the beginning <a id="_idIndexMarker111"/>because it will reduce the risks of getting it wrong later.</p>
    <p class="normal">I call this the Buildroot philosophy, which we will revisit in <a href="Chapter_04.xhtml#_idTextAnchor110"><em class="italic">Chapter 6</em></a>. If, on the other hand, you want to build a toolchain that is generic, and you are prepared to provide the correct settings when you build for a particular target, then you should make the base toolchain generic, which is the way The Yocto Project handles things.</p>
    <p class="normal">Now that we’ve seen the location of the <code class="inlineCode">sysroot</code> directory at build time, let’s look inside the default <code class="inlineCode">sysroot</code> directory installed on your host machine.</p>
    <h2 id="_idParaDest-40" class="heading-2"><a id="_idTextAnchor045"/>sysroot, library, and header files</h2>
    <p class="normal">The toolchain <code class="inlineCode">sysroot</code> directory contains subdirectories for libraries, header files, and other configuration <a id="_idIndexMarker112"/>files. It can be set when the toolchain is <a id="_idIndexMarker113"/>configured through <code class="inlineCode">--with-sysroot=</code> or it can be set <a id="_idIndexMarker114"/>on the command line using <code class="inlineCode">--sysroot=</code>. You can see the location of the default <code class="inlineCode">sysroot</code> by using <code class="inlineCode">-print-sysroot</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -print-sysroot
/home/frank/aarch64--glibc--stable-2024.02-1/aarch64-buildroot-linux-gnu/sysroot
</code></pre>
    <p class="normal">You will <a id="_idIndexMarker115"/>find the following subdirectories in <code class="inlineCode">sysroot</code>:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">lib</code>: Contains the shared objects for the C library and the dynamic linker/loader <code class="inlineCode">ld-linux</code></li>
      <li class="bulletList"><code class="inlineCode">usr/lib</code>: Contains the static library archive files for the C library and any other libraries that may be subsequently installed</li>
      <li class="bulletList"><code class="inlineCode">usr/include</code>: Contains the headers for all the libraries</li>
      <li class="bulletList"><code class="inlineCode">usr/bin</code>: Contains the utility programs that run on the target such as the <code class="inlineCode">ldd</code> command</li>
      <li class="bulletList"><code class="inlineCode">usr/share</code>: Used for localization and internationalization</li>
      <li class="bulletList"><code class="inlineCode">sbin</code>: Provides the <code class="inlineCode">ldconfig</code> utility that is used to optimize library loading paths</li>
    </ul>
    <p class="normal">Some of these are needed on the development host to compile programs and others, like the shared libraries and <code class="inlineCode">ld-linux</code>, are needed on the target at runtime.</p>
    <h2 id="_idParaDest-41" class="heading-2"><a id="_idTextAnchor046"/>Other tools in the toolchain</h2>
    <p class="normal">Below is a list <a id="_idIndexMarker116"/>of commands to invoke the various other components of a GNU toolchain. Like <code class="inlineCode">aarch64-buildroot-linux-gnu-gcc</code>, these tools are all located inside the <code class="inlineCode">~/aarch64--glibc--stable-2024.02-1/bin/</code> directory that you added to your <code class="inlineCode">PATH</code>. Here are brief descriptions of these tools:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">addr2line</code>: Converts program addresses into source code filenames and line numbers by reading the debug symbol tables in an executable file. It is very useful when decoding addresses printed out in a system crash report.</li>
      <li class="bulletList"><code class="inlineCode">ar</code>: An archive utility used to create static libraries.</li>
      <li class="bulletList"><code class="inlineCode">as</code>: GNU assembler.</li>
      <li class="bulletList"><code class="inlineCode">c++filt</code>: Demangles C++ and Java symbols.</li>
      <li class="bulletList"><code class="inlineCode">cpp</code>: C preprocessor used to expand <code class="inlineCode">#define</code>, <code class="inlineCode">#include</code>, and other similar directives. You seldom need to use this by itself.</li>
      <li class="bulletList"><code class="inlineCode">elfedit</code>: Updates the ELF header of the ELF files.</li>
      <li class="bulletList"><code class="inlineCode">g++</code>: GNU C++ frontend, which assumes that source files contain C++ code.</li>
      <li class="bulletList"><code class="inlineCode">gcc</code>: GNU C frontend, which assumes that source files contain C code.</li>
      <li class="bulletList"><code class="inlineCode">gcov</code>: Code coverage tool.</li>
      <li class="bulletList"><code class="inlineCode">gdb</code>: GNU debugger.</li>
      <li class="bulletList"><code class="inlineCode">gprof</code>: Program profiling tool.</li>
      <li class="bulletList"><code class="inlineCode">ld</code>: GNU linker.</li>
      <li class="bulletList"><code class="inlineCode">nm</code>: Lists symbols from object files.</li>
      <li class="bulletList"><code class="inlineCode">objcopy</code>: Copies and translates object files.</li>
      <li class="bulletList"><code class="inlineCode">objdump</code>: Displays information from object files.</li>
      <li class="bulletList"><code class="inlineCode">ranlib</code>: Creates or modifies an index in a static library making the linking stage faster.</li>
      <li class="bulletList"><code class="inlineCode">readelf</code>: Displays information about files in ELF object format.</li>
      <li class="bulletList"><code class="inlineCode">size</code>: Lists section sizes and the total size.</li>
      <li class="bulletList"><code class="inlineCode">strings</code>: Displays strings of printable characters in files.</li>
      <li class="bulletList"><code class="inlineCode">strip</code>: Strips an object file of debug symbol tables, making it smaller. Typically, you would strip all the executable code that is put onto the target.</li>
    </ul>
    <p class="normal">We will now switch gears from command-line tools and return to the topic of the C library.</p>
    <h2 id="_idParaDest-42" class="heading-2"><a id="_idTextAnchor047"/>Looking at the components of the C library</h2>
    <p class="normal">The C library <a id="_idIndexMarker117"/>is not a single library file. It is composed of four main parts that together implement the POSIX API:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">libc</code>: The main C library that contains the well-known POSIX functions such as <code class="inlineCode">printf</code>, <code class="inlineCode">open</code>, <code class="inlineCode">close</code>, <code class="inlineCode">read</code>, <code class="inlineCode">write</code>, and so on</li>
      <li class="bulletList"><code class="inlineCode">libm</code>: Contains math functions such as <code class="inlineCode">cos</code>, <code class="inlineCode">exp</code>, and <code class="inlineCode">log</code></li>
      <li class="bulletList"><code class="inlineCode">libpthread</code>: Contains all the POSIX thread functions with names beginning with <code class="inlineCode">pthread_</code></li>
      <li class="bulletList"><code class="inlineCode">librt</code>: Has real-time extensions to POSIX including shared memory and asynchronous I/O</li>
    </ul>
    <p class="normal">The first one, <code class="inlineCode">libc</code>, is always linked in but the others must be explicitly linked with the <code class="inlineCode">-l</code> option. The parameter to <code class="inlineCode">-l</code> is the library name with <code class="inlineCode">lib</code> stripped off. For example, a program that <a id="_idIndexMarker118"/>calculates a sine function by calling <code class="inlineCode">sin()</code> would be linked with <code class="inlineCode">libm</code> using <code class="inlineCode">-lm</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc myprog.c -o myprog -lm
</code></pre>
    <p class="normal">You can verify which libraries have been linked in this or any other program by using the <code class="inlineCode">readelf</code> command:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-readelf -a myprog | grep "Shared library"
0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
</code></pre>
    <p class="normal">Shared libraries need a runtime linker, which you can expose using:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-readelf -a myprog | grep "program interpreter"
      [Requesting program interpreter: /lib/ld-linux-aarch64.so.1]
</code></pre>
    <p class="normal">This is so useful that I have a script file named <code class="inlineCode">list-libs</code>, which you will find in the book code archive in <code class="inlineCode">MELD/list-libs</code>. It contains the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">${CROSS_COMPILE}readelf -a $1 | grep "program interpreter"
${CROSS_COMPILE}readelf -a $1 | grep "Shared library"
</code></pre>
    <p class="normal">There are other library files we can link to other than the four components of the C library. We will look at how to do that in the next section.</p>
    <h1 id="_idParaDest-43" class="heading-1">Linking wi<a id="_idTextAnchor048"/>th libraries – static and dynamic linking</h1>
    <p class="normal">Any application <a id="_idIndexMarker119"/>you write for Linux, whether it be in C or C++, will be <a id="_idIndexMarker120"/>linked with <a id="_idIndexMarker121"/>the C library <code class="inlineCode">libc</code>. This is so fundamental that you don’t even have to tell <code class="inlineCode">gcc</code> or <code class="inlineCode">g++</code> to do it because it always links <code class="inlineCode">libc</code>. Other libraries that you may want to link with have to be explicitly named through the <code class="inlineCode">-l</code> option.</p>
    <p class="normal">Library code can be linked in two different ways:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Statically</strong>: This means that all the library functions your application calls and their dependencies are pulled from the library archive and bound into your executable.</li>
      <li class="bulletList"><strong class="keyWord">Dynamically</strong>: This means that references to the library files and functions in those files are generated in the code but the actual linking is done dynamically at load time.</li>
    </ul>
    <p class="normal">You will find the code for the examples that follow in the book code archive in <code class="inlineCode">MELD/Chapter02/library</code>.</p>
    <h2 id="_idParaDest-44" class="heading-2"><a id="_idTextAnchor049"/>Static libraries</h2>
    <p class="normal">Static linking is useful in a few circumstances. For example, if you are building a small system that consists <a id="_idIndexMarker122"/>of only BusyBox and some script files, it is simpler to link BusyBox statically and avoid having to copy the runtime library files and linker. The footprint <a id="_idIndexMarker123"/>will also be smaller because you only link in the code that your application uses rather than supplying the entire C library. Static linking is also useful if you need to run a program before the filesystem that holds the runtime libraries is available.</p>
    <p class="normal">You can link all the libraries statically by adding <code class="inlineCode">-static</code> to the command line:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -static helloworld.c -o helloworld-static
</code></pre>
    <p class="normal">You will note that the size of the binary increases dramatically:</p>
    <pre class="programlisting con"><code class="hljs-con">$ ls -l helloworld*
-rwxrwxr-x 1 frank frank   8928 Apr 28 23:34 helloworld
-rw-rw-r-- 1 frank frank    123 Apr 28 23:30 helloworld.c
-rwxrwxr-x 1 frank frank 718472 Apr 28 23:33 helloworld-static
</code></pre>
    <p class="normal">Static linking pulls code from a library archive usually named lib&lt;name&gt;.a. In the preceding case, it is libc.a, which is in &lt;sysroot&gt;/usr/lib:</p>
    <pre class="programlisting con"><code class="hljs-con">$ export SYSROOT=$(aarch64-buildroot-linux-gnu-gcc -print-sysroot)
$ cd $SYSROOT
$  ls -l usr/lib/libc.a
-rw-r--r-- 1 frank frank 5551484 Mar  3  2024 usr/lib/libc.a
</code></pre>
    <p class="normal">Note that the syntax <code class="inlineCode">export SYSROOT=$(aarch64-buildroot-linux-gnu-gcc -print-sysroot)</code> places the path to the <code class="inlineCode">sysroot</code> in the shell variable <code class="inlineCode">SYSROOT</code>, which makes the example a little clearer.</p>
    <p class="normal">Creating a static library is as simple as creating an archive of object files using the <code class="inlineCode">ar</code> command. If I have <a id="_idIndexMarker124"/>two source files named <code class="inlineCode">test1.c</code> and <code class="inlineCode">test2.c</code> (this exercise <a id="_idIndexMarker125"/>has no Git examples – you are expected to generate your own <code class="inlineCode">test1.c</code> and <code class="inlineCode">test2.c</code> files) and I want to create a static library named <code class="inlineCode">libtest.a</code>, then I would do the following:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -c test1.c
$ aarch64-buildroot-linux-gnu-gcc -c test2.c
$ aarch64-buildroot-linux-gnu-ar rc libtest.a test1.o test2.o
$ ls -l
total 24
-rw-rw-r--  1 frank frank 2392 Nov  9 09:28 libtest.a
-rw-rw-r--  1 frank frank  116 Nov  9 09:26 test1.c
-rw-rw-r--  1 frank frank 1080 Nov  9 09:27 test1.o
-rw-rw-r--  1 frank frank  121 Nov  9 09:26 test2.c
-rw-rw-r--  1 frank frank 1088 Nov  9 09:27 test2.o
</code></pre>
    <p class="normal">The book’s Git repository contains source and makefiles to assist with the linking exercises that follow:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cd MELD/Chapter02/library
$ tree
.
├── hello-arm
│   ├── hello-arm.c
│   └── Makefile
├── inc
│   └── testlib.h
├── shared
│   ├── Makefile
│   └── testlib.c
└── static
    ├── Makefile
    └── testlib.c
</code></pre>
    <p class="normal">Compile the static <code class="inlineCode">libtest.a</code> library:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cd static
$ CC=aarch64-buildroot-linux-gnu-gcc make
aarch64-buildroot-linux-gnu-gcc -Wall -g -I../inc -c testlib.c
ar rc libtest.a testlib.o
</code></pre>
    <p class="normal">Compile <code class="inlineCode">hello-arm.c</code> and link it with <code class="inlineCode">libtest.a</code> to produce a hello-arm-static executable:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cd ../hello-arm
$ CC=aarch64-buildroot-linux-gnu-gcc make hello-arm-static
aarch64-buildroot-linux-gnu-gcc -c -Wall -I../inc -o hello-arm.o hello-arm.c
aarch64-buildroot-linux-gnu-gcc -o hello-arm-static hello-arm.o -L../static -ltest
</code></pre>
    <p class="normal">Now let’s <a id="_idIndexMarker126"/>rebuild the same program using dynamic linking.</p>
    <h2 id="_idParaDest-45" class="heading-2"><a id="_idTextAnchor050"/>Shared libraries</h2>
    <p class="normal">A more common way to deploy libraries is as shared objects that are linked at runtime, which makes <a id="_idIndexMarker127"/>more efficient use of storage and system memory since only one copy of the code needs to be loaded. It also makes it easy to update the library files <a id="_idIndexMarker128"/>without having to relink all the programs that use them.</p>
    <p class="normal">The object code for a shared library must be position independent so that the runtime linker is free to locate it in memory at the next free address. To do this, add the <code class="inlineCode">-fPIC</code> parameter to <code class="inlineCode">gcc</code> and then link it using the <code class="inlineCode">-shared</code> option:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -fPIC -c test1.c
$ aarch64-buildroot-linux-gnu-gcc -fPIC -c test2.c
$ aarch64-buildroot-linux-gnu-gcc -shared -o libtest.so test1.o test2.o
</code></pre>
    <p class="normal">This creates the shared library <code class="inlineCode">libtest.so</code>. To link an application with this library, you add <code class="inlineCode">-ltest</code> just like you did for the static case, but this time, the code is not included in the executable. Instead, there is a reference to the library that the runtime linker will have to resolve.</p>
    <p class="normal">Compile the shared <code class="inlineCode">libtest.so</code> library:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cd MELD/Chapter02/library
$ cd shared
$ CC=aarch64-buildroot-linux-gnu-gcc make
aarch64-buildroot-linux-gnu-gcc -Wall -g -fPIC -I../inc -c testlib.c
aarch64-buildroot-linux-gnu-gcc -shared -o libtest.so testlib.o
</code></pre>
    <p class="normal">Compile <code class="inlineCode">hello-arm.c</code> and link it with <code class="inlineCode">libtest.so</code> to produce a <code class="inlineCode">hello-arm-shared</code> executable:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cd ../hello-arm
$ CC=aarch64-buildroot-linux-gnu-gcc make hello-arm-shared
aarch64-buildroot-linux-gnu-gcc -c -Wall -I../inc -o hello-arm.o hello-arm.c
aarch64-buildroot-linux-gnu-gcc -o hello-arm-shared hello-arm.o -L../shared -ltest
$ ~/MELD/list-libs hello-arm-shared
      [Requesting program interpreter: /lib/ld-linux-aarch64.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libtest.so]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
</code></pre>
    <p class="normal">The runtime linker for this program is <code class="inlineCode">/lib/ld-linux-aarch64.so.1</code>, which must be present in <a id="_idIndexMarker129"/>the target’s filesystem. The linker will look for <code class="inlineCode">libtest.so</code> in the default <a id="_idIndexMarker130"/>search path: <code class="inlineCode">/lib</code> and <code class="inlineCode">/usr/lib</code>. If you want it to look for libraries in other directories as well, you can place a colon-separated list of paths in the shell variable <code class="inlineCode">LD_LIBRARY_PATH</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ export LD_LIBRARY_PATH=/opt/lib:/opt/usr/lib
</code></pre>
    <p class="normal">Because shared libraries are separate from executables, you need to ensure the correct versions of shared libraries are installed on the target so that you don’t encounter runtime errors.</p>
    <h3 id="_idParaDest-46" class="heading-3"><a id="_idTextAnchor051"/>Understanding shared library version numbers</h3>
    <p class="normal">One of the benefits of shared libraries is that they can be updated independently of the programs <a id="_idIndexMarker131"/>that use them. Library updates are of two types:</p>
    <ul>
      <li class="bulletList">Those that fix bugs or add new functions in a backward-compatible way</li>
      <li class="bulletList">Those that break compatibility with existing applications</li>
    </ul>
    <p class="normal">GNU/Linux has a versioning scheme to handle both these cases.</p>
    <p class="normal">Each library has a release version and an interface number. The release version is simply a string that is appended to the library name. For example, the JPEG image library <code class="inlineCode">libjpeg</code> is currently at release 8.2.2 and so the library is named <code class="inlineCode">libjpeg.so.8.2.2</code>. There is a symbolic link named <code class="inlineCode">libjpeg.so</code> to <code class="inlineCode">libjpeg.so.8.2.2</code> so that when you compile a program with <code class="inlineCode">-ljpeg</code>, you link with the current version. If you install version 8.2.3, the link is updated, and you will link with that one instead.</p>
    <p class="normal">Now suppose that version 9.0.0 comes along and that breaks the backward compatibility. The link from <code class="inlineCode">libjpeg.so</code> now points to <code class="inlineCode">libjpeg.so.9.0.0</code> so that any new programs are linked with the new version. When the interface to <code class="inlineCode">libjpeg</code> changes, the result is compilation errors that a developer can fix.</p>
    <p class="normal">Any programs on the target that are not recompiled are going to fail in some way because they are still using the old interface. This is where an object known as the <strong class="keyWord">soname</strong> helps. The soname encodes the interface number from when the library was built and is used by the runtime linker when it loads the library. It is formatted as <code class="inlineCode">&lt;library name&gt;.so.&lt;interface number&gt;</code>. For <code class="inlineCode">libjpeg.so.8.2.2</code>, the soname is <code class="inlineCode">libjpeg.so.8</code> because the interface number when that <code class="inlineCode">libjpeg</code> shared library was built is 8:</p>
    <pre class="programlisting con"><code class="hljs-con">$ readelf -a /usr/lib/x86_64-linux-gnu/libjpeg.so.8.2.2 | grep SONAME
0x000000000000000e (SONAME)    Library soname: [libjpeg.so.8]
</code></pre>
    <p class="normal">Any program compiled with it will request <code class="inlineCode">libjpeg.so.8</code> at runtime, which will be a symbolic link <a id="_idIndexMarker132"/>on the target to <code class="inlineCode">libjpeg.so.8.2.2</code>. When version 9.0.0 of <code class="inlineCode">libjpeg</code> is installed, it will have a soname of <code class="inlineCode">libjpeg.so.9</code> and so it is possible to have two incompatible versions of the same library installed on the same system. Programs that were linked with <code class="inlineCode">libjpeg.so.8.*.*</code> will load <code class="inlineCode">libjpeg.so.8</code> and those linked with <code class="inlineCode">libjpeg.so.9.*.*</code> will load <code class="inlineCode">libjpeg.so.9</code>.</p>
    <p class="normal">This is why, when you look at the directory listing of <code class="inlineCode">/usr/lib/x86_64-linux-gnu/libjpeg*</code>, you find these four files:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">libjpeg.a</code>: The library archive used for static linking</li>
      <li class="bulletList"><code class="inlineCode">libjpeg.so -&gt; libjpeg.so.8.2.2</code>: A symbolic link used for dynamic linking</li>
      <li class="bulletList"><code class="inlineCode">libjpeg.so.8 -&gt; libjpeg.so.8.2.2</code>: A symbolic link used when loading the library at runtime</li>
      <li class="bulletList"><code class="inlineCode">libjpeg.so.8.2.2</code>: The actual shared library used at both compile time and runtime</li>
    </ul>
    <p class="normal">The first two are only needed on the host computer for building and the last two are needed on the target at runtime.</p>
    <p class="normal">While you can invoke the various GNU cross-compilation tools directly from the command line, this technique does not scale beyond toy examples like <code class="inlineCode">helloworld</code>. To really be effective at cross-compiling, we need to combine a cross toolchain with a build system.</p>
    <h1 id="_idParaDest-47" class="heading-1"><a id="_idTextAnchor052"/>Art of cross-compiling</h1>
    <p class="normal">Having a working cross toolchain is the starting point of a journey not the end of it. At some point, you will <a id="_idIndexMarker133"/>want to begin cross-compiling the various tools, applications, and libraries that you need for your target. Many of them will be open source packages, each of which has its own method of compiling and its own peculiarities.</p>
    <p class="normal">Some common build systems include:</p>
    <ul>
      <li class="bulletList">Pure makefiles where the toolchain is usually controlled by the <code class="inlineCode">make</code> variable <code class="inlineCode">CROSS_COMPILE</code></li>
      <li class="bulletList">GNU <strong class="keyWord">Autotools</strong> build system</li>
      <li class="bulletList"><strong class="keyWord">CMake</strong></li>
    </ul>
    <p class="normal">Both Autotools and makefiles are <a id="_idIndexMarker134"/>needed to build even a basic embedded Linux system. CMake is <a id="_idIndexMarker135"/>cross-platform <a id="_idIndexMarker136"/>and has seen increased adoption over the years, especially among the C++ community. In this section, we will cover all three build tools.</p>
    <h2 id="_idParaDest-48" class="heading-2"><a id="_idTextAnchor053"/>Simple makefiles</h2>
    <p class="normal">Some important packages are very simple to cross-compile, including the Linux kernel, the U-Boot bootloader, and BusyBox. For each of these, you only need to put the toolchain prefix in the <a id="_idIndexMarker137"/>make variable <code class="inlineCode">CROSS_COMPILE</code>, for example, <code class="inlineCode">aarch64-buildroot-linux-gnu-</code>. Note the trailing hyphen.</p>
    <p class="normal">To compile BusyBox, you type:</p>
    <pre class="programlisting con"><code class="hljs-con">$ make CROSS_COMPILE=aarch64-buildroot-linux-gnu-
</code></pre>
    <p class="normal">Or you can set it as a shell variable:</p>
    <pre class="programlisting con"><code class="hljs-con">$ export CROSS_COMPILE=aarch64-buildroot-linux-gnu-
$ make
</code></pre>
    <p class="normal">In the case <a id="_idIndexMarker138"/>of U-Boot and Linux, you also need to set the <code class="inlineCode">make</code> variable <code class="inlineCode">ARCH</code> to one of the machine architectures they support, which I will cover in <em class="italic">Chapters 3</em> and <em class="italic">4</em>.</p>
    <p class="normal">Both Autotools and CMake can generate makefiles. Autotools only generates makefiles, whereas CMake supports other ways of building projects depending on which platform(s) you are targeting (strictly Linux in our case). Let’s look at cross-compiling with Autotools first.</p>
    <h2 id="_idParaDest-49" class="heading-2"><a id="_idTextAnchor054"/>Autotools</h2>
    <p class="normal">The name Autotools refers <a id="_idIndexMarker139"/>to a group of tools that are used as the build system <a id="_idIndexMarker140"/>in many open source projects. The components, together <a id="_idIndexMarker141"/>with the <a id="_idIndexMarker142"/>appropriate project pages, are:</p>
    <ul>
      <li class="bulletList">GNU autoconf (<a href="https://www.gnu.org/software/autoconf/"><span class="url">https://www.gnu.org/software/autoconf/</span></a> )</li>
      <li class="bulletList"> GNU automake (https://www.gnu.org/software/automake/)</li>
      <li class="bulletList">GNU libtool (<a href="https://www.gnu.org/software/libtool/)"><span class="url">https://www.gnu.org/software/libtool/)</span></a></li>
      <li class="bulletList">gnulib (<a href="https://www.gnu.org/software/gnulib/)"><span class="url">https://www.gnu.org/software/gnulib/)</span></a></li>
    </ul>
    <p class="normal">The role of Autotools is to <a id="_idIndexMarker143"/>smooth over the differences between the <a id="_idIndexMarker144"/>different types of systems that the package may be compiled for, accounting for different versions of compilers, different versions of libraries, different locations of header files, and dependencies with other packages.</p>
    <p class="normal">Packages that use Autotools come with a script named <code class="inlineCode">configure</code> that checks dependencies and generates makefiles according to what it finds. The <code class="inlineCode">configure</code> script may also give you the opportunity to enable or disable certain features. You can find the options on offer by running <code class="inlineCode">./configure --help</code>.</p>
    <p class="normal">To configure, build, and install a package for the native OS, you would typically run the following three commands:</p>
    <pre class="programlisting con"><code class="hljs-con">$ ./configure
$ make
$ sudo make install
</code></pre>
    <p class="normal">Autotools can handle <a id="_idIndexMarker145"/>cross-development as well. You can influence the behavior <a id="_idIndexMarker146"/>of the configured script by setting these shell variables:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">CC</code>: C compiler command</li>
      <li class="bulletList"><code class="inlineCode">CFLAGS</code>: Additional C compiler flags</li>
      <li class="bulletList"><code class="inlineCode">CXX</code>: C++ compiler command</li>
      <li class="bulletList"><code class="inlineCode">CXXFLAGS</code>: Additional C++ compiler flags</li>
      <li class="bulletList"><code class="inlineCode">LDFLAGS</code>: Additional linker flags; for example, if you have libraries in a non-standard directory, <code class="inlineCode">&lt;lib dir&gt;</code>, you would add it to the library search path by adding <code class="inlineCode">-L&lt;lib dir&gt;</code></li>
      <li class="bulletList"><code class="inlineCode">LIBS</code>: A list of additional libraries to pass to the linker; for instance, <code class="inlineCode">-lm</code> for the math library</li>
      <li class="bulletList"><code class="inlineCode">CPPFLAGS</code>: C/C++ preprocessor flags; for example, you would add <code class="inlineCode">-I&lt;include dir&gt;</code> to search for headers in a non-standard directory, <code class="inlineCode">&lt;include dir&gt;</code></li>
      <li class="bulletList"><code class="inlineCode">CPP</code>: C preprocessor to use</li>
    </ul>
    <p class="normal">Sometimes, it is sufficient to set only the <code class="inlineCode">CC</code> variable, as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">$ CC=aarch64-buildroot-linux-gnu-gcc ./configure
</code></pre>
    <p class="normal">Other times, that will result in an error like this:</p>
    <pre class="programlisting con"><code class="hljs-con">&lt;…&gt;
checking for suffix of executables...
checking whether we are cross compiling... configure: error: in '/home/frank/sqlite-autoconf-3440000':
configure: error: cannot run C compiled programs.
If you meant to cross compile, use '--host'.
See 'config.log' for more details
</code></pre>
    <p class="normal">The reason for <a id="_idIndexMarker147"/>the failure is that <code class="inlineCode">configure</code> often tries to discover <a id="_idIndexMarker148"/>the capabilities of the toolchain by compiling snippets of code and running them to see what happens, which cannot work if the program has been cross-compiled.</p>
    <div class="note">
      <p class="normal"><strong class="keyWord">IMPORTANT NOTE</strong></p>
      <p class="normal">Pass <code class="inlineCode">--host=&lt;host&gt;</code> to <code class="inlineCode">configure</code> when you are cross-compiling so that <code class="inlineCode">configure</code> searches your system for the cross-compiling toolchain targeting the specified <code class="inlineCode">&lt;host&gt;</code> platform. That way, <code class="inlineCode">configure</code> does not try to run snippets of non-native code as part of the configuration step.</p>
    </div>
    <p class="normal">Autotools understands three different types of machines that may be involved when compiling a package:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">build</strong>: The computer <a id="_idIndexMarker149"/>that builds the package, which defaults to the current machine.</li>
      <li class="bulletList"><strong class="keyWord">host</strong>: The computer <a id="_idIndexMarker150"/>the program will run on. For a native compile, this is left blank and defaults to the same computer as build. When you are cross-compiling, set it to be the tuple of your toolchain.</li>
      <li class="bulletList"><strong class="keyWord">target</strong>: The <a id="_idIndexMarker151"/>computer the program will generate code for. You would set this when building a cross compiler.</li>
    </ul>
    <p class="normal">To cross-compile, you just need to override the host as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">$ CC=aarch64-buildroot-linux-gnu-gcc ./configure --host=aarch64-buildroot-linux-gnu
</code></pre>
    <p class="normal">One final thing to note is that the default install directory is <code class="inlineCode">&lt;sysroot&gt;/usr/local</code>. You would usually install it in <code class="inlineCode">&lt;sysroot&gt;/usr</code> so that the header files and libraries would be picked <a id="_idIndexMarker152"/>up from their default locations.</p>
    <p class="normal">The complete <a id="_idIndexMarker153"/>command to configure a typical Autotools package is as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">$ CC=aarch64-buildroot-linux-gnu-gcc ./configure --host=aarch64-buildroot-linux-gnu --prefix=/usr
</code></pre>
    <p class="normal">Let’s dive deeper into Autotools and use it to cross-compile a popular library.</p>
    <h3 id="_idParaDest-50" class="heading-3"><a id="_idTextAnchor055"/>An example: SQLite</h3>
    <p class="normal">The SQLite library implements a simple relational database and is quite popular on embedded devices.</p>
    <p class="normal">First, begin by <a id="_idIndexMarker154"/>getting a copy of SQLite:</p>
    <pre class="programlisting con"><code class="hljs-con">$ wget http://www.sqlite.org/2023/sqlite-autoconf-3440000.tar.gz
$ tar xf sqlite-autoconf-3440000.tar.gz
$ cd sqlite-autoconf-3440000
</code></pre>
    <p class="normal">Version 3.44.0 of SQLite may no longer be available. If so, then download a more up-to-date version of the source code from the SQLite Download page at <a href="https://www.sqlite.org/download.html."><span class="url">https://www.sqlite.org/download.html.</span></a> Modify the preceding <code class="inlineCode">tar</code> and <code class="inlineCode">cd</code> commands to match <a id="_idIndexMarker155"/>the filename of the new tarball.</p>
    <p class="normal">Next, run the <code class="inlineCode">configure</code> script:</p>
    <pre class="programlisting con"><code class="hljs-con">$ CC=aarch64-buildroot-linux-gnu-gcc ./configure --host=aarch64-buildroot-linux-gnu --prefix=/usr
</code></pre>
    <p class="normal">That seems to work! If it had failed, there would have been error messages printed to the terminal and recorded in <code class="inlineCode">config.log</code>. Note that several makefiles have been created so now you can build it:</p>
    <pre class="programlisting con"><code class="hljs-con">$ make
</code></pre>
    <p class="normal">Finally, you install it into the toolchain directory by setting the make variable, <code class="inlineCode">DESTDIR</code>. If you don’t, it will try to install it into the host computer’s <code class="inlineCode">/usr</code> directory, which is not what you want:</p>
    <pre class="programlisting con"><code class="hljs-con">$ make DESTDIR=$(aarch64-buildroot-linux-gnu-gcc -print-sysroot) install
</code></pre>
    <p class="normal">You may find that the final command fails with a file permissions error because the toolchain is installed in a system directory such as <code class="inlineCode">/opt</code> or <code class="inlineCode">/usr/local</code>. In that case, you will need root permissions when running the installation.</p>
    <p class="normal">After installing, you should find that various files have been added to your toolchain:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">&lt;sysroot&gt;/usr/bin</code>: <code class="inlineCode">sqlite3</code>: A command-line interface for SQLite that you can install and run on the target</li>
      <li class="bulletList"><code class="inlineCode">&lt;sysroot&gt;/usr/lib</code>: <code class="inlineCode">libsqlite3.so.0.8.6</code>, <code class="inlineCode">libsqlite3.so.0</code>, <code class="inlineCode">libsqlite3.so</code>, <code class="inlineCode">libsqlite3.la</code>, <code class="inlineCode">libsqlite3.a</code>: The shared and static libraries</li>
      <li class="bulletList"><code class="inlineCode">&lt;sysroot&gt;/usr/lib/pkgconfig</code>: <code class="inlineCode">sqlite3.pc</code>: The package configuration file, as described in the following section</li>
      <li class="bulletList"><code class="inlineCode">&lt;sysroot&gt;/usr/include</code>: <code class="inlineCode">sqlite3.h</code>, <code class="inlineCode">sqlite3ext.h</code>: The header files</li>
      <li class="bulletList"><code class="inlineCode">&lt;sysroot&gt;/usr/share/man/man1</code>: <code class="inlineCode">sqlite3.1</code>: The manual page</li>
    </ul>
    <p class="normal">Now you can <a id="_idIndexMarker156"/>compile programs that use sqlite3 by adding <code class="inlineCode">-lsqlite3</code> at the link stage:</p>
    <pre class="programlisting con"><code class="hljs-con">$ aarch64-buildroot-linux-gnu-gcc -lsqlite3 sqlite-test.c -o sqlite-test
</code></pre>
    <p class="normal">Here, <code class="inlineCode">sqlite-test.c</code> is a hypothetical program that calls SQLite functions. Since <code class="inlineCode">sqlite3</code> has been installed into the <code class="inlineCode">sysroot</code>, the compiler will find the header and library files without any problem. If they had been installed elsewhere, you would have had to add <code class="inlineCode">-L&lt;lib dir&gt;</code> and <code class="inlineCode">-I&lt;include dir&gt;</code>.</p>
    <p class="normal">Naturally, there will be runtime dependencies as well and you will have to install the appropriate files into the target directory, as described in <a href="Chapter_05.xhtml#_idTextAnchor138"><em class="italic">Chapter 5</em></a>.</p>
    <p class="normal">To cross-compile a library or package, you first need to cross-compile its dependencies. Autotools relies on a utility called <code class="inlineCode">pkg-config</code> to gather vital information about packages cross-compiled by Autotools.</p>
    <h2 id="_idParaDest-51" class="heading-2"><a id="_idTextAnchor056"/>Package configuration</h2>
    <p class="normal">Tracking package dependencies is quite complex. The package configuration utility <code class="inlineCode">pkg-config</code> helps track <a id="_idIndexMarker157"/>which packages are installed and which compile flags each package needs by keeping a database of Autotools packages in <code class="inlineCode">&lt;sysroot&gt;/usr/lib/pkgconfig</code>. For instance, the one for SQLite3 is named <code class="inlineCode">sqlite3.pc</code> and contains essential information needed by other packages that depend on it:</p>
    <pre class="programlisting con"><code class="hljs-con">cat $(aarch64-buildroot-linux-gnu-gcc -print-sysroot)/usr/lib/pkgconfig/sqlite3.pc
# Package Information for pkg-config
prefix=/usr
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include
Name: SQLite
Description: SQL database engine
Version: 3.44.0
Libs: -L${libdir} -lsqlite3
Libs.private: -lm -ldl -lpthread
Cflags: -I${includedir}
</code></pre>
    <p class="normal">You can use <code class="inlineCode">pkg-config</code> to extract information in a form that you can feed straight to <code class="inlineCode">gcc</code>. In the case of a library like <code class="inlineCode">libsqlite3</code>, you want to know the library name (<code class="inlineCode">--libs</code>) and any special C flags <code class="inlineCode">(--cflags</code>):</p>
    <pre class="programlisting con"><code class="hljs-con">$ pkg-config sqlite3 --libs --cflags
Package sqlite3 was not found in the pkg-config search path.
Perhaps you should add the directory containing 'sqlite3.pc' to the PKG_CONFIG_PATH environment variable
No package 'sqlite3' found
</code></pre>
    <p class="normal">Oops! That failed <a id="_idIndexMarker158"/>because it was looking in the host’s <code class="inlineCode">sysroot</code>, and the development package for <code class="inlineCode">libsqlite3</code> has not been installed on the host. You need to point it at the <code class="inlineCode">sysroot</code> of the target toolchain by setting the shell variable <code class="inlineCode">PKG_CONFIG_LIBDIR</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">$ export PKG_CONFIG_LIBDIR=$(aarch64-buildroot-linux-gnu-gcc -print-sysroot)/usr/lib/pkgconfig
$ pkg-config sqlite3 --libs --cflags
-lsqlite3
</code></pre>
    <p class="normal">Now the output is <code class="inlineCode">-lsqlite3</code>. In this case, you knew that already, but generally, you wouldn’t, so this is a valuable technique. The final commands to compile are:</p>
    <pre class="programlisting con"><code class="hljs-con">$ export PKG_CONFIG_LIBDIR=$(aarch64-buildroot-linux-gnu-gcc -print-sysroot)/usr/lib/pkgconfig
$ aarch64-buildroot-linux-gnu-gcc $(pkg-config sqlite3 --cflags --libs) sqlite-test.c -o sqlite-test
</code></pre>
    <p class="normal">Many <code class="inlineCode">configure</code> scripts read the information generated by <code class="inlineCode">pkg-config</code>. This can lead to errors when cross-compiling, as we shall see next.</p>
    <h2 id="_idParaDest-52" class="heading-2"><a id="_idTextAnchor057"/>Problems with cross-compiling</h2>
    <p class="normal"><code class="inlineCode">sqlite3</code> is a well-behaved <a id="_idIndexMarker159"/>package that cross-compiles nicely, but not all packages are the same. Typical pain points include:</p>
    <ul>
      <li class="bulletList">Home-grown build systems for libraries like <code class="inlineCode">zlib</code> that have a <code class="inlineCode">configure</code> script that does not behave like the Autotools <code class="inlineCode">configure</code> described in the previous section</li>
      <li class="bulletList"><code class="inlineCode">configure</code> scripts that read <code class="inlineCode">pkg-config</code> information, headers, and other files from the host disregarding the <code class="inlineCode">--host</code> override</li>
      <li class="bulletList">Scripts that insist on trying to run cross-compiled code</li>
    </ul>
    <p class="normal">Each case requires careful analysis of the error. We can either pass additional parameters to the <code class="inlineCode">configure</code> script to provide the correct information or apply patches to the code to avoid the problem altogether. Bear in mind that a single package can have many dependencies. This is especially true for programs that have a graphical interface or that handle multimedia content. As an example, MPlayer has dependencies on over 100 libraries. It would take weeks of effort to build them all.</p>
    <p class="normal">Therefore, I would not recommend manually cross-compiling components for the target in this way, except when there is no alternative or the number of packages to build is small. </p>
    <p class="normal">A much better approach is to use a build tool such as Buildroot or The Yocto Project or avoid the problem altogether by setting up a native build environment for your target architecture. Now you can see why distributions like Debian are always compiled natively.</p>
    <h2 id="_idParaDest-53" class="heading-2"><a id="_idTextAnchor058"/>CMake</h2>
    <p class="normal">CMake is more <a id="_idIndexMarker160"/>of a meta build system in the sense that it relies on an underlying platform’s native tools to build software. On Windows, CMake can generate project files <a id="_idIndexMarker161"/>for Microsoft Visual Studio, and on macOS, it can generate project files for Xcode. Integrating with the principal IDEs for each of the major platforms is no simple task and explains the success of CMake as the leading cross-platform build system solution. CMake also runs on Linux where it can be used in conjunction with a cross-compiling toolchain of your choice.</p>
    <p class="normal">To configure, build, and install a package for a native Linux OS, run the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cmake .
$ make
$ sudo make install
</code></pre>
    <p class="normal">On Linux, the native build tool is GNU <code class="inlineCode">make</code> so CMake generates makefiles by default for us to build with. Often, we want to perform out-of-source builds so that object files and other build artifacts remain separate from source files.</p>
    <p class="normal">To configure an out-of-source build in a subdirectory named <code class="inlineCode">build</code>, run the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con">$ mkdir build
$ cd build
$ cmake ..
</code></pre>
    <p class="normal">This will generate the makefiles inside a <code class="inlineCode">build</code> subdirectory within the project directory where the <code class="inlineCode">CMakeLists.txt</code> is located. The <code class="inlineCode">CMakeLists.txt</code> file is the CMake equivalent of the <code class="inlineCode">configure</code> script for Autotools-based projects.</p>
    <p class="normal">We can then build the project out of source from inside the <code class="inlineCode">build</code> directory and install the package just as before:</p>
    <pre class="programlisting con"><code class="hljs-con">$ make
$ sudo make install
</code></pre>
    <p class="normal">CMake uses absolute <a id="_idIndexMarker162"/>paths so the <code class="inlineCode">build</code> subdirectory cannot be copied or moved once the makefiles have been generated or any subsequent <code class="inlineCode">make</code> step will likely fail. Note that CMake defaults to installing packages into system directories like <code class="inlineCode">/usr/bin</code>, even for out-of-source builds.</p>
    <p class="normal">To generate the makefiles so that CMake installs the package in the <code class="inlineCode">build</code> subdirectory, replace the previous <code class="inlineCode">cmake</code> command with the following:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cmake .. -D CMAKE_INSTALL_PREFIX=../build
</code></pre>
    <p class="normal">We no longer need to preface <code class="inlineCode">make install</code> with <code class="inlineCode">sudo</code> because we do not need elevated permissions to copy the package files into the <code class="inlineCode">build</code> directory.</p>
    <p class="normal">Similarly, we can use another CMake command-line option to generate makefiles for cross-compilation:</p>
    <pre class="programlisting con"><code class="hljs-con">$ cmake .. -D CMAKE_C_COMPILER="/home/frank/aarch64--glibc--stable-&lt;version&gt;/bin/aarch64-buildroot-linux-gnu-gcc"
</code></pre>
    <p class="normal">But the best practice for cross-compiling with CMake is to create a toolchain file that sets <code class="inlineCode">CMAKE_C_COMPILER</code> and <code class="inlineCode">CMAKE_CXX_COMPILER</code> in addition to other relevant variables for targeting embedded Linux.</p>
    <p class="normal">CMake works best when we design our software in a modular way by enforcing well-defined API boundaries between libraries and components.</p>
    <p class="normal">Here are some key terms that come up time and time again in CMake:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">target</code>: A software component such as a library or executable.</li>
      <li class="bulletList"><code class="inlineCode">properties</code>: The source files, compiler options, and linked libraries needed to build a target.</li>
      <li class="bulletList"><code class="inlineCode">package</code>: A CMake file that configures an external target for building just as if it was defined within your <code class="inlineCode">CMakeLists.txt</code> itself.</li>
    </ul>
    <p class="normal">For example, if we had a CMake-based executable named <code class="inlineCode">dummy</code> that needed to take a dependency <a id="_idIndexMarker163"/>on SQLite, we could define the following <code class="inlineCode">CMakeLists.txt</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">cmake_minimum_required (VERSION 3.0)
project (Dummy)
add_executable(dummy dummy.c)
find_package (SQLite3)
target_include_directories(dummy PRIVATE ${SQLITE3_INCLUDE_DIRS})
target_link_libraries (dummy PRIVATE ${SQLITE3_LIBRARIES})
</code></pre>
    <p class="normal">The <code class="inlineCode">find_package</code> command searches for a package (SQLite3, in this case) and imports it so that the external target can be added as a dependency to the <code class="inlineCode">dummy</code> executable’s list of <code class="inlineCode">target_link_libraries</code> for linking.</p>
    <p class="normal">CMake comes with numerous finders for popular C and C++ packages, including OpenSSL, Boost, and protobuf, making native development much more productive than if we were to use just pure makefiles.</p>
    <p class="normal">The <code class="inlineCode">PRIVATE</code> qualifier prevents details like headers and flags from leaking outside of the <code class="inlineCode">dummy</code> target. Using <code class="inlineCode">PRIVATE</code> makes more sense when the target being built is a library instead of an executable. Think of targets as modules and attempt to minimize their exposed surface areas when using CMake to define your own targets. Only employ the <code class="inlineCode">PUBLIC</code> qualifier when absolutely necessary and utilize the <code class="inlineCode">INTERFACE</code> qualifier for header-only libraries.</p>
    <p class="normal">Model your application as a dependency graph with edges between targets. This graph should not only include the libraries that your application links to directly but any transitive dependencies as well. For best results, remove any cycles or other unnecessary independencies seen in the graph. It is often best to perform this exercise before you start coding. A little planning can make the difference between a clean, easily maintainable <code class="inlineCode">CMakeLists.txt</code> and an inscrutable mess that nobody wants to touch.</p>
    <h1 id="_idParaDest-54" class="heading-1"><a id="_idTextAnchor059"/>Summary</h1>
    <p class="normal">The toolchain is always your starting point. Everything that follows from that is dependent on having a working, reliable toolchain.</p>
    <p class="normal">You may start with nothing but a toolchain downloaded from Bootlin or Linaro and use it to compile all the packages that you need on your target. Or you may obtain the toolchain as part of a distribution generated from source code using a build system such as Buildroot or The Yocto Project.</p>
    <p class="normal">Beware of toolchains or distributions that are offered to you for free as part of a hardware package. They are often poorly configured and not maintained.</p>
    <p class="normal">Once you have a toolchain, you can use it to build the other components of your embedded Linux system. In the next chapter, you will learn about the bootloader, which brings your device to life and begins the boot process. We will use the toolchain we built in this chapter to build a working bootloader for the BeaglePlay.</p>
    <h1 id="_idParaDest-55" class="heading-1"><a id="_idTextAnchor060"/>Further study</h1>
    <ul>
      <li class="bulletList"><em class="italic">Toolchain Options in 2023: What’s new in compilers and libcs?</em> by Bernhard “Bero” Rosenkränzer – <a href="https://www.youtube.com/watch?v=Vgm3GJ2ItDA"><span class="url">https://www.youtube.com/watch?v=Vgm3GJ2ItDA</span></a></li>
      <li class="bulletList"><em class="italic">Modern CMake for modular design</em>, by Mathieu Ropert – <a href="https://www.youtube.com/watch?v=eC9-iRN2b04"><span class="url">https://www.youtube.com/watch?v=eC9-iRN2b04</span></a></li>
    </ul>
  </div>
</div></div></body></html>