<html><head></head><body>
<div id="_idContainer032">
<h1 class="chapter-number" id="_idParaDest-43"><a id="_idTextAnchor071"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-44"><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.2.1">Meeting the BitBake Tool</span></h1>
<p><span class="koboSpan" id="kobo.3.1">With this chapter, we will now begin our journey of learning how the Yocto Project’s engine works behind the scenes. </span><span class="koboSpan" id="kobo.3.2">As is the case with every journey, communication is critical, so we need to understand the language used by the Yocto Project’s tools and learn how to get the best out of these tools to accomplish </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">our goals.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">The preceding chapters introduced us to the standard Yocto Project workflow for creating and emulating images. </span><span class="koboSpan" id="kobo.5.2">Now, in this chapter, we will explore the concept of metadata and how BitBake reads this metadata to make its internal </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">data collections.</span></span></p>
<h1 id="_idParaDest-45"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.7.1">Understanding the BitBake tool</span></h1>
<p><span class="koboSpan" id="kobo.8.1">The BitBake task scheduler started as a fork from Portage, the package management system used in the </span><a id="_idIndexMarker082"/><span class="koboSpan" id="kobo.9.1">Gentoo distribution. </span><span class="koboSpan" id="kobo.9.2">However, the two projects diverged significantly due to different use cases. </span><span class="koboSpan" id="kobo.9.3">The Yocto Project and the OpenEmbedded Project are intensive users of BitBake. </span><span class="koboSpan" id="kobo.9.4">It remains a separate and independent project with its own development cycle and mailing </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">list (</span></span><a href="mailto:bitbake-devel@lists.openembedded.org"><span class="No-Break"><span class="koboSpan" id="kobo.11.1">bitbake-devel@lists.openembedded.org</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.12.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">BitBake is a tool similar to GNU Make. </span><span class="koboSpan" id="kobo.13.2">As discussed in </span><a href="B19361_01.xhtml#_idTextAnchor013"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.14.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.15.1">, </span><em class="italic"><span class="koboSpan" id="kobo.16.1">Meeting the Yocto Project</span></em><span class="koboSpan" id="kobo.17.1">, BitBake is a task executor and scheduler that parses Python and Shell Script </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">mixed code.</span></span></p>
<p><span class="koboSpan" id="kobo.19.1">Therefore, BitBake is responsible for running as many tasks as possible in parallel while ensuring they are run respecting </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">their dependencies.</span></span></p>
<h1 id="_idParaDest-46"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.21.1">BitBake metadata collections</span></h1>
<p><span class="koboSpan" id="kobo.22.1">For BitBake, there is </span><a id="_idIndexMarker083"/><span class="koboSpan" id="kobo.23.1">no metadata outside a metadata </span><a id="_idIndexMarker084"/><span class="koboSpan" id="kobo.24.1">collection. </span><span class="koboSpan" id="kobo.24.2">Instead, a metadata collection has a unique name, and the common term the Yocto Project uses for those collections </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">is </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.26.1">Layer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">.</span></span></p>
<p><a href="B19361_01.xhtml#_idTextAnchor013"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.28.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.29.1">, </span><em class="italic"><span class="koboSpan" id="kobo.30.1">Meeting the Yocto Project</span></em><span class="koboSpan" id="kobo.31.1">, explains that we have the </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">following layers:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.33.1">OpenEmbedded Core</span></strong><span class="koboSpan" id="kobo.34.1">: This is </span><a id="_idIndexMarker085"/><span class="koboSpan" id="kobo.35.1">inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.36.1">meta</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.37.1"> directory</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.38.1">Poky distribution</span></strong><span class="koboSpan" id="kobo.39.1">: This is inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">meta-poky</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.41.1"> directory</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.42.1">Yocto Project reference BSP</span></strong><span class="koboSpan" id="kobo.43.1">: This is inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">meta-yocto-bsp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.45.1"> directory</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.46.1">The preceding list describes real examples of layers. </span><span class="koboSpan" id="kobo.46.2">Every layer contains a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.47.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.48.1">. </span><span class="koboSpan" id="kobo.48.2">This file </span><a id="_idIndexMarker086"/><span class="koboSpan" id="kobo.49.1">defines several layer properties, such as </span><a id="_idIndexMarker087"/><span class="koboSpan" id="kobo.50.1">the collection name and priority. </span><span class="koboSpan" id="kobo.50.2">The following figure shows the </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.52.1"> file for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">meta-poky</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.54.1"> layer:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer030">
<span class="koboSpan" id="kobo.55.1"><img alt="Figure 4.1 – The conf/layer.conf file for the meta-poky layer" src="image/Figure_4.1_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.56.1">Figure 4.1 – The conf/layer.conf file for the meta-poky layer</span></p>
<p><span class="koboSpan" id="kobo.57.1">The preceding example is relatively simple but serves as a base for us to illustrate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">conf/layer.conf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.59.1">file principles.</span></span></p>
<p><span class="koboSpan" id="kobo.60.1">In line 8, </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">BBFILE_COLLECTIONS</span></strong><span class="koboSpan" id="kobo.62.1">, we tell BitBake to create a new metadata collection called </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">yocto</span></strong><span class="koboSpan" id="kobo.64.1">. </span><span class="koboSpan" id="kobo.64.2">Next, in line 9, </span><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">BBFILE_PATTERN_yocto</span></strong><span class="koboSpan" id="kobo.66.1">, we define the rule to match all paths starting with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.67.1">LAYERDIR</span></strong><span class="koboSpan" id="kobo.68.1"> variable to identify the metadata belonging to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">yocto</span></strong><span class="koboSpan" id="kobo.70.1"> collection. </span><span class="koboSpan" id="kobo.70.2">Finally, in line 10, </span><strong class="source-inline"><span class="koboSpan" id="kobo.71.1">BBFILE_PRIORITY_yocto</span></strong><span class="koboSpan" id="kobo.72.1"> establishes the priority (the higher the number, the higher the priority) of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.73.1">yocto</span></strong><span class="koboSpan" id="kobo.74.1"> collection against the other </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">metadata collections.</span></span></p>
<p><span class="koboSpan" id="kobo.76.1">The dependency relation between the layers is vital as it ensures that all required metadata is available </span><a id="_idIndexMarker088"/><span class="koboSpan" id="kobo.77.1">for use. </span><span class="koboSpan" id="kobo.77.2">An example is in line 18 as </span><strong class="source-inline"><span class="koboSpan" id="kobo.78.1">LAYERDEPENDS_yocto</span></strong><span class="koboSpan" id="kobo.79.1">, from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.81.1"> file, adds a dependency to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">core</span></strong><span class="koboSpan" id="kobo.83.1">, provided by the OpenEmbedded </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">Core layer.</span></span></p>
<p><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.85.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.86.1">.2</span></em><span class="koboSpan" id="kobo.87.1"> shows Poky’s layers using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">bitbake-layers</span></strong><span class="koboSpan" id="kobo.89.1"> command, </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer031">
<span class="koboSpan" id="kobo.91.1"><img alt="Figure 4.2 – Results of bitbake-layers show-layers for Poky" src="image/Figure_4.2_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.92.1">Figure 4.2 – Results of bitbake-layers show-layers for Poky</span></p>
<h1 id="_idParaDest-47"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.93.1">Metadata types</span></h1>
<p><span class="koboSpan" id="kobo.94.1">There are three </span><a id="_idIndexMarker089"/><span class="koboSpan" id="kobo.95.1">major areas where we can classify the metadata used by BitBake. </span><span class="koboSpan" id="kobo.95.2">They are </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.97.1">Configuration (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.100.1"> files)</span></span></li>
<li><span class="koboSpan" id="kobo.101.1">Classes (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">bbclass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.104.1"> files)</span></span></li>
<li><span class="koboSpan" id="kobo.105.1">Recipes (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">.bb</span></strong><span class="koboSpan" id="kobo.107.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">bbappend</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.110.1"> files)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.111.1">The configuration files define the global content to provide information and configure how the recipes work. </span><span class="koboSpan" id="kobo.111.2">One typical example of a configuration file is the machine file, which has a list of settings that describes </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">the hardware.</span></span></p>
<p><span class="koboSpan" id="kobo.113.1">The whole system uses the classes that recipes can </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">inherit</span></strong><span class="koboSpan" id="kobo.115.1"> according to their needs or by default. </span><span class="koboSpan" id="kobo.115.2">They define the commonly used system’s behavior and provide the base methods. </span><span class="koboSpan" id="kobo.115.3">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">kernel.bbclass</span></strong><span class="koboSpan" id="kobo.117.1"> abstracts tasks related to building and packaging the Linux kernel independently of version or </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">vendor changes.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.119.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.120.1">The recipes and classes mix Python and Shell </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">Script code.</span></span></p>
<p><span class="koboSpan" id="kobo.122.1">The classes and recipes describe the tasks to be run and provide the information needed to allow BitBake to generate the required task list and its dependencies. </span><span class="koboSpan" id="kobo.122.2">The inheritance mechanism permits a recipe to inherit one or more classes to promote code reuse, improve accuracy, and make maintenance easier. </span><span class="koboSpan" id="kobo.122.3">A Linux kernel recipe example is </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">linux-yocto_5.15.bb</span></strong><span class="koboSpan" id="kobo.124.1">, which inherits a set of classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">including </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">kernel.bbclass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">BitBake’s most commonly used aspects across all types of metadata (</span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">.conf</span></strong><span class="koboSpan" id="kobo.130.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">.bb</span></strong><span class="koboSpan" id="kobo.132.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">.bbclass</span></strong><span class="koboSpan" id="kobo.134.1">) are covered in </span><a href="B19361_05.xhtml#_idTextAnchor077"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.135.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.136.1">, </span><em class="italic"><span class="koboSpan" id="kobo.137.1">Grasping the BitBake Tool</span></em><span class="koboSpan" id="kobo.138.1">, while the metadata grammar and syntax are detailed in </span><a href="B19361_08.xhtml#_idTextAnchor110"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.139.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.140.1">, </span><em class="italic"><span class="koboSpan" id="kobo.141.1">Diving into </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.142.1">BitBake Metadata</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.144.1">Taking </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.145.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.146.1">.1</span></em><span class="koboSpan" id="kobo.147.1"> into </span><a id="_idIndexMarker090"/><span class="koboSpan" id="kobo.148.1">consideration, we need to pay attention to two other variables – </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">BBPATH</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.150.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">BBFILES</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">BBPATH</span></strong><span class="koboSpan" id="kobo.154.1">, on line 2, is analogous to </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">PATH</span></strong><span class="koboSpan" id="kobo.156.1"> but adds a directory to the search list for metadata files; the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">BBFILES</span></strong><span class="koboSpan" id="kobo.158.1"> variable, on line 5, lists the pattern used to index the collection </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">recipe files.</span></span></p>
<h1 id="_idParaDest-48"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.160.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.161.1">In this chapter, we learned about metadata, metadata collection concepts, and the importance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.163.1">, which are the base for the understanding of the Yocto Project. </span><span class="koboSpan" id="kobo.163.2">In the next chapter, we will examine metadata knowledge, understand how recipes depend on each other, and how BitBake deals with dependencies. </span><span class="koboSpan" id="kobo.163.3">Additionally, we will also get a better view of the tasks managed by BitBake, download all the required source code, build and generate packages, and see how these packages fit into </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">generated images.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer033">
</div>
</div>
</body></html>