- en: 21\. Creating KVM Virtual Machines using Cockpit and virt-manager
  prefs: []
  type: TYPE_NORMAL
- en: KVM-based virtual machines can easily be configured on CentOS 8 using either
    the virt-install command-line tool, the virt-manager GUI tool or the Virtual Machines
    module of the Cockpit web console. For the purposes of this chapter we will use
    Cockpit and the virt-manager tool to install a Fedora distribution as a KVM guest
    on a CentOS 8 host. Before proceeding, however, it is important to note that virt-manager
    is now deprecated in CentOS 8 with the intention that it will be fully replaced
    by the Cockpit module in the future. As of CentOS 8, however, virt-manager is
    still available and includes features not yet integrated into the Cockpit virtual
    machine module.
  prefs: []
  type: TYPE_NORMAL
- en: The command-line approach to virtual machine creation will be covered in the
    next chapter entitled [“Creating KVM Virtual Machines with virt-install and virsh”](../Text/KVM_Create_VM_Command-line.xhtml#_idTextAnchor278).
  prefs: []
  type: TYPE_NORMAL
- en: 21.1 Installing the Cockpit Virtual Machines Module
  prefs: []
  type: TYPE_NORMAL
- en: 'By default, the virtual machines module is not included in a standard Cockpit
    installation. Assuming that Cockpit is installed and configured, the virtual machines
    module may be installed as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: dnf install cockpit-machines
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Once installed, the Virtual Machines option (marked A in [Figure 21-1](../Text/KVM_Create_VM.xhtml#_idTextAnchor265))
    will appear in the navigation panel next time you log into the Cockpit interface:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/centos_8_cockpit_virtual_machines.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-1
  prefs: []
  type: TYPE_NORMAL
- en: 21.2 Creating a Virtual Machine in Cockpit
  prefs: []
  type: TYPE_NORMAL
- en: To create a virtual machine in Cockpit, simply click on the Create VM button
    marked B in [Figure 22-1](../Text/KVM_Create_VM_Command-line.xhtml#_idTextAnchor281)
    to display the creation dialog.
  prefs: []
  type: TYPE_NORMAL
- en: Within the dialog, enter a name for the machine and choose whether the installation
    media is in the form of an ISO accessible via a URL or a local filesystem path.
    Ideally, also select the vendor and operating system type information for the
    guest. While not essential, this will aid the system in optimizing the virtual
    machine for the guest.
  prefs: []
  type: TYPE_NORMAL
- en: 'Also specify the size of the virtual disk drive to be used for the operating
    system installation and the amount of memory to be allocated to the virtual machine:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/centos_8_cockpit_create_virtual_machine.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-2
  prefs: []
  type: TYPE_NORMAL
- en: 'For this example, leave the Immediately Start VM option unselected and, once
    the new virtual machine has been configured, click on the Create button to build
    the virtual machine. After the creation process is complete, the new VM will appear
    in Cockpit as shown in [Figure 21-3](../Text/KVM_Create_VM.xhtml#_idTextAnchor268):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/centos_8_cockpit_vm_ready_to_install.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-3
  prefs: []
  type: TYPE_NORMAL
- en: 'As described in [“An Overview of Virtualization Techniques”](../Text/Virtualization_Overview.xhtml#_idTextAnchor248),
    KVM provides virtual machines with a number of options in terms of network configuration.
    To view and change the network settings of a virtual machine, click on the Networks
    tab as shown in [Figure 21-4](../Text/KVM_Create_VM.xhtml#_idTextAnchor269) followed
    by the Edit button located next to the network entry:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/centos_8_cockpit_vm_network_configuration.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-4
  prefs: []
  type: TYPE_NORMAL
- en: In the resulting dialog, the Network Type menu may be used to change the type
    of network connection, for example from virtual network (NAT) to direct connection
    (MacVTap).
  prefs: []
  type: TYPE_NORMAL
- en: 21.3 Starting the Installation
  prefs: []
  type: TYPE_NORMAL
- en: 'To start the new virtual machine and begin installing the guest operating system
    from the designated installation media, click on the Install button highlighted
    in [Figure 21-3](../Text/KVM_Create_VM.xhtml#_idTextAnchor268) above. Cockpit
    will start the virtual machine and switch to the Consoles view where the guest
    OS screen will appear:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_cockpit_vm_console.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-5
  prefs: []
  type: TYPE_NORMAL
- en: 'If the installation fails, check the message to see if it reads as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Could not open ‘<path to iso image>’: Permission denied'
  prefs: []
  type: TYPE_NORMAL
- en: Domain installation does not appear to have been successful.
  prefs: []
  type: TYPE_NORMAL
- en: 'This usually occurs because the QEMU emulator runs as a user named qemu which
    does not have access to the directory in which the ISO installation image is located.
    To resolve this issue, change directory to the location of the ISO image file
    and add the qemu user to the access control list (ACL) of the parent directory
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: cd /path/to/iso/directory
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: setfacl --modify u:qemu:x ..
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'After making this change, check the setting as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: getfacl ..
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'file: ..'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'owner: demo'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'group: demo'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: user::rwx
  prefs: []
  type: TYPE_NORMAL
- en: user:qemu:--x
  prefs: []
  type: TYPE_NORMAL
- en: group::---
  prefs: []
  type: TYPE_NORMAL
- en: mask::--x
  prefs: []
  type: TYPE_NORMAL
- en: other::---
  prefs: []
  type: TYPE_NORMAL
- en: Once these changes have been made, click on the Install button once again to
    complete the installation.
  prefs: []
  type: TYPE_NORMAL
- en: To complete the installation, interact with the screen in the Consoles view
    just as you would if you were installing the operating system on physical hardware.
  prefs: []
  type: TYPE_NORMAL
- en: 'It is also possible to connect with and display the graphical console for the
    VM from outside the Cockpit browser session using the virt-viewer tool. To install
    virt-viewer on a CentOS 8 system, run the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: dnf install virt-viewer
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The virt-viewer tool is also available for Windows systems and can be downloaded
    from the following URL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[https://virt-manager.org/download/](https://virt-manager.org/download/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'To connect with a virtual machine running on the local host, simply run virt-viewer
    and select the virtual machine to which you wish to connect from the resulting
    dialog:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-viewer-select_vm.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-6
  prefs: []
  type: TYPE_NORMAL
- en: 'Alternatively, it is also possible to specify the virtual machine name and
    bypass the selection dialog, for example:'
  prefs: []
  type: TYPE_NORMAL
- en: virt-viewer myFedoraGuest
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To connect a virt-viewer instance to a virtual machine running on a remote
    host using SSH, the following command can be used:'
  prefs: []
  type: TYPE_NORMAL
- en: $ virt-viewer --connect qemu+ssh://<user>@<host>/system <guest name>
  prefs: []
  type: TYPE_NORMAL
- en: 'For example:'
  prefs: []
  type: TYPE_NORMAL
- en: $ virt-viewer --connect qemu+ssh://root@192.168.1.122/system MyFedoraGuest
  prefs: []
  type: TYPE_NORMAL
- en: When using this technique it is important to note that you will be prompted
    twice for the user password before the connection will be fully established.
  prefs: []
  type: TYPE_NORMAL
- en: Once the virtual machine has been created, the Cockpit interface can be used
    to monitor the machine and perform tasks such as rebooting, shutting down or deleting
    the guest system. An option is also included on the Disks panel to add additional
    disks to the virtual machine configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 21.4 Creating a Virtual Machine using virt-manager
  prefs: []
  type: TYPE_NORMAL
- en: With the caveat that virt-manager is now deprecated and will be removed once
    the Virtual Machines Cockpit extension is fully implemented, the remainder of
    this chapter will explore the use of this tool to create new virtual machines.
  prefs: []
  type: TYPE_NORMAL
- en: 21.5 Starting the Virtual Machine Manager
  prefs: []
  type: TYPE_NORMAL
- en: 'Begin by launching Virtual Machine Manager from the command-line in a terminal
    window by running virt-manager. Once loaded, the virtual machine manager will
    prompt for the password of the currently active user prior to displaying the following
    screen:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_main.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-7
  prefs: []
  type: TYPE_NORMAL
- en: The main screen lists the current virtual machines running on the system. At
    this point there should only be one, the hypervisor running on the host system.
    By default the manager should be connected to the host. If it is not, connect
    to the host system by right-clicking on the entry in the list and selecting Connect
    from the popup menu.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a new virtual system, click on the new virtual machine button (the
    far left button on the toolbar) or right-click on the hypervisor entry and select
    New from the resulting menu to display the first screen of the New VM wizard.
    In the Name field enter a suitably descriptive name for the virtual system. On
    this screen, also select the location of the media from which the guest operating
    system will be installed. This can either be a CD or DVD drive, an ISO image file
    accessible to the local host, a network install using HTTP, FTP, NFS or PXE or
    the disk image from an existing virtual machine:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_create_vm.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-8
  prefs: []
  type: TYPE_NORMAL
- en: 21.6 Configuring the KVM Virtual System
  prefs: []
  type: TYPE_NORMAL
- en: 'Clicking Forward will display a screen seeking additional information about
    the installation process. The screen displayed and information required will depend
    on selections made in the preceding screen. For example, if a CD, DVD or ISO was
    selected, this screen will ask for the specific location of the ISO file or physical
    media device. This screen also attempts to identify the type and version of the
    guest operating system to be installed (for example the Windows version or Linux
    distribution) based on the installation media specified. If it is unable to do
    so, uncheck the Automatically detect from installation media / source option,
    type in the first few character of the operating system name and select an option
    from the list of possible matches:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_select_os.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-9
  prefs: []
  type: TYPE_NORMAL
- en: 'Once these settings are complete, click the Forward button to configure CPU
    and memory settings. The optimal settings will depend on the number of CPUs and
    amount of physical memory present in the host together with the requirements of
    other applications and virtual machines that will run in parallel with the new
    virtual machine:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_virt-manager_new_vm_memory.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-10
  prefs: []
  type: TYPE_NORMAL
- en: The last item to configure before creating the virtual machine is the storage
    space for the guest operating system and corresponding user data. This takes the
    form of a virtual disk image or pre-existing storage. A virtual disk drive is
    essentially an image file located on the file system of the host computer which
    is seen by the virtual machine as a physical disk drive.
  prefs: []
  type: TYPE_NORMAL
- en: 'Options are available to create an image disk of a specified size, select a
    pre-existing volume or to create a storage volume of a specified format (raw,
    vmdk, ISO etc). Unless you have a specific need to use a particular format (for
    example you might need to use vmdk to migrate to a VMware based virtualization
    environment at a later date) or need to use a dedicated disk or partition, it
    is generally adequate to simply specify a size on this screen:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_vm_storage.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-11
  prefs: []
  type: TYPE_NORMAL
- en: 'Once these settings are configured, click the Forward button once more. The
    final screen displays a summary of the configuration. Review the information displayed.
    Advanced options are also available to change the virtual network configuration
    for the guest as shown in [Figure 21-12](../Text/KVM_Create_VM.xhtml#_idTextAnchor274):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/centos_8_cockpit_vm_network_macvtap.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-12
  prefs: []
  type: TYPE_NORMAL
- en: 21.7 Starting the KVM Virtual Machine
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on the Finish button to begin the creation process. The virtualization
    manager will create the disk and configure the virtual machine before starting
    the guest system. The new virtual machine will appear in the main virt-manager
    window with the status set to Running as illustrated in [Figure 21-13](../Text/KVM_Create_VM.xhtml#_idTextAnchor276):'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_vm_running.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-13
  prefs: []
  type: TYPE_NORMAL
- en: 'By default, the console for the virtual machine should appear in the virtual
    machine viewer window. To view the console of the running machine at any future
    time, ensure that it is selected in the virtual machine list and select the Open
    button from the toolbar. The virtual machine viewer should be ready for the installation
    process to begin:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/rhel_8_virt-manager_viewer.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 21-14
  prefs: []
  type: TYPE_NORMAL
- en: From this point on, simply follow the operating system installation instructions
    to install the guest OS in the KVM virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: 21.8 Summary
  prefs: []
  type: TYPE_NORMAL
- en: This chapter has outlined two different ways to create new KVM-based virtual
    machines on a CentOS 8 host system. The first option covered involves the use
    of the Cockpit web-based interface to create and manage virtual machines. This
    has the advantage of not requiring access to a desktop environment running on
    the host system. An alternative option is to use the virt-manager graphical tool.
    Though deprecated in CentOS 8 and likely to be removed in later releases, virt-manager
    currently provides options not currently available in the Cockpit Virtual Machines
    extension. At the point that virt-manager is removed it is expected that Cockpit
    will provide equal or better functionality.
  prefs: []
  type: TYPE_NORMAL
- en: With these basics covered, the next chapter will cover the creation of virtual
    machines from the command-line.
  prefs: []
  type: TYPE_NORMAL
