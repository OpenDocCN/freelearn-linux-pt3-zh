# 序言

Linux 多年来一直是嵌入式计算的主力军。然而，关于这一主题的书籍却少之又少：本书旨在填补这一空白。嵌入式 Linux 这个术语定义不明确，可以应用于各种设备中的操作系统，从恒温器、Wi-Fi 路由器到工业控制单元。然而，它们都是建立在相同的基本开源软件之上。这些技术就是本书所描述的内容，基于我作为工程师的经验。

技术发展永不停歇。围绕嵌入式计算的行业和主流计算一样，受摩尔定律的影响。这意味着指数级增长，自本书第一版出版以来，令人惊讶的许多事物发生了变化。本书第四版已经全面修订，采用了最新版本的主要开源组件，包括 Linux 6.6、Yocto 项目 5.0 Scarthgap 和 Buildroot 2024.02 LTS。除了 Autotools，本书现在还涵盖了 CMake，这是一种近年来被广泛采用的现代构建系统。

# 本书适用对象

本书面向有兴趣深入了解嵌入式计算和 Linux 的开发者，旨在扩展他们对该主题各个分支的知识。在写作本书时，我假设读者对 Linux 命令行有基本的了解，且在编程示例中具备 C 和 Python 语言的工作知识。若读者熟悉硬件及硬件接口，将在一些章节中占据优势，因为几个章节重点讲解了嵌入式目标板所涉及的硬件。

# 本书内容

*第一章*，*入门*，通过描述嵌入式 Linux 生态系统以及你在开始项目时可以选择的选项来为你定下基调。

*第二章*，*了解工具链*，介绍了工具链的组成部分以及如何为目标板获取用于交叉编译代码的工具链。

*第三章*，*关于引导加载程序的一切*，解释了引导加载程序在将 Linux 内核加载到内存中的作用，并以 U-Boot 为例。它还介绍了设备树，作为编码几乎所有嵌入式 Linux 系统硬件细节的机制。

*第四章*，*配置和构建内核*，提供了如何为嵌入式系统选择 Linux 内核并根据设备硬件配置它的信息。还涵盖了如何将 Linux 移植到新硬件上。

*第五章*，*构建根文件系统*，通过逐步指导如何配置根文件系统，介绍了嵌入式 Linux 实现中用户空间部分的概念。

*第六章*，*选择构建系统*，介绍了两种常用的嵌入式 Linux 构建系统，Buildroot 和 The Yocto Project，它们自动化了前四章中描述的步骤。

*第七章*，*使用 Yocto 开发*，展示了如何在现有 BSP 层之上构建系统映像，如何使用 Yocto 的可扩展 SDK 开发板载软件包，并构建自己的嵌入式 Linux 发行版，配备运行时包管理。

*第八章*，*Yocto 背后的秘密*，是对 Yocto 构建工作流和架构的介绍，包括解释 Yocto 独特的多层方法。它还通过实际的配方文件示例，讲解了 BitBake 语法和语义的基础。

*第九章*，*创建存储策略*，讨论了管理闪存时面临的挑战，包括原始闪存芯片和**嵌入式 MMC**（**eMMC**）包。它描述了适用于每种技术的文件系统。

*第十章*，*现场软件更新*，检查了设备部署后更新软件的各种方式，并包括完全管理的**空中下载**（**OTA**）更新。讨论的关键主题是可靠性和安全性。

*第十一章*，*与设备驱动程序接口*，描述了内核设备驱动程序如何通过实现简单的驱动程序与硬件进行交互。它还描述了从用户空间调用设备驱动程序的各种方式。

*第十二章*，*使用附加板进行原型设计*，演示了如何使用预构建的 Debian 镜像和 MikroElektronika 外围附加板，快速进行硬件和软件的原型设计。

*第十三章*，*启动——init 程序*，解释了第一个用户空间程序`init`如何启动其余的系统。它描述了三种不同版本的`init`程序，每种适用于不同类型的嵌入式系统，从简单的 BusyBox `init` 到 System V `init`，再到当前的先进技术`systemd`。

*第十四章*，*电源管理*，考虑了 Linux 可以如何调优以减少功耗，包括动态频率和电压调整、选择更深的空闲状态和系统挂起。其目的是让设备在电池充电后使用更长时间，同时运行得更凉爽。

*第十五章*，*打包 Python*，解释了将 Python 模块捆绑在一起以便部署的各种选择，并阐述了何时使用一种方法而非另一种方法。内容涵盖了`pip`、虚拟环境和`conda`。

*第十六章*，*部署容器镜像*，介绍了 DevOps 运动的原则，并展示了如何将这些原则应用于嵌入式 Linux。首先，我们使用 Docker 将一个 Python 应用程序及其用户空间环境打包到容器镜像中。然后，我们使用 GitHub Actions 为我们的容器镜像设置 CI/CD 管道。最后，我们使用 Docker 在 Raspberry Pi 4 上执行容器化的软件更新。

*第十七章*，*学习进程和线程*，从应用程序程序员的角度描述了嵌入式系统。本章讨论了进程和线程、进程间通信以及调度策略。

*第十八章*，*内存管理*，研究了虚拟内存背后的概念以及如何将地址空间划分为内存映射。它还描述了如何准确测量内存使用情况以及如何检测内存泄漏。

*第十九章*，*使用 GDB 进行调试*，向您展示如何结合 GNU 调试器 GDB 和调试代理`gdbserver`，调试在目标设备上远程运行的应用程序。接着，本章展示了如何扩展该模型以调试内核代码，利用内核调试存根 KGDB。

*第二十章*，*性能分析与追踪*，介绍了可用的系统性能测量技术，从整体系统概况开始，然后集中分析导致性能瓶颈的特定区域。本章还描述了如何使用 Valgrind 检查应用程序在线程同步和内存分配方面的正确性。

*第二十一章*，*实时编程*，提供了一个详细的实时编程指南，讲解如何在 Linux 上使用最近合并的`PREEMPT_RT`实时内核补丁进行实时编程。

# 最大化本书的学习效果

本书中使用的软件完全是开源的。在几乎所有情况下，我使用的是写作时可用的最新稳定版本。虽然我尽力以非版本特定的方式描述主要特性，但不可避免地，某些示例需要适配才能在后续软件版本中工作。以下是本书中使用的主要硬件和软件：

+   QEMU（64 位 Arm）

+   Raspberry Pi 4

+   BeaglePlay

+   Yocto 项目 5.0 Scarthgap

+   Buildroot 2024.02

+   Bootlin aarch64 glibc 稳定工具链 2024.02-1

+   Arm GNU AArch32 裸机目标（arm-none-eabi）工具链 13.2.Rel1

+   U-Boot v2024.04

+   Linux 内核 6.6

嵌入式开发涉及两个系统：主机系统用于开发程序，目标系统用于运行这些程序。对于主机系统，我选择了 Ubuntu 24.04 LTS，因为它广泛使用且有长期的维护保障。你也可以选择在 Docker、虚拟机或 Windows Subsystem for Linux 上运行 Linux，但要注意，有些任务，如使用 Yocto 项目构建分发版，比较复杂，最好在 Linux 的原生安装环境中运行。

对于目标设备，我选择了 QEMU 模拟器、Raspberry Pi 4 和 BeaglePlay。使用 QEMU 意味着你可以在不额外投资硬件的情况下尝试大部分示例。另一方面，某些事情在真实硬件上运行得更好。为此，我选择了 Raspberry Pi 4，因为它价格低廉、普及度高，并且有很好的社区支持。BeaglePlay 取代了本书早期版本中的 BeagleBone Black。当然，你并不仅仅局限于这三种目标设备。本书的核心思想是为你提供一般性的问题解决方案，使你能够将其应用于多种目标开发板。

## 下载示例代码文件

本书的代码包托管在 GitHub 上，网址是：[`github.com/PacktPublishing/Mastering-Embedded-Linux-Development`](https://github.com/PacktPublishing/Mastering-Embedded-Linux-Development)。我们还有其他书籍和视频的代码包，全部可以在[`github.com/PacktPublishing`](https://github.com/PacktPublishing)找到。快去看看吧！

## 下载彩色图像

我们还提供了一个 PDF 文件，里面包含了本书中使用的截图/图表的彩色图像。你可以在这里下载：[`packt.link/gbp/9781803232591`](https://packt.link/gbp/9781803232591)。

## 使用的约定

本书中使用了许多文本约定。

`CodeInText`：表示文本中的代码词汇、数据库表名、文件夹名称、文件名、文件扩展名、路径名、虚拟网址、用户输入和 Twitter 用户名。例如：“执行`make menuconfig`命令：”

代码块如下所示：

```
require recipes-core/images/core-image-minimal.bb
IMAGE_INSTALL:append = " helloworld strace" 
```

所有命令行输入或输出都按照以下方式书写：

```
$ bitbake -c populate_sdk nova-image 
```

**粗体**：表示新术语、重要单词或屏幕上出现的词汇。例如，菜单或对话框中的单词会像这样出现在文本中。例如：“退出**外部工具链**，并打开**工具链**子菜单。”

警告或重要提示以这样的方式出现。

提示和技巧以这样的方式出现。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：请通过电子邮件发送到`feedback@packtpub.com`，并在邮件主题中提及书名。如果你有任何关于本书的疑问，请通过电子邮件联系我们，邮箱地址是`questions@packtpub.com`。

**勘误**：虽然我们已尽一切努力确保内容的准确性，但错误仍然可能发生。如果你在本书中发现了错误，我们将非常感激你向我们报告。请访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，点击**提交勘误**并填写表单。

**盗版**：如果你在互联网上遇到我们作品的任何非法副本，我们将非常感激你提供该副本的网址或网站名称。请通过`copyright@packtpub.com`联系我们，并提供该材料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专长并且有兴趣写书或为书籍贡献内容，请访问[`authors.packtpub.com/`](http://authors.packtpub.com/)。

# 分享你的想法

一旦你阅读完*《掌握嵌入式 Linux 开发，第 4 版》*，我们很想听听你的想法！请[点击这里直接进入亚马逊评论页面](https://packt.link/r/1803232595)分享你的反馈。

你的评价对我们和技术社区都非常重要，将帮助我们确保提供高质量的内容。

# 下载本书的免费 PDF 副本

感谢购买本书！

你喜欢在移动中阅读，但又无法随身携带纸质书籍吗？

你的电子书购买是否与所选设备不兼容？

不用担心，现在每本 Packt 书籍都附赠免费的无 DRM PDF 版本。

随时随地、任何设备上阅读。直接从你最喜爱的技术书籍中搜索、复制并粘贴代码到你的应用程序中。

好处还不止这些，你还可以获得独家折扣、新闻通讯以及每天通过邮件获得的优质免费内容。

按照以下简单步骤获得福利：

1.  扫描二维码或访问以下链接：

![`packt.link/free-ebook/9781801819299`](img/B18466_Free_PDF_QR.jpg)

[`packt.link/free-ebook/9781803232591`](https://packt.link/free-ebook/9781803232591)

1.  提交你的购买凭证。

1.  就是这样！我们会直接将免费的 PDF 和其他福利发送到你的邮箱。
