# *ç¬¬äº”ç« *ï¼šåˆ›å»ºå’Œç¼–è¾‘æœåŠ¡

æˆ‘ä»¬åˆšåˆšäº†è§£äº†`systemd`æœåŠ¡æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•æ§åˆ¶å®ƒä»¬ã€‚ä¸è¿‡ï¼Œæœ‰æ—¶ä½ å¯èƒ½éœ€è¦æ”¹å˜æŸä¸ªæœåŠ¡çš„è¡Œä¸ºï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœåŠ¡ã€‚åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•æ­£ç¡®ç¼–è¾‘æœåŠ¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ã€‚æœ¬ç« çš„å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

+   ç¼–è¾‘ç°æœ‰æœåŠ¡

+   åˆ›å»ºæ–°æœåŠ¡

+   æ›´æ”¹é»˜è®¤çš„ systemd ç¼–è¾‘å™¨

+   ä½¿ç”¨ Podman åˆ›å»ºæ–°çš„å®¹å™¨æœåŠ¡

å¦‚æœä½ å‡†å¤‡å¥½äº†ï¼Œé‚£æˆ‘ä»¬å°±å¼€å§‹å§ã€‚

# æŠ€æœ¯è¦æ±‚

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘å°†ä½¿ç”¨ Alma Linux 8 è™šæ‹Ÿæœºå’Œ Ubuntu Server 20.04 è™šæ‹Ÿæœºã€‚ä¸ºäº†è¿›è¡Œå®‰å…¨ shellï¼ˆSecure Shellï¼‰ç»ƒä¹ ï¼Œä½ éœ€è¦è¿›å…¥ä¸¤å°è™šæ‹Ÿæœºçš„ VirtualBox ç½‘ç»œè®¾ç½®ï¼Œå¹¶é€‰æ‹©`ip a`ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥ä»å®¿ä¸»æœºçš„å‘½ä»¤è¡Œè¿œç¨‹ç™»å½•åˆ°è™šæ‹Ÿæœºã€‚

æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥ï¼Œè§‚çœ‹â€œä»£ç å®æˆ˜â€è§†é¢‘ï¼š[`bit.ly/3xP0yOH`](https://bit.ly/3xP0yOH)

# ç¼–è¾‘ç°æœ‰æœåŠ¡

æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼ŒæœåŠ¡çš„å•å…ƒæ–‡ä»¶ä½äº`/lib/systemd/system/`ç›®å½•ä¸­ï¼Œæ‰€ä»¥ä½ å¯èƒ½é¦–å…ˆä¼šæƒ³åˆ°ç›´æ¥å»é‚£é‡Œï¼Œä½¿ç”¨ä½ å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨ç¼–è¾‘æ–‡ä»¶ã€‚è™½ç„¶è¿™ä¹ˆåšæ˜¯å¯è¡Œçš„ï¼Œä½†ä½ ä¸åº”è¯¥è¿™æ ·åšã€‚å¦‚æœè¿›è¡Œç³»ç»Ÿæ›´æ–°ï¼Œå®ƒå¯èƒ½ä¼šè¦†ç›–ä½ ç¼–è¾‘çš„æ–‡ä»¶ï¼Œä»è€Œä¸¢å¤±ä½ çš„ä¿®æ”¹ã€‚

æ­£ç¡®çš„æ–¹æ³•æ˜¯åœ¨`/etc/systemd/system/`ç›®å½•ä¸­åˆ›å»ºä½ æœåŠ¡æ–‡ä»¶çš„ç¼–è¾‘ç‰ˆã€‚ä½ å¯ä»¥åƒç¼–è¾‘å…¶ä»–é…ç½®æ–‡ä»¶ä¸€æ ·ï¼Œä½¿ç”¨ä½ å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨è¿›è¡Œç¼–è¾‘ã€‚äº‹å®ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ä½ *ä»¥å‰*å¿…é¡»åšçš„äº‹ã€‚å½“ Red Hat å‘å¸ƒ RHEL 7.2 æ—¶ï¼Œä»–ä»¬åœ¨`systemctl`å‘½ä»¤ä¸­æ·»åŠ äº†ä¸€ä¸ª`edit`åŠŸèƒ½ï¼Œè¿™ä½¿å¾—æ“ä½œå˜å¾—æ›´å®¹æ˜“ã€‚ï¼ˆå½“ç„¶ï¼Œç°åœ¨æ‰€æœ‰è¿è¡Œ`systemd`çš„ Linux å‘è¡Œç‰ˆéƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ª`edit`åŠŸèƒ½ã€‚ï¼‰

æ³¨

æˆ‘æ³¨æ„åˆ°æœ‰äº›äººå–œæ¬¢å°†è‡ªå·±çš„è‡ªå®šä¹‰å•å…ƒæ–‡ä»¶æ·»åŠ åˆ°`/lib/systemd/system/`ç›®å½•ä¸­ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥ä¸æ“ä½œç³»ç»Ÿå®‰è£…çš„å•å…ƒæ–‡ä»¶å¹¶åˆ—ã€‚å¦‚æœä½ æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œè¯·ç†è§£è¿™æ ·åšæ˜¯*ä¸*å¥½çš„åšæ³•ã€‚è¿™æ ·åšçš„é£é™©æ˜¯ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿæ›´æ–°æ—¶ï¼Œä½ çš„è‡ªå®šä¹‰å•å…ƒæ–‡ä»¶å¯èƒ½ä¼šè¢«åˆ é™¤æˆ–è¦†ç›–ã€‚è€Œå°†è‡ªå®šä¹‰å•å…ƒæ–‡ä»¶ä¿å­˜åœ¨`/etc/systemd/system/`ç›®å½•ä¸­ï¼Œä¼šè®©ä½ æ›´å®¹æ˜“è·Ÿè¸ªå“ªäº›å•å…ƒæ–‡ä»¶æ˜¯ä½ æ·»åŠ çš„ï¼Œå“ªäº›æ˜¯æ“ä½œç³»ç»Ÿå®‰è£…çš„ã€‚

ç°åœ¨ï¼Œä½ å¯èƒ½ä¼šæƒ³çŸ¥é“å¦‚ä½•äº†è§£å¯ä»¥å¯¹æœåŠ¡æ–‡ä»¶è¿›è¡Œå“ªäº›æ›´æ”¹ã€‚æœ€ç®€å•çš„ç­”æ¡ˆæ˜¯é˜…è¯»ä¸åŒå•å…ƒç±»å‹çš„ man é¡µé¢ï¼ŒæŸ¥çœ‹å¯ä»¥æ·»åŠ ã€åˆ é™¤æˆ–ä¿®æ”¹çš„æ‰€æœ‰å‚æ•°å’Œé€‰é¡¹ã€‚ä¸è¿‡ï¼Œå¦‚æœåƒæˆ‘ä¸€æ ·ï¼Œä½ ä¼šå‘ç°é˜…è¯»è¿™äº› man é¡µé¢å¾ˆå®¹æ˜“è®©äººæ˜æ˜æ¬²ç¡ã€‚åˆ«è¯¯ä¼šï¼Œman é¡µé¢ç¡®å®å¾ˆæœ‰ç”¨ã€‚ä½†å¦‚æœä½ çœŸçš„æƒ³å­¦ä¼šå¦‚ä½•è®©æœåŠ¡æŒ‰ç…§ä½ çš„éœ€æ±‚â€œå”±æ­Œè·³èˆâ€ï¼Œæœ€è½»æ¾çš„åŠæ³•å°±æ˜¯æŸ¥çœ‹ä½ ç³»ç»Ÿä¸­å·²ç»å­˜åœ¨çš„æœåŠ¡æ–‡ä»¶ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•è®¾ç½®çš„ã€‚ç„¶åï¼ŒæŸ¥çœ‹è¿™äº›æ–‡ä»¶ä¸­åˆ—å‡ºçš„å‚æ•°ï¼Œå¹¶æŸ¥é˜…ç›¸åº”çš„ man é¡µé¢ï¼Œäº†è§£å®ƒä»¬ä¸ºä½ åšäº†ä»€ä¹ˆã€‚æˆ‘ä»¬åœ¨æœ¬ç« ä¸­ä¼šé€šè¿‡å¾ˆå¤šä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚

å½“ä½ ä½¿ç”¨ `systemctl edit` åŠŸèƒ½æ—¶ï¼Œå¯ä»¥é€‰æ‹©éƒ¨åˆ†ç¼–è¾‘æ–‡ä»¶æˆ–ç¼–è¾‘æ•´ä¸ªæ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ å°†è¿›è¡Œéƒ¨åˆ†ç¼–è¾‘ã€‚è®©æˆ‘ä»¬ä»æˆ‘èƒ½æƒ³åˆ°çš„æœ€ç®€å•çš„ä¾‹å­å¼€å§‹ã€‚

## å¯¹ [Install] éƒ¨åˆ†è¿›è¡Œéƒ¨åˆ†ç¼–è¾‘

å¯åŠ¨ Ubuntu æœåŠ¡å™¨è™šæ‹Ÿæœºå¹¶å‘ `apache2.service` æ–‡ä»¶æ·»åŠ ä¸€è¡Œ `Alias=`ã€‚é¦–å…ˆè¿™æ ·åšï¼š

```
sudo systemctl edit apache2
```

ä½ çœ‹åˆ°çš„å†…å®¹ç±»ä¼¼äºè¿™æ ·ï¼š

![](img/Figure_5.1_B17491.jpg)

å›¾ 5.1 â€“ Ubuntu ä¸Šçš„ systemd æœåŠ¡ç¼–è¾‘å™¨

æ˜¯çš„ï¼Œçœ‹èµ·æ¥æ²¡ä»€ä¹ˆï¼Œå¯¹å§ï¼Ÿè¿™åªæ˜¯ä¸€ä¸ªåœ¨ nano ç¼–è¾‘å™¨ä¸­æ‰“å¼€çš„ç©ºæ–‡ä»¶ã€‚ä¸è¿‡åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¦åšçš„åªæ˜¯æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œä¸”ä¸éœ€è¦çœ‹åˆ°æ•´ä¸ªæœåŠ¡æ–‡ä»¶å°±èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Ubuntuï¼ŒApache æœåŠ¡çš„åç§°æ˜¯ `apache2`ã€‚å‡è®¾ä½ åˆšä» Red Hat ç¯å¢ƒè¿‡æ¥ï¼Œå¹¶ä¸”ä¹ æƒ¯äº†æ€»æ˜¯ä½¿ç”¨ `httpd` ä½œä¸º Apache æœåŠ¡åã€‚å› æ­¤ï¼Œæ¯å½“ä½ åœ¨ Ubuntu æœºå™¨ä¸Šè¾“å…¥é”™è¯¯çš„æœåŠ¡åæ—¶ï¼Œå°±ä¼šæ„Ÿåˆ°å¾ˆæ²®ä¸§ã€‚è¿™å°±åƒæ˜¯ä½ ä¸€è¾ˆå­éƒ½ä¹ æƒ¯å¼€æ‰‹åŠ¨æŒ¡è½¦ï¼Œç»“æœä¸€ä¸Šè‡ªåŠ¨æŒ¡è½¦å°±å¼€å§‹æ‰¾ç¦»åˆå™¨ã€‚ï¼ˆå—¯ï¼Œåæ­£æˆ‘æ˜¯è¿™ä¹ˆåšçš„ã€‚ï¼‰æˆ‘ä»¬å¯ä»¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä¾‹å­ã€‚

åœ¨å¦ä¸€ä¸ªçª—å£ä¸­ï¼ŒæŸ¥çœ‹ Ubuntu æœºå™¨ä¸Š `ssh.service` æ–‡ä»¶çš„ `[Install]` éƒ¨åˆ†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
. . .
. . .
[Install]
WantedBy=multi-user.target
Alias=sshd.service
```

æœ€åçš„ `Alias=` è¡Œå°±æ˜¯æˆ‘ä»¬çš„ä¾‹å­ã€‚ç°åœ¨ï¼Œåœ¨ nano çª—å£ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```
[Install]
Alias=httpd.service
```

ä¿å­˜æ–‡ä»¶å¹¶é€šè¿‡æŒ‰ *Ctrl* + *X* é”®ç»„åˆé€€å‡ºç¼–è¾‘å™¨ã€‚å½“å®ƒè¯¢é—®æ˜¯å¦ä¿å­˜å·²ä¿®æ”¹çš„ç¼“å†²åŒºæ—¶ï¼ŒæŒ‰ *y* é”®ã€‚ç„¶åï¼ŒæŒ‰ *Enter* é”®æ¥å—é»˜è®¤çš„æ–‡ä»¶åã€‚æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹ `/etc/systemd/system/` ç›®å½•ã€‚ä½ ä¼šçœ‹åˆ°æˆ‘ä»¬åˆšåˆšåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ `apache2.service.d` ç›®å½•ï¼š

```
donnie@ubuntu20-04:/etc/systemd/system$ ls -l
total 104
drwxr-xr-x 2 root root 4096 AprÂ Â 5 16:55 apache2.service.d
. . .
. . .
```

åœ¨é‚£ä¸ªç›®å½•ä¸­ï¼Œä½ å°†çœ‹åˆ°ä»¥ä¸‹ `override.conf` æ–‡ä»¶ï¼š

```
donnie@ubuntu20-04:/etc/systemd/system/apache2.service.d$ ls -l
total 4
-rw-r--r-- 1 root root 30 AprÂ Â 5 16:55 override.conf
donnie@ubuntu20-04:/etc/systemd/system/apache2.service.d$
```

è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æˆ‘ä»¬åˆšåˆšæ·»åŠ çš„å‚æ•°ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
[Install]
Alias=httpd.service
```

å°±æ˜¯è¿™æ ·â€”â€”æ•´ä¸ªæ–‡ä»¶ã€‚å½“æˆ‘ä»¬å¯åŠ¨ Apache æ—¶ï¼Œè¿™ä¸ªå‚æ•°å°†è¢«æ·»åŠ åˆ°åŸå§‹æœåŠ¡æ–‡ä»¶ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ã€‚å…¶ä¼˜ç‚¹æ˜¯ï¼Œå¦‚æœåŸå§‹æœåŠ¡æ–‡ä»¶åœ¨ç³»ç»Ÿæ›´æ–°ä¸­è¢«æ›¿æ¢ï¼Œä½ å°†è·å¾—æ›´æ–°æ‰€åšçš„æ›´æ”¹ï¼Œå¹¶ä¸”ä»ç„¶ä¿ç•™è¿™ä¸ªä¿®æ”¹ã€‚

ä½†æ˜¯ï¼Œåœ¨ä½ ä½¿ç”¨è¿™ä¸ªä¿®æ”¹ä¹‹å‰ï¼Œä½ éœ€è¦å°†å®ƒåŠ è½½åˆ°ç³»ç»Ÿä¸­ã€‚ä½ å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl daemon-reload
[sudo] password for donnie: 
donnie@ubuntu20-04:~$
```

æ¯æ¬¡ä¿®æ”¹æˆ–æ·»åŠ æœåŠ¡æ–‡ä»¶æ—¶ï¼Œä½ éƒ½éœ€è¦æ‰§è¡Œ`daemon-reload`ã€‚å½“ä½ æ·»åŠ `Alias=`æ—¶ï¼Œè¿˜éœ€è¦åœ¨`/etc/systemd/system/`ç›®å½•ä¸­ä¸ºå…¶åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚ä½ å¯ä»¥é€šè¿‡`ln -s`å‘½ä»¤æ‰‹åŠ¨åˆ›å»ºå®ƒï¼Œä½†å…¶å®ä¸å¿…ã€‚å½“ä½ åœ¨æœåŠ¡æ–‡ä»¶çš„`[Install]`éƒ¨åˆ†æ·»åŠ `Alias=`è¡Œæ—¶ï¼Œå¯ç”¨æœåŠ¡æ—¶é“¾æ¥ä¼šè‡ªåŠ¨åˆ›å»ºã€‚åœ¨ Ubuntu æœºå™¨ä¸Šï¼ŒApache æœåŠ¡å·²ç»å¯ç”¨å¹¶æ­£åœ¨è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦ç¦ç”¨å¹¶é‡æ–°å¯ç”¨å®ƒã€‚ï¼ˆæ³¨æ„ï¼Œä¸éœ€è¦åœæ­¢æœåŠ¡ã€‚ï¼‰é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆç¦ç”¨ Apacheï¼Œåƒè¿™æ ·ï¼š

```
donnie@ubuntu20-04:/etc/systemd/system$ sudo systemctl disable apache2
Synchronizing state of apache2.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install disable apache2
Removed /etc/systemd/system/multi-user.target.wants/apache2.service.
donnie@ubuntu20-04:/etc/systemd/system$
```

ç°åœ¨ï¼Œæˆ‘ä»¬å°†é‡æ–°å¯ç”¨å®ƒï¼Œåƒè¿™æ ·ï¼š

```
donnie@ubuntu20-04:/etc/systemd/system$ sudo systemctl enable apache2
Synchronizing state of apache2.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable apache2
Created symlink /etc/systemd/system/httpd.service â†’ /lib/systemd/system/apache2.service.
Created symlink /etc/systemd/system/multi-user.target.wants/apache2.service â†’ /lib/systemd/system/apache2.service.
donnie@ubuntu20-04:/etc/systemd/system$
```

ä½ å¯ä»¥åœ¨è¾“å‡ºä¸­çœ‹åˆ°ï¼Œ`enable`å‘½ä»¤è¯»å–äº†æˆ‘ä»¬æ’å…¥`[Install]`éƒ¨åˆ†çš„`Alias=`è¡Œï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘åŸå§‹`apache2.service`æ–‡ä»¶çš„`httpd.service`é“¾æ¥ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹`ls -l`å‘½ä»¤æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š

```
donnie@ubuntu20-04:/etc/systemd/system$ ls -l httpd.service 
lrwxrwxrwx 1 root root 35 AprÂ Â 5 17:39 httpd.service -> /lib/systemd/system/apache2.service
donnie@ubuntu20-04:/etc/systemd/system$
```

ç°åœ¨æ˜¯å…³é”®æ—¶åˆ»äº†ã€‚æˆ‘ä»¬èƒ½é€šè¿‡è°ƒç”¨`httpd`æœåŠ¡åç§°æ¥æ§åˆ¶æˆ‘ä»¬ Ubuntu æœºå™¨ä¸Šçš„ Apache å—ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š

```
donnie@ubuntu20-04:~$ systemctl status httpd
â€¢ apache2.service - The Apache HTTP Server
Â Â Â Â Â Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
Â Â Â Â Drop-In: /etc/systemd/system/apache2.service.d
Â Â Â Â Â Â Â Â Â Â Â Â Â â””â”€override.conf
Â Â Â Â Â Active: active (running) since Mon 2021-04-05 17:19:08 UTC; 34min ago
. . .
. . .
```

å“¦ï¼Œæ²¡é”™ã€‚å®ƒè¿è¡Œå¾—åƒå† å†›ä¸€æ ·ã€‚ï¼ˆä½ éš¾é“ä¸å–œæ¬¢è®¡åˆ’æˆåŠŸæ—¶çš„æ„Ÿè§‰å—ï¼Ÿï¼‰è¦æŸ¥çœ‹å¸¦æœ‰æ–°ç¼–è¾‘çš„æœåŠ¡æ–‡ä»¶ï¼Œä½¿ç”¨`systemctl cat`ï¼Œåƒè¿™æ ·ï¼š

```
donnie@ubuntu20-04:~$ systemctl cat apache2
# /lib/systemd/system/apache2.service
[Unit]
Description=The Apache HTTP Server
. . .
. . .
[Install]
WantedBy=multi-user.target
# /etc/systemd/system/apache2.service.d/override.conf
[Install]
Alias=httpd.service
donnie@ubuntu20-04:~$
```

è¾“å‡ºçš„é¡¶éƒ¨éƒ¨åˆ†æ˜¾ç¤ºäº†åŸå§‹çš„æœåŠ¡æ–‡ä»¶ï¼Œåº•éƒ¨éƒ¨åˆ†æ˜¾ç¤ºäº†ä½ åˆ›å»ºçš„`override.conf`æ–‡ä»¶ã€‚

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥èµ°åæ–¹å‘ã€‚å¦‚æœä½ ä¹ æƒ¯äº† Ubuntu çš„æ–¹å¼ï¼Œè€Œçªç„¶å‘ç°è‡ªå·±åœ¨ RHEL ç±»å‹çš„æœºå™¨ä¸Šç®¡ç† Apacheï¼Œä½ å¯ä»¥åœ¨`httpd.service`æ–‡ä»¶ä¸­æ·»åŠ `Alias=apache2.service`è¡Œï¼Œç„¶åç¦ç”¨å¹¶é‡æ–°å¯ç”¨ Apache æ¥åˆ›å»ºé“¾æ¥ã€‚å”¯ä¸€çš„ä¸åŒä¹‹å¤„æ˜¯ï¼Œåœ¨ Ubuntu æœºå™¨ä¸Šï¼Œ`systemctl edit`ä¼šå¯åŠ¨ nano æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œè€Œåœ¨ RHEL ç±»å‹çš„æœºå™¨ä¸Šï¼Œå®ƒå¯èƒ½ä¼šå¯åŠ¨ vi æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ï¼ˆRHEL ç±»å‹çš„å‘è¡Œç‰ˆæœ€è¿‘æ‰ä» vi åˆ‡æ¢ä¸º nano ä½œä¸ºé»˜è®¤çš„ systemd ç¼–è¾‘å™¨ã€‚ï¼‰

ä¸“ä¸šæç¤º

è®°ä½ï¼Œå¯¹æœåŠ¡æ–‡ä»¶ä¸­`[Install]`éƒ¨åˆ†æ‰€åšçš„ä»»ä½•æ›´æ”¹éƒ½ä¼šå½±å“æ¯æ¬¡å¯ç”¨æˆ–ç¦ç”¨è¯¥æœåŠ¡æ—¶çš„è¡Œä¸ºã€‚

å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»åœ¨`[Install]`éƒ¨åˆ†æ·»åŠ äº†ä¸€ä¸ªå¾ˆé…·çš„é€‰é¡¹ï¼Œè®©æˆ‘ä»¬æ¥æ·»åŠ ä¸€äº›åˆ°`[Service]`éƒ¨åˆ†å§ã€‚

## å¯¹`[Service]`éƒ¨åˆ†è¿›è¡Œå±€éƒ¨ç¼–è¾‘

è®©æˆ‘ä»¬ç»§ç»­æ“ä½œæˆ‘ä»¬çš„ Ubuntu æœåŠ¡å™¨è™šæ‹Ÿæœºï¼Œå¹¶åœ¨å·²ç»åšè¿‡çš„åŸºç¡€ä¸Šå†æ·»åŠ ä¸€äº›å†…å®¹ã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬å°†åœ¨ `[Service]` éƒ¨åˆ†æ·»åŠ ä¸€äº›é€‰é¡¹ï¼Œç¨å¾®å¢å¼ºä¸€ä¸‹å®‰å…¨æ€§ã€‚ä¸è¿‡ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ Apache çš„å®é™…å®‰å…¨æ€§å¦‚ä½•ã€‚æˆ‘ä»¬å°†é€šè¿‡ `systemd-analyze` å·¥å…·æ¥æ£€æŸ¥ã€‚

åœ¨ `systemd-analyze` çš„æ‰‹å†Œé¡µä¸Šï¼Œä½ ä¼šçœ‹åˆ°è¿™ä¸ªå·¥å…·æœ‰å¾ˆå¤šç”¨é€”ã€‚ç›®å‰ï¼Œæˆ‘ä»¬åªä»‹ç» `security` é€‰é¡¹ã€‚é¦–å…ˆï¼Œé€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥æˆ‘ä»¬ Ubuntu è™šæ‹Ÿæœºä¸ŠæœåŠ¡çš„æ•´ä½“å®‰å…¨é…ç½®ï¼š

```
donnie@ubuntu20-04:~$ systemd-analyze security
UNITÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â EXPOSURE PREDICATE HAPPY
accounts-daemon.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.6 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
apache2.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.2 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
apport.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.6 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
. . .
. . .Â Â Â Â Â Â ğŸ™‚Â Â Â Â 
systemd-udevd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 8.4 EXPOSED ğŸ™Â Â Â Â 
thermald.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.6 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
unattended-upgrades.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.6 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
user@1000.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.4 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
uuidd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 4.5 OKÂ Â Â Â Â Â ğŸ™‚Â Â Â Â 
vgauth.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 9.5 UNSAFEÂ Â ğŸ˜¨Â Â Â Â 
donnie@ubuntu20-04:~$
```

è¿™ä¸ªå‘½ä»¤ä¼šæ£€æŸ¥æ¯ä¸ªæœåŠ¡çš„å®‰å…¨æ€§å’Œæ²™ç›’è®¾ç½®ï¼Œå¹¶ä¸ºæ¯ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ª `EXPOSURE` åˆ†æ•°ã€‚åˆ†æ•°è¶Šé«˜ï¼ŒæœåŠ¡å°±è¶Šä¸å®‰å…¨ã€‚æ‰€ä»¥ï¼Œè¿™å°±åƒé«˜å°”å¤«æ¯”èµ›ä¸€æ ·ï¼Œä½ éœ€è¦å°½å¯èƒ½è·å¾—æœ€ä½åˆ†æ•°ã€‚`HAPPY` åˆ—æœ¬æ¥åº”è¯¥æ˜¾ç¤ºä¸åŒç¨‹åº¦çš„å¼€å¿ƒæˆ–éš¾è¿‡è¡¨æƒ…ç¬¦å·ï¼Œä½†ç²˜è´´åˆ°ä¹¦ä¸­çš„æ—¶å€™è¡¨æƒ…ç¬¦å·æ— æ³•æ˜¾ç¤ºã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨è‡ªå·±çš„è™šæ‹Ÿæœºä¸Šçœ‹åˆ°è¿™äº›è¡¨æƒ…ã€‚

ç°åœ¨ï¼Œåœ¨ä½ çœ‹åˆ°æŸä¸ªæœåŠ¡è¢«æ ‡è®°ä¸º `UNSAFE`ï¼ˆå¦‚æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°çš„ Apache æœåŠ¡ï¼‰æ—¶ï¼Œåˆ«å¤ªæ¿€åŠ¨ï¼Œä½ éœ€è¦ç†è§£è¿™åªæ˜¯æ£€æŸ¥äº†æœåŠ¡æ–‡ä»¶ä¸­çš„å®‰å…¨è®¾ç½®ã€‚å®ƒå¹¶æ²¡æœ‰è€ƒè™‘æœåŠ¡è‡ªèº«é…ç½®æ–‡ä»¶ä¸­çš„ä»»ä½•å®‰å…¨è®¾ç½®ï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘å¯èƒ½åµŒå…¥åœ¨æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å®‰å…¨é€‰é¡¹ï¼Œæˆ–è€…ä»»ä½•å¯èƒ½ç”Ÿæ•ˆçš„**å¼ºåˆ¶è®¿é—®æ§åˆ¶**ï¼ˆ**MAC**ï¼‰é€‰é¡¹ã€‚ä¸è¿‡ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œè¿™ä»ç„¶æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥ä¸ºä½ æä¾›åŠ å¼ºå®‰å…¨è®¾ç½®çš„å»ºè®®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›é’ˆå¯¹ Apache æœåŠ¡çš„å»ºè®®ï¼š

```
donnie@ubuntu20-04:~$ systemd-analyze security apache2
Â Â NAMEÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â DESCRIPTIONÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â EXPOSURE
âœ— PrivateNetwork=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has access to the host's networkÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.5
âœ— User=/DynamicUser=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service runs as root userÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.4
âœ— CapabilityBoundingSet=~CAP_SET(UID|GID|PCAP)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may change UID/GID identities/capabilitiesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.3
âœ— CapabilityBoundingSet=~CAP_SYS_ADMINÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has administrator privilegesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.3
âœ— CapabilityBoundingSet=~CAP_SYS_PTRACEÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has ptrace() debugging abilitiesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.3
. . .
. . .
```

è¿™é‡Œçš„è¾“å‡ºå¤ªå¤šï¼Œæ— æ³•å…¨éƒ¨æ˜¾ç¤ºï¼Œä½†æ²¡å…³ç³»ã€‚è®©æˆ‘ä»¬å‘ä¸‹æ»šåŠ¨ä¸€äº›ï¼Œå±•ç¤ºä¸€äº›ä¸æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…æ›´ç›¸å…³çš„è®¾ç½®ï¼š

```
. . .
. . .
âœ“ PrivateMounts=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service cannot install system mountsÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
âœ“ PrivateTmp=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has no access to other software's temporary filesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
âœ— PrivateUsers=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has access to other usersÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.2
âœ— ProtectClock=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may write to the hardware clock or system clockÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.2
âœ— ProtectControlGroups=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may modify the control group file systemÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.2
âœ— ProtectHome=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has full access to home directoriesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.2
. . .
. . .
âœ— ProtectSystem=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has full access to the OS file hierarchyÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.2
. . .
. . .
```

å½“ä½ çœ‹åˆ°æ¡ç›®å‰é¢æœ‰ä¸€ä¸ª `X` æ—¶ï¼Œæ„å‘³ç€è¿™ä¸ªè®¾ç½®æ˜¯ä¸å®‰å…¨çš„ã€‚å¦‚æœæ¡ç›®å‰æœ‰ä¸€ä¸ªå‹¾é€‰æ ‡è®°ï¼Œè¡¨ç¤ºè¯¥å‚æ•°å·²é…ç½®ä¸ºå®‰å…¨è®¾ç½®ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ èƒ¡ä¹±åœ°å°†ä¸å®‰å…¨çš„è®¾ç½®æ›´æ”¹ä¸ºå®‰å…¨çš„è®¾ç½®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡æ— æ³•æ­£å¸¸è¿è¡Œã€‚ä¸€äº›æ‰€è°“çš„ä¸å®‰å…¨è®¾ç½®å…¶å®æ˜¯æœåŠ¡æ­£å¸¸è¿è¡Œæ‰€å¿…éœ€çš„ã€‚ä»¥ `User=/DynamicUser=` è®¾ç½®ä¸ºä¾‹ã€‚å¦‚æœæ²¡æœ‰è¯¥å‚æ•°ï¼ŒApache æœåŠ¡å°†ä»¥ root æƒé™è¿è¡Œã€‚è¿™ä¸ä¸€å®šä¸å¥½ï¼Œå› ä¸º Apache æœåŠ¡éœ€è¦ root æƒé™æ¥æ‰§è¡ŒæŸäº›ä»»åŠ¡ã€‚å¦‚æœä½ å°†è¯¥é€‰é¡¹è®¾ç½®ä¸ºé root ç”¨æˆ·ï¼ŒApache å°†æ— æ³•å¯åŠ¨ã€‚è€Œä¸”ï¼ŒApache å¼€å‘è€…å·²ç»è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ã€‚ä»–ä»¬çš„è®¾ç½®æ–¹å¼æ˜¯ï¼Œåªæœ‰ç¬¬ä¸€ä¸ª Apache è¿›ç¨‹ä¼šä»¥ root æƒé™è¿è¡Œï¼Œå…¶ä»–æ‰€æœ‰çš„ Apache è¿›ç¨‹â€”â€”å³æµè§ˆå™¨è¿æ¥çš„è¿›ç¨‹â€”â€”éƒ½ä¸ä¼šä»¥ root æƒé™è¿è¡Œã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œåœ¨ RHEL ç±»å‹çš„å‘è¡Œç‰ˆä¸­ï¼Œæ¯”å¦‚ Alma Linuxï¼ŒApache è¿›ç¨‹æ˜¯ä»¥ `apache` ç”¨æˆ·èº«ä»½è¿è¡Œçš„ã€‚è€Œåœ¨ Ubuntu ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒä»¬æ˜¯ä»¥ `www-data` è´¦æˆ·è¿è¡Œçš„ï¼š

```
donnie@ubuntu20-04:/etc/apache2$ ps aux | grep apache
rootÂ Â Â Â Â Â Â Â 2290Â Â 0.0Â Â 0.2Â Â Â 6520Â Â 4480 ?Â Â Â Â Â Â Â Â SsÂ Â Â 18:40Â Â Â 0:00 /usr/sbin/apache2 -k start
www-dataÂ Â Â Â 2291Â Â 0.0Â Â 0.2 752656Â Â 4344 ?Â Â Â Â Â Â Â Â SlÂ Â Â 18:40Â Â Â 0:00 /usr/sbin/apache2 -k start
www-dataÂ Â Â Â 2292Â Â 0.0Â Â 0.2 752656Â Â 4344 ?Â Â Â Â Â Â Â Â SlÂ Â Â 18:40Â Â Â 0:00 /usr/sbin/apache2 -k start
donnieÂ Â Â Â Â Â 2554Â Â 0.0Â Â 0.0Â Â Â 6432Â Â Â 724 pts/0Â Â Â Â S+Â Â Â 19:55Â Â Â 0:00 grep --color=auto apache
donnie@ubuntu20-04:/etc/apache2$
```

è¿™ä¸ªéæ ¹ç”¨æˆ·æ˜¯åœ¨ Apache é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„å¥½æœ‹å‹`grep`èƒ½å¦å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªè®¾ç½®çš„ä½ç½®ï¼š

```
donnie@ubuntu20-04:/etc/apache2$ grep -r 'USER' *
apache2.conf:User ${APACHE_RUN_USER}
envvars:export APACHE_RUN_USER=www-data
donnie@ubuntu20-04:/etc/apache2$
```

æ‰€ä»¥ï¼Œåœ¨ Ubuntu æœºå™¨ä¸Šï¼Œé root çš„ `www-data` ç”¨æˆ·å®šä¹‰åœ¨ `/etc/apache2/envvars` æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨ `/etc/apache2/apache2.conf` æ–‡ä»¶ä¸­è°ƒç”¨ã€‚ï¼ˆå…³äº Alma Linux æœºå™¨ä¸Šè¿™ä¸ªè®¾ç½®çš„ä½ç½®ï¼Œæˆ‘ç•™ç»™ä½ è‡ªå·±å»æ‰¾ã€‚ï¼‰æ€»ä¹‹ï¼Œå…³äºæˆ‘ä»¬ä¸èƒ½æ›´æ”¹çš„è®¾ç½®å°±è¯´åˆ°è¿™é‡Œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›æˆ‘ä»¬*å¯ä»¥*æ›´æ”¹çš„è®¾ç½®ã€‚

æç¤ºï¼š

åœ¨ RHEL ç±»å‹çš„æœºå™¨ä¸Šï¼Œæ¥ä¸‹æ¥æˆ‘å°†å±•ç¤ºçš„æ‰€æœ‰å†…å®¹å·²ç»ç”± SELinux è¦†ç›–ã€‚ä½†å¦‚æœä½ å¸Œæœ›è·å¾—åŒé‡ä¿æŠ¤ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨è¿™äº›è®¾ç½®ã€‚Ubuntu å’Œ SUSE ä½¿ç”¨ AppArmor è€Œä¸æ˜¯ SELinuxã€‚ä¸å¹¸çš„æ˜¯ï¼Œé™¤éä½ è‡ªè¡Œåˆ›å»ºè‡ªå®šä¹‰çš„ AppArmor é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™ AppArmor å¯¹ Apache å‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚è€Œåœ¨ `systemd` ä¸­è®¾ç½®è¿™äº›ä¿æŠ¤åˆ™è¦ç®€å•å¾—å¤šã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä¿æŠ¤ç”¨æˆ·çš„ä¸»ç›®å½•ã€‚æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨ `sudo systemctl edit apache2` å‘½ä»¤ï¼Œè¿™å°†æ‰“å¼€æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ `override.conf` æ–‡ä»¶ã€‚`[Install]` éƒ¨åˆ†ä»ç„¶å­˜åœ¨ï¼Œæˆ‘ä»¬åªéœ€æ·»åŠ ä¸€ä¸ª `[Service]` éƒ¨åˆ†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
[Service]
ProtectHome=yes
ProtectSystem=strict
[Install]
Alias=httpd.service
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒApache æœåŠ¡å¯ä»¥è¯»å–æˆ–å†™å…¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä»»ä½•ä½ç½®ã€‚`ProtectHome=yes` è®¾ç½®å¯ä»¥é˜²æ­¢ Apache è®¿é—® `/root/`ã€`/home/` å’Œ `/run/user/` ç›®å½•ï¼Œå³ä½¿è¿™äº›ç›®å½•è®¾ç½®äº†å…¨å±€å¯è¯»æƒé™ã€‚å¦‚æœç”¨æˆ·å¸Œæœ›é€šè¿‡è‡ªå·±çš„ä¸»ç›®å½•æä¾› Web å†…å®¹ï¼ŒåŒæ—¶é˜²æ­¢ Apache å†™å…¥è¿™äº›ç›®å½•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†æ­¤è®¾ç½®ä¸º `read-only`ã€‚

`ProtectSystem=strict` è®¾ç½®ä¼šä½¿ Apache åªèƒ½å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œåªè¯»è®¿é—®ï¼Œé™¤äº† `/dev/`ã€`/proc/` å’Œ `/sys/` ç›®å½•ã€‚æˆ‘ä»¬ä¿å­˜æ–‡ä»¶å¹¶é‡å¯ Apacheï¼Œçœ‹çœ‹ç»“æœï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl daemon-reload
donnie@ubuntu20-04:~$ sudo systemctl restart apache2
Job for apache2.service failed because the control process exited with error code.
See "systemctl status apache2.service" and "journalctl -xe" for details.
donnie@ubuntu20-04:~$
```

å“å‘€ï¼Œè¿™ä¸å¥½ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼Œçœ‹çœ‹é—®é¢˜å¯èƒ½å‡ºåœ¨å“ªé‡Œï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl status apache2
. . .
. . .
Apr 10 21:52:20 ubuntu20-04 apachectl[3848]: (30)Read-only file system: AH00091: apache2: could not open error log file /var/log/apache2/error.log.
Apr 10 21:52:20 ubuntu20-04 apachectl[3848]: AH00015: Unable to open logs
Apr 10 21:52:20 ubuntu20-04 apachectl[3836]: Action 'start' failed.
Apr 10 21:52:20 ubuntu20-04 apachectl[3836]: The Apache error log may have more information.
. . .
. . .
donnie@ubuntu20-04:~$
```

æ‰€ä»¥ï¼ŒApache æƒ³è¦å†™å…¥`/var/log/apache2/`ç›®å½•ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼Œä½†å®ƒä¸èƒ½ã€‚è®©æˆ‘ä»¬æ›´æ”¹`ProtectSystem`è®¾ç½®ï¼Œçœ‹çœ‹èƒ½å¦è§£å†³é—®é¢˜ï¼š

```
[Service]
ProtectHome=yes
ProtectSystem=fullÂ Â 
[Install]
Alias=httpd.service
```

å°†`ProtectSystem=`è®¾ç½®ä¸º`full`ä¼šä½¿ Apache å¯¹`/boot/`ã€`/usr/`å’Œ`/etc/`ç›®å½•å…·æœ‰åªè¯»è®¿é—®æƒé™ã€‚é€šå¸¸ï¼ŒApache ä¸éœ€è¦å†™å…¥è¿™äº›ç›®å½•ï¼Œæ‰€ä»¥ç°åœ¨å®ƒåº”è¯¥èƒ½æ­£å¸¸å·¥ä½œã€‚æˆ‘ä»¬è¯•è¯•çœ‹ï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl daemon-reload
donnie@ubuntu20-04:~$ sudo systemctl restart apache2
donnie@ubuntu20-04:~$
```

æ²¡æœ‰é”™è¯¯ä¿¡æ¯ï¼Œè¿™å¾ˆå¥½ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl status apache2
â— apache2.service - The Apache HTTP Server
Â Â Â Â Â Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
Â Â Â Â Drop-In: /etc/systemd/system/apache2.service.d
Â Â Â Â Â Â Â Â Â Â Â Â Â â””â”€override.conf
Â Â Â Â Â Active: active (running) since Sat 2021-04-10 21:58:22 UTC; 4s ago
. . .
. . .
```

å¥½çš„ï¼Œè¿™æ²¡é—®é¢˜ã€‚æ‰€ä»¥ï¼Œå¤ªæ£’äº†ï¼æˆ‘ä»¬æå®šäº†ï¼Œå®è´ï¼ä½†è¯´å®è¯ï¼Œçœ‹çœ‹`systemd.exec`æ‰‹å†Œé¡µï¼Œä½ ä¼šçœ‹åˆ°æ›´å¤šä½ å¯èƒ½ç”¨å¾—ä¸Šçš„å®‰å…¨è®¾ç½®ã€‚

æ³¨æ„

ä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä¸å°å¿ƒä½¿ç”¨äº†`sudo`æ¥æŸ¥çœ‹æœåŠ¡çŠ¶æ€ã€‚ä¹ æƒ¯æ€§åœ°åœ¨ä½¿ç”¨`systemctl`æ—¶åŠ ä¸Š`sudo`ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œå³ä½¿åœ¨ä¸éœ€è¦æ—¶ä½¿ç”¨å®ƒä¹Ÿä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ã€‚

ä»…ä¸ºå¥½ç©ï¼Œæˆ‘ä»¬å†æ·»åŠ ä¸€äº›å®‰å…¨é€‰é¡¹ï¼Œç„¶åå†æ¬¡æ£€æŸ¥å®‰å…¨çŠ¶æ€ã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ä¼šè®©æˆ‘ä»¬çš„`[Service]`éƒ¨åˆ†çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```
[Service]
ProtectHome=yes
ProtectSystem=full
PrivateDevices=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM
NoNewPrivileges=yes
```

æˆ‘ç•™ç»™ä½ å»é˜…è¯»è¿™äº›æ–°å‚æ•°çš„`systemd.exec`æ‰‹å†Œé¡µã€‚

ç¼–è¾‘å®Œæˆåï¼Œé‡æ–°å¯åŠ¨ Apacheï¼Œç¡®ä¿å®ƒèƒ½æ­£å¸¸å¯åŠ¨ã€‚ç„¶åï¼Œå†æ¬¡è¿è¡Œ`systemd-analyze security apache2.service`ã€‚ä½ åº”è¯¥ä¼šçœ‹åˆ°æ•´ä½“çš„å®‰å…¨è¯„åˆ†æ¯”ä¹‹å‰æœ‰æ‰€æå‡ã€‚

ä½ å¯ä»¥åœ¨æœåŠ¡æ–‡ä»¶ä¸­è®¾ç½®æ›´å¤šä¸å®‰å…¨ç›¸å…³çš„å‚æ•°ã€‚ä¸è¿‡è¦è®°ä½ï¼Œå¤§å¤šæ•°æœåŠ¡è¦æ±‚æŸäº›è®¾ç½®ä¿æŒåœ¨`UNSAFE`æ¨¡å¼ä¸‹æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯ï¼Œåœ¨è™šæ‹Ÿæœºä¸Šå°è¯•ä¸åŒæœåŠ¡çš„è¿™äº›è®¾ç½®ã€‚è¿™æ ·ï¼Œä½ å°±èƒ½æ¸…æ¥šåœ°äº†è§£å“ªäº›è®¾ç½®é€‚ç”¨äºä¸åŒçš„æœåŠ¡ã€‚è€Œä¸”ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œåœ¨å°†ä»»ä½•æœåŠ¡ä¿®æ”¹æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼ŒåŠ¡å¿…è¿›è¡Œå½»åº•çš„æµ‹è¯•ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å¯¹ Secure Shell æœåŠ¡è¿›è¡Œå®Œå…¨ç¼–è¾‘ã€‚

## è¿›è¡Œå®Œå…¨ç¼–è¾‘

éƒ¨åˆ†ç¼–è¾‘éå¸¸é€‚ç”¨äºå½“ä½ åªéœ€è¦æ·»åŠ ä¸€ä¸ªæœåŠ¡æ–‡ä»¶ä¸­å°šæœªå­˜åœ¨çš„å‚æ•°æ—¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ éœ€è¦åˆ é™¤ä¸€ä¸ªå‚æ•°ã€æ›´æ”¹å‚æ•°çš„å€¼ï¼Œæˆ–æ·»åŠ ä¸€ä¸ªä¸å…¶ä»–ç°æœ‰å‚æ•°å†²çªçš„å‚æ•°ï¼Œè¿™æ—¶å°±éœ€è¦è¿›è¡Œå®Œå…¨ç¼–è¾‘ã€‚è¿›è¡Œå®Œå…¨ç¼–è¾‘çš„å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œä½ å¯èƒ½å¸Œæœ›å°†æ•´ä¸ªæ–‡ä»¶å±•ç°åœ¨çœ¼å‰ï¼Œè¿™æ ·ä½ å°±èƒ½æ¸…æ¥šåœ°äº†è§£è‡ªå·±åœ¨åšä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œè¦å¯¹`ssh.service`æ–‡ä»¶è¿›è¡Œå®Œå…¨ç¼–è¾‘ï¼Œåªéœ€ä½¿ç”¨`--full`é€‰é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl edit --full ssh.service
```

è¿™æ¬¡ï¼Œä½ å°†çœ‹åˆ°æ•´ä¸ª`ssh.service`æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](img/Figure_5.2_B17491.jpg)

å›¾ 5.2 â€“ ä½¿ç”¨--full é€‰é¡¹ç¼–è¾‘æœåŠ¡æ–‡ä»¶

è¿™æ¬¡ï¼Œæˆ‘ä»¬æ¥è®¾ç½® Secure Shell æœåŠ¡çš„è®¿é—®æ§åˆ¶ã€‚

ä¸“ä¸šæç¤º

å¦‚æœä½ åœ¨ Linux åœˆå­é‡Œå¾…äº†æœ‰ä¸€æ®µæ—¶é—´ï¼Œå¯èƒ½ä¼šå¯¹`tcpwrappers`è¿™ä¸ªæ¦‚å¿µæœ‰æ‰€äº†è§£ã€‚å®ƒçš„åå­—å¾ˆå¥‡æ€ªï¼Œä½†æ¦‚å¿µå¾ˆç®€å•ã€‚ä½ åªéœ€è¦åœ¨`/etc/hosts.allow`æ–‡ä»¶ä¸­é…ç½®å¸Œæœ›å…è®¸è®¿é—®ç‰¹å®šç½‘ç»œæœåŠ¡çš„ IP åœ°å€ï¼Œç„¶ååœ¨`/etc/hosts.deny`æ–‡ä»¶ä¸­æ‹’ç»æ‰€æœ‰å…¶ä»– IP åœ°å€ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ Ubuntu ä¸­ä¾ç„¶æœ‰æ•ˆï¼Œä½† Red Hat åœ¨ RHEL 8 ä¸­å·²ç§»é™¤`tcpwrappers`ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³åœ¨ä»»ä½• RHEL 8 ç±»å‹çš„å‘è¡Œç‰ˆä¸Šé…ç½®è®¿é—®æ§åˆ¶ï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨çš„ Alma Linux 8ï¼‰ï¼Œä½ éœ€è¦é€šè¿‡é…ç½®æœåŠ¡æ–‡ä»¶æ¥å®ç°ã€‚åœ¨ Ubuntu ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»æ„ä¸€ç§æ–¹æ³•ã€‚

å‡è®¾ä½ åªæƒ³å…è®¸æ¥è‡ªä¸€å°ç‰¹å®šæ¡Œé¢æœºå™¨çš„ SSH ç™»å½•ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨`ssh.service`æ–‡ä»¶çš„`[Service]`éƒ¨åˆ†ä½¿ç”¨`IPAddressAllow=`å’Œ`IPAddressDeny=`å‚æ•°ã€‚ï¼ˆå½“ç„¶ï¼Œå¦‚æœä½ æƒ³åœ¨ Alma Linux æœºå™¨ä¸Šå°è¯•ï¼Œåº”è¯¥æ˜¯`sshd.service`æ–‡ä»¶ã€‚ï¼‰åƒæˆ‘åˆšæ‰å±•ç¤ºçš„é‚£æ ·æ‰“å¼€æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œå¹¶åœ¨`[Service]`éƒ¨åˆ†çš„æœ«å°¾æ·»åŠ ä¸¤è¡Œï¼Œä½¿ç”¨ä½ è‡ªå·±ä¸»æœºçš„ IP åœ°å€å¡«å†™`IPAddressAllow=`è¡Œã€‚è¿™ä¸¤è¡Œåº”è¯¥åƒè¿™æ ·ï¼š

```
IPAddressAllow=192.168.0.222
IPAddressDeny=any
```

æ•´ä¸ªæ–‡ä»¶ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![](img/Figure_5.3_B17491.jpg)

å›¾ 5.3 - ç¼–è¾‘åçš„ ssh.service æ–‡ä»¶

å¦‚æœä½ åªæ’å…¥`IPAddressAllow=`è¡Œï¼Œè€Œä¸æ’å…¥`IPAddressDeny=`è¡Œï¼Œä½ ä¼šå‘ç°æ²¡æœ‰ä»»ä½•ä¸œè¥¿è¢«é˜»æ­¢ã€‚å› æ­¤ï¼Œæ¯å½“ä½ æƒ³è®¾ç½®è®¿é—®ç™½åå•æ—¶ï¼Œéƒ½éœ€è¦åŒæ—¶ä½¿ç”¨è¿™ä¸¤è¡Œã€‚

ä¿å­˜æ–‡ä»¶å¹¶æ‰§è¡Œ`sudo systemctl daemon-reload`ã€‚ç„¶åï¼Œé‡å¯æˆ–é‡æ–°åŠ è½½å®‰å…¨å¤–å£³æœåŠ¡ã€‚å¦‚æœä½ ä½¿ç”¨äº†æ­£ç¡®çš„ä¸»æœº IP åœ°å€ï¼Œä½ åº”è¯¥èƒ½å¤Ÿé€šè¿‡ SSH ç™»å½•ã€‚ä¸ºäº†çœŸæ­£æµ‹è¯•è¿™ä¸ªåŠŸèƒ½ï¼Œå†æ¬¡ç¼–è¾‘æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨é”™è¯¯çš„ä¸»æœº IP åœ°å€ã€‚è¿™æ¬¡ï¼Œä½ åº”è¯¥ä¼šè¢«é˜»æ­¢è¿›è¡Œ SSH ç™»å½•ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œä½ ä¸éœ€è¦å†æ¬¡æ‰§è¡Œ`daemon-reload`å‘½ä»¤ã€‚è¿™ä¸ªæ–°è®¾ç½®åœ¨ä¿å­˜æ–‡ä»¶åä¼šç«‹å³ç”Ÿæ•ˆã€‚å› æ­¤ï¼Œå¦‚æœä½ åœ¨è¿œç¨‹æ“ä½œï¼Œå¹¶ä¸”è¾“å…¥äº†é”™è¯¯çš„ä¸»æœº IP åœ°å€ï¼Œä½ å°†ä¼šè¢«é”å®šã€‚åœ¨å®é™…æ“ä½œä¸­ï¼Œä½ éœ€è¦è¿›å…¥æœåŠ¡å™¨æœºæˆ¿ï¼Œä»æœåŠ¡å™¨çš„æœ¬åœ°ç»ˆç«¯æ­£ç¡®é…ç½®ã€‚

å½“ä½ è¿›è¡Œå®Œæ•´ç¼–è¾‘æ—¶ï¼Œä¿®æ”¹åçš„åŸå§‹æœåŠ¡æ–‡ä»¶å‰¯æœ¬å°†è¢«ä¿å­˜åˆ°`/etc/systemd/system/`ç›®å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
donnie@ubuntu20-04:~$ cd /etc/systemd/system/
donnie@ubuntu20-04:/etc/systemd/system$ ls -l ssh.service 
-rw-r--r-- 1 root root 586 Apr 11 20:07 ssh.service
donnie@ubuntu20-04:/etc/systemd/system$
```

åªè¦è¿™ä¸ªæ–‡ä»¶å­˜åœ¨ï¼Œå®ƒå°†å§‹ç»ˆè¦†ç›–`/lib/systemd/system/`ç›®å½•ä¸­çš„åŸå§‹æ–‡ä»¶ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœåŠ¡ã€‚

# åˆ›å»ºä¸€ä¸ªæ–°æœåŠ¡

è¦ä»å¤´å¼€å§‹åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœåŠ¡ï¼Œä½¿ç”¨`--force`å’Œ`--full`é€‰é¡¹ç»„åˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
donnie@ubuntu20-04:~$ sudo systemctl edit --force --full timestamp.service
```

è¿™å°†åœ¨`/etc/systemd/system/`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡æ–‡ä»¶ï¼Œæ­£å¦‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„é‚£æ ·ã€‚

åœ¨è¿™ä¸ªæ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œå°†å®šæœŸçš„æ—¶é—´æˆ³å†™å…¥æˆ‘ä»¬çš„ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€‚æˆ‘ä»¬çš„ `timestamp.service` æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

```
[Unit]
Description=Service Creation Demo
Wants=network.target
After=syslog.target network-online.target
[Service]
ExecStart=/usr/local/bin/timestamp.sh
Restart=on-failure
RestartSec=20
KillMode=process
[Install]
WantedBy=multi-user.target
```

è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° `RestartSec=` å‚æ•°ï¼Œè¿™æ˜¯æˆ‘ä»¬ä»¥å‰æ²¡æœ‰è§è¿‡çš„ã€‚å®ƒä¸ `Restart=` è¡Œä¸€èµ·å·¥ä½œï¼Œè¡¨ç¤ºåœ¨é‡å¯å´©æºƒçš„æœåŠ¡ä¹‹å‰ç­‰å¾…æŒ‡å®šçš„ç§’æ•°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®¾å®šç­‰å¾… 20 ç§’ã€‚æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ° `Type=` è¡Œï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å®ƒã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€è¡Œï¼Œ`systemd` ä¼šä½¿ç”¨é»˜è®¤çš„ `Type=simple`ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚ï¼ˆæˆ‘ç•™ç»™ä½ å»é˜…è¯» `systemd.service` æ‰‹å†Œé¡µä¸­çš„ `simple` `Type` éƒ¨åˆ†ã€‚ï¼‰

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»º `timestamp.sh` è„šæœ¬ï¼Œè¯¥è„šæœ¬æ¯ 60 ç§’å°†æ—¶é—´æˆ³å†™å…¥ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€‚è®©æˆ‘ä»¬å°†å®ƒåšæˆè¿™æ ·ï¼š

```
#!/bin/bash
echo "Starting the timestamp service" | systemd-cat -p info
while :
do
Â Â Â Â Â Â Â Â echo "timestamp.service: The current time is $(date '+%m-%d-%Y %H:%M:%S')" | systemd-cat -p info
Â Â Â Â Â Â Â Â sleep 60
done
```

å¦‚ä½ æ‰€è§ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ `while` å¾ªç¯ï¼Œå®ƒæ¯éš” 60 ç§’å°†å½“å‰æ—¶é—´ä¼ é€’ç»™ `systemd-cat` å·¥å…·ã€‚ç„¶åï¼Œ`systemd-cat` å°† `timestamp` æ¶ˆæ¯å‘é€åˆ°ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€‚`-p info` é€‰é¡¹å°†è¯¥æ¶ˆæ¯æ ‡è®°ä¸º `info` çº§åˆ«çš„ä¼˜å…ˆçº§ã€‚

æ¥ä¸‹æ¥ï¼Œä½¿è„šæœ¬æ–‡ä»¶å¯æ‰§è¡Œï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ° `/usr/local/bin/` ç›®å½•ã€‚ç„¶åï¼Œå¯åŠ¨æœåŠ¡ï¼š

```
donnie@ubuntu20-04:~$ chmod u+x timestamp.sh 
donnie@ubuntu20-04:~$ sudo cp timestamp.sh /usr/local/bin
donnie@ubuntu20-04:~$ sudo systemctl start timestamp
donnie@ubuntu20-04:~$
```

å¦‚æœä½ çœŸçš„æƒ³å¯ç”¨è¯¥æœåŠ¡ï¼Œå¯ä»¥å¯ç”¨å®ƒï¼Œä½†ç›®å‰æˆ‘ä»¬ä¸éœ€è¦å®ƒã€‚

çŠ¶æ€åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

```
donnie@ubuntu20-04:~$ systemctl status timestamp
â— timestamp.service - Service Creation Demo
Â Â Â Â Â Loaded: loaded (/etc/systemd/system/timestamp.service; disabled; vendor preset: enabled)
Â Â Â Â Â Active: active (running) since Sun 2021-04-11 21:57:26 UTC; 13min ago
Â Â Â Main PID: 14293 (timestamp.sh)
Â Â Â Â Â Â Tasks: 2 (limit: 2281)
Â Â Â Â Â Memory: 820.0K
Â Â Â Â Â CGroup: /system.slice/timestamp.service
Â Â Â Â Â Â Â Â Â Â Â Â Â â”œâ”€14293 /bin/bash /usr/local/bin/timestamp.sh
Â Â Â Â Â Â Â Â Â Â Â Â Â â””â”€14411 sleep 60
Apr 11 22:00:26 ubuntu20-04 cat[14335]: timestamp.service: The current time is 04-11-2021 22:00:26
. . .
. . .
```

è¦åœ¨æ—¥å¿—æ–‡ä»¶ä¸­æŸ¥çœ‹æ—¶é—´æˆ³ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

`donnie@ubuntu20-04:~$ journalctl -xe`

æˆ–è€…ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨ Ubuntu æœºå™¨ä¸Šæ‰§è¡Œ `sudo tail -f /var/log/syslog`ï¼Œæˆ–åœ¨ Alma æœºå™¨ä¸Šæ‰§è¡Œ `sudo tail -f /var/log/messages` æ¥å®æ—¶æŸ¥çœ‹å®ƒä»¬çš„æ·»åŠ æƒ…å†µã€‚å½“ä½ çœ‹åˆ°è¶³å¤Ÿçš„ä¿¡æ¯æ—¶ï¼Œåªéœ€æŒ‰ *Ctrl* + *C* é€€å‡ºã€‚

# æ›´æ”¹é»˜è®¤çš„ systemd ç¼–è¾‘å™¨

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä¸€ç›´åœ¨å±•ç¤ºå¦‚ä½•åœ¨ nano æ–‡æœ¬ç¼–è¾‘å™¨ä¸­å®Œæˆè¿™äº›æ“ä½œï¼Œnano æ˜¯å¤§å¤šæ•°ç°ä»£ Linux å‘è¡Œç‰ˆçš„é»˜è®¤ `systemd` ç¼–è¾‘å™¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ nanoï¼Œè€Œæƒ³ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨å‘¢ï¼Ÿå‡è®¾ä½ æœ€å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨æ˜¯ Vimï¼Œä½ æƒ³ç”¨å®ƒæ¥æ›¿ä»£ nanoã€‚

ä½¿ç”¨æ›¿ä»£æ–‡æœ¬ç¼–è¾‘å™¨çš„ä¸€ç§æ–¹æ³•æ˜¯æ¯æ¬¡è¿è¡Œ `systemctl edit` å‘½ä»¤æ—¶æŒ‡å®šæ›¿ä»£ç¼–è¾‘å™¨ï¼Œåƒè¿™æ ·ï¼š

```
[donnie@localhost ~]$ sudo EDITOR=vim systemctl edit --full sshd
[donnie@localhost ~]$
```

è¿™æ ·å¯ä»¥ï¼Œä½†æ¯æ¬¡è¿è¡Œ `systemctl edit` å‘½ä»¤æ—¶éƒ½è¿™æ ·åšå¯èƒ½ä¼šæœ‰ç‚¹éº»çƒ¦ã€‚å¹¸è¿çš„æ˜¯ï¼Œä¸€æ—¦ä½ çŸ¥é“å¦‚ä½•æ“ä½œï¼Œä¿®æ”¹é»˜è®¤ç¼–è¾‘å™¨éå¸¸ç®€å•ã€‚

é¦–å…ˆï¼Œç¼–è¾‘ä½äºä½ ä¸ªäººä¸»ç›®å½•ä¸­çš„ `.bashrc` æ–‡ä»¶ã€‚åœ¨æ–‡ä»¶çš„æœ€åº•éƒ¨ï¼Œæ·»åŠ è¿™ä¸€è¡Œï¼š

```
export SYSTEMD_EDITOR=vim
```

ä¿å­˜æ–‡ä»¶åï¼Œé‡æ–°åŠ è½½æ–°çš„é…ç½®ï¼š

```
[donnie@localhost ~]$ source .bashrc
[donnie@localhost ~]$
```

æ¥ä¸‹æ¥ï¼Œæ‰“å¼€ `sudoers` æ–‡ä»¶ï¼š

```
[donnie@localhost ~]$ sudo visudo
```

å‘ä¸‹æ»šåŠ¨åˆ°ä½ çœ‹åˆ° `Defaults` è¡Œçš„ä½ç½®ï¼Œç„¶åæ·»åŠ è¿™ä¸€è¡Œï¼š

```
DefaultsÂ Â Â env_keep += "SYSTEMD_EDITOR"
```

ä¿å­˜æ–‡ä»¶åï¼Œå°è¯•è¿è¡Œ `systemctl edit` å‘½ä»¤ã€‚ä½ ç°åœ¨åº”è¯¥çœ‹åˆ° vim è€Œä¸æ˜¯ nanoã€‚

æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸€äº›å¾ˆé…·çš„ä¸œè¥¿ï¼Œä½†æˆ‘ä»¬æ‰åˆšåˆšå¼€å§‹ã€‚ä¸ºäº†è¾¾åˆ°æè‡´çš„é…·ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ `podman` è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºå®¹å™¨æœåŠ¡æ–‡ä»¶ã€‚

# ä½¿ç”¨ podman åˆ›å»ºæ–°çš„å®¹å™¨æœåŠ¡

å®¹å™¨æŠ€æœ¯å·²ç»å­˜åœ¨å¾ˆé•¿æ—¶é—´äº†ï¼Œä½†ç›´åˆ° Docker æ¨å‡ºäº†å…¶æ–°çš„å®¹å™¨ç®¡ç†ç³»ç»Ÿï¼Œå®¹å™¨æ‰å˜å¾—éå¸¸æµè¡Œã€‚åŸå§‹çš„ Docker ç³»ç»Ÿç¡®å®å¾ˆé…·ï¼Œä½†å®ƒæœ‰ä¸€äº›ä¸è¶³ï¼Œå°¤å…¶æ˜¯åœ¨å®‰å…¨æ€§æ–¹é¢ã€‚ä¸ºæ­¤ï¼ŒRed Hat çš„å¥½å¿ƒäººå¼€å‘äº†è‡ªå·±çš„ Docker æ›¿ä»£å“ï¼Œå«åš `podman`ã€‚`podman` æä¾›äº†å¤§å¤§å¢å¼ºçš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”å…·å¤‡ Docker ä¸­æ²¡æœ‰çš„é…·åŠŸèƒ½ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯ï¼Œ`podman` ç›®å‰ä»…åœ¨ RHEL ç±»å‹å’Œ Fedora å‘è¡Œç‰ˆä¸Šå¯ç”¨ï¼Œè€Œå…¶ä»–æ‰€æœ‰äººä»ç„¶ä½¿ç”¨ Dockerã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ Alma Linux æœºå™¨ä¸Šæ¼”ç¤ºè¿™äº›æ“ä½œã€‚

è¦åœ¨ä½ çš„ Alma æœºå™¨ä¸Šå®‰è£… `podman`ï¼Œè¯·æ‰§è¡Œï¼š

```
[donnie@localhost ~]$ sudo dnf install podman-docker
```

è¿™å°†å®‰è£… `podman` åŒ…ï¼Œå¹¶é™„å¸¦ä¸€ä¸ª shell è„šæœ¬ï¼Œä»»ä½•æ—¶å€™ä½ ä¸å°å¿ƒè¾“å…¥ `docker` æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ `podman`ã€‚ï¼ˆå®é™…ä¸Šï¼Œè¿™å¯èƒ½ä¸æ˜¯å¶ç„¶çš„ã€‚ä½ å¯èƒ½æœ‰ä¸€äº› shell è„šæœ¬ä¼šè°ƒç”¨ `docker` å‘½ä»¤ï¼Œå®‰è£… `podman-docker` åŒ…å°†é¿å…ä½ ä¿®æ”¹å®ƒä»¬ä»¥ä½¿ç”¨ `podman` å‘½ä»¤ã€‚ï¼‰ä¸ºäº†é¿å…æ··æ·†ï¼Œæ¥ä¸‹æ¥çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘å°†åªå±•ç¤º `podman` å‘½ä»¤ã€‚

`podman` å·¥å…·é€šå¸¸ä¸éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¿™æ˜¯å®ƒç›¸å¯¹äº Docker çš„ä¸€ä¸ªä¼˜åŠ¿ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿å…¶æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦åœ¨ root ç”¨æˆ·è´¦æˆ·ä¸‹åˆ›å»º Docker å®¹å™¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿›å…¥ root ç”¨æˆ· shell æ¥å®Œæˆè¿™é¡¹æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨æ™®é€šç”¨æˆ· shell ä¸­æ‰§è¡Œ `sudo` æ¥è¿è¡Œ `podman` å‘½ä»¤ã€‚ç”±äºé™¤éå¿…è¦ï¼Œæˆ‘é€šå¸¸ä¸å–œæ¬¢è¿›å…¥ root shellï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨ `sudo` æ¥æ‰§è¡Œã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `wordpress` å®¹å™¨ï¼Œåƒè¿™æ ·ï¼š

```
[donnie@localhost ~]$ sudo podman run -d -p 8080:80 --name wordpress wordpress
```

WordPress æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºåšå®¢å¹³å°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥ `detached`ï¼ˆåå°ï¼‰æ¨¡å¼è¿è¡Œä¸€ä¸ª `wordpress` å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ `-d` å‚æ•°ã€‚æˆ‘ä»¬æ²¡æœ‰å°†é»˜è®¤çš„ `80` ç«¯å£æš´éœ²ç»™ç½‘ç»œï¼Œè€Œæ˜¯æš´éœ²äº† `8080` ç«¯å£ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºç«¯å£ `8080` å·²ç»æœ‰å…¶ä»–åº”ç”¨åœ¨ç›‘å¬ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œè¯·å°è¯•ä½¿ç”¨å…¶ä»–ç«¯å£ã€‚ï¼‰`--name` å‚æ•°è®¾ç½®äº†å®¹å™¨çš„åç§°ï¼Œæˆ‘ä»¬ç¨åå°†åœ¨å‘½ä»¤ä¸­ä½¿ç”¨è¯¥åç§°æ¥åˆ›å»ºæœåŠ¡æ–‡ä»¶ã€‚

æˆ‘ä»¬å°†é€šè¿‡ `sudo podman ps` æ¥éªŒè¯å®ƒæ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```
[donnie@localhost ~]$ sudo podman ps
CONTAINER IDÂ Â IMAGEÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â COMMANDÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â CREATEDÂ Â Â Â Â Â Â Â STATUSÂ Â Â Â Â Â Â Â Â Â Â Â PORTSÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â NAMES
cc06c35f21ceÂ Â docker.io/library/wordpress:latestÂ Â apache2-foregroun...Â Â 2 minutes agoÂ Â Up 2 minutes agoÂ Â 0.0.0.0:8080->80/tcpÂ Â wordpress
[donnie@localhost ~]$
```

ä½ ä¹Ÿå¯ä»¥å°è¯•ä»ä¸»æœºçš„ç½‘é¡µæµè§ˆå™¨è®¿é—® WordPressï¼Œä½†ä½ é¦–å…ˆéœ€è¦åœ¨ Alma æœºå™¨çš„é˜²ç«å¢™ä¸Šæ‰“å¼€ `8080/tcp` ç«¯å£ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```
[donnie@localhost ~]$ sudo firewall-cmd --permanent --add-port=8080/tcp
success
[donnie@localhost ~]$ sudo firewall-cmd --reload
success
[donnie@localhost ~]$
```

ç„¶åï¼Œæ‰“å¼€ä¸»æœºçš„ç½‘é¡µæµè§ˆå™¨ï¼Œè®¿é—® Alma æœºå™¨çš„ IP åœ°å€ä¸Šçš„ `8080` ç«¯å£ã€‚URL åº”è¯¥åƒè¿™æ ·ï¼š

[`192.168.0.9:8080/`](http://192.168.0.9:8080/)

è¿™åº”è¯¥ä¼šå¼¹å‡º WordPress çš„åˆå§‹ç•Œé¢ï¼Œå¼•å¯¼ä½ å®Œæˆè®¾ç½®è¿‡ç¨‹ã€‚

å¥½çš„ï¼Œè¿™å¾ˆæ£’ï¼Œä½†é—®é¢˜æ˜¯å½“ä½ é‡å¯æœºå™¨æ—¶ï¼Œå®¹å™¨ä¸ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `sudo podman generate systemd` å‘½ä»¤æ¥åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```
[donnie@localhost ~]$ sudo podman generate systemd wordpress | sudo tee /etc/systemd/system/wordpress-container.service
```

æ³¨æ„ï¼Œåœ¨ `/etc/` ç›®å½•ä¸­ï¼Œä½¿ç”¨ `sudo` è¿›è¡Œæ­£å¸¸çš„é‡å®šå‘æ“ä½œï¼ˆä½¿ç”¨ `>` ç¬¦å·ï¼‰æ•ˆæœä¸å¥½ï¼Œä½†å°†è¾“å‡ºé€šè¿‡ç®¡é“ä¼ é€’åˆ° `tee` å·¥å…·å°±èƒ½æ­£å¸¸å·¥ä½œã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œ`tee` å·¥å…·å°†è¾“å‡ºå‘é€åˆ°å±å¹•å’ŒæŒ‡å®šçš„æ–‡ä»¶ã€‚

æ‰§è¡Œ `systemctl cat wordpress-container` å°†æ˜¾ç¤ºç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶ï¼š

![](img/Figure_5.4_B17491.jpg)

å›¾ 5.4 â€“ podman ç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶

å¦‚æœè¿™è¿˜ä¸å¤Ÿé¡ºç•…ï¼Œé‚£æˆ‘å°±ä¸çŸ¥é“ä»€ä¹ˆæ‰ç®—é¡ºç•…äº†ã€‚è®©æˆ‘ä»¬å¯ç”¨è¯¥æœåŠ¡å¹¶é‡å¯ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š

```
[donnie@localhost ~]$ sudo systemctl daemon-reload
[donnie@localhost ~]$ sudo systemctl enable wordpress-container
Created symlink /etc/systemd/system/multi-user.target.wants/wordpress-container.service â†’ /etc/systemd/system/wordpress-container.service.
Created symlink /etc/systemd/system/default.target.wants/wordpress-container.service â†’ /etc/systemd/system/wordpress-container.service.
[donnie@localhost ~]$ sudo shutdown -r now
```

é‡å¯å®Œæˆåï¼Œæ‰§è¡Œ `sudo podman ps` å‘½ä»¤åº”è¯¥ä¼šæ˜¾ç¤ºå®¹å™¨æ­£åœ¨è¿è¡Œï¼š

```
[donnie@localhost ~]$ sudo podman ps
[sudo] password for donnie: 
CONTAINER IDÂ Â IMAGEÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â COMMANDÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â CREATEDÂ Â Â Â Â Â Â Â Â STATUSÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PORTS Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â NAMES
cc06c35f21ceÂ Â docker.io/library/wordpress:latestÂ Â apache2-foregroun...Â Â 12 minutes agoÂ Â Up About a minute agoÂ Â 0.0.0.0:8080->80/tcpÂ Â wordpress
[donnie@localhost ~]$
```

ï¼ˆä½ è¿™é‡Œåªéœ€è¦ä½¿ç”¨ `sudo`ï¼Œå› ä¸ºå®¹å™¨æ˜¯åœ¨ root ç”¨æˆ·è´¦æˆ·ä¸‹è¿è¡Œçš„ã€‚ï¼‰

å½“ç„¶ï¼Œ`systemctl status` ä¹Ÿåº”è¯¥æ˜¾ç¤ºè¯¥æœåŠ¡æ­£åœ¨è¿è¡Œï¼š

```
[donnie@localhost ~]$ systemctl status wordpress-container
â— wordpress-container.service - Podman container-cc06c35f21cedd4d2384cf2c048f013748e84cabdc594b110a8c8529173f4c81.service
Â Â Â Loaded: loaded (/etc/systemd/system/wordpress-container.service; enabled; vendor preset: disabled)
Â Â Â Active: active (running) since Wed 2021-04-14 15:27:37 EDT; 2min 38s ago
. . .
. . .
```

å¥½çš„ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ éœ€è¦åˆ›å»ºä¸€ä¸ªå®¹å™¨æœåŠ¡ï¼Œå¹¶å¸Œæœ›ä»ä½ è‡ªå·±çš„ç”¨æˆ·è´¦æˆ·è¿è¡Œï¼Œè€Œä¸éœ€è¦æ ¹æƒé™å‘¢ï¼Ÿå¥½å§ï¼Œæˆ‘ä»¬ä¹Ÿä¸ºä½ æä¾›äº†è¿™ç§æ–¹æ³•ã€‚åªéœ€åœ¨ä½ è‡ªå·±çš„ä¸»ç›®å½•ä¸­åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼Œå¹¶ä»é‚£é‡Œè¿è¡Œã€‚

æˆ‘ä»¬å°†åƒä¹‹å‰ä¸€æ ·å¼€å§‹ï¼Œåªæ˜¯ä½¿ç”¨ä¸åŒçš„å®¹å™¨åç§°ï¼Œå¹¶ä»æ­£å¸¸çš„ç”¨æˆ· shell ä¸­å¯åŠ¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
[donnie@localhost ~]$ podman run -d -p 9080:80 --name wordpress-noroot wordpress
```

è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨äº†ä¸åŒçš„ç½‘ç»œç«¯å£ï¼Œä»¥é¿å…ä¸ä¹‹å‰çš„è®¾ç½®å†²çªã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœæ­¢å®¹å™¨ï¼š

```
[donnie@localhost ~]$ podman container stop wordpress-noroot
a6e2117dd4d5148d01a55d64ad8753c03436bfd9a573435e95d927f74 dc48f9e
[donnie@localhost ~]$
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ç”¨æˆ·çš„æ­£å¸¸ä¸»ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼š

```
[donnie@localhost ~]$ mkdir -p .config/systemd/user/
[donnie@localhost ~]$
```

æˆ‘ä»¬å°†ç”ŸæˆæœåŠ¡æ–‡ä»¶ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ï¼š

```
[donnie@localhost ~]$ podman generate systemd wordpress-noroot > .config/systemd/user/wordpress-noroot.service
[donnie@localhost ~]$
```

æˆ‘ä¹‹å‰å¿˜äº†æåˆ°ï¼Œè¿™äº›ç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶åœ¨ `[Install]` éƒ¨åˆ†æœ‰ä¸€ä¸ªå°çš„ä¸åŒã€‚ä½ å°†çœ‹åˆ°ä¸¤ä¸ªç›®æ ‡ï¼Œè€Œä¸æ˜¯åªæœ‰ä¸€ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
. . .
. . .
[Install]
WantedBy=multi-user.target default.target
```

`Default.target` æ˜¯åœ¨ä½ å¸Œæœ›ä»è‡ªå·±çš„ç”¨æˆ·è´¦æˆ·è¿è¡ŒæœåŠ¡æ—¶éœ€è¦ä½¿ç”¨çš„ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œç®¡ç†å‘½ä»¤å¤§è‡´ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ä½ ä¸éœ€è¦ä½¿ç”¨ `sudo`ï¼Œè€Œä¸”éœ€è¦ä½¿ç”¨ `--user` é€‰é¡¹æ¥å‘Šè¯‰ `systemd` æœåŠ¡å•å…ƒæ–‡ä»¶ä½äºä½ è‡ªå·±çš„ä¸»ç›®å½•ä¸­ã€‚è®©æˆ‘ä»¬åŠ è½½æ–°çš„æœåŠ¡æ–‡ä»¶å¹¶æ£€æŸ¥çŠ¶æ€ï¼š

```
[donnie@localhost ~]$ systemctl --user daemon-reload
[donnie@localhost ~]$ systemctl --user status wordpress-noroot
â— wordpress-noroot.service - Podman container-a6e2117dd4d5148d01a55d64ad8753c03436bfd9a573435e95d927f74dc48f9e.service
Â Â Â Loaded: loaded (/home/donnie/.config/systemd/user/wordpress-noroot.service; disabled; vendor preset: enabled)
Â Â Â Active: inactive (dead)
. . .
. . .
```

è®©æˆ‘ä»¬å¯ç”¨å®ƒå¹¶å¯åŠ¨ï¼Œç„¶åå†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼š

```
[donnie@localhost ~]$ systemctl --user enable --now wordpress-noroot
Created symlink /home/donnie/.config/systemd/user/multi-user.target.wants/wordpress-noroot.service â†’ /home/donnie/.config/systemd/user/wordpress-noroot.service.
Created symlink /home/donnie/.config/systemd/user/default.target.wants/wordpress-noroot.service â†’ /home/donnie/.config/systemd/user/wordpress-noroot.service.
[donnie@localhost ~]$ systemctl --user status wordpress-noroot
â— wordpress-noroot.service - Podman container-a6e2117dd4d5148d01a55d64ad8753c03436bfd9a573435e95d927f74dc48f9e.service
Â Â Â Loaded: loaded (/home/donnie/.config/systemd/user/wordpress-noroot.service; enabled; vendor preset: enabled)
Â Â Â Active: active (running) since Wed 2021-04-14 15:44:26 EDT; 12s ago
. . .
. . .
```

å¦‚æœä½ æ‹¥æœ‰æ ¹æƒé™ï¼Œå¯ä»¥åœ¨é˜²ç«å¢™ä¸Šæ‰“å¼€ç«¯å£ `9080/tcp`ï¼Œå¹¶ä»å¤–éƒ¨æœºå™¨è®¿é—® WordPressï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰åšçš„é‚£æ ·ã€‚

ç›®å‰ï¼Œæˆ‘ä»¬çš„æ— æ ¹ WordPress æœåŠ¡åœ¨å¯åŠ¨æœºå™¨æ—¶ä¸ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚ä½†å®ƒä¼šåœ¨ä½ ç™»å½•æœºå™¨æ—¶å¯åŠ¨ï¼Œå¹¶åœ¨ä½ ç™»å‡ºæ—¶åœæ­¢ã€‚é€šè¿‡å¯¹ä½ è‡ªå·±çš„ç”¨æˆ·è´¦æˆ·æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š

```
[donnie@localhost ~]$ loginctl enable-linger donnie
[donnie@localhost ~]$
```

ç°åœ¨ï¼Œå®¹å™¨æœåŠ¡å°†åœ¨æˆ‘ç™»å‡ºæ—¶ç»§ç»­è¿è¡Œï¼Œå¹¶ä¸”åœ¨æˆ‘é‡å¯æœºå™¨æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚

# æ€»ç»“

åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ç¼–è¾‘å’Œåˆ›å»ºæœåŠ¡å•å…ƒæ–‡ä»¶ã€‚è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¯ä»¥è®¾ç½®çš„å„ç§å‚æ•°ï¼ŒåŒ…æ‹¬ä¸€äº›ä¸å®‰å…¨ç›¸å…³çš„å‚æ•°ã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°ï¼Œåœ¨å°†ä»»ä½•ä¿®æ”¹æŠ•å…¥ç”Ÿäº§ä¹‹å‰ï¼Œæµ‹è¯•æœåŠ¡æ–‡ä»¶çš„æ›´æ”¹æ˜¯éå¸¸é‡è¦çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä¸€ç›´å¼ºè°ƒçš„é‚£ä¸€ç‚¹æ˜¯ï¼ŒæŒæ¡å¦‚ä½•ä½¿ç”¨`systemd`æ‰‹å†Œé¡µçš„é‡è¦æ€§ã€‚

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†è®¨è®º`systemd`ç›®æ ‡ã€‚åˆ°æ—¶å€™è§ã€‚

# é—®é¢˜

1.  å¦‚ä½•å¯¹`ssh.service`æ–‡ä»¶è¿›è¡Œéƒ¨åˆ†ç¼–è¾‘ï¼Ÿ

    a) `sudo systemctl edit --partial ssh.service`

    b) `sudo systemctl edit ssh.service`

    c) `sudo systemedit ssh.service`

    d) `sudo systemedit --partial ssh.service`

1.  å¦‚ä½•åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœåŠ¡ï¼Ÿ

    a) `sudo systemctl edit --new newservice.service`

    b) `sudo systemctl edit --full newservice.service`

    c) `sudo systemctl edit --full --force newservice.service`

    d) `sudo systemctl edit newservice.service`

1.  å¦‚ä½•ä¸ºæœåŠ¡åˆ›å»ºè®¿é—®ç™½åå•ï¼Ÿ

    a) åªéœ€åœ¨`[Service]`éƒ¨åˆ†æ’å…¥`IPAddressAllow=`æŒ‡ä»¤ã€‚

    b) åœ¨`[Service]`éƒ¨åˆ†åŒæ—¶æ’å…¥`IPAddressAllow=`æŒ‡ä»¤å’Œ`IPAddressDeny=`æŒ‡ä»¤ã€‚

    c) åªéœ€åœ¨`[Unit]`éƒ¨åˆ†æ’å…¥`IPAddressAllow=`æŒ‡ä»¤ã€‚

    d) åœ¨`[Unit]`éƒ¨åˆ†åŒæ—¶æ’å…¥`IPAddressAllow=`æŒ‡ä»¤å’Œ`IPAddressDeny=`æŒ‡ä»¤ã€‚

# ç­”æ¡ˆ

b

c

b

# è¿›ä¸€æ­¥é˜…è¯»

+   å¦‚ä½•åˆ›å»º`systemd`æœåŠ¡æ–‡ä»¶ï¼š[`linuxconfig.org/how-to-create-systemd-service-unit-in-linux`](https://linuxconfig.org/how-to-create-systemd-service-unit-in-linux)

+   ä¿æŠ¤å’Œæ²™ç›’åŒ–åº”ç”¨ç¨‹åºåŠæœåŠ¡ï¼š[`www.redhat.com/sysadmin/mastering-systemd`](https://www.redhat.com/sysadmin/mastering-systemd)

+   ä½¿ç”¨`systemd`å•å…ƒæ–‡ä»¶ç®¡ç†`podman`å®¹å™¨ï¼š[`youtu.be/AGkM2jGT61Y`](https://youtu.be/AGkM2jGT61Y)
