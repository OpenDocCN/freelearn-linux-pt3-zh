<html><head></head><body>
<div class="_idGenObjectStyleOverride-1" id="_idContainer361">
<p class="Chapter-Title" id="_idParaDest-247" lang="en-US" xml:lang="en-US"><span class="ChapterMarker"><span class="koboSpan" id="kobo.1.1">28. </span></span><a id="_idTextAnchor420"/><span class="koboSpan" id="kobo.2.1">Managing KVM using the virsh Command-Line Tool</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3.1">In previous chapters, we have covered the installation and configuration of KVM-based guest operating systems on Ubuntu. </span><span class="koboSpan" id="kobo.3.2">This chapter explores additional areas of the </span><a id="_idIndexMarker627"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.4.1">virsh</span></span><span class="koboSpan" id="kobo.5.1"> tool that have not been covered in previous chapters and how it may be used to manage KVM-based guest operating systems from the command line. </span></p>
<p class="Heading-1-1" id="_idParaDest-248" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.6.1">28.1 </span></span><a id="_idTextAnchor421"/><span class="koboSpan" id="kobo.7.1">The virsh Shell and Command-Line</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.8.1">The virsh tool is both a command-line tool and an interactive shell environment. </span><span class="koboSpan" id="kobo.8.2">When used in the command-line mode, the command is issued at the command prompt with sets of arguments appropriate to the task.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.9.1">To use the options as command-line arguments, use them at a terminal command prompt, as shown in the following example: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.10.1"># virsh &lt;option&gt;</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.11.1">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.12.1">virsh</span></span><span class="koboSpan" id="kobo.13.1"> tool, when used in shell mode, provides an interactive environment from which to issue sequences of commands.</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.14.1">To run commands in the </span><a id="_idIndexMarker628"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.15.1">virsh</span></span><span class="koboSpan" id="kobo.16.1"> shell, run the following command: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.17.1"># virsh</span></p>
<p class="Code"><span class="koboSpan" id="kobo.18.1">Welcome to virsh, the virtualization interactive terminal.</span></p>
<p class="Code"><span class="koboSpan" id="kobo.19.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.20.1">Type:  'help' for help with commands</span></p>
<p class="Code"><span class="koboSpan" id="kobo.21.1">       'quit' to quit</span></p>
<p class="Code"><span class="koboSpan" id="kobo.22.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.23.1">virsh #</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.24.1">At the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.25.1">virsh</span></span><span class="koboSpan" id="kobo.26.1"> # prompt, enter the options you wish to run. </span><span class="koboSpan" id="kobo.26.2">The following </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.27.1">virsh</span></span><span class="koboSpan" id="kobo.28.1"> session, for example, lists the current virtual machines, starts a virtual machine named FedoraVM, and then obtains another listing to verify the VM is running: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.29.1"># virsh </span></p>
<p class="Code"><span class="koboSpan" id="kobo.30.1">Welcome to virsh, the virtualization interactive terminal.</span></p>
<p class="Code"><span class="koboSpan" id="kobo.31.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.32.1">Type:  'help' for help with commands</span></p>
<p class="Code"><span class="koboSpan" id="kobo.33.1">       'quit' to quit</span></p>
<p class="Code"><span class="koboSpan" id="kobo.34.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.35.1">virsh # list</span></p>
<p class="Code"><span class="koboSpan" id="kobo.36.1"> Id    Name                           State</span></p>
<p class="Code"><span class="koboSpan" id="kobo.37.1">----------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.38.1"> 8     RHEL9VM                       running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.39.1"> 9     CentOS9VM                     running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.40.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.41.1">virsh # start FedoraVM</span></p>
<p class="Code"><span class="koboSpan" id="kobo.42.1">Domain FedoraVM started</span></p>
<p class="Code"><span class="koboSpan" id="kobo.43.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.44.1">virsh # list</span></p>
<p class="Code"><span class="koboSpan" id="kobo.45.1"> Id    Name                           State</span></p>
<p class="Code"><span class="koboSpan" id="kobo.46.1">----------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.47.1"> 8     RHEL9VM                       running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.48.1"> 9     CentOS9VM                     running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.49.1">10     FedoraVM                      running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.50.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.51.1">virsh#</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.52.1">The </span><a id="_idIndexMarker629"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.53.1">virsh</span></span><span class="koboSpan" id="kobo.54.1"> tool supports a wide range of commands, a complete listing of which may be obtained using the help option:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.55.1"># virsh help</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.56.1">Additional details on the syntax for each command may be obtained by specifying the command after the help directive:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.57.1"># virsh help restore</span></p>
<p class="Code"><span class="koboSpan" id="kobo.58.1">  NAME</span></p>
<p class="Code"><span class="koboSpan" id="kobo.59.1">    restore - restore a domain from a saved state in a file</span></p>
<p class="Code"><span class="koboSpan" id="kobo.60.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.61.1">  SYNOPSIS</span></p>
<p class="Code"><span class="koboSpan" id="kobo.62.1">    restore &lt;file&gt; [--bypass-cache] [--xml &lt;string&gt;] [--running] [--paused]</span></p>
<p class="Code"><span class="koboSpan" id="kobo.63.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.64.1">  DESCRIPTION</span></p>
<p class="Code"><span class="koboSpan" id="kobo.65.1">    Restore a domain.</span></p>
<p class="Code"><span class="koboSpan" id="kobo.66.1"> </span></p>
<p class="Code"><span class="koboSpan" id="kobo.67.1">  OPTIONS</span></p>
<p class="Code"><span class="koboSpan" id="kobo.68.1">    [--file] &lt;string&gt;  the state to restore</span></p>
<p class="Code"><span class="koboSpan" id="kobo.69.1">    --bypass-cache   avoid file system cache when restoring</span></p>
<p class="Code"><span class="koboSpan" id="kobo.70.1">    --xml &lt;string&gt;   filename containing updated XML for the target</span></p>
<p class="Code"><span class="koboSpan" id="kobo.71.1">    --running        restore domain into running state</span></p>
<p class="Code"><span class="koboSpan" id="kobo.72.1">    --paused         restore domain into paused state</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.73.1">In the remainder of this chapter, we will look at some of these commands in more detail.</span></p>
<p class="Heading-1-1" id="_idParaDest-249" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.74.1">28.2 </span></span><a id="_idTextAnchor422"/><span class="koboSpan" id="kobo.75.1">Listing Guest System Status </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.76.1">The status of the guest systems on an Ubuntu virtualization host may be viewed at any time using the list option of the </span><a id="_idIndexMarker630"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.77.1">virsh</span></span><span class="koboSpan" id="kobo.78.1"> tool. </span><span class="koboSpan" id="kobo.78.2">For example: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.79.1"># virsh list</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">The above command will display output containing a line for each guest similar to the following: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.81.1">virsh # list</span></p>
<p class="Code"><span class="koboSpan" id="kobo.82.1"> Id    Name                           State</span></p>
<p class="Code"><span class="koboSpan" id="kobo.83.1">----------------------------------------------------</span></p>
<p class="Code"><span class="koboSpan" id="kobo.84.1"> 8     RHEL9VM                       running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.85.1"> 9     CentOS9VM                     running</span></p>
<p class="Code"><span class="koboSpan" id="kobo.86.1">10     FedoraVM                      running</span></p>
<p class="Heading-1-1" id="_idParaDest-250" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.87.1">28.3 </span></span><a id="_idTextAnchor423"/><span class="koboSpan" id="kobo.88.1">Starting a Guest System </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.89.1">A guest operating system can be started using the </span><a id="_idIndexMarker631"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.90.1">virsh</span></span><span class="koboSpan" id="kobo.91.1"> tool combined with the start option followed by the name of the guest operating system to be launched. </span><span class="koboSpan" id="kobo.91.2">For example: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.92.1"># virsh start myGuestOS</span></p>
<p class="Heading-1-1" id="_idParaDest-251" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.93.1">28.4 </span></span><a id="_idTextAnchor424"/><span class="koboSpan" id="kobo.94.1">Shutting Down a Guest System </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.95.1">The shutdown option of the </span><a id="_idIndexMarker632"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.96.1">virsh</span></span><span class="koboSpan" id="kobo.97.1"> tool, as the name suggests, is used to shut down a guest operating system: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.98.1"># virsh shutdown guestName</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.99.1">Note that the shutdown option allows the guest operating system to perform an orderly shutdown when it receives the instruction. </span><span class="koboSpan" id="kobo.99.2">To instantly stop a guest operating system, the </span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.100.1">destroy option may be used (with the risk of file system damage and data loss): </span></p>
<p class="Code"><span class="koboSpan" id="kobo.101.1"># virsh destroy guestName</span></p>
<p class="Heading-1-1" id="_idParaDest-252" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.102.1">28.5 </span></span><a id="_idTextAnchor425"/><span class="koboSpan" id="kobo.103.1">Suspending and Resuming a Guest System </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.104.1">A guest system can be suspended and resumed using the </span><a id="_idIndexMarker634"/><a id="_idIndexMarker635"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.105.1">virsh</span></span><span class="koboSpan" id="kobo.106.1"> tool’s suspend and resume options. </span><span class="koboSpan" id="kobo.106.2">For example, to suspend a specific system: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.107.1"># virsh suspend guestName</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.108.1">Similarly, to resume the paused system: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.109.1"># virsh resume guestName</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.110.1">A suspended session will be lost if the host system is rebooted. </span><span class="koboSpan" id="kobo.110.2">Also, be aware that a suspended system continues to reside in memory. </span><span class="koboSpan" id="kobo.110.3">Therefore, to save a session such that it no longer takes up memory and can be restored to its exact state (even after a reboot), it is necessary to save and restore the guest. </span></p>
<p class="Heading-1-1" id="_idParaDest-253" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.111.1">28.6 </span></span><a id="_idTextAnchor426"/><span class="koboSpan" id="kobo.112.1">Saving and Restoring Guest Systems </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.113.1">A running guest operating system can be saved and restored using the </span><a id="_idIndexMarker636"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.114.1">virsh</span></span><span class="koboSpan" id="kobo.115.1"> utility. </span><span class="koboSpan" id="kobo.115.2">When saved, the current status of the guest operating system is written to disk and removed from system memory. </span><span class="koboSpan" id="kobo.115.3">A saved system may subsequently be restored at any time (including after a host system reboot).</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.116.1">To save a guest: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.117.1"># virsh save guestName path_to_save_file</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.118.1">To </span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.119.1">restore a saved guest operating system session:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.120.1"># virsh restore path_to_save_file</span></p>
<p class="Heading-1-1" id="_idParaDest-254" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.121.1">28.7 </span></span><a id="_idTextAnchor427"/><span class="koboSpan" id="kobo.122.1">Rebooting a Guest System </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.123.1">To </span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.124.1">reboot a guest operating system: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.125.1"># virsh reboot guestName</span></p>
<p class="Heading-1-1" id="_idParaDest-255" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.126.1">28.8 </span></span><a id="_idTextAnchor428"/><span class="koboSpan" id="kobo.127.1">Configuring the Memory Assigned to a Guest OS </span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.128.1">To configure the memory assigned to a guest OS, use the </span><a id="_idIndexMarker639"/><a id="_idIndexMarker640"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.129.1">setmem</span></span><span class="koboSpan" id="kobo.130.1"> option of the virsh command. </span><span class="koboSpan" id="kobo.130.2">For example, the following command reduces the memory allocated to a guest system to 256MB: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.131.1"># virsh setmem guestName 256</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.132.1">Note that acceptable memory settings must fall within the memory available to the current Domain. </span><span class="koboSpan" id="kobo.132.2">This may be increased using the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.133.1">setmaxme</span></span><span class="koboSpan" id="kobo.134.1">m option. </span></p>
<p class="Heading-1-1" id="_idParaDest-256" lang="en-US" xml:lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.135.1">28.9 </span></span><a id="_idTextAnchor429"/><span class="koboSpan" id="kobo.136.1">Summary</span></p>
<p class="My-Basic-Paragraph" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.137.1">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.138.1">virsh</span></span><span class="koboSpan" id="kobo.139.1"> tool provides various options for creating, monitoring, and managing guest virtual machines. </span><span class="koboSpan" id="kobo.139.2">As outlined in this chapter, the tool can be used in either command-line or interactive modes.</span></p>
</div>
</body></html>