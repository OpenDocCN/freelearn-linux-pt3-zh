# 6

# 在命令行上编辑文件

在命令行上编辑文本常常是生产系统的硬性要求，因为这些系统通常缺乏图形用户界面。然而，即使在没有这些系统的情况下，熟练掌握命令行文本编辑也有很多好处——实际上，即使你有图形化文本编辑器或**集成开发环境**（**IDEs**）可用。

例如，许多功能齐全的文本编辑器和 IDE 都支持本章中你将学到的模式，这意味着你获得的速度和效率是可以转移到其他工具上的。事实上，你可以在所有种类的工作中使用本章中学到的快捷键，从快速查找和替换文本到在长长的 shell 命令中更正拼写错误。

你甚至可能会发现你最喜欢的工具（有时通过插件）内置了类似的快捷键；例如，通过几次 Google 搜索，你就能发现支持 vim 键盘快捷键的电子邮件客户端、浏览器插件和 Web 应用程序，而这些快捷键你将在本章后面学到。

学会以这些简约、纯文本界面所要求的高效模式进行思考，可以帮助你找到更高效的方式完成你每天必须做的事情，避免你在可以通过几次按键就完成任务时，浪费时间一遍又一遍地点击图形菜单或向导。

**注意**

许多极其简约（或高度安全）的环境也倾向于将文本编辑器从生产镜像中移除，尽管这并不能提高安全性（`cat`、`echo`、`mv` 和输入/输出重定向足以在紧急情况下临时充当一个可用的文本编辑器）。你——就像世界各地的黑客一样——很可能会在你的一生中在许多 Docker 容器中安装 nano 或 vim。

在本章中，你将学习两款文本编辑器的基础知识：我们认为最容易入门的一款（nano），以及我们认为对你职业生涯最有长期投资价值的一款（vim）。你将了解 Linux 中命令行文本编辑的基本背景，深入学习 nano 和 vim，最后，学习如何避免最常见的编辑错误。我们还将展示如何调整你的 shell 以便在可能的情况下自动使用你首选的编辑器。

# Nano

Nano 是一个小巧且易于使用的命令行文本编辑器。Nano 的一个特点——你甚至可以称它为主要特点——是它会在你愉快地在终端中编辑文本时，在屏幕底部突出显示键盘快捷键备忘单。这在你感到压力山大且不习惯在命令行中编辑文本时尤其有用。

Nano 在紧急情况下很好用，但你不会在更多的简约环境中找到它（例如 Docker 容器或生产虚拟机）。需要注意的是，nano 还倾向于自动创建备份文件（`~yourfile.txt`），从而可能污染文件系统。

## 安装 nano

在你可能使用的所有流行 Linux 发行版中，nano 的包名是`nano`——使用你偏好的操作系统的包管理器来安装它（在这里，我们是在 Ubuntu 上安装它）：

```
apt-get install nano 
```

## Nano 备忘单

你可以在这里找到一个官方的、最新的 nano 备忘单：[`www.nano-editor.org/dist/latest/cheatsheet.html`](https://www.nano-editor.org/dist/latest/cheatsheet.html)

以下章节中列出了最有用的命令。

### 文件处理

+   *Ctrl*+*S*：保存当前文件

+   *Ctrl*+*O*：提供写入文件的选项（“另存为”）

+   *Ctrl*+*R*：将文件插入到当前文件中

+   *Ctrl*+*X*：关闭缓冲区，退出 nano

### 编辑

+   *Ctrl*+*K*：将当前行剪切到剪切缓冲区

+   *Ctrl*+*U*：粘贴剪切缓冲区中的内容

+   *Alt*+*3*：注释/取消注释一行/区域

+   *Alt*+*U*：撤销上一步操作

+   *Alt*+*E*：重做上一步撤销的操作

### 查找与替换

+   *Ctrl*+*Q*：开始向后查找

+   *Ctrl*+*W*：开始向前查找

+   *Alt*+*Q*：查找上一个出现的位置

+   *Alt*+*W*：查找下一个出现的位置

+   *Alt*+*R*：开始替换操作

# Vi(m)

Vi（通常被称为 ex-vi 或 nvi）是一个命令行文本编辑器。Vim（vi iMproved）是一个扩展版本，很多人将它作为整个 IDE 使用。vi 和 vim 共享相同的基本命令和键盘绑定，所以只要你学会了基础，无论登录什么样的古老或现代系统，你都能应对自如。

温馨提示：vim 很复杂，学习曲线较陡。可能需要几周的业余时间来学习和实验，才能感到熟练——这就像是设置第一个 Linux 网页服务器或编写第一个 500 行的程序一样。

学习 vim 的一个奇妙之处在于，你可以在笔记本电脑上本地使用它，或者在没有图形界面的远程服务器上使用，它们的编辑体验是相同的——都非常高效美观。为了有效使用它，心态的转变和对其词汇（我们将要介绍的*命令*和*模式*）的理解非常重要。

像学习其他任何技能一样，一些专注的练习和持续使用编辑器是建立理解并感到舒适的关键。刚开始可能会遇到一些困难和困惑，这很正常。请不要让这些影响你的学习进程！

Vim 是一个模式编辑器，这意味着相同的按键在不同的“模式”下执行不同的操作。例如，当你处于插入模式时，你按下的键将直接写入你正在编辑的文件（或缓冲区）——就像你在使用 IDE 或 Microsoft Word 一样。然而，在普通模式下，按下相同的字母键会执行与之绑定的命令。一旦你适应了这一点——**模式编辑**——剩下的 vi/vim 内容就是不断的练习。

例如，如果你启动 vim 并连续输入两个小写的*i*，第一个*i*将进入插入模式，而第二个*i*将实际在编辑窗口（缓冲区）中写入*i*字符。如果现在听起来很混乱，没关系。即使你从不打算将 vim 作为常规 IDE 使用，到本章结束时，你对其基础知识也会感到更加熟悉。

**注意**

值得一提的是，在撰写本书时，另一个类似 vim 的编辑器 nvim（neovim）开始逐渐流行起来。大部分适用于 vim 的内容也同样适用于 nvim，所以不必担心从 vim 转到 neovim。它们主要的区别在于插件开发，因此如果你决定以后从 vim 转到 neovim，你不会失去任何东西。

## Vi/vim 命令

这里有一些基本的 vi(m)命令 – 在使用这些命令前，请先按下*Escape*键确保你处于普通模式。

## 模式

+   *v* – 进入可视模式。这个功能只存在于 vim（而不是 vi），初学者可能会过度使用，因为它对从其他编辑器过来的人来说更加熟悉。

+   *ESC* — 退出当前模式并进入普通模式，可以执行命令。

### 命令模式

可以通过在普通模式中按下*Escape*键，然后键入冒号（`:`）进入命令模式。为了清晰起见，下面的命令中包含了冒号。

#### 助手

+   `:set number` – 显示行号。

+   `:set paste` – 如果你想粘贴内容到 vim 中且不希望其影响缩进，这很有帮助。你可以用`:set nopaste`再次禁用它。

#### 退出

+   `:q` – 退出

+   `:q!` – 不保存退出（强制退出）

+   `:w` – 写入（保存）文件

+   `:wq` – 写入并退出

+   `:wqa` – 仅适用于 vim；在多个窗格打开时有帮助，比如插件在侧边打开文件浏览器时

### 普通模式

普通模式是你启动 vim 时的模式，在输入任何内容之前都是如此。你可以随时通过按下*Escape*键返回普通模式。

#### 导航

+   *k* – 向上移动

+   *j* – 向下移动

+   *l* – 向右移动

+   *h* – 向左移动

另外，也可以使用箭头键，但考虑使用 vi 快捷键会更有帮助，而不是像普通编辑器一样操作 vi(m)。我们发现在练习时坚持使用 vi 的移动键会更有效。

+   *w* – 移动到下一个单词

+   *b* – 移动到当前单词或前一个单词的开头

+   *^* 或 *0* – 移动到行首

+   *$* – 移动到行尾

+   *gg* – 移动到文件开头

+   *G* – 移动到文件末尾

#### 编辑

+   *i* – 进入插入模式（写入实际文本）。*I* 在行首插入。

+   *a* – 插入文本，在光标后添加。*A* 在当前行的末尾添加。

+   *o* – 打开新行（*O* 在当前行之前打开新行）

+   */* – 搜索模式（支持正则表达式；使用*ENTER*进行搜索，*n*和*SHIFT*+*n*循环前进或后退搜索结果）。

+   *dd* – 删除（并剪切）当前行。

+   *y* – 复制选中的文本（yank）

+   *yy* – 复制当前行。

+   *p* – 将文本粘贴到光标后。

+   *u* – 撤销上一次更改。

+   *CTRL*+*R* – 重做。

+   *nX* – 其中*n*是数字，*X*是命令，将执行*X n*次。例如，*3dd*将删除三行。

## 学习 vi(m)的技巧

在几周的正常编辑任务中，你可以变得相当熟悉 vim。尽管如此，刚开始时并不容易。以下是我们使旅程更顺畅的建议。

### 使用 vimtutor

Vim 自带了一个内置教程。如果你想开始使用 vim，这可能是你首先要做的事情。只需在命令行中运行`vimtutor`来打开 vim 和教程。

### 通过助记符来思考

在使用 vi(m)编辑文件时，通常会用你上面看到的命令来“构建句子”。例如，`d2w`表示“删除两个单词”。虽然我们尽力在上面的命令列表中提到合适的单词，但不同的人有不同的思维方式，所以不要害怕建立你自己的词汇。

### 避免使用箭头键

避免使用箭头键，并考虑禁用此功能。这可以避免你把 vim 当作另一个编辑器来使用，并减少你适应其标准键绑定所需的时间。别担心；虽然刚开始时可能会觉得奇怪，但你会在几次使用后习惯基本的 vim 键绑定。

### 避免使用鼠标

尽管 vim 可以用鼠标进行可视化选择，但最好抵制这个诱惑，并继续训练你的键盘快捷键的工作记忆。否则，你会在两者之间反复切换，在关键时刻（比如凌晨三点在没有鼠标输入的远程服务器上排除故障时）会感到不适应。

### 不要使用 gvim

尽管 gvim（图形化/GUI vim）在某些情况下很有用，但在没有合适终端的情况下，使用其图形快捷键并不是一个好主意。vi(m)的好处在于，当没有图形环境时，它可以通过键盘高效地进行文本操作——就像你在读完这本书后将要排查的许多 Linux 服务器一样！

### 避免从大量配置或插件开始

一个典型的初学者错误是从别人的 vim 配置开始。虽然它们一开始看起来很有用，但高度自定义的 vim 设置会在你刚开始学习基本概念时阻碍你。大量的配置并不会神奇地让你变得更高效，尤其是在刚开始的时候。一旦你变得更自信，你会发现自己开始编写自己的配置。

另一个需要避免的事情是过度使用插件，尤其是在刚开始时。插件偶尔会导致一些问题，这可能会成为负担并引发更多问题。刚开始使用 vim 时，解决插件相关问题不是你想要处理的事情。第三方配置文件和插件确实非常有用，但它们也可能成为一种依赖：当你突然进入一个不同于开发环境的环境时，你将无法依赖那些炫酷的东西。如果你已经过于依赖定制化的工作流程，即使是基本的编辑也可能变得困难且令人沮丧，尤其是在压力下。

更为明智的做法是从一个简洁的配置开始，只添加你完全理解的部分（并且确保你确实需要）。你将更多的时间用于实际在项目中使用编辑器，因为这能帮助你记住最重要的 vim 快捷键并保持在工作记忆中。虽然需要一些时间，但最终你会不假思索地使用它们，而是通过你为自己编制的助记符来思考。

这里有一个简洁的 vim 配置示例，适合初学者使用。你可以随意修改，或者挑选看起来有用的部分。

将以下内容添加到你的 `$HOME/.vimrc` 中：

```
 "This breaks compatibility with vi, saying that we want to use the benefits of vim
    set nocompatible
    " Enable syntax highlighting
    syntax on
    " Increase the command history to be very big
    set history=10000
    " Indent based on the previous line
    set autoindent
    " Make it so searches wrap around at the end of the file
    set wrapscan
    " Show the current mode in the command line
    set showmode
    " Displays partial commands in the last line
    set showcmd
    " Highlight searches
    set hlsearch
    " Use case insensitive search
    set ignorecase
    " Don't use case insensitive search use when using capital letters
    set smartcase
    " Display the cursor position at the bottom
    set ruler 
```

## 在其他软件中的 Vim 绑定

如果你开始喜欢并习惯 vim 的使用方式，值得一提的是，许多文本编辑器和 IDE 都有选项和插件可以切换到 vim 输入模式。甚至有些网页浏览器也提供了 vim 风格的输入！

如果你对 vim 章节中的内容感兴趣或想要复习，可以在这里找到一个视频教程，涵盖了本章中一些最重要的内容（甚至包括一些额外的 vim 功能！）：[`www.youtube.com/watch?v=ggSyF1SVFr4`](https://www.youtube.com/watch?v=ggSyF1SVFr4)

# 编辑一个你没有权限修改的文件

无论你使用哪个编辑器，有时你需要编辑一个当前用户没有写权限的文件。例如，如果你是普通用户，想编辑 `/etc/hosts` —— 这是一个由 root 拥有且仅 root 可写的文件 —— 你需要成为 root 或使用 `sudo` 命令。更多详情请参见*第七章*，*用户和组*。

虽然像 `sudo $EDITOR /etc/hosts` 这样的命令可以用来以 root 用户编辑文件，但更好的方法是使用 `sudoedit` 以 root 身份执行编辑命令：

+   `sudoedit /etc/hosts`

+   `EDITOR=nano sudoedit /etc/hosts`

+   `EDITOR=vi sudoedit /etc/hosts`

第一个示例将使用你在 `EDITOR` 环境变量中设置的编辑器，而其他两个命令则会将 `EDITOR` 环境变量作为命令的一部分传递（或覆盖）。

# 设置你偏好的编辑器

Linux 以及所有类 Unix 系统都允许你通过`EDITOR`环境变量设置首选编辑器。大多数命令行软件在执行某些任务时（例如`git`提交时或`visudo`编辑 sudoers 文件时），会使用此变量来确定打开哪个编辑器。你可以将此`EDITOR`变量设置为任何你喜欢的编辑器的路径，甚至是图形界面的（前提是你的系统安装了图形用户界面）：

```
bash-3.2$ echo $EDITOR
nano
bash-3.2$ export EDITOR=vim 
```

请注意，上述交互式 shell 命令仅在当前 shell 会话关闭之前有效；要将此设置持久化到 Bash shell 中，我会将其添加到我的`~/.bashrc`文件中。有关更多详细信息，请参阅*第四章*，*使用 Shell 历史*。

# 结论

在本章中，你学会了如何在命令行上编辑文本文件。首先，我们介绍了最简单的入门方式（nano），然后我们展示了如何逐步转向一种技能集，这种技能集将在你整个职业生涯中产生回报：vi/vim 及其键绑定，在各种软件中都有广泛支持。

使用本章的速查表开始命令行编辑，但要知道，在练习一两天后，你将准备好学习 vim 中的其他快捷方式和命令。最好通过 vimtutor、在线速查表和 YouTube 视频结合学习。我们也非常喜欢 Drew Neil 的书籍《实用 Vim》，第二版。

当你在工作时，熟练掌握命令行文本编辑是看起来和感觉像专业人士的最可靠方法之一。不要忽视这一技能集！

# 在 Discord 上了解更多信息

要加入本书的 Discord 社区 – 在这里你可以分享反馈，向作者提问，了解新版本发布信息 – 请扫描下面的 QR 码：

[`packt.link/SecNet`](https://packt.link/SecNet)

![](img/QR_Code1768422420210094187.png)
