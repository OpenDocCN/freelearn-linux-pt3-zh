

# 第四章：使用 Shell 历史

要熟练掌握命令行，你必须定期使用它。没有捷径可以让你快速适应，但有一些高价值的技巧你可以尽早学习，它们将节省你的时间和避免挫败感。越早将这些技巧融入肌肉记忆，效果越好。

在本章中，你将学习如何利用 Shell 历史，避免重复输入已经执行过的命令。你还将看到如何通过 Shell 配置文件自定义 Shell 的行为或外观。最后，我们将展示在命令提示符下编辑和修改命令的最有用的快捷键。总之，本章将使你在命令行上变得飞快。

我们将通过以下主题来进行讲解：

+   Shell 历史

+   使用 `!` 执行之前的命令

+   跳转到行首或行尾

让我们从了解 Shell 历史开始。

# Shell 历史

大多数 Shell 会保存你执行过的命令历史。这意味着你可以通过按箭头键查看你执行过的每一条成功命令：使用 *上箭头* 键回溯一条命令，使用 *下箭头* 键前进一条命令。通过这种方式浏览 Shell 历史非常有用，尤其是当你发现自己频繁执行类似的命令时。

请注意，你也可以编辑找到的命令：使用 *左箭头* 和 *右箭头* 来导航到命令所在的文本行，然后直接输入来编辑命令。

编辑过的命令会被添加到 Shell 历史的末尾（它不会实际修改历史中已保存的命令）。

这些技巧结合起来，可以让你轻松地回到并重新执行或修改之前的命令。

## Shell 配置文件

我们将讨论的一些技巧需要更改 Shell 配置文件。工作流程通常是：

1.  在你的 Shell 配置文件中修改你想要更改的选项。

1.  保存文件。

1.  打开一个新的 Shell 会话以查看更改。

1.  对于已存在的 Shell 会话，可以通过运行命令 `source`（执行）重新加载 Shell 配置文件：`source ~/path/to/config/file`。

以下是最常见 Shell 的位置：

| **常见的 Shell** | **位置** |
| --- | --- |
| Bash | `~/.bashrc` 用于交互式会话，例如在图形环境中打开新终端窗口时获得的会话。如果你在工作机器上更改配置，通常需要这个配置文件。“交互式”指的是用户在终端中直接使用 Shell，而不是脚本执行的情况（例如，由 cron 任务自动调用的脚本）。当你在某种形式的终端中，手动输入命令时，你就处于“交互式 Shell”中。`~/.bash_profile` 用于登录 Shell —— 这可能是本地登录，也可能是通过 SSH 登录的会话。再次强调，这是与运行脚本时的 Shell 实例的对比。 |
| Zsh（Z shell） | `~/.zshrc` |

## 历史文件

不同的 shell 将历史记录文件保存在不同的位置，大多数 shell 都可以配置以更改该位置。默认情况下，你几乎总是使用 Bash，而 Bash 默认将其历史记录文件保存在 `~/.bash_history`。

如果你不确定在哪里找到 shell 历史文件，许多 shell 提供一个名为 `HISTFILE` 的配置选项，其中包含历史文件的位置。

这里，我正在检查历史文件的位置，同时运行 `zsh` 操作系统：

```
% echo $HISTFILE
/home/dcohen/.zsh_history 
```

Bash 有两个配置选项，可以防止历史记录文件无限增长，以保持其大小可控，并使历史记录搜索更快速：

+   `HISTSIZE` 控制在内存中保留的最大历史记录数量。

+   `HISTFILESIZE` 控制 shell 会话之间保存的历史文件的最大大小。

如果你想增加 Bash 保留的历史记录数量，可以在 shell 的配置文件中增加前述的设置。

为此，打开 shell 的配置文件（例如，`~/.bashrc`），并通过将以下几行附加到文件末尾来设置这些变量：

```
export HISTSIZE=1000
export HISTFILESIZE=5000 
```

## 搜索 shell 历史记录

你经常会想要找出一周（或一个月）前运行的命令。这个命令可能会在历史记录中更久远的位置，为了到达那里，按 *上箭头* 成百上千次无疑是一种浪费时间的做法。如果你至少对要找的命令有一些线索，交互式的 shell 历史搜索就是你需要的技巧。下面是如何搜索你的 shell 历史：

1.  按 *CTRL* + *R* 来激活 `reverse-i-search`（反向搜索）。

1.  输入你正在寻找的命令的一部分。

1.  你的 shell 会尝试将你输入的字符与命令历史记录进行匹配，并找到最接近的、最近的匹配项。

1.  重复按 *CTRL* + *R* 来浏览历史记录。按 *ENTER* 选择一个命令，或者按 *Esc* 退出此模式。

1.  如果你不小心跳过了想要的命令，*CTRL* + *SHIFT* + *R* 将会搜索向前到下一个最近的匹配项。

## 例外情况

这个功能根据你使用的 shell 和配置有所不同，可能会有一些例外情况。

一些 shell 会忽略那些因错误（以非零退出代码退出）而失败的命令。许多 shell 也会忽略以空格字符开头的命令——这些命令不会被添加到 shell 的历史记录中。然而，在这两种情况下，只要你立即按下 (*上箭头*)，通常仍然可以找到该历史记录条目，而不必执行其他任何命令。

# 使用 `!` 执行之前的命令

执行之前的命令是通过感叹号来实现的。有多种方法可以使用这个技巧，下面我们来看看。

## 使用相同的参数重新运行命令

`!` 命令将执行最后一个命令并带上先前的参数。例如，`!ssh` 将回溯并找到你上次运行的 `ssh` 命令，并使用相同的参数重新执行它。你可以用它来重新运行你经常使用的命令，并保持相同的参数，例如快速重新连接到你每天连接的 SSH 服务器。

## 在历史命令中添加前置命令

`!!` 命令将执行你上次运行的命令，但会在它前面加上其他命令。这听起来可能有些奇怪，但在你不小心运行了一个需要 root 权限的命令，而没有在前面加上 `sudo` 时，它*非常*有用。

```
apt-get install nginx # fails with a permission error
sudo !!
# this is the command that runs:
sudo apt-get install nginx 
```

如果前一个命令因权限不足失败，只需运行 `sudo !!` 就能重新执行该命令，并在开头加上 `sudo`。

**注意**

为了安全起见，不要将此作为自动习惯：始终确保你知道为什么一个命令需要更多的权限，并问自己是否信任它，愿意让它在你的系统上做任何事情。对 `sudo` 的不小心使用可能会导致轻易破坏系统，或让攻击者在系统上占据一席之地。

# 跳到当前行的开头或结尾

在编辑时跳到行的开头并不罕见，也许是为了纠正命令的拼写或添加一个必需的参数。要做到这一点，请按 *CTRL* + *A*。

同样地，要跳到行的末尾，请使用 *CTRL* + *E*。

这两个快捷键会非常有用。

# 结论

在 Linux shell 环境中工作需要大量打字。即使是最小的提高你的速度和准确性，也能让你在构建和编辑命令时感到不再是基本任务拖延的永恒感，而是像经验丰富的 Unix 大师一样飞速前行。

本章分享的技巧是我们日常工作中使用的最常见且最强大的快捷键之一。将你新的命令历史搜索技能与编辑和命令修改快捷键结合使用，将大大提高你在命令行上的舒适度、效率和速度。

# 在 Discord 上了解更多

要加入本书的 Discord 社区——在这里你可以分享反馈，向作者提问并了解新版本——请扫描下面的二维码：

[`packt.link/SecNet`](https://packt.link/SecNet)

![](img/QR_Code1768422420210094187.png)
