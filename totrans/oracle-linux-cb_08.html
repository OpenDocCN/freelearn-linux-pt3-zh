<html><head></head><body>
<div id="_idContainer248">
<h1 class="chapter-number" id="_idParaDest-170"><a id="_idTextAnchor212"/><a id="_idTextAnchor213"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-171"><a id="_idTextAnchor214"/><span class="koboSpan" id="kobo.2.1">DevOps Automation Tools – Terraform, Ansible, Packer, and More</span></h1>
<p><span class="koboSpan" id="kobo.3.1">What good is an operating system if it doesn’t cater to developers? </span><span class="koboSpan" id="kobo.3.2">After all, an operating system that’s easy to develop on tends to enjoy a much stronger ecosystem than one that does not. </span><span class="koboSpan" id="kobo.3.3">You’ll be happy to learn that Oracle Linux plays very nicely with developers, and this chapter is all about common development tools that will make your life easier when setting out to work on your </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">next project.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">There are countless development tools that work well on Oracle Linux, but the ones we’re focusing on in this chapter are all about automation. </span><span class="koboSpan" id="kobo.5.2">We’ll be talking about automating cloud infrastructure, automating the operating system build cycle, automating system administrators’ tasks, and automating the launching of virtual machines for </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">development purposes.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we’re going to cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Do it once manually – rinse and repeat </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">with Terraform</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Creating portable roles </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">for Ansible</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Managing secrets with </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">Ansible Vault</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Cooking up the perfect lab environment </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">with Vagrant</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Using Packer to modify </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">source images</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Pack it up, pack it in, let me begin, err, </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">umm… build</span></span></li>
</ul>
<h1 id="_idParaDest-172"><a id="_idTextAnchor215"/><span class="koboSpan" id="kobo.21.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.22.1">We’re covering a lot of technologies in this chapter. </span><span class="koboSpan" id="kobo.22.2">Let’s prepare your machine so that you can conveniently follow along with </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">the recipes.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor216"/><span class="koboSpan" id="kobo.24.1">Ansible</span></h2>
<p><span class="koboSpan" id="kobo.25.1">For Oracle Linux 8, we</span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.26.1"> can install Ansible by leveraging the </span><strong class="bold"><span class="koboSpan" id="kobo.27.1">Oracle Linux Automation Manager</span></strong><span class="koboSpan" id="kobo.28.1"> repository, so let’s install the repository first, and then we’ll </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">install Ansible:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.30.1">
$ sudo dnf install -y oraclelinux-automation-manager-release-el8
$ sudo dnf install -y ansible</span></pre> <h2 id="_idParaDest-174"><a id="_idTextAnchor217"/><span class="koboSpan" id="kobo.31.1">Packer, Vagrant, and Terraform</span></h2>
<p><span class="koboSpan" id="kobo.32.1">Packer is a tool used for automating the creation of machine images, Vagrant is used for managing the lifecycle of virtual machines, and Terraform is an infrastructure-as-code tool. </span><span class="koboSpan" id="kobo.32.2">Packer, Vagrant, and Terraform are all products of HashiCorp, but they work well on </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">Oracle Linux.</span></span></p>
<p><span class="koboSpan" id="kobo.34.1">We’re going to install Packer, Vagrant, and Terraform directly </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">from HashiCorp:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.36.1">
$ sudo dnf install -y dnf-plugins-core
$ sudo dnf config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
$ sudo dnf install -y packer vagrant terraform</span></pre> <p><span class="koboSpan" id="kobo.37.1">Once that’s finished, let’s</span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.38.1"> go ahead and install </span><strong class="bold"><span class="koboSpan" id="kobo.39.1">Oracle VM VirtualBox</span></strong><span class="koboSpan" id="kobo.40.1">, as we’ll be </span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.41.1">using</span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.42.1"> VirtualBox with </span><strong class="bold"><span class="koboSpan" id="kobo.43.1">Packer</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.44.1">and </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.45.1">Vagrant</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.47.1">
$ sudo dnf install -y oraclelinux-developer-release-el8
$ sudo dnf install -y VirtualBox-7.0</span></pre> <p><span class="koboSpan" id="kobo.48.1">Finally, along with </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.49.1">Terraform, we’ll also want to create an </span><strong class="bold"><span class="koboSpan" id="kobo.50.1">Oracle Cloud Infrastructure</span></strong><span class="koboSpan" id="kobo.51.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.52.1">OCI</span></strong><span class="koboSpan" id="kobo.53.1">) account. </span><span class="koboSpan" id="kobo.53.2">If you prefer, you may opt to use a different cloud, but use OCI if you want to follow this </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">tutorial directly.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.55.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.56.1">Be sure to remember your Cloud Account Name as this is an important detail required in order to access your </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">OCI account.</span></span></p>
<h2 id="_idParaDest-175"><a id="_idTextAnchor218"/><span class="koboSpan" id="kobo.58.1">Downloading the source code</span></h2>
<p><span class="koboSpan" id="kobo.59.1">The source code for the recipes in this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8"><span class="No-Break"><span class="koboSpan" id="kobo.61.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.62.1">.</span></span></p>
<h1 id="_idParaDest-176"><a id="_idTextAnchor219"/><span class="koboSpan" id="kobo.63.1">Do it once manually – rinse and repeat with Terraform</span></h1>
<p><span class="koboSpan" id="kobo.64.1">Terraform is an </span><strong class="bold"><span class="koboSpan" id="kobo.65.1">infrastructure-as-code</span></strong><span class="koboSpan" id="kobo.66.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.67.1">IaC</span></strong><span class="koboSpan" id="kobo.68.1">) tool that lets you build, change, and version infrastructure </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.69.1">safely and efficiently. </span><span class="koboSpan" id="kobo.69.2">This recipe will provide a general overview of a good technique for automating the </span><em class="italic"><span class="koboSpan" id="kobo.70.1">ugly</span></em><span class="koboSpan" id="kobo.71.1"> with </span><strong class="bold"><span class="koboSpan" id="kobo.72.1">Terraform</span></strong><span class="koboSpan" id="kobo.73.1">. </span><span class="koboSpan" id="kobo.73.2">What do I mean by </span><em class="italic"><span class="koboSpan" id="kobo.74.1">ugly</span></em><span class="koboSpan" id="kobo.75.1">? </span><span class="koboSpan" id="kobo.75.2">Well, it’s anything that’s being</span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.76.1"> done manually. </span><span class="koboSpan" id="kobo.76.2">We want to cut out the manual steps and automate as much as possible. </span><span class="koboSpan" id="kobo.76.3">In the case of Terraform specifically, this means we’re going to automate the deployment of cloud infrastructure. </span><span class="koboSpan" id="kobo.76.4">Thanks to Terraform, we no longer need to click around through a hundred different menu settings. </span><span class="koboSpan" id="kobo.76.5">Instead, we’re going to defi</span><a id="_idTextAnchor220"/><span class="koboSpan" id="kobo.77.1">ne our </span><strong class="bold"><span class="koboSpan" id="kobo.78.1">infrastructure as code</span></strong><span class="koboSpan" id="kobo.79.1">. </span><span class="koboSpan" id="kobo.79.2">This results in faster and more consistent deployments. </span><span class="koboSpan" id="kobo.79.3">Additionally, it’s also much easier to make changes to your infrastructure since it can all be edited </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">via</span><a id="_idTextAnchor221"/><span class="koboSpan" id="kobo.81.1"> code.</span></span></p>
<h2 id="_idParaDest-177"><a id="_idTextAnchor222"/><span class="koboSpan" id="kobo.82.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.83.1">You will need the following for </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">this recipe:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.85.1">Oracle Linux</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.86.1">Terraform</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.87.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.88.1">Technical requirements</span></em><span class="koboSpan" id="kobo.89.1"> section at the beginning of this chapter if you need help </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">installing Terraform.</span></span></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor223"/><span class="koboSpan" id="kobo.91.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.92.1">Any time you set out to automate something, it’s always a good idea to have a solid grasp on what needs to be done under the hood. </span><span class="koboSpan" id="kobo.92.2">Can you guess what that means? </span><span class="koboSpan" id="kobo.92.3">Yep, you’ve got to perform all the manual steps at least once before trying to </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">automa</span><a id="_idTextAnchor224"/><a id="_idTextAnchor225"/><span class="koboSpan" id="kobo.94.1">te it.</span></span></p>
<h3><span class="koboSpan" id="kobo.95.1">First, do it once manually…</span></h3>
<p><span class="koboSpan" id="kobo.96.1">The goal for this recipe is to use Terraform</span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.97.1"> to deploy a simple VM in the cloud. </span><span class="koboSpan" id="kobo.97.2">It’s an easy enough task, but before we jump into how this can be done using code, it’s generally best to do it manually first. </span><span class="koboSpan" id="kobo.97.3">So, with that being said, let’s go ahead and deploy a virtual machine using the OCI </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">web GUI:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.99.1">Log in to the Oracle Cloud Infrastructure </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">Console (</span></span><a href="https://cloud.oracle.com/"><span class="No-Break"><span class="koboSpan" id="kobo.101.1">https://cloud.oracle.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.102.1">).</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer204">
<span class="koboSpan" id="kobo.103.1"><img alt="Figure 8.1 – OCI Console Login Page" src="image/B18349_08_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.104.1">Figure 8.1 – OCI Console Login Page</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.105.1">Click on the hamburger menu icon at the </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">top left:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer205">
<span class="koboSpan" id="kobo.107.1"><img alt="Figure 8.2 – OCI Console main screen" src="image/B18349_08_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.108.1">Figure 8.2 – OCI Console main screen</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.109.1">Then click</span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.110.1"> on </span><strong class="bold"><span class="koboSpan" id="kobo.111.1">Compute</span></strong><span class="koboSpan" id="kobo.112.1"> | </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.113.1">Instances</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer206">
<span class="koboSpan" id="kobo.115.1"><img alt="Figure 8.3 – OCI Cloud Compute menu" src="image/B18349_08_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.116.1">Figure 8.3 – OCI Cloud Compute menu</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.117.1">Verify you are in the desired </span><strong class="bold"><span class="koboSpan" id="kobo.118.1">Compartment</span></strong><span class="koboSpan" id="kobo.119.1">, and finally, click on </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.120.1">Create instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer207">
<span class="koboSpan" id="kobo.122.1"><img alt="Figure 8.4 – OCI Cloud Compute Instances" src="image/B18349_08_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.123.1">Figure 8.4 – OCI Cloud Compute Instances</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.124.1">Info</span></p>
<p class="callout"><span class="koboSpan" id="kobo.125.1">For brevity, when multiple menu items need to be clicked, the pipe symbol (|) indicates the sequence in which to </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">click buttons/links.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.127.1">We’re going to use</span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.128.1"> the default Oracle Linux image, but if you want to change this, you can go to </span><strong class="bold"><span class="koboSpan" id="kobo.129.1">Image and shape</span></strong><span class="koboSpan" id="kobo.130.1"> and click </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.132.1">Edit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer208">
<span class="koboSpan" id="kobo.134.1"><img alt="Figure 8.5 – OCI Console Compute Image and shape" src="image/B18349_08_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.135.1">Figure 8.5 – OCI Console Compute Image and shape</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.136.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.137.1">There’s no cost as long</span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.138.1"> as you stick to all </span><strong class="bold"><span class="koboSpan" id="kobo.139.1">Always Free-eligible</span></strong><span class="koboSpan" id="kobo.140.1"> resources; however, at the time of writing, there is a bug that falsely shows a $2.00 per month charge for the boot volume. </span><span class="koboSpan" id="kobo.140.2">This is a bug as the boot volume uses block storage and OCI gives you up to 200 GB of block storage </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">for free.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.142.1">At the time of writing, the latest version is </span><em class="italic"><span class="koboSpan" id="kobo.143.1">Oracle Linux 8</span></em><span class="koboSpan" id="kobo.144.1"> (image </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">build: 2023.06.30-0).</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.146.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.147.1">Add SSH Keys</span></strong><span class="koboSpan" id="kobo.148.1">, select </span><strong class="bold"><span class="koboSpan" id="kobo.149.1">Generate a key pair for me</span></strong><span class="koboSpan" id="kobo.150.1"> and then click on </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">Save Private Key</span></strong><span class="koboSpan" id="kobo.152.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.153.1">Save </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.154.1">Public Key</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.156.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.157.1">Choose a place that is easy for you to remember, as you’ll need this later when you seek to SSH into </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">your VM.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.159.1">Finally, click </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.161.1">Create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.163.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.164.1">Feel free to grab a coffee while waiting for the image </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">to build.</span></span></p>
<p><span class="koboSpan" id="kobo.166.1">Now, let’s use SSH </span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.167.1">to connect to </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">the instance:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.169.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.170.1">Instance information</span></strong><span class="koboSpan" id="kobo.171.1"> tab, click on </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">Copy</span></strong><span class="koboSpan" id="kobo.173.1"> next to the </span><strong class="bold"><span class="koboSpan" id="kobo.174.1">Public IP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.175.1">address</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.176.1"> entry.</span></span></li>
<li><span class="koboSpan" id="kobo.177.1">Open up a terminal application and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">ssh</span></strong><span class="koboSpan" id="kobo.179.1"> command to connect. </span><span class="koboSpan" id="kobo.179.2">We’ll use </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">-i</span></strong><span class="koboSpan" id="kobo.181.1"> (where </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">i</span></strong><span class="koboSpan" id="kobo.183.1"> stands for identify file) to reference the private key we saved in the previous steps. </span><span class="koboSpan" id="kobo.183.2">The default username for official Oracle Linux instances hosted in the OCI is </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">opc</span></strong><span class="koboSpan" id="kobo.185.1">, so we’ll instruct </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">ssh</span></strong><span class="koboSpan" id="kobo.187.1"> to connect as </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">opc</span></strong><span class="koboSpan" id="kobo.189.1">. </span><span class="koboSpan" id="kobo.189.2">Finally, input the </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">Public IP address</span></strong><span class="koboSpan" id="kobo.191.1"> you obtained in the previous step. </span><span class="koboSpan" id="kobo.191.2">Your command should look a bit </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer209">
<span class="koboSpan" id="kobo.193.1"><img alt="Figure 8.6 – SSH into compute instance (failure)" src="image/B18349_08_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.194.1">Figure 8.6 – SSH into compute instance (failure)</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.195.1">Uh oh! </span><span class="koboSpan" id="kobo.195.2">Did you notice the big warning, as well as that last message? </span><span class="koboSpan" id="kobo.195.3">We were denied access because of bad permissions. </span><span class="koboSpan" id="kobo.195.4">Let’s fix that using </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">chmod</span></strong><span class="koboSpan" id="kobo.197.1"> to give only the owner permission to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">key file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer210">
<span class="koboSpan" id="kobo.199.1"><img alt="" role="presentation" src="image/B18349_08_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.200.1">Figure 8.7 – SSH into compute instance (success)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.201.1">Great! </span><span class="koboSpan" id="kobo.201.2">We’ve connected to the machine </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">via SSH.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">Now I do realize that</span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.204.1"> this wasn’t all that difficult, but imagine if you had to do this a hundred times? </span><span class="koboSpan" id="kobo.204.2">Why not automate the process </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">with Terra</span><a id="_idTextAnchor226"/><span class="koboSpan" id="kobo.206.1">form?</span></span></p>
<h3><span class="koboSpan" id="kobo.207.1">Now it’s time to rinse and repeat with Terraform</span></h3>
<p><span class="koboSpan" id="kobo.208.1">This time around, we’re going</span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.209.1"> to accomplish the exact same thing that was described earlier – that is, we’re going to create another virtual machine in OCI. </span><span class="koboSpan" id="kobo.209.2">However, this time around, we’re going to define our IaC </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">using Terraform:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.211.1">First, let’s create three new files within the root of your project directory (I’m naming this one </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">terraform</span></strong><span class="koboSpan" id="kobo.213.1">) using your favorite code editor, and name them </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">as follows:</span></span><ol><li class="Alphabets"><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">main.tf</span></strong></span></li><li class="Alphabets"><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">variables.tf</span></strong></span></li><li class="Alphabets"><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">terraform.tfvars</span></strong></span></li></ol></li>
<li><span class="koboSpan" id="kobo.218.1">Next, let’s head</span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.219.1"> to the Terraform Re</span><a id="_idTextAnchor227"/><span class="koboSpan" id="kobo.220.1">gistry (</span><a href="https://registry.terraform.io/"><span class="koboSpan" id="kobo.221.1">https://registry.terraform.io/</span></a><span class="koboSpan" id="kobo.222.1">) to find</span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.223.1"> the provider for </span><strong class="bold"><span class="koboSpan" id="kobo.224.1">Oracle Cloud </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.225.1">Infrastructure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.226.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.227.1">OCI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.229.1">On the Terraform Registry, search for either </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">oci</span></strong><span class="koboSpan" id="kobo.231.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">oracle cloud infrastructure</span></strong><span class="koboSpan" id="kobo.233.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.235.1">oracle/oci</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.237.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.238.1">Alternatively, you can click on </span><strong class="bold"><span class="koboSpan" id="kobo.239.1">Browse Providers</span></strong><span class="koboSpan" id="kobo.240.1"> and then click on the </span><strong class="bold"><span class="koboSpan" id="kobo.241.1">Oracle Cloud </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.242.1">Infrastructure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.243.1"> button.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.244.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.245.1">USE PROVIDER</span></strong><span class="koboSpan" id="kobo.246.1">, and copy and paste the code displayed into your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.248.1"> file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer211">
<span class="koboSpan" id="kobo.249.1"><img alt="Figure 8.8 – Terraform OCI provider" src="image/B18349_08_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.250.1">Figure 8.8 – Terraform OCI provider</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.251.1">Notice the comment for </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1"># Configuration options</span></strong><span class="koboSpan" id="kobo.253.1"> under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">provider "oci"</span></strong><span class="koboSpan" id="kobo.255.1">. </span><span class="koboSpan" id="kobo.255.2">This tells us we may need to supply some configuration options</span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.256.1"> in order to use </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">the provider.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.258.1">Let’s take a look at how to </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">do this:</span></span></p><ol><li class="Alphabets"><span class="koboSpan" id="kobo.260.1">Click on the </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">Documentation</span></strong><span class="koboSpan" id="kobo.262.1"> tab (it’s right next to </span><strong class="bold"><span class="koboSpan" id="kobo.263.1">USE PROVIDER</span></strong><span class="koboSpan" id="kobo.264.1">), then find the link on </span><strong class="bold"><span class="koboSpan" id="kobo.265.1">How to configure </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.266.1">the provider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">.</span></span></li><li class="Alphabets"><span class="koboSpan" id="kobo.268.1">You’ll find that the OCI Terraform provider supports four </span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">authentication methods:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.270.1">API Key </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.271.1">Authentication</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.272.1"> (default)</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.273.1">Instance </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.274.1">Principal Authorization</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.275.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.276.1">Principal Authentication</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.277.1">Security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.278.1">Token Authentication</span></strong></span></li></ul></li><li class="Alphabets"><span class="koboSpan" id="kobo.279.1">For this recipe, I’ll be using the default authentication</span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.280.1"> method; that is, </span><strong class="bold"><span class="koboSpan" id="kobo.281.1">API Key Authentication</span></strong><span class="koboSpan" id="kobo.282.1">. </span><span class="koboSpan" id="kobo.282.2">This method has the fewest limitations, but depending on your use case, you can choose the one that best meets </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">your needs.</span></span></li></ol></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.284.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.285.1">There’s no shortcut to providing the authentication details; however, for some helpful guidance, you may want to reference the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">oci-provider-conf.md</span></strong><span class="koboSpan" id="kobo.287.1"> file in the GitHub repository associated with this recipe. </span><span class="koboSpan" id="kobo.287.2">If you want greater details, I recommend working through the documentation described in the </span><strong class="bold"><span class="koboSpan" id="kobo.288.1">How to configure the provider</span></strong><span class="koboSpan" id="kobo.289.1"> section </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">referenced earlier.</span></span></p>
<ol>
<li class="Alphabets" value="4"><span class="koboSpan" id="kobo.291.1">If you decided to use </span><strong class="bold"><span class="koboSpan" id="kobo.292.1">API Key Authentication</span></strong><span class="koboSpan" id="kobo.293.1"> for your authentication method, go ahead and add the following configuration options to </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">provider "oci"</span></strong><span class="koboSpan" id="kobo.295.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1"> file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer212">
<span class="koboSpan" id="kobo.298.1"><img alt="Figure 8.9 – API key authentication details" src="image/B18349_08_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.299.1">Figure 8.9 – API key authentication details</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.300.1">In order to keep things clean, we’re going to reference variables for these values. </span><span class="koboSpan" id="kobo.300.2">I will provide more details on how to define/declare variables later in </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">this recipe.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.302.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.303.1">To illustrate that we’re adding to a file, I am using three series of three dots. </span><span class="koboSpan" id="kobo.303.2">This is meant to represent a continuation of what we did in the </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">previous steps.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.305.1">Here's </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">an example:</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">...</span></strong></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">...</span></strong></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">...</span></strong></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.310.1">Now that we’ve got our provider</span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.311.1"> set up, it’s not going to do much unless we add a resource. </span><span class="koboSpan" id="kobo.311.2">In this case, we want to add </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">an </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">oci_core_instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.315.1">Do you recall when we generated an SSH key pair during the manual process? </span><span class="koboSpan" id="kobo.315.2">Well, now we need to figure out a way to do this dynamically using code. </span><span class="koboSpan" id="kobo.315.3">The following instruction is how we can do this using Terraform. </span><span class="koboSpan" id="kobo.315.4">We’ll create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">tls_private_key</span></strong><span class="koboSpan" id="kobo.317.1"> resource, and reference that as our </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">ssh_authorized_keys</span></strong><span class="koboSpan" id="kobo.319.1"> under the metadata for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">oci_core_instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.321.1"> resource.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.322.1">Let’s start with the SSH key pair, which is created with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">tls_private_key</span></strong><span class="koboSpan" id="kobo.324.1"> resource. </span><span class="koboSpan" id="kobo.324.2">Details on this resource can be found under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">hashicorp/tls</span></strong><span class="koboSpan" id="kobo.326.1"> provider on the Terraform registry. </span><span class="koboSpan" id="kobo.326.2">Continue to edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">main.tf</span></strong><span class="koboSpan" id="kobo.328.1"> file, and add </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">the following:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer213">
<span class="koboSpan" id="kobo.330.1"><img alt="Figure 8.10 – Defining SSH key pair with Terraform" src="image/B18349_08_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.331.1">Figure 8.10 – Defining SSH key pair with Terraform</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.332.1">You’ll need to define a valid availability</span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.333.1"> domain. </span><span class="koboSpan" id="kobo.333.2">One way to do this is by using Terraform to query a list of availability domains and reference one of the items from that list, so let’s add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.335.1"> file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer214">
<span class="koboSpan" id="kobo.336.1"><img alt="Figure 8.11 – Getting a list of availability domains using Terraform" src="image/B18349_08_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.337.1">Figure 8.11 – Getting a list of availability domains using Terraform</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.338.1">Finally, we’re going to add a resource for </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">oci_core_instance</span></strong><span class="koboSpan" id="kobo.340.1">. </span><span class="koboSpan" id="kobo.340.2">If you review the </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">oci_core_instance</span></strong><span class="koboSpan" id="kobo.342.1"> resource from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">oracle/oci</span></strong><span class="koboSpan" id="kobo.344.1"> provider on the Terraform registry, you’ll see a long list of parameters that can be used to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">oci_core_instance</span></strong><span class="koboSpan" id="kobo.346.1"> resource; however, not everything from this list is required as many of the parameters are preceded with </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">#Optional</span></strong><span class="koboSpan" id="kobo.348.1">. </span><span class="koboSpan" id="kobo.348.2">For this recipe, we’re going to use the bare minimum that is required for this resource – so that should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer215">
<span class="koboSpan" id="kobo.350.1"><img alt="Figure 8.12 – OCI Core instance resource details" src="image/B18349_08_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.351.1">Figure 8.12 – OCI Core instance resource details</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.352.1">Once you are finished</span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.353.1"> with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">oci_core_instance</span></strong><span class="koboSpan" id="kobo.355.1"> resource, your entire </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">main.tf</span></strong><span class="koboSpan" id="kobo.357.1"> file should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer216">
<span class="koboSpan" id="kobo.359.1"><img alt="Figure 8.13 – Contents of main.tf file" src="image/B18349_08_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.360.1">Figure 8.13 – Contents of main.tf file</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.361.1">Now we need to declare</span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.362.1"> all of those variables we referenced throughout the </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">main.tf</span></strong><span class="koboSpan" id="kobo.364.1"> file. </span><span class="koboSpan" id="kobo.364.2">In order to keep things organized, let’s put them in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">variables.tf</span></strong><span class="koboSpan" id="kobo.366.1"> file. </span><span class="koboSpan" id="kobo.366.2">Each variable should, at a minimum, contain a type; however, we’ll also add a description to explain the purpose of </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">the variable.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.368.1">Input the following</span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.369.1"> into your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">variables.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.371.1"> file:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer217">
<span class="koboSpan" id="kobo.372.1"><img alt="Figure 8.14 – Declaration of variables in the variables.tf file" src="image/B18349_08_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.373.1">Figure 8.14 – Declaration of variables in the variables.tf file</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.374.1">Finally, we would</span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.375.1"> want to assign values to the variables. </span><span class="koboSpan" id="kobo.375.2">For this, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.377.1"> file. </span><span class="koboSpan" id="kobo.377.2">It should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer218">
<span class="koboSpan" id="kobo.379.1"><img alt="Figure 8.15 – Content of terraform.tfvars file" src="image/B18349_08_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.380.1">Figure 8.15 – Content of terraform.tfvars file</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.381.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.382.1">Reference the following</span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.383.1"> guide to find the </span><em class="italic"><span class="koboSpan" id="kobo.384.1">ocid</span></em><span class="koboSpan" id="kobo.385.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">tenancy_ocid</span></strong><span class="koboSpan" id="kobo.387.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">compartment_ocid</span></strong><span class="koboSpan" id="kobo.389.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">user_ocid</span></strong><span class="koboSpan" id="kobo.391.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">fingerprint</span></strong><span class="koboSpan" id="kobo.393.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">subnet_ocid</span></strong><span class="koboSpan" id="kobo.395.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">private_key_path</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">: </span></span><a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/terraformproviderconfiguration.htm"><span class="No-Break"><span class="koboSpan" id="kobo.398.1">https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/terraformproviderconfiguration.htm</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.399.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.400.1">To get the OCID for Oracle</span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.401.1"> Linux 8, visit the following link: </span><a href="https://docs.oracle.com/en-us/iaas/images/oracle-linux-8x/"><span class="koboSpan" id="kobo.402.1">https://docs.oracle.com/en-us/iaas/images/oracle-linux-8x/</span></a><a href="https://docs.oracle.com/en-us/iaas/images/oracle-linux-8x/.This"/><span class="koboSpan" id="kobo.403.1"> is region specific as well as architecture specific, so you’ll want to find the latest Oracle Linux 8 image for x86 (or in other words, look for one without the </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">aarch64</span></strong><span class="koboSpan" id="kobo.405.1"> text in the </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">image name).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.407.1">Warning</span></p>
<p class="callout"><span class="koboSpan" id="kobo.408.1">Just be sure to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.410.1"> file to your </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">.gitignore</span></strong><span class="koboSpan" id="kobo.412.1"> list to avoid checking any sensitive information into </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">version control.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.414.1">Next, let’s run Terraform to see if we did </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">everything correctly:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.416.1">$ terraform init</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.417.1">$ terraform plan</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.418.1">$ terraform apply</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.419.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">terraform init</span></strong><span class="koboSpan" id="kobo.421.1"> command</span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.422.1"> initializes the working directory containing your Terraform project files and this should always be the first command that you run after you write a new Terraform configuration. </span><span class="koboSpan" id="kobo.422.2">After this, it is a good idea to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">terraform plan</span></strong><span class="koboSpan" id="kobo.424.1"> as this will give you a chance to preview/verify the plan. </span><span class="koboSpan" id="kobo.424.2">During this command, Terraform will compare your real infrastructure against your configuration. </span><span class="koboSpan" id="kobo.424.3">Finally, running </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">terraform apply</span></strong><span class="koboSpan" id="kobo.426.1"> will display the plan again, but it will additionally give you the chance to enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">yes</span></strong><span class="koboSpan" id="kobo.428.1"> to perform any actions proposed by </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">the plan.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.430.1">When you see the prompt that asks you to </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">Enter a value</span></strong><span class="koboSpan" id="kobo.432.1">, go ahead and type </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">yes</span></strong><span class="koboSpan" id="kobo.434.1">, and then </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.436.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.438.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.439.1">If you get a </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">401-NotAuthenticated</span></strong><span class="koboSpan" id="kobo.441.1"> error, make sure you’ve added your public key to the OCI console. </span><span class="koboSpan" id="kobo.441.2">This is the public key that pairs with </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">private_key_path</span></strong><span class="koboSpan" id="kobo.443.1"> under the </span><em class="italic"><span class="koboSpan" id="kobo.444.1">API Key </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.445.1">Authentication</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.446.1"> method.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.447.1">For help with adding</span><a id="_idIndexMarker706"/><span class="koboSpan" id="kobo.448.1"> your public key to the OCI console, </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">visit </span></span><a href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm#three"><span class="No-Break"><span class="koboSpan" id="kobo.450.1">https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm#three</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.451.1">.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.452.1">If all goes well, you should be able to watch as your resources are created. </span><span class="koboSpan" id="kobo.452.2">Once this is complete, you’ll see a message </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">like this:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.454.1">Apply complete! </span><span class="koboSpan" id="kobo.454.2">Resources: 3 added, 0 changed, 0 destroyed.</span></strong></pre></li> <li><span class="koboSpan" id="kobo.455.1">If you check the OCI console, you will see your newly created instance and you will be able to connect to it via the SSH key pair the Terraform code generated and stuffed inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">instances</span></strong><span class="koboSpan" id="kobo.457.1"> folder within your </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">Terraform project.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.459.1">This is easy enough to do, but why not automate a bit more so we don’t need to check the OCI console for the public IP address? </span><span class="koboSpan" id="kobo.459.2">All we need to do is add a bit more code to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">main.tf</span></strong><span class="koboSpan" id="kobo.461.1"> file and we can really start to take things to the </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">next level.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.463.1">Go ahead and add the following code to your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.465.1"> file:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer219">
<span class="koboSpan" id="kobo.466.1"><img alt="Figure 8.16 – Terraform code that outputs connection details" src="image/B18349_08_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.467.1">Figure 8.16 – Terraform code that outputs connection details</span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.468.1">Now that we have that</span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.469.1"> in place, save your file and run </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">terraform apply</span></strong><span class="koboSpan" id="kobo.471.1"> once more to see what </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">this does:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.473.1">$ terraform apply</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.474.1">Terraform will again compare your real infrastructure with your configuration, but this time, since most of our infrastructure is in place, it’s only going to propose adding one resource. </span><span class="koboSpan" id="kobo.474.2">When you see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">Enter a value</span></strong><span class="koboSpan" id="kobo.476.1"> prompt, go ahead and type </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">yes</span></strong><span class="koboSpan" id="kobo.478.1">, and then </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.480.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.482.1">Terraform will do its thing, and at the end, you’ll see output that provides instructions on how to SSH into the newly created instance. </span><span class="koboSpan" id="kobo.482.2">That should look a bit </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer220">
<span class="koboSpan" id="kobo.484.1"><img alt="Figure 8.17 – Output of “terraform apply”" src="image/B18349_08_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.485.1">Figure 8.17 – Output of “terraform apply”</span></p>
<p><span class="koboSpan" id="kobo.486.1">I realize that what we have just covered seems like a lot of information, but let’s consider what we’ve done here. </span><span class="koboSpan" id="kobo.486.2">We automated the deployment of an instance into the cloud. </span><span class="koboSpan" id="kobo.486.3">Every parameter is easily configurable within our </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.488.1"> file. </span><span class="koboSpan" id="kobo.488.2">Finally, trivial steps including generating SSH keys are also automated, and we even print a statement at the end that clearly</span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.489.1"> instructs how to connect to the newly deployed instance. </span><span class="koboSpan" id="kobo.489.2">I hope you enjoyed</span><a id="_idIndexMarker709"/><span class="koboSpan" id="kobo.490.1"> this recipe and are starting to see the true value </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">of </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.492.1">IaC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.493.1">!</span></span></p>
<p><span class="koboSpan" id="kobo.494.1">The source code for this recipe can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/terraform"><span class="No-Break"><span class="koboSpan" id="kobo.496.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/terraform</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.497.1">.</span></span></p>
<h1 id="_idParaDest-179"><a id="_idTextAnchor228"/><span class="koboSpan" id="kobo.498.1">Creating portable roles for Ansible</span></h1>
<p><span class="koboSpan" id="kobo.499.1">Before attempting to follow</span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.500.1"> this recipe, I recommend having some basic knowledge</span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.501.1"> of Ansible and how to write an Ansible playbook. </span><span class="koboSpan" id="kobo.501.2">If you’ve never written an Ansible playbook, I recommend</span><a id="_idIndexMarker712"/><span class="koboSpan" id="kobo.502.1"> following the </span><em class="italic"><span class="koboSpan" id="kobo.503.1">Creating a playbook</span></em><span class="koboSpan" id="kobo.504.1"> guide from the official Ansible documentation. </span><span class="koboSpan" id="kobo.504.2">That can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">here: </span></span><a href="https://docs.ansible.com/ansible/latest/getting_started/get_started_playbook.html"><span class="No-Break"><span class="koboSpan" id="kobo.506.1">https://docs.ansible.com/ansible/latest/getting_started/get_started_playbook.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.507.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.508.1">In this recipe, you will learn</span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.509.1"> how easy it is to move things around when using </span><strong class="bold"><span class="koboSpan" id="kobo.510.1">Ansible roles</span></strong><span class="koboSpan" id="kobo.511.1">. </span><span class="koboSpan" id="kobo.511.2">When I first started using Ansible, I wrote my playbooks using </span><em class="italic"><span class="koboSpan" id="kobo.512.1">tasks</span></em><span class="koboSpan" id="kobo.513.1"> only. </span><span class="koboSpan" id="kobo.513.2">This to me seemed like a logical approach at the time and was more akin to traditional scripting since everything happened in </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">chronological order.</span></span></p>
<p><span class="koboSpan" id="kobo.515.1">The problem with writing playbooks in this way is there are no clear dependencies, and the tasks are defined along with the hosts, all in the same file. </span><span class="koboSpan" id="kobo.515.2">If you wanted to move things to another playbook, you’d have to be careful to grab the correct dependencies with each task, and you may be repeating yourself unnecessarily since tasks on their own are not reusable. </span><span class="koboSpan" id="kobo.515.3">As your playbooks become more complex and/or increase in size, you’ll eventually want something more portable for the sake </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">of manageability.</span></span></p>
<p><span class="koboSpan" id="kobo.517.1">According to Red Hat, roles are designed to be </span><em class="italic"><span class="koboSpan" id="kobo.518.1">self-contained portable units </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.519.1">of automation.</span></em></span></p>
<p><span class="koboSpan" id="kobo.520.1">Organizing your tasks into roles will allow</span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.521.1"> you to easily reuse them and share them with others. </span><span class="koboSpan" id="kobo.521.2">In fact, if you vis</span><a id="_idTextAnchor229"/><span class="koboSpan" id="kobo.522.1">it Ansible Galaxy (</span><a href="https://galaxy.ansible.com/"><span class="koboSpan" id="kobo.523.1">https://galaxy.ansible.com/</span></a><span class="koboSpan" id="kobo.524.1">) you will find plenty of content in the form of </span><em class="italic"><span class="koboSpan" id="kobo.525.1">pre-packaged units of work referred to in Ansible as roles and collections.</span></em><span class="koboSpan" id="kobo.526.1"> It’s much easier to reuse and share Ansible roles as organized units of automation because they are decoupled from the rest of the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">playbook framework.</span></span></p>
<p><span class="koboSpan" id="kobo.528.1">If you’re a programmer, you can think of roles as functions or methods. </span><span class="koboSpan" id="kobo.528.2">Easy enough? </span><span class="koboSpan" id="kobo.528.3">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">get cooking!</span></span></p>
<h2 id="_idParaDest-180"><a id="_idTextAnchor230"/><span class="koboSpan" id="kobo.530.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.531.1">For this recipe, you will need </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.533.1">Oracle Linux</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.534.1">Ansible</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.535.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.536.1">Technical requirements</span></em><span class="koboSpan" id="kobo.537.1"> section at the beginning of this chapter if you need help </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">i</span><a id="_idTextAnchor231"/><span class="koboSpan" id="kobo.539.1">nstalling Ansible.</span></span></p>
<h2 id="_idParaDest-181"><a id="_idTextAnchor232"/><span class="koboSpan" id="kobo.540.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.541.1">It’s not difficult to convert</span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.542.1"> a series of tasks into roles. </span><span class="koboSpan" id="kobo.542.2">It’s really just a matter</span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.543.1"> of stripping out the tasks and organizing them into categories that represent a role. </span><span class="koboSpan" id="kobo.543.2">This recipe aims to describe that process, and hopefully by the end, you will have a good understanding of how to do the same with </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">your playbooks.</span></span></p>
<h3><span class="koboSpan" id="kobo.545.1">Original playbook</span></h3>
<p><span class="koboSpan" id="kobo.546.1">To kick things off, let’s first take a look at a playbook </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.547.1">that doesn’t leverage roles so we can dive into w</span><a id="_idTextAnchor233"/><span class="koboSpan" id="kobo.548.1">hat needs to </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">be done.</span></span></p>
<p><span class="koboSpan" id="kobo.550.1">A typical playbook that does not leverage roles looks something </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer221">
<span class="koboSpan" id="kobo.552.1"><img alt="Figure 8.18 – Long playbook without roles" src="image/B18349_08_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.553.1">Figure 8.18 – Long playbook without roles</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.554.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.555.1">The screenshot fades out at the end because it’s a long playbook and the entire contents of the playbook are </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">not important.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">This playbook automates</span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.558.1"> several tasks. </span><span class="koboSpan" id="kobo.558.2">First, it creates a standard user if they do not already exist, then it installs Podman via the container-tools AppStream module, after which it launches an NGINX container, and then eventually it proceeds to upgrading all the packages on the system and checking whether the system needs to </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">be rebooted.</span></span></p>
<p><span class="koboSpan" id="kobo.560.1">As you can see from this example, if you write all your tasks directly into a playbook, it doesn’t take long for that file to become massive and unwieldy. </span><span class="koboSpan" id="kobo.560.2">Before long, you will find yourself repeating preparatory tasks throughout, and you’ll most likely add hash marks at the beginning of each line for unnecessary tasks, which will make the automation engine see it as a comment rather than code – you might even find yourself toggling between disabling and enabling tasks in order to target a specific task when running the playbook. </span><span class="koboSpan" id="kobo.560.3">This can become overwhelming, and if you’re not careful, you might end up removing bits of code when you don’t need them (even though sometimes, you might need them). </span><span class="koboSpan" id="kobo.560.4">Roles offer a better way to organize your playbooks. </span><span class="koboSpan" id="kobo.560.5">In fact, you can write as many roles as you want, and neatly call them in the playbook – this makes the playbook</span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.561.1"> far easier to read a</span><a id="_idTextAnchor234"/><span class="koboSpan" id="kobo.562.1">nd maintain </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">over time.</span></span></p>
<h3><span class="koboSpan" id="kobo.564.1">Creating a role</span></h3>
<p><span class="koboSpan" id="kobo.565.1">In Ansible, roles are organized</span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.566.1"> under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">roles</span></strong><span class="koboSpan" id="kobo.568.1"> directory. </span><span class="koboSpan" id="kobo.568.2">You create a folder under </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">roles</span></strong><span class="koboSpan" id="kobo.570.1">, and whatever you name the folder will become the name of the role. </span><span class="koboSpan" id="kobo.570.2">Then within that folder, you create a minimum of one folder called </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">tasks</span></strong><span class="koboSpan" id="kobo.572.1">, which should contain a </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">main.yml</span></strong><span class="koboSpan" id="kobo.574.1"> file defining the primary tasks that the role </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">will perform:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.576.1">Let’s break things up and create a role for our users by creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">users</span></strong><span class="koboSpan" id="kobo.578.1"> folder in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">roles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.580.1"> directory.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.581.1">Your directory structure should look a bit </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">like this:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.583.1">
├── playbook.yml
└── roles
    └── users
        ├── files
        │   └── wallpaper.jpg
        └── tasks
            └── main.yml</span></pre></li> <li><span class="koboSpan" id="kobo.584.1">Now, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">main.yml</span></strong><span class="koboSpan" id="kobo.586.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">tasks</span></strong><span class="koboSpan" id="kobo.588.1"> directory, and let’s port our user-related tasks over into </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">that file.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer222">
<span class="koboSpan" id="kobo.590.1"><img alt="Figure 8.19 – Ansible role for provisioning users" src="image/B18349_08_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.591.1">Figure 8.19 – Ansible role for provisioning users</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.592.1">Now we have the beginnings</span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.593.1"> of a role. </span><span class="koboSpan" id="kobo.593.2">We can take advantage of other features to facilitate pre-configuration operations. </span><span class="koboSpan" id="kobo.593.3">Here are two features that I tend to use most often – </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">files</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.595.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">meta</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">:</span></span><ul><li><span class="koboSpan" id="kobo.598.1">First, you’ll notice we are referencing a </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">files</span></strong><span class="koboSpan" id="kobo.600.1"> directory. </span><span class="koboSpan" id="kobo.600.2">That is a special directory that belongs to a role, and contains files related to </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">that role.</span></span></li><li><span class="koboSpan" id="kobo.602.1">The other is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">meta</span></strong><span class="koboSpan" id="kobo.604.1"> directory that acts as a way to declare dependencies. </span><span class="koboSpan" id="kobo.604.2">For example, since the </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">users</span></strong><span class="koboSpan" id="kobo.606.1"> role depends on certain groups to exist, it may be a good idea to make this role dependent on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">groups</span></strong><span class="koboSpan" id="kobo.608.1"> role first. </span><span class="koboSpan" id="kobo.608.2">To do this, we can simply create a role for </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">groups</span></strong><span class="koboSpan" id="kobo.610.1"> and then call this role from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">meta</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.612.1"> directory.</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.613.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">groups</span></strong><span class="koboSpan" id="kobo.615.1"> role may look like the following. </span><span class="koboSpan" id="kobo.615.2">Notice the directory structure, along with the accompanying</span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.616.1"> files – all of which are elements that make up a role. </span><span class="koboSpan" id="kobo.616.2">Your directory structure should look </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.618.1">
├── playbook.yml
└── roles
    └── groups
        └── tasks
            └── main.yml</span></pre></li> <li><span class="koboSpan" id="kobo.619.1">The actual task should be written in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">main.yml</span></strong><span class="koboSpan" id="kobo.621.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer223">
<span class="koboSpan" id="kobo.623.1"><img alt="Figure 8.20 – Ansible role for user groups" src="image/B18349_08_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.624.1">Figure 8.20 – Ansible role for user groups</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.625.1">Now, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">meta/main.yml</span></strong><span class="koboSpan" id="kobo.627.1"> file for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">users</span></strong><span class="koboSpan" id="kobo.629.1"> role, we just need to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">groups</span></strong><span class="koboSpan" id="kobo.631.1"> role as </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">a dependency:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.633.1">
---
dependencies:
  - role: groups</span></pre></li> <li><span class="koboSpan" id="kobo.634.1">Finally, run the playbook with the </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.636.1">$ ansible-playbook playbook.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.637.1">You have successfully created a role </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">within Ansible.</span></span></p></li> <li><span class="koboSpan" id="kobo.639.1">Next, repeat this process until you have everything organized into roles. </span><span class="koboSpan" id="kobo.639.2">For me, I ended up with the following</span><a id="_idIndexMarker723"/> <span class="No-Break"><span class="koboSpan" id="kobo.640.1">directory structure:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.641.1">
├── playbook.yml
└── roles
    ├── base_software
    │   └── tasks
    │       └── main.yml
    ├── containers
    │   └── tasks
    │       └── main.yml
    ├── get_hostname
    │   └── tasks
    │       └── main.yml
    ├── groups
    │   └── tasks
    │       └── main.yml
    ├── update_packages
    │   ├── meta
    │   │   └── main.yml
    │   └── tasks
    │       └── main.yml
    ├── uptime
    │   └── tasks
    │       └── main.yml
    └── users
        ├── files
        │   └── wallpaper.jpg
        ├── meta
        │   └── main.yml
        └── tasks
            └── main.yml</span></pre></li> </ol>
<h3><span class="koboSpan" id="kobo.642.1">New and improved playbook</span></h3>
<p><span class="koboSpan" id="kobo.643.1">As for the actual playbook</span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.644.1"> itself, it can now be simplified </span><a id="_idTextAnchor235"/><span class="koboSpan" id="kobo.645.1">to just </span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer224">
<span class="koboSpan" id="kobo.647.1"><img alt="Figure 8.21 – Ansible playbook leveraging roles" src="image/B18349_08_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.648.1">Figure 8.21 – Ansible playbook leveraging roles</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.649.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.650.1">Notice that we are not listing out the </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">base_software</span></strong><span class="koboSpan" id="kobo.652.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">groups</span></strong><span class="koboSpan" id="kobo.654.1"> roles in the playbook as these are dependencies we have defined under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">meta</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.656.1"> directories.</span></span></p>
<p><span class="koboSpan" id="kobo.657.1">As you can see, instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1">tasks</span></strong><span class="koboSpan" id="kobo.659.1">, we are now simply referencing </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">roles</span></strong><span class="koboSpan" id="kobo.661.1">. </span><span class="koboSpan" id="kobo.661.2">It is very neat and organized, and much easier to understand what the playbook is set out to do. </span><span class="koboSpan" id="kobo.661.3">If you want to understand what a specific role does, all you need to do is look into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">roles</span></strong><span class="koboSpan" id="kobo.663.1"> directory for the name of the respective role and examine the </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">main.yml</span></strong><span class="koboSpan" id="kobo.665.1"> file in the role’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">tasks</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.667.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.668.1">When you’re ready, run the playbook just as you </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">normally would:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.670.1">
$ ansib</span><a id="_idTextAnchor236"/><span class="koboSpan" id="kobo.671.1">le-playbook playbook.yml</span></pre> <p><span class="koboSpan" id="kobo.672.1">If all went well, it should have accomplished everything that was being done in our original playbook; however, this time around we are using Ansible roles, and thus our playbook will be far easier</span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.673.1"> to maintain </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">going forward.</span></span></p>
<p><span class="koboSpan" id="kobo.675.1">The source code for this recipe can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/ansible-roles"><span class="No-Break"><span class="koboSpan" id="kobo.677.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/ansible-roles</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.678.1">.</span></span></p>
<h1 id="_idParaDest-182"><a id="_idTextAnchor237"/><span class="koboSpan" id="kobo.679.1">Managing secrets with Ansible Vault</span></h1>
<p><span class="koboSpan" id="kobo.680.1">This recipe aims to provide guidance on leveraging </span><strong class="bold"><span class="koboSpan" id="kobo.681.1">Ansible Vault</span></strong><span class="koboSpan" id="kobo.682.1"> for </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.683.1">secrets management</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.685.1">There are multiple ways to store secrets</span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.686.1"> in Ansible. </span><span class="koboSpan" id="kobo.686.2">When starting out, you may be inclined to encrypt the entire </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">hosts</span></strong><span class="koboSpan" id="kobo.688.1"> file. </span><span class="koboSpan" id="kobo.688.2">This works and keeps everything secure in the context of using a version control system without compromising your secrets/passwords; however, it is not manageable, nor does it provide any useful information in version control systems because all you’re left with is a long nonsensical string of </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">encrypted characters.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor238"/><span class="koboSpan" id="kobo.690.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.691.1">You will need the following for </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">this recipe:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.693.1">Oracle Linux</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.694.1">Ansible</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.695.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.696.1">Technical requirements</span></em><span class="koboSpan" id="kobo.697.1"> section at the beginning of this chapter i</span><a id="_idTextAnchor239"/><span class="koboSpan" id="kobo.698.1">f you need help </span><span class="No-Break"><span class="koboSpan" id="kobo.699.1">installing Ansible.</span></span></p>
<h2 id="_idParaDest-184"><a id="_idTextAnchor240"/><span class="koboSpan" id="kobo.700.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.701.1">First, let’s take a look at whole-file encryption. </span><span class="koboSpan" id="kobo.701.2">To begin, we’ll first</span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.702.1"> need to define our Ansib</span><a id="_idTextAnchor241"/><span class="koboSpan" id="kobo.703.1">le host file in </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">plain text.</span></span></p>
<h3><span class="koboSpan" id="kobo.705.1">Whole-file encryption</span></h3>
<p><span class="koboSpan" id="kobo.706.1">Typically, an Ansible </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.707.1">hosts file will look something </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.709.1">
# hosts
[host1]
192.168.2.70
[host1:vars]
ansible_user=admin
ansible_password=B@by-Y0dA
ansible_connection=ssh
ansible_shell_type=powershell
[host2]
192.168.2.71
[host2:vars]
ansible_user=admin
ansible_password=B@by-Y0dA
ansible_connection=ssh
ansible_shell_type=powershell</span></pre> <p><span class="koboSpan" id="kobo.710.1">You can encrypt the file by running the following into </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">the terminal/console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.712.1">
$ ansible-vault encrypt hosts --ask-vault-pass
New Vault password:
Confirm New Vault password:
Encryption successful</span></pre> <p><span class="koboSpan" id="kobo.713.1">I am using a randomly generated string as my </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">vault password.</span></span></p>
<p><span class="koboSpan" id="kobo.715.1">Another way to encrypt the file is to use a </span><strong class="bold"><span class="koboSpan" id="kobo.716.1">vault password file</span></strong><span class="koboSpan" id="kobo.717.1"> so you don’t have to input the password every time you need</span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.718.1"> to encrypt/decrypt something. </span><span class="koboSpan" id="kobo.718.2">To do this, create</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.719.1"> a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">vault_password</span></strong><span class="koboSpan" id="kobo.721.1"> and paste only the vault password </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">into it.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.723.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.724.1">It’s a good idea to set the permissions to </span><strong class="source-inline"><span class="koboSpan" id="kobo.725.1">0600</span></strong><span class="koboSpan" id="kobo.726.1"> on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.727.1">vault_password</span></strong><span class="koboSpan" id="kobo.728.1"> file (this can be done by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">chmod 0600 ./vault_password</span></strong><span class="koboSpan" id="kobo.730.1">) so it’s protected from </span><span class="No-Break"><span class="koboSpan" id="kobo.731.1">other users.</span></span></p>
<p><span class="koboSpan" id="kobo.732.1">Now, instead of using </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">--ask-vault-pass</span></strong><span class="koboSpan" id="kobo.734.1">, you can use </span><span class="No-Break"><span class="koboSpan" id="kobo.735.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.736.1">
$ ansible-vault encrypt hosts --vault-password-file vault_password
Encryption successful</span></pre> <p><span class="koboSpan" id="kobo.737.1">Cool! </span><span class="koboSpan" id="kobo.737.2">Just be sure to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">vault_password</span></strong><span class="koboSpan" id="kobo.739.1"> file to your </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">.gitignore</span></strong><span class="koboSpan" id="kobo.741.1"> list to avoid checking that into </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">version control.</span></span></p>
<p><span class="koboSpan" id="kobo.743.1">Now if you </span><strong class="source-inline"><span class="koboSpan" id="kobo.744.1">cat</span></strong><span class="koboSpan" id="kobo.745.1"> your </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">hosts</span></strong><span class="koboSpan" id="kobo.747.1"> file, you will see the contents </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">are encrypted:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer225">
<span class="koboSpan" id="kobo.749.1"><img alt="Figure 8.22 – Contents of encrypted “hosts” file" src="image/B18349_08_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.750.1">Figure 8.22 – Contents of encrypted “hosts” file</span></p>
<p><span class="koboSpan" id="kobo.751.1">This is great, but anytime you need to make changes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">hosts</span></strong><span class="koboSpan" id="kobo.753.1"> file, you are faced with </span><span class="No-Break"><span class="koboSpan" id="kobo.754.1">two options:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.755.1">Decrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">hosts</span></strong><span class="koboSpan" id="kobo.757.1"> file, make your changes, then encrypt </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">it again</span></span></li>
<li><span class="koboSpan" id="kobo.759.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">ansible-vault edit hosts</span></strong><span class="koboSpan" id="kobo.761.1"> to leverage ansible-vault’s </span><em class="italic"><span class="koboSpan" id="kobo.762.1">vim</span></em><span class="koboSpan" id="kobo.763.1"> mode to edit </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">the file</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.765.1">These aren’t terrible options, but in practice this can become cumbersome. </span><span class="koboSpan" id="kobo.765.2">I propose a better way, which is to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">encrypt_string</span></strong><span class="koboSpan" id="kobo.767.1"> method within Ansible Vault to encrypt only the sensitive data, and use</span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.768.1"> variables in place of passwords/secrets to refe</span><a id="_idTextAnchor242"/><span class="koboSpan" id="kobo.769.1">rence those </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">encrypted strings.</span></span></p>
<h3><span class="koboSpan" id="kobo.771.1">Hiding passwords in plain sight</span></h3>
<p><span class="koboSpan" id="kobo.772.1">Hiding passwords in plain sight</span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.773.1"> is in direct contrast to the whole-file encryption we described previously. </span><span class="koboSpan" id="kobo.773.2">We’re still going to encrypt our sensitive data, but this time around we’ll encrypt </span><em class="italic"><span class="koboSpan" id="kobo.774.1">only</span></em><span class="koboSpan" id="kobo.775.1"> the sensitive data, and leave everything else in plain, </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">unencrypted text:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.777.1">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.778.1">encrypt_string</span></strong><span class="koboSpan" id="kobo.779.1"> method. </span><span class="koboSpan" id="kobo.779.2">In this example, the password we want to encrypt is </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">B@by-Y0dA</span></strong><span class="koboSpan" id="kobo.781.1"> and we will name the variable that identifies this password </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">admin_password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.784.1">.</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.785.1">$ ansible-vault encrypt_string --vault-password-file vault_password 'B@by-Y0dA' --name 'admin_password'</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.786.1">In the terminal/console, once</span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.787.1"> you press </span><em class="italic"><span class="koboSpan" id="kobo.788.1">Enter</span></em><span class="koboSpan" id="kobo.789.1"> you will see what </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">'B@by-Y0dA'</span></strong><span class="koboSpan" id="kobo.791.1"> looks like </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">once encrypted:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer226">
<span class="koboSpan" id="kobo.793.1"><img alt="Figure 8.23 – Encrypting secrets" src="image/B18349_08_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.794.1">Figure 8.23 – Encrypting secrets</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.795.1">Next, we need to copy the output of that into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">secrets.yml</span></strong><span class="koboSpan" id="kobo.797.1"> file (you could just append </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">&gt;&gt; secrets.yml</span></strong><span class="koboSpan" id="kobo.799.1"> to the command entered previously to automatically copy the output to the file). </span><span class="koboSpan" id="kobo.799.2">Here's </span><span class="No-Break"><span class="koboSpan" id="kobo.800.1">an example:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.801.1">$ ansible-vault encrypt_string --vault-password-file vault_password 'B@by-Y0dA' --name 'admin_password' &gt;&gt; secrets.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.802.1">Your </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">secrets.yml</span></strong><span class="koboSpan" id="kobo.804.1"> file should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">like this:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer227">
<span class="koboSpan" id="kobo.806.1"><img alt="Figure 8.24 – Contents of secrets.yml file" src="image/B18349_08_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.807.1">Figure 8.24 – Contents of secrets.yml file</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.808.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.809.1">You may notice the encrypted value is different every time you run the command, even when you encrypt the same value using the same password. </span><span class="koboSpan" id="kobo.809.2">The random salt changes each time you encrypt it; this is by design, and the intent is to ensure that the final encrypted output is never the same (even</span><a id="_idTextAnchor243"/><span class="koboSpan" id="kobo.810.1"> when using the </span><span class="No-Break"><span class="koboSpan" id="kobo.811.1">same content).</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.812.1">Now that you have it</span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.813.1"> encrypted, you can replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">ansible_password</span></strong><span class="koboSpan" id="kobo.815.1"> value in your host file with the name of the variable that references the password (in this </span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">case, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">admin_password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.819.1">
# hosts
[host1]
192.168.2.70
[host1:vars]
ansible_user=admin
ansible_password={{ admin_password }}
ansible_connection=ssh
ansible_shell_type=powershell
[host2]
192.168.2.71
[host2:vars]
ansible_user=admin
ansible_password={{ admin_password }}
ansible_connection=ssh
ansi</span><a id="_idTextAnchor244"/><span class="koboSpan" id="kobo.820.1">ble_shell_type=powershell</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.821.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.822.1">The advantage of  </span><strong class="bold"><span class="koboSpan" id="kobo.823.1">variable-level encryption</span></strong><span class="koboSpan" id="kobo.824.1"> is that files can still easily be read and understood because</span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.825.1"> there will be a mixture of plaintext alongside the </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">encrypted variables.</span></span></p>
<p><span class="koboSpan" id="kobo.827.1">The source code for this recipe can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/ansible-vault"><span class="No-Break"><span class="koboSpan" id="kobo.829.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/ansible-vault</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.830.1">.</span></span></p>
<h1 id="_idParaDest-185"><span class="koboSpan" id="kobo.831.1">Cooking up the perf</span><a id="_idTextAnchor245"/><span class="koboSpan" id="kobo.832.1">ect lab environment with Vagrant</span></h1>
<p><span class="koboSpan" id="kobo.833.1">Recently at work, I was tasked with preparing a demo of </span><strong class="bold"><span class="koboSpan" id="kobo.834.1">Oracle Linux Manager</span></strong><span class="koboSpan" id="kobo.835.1"> and showcasing several features</span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.836.1"> of the software. </span><span class="koboSpan" id="kobo.836.2">This is an easy enough thing to do, but there</span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.837.1"> are several barriers to entry that stand in the way </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.838.1">before you can access th</span><a id="_idTextAnchor246"/><span class="koboSpan" id="kobo.839.1">e web GUI for Oracle </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">Linux Manager.</span></span></p>
<p><span class="koboSpan" id="kobo.841.1">For starters, Oracle Linux Manager requires Oracle Linux 7; it’s not yet certified on Oracle Linux 8. </span><span class="koboSpan" id="kobo.841.2">So, I set out to download the ISO for Oracle Linux 7 and proceeded to create a VM in VirtualBox and installed the OS. </span><span class="koboSpan" id="kobo.841.3">I then wanted to SSH into the box, so I had to go into the settings menu for that VM and configure port forwarding from the host to the guest. </span><span class="koboSpan" id="kobo.841.4">At this point, I was able to SSH in, and then followed the installation instructions for Oracle Linux Manager. </span><span class="koboSpan" id="kobo.841.5">It’s not that bad setting things up, but there were several speed-bumps along the way. </span><span class="koboSpan" id="kobo.841.6">For instance, I needed to decide on a database to use. </span><span class="koboSpan" id="kobo.841.7">Oracle supports only Oracle Database</span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.842.1"> for use with Oracle Linux Manager, but for the sake of brevity (and since this was only ever intended as a lab demonstration of Oracle Linux Manager), I decided to </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">use </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.844.1">PostgreSQL</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.845.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.846.1">With so many manual steps, I’d be inclined to keep my newly created virtual machine and take care of it like a pet. </span><span class="koboSpan" id="kobo.846.2">They say containers are like cattle, and virtual machines are like pets. </span><span class="koboSpan" id="kobo.846.3">That is, until you’ve started using tools like Vagrant. </span><span class="koboSpan" id="kobo.846.4">Vagrant does a good job making your virtual machines blend in with the cattle – thanks to how easy it is to recreate your virtual machines using Vagrant, you no longer need to care for them the way you had to previously if you weren’t </span><span class="No-Break"><span class="koboSpan" id="kobo.847.1">using Vagrant.</span></span></p>
<p><span class="koboSpan" id="kobo.848.1">This recipe will walk you through the process of creating a lab environment </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">using </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.850.1">Vagrant</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">.</span></span></p>
<h2 id="_idParaDest-186"><a id="_idTextAnchor247"/><span class="koboSpan" id="kobo.852.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.853.1">You will need the following for </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">this recipe:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.855.1">Oracle Linux</span></span></li>
<li><span class="koboSpan" id="kobo.856.1">Oracle </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">VM VirtualBox</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.858.1">Vagrant</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.859.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.860.1">Technical requirements</span></em><span class="koboSpan" id="kobo.861.1"> section at the beginning </span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.862.1">of this chapter if you need help installing Oracle</span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.863.1"> VM VirtualBox </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">and Vagrant.</span></span></p>
<h2 id="_idParaDest-187"><a id="_idTextAnchor248"/><span class="koboSpan" id="kobo.865.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.866.1">Vagrant is a tool used for managing the lifecycle of virtual machines. </span><span class="koboSpan" id="kobo.866.2">In this recipe, we’re going to create a Vagrant box</span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.867.1"> that automatically installs and configures Oracle Linux Manager. </span><span class="koboSpan" id="kobo.867.2">Oracle Linux Manager requires Oracle Linux 7. </span><span class="koboSpan" id="kobo.867.3">In this case, we can use the official </span><strong class="bold"><span class="koboSpan" id="kobo.868.1">Oracle Linux 7 Vagrant Box</span></strong><span class="koboSpan" id="kobo.869.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">our base:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.871.1">
$ vagrant init oraclelinux/7 https://oracle.github.io/vagrant-projects/boxes/oraclelinux/7.json</span></pre> <p><span class="koboSpan" id="kobo.872.1">Great, that has pulled in a nice base file for us to start with. </span><span class="koboSpan" id="kobo.872.2">Let’s look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">Vagrantfile</span></strong><span class="koboSpan" id="kobo.874.1"> file to see </span><span class="No-Break"><span class="koboSpan" id="kobo.875.1">what’s inside:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.876.1">
# Vagrantfile
Vagrant.configure("2") do |config|
  config.vm.box = "oraclelinux/7"
  config.vm.box_url = "https://oracle.github.io/vagrant-projects/boxes/oraclelinux/7.json"
end</span></pre> <p><span class="koboSpan" id="kobo.877.1">The actual </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">Vagrantfile</span></strong><span class="koboSpan" id="kobo.879.1"> generated by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">init</span></strong><span class="koboSpan" id="kobo.881.1"> command contains 69 lines of code, but 65 of those lines are comments, hence I removed them to help make this recipe more </span><span class="No-Break"><span class="koboSpan" id="kobo.882.1">easily comprehensible.</span></span></p>
<p><span class="koboSpan" id="kobo.883.1">As we can see from this </span><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">Vagrantfile</span></strong><span class="koboSpan" id="kobo.885.1">, all we need</span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.886.1"> is those four lines to launch an Oracle Linux 7 instance in </span><strong class="bold"><span class="koboSpan" id="kobo.887.1">VM VirtualBox</span></strong><span class="koboSpan" id="kobo.888.1">. </span><span class="koboSpan" id="kobo.888.2">If you want to test it, enter the </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">vagrant up</span></strong><span class="koboSpan" id="kobo.890.1"> command and when it’s up and running, you can</span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.891.1"> simply enter the </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">vagrant ssh</span></strong><span class="koboSpan" id="kobo.893.1"> command to access the VM</span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.894.1"> and see how it works. </span><span class="koboSpan" id="kobo.894.2">Once finished, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">vagrant destroy</span></strong><span class="koboSpan" id="kobo.896.1"> to bring down the VM. </span><span class="koboSpan" id="kobo.896.2">Now, let’s dive into ways to make this more useful; because I want to be able to type </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">vagrant up</span></strong><span class="koboSpan" id="kobo.898.1"> and have not only an Oracle Linux VM, but also want that same command to result in a working copy of Oracle </span><span class="No-Break"><span class="koboSpan" id="kobo.899.1">Linux Man</span><a id="_idTextAnchor249"/><span class="koboSpan" id="kobo.900.1">ager.</span></span></p>
<p><span class="koboSpan" id="kobo.901.1">First things first, let’s</span><a id="_idTextAnchor250"/><span class="koboSpan" id="kobo.902.1"> review</span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.903.1"> the installation and configuration instructions for Oracle Linux Manager – this can be found at </span><a href="https://docs.oracle.com/en/operating-systems/oracle-linux-manager/2.10/install/#Oracle-Linux-Manager"><span class="koboSpan" id="kobo.904.1">https://docs.oracle.com/en/operating-systems/oracle-linux-manager/2.10/install/#Oracle-Linux-Manager</span></a><span class="koboSpan" id="kobo.905.1">. </span><span class="koboSpan" id="kobo.905.2">Since we aren’t using an Oracle database, we will divert slightly from the instructions outlined – this means we’ll skip anything related to Oracle databases (for example, we won’t need the Oracle Instant Client and </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.906.1">SQL*Plus</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.907.1"> packages).</span></span></p>
<p><span class="koboSpan" id="kobo.908.1">To illustrate what we’re going to do, I’ll list all the steps from the guide, applying </span><strong class="bold"><span class="koboSpan" id="kobo.909.1">bold</span></strong><span class="koboSpan" id="kobo.910.1"> style to the steps we want to keep. </span><span class="koboSpan" id="kobo.910.2">The ones that are not bold will </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">be skipped:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">sudo yum install </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">oracle-instantclient18.5-basic-18.5.0.0.0-3.x86_64.rpm oracle-instantclient18.5-sqlplus-18.5.0.0.0-3.x86_64.rpm</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.914.1">echo "/usr/lib/oracle/18.5/client64/lib" | sudo </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">tee /etc/ld.so.conf.d/oracle-instantclient18.5.conf</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">sudo ldconfig</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.917.1">sudo yum list installed | </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.918.1">grep jta</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.919.1">sudo yum </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.920.1">remove jta</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.921.1">echo «exclude=jta*» &gt;&gt; /</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.922.1">etc/yum.conf</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.923.1">sudo yum-config-manager –</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.924.1">disable ol7_addons</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">sudo firewall-cmd --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">permanent --add-port=69/udp</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.927.1">sudo firewall-cmd --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">permanent --add-port=80/tcp</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">sudo firewall-cmd --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">permanent --add-port=443/tcp</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">sudo firewall-cmd --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">permanent --add-port=5222/tcp</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">sudo firewall-cmd --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">permanent --add-port=5269/tcp</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">sudo systemctl </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.936.1">reload firewalld</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.937.1">sudo yum </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.938.1">install oracle-release-el7</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.939.1">sudo yum </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.940.1">install oracle-linux-manager-server-release-el7</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.941.1">sudo yum-config-manager --</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.942.1">enable ol7_optional_latest</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.943.1">sudo yum install</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.944.1">spacewalk-oracle</span></strong> <span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.945.1">spacecmd spacewalk-utils</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.946.1">sudo </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.947.1">spacewalk-setup --external-oracle</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.948.1">And that’s basically it. </span><span class="koboSpan" id="kobo.948.2">The following</span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.949.1"> is for additional changes that we need</span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.950.1"> to make to use Oracle Linux Manager </span><span class="No-Break"><span class="koboSpan" id="kobo.951.1">with PostgreSQL:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.952.1">
sudo yum install spacewalk-setup-postgresql spacewalk-postgresql</span></pre> <p><span class="koboSpan" id="kobo.953.1">Finally, we’ll need to provide an answer file since the automation we’re doing in Vagrant cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.954.1">be interactive:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.955.1">
sudo spacewalk-setup --non-interactive --answer-file=/tmp/answer-file.txt</span></pre> <p><span class="koboSpan" id="kobo.956.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.957.1">answer-file.txt</span></strong><span class="koboSpan" id="kobo.958.1"> and place the following content into </span><span class="No-Break"><span class="koboSpan" id="kobo.959.1">the file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.960.1">
admin-email = root@localhost
ssl-set-cnames = spacewalk
ssl-set-org = Oracle
ssl-set-org-unit = OLM
ssl-set-city = Raleigh
ssl-set-state = NC
ssl-set-country = US
ssl-password = Password1
ssl-set-email = root@localhost
ssl-config-sslvhost = Y
db-backend = postgresql
db-name = spaceschema
db-user = spaceuser
db-password = Password1
db-host = localhost
db-port = 5432
enable-tftp = Y</span></pre> <p><span class="koboSpan" id="kobo.961.1">This summarizes the bulk of the installation </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.962.1">and configuration steps. </span><span class="koboSpan" id="kobo.962.2">Next, in order to make</span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.963.1"> all of this work so that we can deploy and provision Oracle Linux Manager automatically using Vagrant, we need to make some very simple changes. </span><span class="koboSpan" id="kobo.963.2">All we really need to do is paste those steps into a </span><em class="italic"><span class="koboSpan" id="kobo.964.1">Bash shell script</span></em><span class="koboSpan" id="kobo.965.1"> file and tell Vagrant to use a provisioner to run these commands on the box. </span><span class="koboSpan" id="kobo.965.2">Also, again, since automation cannot be interactive, we just need to add </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">-y</span></strong><span class="koboSpan" id="kobo.967.1"> to all the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">yum</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.969.1"> commands.</span></span></p>
<p><span class="koboSpan" id="kobo.970.1">Therefore, to clean things up and prepare them for Vagrant, our Bash script will look something </span><span class="No-Break"><span class="koboSpan" id="kobo.971.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.972.1">
#!/bin/bash
yum remove jta -y
echo "exclude=jta*" &gt;&gt; /etc/yum.conf
yum-config-manager --disable ol7_addons
yum install oracle-release-el7 -y
yum install oracle-linux-manager-server-release-el7 -y
yum-config-manager --enable ol7_optional_latest -y
yum install spacewalk-schema-2.10.14-1.el7 spacewalk-setup-postgresql spacewalk-postgresql spacecmd spacewalk-utils -y
spacewalk-setup --non-interactive --answer-file=/tmp/answer-file.txt</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.973.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.974.1">At some point while authoring this recipe, an update was made to the spacewalk-schema package making it no longer compatible with PostgreSQL. </span><span class="koboSpan" id="kobo.974.2">This can be fixed by pinning the spacewalk-schema package to </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">spacewalk-schema-2.10.14-1.el7</span></strong><span class="koboSpan" id="kobo.976.1"> as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.977.1">preceding snippet.</span></span></p>
<p><span class="koboSpan" id="kobo.978.1">I removed the call to </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">sudo</span></strong><span class="koboSpan" id="kobo.980.1"> for each step</span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.981.1"> since everything runs as root during the provisioning</span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.982.1"> phase </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">of Vagrant.</span></span></p>
<p><span class="koboSpan" id="kobo.984.1">Now for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">Vagrantfile</span></strong><span class="koboSpan" id="kobo.986.1">, add a few lines so that Vagrant can copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">answer-file.txt</span></strong><span class="koboSpan" id="kobo.988.1"> file to the guest machine, then tell Vagrant to execute the script we just wrote. </span><span class="koboSpan" id="kobo.988.2">We’ll also create a private network, which allows host-only access to the machine using a specific IP (this will allow us to easily access Oracle Linux Manager via our </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1">web browser):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer228">
<span class="koboSpan" id="kobo.990.1"><img alt="F﻿igure 8.25 – Vagrant file for deploying OLM" src="image/B18349_08_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.991.1">F</span><a id="_idTextAnchor251"/><span class="koboSpan" id="kobo.992.1">igure 8.25 – Vagrant file for deploying OLM</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.993.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.994.1">On Linux/Unix-based systems, VirtualBox will only allow IP addresses in </span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">192.168.56.0/21</span></strong><span class="koboSpan" id="kobo.996.1"> range to be assigned to host-only adapters. </span><span class="koboSpan" id="kobo.996.2">This allows for IP addresses starting at </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">192.168.56.1</span></strong><span class="koboSpan" id="kobo.998.1"> and ending </span><span class="No-Break"><span class="koboSpan" id="kobo.999.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">192.168.63.254</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1002.1">Now we can </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.1003.1">review what</span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.1004.1"> our directory should </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">look like:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1006.1">
└── oracle-linux-manager
    ├── answer-file.txt
    ├── provision.sh
    └── Vagrantfile</span></pre> <p><span class="koboSpan" id="kobo.1007.1">We’re ready to fire </span><span class="No-Break"><span class="koboSpan" id="kobo.1008.1">things up:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1009.1">
$ vagrant up
…
…
…
--&gt; default: Running provisioner: shell…
    default: Running: inline script
    default: Ac</span><a id="_idTextAnchor252"/><span class="koboSpan" id="kobo.1010.1">cess Oracle Linux Manager at https://192.168.56.10</span></pre> <p><span class="koboSpan" id="kobo.1011.1">You’ll watch as the provisioning script installs and configures Oracle Linux Manager, and within a matter of minutes, you’ll be able to point your browser to the IP address defined for the virtual machine</span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.1012.1"> to access Oracle Linux Manager. </span><span class="koboSpan" id="kobo.1012.2">The best part about this is everything is </span><strong class="bold"><span class="koboSpan" id="kobo.1013.1">defined as code</span></strong><span class="koboSpan" id="kobo.1014.1">. </span><span class="koboSpan" id="kobo.1014.2">Everything we created in this recipe amounts to just 6 KB in size! </span><span class="koboSpan" id="kobo.1014.3">Vagrant does an amazing job at solving the classic “</span><em class="italic"><span class="koboSpan" id="kobo.1015.1">it works on my machine</span></em><span class="koboSpan" id="kobo.1016.1">” problem. </span><span class="koboSpan" id="kobo.1016.2">You can take these 6 KB of code and deploy your work on any machine (Mac, Windows, Linux, etc.) </span><a id="_idTextAnchor253"/><span class="koboSpan" id="kobo.1017.1">– all you need is Vagrant and Oracle </span><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">VM VirtualBox.</span></span></p>
<p><span class="koboSpan" id="kobo.1019.1">We could take this automation a few steps further to make it even more useful. </span><span class="koboSpan" id="kobo.1019.2">For example, we could automate the creation of the first user for Oracle Linux Manager, automatically create the channels, repositories, and activation keys, then create clients for OLM and connect to them automatically. </span><span class="koboSpan" id="kobo.1019.3">Getting</span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.1020.1"> into the details for all that is beyond the scope of this recipe, but if you’re interested</span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.1021.1"> in seeing how this is done, I’ve got the solution published on GitHub – you can find that </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">here: </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/vagrant"><span class="No-Break"><span class="koboSpan" id="kobo.1023.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/vagrant</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1024.1">.</span></span></p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor254"/><span class="koboSpan" id="kobo.1025.1">Using Packer to modify source images</span></h1>
<p><span class="koboSpan" id="kobo.1026.1">Packer is a tool used</span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.1027.1"> for automating the</span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.1028.1"> creation of machine images. </span><span class="koboSpan" id="kobo.1028.2">In this recipe, we’re going to use Packer to reference an </span><strong class="bold"><span class="koboSpan" id="kobo.1029.1">Oracle Linux 8</span></strong><span class="koboSpan" id="kobo.1030.1"> platform image as its source, install something using a provisioner, and push</span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.1031.1"> up a new OCID image with these changes </span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1">onto OCI.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1033.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1034.1">Although OCI features a free tier that contains “Always Free” resources, this does not include the ability to store images. </span><span class="koboSpan" id="kobo.1034.2">If you wish to follow along with this recipe, you will need to use a </span><span class="No-Break"><span class="koboSpan" id="kobo.1035.1">paid account.</span></span></p>
<h2 id="_idParaDest-189"><a id="_idTextAnchor255"/><span class="koboSpan" id="kobo.1036.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1037.1">For this recipe, you will need </span><span class="No-Break"><span class="koboSpan" id="kobo.1038.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1039.1">Oracle Linux</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1040.1">Packer</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1041.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.1042.1">Technical requirements</span></em><span class="koboSpan" id="kobo.1043.1"> section at the beginning of this c</span><a id="_idTextAnchor256"/><span class="koboSpan" id="kobo.1044.1">hapter if you need help </span><span class="No-Break"><span class="koboSpan" id="kobo.1045.1">installing Packer.</span></span></p>
<h2 id="_idParaDest-190"><a id="_idTextAnchor257"/><span class="koboSpan" id="kobo.1046.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1047.1">Packer is often overlooked </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.1048.1">because it seems so simple on the surface; however, don’t let</span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.1049.1"> this simplicity fool you – Packer is incredibly powerful and useful. </span><span class="koboSpan" id="kobo.1049.2">In this recipe, we’re going to use Packer to reference some release of Oracle Linux 8 as its base image, install something using a provisioner, and push up a new OCID image with these changes onto </span><span class="No-Break"><span class="koboSpan" id="kobo.1050.1">the OCI:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1051.1">First, we will specify a Packer plugin that provides a builder called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">oracle-oci</span></strong><span class="koboSpan" id="kobo.1053.1">, which enables Packer to create machine images for OCI. </span><span class="koboSpan" id="kobo.1053.2">We can do that in a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">oracle-oci.pkr.hcl</span></strong><span class="koboSpan" id="kobo.1055.1">. </span><span class="koboSpan" id="kobo.1055.2">Input the following at the beginning of </span><span class="No-Break"><span class="koboSpan" id="kobo.1056.1">the file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer229">
<span class="koboSpan" id="kobo.1057.1"><img alt="Figure 8.26 – Packer OCI builder plugin" src="image/B18349_08_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1058.1">Figure 8.26 – Packer OCI builder plugin</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1059.1">Next, we will configure our authentication to OCI using the configuration options specified by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">oracle-oci</span></strong><span class="koboSpan" id="kobo.1061.1"> builder. </span><span class="koboSpan" id="kobo.1061.2">Details on configuring the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">oracle-oci</span></strong><span class="koboSpan" id="kobo.1063.1"> builder</span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.1064.1"> can be reviewed </span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">at </span></span><a href="https://developer.hashicorp.com/packer/plugins/builders/oracle/oci"><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">https://developer.hashicorp.com/packer/plugins/builders/oracle/oci</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1067.1">:</span></span><ul><li><span class="koboSpan" id="kobo.1068.1">There are numerous ways</span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.1069.1"> to do this. </span><span class="koboSpan" id="kobo.1069.2">One way is to reference variables for the authentication details</span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.1070.1"> directly in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">*.pkr.hcl</span></strong><span class="koboSpan" id="kobo.1072.1"> file, </span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1">like this:</span></span></li></ul></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer230">
<span class="koboSpan" id="kobo.1074.1"><img alt="Figure 8.27 – Referencing variables in Packer" src="image/B18349_08_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1075.1">Figure 8.27 – Referencing variables in Packer</span></p>
<ul>
<li><span class="koboSpan" id="kobo.1076.1">Then, we need to declare all of those variables in a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">variables.pkr.hcl</span></strong><span class="koboSpan" id="kobo.1078.1">. </span><span class="koboSpan" id="kobo.1078.2">In this file, we declare the variable and specify the type, as well as providing a description to explain the purpose of the variable. </span><span class="koboSpan" id="kobo.1078.3">Input the following into your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">variables.pkr.hcl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1080.1"> file:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer231">
<span class="koboSpan" id="kobo.1081.1"><img alt="Figure 8.28 – Declaration of variables in Packer" src="image/B18349_08_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1082.1">Figure 8.28 – Declaration of variables in Packer</span></p>
<ul>
<li><span class="koboSpan" id="kobo.1083.1">Finally, we want to assign</span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.1084.1"> values to the variables. </span><span class="koboSpan" id="kobo.1084.2">We place</span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.1085.1"> them in a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">variables.auto.pkrvars.hcl</span></strong><span class="koboSpan" id="kobo.1087.1">. </span><span class="koboSpan" id="kobo.1087.2">It should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.1088.1">like this:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer232">
<span class="koboSpan" id="kobo.1089.1"><img alt="Figure 8.29 – Assigning variables in Packer" src="image/B18349_08_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1090.1">Figure 8.29 – Assigning variables in Packer</span></p>
<ul>
<li><span class="koboSpan" id="kobo.1091.1">Another way is to configure your OCI CLI in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">~/.oci/config</span></strong><span class="koboSpan" id="kobo.1093.1">. </span><span class="koboSpan" id="kobo.1093.2">That</span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.1094.1"> would look something</span><a id="_idIndexMarker769"/> <span class="No-Break"><span class="koboSpan" id="kobo.1095.1">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1096.1">
[DEFAULT]
user=ocid1.user.oc1..&lt;unique_ID&gt;
fingerprint=&lt;your_fingerprint&gt;
key_file=~/.oci/oci_api_key.pem
tenancy=ocid1.tenancy.oc1..&lt;unique_ID&gt;
region=us-ashburn-1
[ADMIN_USER]
user=ocid1.user.oc1..&lt;unique_ID&gt;
fingerprint=&lt;your_fingerprint&gt;
key_file=keys/admin_key.pem
pass_phrase=&lt;your_passphrase&gt;</span></pre></li> </ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.1097.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1098.1">Full details on configuring</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.1099.1"> your OCI CLI can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">here: </span></span><a href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/sdkconfig.htm"><span class="No-Break"><span class="koboSpan" id="kobo.1101.1">https://docs.oracle.com/en-us/iaas/Content/API/Concepts/sdkconfig.htm</span></span></a></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1102.1">Once you have the authentication configured, you can start by defining the base image. </span><span class="koboSpan" id="kobo.1102.2">This should look something like </span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">the following:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer233">
<span class="koboSpan" id="kobo.1104.1"><img alt="Figure 8.30 –  Defining the base image in Packer" src="image/B18349_08_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1105.1">Figure 8.30 –  Defining the base image in Packer</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1106.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1107.1">To get the OCID for Oracle Linux 8, visit the following URL: </span><a href="https://docs.oracle.com/en-us/iaas/images/oracle-linux-8x/"><span class="koboSpan" id="kobo.1108.1">https://docs.oracle.com/en-us/iaas/images/oracle-linux-8x/</span></a><span class="koboSpan" id="kobo.1109.1">. </span><span class="koboSpan" id="kobo.1109.2">This is region specific as well as architecture</span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.1110.1"> specific, so you’ll want to find the latest Oracle Linux 8 image for x86 (or in other words, look for one without </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">aarch64</span></strong><span class="koboSpan" id="kobo.1112.1"> mentioned in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">image name).</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1114.1">Once you’ve defined</span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.1115.1"> the source, you can move on to instructing Packer </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.1116.1">on what to do during the build process. </span><span class="koboSpan" id="kobo.1116.2">In this case, we’ll call a provisioner so we can run a shell command to </span><span class="No-Break"><span class="koboSpan" id="kobo.1117.1">install Git:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer234">
<span class="koboSpan" id="kobo.1118.1"><img alt="Figure 8.31 – Packer provisioners" src="image/B18349_08_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1119.1">Figure 8.31 – Packer provisioners</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1120.1">At this point, we’ve told Packer</span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.1121.1"> about what we want to use for</span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.1122.1"> our source and described what we want to do for our build. </span><span class="koboSpan" id="kobo.1122.2">Your entire file should look something </span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1">like this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer235">
<span class="koboSpan" id="kobo.1124.1"><img alt="Figure 8.32 – Complete Packer file for modifying base images" src="image/B18349_08_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1125.1">Figure 8.32 – Complete Packer file for modifying base images</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1126.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1127.1">In the final file, I replaced the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.1128.1">example</span></strong><span class="koboSpan" id="kobo.1129.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">ol8u8</span></strong><span class="koboSpan" id="kobo.1131.1"> throughout to be a bit more descriptive about what I’m working with. </span><span class="koboSpan" id="kobo.1131.2">This is simply a good form </span><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">of self-documentation.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1133.1">Next,</span><a id="_idTextAnchor258"/><span class="koboSpan" id="kobo.1134.1"> we’re going</span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.1135.1"> to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">packer init</span></strong><span class="koboSpan" id="kobo.1137.1"> to download the </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">external </span></span><span class="No-Break"><a id="_idIndexMarker777"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1139.1">plugin:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1140.1">$</span><a id="_idTextAnchor259"/><span class="koboSpan" id="kobo.1141.1"> packer init .</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1142.1">Finally, let’s go ahead and build the </span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1">OCID image:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1144.1">$ packer build .</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1145.1">Packer will spin up a new Oracle Linux 8.8 instance in the Oracle Cloud. </span><span class="koboSpan" id="kobo.1145.2">Once the machine is running, it will run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1146.1">sudo dnf install -y git</span></strong><span class="koboSpan" id="kobo.1147.1"> to install Git on </span><span class="No-Break"><span class="koboSpan" id="kobo.1148.1">the instance.</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer236">
<span class="koboSpan" id="kobo.1149.1"><img alt="Figure 8.33 – Initial output after running packer build" src="image/B18349_08_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1150.1">Figure 8.33 – Initial output after running packer build</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1151.1">Once Git is installed, it will take a snapshot of the instance and export this as a new OCID image, giving us a new starting point for all </span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1">future instances.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer237">
<span class="koboSpan" id="kobo.1153.1"><img alt="Figure 8.34 – Output as Packer completes the build process" src="image/B18349_08_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1154.1">Figure 8.34 – Output as Packer completes the build process</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1155.1">When Packer is finished, you can view</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.1156.1"> the newly published image</span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.1157.1"> by navigating to the </span><strong class="bold"><span class="koboSpan" id="kobo.1158.1">Compute</span></strong><span class="koboSpan" id="kobo.1159.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.1160.1">Custom Images</span></strong><span class="koboSpan" id="kobo.1161.1"> on the OCI Console. </span><span class="koboSpan" id="kobo.1161.2">Here’s an example of what that </span><span class="No-Break"><span class="koboSpan" id="kobo.1162.1">looks like:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer238">
<span class="koboSpan" id="kobo.1163.1"><img alt="Figure 8.35 – Viewing the recently published custom image on OCI" src="image/B18349_08_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1164.1">Figure 8.35 – Viewing the recently published custom image on OCI</span></p>
<p><span class="koboSpan" id="kobo.1165.1">The source code for this recipe can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/packer-cloud"><span class="No-Break"><span class="koboSpan" id="kobo.1167.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/packer-cloud</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1168.1">.</span></span></p>
<h1 id="_idParaDest-191"><a id="_idTextAnchor260"/><span class="koboSpan" id="kobo.1169.1">Pack it up, pack it in, let me begin, err, umm… build</span></h1>
<p><span class="koboSpan" id="kobo.1170.1">In this recipe, we’re going to use Packer to start from source media (such as an ISO) to create our very own</span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.1171.1"> Vagrant box </span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1">from scratch.</span></span></p>
<h2 id="_idParaDest-192"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.1173.1">Getting started</span></h2>
<p><span class="koboSpan" id="kobo.1174.1">You will need the following for </span><span class="No-Break"><span class="koboSpan" id="kobo.1175.1">this recipe:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1176.1">Oracle Linux</span></span></li>
<li><span class="koboSpan" id="kobo.1177.1">Oracle </span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1">VM VirtualBox</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1179.1">Packer</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1180.1">Refer to the </span><em class="italic"><span class="koboSpan" id="kobo.1181.1">Technical requirements</span></em><span class="koboSpan" id="kobo.1182.1"> section at the beginning of this chapter if you n</span><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.1183.1">eed help installing Oracle VM VirtualBox </span><span class="No-Break"><span class="koboSpan" id="kobo.1184.1">and Packer.</span></span></p>
<h2 id="_idParaDest-193"><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.1185.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1186.1">More often than not, you can search </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.1187.1">the Vagrant catalog and find pre-made </span><strong class="bold"><span class="koboSpan" id="kobo.1188.1">Vagrantfiles</span></strong><span class="koboSpan" id="kobo.1189.1"> containing the operating system you’re looking for. </span><span class="koboSpan" id="kobo.1189.2">But what happens if what you need is not there? </span><span class="koboSpan" id="kobo.1189.3">Or maybe you don’t trust the author of the Vagrantfile and/or you simply prefer to create your own. </span><span class="koboSpan" id="kobo.1189.4">You can do this manually, or you can do this entirely with code, by leveraging Packer. </span><span class="koboSpan" id="kobo.1189.5">In this recipe, we’ll use Packer to bake up a fresh Vagrant box from the Oracle Linux 8.8 source ISO. </span><span class="koboSpan" id="kobo.1189.6">At a high level, Packer will download the ISO image for the operating system we wish to use, it will then spin up a VM using Oracle VM VirtualBox</span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.1190.1"> and install the VM. </span><span class="koboSpan" id="kobo.1190.2">Afterward, it will export the VM in </span><strong class="bold"><span class="koboSpan" id="kobo.1191.1">Open Virtualization Format</span></strong><span class="koboSpan" id="kobo.1192.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1193.1">OVF</span></strong><span class="koboSpan" id="kobo.1194.1">). </span><span class="koboSpan" id="kobo.1194.2">Finally, it will compress this file and convert it into a Vagrant </span><span class="No-Break"><span class="koboSpan" id="kobo.1195.1">box file.</span></span></p>
<h3><span class="koboSpan" id="kobo.1196.1">Oracle Linux 8 kickstart file</span></h3>
<ol>
<li><span class="koboSpan" id="kobo.1197.1">For this magic to work, you’ll need </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.1198.1">to provide a kickstart file</span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.1199.1"> to automate the installation of the ISO. </span><span class="koboSpan" id="kobo.1199.2">You can create your own, or use one from the Oracle Linux Image Tools found in the official Oracle Linux repository on GitHub</span><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.1200.1">. </span><span class="koboSpan" id="kobo.1200.2">For this recipe, I’ll be using one from the Oracle Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.1201.1">Image Tools:</span></span><p class="list-inset"><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">https://github.com/oracle/oracle-linux/blob/main/oracle-linux-image-tools/distr/ol8-slim/ol8-ks.cfg</span></span></p></li>
<li><span class="koboSpan" id="kobo.1203.1">Now, to get started with this recipe, we’ll create a new directory called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">ol8-vagrant</span></strong><span class="koboSpan" id="kobo.1205.1">. </span><span class="koboSpan" id="kobo.1205.2">In this directory, create a Packer file and name it </span><strong class="source-inline"><span class="koboSpan" id="kobo.1206.1">vagrant-ol8.pkr.hcl</span></strong><span class="koboSpan" id="kobo.1207.1">, and go ahead</span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.1208.1"> and create a folder called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1209.1">http</span></strong><span class="koboSpan" id="kobo.1210.1"> and place the kickstart file there. </span><span class="koboSpan" id="kobo.1210.2">Once this is done, your file structure should look </span><span class="No-Break"><span class="koboSpan" id="kobo.1211.1">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1212.1">
└── vagrant-ol8
    ├── http
    │   └── ol8-ks.cfg
    └── vagrant-ol8.pkr.hcl</span></pre></li> <li><span class="koboSpan" id="kobo.1213.1">In our kickstart file, we just need to set the password for the root user. </span><span class="koboSpan" id="kobo.1213.2">So, in this case, we’ll change the line that reads </span><strong class="source-inline"><span class="koboSpan" id="kobo.1214.1">rootpw --lock</span></strong><span class="koboSpan" id="kobo.1215.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">rootpw --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1">plaintext vagrant</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1218.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1219.1">Next, we’ll go ahead</span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.1220.1"> and work on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">vagrant-ol8.pkr.hcl</span></strong><span class="koboSpan" id="kobo.1222.1"> file. </span><span class="koboSpan" id="kobo.1222.2">The first thing we’ll need to do here is specify the plugins we’ll need. </span><span class="koboSpan" id="kobo.1222.3">Let’s use the VirtualBox Builder since we want to create a VM from an ISO image, and the Vagrant Builder since we’re going to convert our OVF file into a Vagrant box file. </span><span class="koboSpan" id="kobo.1222.4">These can be added by placing the following code into your Packer </span><span class="No-Break"><span class="koboSpan" id="kobo.1223.1">configuration file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer239">
<span class="koboSpan" id="kobo.1224.1"><img alt="Figure 8.36 – Packer VirtualBox and Vagrant builder plu﻿gins" src="image/B18349_08_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1225.1">Figure 8.36 – Packer VirtualBox and Vagrant builder plu</span><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.1226.1">gins</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1227.1">Info:</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1228.1">More info on the Packer VirtualBox plugin</span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.1229.1"> can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1230.1">here: </span></span><a href="https://www.packer.io/plugins/builders/virtualbox"><span class="No-Break"><span class="koboSpan" id="kobo.1231.1">https://www.packer.io/plugins/builders/virtualbox</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1233.1">Now we need to define</span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.1234.1"> a source. </span><span class="koboSpan" id="kobo.1234.2">In this case, we want to use the Oracle Linux 8.8 ISO. </span><span class="koboSpan" id="kobo.1234.3">Add the following</span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.1235.1"> to your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">vagrant-ol8.pkr.hcl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1237.1"> file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer240">
<span class="koboSpan" id="kobo.1238.1"><img alt="Figure 8.37 – Packer file for building Vagrant boxes" src="image/B18349_08_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1239.1">Figure 8.37 – Packer file for building Vagrant boxes</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1240.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1241.1">Notice the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1242.1">modifyvm</span></strong><span class="koboSpan" id="kobo.1243.1"> command, which sets </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1">--nat-localhostreachable1</span></strong><span class="koboSpan" id="kobo.1245.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">on</span></strong><span class="koboSpan" id="kobo.1247.1">. </span><span class="koboSpan" id="kobo.1247.2">This is a new setting that is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">off</span></strong><span class="koboSpan" id="kobo.1249.1"> by default in Oracle VM VirtualBox 7. </span><span class="koboSpan" id="kobo.1249.2">Setting this value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">on</span></strong><span class="koboSpan" id="kobo.1251.1"> fixes a networking issue that prevents Packer from sending the kickstart file to the VM. </span><span class="koboSpan" id="kobo.1251.2">In other words, it’s important to include this if you’re using VirtualBox 7 to build your VM, but if you’re on VirtualBox 6, you’ll need to remove this line or your build </span><span class="No-Break"><span class="koboSpan" id="kobo.1252.1">will fail.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1253.1">So, in the preceding code, we specified the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1254.1">guest_os_type</span></strong><span class="koboSpan" id="kobo.1255.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1256.1">"Oracle_64"</span></strong><span class="koboSpan" id="kobo.1257.1"> because we’re building</span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.1258.1"> from an Oracle Linux ISO. </span><span class="koboSpan" id="kobo.1258.2">Next, we input the URL for the ISO as well as the checksum. </span><span class="koboSpan" id="kobo.1258.3">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.1259.1">ssh_username</span></strong><span class="koboSpan" id="kobo.1260.1">, we’ll use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">"root"</span></strong><span class="koboSpan" id="kobo.1262.1"> and for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">ssh_password</span></strong><span class="koboSpan" id="kobo.1264.1">, we’ll use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">"vagrant"</span></strong><span class="koboSpan" id="kobo.1266.1"> because these are the defaults that Vagrant expects in order</span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.1267.1"> to make things easy – especially if you plan to distribute your box publicly. </span><span class="koboSpan" id="kobo.1267.2">If you intend to keep your box for private use only, it is best to use different values, as this will keep the box </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">more secure.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1269.1">Info</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1270.1">For more information</span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.1271.1"> on Vagrant usernames and passwords, </span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">visit </span></span><a href="https://www.vagrantup.com/docs/boxes/base#vagrant-user"><span class="No-Break"><span class="koboSpan" id="kobo.1273.1">https://www.vagrantup.com/docs/boxes/base#vagrant-user</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1275.1">We’ll set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">headless</span></strong><span class="koboSpan" id="kobo.1277.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">"true"</span></strong><span class="koboSpan" id="kobo.1279.1"> in order to prevent the virtual machine from starting the VirtualBox GUI. </span><span class="koboSpan" id="kobo.1279.2">We increase the time for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1280.1">ssh_wait_timeout</span></strong><span class="koboSpan" id="kobo.1281.1"> to give the operating system sufficient time to install and to get up and running. </span><span class="koboSpan" id="kobo.1281.2">All of this is self-explanatory; that is, until we get to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1282.1">http_directory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1"> setting.</span></span></li>
<li><span class="koboSpan" id="kobo.1284.1">All you really need to know is that we’ll leverage the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">http_directory</span></strong><span class="koboSpan" id="kobo.1286.1"> option as a convenient way to serve a directory using an HTTP server. </span><span class="koboSpan" id="kobo.1286.2">It does this so that the boot command can point to a kickstart file – which we’ve placed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1">http</span></strong><span class="koboSpan" id="kobo.1288.1"> directory. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1">http://{{ .HTTPIP }}:{{ .HTTPPort }}/ol8-ks.cfg</span></strong><span class="koboSpan" id="kobo.1290.1"> tells the operating system exactly what it needs to reach the kickstart file. </span><span class="koboSpan" id="kobo.1290.2">You don’t really need to worry about the syntax of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1291.1">{{ .HTTPIP }}</span></strong><span class="koboSpan" id="kobo.1292.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1293.1">{{ .HTTPPort }}</span></strong><span class="koboSpan" id="kobo.1294.1">; these are just template variables that are processed by the Packer </span><span class="No-Break"><span class="koboSpan" id="kobo.1295.1">templating engine.</span></span></li>
<li><span class="koboSpan" id="kobo.1296.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1">nic_type</span></strong><span class="koboSpan" id="kobo.1298.1">, the default value is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">82540EM</span></strong><span class="koboSpan" id="kobo.1300.1">, which equates to Intel PRO/1000 MT Desktop. </span><span class="koboSpan" id="kobo.1300.2">That’s a safe choice and is great when running old operating systems, but Oracle Linux 8 is a modern operating system so we’re setting this to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1301.1">virtio</span></strong><span class="koboSpan" id="kobo.1302.1">. </span><span class="koboSpan" id="kobo.1302.2">VirtIO is a para-virtualized driver and will give us better networking performance in </span><span class="No-Break"><span class="koboSpan" id="kobo.1303.1">the VM.</span></span></li>
<li><span class="koboSpan" id="kobo.1304.1">Now, on to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1305.1">boot_command</span></strong><span class="koboSpan" id="kobo.1306.1">. </span><span class="koboSpan" id="kobo.1306.2">Basically, we need to figure out what sequence of key presses</span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.1307.1"> are required in order to send a boot </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.1308.1">command to the operating system at boot time. </span><span class="koboSpan" id="kobo.1308.2">In the case of Oracle Linux 8, we send key presses of </span><em class="italic"><span class="koboSpan" id="kobo.1309.1">up</span></em><span class="koboSpan" id="kobo.1310.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.1311.1">Tab</span></em><span class="koboSpan" id="kobo.1312.1">, and then we send instructions on where to find the kickstart file, and finally we tell it to press </span><em class="italic"><span class="koboSpan" id="kobo.1313.1">Enter</span></em><span class="koboSpan" id="kobo.1314.1"> to begin installing </span><span class="No-Break"><span class="koboSpan" id="kobo.1315.1">the OS.</span></span></li>
<li><span class="koboSpan" id="kobo.1316.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.1317.1">vboxmanage</span></strong><span class="koboSpan" id="kobo.1318.1">, I found that, by default, Packer tried to launch my VM with only 512 MB of memory, and that resulted in an error during the installation of the OS. </span><span class="koboSpan" id="kobo.1318.2">In order to resolve this issue, I increased the memory to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">2048</span></strong><span class="koboSpan" id="kobo.1320.1">. </span><span class="koboSpan" id="kobo.1320.2">I also gave it two CPUs just for </span><span class="No-Break"><span class="koboSpan" id="kobo.1321.1">good measure.</span></span></li>
<li><span class="koboSpan" id="kobo.1322.1">Finally, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">shutdown_command</span></strong><span class="koboSpan" id="kobo.1324.1">, we simply tell Packer how to shut down the system gracefully once all the provisioning is done. </span><span class="koboSpan" id="kobo.1324.2">If we leave this blank Packer would forcefully shut down </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1">the machine.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1326.1">Info</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1327.1">For a complete overview </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.1328.1">of available configuration options, </span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1">see </span></span><a href="https://www.packer.io/plugins/builders/virtualbox/iso"><span class="No-Break"><span class="koboSpan" id="kobo.1330.1">https://www.packer.io/plugins/builders/virtualbox/iso</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1331.1">.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1332.1">At this point, we have enough to install the OS automatically, but we need to do a few more things to prepare the virtual machine for Vagrant. </span><span class="koboSpan" id="kobo.1332.2">To be specific, we need to add a user called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">vagrant</span></strong><span class="koboSpan" id="kobo.1334.1">, populate that user’s authorized keys with a known public key for that user, and finally we’ll want to install VirtualBox </span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1">Guest Additions.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1336.1">For these tasks, we’ll leverage</span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.1337.1"> a provisioner to execute a shell script. </span><span class="koboSpan" id="kobo.1337.2">This task takes place after the operating system</span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.1338.1"> is installed and while the virtual machine is still running. </span><span class="koboSpan" id="kobo.1338.2">It’s the last thing we’ll do before we shut down the system and convert it to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">Vagrant box.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1340.1">Go ahead and add the following to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">vagrant-ol8.pkr.hcl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1342.1"> file:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer241">
<span class="koboSpan" id="kobo.1343.1"><img alt="Figure 8.38 – Packer file for building Vagrant boxes (continued)" src="image/B18349_08_38.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1344.1">Figure 8.38 – Packer file for building Vagrant boxes (continued)</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1345.1">Info</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1346.1">More info on post-processors</span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.1347.1"> can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1348.1">here: </span></span><a href="https://www.packer.io/plugins/post-processors/vagrant/vagrant#virtualbox"><span class="No-Break"><span class="koboSpan" id="kobo.1349.1">https://www.packer.io/plugins/post-processors/vagrant/vagrant#virtualbox</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1350.1">.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1351.1">As you can see from the preceding screenshot, we’re going to create a new folder called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1">scripts</span></strong><span class="koboSpan" id="kobo.1353.1"> and place the shell script </span><span class="No-Break"><span class="koboSpan" id="kobo.1354.1">in there:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1355.1">
└── ol8-vagrant
    ├── http
    │   └── ol8-ks.ks
    ├── scripts
    │   └── vagrant-base-box.sh
    └── vagrant-ol8.pkr.hcl</span></pre></li> <li><span class="koboSpan" id="kobo.1356.1">Now, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1357.1">vagrant-base-box.sh</span></strong><span class="koboSpan" id="kobo.1358.1"> script, we’ll </span><span class="No-Break"><span class="koboSpan" id="kobo.1359.1">add this:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer242">
<span class="koboSpan" id="kobo.1360.1"><img alt="Figure 8.39 – Contents of the vagrant-base-box.sh script" src="image/B18349_08_39.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1361.1">Figure 8.39 – Contents of the vagrant-base-box.sh script</span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.1362.1">Next, we’re going</span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.1363.1"> to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1364.1">packer init</span></strong><span class="koboSpan" id="kobo.1365.1"> to download </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.1366.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1">external plugin:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1368.1">$ packer init .</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1369.1">Now we’re ready to build the Vagrant box. </span><span class="koboSpan" id="kobo.1369.2">This part is simple, just run </span><span class="No-Break"><span class="koboSpan" id="kobo.1370.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1371.1">$ packer build .</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1372.1">After entering the command, you will see something like </span><span class="No-Break"><span class="koboSpan" id="kobo.1373.1">the following:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer243">
<span class="koboSpan" id="kobo.1374.1"><img alt="Figure 8.40 – Output of the “packer build” command" src="image/B18349_08_40.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1375.1">Figure 8.40 – Output of the “packer build” command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1376.1">This will take a while, because it’s actually doing quite a bit here. </span><span class="koboSpan" id="kobo.1376.2">Remember what we talked about from</span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.1377.1"> a high level: Packer</span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.1378.1"> is going to download the ISO, create a VM, and install the OS, and afterward it will run everything in the script you just defined, but once all of this is done, you will be left with a nice neat </span><strong class="source-inline"><span class="koboSpan" id="kobo.1379.1">.box</span></strong><span class="koboSpan" id="kobo.1380.1"> file (which is exactly what we need to for use </span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1">with Vagrant).</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1382.1">If you switch over to VirtualBox, you’ll eventually see a new VM that was created by Packer. </span><span class="koboSpan" id="kobo.1382.2">You can just leave it be and let Packer do its thing, but knowing this detail gives you the ability to know what’s going on behind </span><span class="No-Break"><span class="koboSpan" id="kobo.1383.1">the scenes.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer244">
<span class="koboSpan" id="kobo.1384.1"><img alt="Figure 8.41 – Screenshot of VM being built and configured with Packer" src="image/B18349_08_41.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1385.1">Figure 8.41 – Screenshot of VM being built and configured with Packer</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1386.1">Once the build</span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.1387.1"> is complete, you should</span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.1388.1"> see output similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer245">
<span class="koboSpan" id="kobo.1390.1"><img alt="Figure 8.42 – Screenshot of completed build of Vagrant box" src="image/B18349_08_42.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1391.1">Figure 8.42 – Screenshot of completed build of Vagrant box</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1392.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1393.1">The Oracle Linux ISO file is several gigabytes, so this really could take a while. </span><span class="koboSpan" id="kobo.1393.2">Now may be the perfect time to take a break and have a </span><span class="No-Break"><span class="koboSpan" id="kobo.1394.1">coffee. </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1395.1">😉</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1396.1">Now it’s time to prepare </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.1397.1">our box for use with Vagrant. </span><span class="koboSpan" id="kobo.1397.2">We’ll just</span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.1398.1"> run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1399.1">vagrant init</span></strong><span class="koboSpan" id="kobo.1400.1"> to build </span><span class="No-Break"><span class="koboSpan" id="kobo.1401.1">our Vagrantfile:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1402.1">$ vagrant init ol8-x64-virtualbox.box</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1403.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1404.1">as follows:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer246">
<span class="koboSpan" id="kobo.1405.1"><img alt="Figure 8.43 – Initializing Vagrant box" src="image/B18349_08_43.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1406.1">Figure 8.43 – Initializing Vagrant box</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1407.1">Helpful tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1408.1">You could run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">vagrant init</span></strong><span class="koboSpan" id="kobo.1410.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1411.1">vagrant init .</span></strong><span class="koboSpan" id="kobo.1412.1"> , but it’s best to specify the filename of the box. </span><span class="koboSpan" id="kobo.1412.2">This way, Vagrant will automatically specify the proper value of the box inside the Vagrantfile. </span><span class="koboSpan" id="kobo.1412.3">That’s why for this recipe, we are running </span><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">vagrant </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">init ol8-x64-virtualbox.box</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">.</span></span></p>
<ol>
<li value="19"><span class="koboSpan" id="kobo.1416.1">Finally, it’s time to test</span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.1417.1"> out our new Vagrant</span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.1418.1"> box by running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1419.1">vagrant up</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1420.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1421.1">$ vagrant up</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1422.1">The output of this command is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1423.1">following screenshot:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer247">
<span class="koboSpan" id="kobo.1424.1"><img alt="Figure 8.44 – Output of the “vagrant up” command" src="image/B18349_08_44.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1425.1">Figure 8.44 – Output of the “vagrant up” command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1426.1">And there you have it. </span><span class="koboSpan" id="kobo.1426.2">After a few short moments, your virtual machine will be up and running, and you can interact</span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.1427.1"> with it using the convenient commands made possible</span><a id="_idIndexMarker810"/> <span class="No-Break"><span class="koboSpan" id="kobo.1428.1">by Vagrant.</span></span></p>
<p><span class="koboSpan" id="kobo.1429.1">The source code for this recipe can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1430.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/packer-vagrant"><span class="No-Break"><span class="koboSpan" id="kobo.1431.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook/tree/main/ch8/packer-vagrant</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1432.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1433.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1434.1">If you’re still developing your Vagrant box and need to test after each build, you’ll want to make sure you’re testing the latest box that you’ve built. </span><span class="koboSpan" id="kobo.1434.2">I actually ran into an issue thinking that my changes weren’t persisting until I realiz</span><a id="_idTextAnchor266"/><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.1435.1">ed Vagrant was using a cached box from a previous build. </span><span class="koboSpan" id="kobo.1435.2">You can remove old boxes with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">vagrant box </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1437.1">remove ol8-x64-virtualbox.box</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1438.1">.</span></span></p>
</div>
</body></html>