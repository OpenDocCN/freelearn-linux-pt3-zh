# 15

# 安全指南和最佳实践

在现代社会，几乎所有计算机都连接到互联网，在线应用在我们生活的各个方面扮演着越来越重要的角色，信息安全也变得愈发重要。当以数字形式存储的信息变得越来越有价值，而恶意行为者不断设计新的攻击方式时，每个系统管理员都必须有意识地努力保持机器的安全。

幸运的是，遵循安全指南和最佳实践可以防止大多数攻击，并在攻击发生时限制其影响。

在本章中，我们将学习以下内容：

+   信息安全组件和泄露类型

+   常见的攻击类型和威胁

+   攻击途径和安全漏洞

+   保持系统安全和稳定的方法

# 常见的威胁和攻击类型

攻击者可能针对系统的原因有很多，攻击目标的方式也各不相同，而受损系统的操作员可能面临多种后果。我们将详细探讨这些内容。

## 攻击者的动机及其可能带来的后果

电影、文学和视频游戏中呈现的计算机系统攻击画面通常是针对一个精心挑选的目标进行攻击，具有特定的目标——最常见的目标是窃取一些有价值的信息、修改它，或者可能摧毁它。

这样的攻击在现实世界中确实存在，并且对高知名度公司和政府机构来说是一个巨大的隐患。然而，这种流行的描绘常常误导人们认为，安全对他们并不重要，因为他们没有任何有价值的信息，也不是高知名度的目标。

这种看法在互联网初期可能是正确的，但如今，这种假设已经变得非常危险。实际上，大多数攻击不再是针对特定目标并精心策划的，而是自动化的、机会主义的。每一台连接到互联网的机器都会不断被自动化工具扫描，试图利用已知的安全漏洞。

更糟糕的是，自动化攻击通常依赖于被攻陷的第三方机器的可用性——在攻击者自己的机器上运行自动化攻击工具既昂贵又容易被发现并加以遏制。为了避免支付托管费用并逃避检测和封锁，攻击者通常会获得对几台机器的未经授权的访问，并利用它们来促进进一步的攻击。一组被恶意实体控制的机器通常被称为**僵尸网络**。僵尸网络用于扫描更多机器并控制它们，分发恶意软件，发送未经请求的消息（垃圾邮件），并执行其他类型的攻击。

因此，一位粗心的系统管理员不仅可能成为攻击的受害者，还可能成为攻击者的无意和不知情的同谋。在某些情况下，受攻击系统的所有者可能会受到执法机关的调查，并因攻击源自其机器而被怀疑为攻击的实施者。这类情况虽罕见，但即使所有者不承担法律责任，允许攻击者控制你的机器仍然会带来许多潜在后果：电力成本（对于本地机器或联合托管的机器）、云平台上的 CPU 时间、带宽使用费用，以及系统过载，导致合法用户的资源被抢占。

最后，被确认作为攻击或垃圾邮件来源的机器可能会被加入黑名单。多个黑名单由不同的公司维护，因此，如果你的 IP 地址或域名被列入这些名单，清除它们可能是一个非常耗时的工作。此外，黑名单维护者并没有义务删除你的地址，因为它们是私营公司，黑名单的加入和移除并不受任何法律监管，且它们可能会拒绝删除重复违规者的条目，或者要求提供大量证明，证明当前所有者已经显著改善了安全措施。

## 信息安全特性及其攻击

信息安全的三个组成部分通常定义如下：

+   可用性

+   保密性

+   完整性（或真实性）

信息可用性意味着授权用户可以在需要时访问信息。保密性意味着用户只能访问他们被授权访问的信息。最后，完整性意味着没有任何无意或故意的修改被合法用户执行或授权。

攻击可能有不同的目标——要么是破坏信息的可用性，要么是获得目标的控制权，从而破坏存储在其中的信息的机密性和真实性。在现代社会，许多攻击者更关心的是机器的资源，而非存储在其中的信息。我们来详细看看这些攻击。

### 拒绝服务

对信息可用性的攻击称为**拒绝服务**（**DoS**）攻击。表面上看，这可能是最无害的攻击类型，因为其影响通常是暂时性的。然而，这种攻击仍然可能带来严重后果——例如，一个在线商店的网站无法访问可能导致收入的大幅损失，而对电话系统的攻击可能使用户无法拨打紧急电话，甚至可能导致生命丧失。一些 DoS 攻击仅仅是破坏行为，但许多此类攻击是为了从目标系统运营商勒索资金以换取停止攻击，损害其声誉，使服务变得不可靠，或阻止其向用户提供信息（最后一种目标对于政治动机的攻击尤为常见）。

执行 DoS 攻击有两种可能的方式。经典方式是利用系统软件中的漏洞来使其崩溃，或让其反复执行复杂操作，从而使其变慢。这些攻击可以通过适当的软件开发和配置来防止。

另一种、日益常见的攻击类型是**分布式拒绝服务**（**DDoS**）攻击。这种攻击利用大量机器来饱和目标系统的网络链接，或用超出其处理能力的请求使其过载。攻击者可以通过大型僵尸网络生成攻击流量，或使用放大攻击——即他们可以向公共服务器发送 DNS 或 NTP 请求，并将攻击目标的地址指定为源地址，以使其向目标发送未经请求的回复数据包。由于回复通常比请求数据包大，放大攻击可以通过让好心的第三方参与攻击，从而为攻击者节省大量带宽和计算资源。

DDoS 攻击最糟糕的部分是，如果攻击者产生足够的流量来使目标的网络链接饱和，目标机器的管理员本身无法采取任何措施来缓解这种情况——如果攻击流量已经到达目标，损害已经发生。这种攻击只能通过托管服务提供商、互联网服务提供商或专门的 DDoS 保护服务来缓解，这些服务通过过滤恶意数据包并将合法请求转发到目标机器。然而，DDoS 攻击总是有明确目标的，而非机会主义性攻击，因为它们需要从多台机器向单一指定目标发送流量，并且大多数系统永远不会成为 DDoS 攻击的目标。

### 凭证盗窃和暴力破解攻击

完全控制目标机器是任何攻击者最吸引人的目标之一，因为它允许攻击者轻松破坏机器上存储的任何信息的完整性和机密性，并将机器本身用于自己的目的。

获取访问权限的最干净方法是冒充合法用户。如果攻击者以某种方式获取了密码、加密密钥或用于身份验证的 API 密钥，他们使用系统的行为将与正常访问无法区分。

即便是访问小型服务器的凭证，在现代社会也能变得非常有价值——如果攻击者能窃取足够多的凭证，获取访问权限后的常见攻击行为之一就是在受害机器上运行加密货币挖矿软件，从而直接将其 CPU 和 GPU 的计算能力转化为货币。窃取云平台、电子邮件服务或**互联网语音协议**（**VoIP**）的访问凭证更具盈利性，因为攻击者可以利用这些凭证生成新的虚拟机、发送垃圾邮件或拨打国际电话——有些人甚至会将这些非法获取的资源出售给第三方，第三方对此毫不知情。当然，这些服务的费用最终要由合法的凭证拥有者支付。

许多恶意软件被编程用来窃取终端用户计算机上的密码和密钥。这种方法对攻击者来说是理想的，因为它不会在他们通过窃取的凭证访问的目标机器上留下任何痕迹。

然而，许多其他攻击利用了终端用户通常使用容易猜测的弱密码这一事实。这正是暴力破解攻击的基础，攻击者通过反复尝试使用包含常见单词、常用口令和经常被窃取的其他机器密码的密码字典登录，希望某些用户将它们用于多台机器或服务（这种情况很常见）。

通过使用强密码、加密密钥和设置速率限制，可以显著增加暴力破解攻击的难度，从而减少攻击者登录和猜测密码的机会。

### 利用配置和软件漏洞进行的攻击

最后，在某些情况下，攻击者可以通过利用系统本身的漏洞，执行那些逻辑上应该被拒绝的操作。

这种漏洞有两类：配置问题和软件漏洞。

以配置缺陷为例，考虑到电子邮件提交的标准协议——**简单邮件传输协议**（**SMTP**）——不要求强制身份验证。因此，每个 SMTP 服务器的实现都可以配置为允许任何人通过它发送邮件，并充当开放中继。如果一个配置了这种设置的服务器暴露在公共互联网中，攻击者可以利用它发送大量垃圾邮件，仅仅因为它没有检查发件人是否是系统的合法用户。

在其他情况下，缺陷存在于软件本身。例如，假设一个 Web 应用程序实现了用户身份验证，并且在用户登录后正确地将他们重定向到其账户页面——假设用户名为`bob`的用户从`https://example.com/login`被重定向到`https://example.com/users/bob`。然而，由于编程错误，应用程序在用户尝试访问账户页面时从未检查用户账户，因此任何知道系统中有一个名为`bob`的用户的人，只需在地址栏输入`https://example.com/users/bob`，就可以访问该账户页面。

这个例子听起来可能很严重，但它与在真实软件中发现的漏洞并不太远，即使它们的利用方法可能比在地址栏中输入 URL 更复杂。

幸运的是，大多数漏洞并没有那么危险。当安全研究人员发布他们的发现，以及软件维护人员发布已发现漏洞的修复程序时，他们会使用一组术语来表示漏洞类型和严重性等级，你应该熟悉这些术语，以估计修复的重要性。

漏洞报告由个人研究人员和软件供应商发布，并且也会汇总到像美国**国家标准与技术研究院**（**NIST**）维护的国家漏洞数据库中。在这些数据库中，每个已知的漏洞都会分配一个唯一的标识符，例如 CVE-2023-28531（[`nvd.nist.gov/vuln/detail/CVE-2023-28531`](https://nvd.nist.gov/vuln/detail/CVE-2023-28531)），其中**CVE**代表**公共漏洞和暴露**。

常见的严重性等级如下：

+   **严重**：通常，这使得任何能够连接到系统的攻击者都可以完全控制它。易受攻击的系统应该立即修补，或者如果补丁尚不可用，则应隔离，使其无法被攻击者访问。

+   **高和中等**：这些可能允许攻击者显著危害系统，但需要特殊的情况（例如，系统中启用了某些特性）或复杂的利用过程。如果补丁不可用，受影响的系统应该尽快修补，且可能需要采取临时缓解措施（例如禁用受影响的特性）。

+   **低**：这不会给攻击者带来显著的优势，因为只有在罕见的情况下才能进行利用。

数据库根据多个因素（例如风险等级、攻击者利用漏洞所需的技能、影响等）来分配这些等级。有关详细信息，你可能想要阅读 NIST 使用的**常见漏洞评分系统**或 OWASP 风险评级方法。

以下是一些常见的漏洞类型：

+   任意代码执行

+   提权

+   拒绝服务

**任意代码执行**攻击往往是最危险的，因为它们允许攻击者向目标系统引入新的程序逻辑，而不仅仅是使用或滥用系统上已运行的软件。然而，也有许多缓解因素。一个允许远程未认证攻击者通过向目标系统发送特制请求来执行任意代码的漏洞是所有威胁中最严重的，可能需要将受影响的系统完全下线，直到修补漏洞。然而，如果攻击者需要先认证才能执行攻击，那么它的影响会大大减少——要到达任意代码执行阶段，攻击者首先需要窃取有效的用户凭证。此外，从一个具有高度限制权限且无法访问任何敏感信息的进程中执行任意代码，可能对攻击者的帮助有限。

**权限提升**攻击允许合法用户执行本不应由他们执行的操作。其影响可能非常严重——例如，如果一个漏洞允许任何已认证用户读取系统上的所有文件，不论文件权限如何，那么任何允许非管理员用户登录的机器都有隐私泄露的风险。然而，在外部攻击者利用这个漏洞之前，他们首先需要找到一种登录的方法。对于仅允许管理员访问的系统而言，除非同时存在远程任意代码执行漏洞或凭证盗窃漏洞，否则这种漏洞根本不需要担心。

最后，**拒绝服务**漏洞仅仅允许攻击者妥协系统的可用性，就像我们之前讨论的那样。

牢记这一点，接下来我们将讨论如何保护您的系统免受这些类型的攻击。

# 保持系统安全

在信息安全圈中有一个常见的笑话，那就是唯一完全安全的系统就是关机的系统。当然，这样的系统仅在完整性和机密性的意义上是安全的——以可用性为代价。任何现实场景总是一个妥协，总是存在风险；系统管理员的目标是防止已知攻击，并减少未知攻击的影响，每个管理员必须始终准备好应对新的威胁并加以缓解。

幸运的是，遵循一些简单的指导原则可以大大降低风险——接下来我们将讨论防止特定攻击类型的一般策略和战术。

## 减少攻击面

系统的攻击面大致可以理解为访问系统的所有方式。例如，一个同时运行着 web 服务器和邮件服务器的机器，其攻击面比只运行其中之一的系统要大。如果我们假设这些服务中的漏洞和配置问题发生的概率相同且可以独立出现，那么运行这两项服务的系统就有两倍的可能性受到攻击。

当然，许多真实的系统需要同时提供多项服务——例如，电子邮件提供商需要邮件服务器和面向客户的网站。减少攻击面并不是减少服务的数量，而是将服务彼此隔离，并且理想情况下，要将它们与攻击者隔离开来。

例如，一个典型的 Web 应用堆栈包括应用服务器和数据库服务器。大多数情况下，数据库服务器不需要对外公开访问——将其访问限制在内部网络中总是一个好主意。此外，应用服务器也不需要*直接*对外公开——正如我们在*第十三章*中讨论的内容，*高可用性*，它们可以被放置在负载均衡器后面。负载均衡器不仅能提高系统的可用性，还能减少攻击者通过公共互联网能够接触到的攻击面。此外，它还可以提供速率限制和威胁检测系统，至少能在一定程度上保护应用服务器免受部分攻击流量的影响。

## **隔离与权限分离**

很久以前，系统中不同组件之间唯一的隔离方法是将它们运行在不同的物理机器上。这种方法成本很高，通常只有在有充分理由的情况下才会采用——例如，设计用来处理高负载的应用程序必须使用独立的数据库和应用服务器，以满足其性能要求，而不仅仅是为了减少系统的攻击面。

然而，在过去二十年里，出现了许多更细粒度的方法来隔离进程，即使是在普通硬件上。虚拟化技术使你可以在单一物理机器上运行多个操作系统实例，现代虚拟机管理器使得启动虚拟机变得简单——更不用说云平台，它们可以通过单一点击或 API 调用来启动你选择的操作系统的虚拟机。

除了完全虚拟化外，还有许多方法可以在单台机器上隔离应用程序。包括`chroot`环境、容器和强制访问控制系统。

### 使用 chroot

完全隔离进程的最古老方法是`chroot`。从技术上讲，`chroot`（更改根目录）是内核中的一个系统调用，用于更改进程的根目录。根目录已更改的进程将无法访问根目录以外的任何文件——对该进程而言，系统中似乎只有它所在的目录。手动为进程设置`chroot`环境可能是一个耗时的任务，因此许多发行版提供了特殊的包来简化该过程。

例如，Fedora 提供了一种简单的方法来在`chroot`环境中运行 ISC BIND（也称为`named`），这是一款流行的 DNS 服务器：

```
$ sudo dnf install bind9-next-chroot
Installed:
  bind9-next-32:9.19.11-1.fc37.x86_64     bind9-next-chroot-32:9.19.11-1.fc37.x86_64     bind9-next-dnssec-utils-32:9.19.11-1.fc37.x86_64     bind9-next-libs-32:9.19.11-1.fc37.x86_64     bind9-next-license-32:9.19.11-1.fc37.noarch
Complete!
$ sudo systemctl enable  named-chroot
Created symlink /etc/systemd/system/multi-user.target.wants/named-chroot.service → /usr/lib/systemd/system/named-chroot.service.
$ tree /var/named/chroot/
/var/named/chroot/
├── dev
├── etc
│   ├── crypto-policies
│   │   └── back-ends
│   ├── named
│   └── pki
│     └── dnssec-keys
├── proc
│   └── sys
│       └── net
│           └── ipv4
...
```

正如你所见，作为 BIND 进程的限制根目录的目录与真实根目录类似，它也有 `/dev` 和 `/proc` 层级 —— 这些目录的全局版本将无法被进程访问。

因此，即使攻击者利用远程代码执行漏洞成功将恶意代码注入到 BIND 进程中，他们也无法读取 `/var/named/chroot` 以外的任何文件。然而，他们仍然可以与系统上的其他进程进行交互。如果需要更深层次的隔离，可以改用容器。

### 使用容器

Linux 内核提供了一种名为 **LXC** 的容器技术。它由多个子组件组成，例如进程组、控制组和网络命名空间。手动创建容器环境并启动它们是一个繁琐的过程，因此人们创建了可以自动化该过程的工具，并且有了可供使用的容器镜像注册表。

此时，Linux 上最流行的容器管理工具是 Docker，尽管也有替代工具，例如 Podman。我们将通过使用 Docker 启动 Fedora 镜像来演示进程隔离：

```
$ sudo dnf install docker
$ sudo docket pull fedora:latest
$ docker run -it fedora:latest bash
[root@df231cc10b87 /]# dnf install procps-ng
[root@df231cc10b87 /]# ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   4720  3712 pts/0    Ss   15:21   0:00 /bin/bash
root          55  0.0  0.0   5856  2688 pts/0    R+   15:23   0:00 ps aux
```

如你所见，当我们在容器中启动一个 `bash` shell 进程时，从容器内部看，它就像是系统中的唯一进程。宿主系统中的进程（例如 systemd 或 Docker 守护进程）对容器来说是不可见的，容器中的进程也无法与它们进行任何交互。

### 使用强制访问控制

最后，存在授予用户和进程不同能力的方式 —— 理想情况下，只有它们需要的能力才能正常运行。这种机制被称为 **强制访问控制** (**MAC**) 系统 —— 与经典的 **自主访问控制**（即 Unix 文件权限系统）不同。

当前，Linux 最流行的 MAC 系统是 **安全增强 Linux**（**SELinux**），尽管也有一些不太常见的替代方案 —— 最著名的就是 AppArmor 内核模块。

如今，许多 Linux 发行版默认启用 SELinux，并为流行服务包含了相应的能力和对象上下文。

你可以使用 `getenforce` 命令检查系统是否启用了 SELinux：

```
$ getenforce
Enforcing
```

在 `Enforcing` 模式下，SELinux 会禁止用户或进程未被授权的操作 —— 例如，若进程没有 `can_network_connect` 能力，它将无法发起任何网络连接。而在 `Permissive` 模式下，SELinux 会在系统日志中生成警报，但不会强制执行能力 —— 该模式适合用于测试。最后，如果模式为 `Disabled`，则 SELinux 完全不执行任何能力检查。

配置 SELinux 策略是一本入门书籍无法涵盖的主题。然而，如果你决定启用 SELinux，你将经常需要知道如何授予进程对文件的访问权限。

例如，在 Apache HTTPd 配置文件中，可以将任何目录指定为网站根目录。如果攻击者控制了 Apache 进程，这也可能带来安全问题。这就是为什么在 Fedora 中，该软件包的维护者为必须让 web 服务器访问的文件引入了一组特殊的 SELinux 上下文。

你可以通过在 `ls` 命令中添加 `-Z` 选项来查看文件的 SELinux 上下文。例如，`/var/lib/httpd` 目录具有 `httpd_var_lib_t` 上下文，授予读取权限：

```
$ sudo ls -alZ /var/lib/httpd/
total 8
drwx------.  2 apache apache system_u:object_r:httpd_var_lib_t:s0 4096 Jun 17  2022 .
drwxr-xr-x. 55 root   root   system_u:object_r:var_lib_t:s0       4096 Nov 16 02:39 ..
```

可能是可写的网页目录使用不同的上下文 —— `httpd_sys_content_t`：

```
$ ls -alZ /var/www/html/
total 8
drwxr-xr-x. 2 root root system_u:object_r:httpd_sys_content_t:s0 4096 Jun 17  2022 .
drwxr-xr-x. 6 root root system_u:object_r:httpd_sys_content_t:s0 4096 Jun 17  2022 ..
```

如果你将网站根目录设置为一个新创建的其他目录，Apache 进程将无法访问该目录，因为它缺少所需的上下文，即使该目录根据 Unix 权限应该是可读的。你可以使用`chcon`命令授予它访问权限：

```
$ sudo chcon system_u:object_r:httpd_sys_content_t:s0 /home/webmaster/public_html
```

使用 SELinux 创建灵活且细粒度的安全策略还有很多其他可能性，但初学者应当先从使用发行版默认配置开始。

## 防止凭证盗窃和暴力破解攻击

凭证盗窃必须在用户工作站上处理。没有绝对的方法可以防止凭证盗窃，因此你应该努力保护你的笔记本或台式系统免受攻击 —— 保持系统更新，保护免受恶意软件侵害，避免陷入如钓鱼邮件等社会工程攻击，其中包含恶意链接。

对于暴力破解攻击，有两种互补的策略 —— 保持密码难以猜测和限制认证尝试次数。

大多数 Linux 发行版默认启用了一个名为 `pam_pwquality.so` 的 PAM 模块，它防止非特权用户使用不安全的密码。你可以通过尝试设置一个非常短的密码或简单的字典词来验证这一点：

```
$ passwd
Changing password for user ...
Current password:
New password: qwerty
BAD PASSWORD: The password is shorter than 8 characters
passwd: Authentication token manipulation error
$ passwd
Changing password for user ...
Current password:
New password: swordfish
BAD PASSWORD: The password fails the dictionary check - it is based on a dictionary word
passwd: Authentication token manipulation error
```

它用于密码强度检查的后端叫做 `cracklib`。它通常将数据保存在 `/usr/share/cracklib` 中。其字典是二进制格式，但它提供了用于操作这些字典文件和检查密码强度的工具，无需实际设置密码：

```
$ echo "swordfish" | cracklib-check
swordfish: it is based on a dictionary word
```

请注意，root 用户不受密码质量检查的限制，可以为任何用户设置任何密码。

还有一个名为 **pwgen** 的工具可以生成安全的随机密码，这个工具存在于大多数 Linux 发行版的软件包仓库中。它允许你指定密码是否应完全随机，密码应包含哪些字符，密码的长度，及一次生成多少个密码：

```
$ pwgen --secure 40 1
DMYRsJNuXJQb98scCUASDzt3GFPa7yzGg9eS1L1U
$ pwgen --secure 8 16
Ob4r24Sp KwGCF63L 3bgKI79L aWK2K7aK MFf1ykum y74VTKqb OxbrNlI0 8Dl4yilz
bmI1RsKr oM4p8dsJ 2EXmmHIJ bt9Go1gg 3znmVqpo vZ9BDIlz QMZ7eME0 izkB15Xe
```

限制速率是一个广泛的话题，且其设置在不同的服务和应用程序之间有所不同。然而，也有一些通用的集成解决方案支持多个服务，例如**fail2ban**。

## 降低软件漏洞的风险

确保系统没有脆弱软件的最佳方法是使用来自发行版仓库的软件，并按时安装更新。应该避免手动安装软件包，因为这些软件包不会自动接收发行版维护者的更新。如果确实需要，您应该确保订阅它们的发布公告，并自行检查更新。

很多时候，漏洞是在已经发布的软件版本中发现的，而不是在开发过程中 – 这种情况被称为**零日漏洞**（通常简称为**0day**）。有时，这些漏洞在被发现之前已经存在了几个月甚至几年。修复这些漏洞的更新包可能会晚于恶意行为者开始利用它们的时间。在这种情况下，软件维护者通常会建议一种临时的缓解策略，可能包括更改配置选项、禁用特定功能或对系统进行其他更改，以使攻击更难执行。因此，关注您常用的发行版和软件项目的博客、邮件列表也是一个好主意。

# 总结

在本章中，我们了解了计算机系统受到的各种攻击类型、攻击者执行攻击的动机，以及这些攻击可能给用户带来的后果。

我们还了解了保持系统免受攻击的常见策略。然而，我们仅仅触及了表面——信息安全是一个庞大的领域，保持对它的知识更新并确保系统安全是每个系统管理员终身的追求。

# 深入阅读

要了解本章中涉及的更多内容，请查阅以下资源：

+   NIST 漏洞数据库: [`nvd.nist.gov/`](https://nvd.nist.gov/%0D)

+   常见漏洞评分系统: [`nvd.nist.gov/vuln-metrics/cvss`](https://nvd.nist.gov/vuln-metrics/cvss%0D)

+   OWASP 风险评估方法论: [`owasp.org/www-community/OWASP_Risk_Rating_Methodology`](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology%0D)

+   Fail2Ban 限速守护进程: [`www.fail2ban.org`](https://www.fail2ban.org)
