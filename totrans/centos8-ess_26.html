<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer226" class="_idGenObjectStyleOverride-1">&#13;
			<p id="_idParaDest-261" class="Chapter-Title"><span class="ChapterMarker">28. </span><a id="_idTextAnchor346"/>Configuring a CentOS 8 <a id="_idIndexMarker601"/>Postfix <a id="_idIndexMarker602"/>Email Server</p>&#13;
			<p class="My-Basic-Paragraph">Along with acting as a web server, email is one of the primary uses of a CentOS 8 system, particularly in business environments. Given both the importance and popularity of email it is surprising to some people to find out how complex the email structure is on a Linux system and this complexity can often be a little overwhelming to the CentOS 8 newcomer. </p>&#13;
			<p class="My-Basic-Paragraph">The good news is that much of the complexity is there to allow experienced email administrators to implement complicated configurations for large scale enterprise installations. The fact is, for most Linux administrators it is relatively straight forward to set up a basic email system so that users can send and receive electronic mail. </p>&#13;
			<p class="My-Basic-Paragraph">In this chapter of CentOS 8 Essentials, we will explain the basics of Linux-based email configuration and step through configuring a basic email environment. In the interests of providing the essentials, we will leave the complexities of the email system for more advanced books on the subject. </p>&#13;
			<p id="_idParaDest-262" class="Heading-1-1"><span class="Heading11Marker">28.1 </span><a id="_idTextAnchor347"/>The structure of the <a id="_idIndexMarker603"/>Email System </p>&#13;
			<p class="My-Basic-Paragraph">There are a number of components that make up a complete email system. Below is a brief description of each one: </p>&#13;
			<p id="_idParaDest-263" class="Heading-1-1-1"><span class="Heading111Marker">28.1.1 </span><a id="_idTextAnchor348"/><a id="_idIndexMarker604"/>Mail User Agent </p>&#13;
			<p class="My-Basic-Paragraph">This is the part of the system that the typical user is likely to be most familiar with. The Mail User Agent (<a id="_idIndexMarker605"/>MUA), or mail client, is the application that is used to write, send and read email messages. Anyone who has written and sent a message on any computer has used a Mail User Agent of one type or another. </p>&#13;
			<p class="My-Basic-Paragraph">Typical Graphical MUA’s on Linux are Evolution, Thunderbird and KMail. For those who prefer a text based mail client, there are also the more traditional <span class="My-Italic _idGenCharOverride-1">pine</span> and <span class="My-Italic _idGenCharOverride-1">mail</span> tools. </p>&#13;
			<p id="_idParaDest-264" class="Heading-1-1-1"><span class="Heading111Marker">28.1.2 </span><a id="_idTextAnchor349"/><a id="_idIndexMarker606"/>Mail Transfer Agent </p>&#13;
			<p class="My-Basic-Paragraph">The Mail Transfer Agent (<a id="_idIndexMarker607"/>MTA) is the part of the email system that does much of the work of transferring the email messages from one computer to another (either on the same local network or over the internet to a remote system). Once configured correctly, most users will not have any direct interaction with their chosen MTA unless they wish to re-configure it for any reason. There are many choices of MTA available for Linux including sendmail, Postfix, Fetchmail, Qmail and Exim. </p>&#13;
			<p id="_idParaDest-265" class="Heading-1-1-1"><span class="Heading111Marker">28.1.3 </span><a id="_idTextAnchor350"/><a id="_idIndexMarker608"/>Mail Delivery Agent </p>&#13;
			<p class="My-Basic-Paragraph">Another part of the infrastructure that is typically hidden from the user, the Mail Delivery Agent (<a id="_idIndexMarker609"/>MDA) sits in the background and performs filtering of the email messages between the Mail Transfer Agent and the mail client (MUA). The most popular form of MDA is a spam filter to remove all the unwanted email messages from the system before they reach the inbox of the user’s mail client (MUA). Popular MDAs are Spamassassin and Procmail. It is important to note that some Mail User Agent applications (such as Evolution, Thunderbird and KMail) include their own MDA filtering. Others, such as Pine and Basla, do not. This can be a source of confusion to the Linux beginner. </p>&#13;
			<p id="_idParaDest-266" class="Heading-1-1-1"><span class="Heading111Marker">28.1.4 </span><a id="_idTextAnchor351"/><a id="_idIndexMarker610"/>SMTP </p>&#13;
			<p class="My-Basic-Paragraph">SMTP is an acronym for Simple Mail Transport Protocol. This is the protocol used by the email systems to transfer mail messages from one server to another. This protocol is essentially the communications language that the MTAs use to talk to each other and transfer messages back and forth.</p>&#13;
			<p id="_idParaDest-267" class="Heading-1-1-1"><span class="Heading111Marker">28.1.5 </span><a id="_idTextAnchor352"/><a id="_idIndexMarker611"/>SMTP Relay</p>&#13;
			<p class="My-Basic-Paragraph">SMTP Relay is a protocol that allows an external SMTP server to be used to send emails instead of hosting a local SMTP server. This will typically involve using a service such as MailJet, SendGrid or MailGun. These services avoid the necessity to configure and maintain your own SMTP server and often provide additional benefits such as analytics. </p>&#13;
			<p id="_idParaDest-268" class="Heading-1-1"><span class="Heading11Marker">28.2 </span><a id="_idTextAnchor353"/>Configuring a CentOS 8 <a id="_idIndexMarker612"/><a id="_idIndexMarker613"/>Email Server </p>&#13;
			<p class="My-Basic-Paragraph">Many systems use the Sendmail MTA to transfer email messages and on many Linux distributions this is the default Mail Transfer Agent. Sendmail is, however, a complex system that can be difficult for beginner and experienced user alike to understand and configure. It is also falling from favor because it is considered to be slower at processing email messages than many of the more recent MTAs available. </p>&#13;
			<p class="My-Basic-Paragraph">Many system administrators are now using Postfix or Qmail to handle email. Both are faster and easier to configure than Sendmail. </p>&#13;
			<p class="My-Basic-Paragraph">For the purposes of this chapter, therefore, we will look at Postfix as an MTA because of its simplicity and popularity. If you would prefer to use Sendmail there are many books that specialize in the subject and that will do the subject much more justice than we can in this chapter. </p>&#13;
			<p class="My-Basic-Paragraph">As a first step, this chapter will cover the configuration of a CentOS 8 system to act as a full email server. Later in the chapter, the steps to make use of an SMTP Relay service will also be covered.</p>&#13;
			<p id="_idParaDest-269" class="Heading-1-1"><span class="Heading11Marker">28.3 </span><a id="_idTextAnchor354"/>Postfix Pre-Installation Steps </p>&#13;
			<p class="My-Basic-Paragraph">The first step before installing Postfix is to make sure that Sendmail is not already running on your system. You can check for this using the following command: </p>&#13;
			<p class="Code"># systemctl status sendmail</p>&#13;
			<p class="My-Basic-Paragraph">If sendmail is not installed, the tool will display a message similar to the following:</p>&#13;
			<p class="Code">Unit sendmail.service could not be found.</p>&#13;
			<p class="My-Basic-Paragraph">If sendmail is running on your system it is necessary to stop it before installing and configuring Postfix. To stop sendmail, run the following command: </p>&#13;
			<p class="Code"># systemctl stop sendmail</p>&#13;
			<p class="My-Basic-Paragraph">The next step is to ensure that sendmail does not get restarted automatically when the system is rebooted:</p>&#13;
			<p class="Code"># systemctl disable  sendmail </p>&#13;
			<p class="My-Basic-Paragraph">Sendmail is now switched off and configured so that it does not auto start when the system is booted. Optionally, to completely remove sendmail from the system, run the following command:</p>&#13;
			<p class="Code"># dnf remove sendmail</p>&#13;
			<p id="_idParaDest-270" class="Heading-1-1"><span class="Heading11Marker">28.4 </span><a id="_idTextAnchor355"/><a id="_idIndexMarker614"/>Firewall/Router Configuration</p>&#13;
			<p class="My-Basic-Paragraph">Since the sending and receiving of email messages involves network connections, the <span class="My-Italic _idGenCharOverride-1">firewall-cmd</span> tool will need to be used to add the <span class="My-Italic _idGenCharOverride-1">smtp</span> service to the firewall as follows:</p>&#13;
			<p class="Code"># firewall-cmd --permanent --add-service=smtp</p>&#13;
			<p class="My-Basic-Paragraph">It will also be important to configure any other firewall or router between the server and the internet to allow connections on port 25, 143 and 587 and, if necessary, to configure port forwarding for those ports to the corresponding ports on the email server.</p>&#13;
			<p class="My-Basic-Paragraph">With these initial steps completed, we can now move on to installing Postfix.</p>&#13;
			<p id="_idParaDest-271" class="Heading-1-1"><span class="Heading11Marker">28.5 </span><a id="_idTextAnchor356"/>Installing <a id="_idIndexMarker615"/>Postfix on CentOS 8</p>&#13;
			<p class="My-Basic-Paragraph">By default, the CentOS 8 installation process installs postfix for most configurations. To verify if postfix is already installed, use the following <span class="My-Italic _idGenCharOverride-1">rpm</span> command: </p>&#13;
			<p class="Code"># rpm -q postfix</p>&#13;
			<p class="My-Basic-Paragraph">If <span class="My-Italic _idGenCharOverride-1">rpm</span> reports that postfix is not installed, it may be installed as follows: </p>&#13;
			<p class="Code"># dnf install postfix</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">dnf</span> tool will download and install postfix, and configure a special postfix user in the <span class="My-Italic _idGenCharOverride-1">/etc/passwd</span> file. </p>&#13;
			<p id="_idParaDest-272" class="Heading-1-1"><span class="Heading11Marker">28.6 </span><a id="_idTextAnchor357"/>Configuring <a id="_idIndexMarker616"/>Postfix </p>&#13;
			<p class="My-Basic-Paragraph">The main configuration settings for postfix are located in the <span class="My-Italic _idGenCharOverride-1">/etc/postfix/</span><span class="My-Italic CharOverride-1"><a id="_idIndexMarker617"/><a id="_idIndexMarker618"/></span><span class="My-Italic _idGenCharOverride-1">main.cf</span> file. There are many resources on the internet that provide detailed information on postfix so this section will focus on the basic options required to get email up and running. </p>&#13;
			<p class="My-Basic-Paragraph">The key options in the <span class="My-Italic _idGenCharOverride-1">main.cf</span> file are: </p>&#13;
			<p class="Code">myhostname = mta1.domain.com</p>&#13;
			<p class="Code">mydomain = domain.com</p>&#13;
			<p class="Code">myorigin = $mydomain</p>&#13;
			<p class="Code">mydestination = mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain</p>&#13;
			<p class="Code">inet_interfaces = $myhostname</p>&#13;
			<p class="Code">mynetworks = subnet</p>&#13;
			<p class="My-Basic-Paragraph">Other settings will have either been set up for you by the installation process or are not needed unless you are feeling adventurous and want to configure a more sophisticated email system. </p>&#13;
			<p class="My-Basic-Paragraph">The format of <span class="My-Italic _idGenCharOverride-1">myhostname</span> is <span class="My-Italic _idGenCharOverride-1">host.domain.extension</span>. If, for example, your Linux system is named MyLinuxHost and your internet domain is MyDomain.com you would set the myhostname option as follows: </p>&#13;
			<p class="Code">myhostname = mylinuxhost.mydomain.com</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">mydomain</span> setting is just the domain part of the above setting. For example: </p>&#13;
			<p class="Code">mydomain = mydomain.com</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">myorigin</span> setting defines the name of the domain from which output email appears to come from when it arrives in the recipient’s inbox and should be set to your domain name:</p>&#13;
			<p class="Code">myorigin = $mydomain</p>&#13;
			<p class="My-Basic-Paragraph">Perhaps one of the most crucial parameters, <span class="My-Italic _idGenCharOverride-1">mydestination</span> relates to incoming messages and declares the domains for which this server is the final delivery destination. Any incoming email messages addressed to a domain name not on this list will be considered a relay request which, subject to the <span class="My-Italic _idGenCharOverride-1">mynetworks</span> setting (outlined below), will typically result in a delivery failure.</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">inet_interfaces</span> setting defines the network interfaces on the system via which postfix is permitted to receive email and is generally set to <span class="My-Italic _idGenCharOverride-1">all:</span></p>&#13;
			<p class="Code">inet_interfaces = all</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">mynetworks</span> setting defines which external systems are trusted to use the server as an SMTP relay. Possible values for this setting are as follows:</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-4">•</span><span class="My-Bold _idGenCharOverride-1">host</span> - Only the local system is trusted. Attempts by all external clients to use the server as a relay will be rejected.</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-4">•</span><span class="My-Bold _idGenCharOverride-1">subnet</span> - Only systems on the same network subnet are permitted to use the server as a relay. If, for example, the server has an IP address of 192.168.1.29, a client system with an IP address of 192.168.1.30 would be able to use the server as a relay.</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-4">•</span><span class="My-Bold _idGenCharOverride-1">class</span> - Any systems within the same IP address class (A, B and C) may use the server as a relay.</p>&#13;
			<p class="My-Basic-Paragraph">Trusted IP addresses may also be defined manually by specifying subnets, address ranges or referencing pattern files. The following example declares the local host and the subnet 192.168.0.0 as trusted IP addresses.</p>&#13;
			<p class="Code">mynetworks = 192.168.0.0/24, 127.0.0.0/8</p>&#13;
			<p class="My-Basic-Paragraph">For this example, set the property to <span class="My-Italic _idGenCharOverride-1">subnet</span> so that any other systems on the same local network as the server are able to send email via SMTP relay while external systems are prevented from doing so.</p>&#13;
			<p class="Code">mynetworks = subnet<span class="CharOverride-2"> </span></p>&#13;
			<p id="_idParaDest-273" class="Heading-1-1"><span class="Heading11Marker">28.7 </span><a id="_idTextAnchor358"/>Configuring <a id="_idIndexMarker619"/><a id="_idIndexMarker620"/><a id="_idIndexMarker621"/>DNS MX Records</p>&#13;
			<p class="My-Basic-Paragraph">When you registered and configured your domain name with a registrar, a number of default values will have been configured in the DNS settings. One of these is the so-called <span class="My-Italic _idGenCharOverride-1">Mail Exchanger (MX)</span> record. This record essentially defines where email addressed to your domain should be sent and is usually set by default to a mail server provided by your registrar. If you are hosting your own mail server, the MX record should be set to your domain or the address of your mail server. The steps on how to make this change will depend on your domain registrar but generally involves editing the DNS information for the domain and either adding or editing an existing MX record so that it points to your email server. </p>&#13;
			<p id="_idParaDest-274" class="Heading-1-1"><span class="Heading11Marker">28.8 </span><a id="_idTextAnchor359"/>Starting <a id="_idIndexMarker622"/>Postfix on a CentOS 8 System</p>&#13;
			<p class="My-Basic-Paragraph">Once the <span class="My-Italic _idGenCharOverride-1">/etc/postfix/main.cf</span> file is configured with the correct settings it is now time to start up postfix. This can be achieved from the command-line as follows: </p>&#13;
			<p class="Code"># systemctl start postfix</p>&#13;
			<p class="My-Basic-Paragraph">To configure postfix to start automatically at system startup, run the following command: </p>&#13;
			<p class="Code"># systemctl enable postfix</p>&#13;
			<p class="My-Basic-Paragraph">The postfix process should now start up. The best way to verify that everything is working is to check your mail log. This is typically in the <span class="My-Italic _idGenCharOverride-1">/var/log/maillog</span> file and should now contain an entry resembling the following output: </p>&#13;
			<p class="Code"><a id="_idIndexMarker623"/>Mar 25 11:21:48 demo-server postfix/postfix-script[5377]: starting the Postfix mail system</p>&#13;
			<p class="Code">Mar 25 11:21:48 demo-server postfix/master[5379]: daemon started -- version 3.3.1, configuration /etc/postfix </p>&#13;
			<p class="My-Basic-Paragraph">As long as no error messages have been logged, you have successfully installed and started postfix and are ready to test the postfix configuration. </p>&#13;
			<p id="_idParaDest-275" class="Heading-1-1"><span class="Heading11Marker">28.9 </span><a id="_idTextAnchor360"/>Testing <a id="_idIndexMarker624"/>Postfix</p>&#13;
			<p class="My-Basic-Paragraph">An easy way to test the postfix configuration is to send an email message between local users on the system. To perform a quick test, use the <span class="My-Italic _idGenCharOverride-1">mail</span> tool as follows (where <span class="My-Italic _idGenCharOverride-1">name</span> and <span class="My-Italic _idGenCharOverride-1">mydomain</span> are replaced by the name of a user on the system and your domain name respectively):</p>&#13;
			<p class="Code"># mail name@mydomain.com</p>&#13;
			<p class="My-Basic-Paragraph">When prompted, enter a subject for the email message and then enter message body text. To send the email message, simply press Ctrl-D. For example:</p>&#13;
			<p class="Code"># mail neil@mydomain.com</p>&#13;
			<p class="Code">Subject: Test email message</p>&#13;
			<p class="Code">This is a test message.</p>&#13;
			<p class="Code">EOT</p>&#13;
			<p class="My-Basic-Paragraph">Run the <span class="My-Italic _idGenCharOverride-1">mail</span> command again, this time as the other user and verify that the message was sent and received:</p>&#13;
			<p class="Code">$ mail</p>&#13;
			<p class="Code">Heirloom Mail version 12.5 7/5/10.  Type ? for help.</p>&#13;
			<p class="Code">"/var/spool/mail/neilsmyth": 1 message 1 new</p>&#13;
			<p class="Code">&gt;N  1 root                  Mon Mar 25 13:36  18/625   "Test email message"</p>&#13;
			<p class="Code">&amp; </p>&#13;
			<p class="My-Basic-Paragraph">If the message does not appear, check the log file (<span class="My-Italic _idGenCharOverride-1">/var/log/maillog</span>) for errors. A successful mail delivery will appear in the log file as follows:</p>&#13;
			<p class="Code">Mar 25 13:41:37 demo-server postfix/pickup[7153]: 94FAF61E8F4A: uid=0 from=&lt;root&gt;</p>&#13;
			<p class="Code">Mar 25 13:41:37 demo-server postfix/cleanup[7498]: 94FAF61E8F4A: message-id=&lt;20190325174137.94FAF61E8F4A@demo-server.mydomain.com&gt;</p>&#13;
			<p class="Code">Mar 25 13:41:37 demo-server postfix/qmgr[7154]: 94FAF61E8F4A: from=&lt;root@mydomain.com&gt;, size=450, nrcpt=1 (queue active)</p>&#13;
			<p class="Code">Mar 25 13:41:37 demo-server postfix/local[7500]: 94FAF61E8F4A: to=&lt;neil@mydomain.com&gt;, relay=local, delay=0.12, delays=0.09/0.01/0/0.02, dsn=2.0.0, status=sent (delivered to mailbox)</p>&#13;
			<p class="Code">Mar 25 13:41:37 demo-server postfix/qmgr[7154]: 94FAF61E8F4A: removed</p>&#13;
			<p class="My-Basic-Paragraph">Once local email is working, try sending an email to an external address (such as a GMail account), Also, test that incoming mail works by sending an email from an external account to a user on your domain. In each case, check the <span class="My-Italic _idGenCharOverride-1">/var/log/maillog</span> file for explanations of any errors.</p>&#13;
			<p id="_idParaDest-276" class="Heading-1-1"><span class="Heading11Marker">28.10 </span><a id="_idTextAnchor361"/>Sending Mail via an <a id="_idIndexMarker625"/><a id="_idIndexMarker626"/><a id="_idIndexMarker627"/>SMTP Relay Server</p>&#13;
			<p class="My-Basic-Paragraph">An alternative to configuring a mail server to handle outgoing email messages is to use an SMTP Relay service. As previously discussed, a number of services are available, most of which can be found by performing a web search for “SMTP Relay Service”. Most of these services will require you to verify your domain in some way and will provide MX records with which to update your DNS settings. You will also be provided with a username and password which need to be added to the postfix configuration. The remainder of this section makes the assumption that postfix is already installed on your system and that all of the initial steps required by your chosen SMTP Relay provider have been completed. </p>&#13;
			<p class="My-Basic-Paragraph">Begin by editing the <span class="My-Italic _idGenCharOverride-1">/etc/postfix/main.cf</span> file and configuring the <span class="My-Italic _idGenCharOverride-1">myhostname</span> parameter with your domain name:</p>&#13;
			<p class="Code">myhostname = mydomain.com</p>&#13;
			<p class="My-Basic-Paragraph">Next, create a new file in <span class="My-Italic _idGenCharOverride-1">/etc/postfix</span> named <span class="My-Italic _idGenCharOverride-1">sasl_passwd</span> and add a line containing the mail server host provided by the relay service and the user name and password. For example:</p>&#13;
			<p class="Code">[smtp.myprovider.com]:587 neil@mydomain.com:mypassword</p>&#13;
			<p class="My-Basic-Paragraph">Note that port 587 has also been specified in the above entry. Without this setting, postfix will default to using port 25 which is blocked by default by most SMTP relay service providers.</p>&#13;
			<p class="My-Basic-Paragraph">With the password file created, use the <span class="My-Italic _idGenCharOverride-1">postmap</span> utility to generate the hash database containing the mail credentials:</p>&#13;
			<p class="Code"># postmap /etc/postfix/sasl_passwd</p>&#13;
			<p class="My-Basic-Paragraph">Before proceeding, take some additional steps to secure your postfix credentials:</p>&#13;
			<p class="Code"># chown root:root /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db</p>&#13;
			<p class="Code"># chmod 0600 /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db</p>&#13;
			<p class="My-Basic-Paragraph">Edit the <span class="My-Italic _idGenCharOverride-1">main.cf</span> file once again and add an entry to specify the relay server:</p>&#13;
			<p class="Code">relayhost = [smtp.myprovider.com]:587</p>&#13;
			<p class="My-Basic-Paragraph">Remaining within the <span class="My-Italic _idGenCharOverride-1">main.cf</span> file, add the following lines to configure the authentication settings for the SMTP server:</p>&#13;
			<p class="Code">smtp_use_tls = yes</p>&#13;
			<p class="Code">smtp_sasl_auth_enable = yes</p>&#13;
			<p class="Code">smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd</p>&#13;
			<p class="Code">smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt</p>&#13;
			<p class="Code">smtp_sasl_security_options = noanonymous</p>&#13;
			<p class="Code">smtp_sasl_tls_security_options = noanonymous</p>&#13;
			<p class="My-Basic-Paragraph">Finally, restart the postfix service:</p>&#13;
			<p class="Code"># systemctl restart postfix</p>&#13;
			<p class="My-Basic-Paragraph">Once the service has restarted, try sending and receiving mail using either the <span class="My-Italic _idGenCharOverride-1">mail</span> tool or your preferred mail client. </p>&#13;
			<p id="_idParaDest-277" class="Heading-1-1"><span class="Heading11Marker">28.11 </span><a id="_idTextAnchor362"/>Summary</p>&#13;
			<p class="My-Basic-Paragraph">A complete, end-to-end email system consists of a Mail User Agent (MUA), Mail Transfer Agent (MTA), Mail Delivery Agent (MDA) and the SMTP protocol. CentOS 8 provides a number of options in terms of MTA solutions, one of the more popular being Postfix. This chapter has outlined how to install, configure and test postfix on a CentOS 8 system both to act as a mail server and to send and receive email using a third party SMTP relay server.</p>&#13;
		</div>&#13;
</div>



  </body></html>