<html><head></head><body><div id="sbo-rt-content" class="calibre1"><div id="_idContainer014" class="calibre2">
			<h1 id="_idParaDest-70" class="calibre5"><em class="italic"><a id="_idTextAnchor071" class="pcalibre calibre6 pcalibre1"/>Chapter 3</em>: Managing User Logins</h1>
			<p class="calibre3">When we log in to an SELinux-enabled system, we receive an SELinux context to work in. This context contains an SELinux user, an SELinux role, a domain, and optionally, a sensitivity range. As the SELinux user defines the roles and types that can be accessed, managing user logins and SELinux users is the first step in configuring end users on the system.</p>
			<p class="calibre3">To enable properly configured users, we will learn to define users that have sufficient rights to do their jobs, ranging from regular users with strict SELinux protections to fully privileged administrative users with few SELinux protections. We will create and assign categories and sensitivities, as well as assign roles to users and use various tools to switch roles. At the end of the chapter, we will see how SELinux integrates with the Linux authentication process.</p>
			<p class="calibre3">In this chapter, we're going to cover the following main topics:</p>
			<ul class="calibre8">
				<li class="calibre9">User-oriented SELinux contexts</li>
				<li class="calibre9">SELinux users and roles</li>
				<li class="calibre9">Handling SELinux roles</li>
				<li class="calibre9">SELinux and PAM</li>
			</ul>
			<h1 id="_idParaDest-71" class="calibre5"><a id="_idTextAnchor072" class="pcalibre calibre6 pcalibre1"/>Technical requirements</h1>
			<p class="calibre3">Check out the following video to see the Code in Action: <a href="https://bit.ly/3jbASmr" class="pcalibre calibre6 pcalibre1">https://bit.ly/3jbASmr</a></p>
			<h1 id="_idParaDest-72" class="calibre5"><a id="_idTextAnchor073" class="pcalibre calibre6 pcalibre1"/>User-oriented SELinux contexts</h1>
			<p class="calibre3">Once logged <a id="_idIndexMarker177" class="pcalibre calibre6 pcalibre1"/>in to a system, our user will run inside a certain context. This user context defines the rights and privileges that we, as a user, have on the system. The command to obtain current user information, <strong class="source-inline">id</strong>, also supports displaying the current SELinux context information:</p>
			<p class="source-code">$ id -Z</p>
			<p class="source-code">unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</p>
			<p class="calibre3">On SELinux systems with a targeted policy type, chances are very high that all users are logged in as <strong class="source-inline">unconfined_u</strong> (the first part of the context). On more restricted systems, the user can be <strong class="source-inline">user_u</strong> (regular restricted users), <strong class="source-inline">staff_u</strong> (operators), <strong class="source-inline">sysadm_u</strong> (system administrators), or any of the other SELinux users.</p>
			<p class="calibre3">The SELinux user defines the roles that the user can switch to. SELinux roles themselves define the application domains that the user can use. By default, a fixed number of SELinux users are available on the system, but administrators can create additional SELinux users. It is also the administrator's task to assign Linux logins to SELinux users.</p>
			<p class="calibre3">SELinux roles, on the other hand, cannot be created through administrative commands, as SELinux <a id="_idIndexMarker178" class="pcalibre calibre6 pcalibre1"/>roles are part of the SELinux policy. For this, the SELinux policy needs to be enhanced with additional rules that create the role. We will touch upon that in <a href="B16276_15_Final_VK.xhtml#_idTextAnchor373" class="pcalibre calibre6 pcalibre1"><em class="italic">Chapter 15</em></a>, <em class="italic">Using the Reference Policy</em>.</p>
			<p class="calibre3">To view the currently available roles, use <strong class="source-inline">seinfo</strong>:</p>
			<p class="source-code"># seinfo --role</p>
			<p class="source-code">Roles: 14</p>
			<p class="source-code">  auditadm_r</p>
			<p class="source-code">  dbadm_r</p>
			<p class="source-code">  ...</p>
			<p class="source-code">  xguest_r</p>
			<p class="calibre3">SELinux roles can be coarse-grained (such as <strong class="source-inline">sysadm_r</strong>) or more functionality-oriented (such as <strong class="source-inline">dbadm_r</strong>). Custom SELinux roles can even be very fine-grained, only granting the ability to transition into limited domains.</p>
			<p class="calibre3">Let's see how to create and manage SELinux users.</p>
			<h1 id="_idParaDest-73" class="calibre5"><a id="_idTextAnchor074" class="pcalibre calibre6 pcalibre1"/>SELinux users and roles</h1>
			<p class="calibre3">In SELinux-enabled <a id="_idIndexMarker179" class="pcalibre calibre6 pcalibre1"/>environments, the login binary calls the <strong class="source-inline">libselinux</strong> API to <a id="_idIndexMarker180" class="pcalibre calibre6 pcalibre1"/>establish the initial mapping between SELinux users and local users. Then, after finding the right SELinux user, the system looks up the role and domain that the user should be in and sets that as the user's context.</p>
			<h2 id="_idParaDest-74" class="calibre10"><a id="_idTextAnchor075" class="pcalibre calibre6 pcalibre1"/>Listing SELinux user mappings</h2>
			<p class="calibre3">When <a id="_idIndexMarker181" class="pcalibre calibre6 pcalibre1"/>logged in to the system, we can use <strong class="source-inline">id -Z</strong> to obtain the current SELinux context. For many users, this context will be defined by the unconfined user (<strong class="source-inline">unconfined_u</strong>), regardless of their username. If not that, it will generally be a context based on one of <strong class="source-inline">sysadm_u</strong>, <strong class="source-inline">staff_u</strong>, or <strong class="source-inline">user_u</strong>. This is because most Linux distributions will only provide a limited set of SELinux users by default, aligned with the SELinux roles that they support.</p>
			<p class="calibre3">During login, the service process through which the login is handled will check a local definition file to find the appropriate mapping between the Linux account and the SELinux user. Let's look at the existing login mappings using <strong class="source-inline">semanage login -l</strong>. The following output is the default output on a CentOS system:</p>
			<p class="source-code"># semanage login -l</p>
			<p class="source-code">Login Name		SELinux User	MLS/MCS Range	Service</p>
			<p class="source-code">__default__	unconfined_u	s0-s0:c0.c1023	*</p>
			<p class="source-code">root			unconfined_u	s0-s0:c0.c1023	*</p>
			<p class="calibre3">The output of the command shows one login mapping per line. Each mapping consists of the following:</p>
			<ul class="calibre8">
				<li class="calibre9">The <strong class="source-inline">Login Name</strong> for which the mapping is applicable (that is, the username)</li>
				<li class="calibre9">The <strong class="source-inline">SELinux User</strong> to which the login is mapped</li>
				<li class="calibre9">The <strong class="source-inline">MLS/MCS Range</strong> to which the login is mapped</li>
				<li class="calibre9">The <strong class="source-inline">Service</strong> for which the mapping applies (this is used for local customizations, which we will tackle in the <em class="italic">Customizing logins for services</em> section)</li>
			</ul>
			<p class="calibre3">The login name can contain a few special values that do not map directly to a single Linux account:</p>
			<ul class="calibre8">
				<li class="calibre9"><strong class="source-inline">__default__</strong> is a catch-all rule. If none of the other rules match, then the users are mapped to the SELinux user identified through this line. In the given example, all users are mapped to the <strong class="source-inline">unconfined_u</strong> SELinux user, meaning regular Linux users are hardly confined in their actions. When this isn't meant to happen, administrators usually map regular logins to restricted SELinux users, while administrative logins are mapped to the <strong class="source-inline">staff_u</strong> or <strong class="source-inline">sysadm_u</strong> SELinux users.</li>
				<li class="calibre9">Login names starting with <strong class="source-inline">%</strong> will map to groups. This allows administrators to map a group of people directly to an SELinux user rather than having to manage the mappings individually.</li>
			</ul>
			<p class="calibre3">When both an individual user mapping and group mapping match, then the individual user mapping takes precedence. When multiple group definitions exist, then SELinux will use the first matching group mapping (in the order listed in the underlying <strong class="source-inline">seusers</strong> configuration file).</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">System processes (non-interactively logged-in Linux accounts) are mapped to the <strong class="source-inline">system_u</strong> SELinux user. This SELinux user should never be assigned to end user logins.</p>
			<p class="calibre3">In the case of an MLS- or MCS-enabled system, the mapping contains information about the user's allowed <a id="_idIndexMarker182" class="pcalibre calibre6 pcalibre1"/>sensitivity range (MLS/MCS range). This way, we can map multiple users to the same restricted SELinux user, while differentiating between these users through the allowed sensitivities. For instance, one user might only be allowed to access low-sensitivity areas (<strong class="source-inline">s0</strong>), whereas another user might also have access to higher sensitivities (for example, <strong class="source-inline">s1</strong>) or different categories.</p>
			<h2 id="_idParaDest-75" class="calibre10"><a id="_idTextAnchor076" class="pcalibre calibre6 pcalibre1"/>Mapping logins to SELinux users</h2>
			<p class="calibre3">Let's use <a id="_idIndexMarker183" class="pcalibre calibre6 pcalibre1"/>a few examples to show how we make these mappings work. For more intricate details on this, see the <em class="italic">SELinux and PAM</em> section. We'll assume we have a Linux user called <strong class="source-inline">lisa</strong>, and we want her account to be mapped to the <strong class="source-inline">staff_u</strong> SELinux user, whereas all other users in the <strong class="source-inline">users</strong> group are mapped to the <strong class="source-inline">user_u</strong> SELinux user.</p>
			<p class="calibre3">We can accomplish this through the <strong class="source-inline">semanage login</strong> command, using the <strong class="source-inline">-a</strong> (add) option:</p>
			<p class="source-code"># semanage login -a -s staff_u lisa</p>
			<p class="source-code"># semanage login -a -s user_u %users</p>
			<p class="calibre3">The <strong class="source-inline">-s</strong> parameter assigns the SELinux user to the given login, whereas the <strong class="source-inline">-r</strong> parameter handles the sensitivity (and categories) for that user. For instance, let's modify (using <strong class="source-inline">-m</strong> instead of <strong class="source-inline">-a</strong>) the recently created group-based definition by mapping to the <strong class="source-inline">staff_u</strong> user instead, and limiting these users to the <strong class="source-inline">s0-s0</strong> sensitivity range and categories <strong class="source-inline">c0</strong> to <strong class="source-inline">c4</strong>:</p>
			<p class="source-code"># semanage login -m -s staff_u -r "s0-s0:c0.c4" %users</p>
			<p class="calibre3">The sensitivity range of a login mapping may not exceed the range assigned to the SELinux user. For example, if the <strong class="source-inline">staff_u</strong> SELinux user itself is only granted access to <strong class="source-inline">s0-s0:c0.c3</strong>, then the previous command will fail as it is trying to assign a broader access range. We'll discuss how to define SELinux users and their range in the <em class="italic">Creating SELinux users</em> section.</p>
			<p class="calibre3">The <strong class="source-inline">semanage login</strong> command updates the <strong class="source-inline">seusers</strong> file located inside <strong class="source-inline">/etc/selinux/targeted</strong>. If multiple group mappings are defined, then the order of mappings within this file defines which mapping applies to a given user. Users that belong to multiple mapped groups will be assigned an SELinux user based on the first match.</p>
			<p class="calibre3">While it <a id="_idIndexMarker184" class="pcalibre calibre6 pcalibre1"/>is possible to update the order of the entries in the <strong class="source-inline">seusers</strong> file, this is not recommended. Every time <strong class="source-inline">semanage login</strong> modifies the <strong class="source-inline">seusers</strong> file, it will reorder the mappings. Instead, when a user belongs to multiple mapped groups, we advise you to create an individual (user-based) mapping. This is also shown whenever we create a group mapping for a group that contains users for which active mappings already exist:</p>
			<p class="source-code"># semanage login -a -s guest_u %nginx</p>
			<p class="source-code">libsemanage.add_user: User taylor is already mapped to group users, but also belongs to group nginx. Add an explicit mapping for this user to override group mappings.</p>
			<p class="calibre3">The changes take effect when a new login occurs, so we should force a logout for these users. The following command kills all the processes of the <strong class="source-inline">lisa</strong> user, forcing a logout for that user:</p>
			<p class="source-code"># pkill -KILL -u lisa</p>
			<p class="calibre3">Also, when we modify a user's settings, we should also reset the contexts of that user's home directory (while that user is not logged in). To accomplish this, use <strong class="source-inline">restorecon</strong> as follows:</p>
			<p class="source-code"># restorecon -RF /home/lisa</p>
			<p class="calibre3">The <strong class="source-inline">-F</strong> option in the preceding command forces a reset, while <strong class="source-inline">-R</strong> does this recursively.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Running the <strong class="source-inline">restorecon -RF</strong> command will also reset file contexts that the user has manually set using tools such as <strong class="source-inline">chcon</strong>. We recommend defining SELinux user mappings up front, or recursively changing only the SELinux user of the files using <strong class="source-inline">chcon -R -u</strong>. The <strong class="source-inline">chcon</strong> application and file contexts are discussed in the next chapter.</p>
			<p class="calibre3">To remove <a id="_idIndexMarker185" class="pcalibre calibre6 pcalibre1"/>a login mapping, use the <strong class="source-inline">-d</strong> (delete) option. Don't forget to run the <strong class="source-inline">restorecon</strong> command afterward:</p>
			<p class="source-code"># semanage login -d lisa</p>
			<p class="source-code"># restorecon -RF /home/lisa</p>
			<p class="calibre3">Don't forget to force a user logout again if this user is active on the system.</p>
			<h2 id="_idParaDest-76" class="calibre10"><a id="_idTextAnchor077" class="pcalibre calibre6 pcalibre1"/>Customizing logins for services</h2>
			<p class="calibre3">When login <a id="_idIndexMarker186" class="pcalibre calibre6 pcalibre1"/>mappings are added using <strong class="source-inline">semanage login</strong>, they apply to all services. There is no option in <strong class="source-inline">semanage</strong> to allow customizing the mappings based on the service. However, that does not mean it is not possible.</p>
			<p class="calibre3">The SELinux user space tools and libraries will consult the following two configuration files to know what the mappings are:</p>
			<ul class="calibre8">
				<li class="calibre9">The <strong class="source-inline">/etc/selinux/targeted/seusers</strong> file contains the standard, service-agnostic mappings. This file is managed by <strong class="source-inline">semanage login</strong> and should not be updated through any other means.</li>
				<li class="calibre9">The <strong class="source-inline">/etc/selinux/targeted/logins</strong> directory contains customized mappings, one file per Linux account. So, the custom mapping for the root user will be in <strong class="source-inline">/etc/selinux/targeted/logins/root</strong>.</li>
			</ul>
			<p class="calibre3">Inside the files for customized mappings, administrators can define, per service, a different SELinux user to map to. The services are the <strong class="bold">Pluggable Authentication Modules</strong> (<strong class="bold">PAM</strong>) services through which a user can log in, and <a id="_idIndexMarker187" class="pcalibre calibre6 pcalibre1"/>more information on this can be found in the <em class="italic">SELinux and PAM</em> section.</p>
			<p class="calibre3">For instance, to have the <strong class="source-inline">root</strong> user – when logged in through SSH – be mapped to the <strong class="source-inline">user_u</strong> SELinux user rather than their default <strong class="source-inline">unconfined_u</strong> user, the <strong class="source-inline">root</strong> file would need to contain the following:</p>
			<p class="source-code">sshd:user_u:s0</p>
			<p class="calibre3">When <a id="_idIndexMarker188" class="pcalibre calibre6 pcalibre1"/>querying the current mapping, <strong class="source-inline">semanage login</strong> will show this customization as follows:</p>
			<p class="source-code"># semanage login -l</p>
			<p class="source-code">...</p>
			<p class="source-code">Local customization in /etc/selinux/targeted/logins</p>
			<p class="source-code">root		user_u		s0		sshd</p>
			<p class="calibre3">Of course, this customization does not need to be so drastic. It can also be used to limit the user's default MLS/MCS range. For instance, to limit the categories to <strong class="source-inline">c0.c8</strong> (rather than the default <strong class="source-inline">c0.c1023</strong> range) you would use the following:</p>
			<p class="source-code">sshd:unconfined_u:s0-s0:c0.c8</p>
			<p class="calibre3">Such customizations allow us to flexibly change the access control policies based on the PAM service used.</p>
			<h2 id="_idParaDest-77" class="calibre10"><a id="_idTextAnchor078" class="pcalibre calibre6 pcalibre1"/>Creating SELinux users</h2>
			<p class="calibre3">By default, only <a id="_idIndexMarker189" class="pcalibre calibre6 pcalibre1"/>a small number of SELinux users are available for mapping to logins. If we want more control over the Linux accounts and their mappings, we need to create additional SELinux users.</p>
			<p class="calibre3">First, list the currently known SELinux users using the <strong class="source-inline">semanage user -l</strong> command, as follows:</p>
			<p class="source-code"># semanage user -l</p>
			<p class="source-code">SELinux	Labeling	MLS/		MLS/</p>
			<p class="source-code">User		Prefix	MCS Level	MCS Range		SELinux Roles</p>
			<p class="source-code">guest_u	user		s0		s0			guest_r</p>
			<p class="source-code">root		user		s0		s0-s0:c0.c1023	staff_r ...</p>
			<p class="source-code">...</p>
			<p class="source-code">xguest_u	user		s0		s0			xguest_r</p>
			<p class="calibre3">Next, create a new SELinux user with <strong class="source-inline">semanage user</strong>, using the <strong class="source-inline">-a</strong> (add) option. We need to give SELinux <a id="_idIndexMarker190" class="pcalibre calibre6 pcalibre1"/>additional information about this SELinux user, such as the following:</p>
			<ul class="calibre8">
				<li class="calibre9">The default sensitivity (using the <strong class="source-inline">-L</strong> option) for the SELinux user. This is the sensitivity that the user starts with.</li>
				<li class="calibre9">The security clearance (using the <strong class="source-inline">-r</strong> option) applicable to the SELinux user. This range cannot be extended when defining login mappings. It is, however, possible to give a user a more limited range, as long as it is bounded by the current range.</li>
				<li class="calibre9">The allowed role or roles (using the <strong class="source-inline">-R</strong> option) for the SELinux user.<p class="callout-heading">Tip</p><p class="callout">The labeling prefix shown in the previous example is used to dynamically create SELinux policies with specific prefixes, such as <strong class="source-inline">&lt;prefix&gt;_home_t</strong> for user's home files. Most distributions leave this to the default <em class="italic">user</em> setting, and changing it is done through the (undocumented) <strong class="source-inline">-P</strong> parameter to <strong class="source-inline">semanage user</strong>.</p></li>
			</ul>
			<p class="calibre3">In the following example, we're configuring the SELinux user <strong class="source-inline">finance_u</strong>:</p>
			<p class="source-code"># semanage user -a -L s0 -r "s0-s0:c0.c127" -R user_r finance_u</p>
			<p class="calibre3">When the command creates the SELinux user, its information becomes part of the SELinux policy. From this point onward, administrators can map Linux accounts to this SELinux user.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">SELinux roles are enabled through the SELinux user that a Linux account is mapped to. When an administrator wants to allow additional existing roles to a Linux account, the administrator either updates existing SELinux mappings to include the new role(s) or creates a new SELinux user that has access to the new role(s) and then maps this SELinux user to the Linux account.</p>
			<p class="calibre3">Just like with login mappings, <strong class="source-inline">semanage user</strong> also accepts the <strong class="source-inline">-m</strong> option to modify an existing entry, or <strong class="source-inline">-d</strong> to delete one. For instance, the following command deletes the <strong class="source-inline">finance_u</strong> SELinux user:</p>
			<p class="source-code"># semanage user -d finance_u</p>
			<p class="calibre3">Separate SELinux <a id="_idIndexMarker191" class="pcalibre calibre6 pcalibre1"/>users enhance the audit information since SELinux users generally do not change during a user's session, whereas the effective Linux user ID can. If the user creates files or other resources, these resources also inherit the SELinux user part in their security context.</p>
			<h2 id="_idParaDest-78" class="calibre10"><a id="_idTextAnchor079" class="pcalibre calibre6 pcalibre1"/>Listing accessible domains</h2>
			<p class="calibre3">When creating <a id="_idIndexMarker192" class="pcalibre calibre6 pcalibre1"/>SELinux users, one of the parameters that needs to be provided is the role or roles for an SELinux user. Most of the roles are self-explanatory: the <strong class="source-inline">dbadm_r</strong> role is for DBAs, whereas the <strong class="source-inline">webadm_r</strong> role is for web application infrastructure administrators. If a role is not clear, or an administrator is not certain which accesses are part of a given role, the administrator can still query the SELinux policy for more information.</p>
			<p class="callout-heading">Informational note</p>
			<p class="callout">This book will mostly focus on the command-line utilities used to query and interact with the active SELinux policy. In <a href="B16276_13_Final_VK.xhtml#_idTextAnchor330" class="pcalibre calibre6 pcalibre1"><em class="italic">Chapter 13</em></a>, <em class="italic">Analyzing Policy Behavior</em>, we will also cover the graphical utility <strong class="source-inline">apol</strong>.</p>
			<p class="calibre3">As documented earlier, roles define which domains are accessible for the users associated with the role. We saw that <strong class="source-inline">seinfo</strong> can show us the available roles, but it can do more. It can list the domains accessible for a role as well, using the <strong class="source-inline">-x</strong> option:</p>
			<p class="source-code"># seinfo -r dbadm_r -x</p>
			<p class="source-code">Roles: 1</p>
			<p class="source-code">  role dbadm_r types { ... qmail_inject_t user_mail_t ... };</p>
			<p class="calibre3">In this example, users running with the <strong class="source-inline">dbadm_r</strong> role as part of their security context will be able to transition to, for instance, the <strong class="source-inline">qmail_inject_t</strong> (the domain used to read email messages and pass those on to the <strong class="source-inline">qmail</strong> queue) and <strong class="source-inline">user_mail_t</strong> (the domain used for generic email-sending command-line applications) domains.</p>
			<p class="calibre3">The information provided through the <strong class="bold">dominated roles</strong> is usually not of concern to the administrators. Role <a id="_idIndexMarker193" class="pcalibre calibre6 pcalibre1"/>dominance, although supported in SELinux <a id="_idIndexMarker194" class="pcalibre calibre6 pcalibre1"/>core, is not used by Linux distribution policies. It signifies the inheritance of (other) roles, but it will always just show the queried role.</p>
			<h2 id="_idParaDest-79" class="calibre10"><a id="_idTextAnchor080" class="pcalibre calibre6 pcalibre1"/>Managing categories</h2>
			<p class="calibre3">Sensitivity labels <a id="_idIndexMarker195" class="pcalibre calibre6 pcalibre1"/>and their associated categories are identified through numeric values, which is great for computers but not that obvious for users. Luckily, the SELinux utilities support translating the levels and categories to human-readable values, even though they are still stored as numbers. As a result, almost all tools that can show contexts will show them translated rather than presented as numerical values.</p>
			<p class="calibre3">The translations are managed through the <strong class="source-inline">setrans.conf</strong> file, located in <strong class="source-inline">/etc/selinux/targeted</strong>. Inside this file, we can name specific values (for example, <strong class="source-inline">s0:c102</strong>) or ranges (such as <strong class="source-inline">s0-s0:c1.c127</strong>) with a string that is much easier for administrators to use. However, for <a id="_idIndexMarker196" class="pcalibre calibre6 pcalibre1"/>translations to be performed, <strong class="bold">mcstransd</strong> – the MCS translation daemon – needs to be running.</p>
			<p class="calibre3">Consider our example of the <strong class="source-inline">finance_u</strong> SELinux user who was allowed access to the <strong class="source-inline">c0.c127</strong> category range. Two of the categories within that range are <strong class="source-inline">c102</strong>, which we will tag as <strong class="source-inline">Contracts</strong>, and <strong class="source-inline">c103</strong>, which we will tag as <strong class="source-inline">Salaries</strong>. The <strong class="source-inline">c1.c127</strong> range will be labeled as <strong class="source-inline">FinanceData</strong>. The following diagram shows the relationship between these various categories:</p>
			<div class="calibre13">
				<div id="_idContainer013" class="img---figure">
					<img src="Images/B16276_03_001.jpg" alt="Figure 3.1 – Relationship of the example categories and category range " class="calibre20"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.1 – Relationship of the example categories and category range</p>
			<p class="calibre3">To accomplish this, the following should be placed in the <strong class="source-inline">setrans.conf</strong> file: </p>
			<p class="source-code">s0:c102=Contracts</p>
			<p class="source-code">s0:c103=Salaries</p>
			<p class="source-code">s0-s0:c1.c127=FinanceData</p>
			<p class="calibre3">After editing the <strong class="source-inline">setrans.conf</strong> file, the <strong class="source-inline">mcstransd</strong> application needs to be restarted.</p>
			<p class="calibre3">These translations are handled by the SELinux utilities, which connect to the <strong class="source-inline">mcstransd</strong> daemon through the <strong class="source-inline">.setrans-unix</strong> socket located in <strong class="source-inline">/var/run/setrans</strong> to query the <strong class="source-inline">setrans.conf</strong> file. If the daemon is not running or the communication with the daemon fails, the numeric sensitivity and category values are displayed.</p>
			<p class="calibre3">For instance, with the daemon running, the output of <strong class="source-inline">id -Z</strong> is now as follows:</p>
			<p class="source-code"># id -Z</p>
			<p class="source-code">unconfined_u:unconfined_r:unconfined_t:SystemLow-SystemHigh</p>
			<p class="calibre3">We can <a id="_idIndexMarker197" class="pcalibre calibre6 pcalibre1"/>view the available sensitivities and their human-readable counterparts using the <strong class="source-inline">chcat</strong> tool. The following example displays the translations after adding the finance-related ones:</p>
			<p class="source-code">$ chcat -L</p>
			<p class="source-code">s0			SystemLow</p>
			<p class="source-code">s0-s0:c0.c1023	SystemLow-SystemHigh</p>
			<p class="source-code">s0:c0.c1023	SystemHigh</p>
			<p class="source-code">s0:c102		Contracts</p>
			<p class="source-code">s0:c103		Salaries</p>
			<p class="source-code">s0-s0:c1.c127	FinanceData</p>
			<p class="calibre3">The same <strong class="source-inline">chcat</strong> utility can be used to assign categories to users. For instance, to grant the <strong class="source-inline">Salaries</strong> category to the <strong class="source-inline">lisa</strong> Linux user, we'd use the following command:</p>
			<p class="source-code"># chcat -l -- +Salaries lisa</p>
			<p class="calibre3">The previous command grants the <strong class="source-inline">Salaries</strong> category (<strong class="source-inline">c103</strong>) to the Linux user <strong class="source-inline">lisa</strong>. The user mapping is immediately updated with this information. Again, we need to make sure that the <strong class="source-inline">lisa</strong> user is logged out for the changes to take effect.</p>
			<p class="calibre3">With this, we end our section on managing SELinux users and logins. We've learned how to align users with SELinux users so that they log in to the system with the correct context. In the next section, we will look at the SELinux roles and how to apply those to SELinux users.</p>
			<h1 id="_idParaDest-80" class="calibre5"><a id="_idTextAnchor081" class="pcalibre calibre6 pcalibre1"/>Handling SELinux roles</h1>
			<p class="calibre3">We saw <a id="_idIndexMarker198" class="pcalibre calibre6 pcalibre1"/>how SELinux users define the role(s) that a user can hold. But how does SELinux enforce which role a user logs in through? And when logged in, how can a user switch their active role?</p>
			<h2 id="_idParaDest-81" class="calibre10"><a id="_idTextAnchor082" class="pcalibre calibre6 pcalibre1"/>Defining allowed SELinux contexts</h2>
			<p class="calibre3">To select the context assigned to a successfully authenticated user, SELinux introduces the notion of a <a id="_idIndexMarker199" class="pcalibre calibre6 pcalibre1"/>default context. Based on the context of the service through which a user logs in (or through which the user executes commands), the system selects the right user context.</p>
			<p class="calibre3">Inside the <strong class="source-inline">/etc/selinux/targeted/contexts</strong> directory, a file called <strong class="source-inline">default_contexts</strong> exists. Each line in this file starts with the SELinux context information of the parent process and is then followed by an ordered list of all the contexts that could be picked based on the user's allowed SELinux role(s).</p>
			<p class="calibre3">Consider the following line of code for the <strong class="source-inline">sshd_t</strong> context:</p>
			<p class="source-code">system_r:sshd_t:s0	user_r:user_t:s0 \</p>
			<p class="source-code">                      staff_r:staff_t:s0 \</p>
			<p class="source-code">                      sysadm_r:sysadm_t:s0 \</p>
			<p class="source-code">                      unconfined_r:unconfined_t:s0</p>
			<p class="calibre3">This line of code mentions that when a user logs in through a process running in the <strong class="source-inline">sshd_t</strong> domain, the listed roles are checked against the roles of the user. The user will transition to the first context listed that matches the roles the user can use.</p>
			<p class="calibre3">For instance, assume we are mapped to an SELinux user that has access to both the <strong class="source-inline">staff_r</strong> and <strong class="source-inline">sysadm_r</strong> roles. In that case, we will log in as <strong class="source-inline">staff_r:staff_t</strong> since that is the first match.</p>
			<p class="calibre3">However, like the <strong class="source-inline">seusers</strong> file for the Linux account mappings, the <strong class="source-inline">default_contexts</strong> file is a default file that can be overruled through specific customizations. These customizations are stored in the <strong class="source-inline">/etc/selinux/targeted/contexts/users</strong> subdirectory. These files are named after the SELinux user for which they take effect. This allows us to assign different contexts for particular SELinux users even if they share the same roles with other SELinux users. Because SELinux checks the entries per line, we do not need to copy the entire content of the <strong class="source-inline">default_contexts</strong> file. Only the configuration lines that we want to see a different configuration for need to be listed; SELinux will automatically use the <strong class="source-inline">default_contexts</strong> file for the rest.</p>
			<p class="calibre3">Let's modify the default contexts so that the <strong class="source-inline">staff_u</strong> SELinux user logs in with the <strong class="source-inline">sysadm_r</strong> role (and with the <strong class="source-inline">sysadm_t</strong> type) when logged in through SSH. To do so, use the <strong class="source-inline">sshd_t</strong> line, modify it, and save the result as <strong class="source-inline">/etc/selinux/targeted/contexts/users/staff_u</strong>:</p>
			<p class="source-code">system_r:sshd_t:s0	sysadm_r:sysadm_t:s0</p>
			<p class="calibre3">Specifically, for the SSH daemon, we also need to enable the <strong class="source-inline">ssh_sysadm_login</strong> boolean, which is a special precaution SELinux policy developers have made to prevent users from immediately logging in with highly privileged accounts:</p>
			<p class="source-code"># setsebool ssh_sysadm_login on</p>
			<p class="calibre3">With these <a id="_idIndexMarker200" class="pcalibre calibre6 pcalibre1"/>settings in place, we've set <strong class="source-inline">sysadm_r:sysadm_t:s0</strong> as the only possible context, ensuring that the target context is <strong class="source-inline">staff_u:sysadm_r:sysadm_t</strong>.</p>
			<h2 id="_idParaDest-82" class="calibre10"><a id="_idTextAnchor083" class="pcalibre calibre6 pcalibre1"/>Validating contexts with getseuser</h2>
			<p class="calibre3">To validate <a id="_idIndexMarker201" class="pcalibre calibre6 pcalibre1"/>whether our change succeeded, we can ask SELinux what the result of a context choice will be without having to parse the files ourselves. We can accomplish this through the <strong class="source-inline">getseuser</strong> command, which takes two arguments: the Linux user account and the context of the process that switches the user context.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The <strong class="source-inline">getseuser</strong> command is a helper utility offered by the SELinux user space project, but is not made available on all distributions. You will find it on Debian and Gentoo, but not on CentOS or other Red Hat Enterprise Linux-derived distributions.</p>
			<p class="calibre3">Here's an example that checks what the context would be for the <strong class="source-inline">sven</strong> user when they log in through a process running in the <strong class="source-inline">sshd_t</strong> domain:</p>
			<p class="source-code"># getseuser sven system_u:system_r:sshd_t</p>
			<p class="source-code">seuser: user_u, level s0-s0</p>
			<p class="source-code">Context 0	user_u:user_r:user_t:s0</p>
			<p class="calibre3">One of the advantages of the <strong class="source-inline">getseuser</strong> command is that it asks the SELinux code what the context <a id="_idIndexMarker202" class="pcalibre calibre6 pcalibre1"/>should be, which not only looks through the <strong class="source-inline">default_contexts</strong> and customized files, but also checks whether the target context can be reached or not, and that there are no other constraints that prohibit the change to this context.</p>
			<h2 id="_idParaDest-83" class="calibre10"><a id="_idTextAnchor084" class="pcalibre calibre6 pcalibre1"/>Switching roles with newrole</h2>
			<p class="calibre3">After having <a id="_idIndexMarker203" class="pcalibre calibre6 pcalibre1"/>successfully authenticated and logged in, users will be assigned the context through the configuration mentioned in the <em class="italic">SELinux users and roles</em> section. If the SELinux user has access to multiple roles, however, then the Linux user can use the <strong class="source-inline">newrole</strong> application to transition from one role to another.</p>
			<p class="calibre3">Consider an SELinux system without unconfined domains and where we are, by default, logged in as the <strong class="source-inline">staff_r</strong> role. To perform administrative tasks, we need to switch to the <strong class="source-inline">sysadm_r</strong> administrative role, which we can do with the <strong class="source-inline">newrole</strong> command. This command only works when working through a secure terminal listed in <strong class="source-inline">/etc/securetty</strong>:</p>
			<p class="source-code">$ id -Z</p>
			<p class="source-code">staff_u:staff_r:staff_t:s0</p>
			<p class="source-code">$ newrole -r sysadm_r</p>
			<p class="source-code">Password: (Enter user password)</p>
			<p class="source-code">$ id -Z</p>
			<p class="source-code">staff_u:sysadm_r:sysadm_t:s0</p>
			<p class="calibre3">Notice how the SELinux user remains constant but the role and domain have changed.</p>
			<p class="calibre3">The <strong class="source-inline">newrole</strong> command can also be used to transition to a specific sensitivity, as follows:</p>
			<p class="source-code">$ newrole -l s0-s0:c0.c100</p>
			<p class="calibre3">When we <em class="italic">switch</em> to another role or sensitivity, what we actually do is create a new session (with a new shell) that has this new role or sensitivity. The command does not change the context of the current session, nor does it exit from the current session.</p>
			<p class="calibre3">We can return from our assigned role and go back to the first session by exiting (through <strong class="source-inline">exit</strong>, <strong class="source-inline">logout</strong>, or <em class="italic">Ctrl</em> + <em class="italic">D</em>).</p>
			<h2 id="_idParaDest-84" class="calibre10"><a id="_idTextAnchor085" class="pcalibre calibre6 pcalibre1"/>Managing role access through sudo</h2>
			<p class="calibre3">Most administrators use <strong class="source-inline">sudo</strong> for privilege delegation: allowing users to run certain commands <a id="_idIndexMarker204" class="pcalibre calibre6 pcalibre1"/>in a more privileged context than the user is otherwise allowed. The <strong class="source-inline">sudo</strong> application is also capable of switching SELinux roles and types.</p>
			<p class="calibre3">We can pass the target role and type to <strong class="source-inline">sudo</strong> directly. For instance, we can tell <strong class="source-inline">sudo</strong> to switch to the administrative role when we edit a PostgreSQL configuration file:</p>
			<p class="source-code">$ sudo -r sysadm_r -t sysadm_t vim /var/lib/pgsql/data/pg_hba.conf</p>
			<p class="calibre3">However, we can also configure <strong class="source-inline">sudo</strong> through the <strong class="source-inline">/etc/sudoers</strong> file to allow users to run commands within a certain role and/or type, or get a shell within a certain context. Consider a user that has access to both the <strong class="source-inline">user_r</strong> and <strong class="source-inline">dbadm_r</strong> roles (with the <strong class="source-inline">dbadm_r</strong> role being a role designated for database administrators). Within the <strong class="source-inline">sudoers</strong> file, the following line allows the <strong class="source-inline">myuser</strong> user to run any command through <strong class="source-inline">sudo,</strong> which, when triggered, will run with the <strong class="source-inline">dbadm_r</strong> role and within the <strong class="source-inline">dbadm_t</strong> domain:</p>
			<p class="source-code">myuser ALL=(ALL) TYPE=sysadm_t ROLE=sysadm_r ALL</p>
			<p class="calibre3">Often, administrators will prefer <strong class="source-inline">sudo</strong> over <strong class="source-inline">newrole</strong> as the latter does not change the effective user ID, which is often required for end users when they want to invoke a more privileged command (concerning the root user or a service-specific runtime account) anyway. The <strong class="source-inline">sudo</strong> application also has great logging capabilities, and we can even have commands switching roles without requiring the end user to explicitly mention the target role and type. Sadly, it does not support changing sensitivities.</p>
			<h2 id="_idParaDest-85" class="calibre10"><a id="_idTextAnchor086" class="pcalibre calibre6 pcalibre1"/>Reaching other domains using runcon</h2>
			<p class="calibre3">Another <a id="_idIndexMarker205" class="pcalibre calibre6 pcalibre1"/>application that can switch roles and sensitivities is the <strong class="source-inline">runcon</strong> application. The <strong class="source-inline">runcon</strong> command is available for all users and is used to launch a specific command as a different role, type, and/or sensitivity. It even supports changing the SELinux user – assuming the SELinux policy lets you.</p>
			<p class="calibre3">The <strong class="source-inline">runcon</strong> command does not have its own domain – it runs in the context of the user executing the command. As such, the privileges of the user domain itself govern the ability to change the role, type, sensitivity, or even SELinux user.</p>
			<p class="calibre3">Most of the time, we will use <strong class="source-inline">runcon</strong> to launch applications with a particular category. This allows <a id="_idIndexMarker206" class="pcalibre calibre6 pcalibre1"/>us to take advantage of the MCS approach in SELinux without requiring applications to be MCS-enabled:</p>
			<p class="source-code">$ runcon -l Salaries bash</p>
			<p class="source-code">$ id -Z</p>
			<p class="source-code">unconfined_u:unconfined_r:unconfined_t:Salaries</p>
			<p class="calibre3">For instance, in the previous example, we run a shell session with the <strong class="source-inline">Salaries</strong> category (prohibiting it from accessing resources that do not have the same or fewer categories set).</p>
			<h2 id="_idParaDest-86" class="calibre10"><a id="_idTextAnchor087" class="pcalibre calibre6 pcalibre1"/>Switching to the system role</h2>
			<p class="calibre3">Sometimes, administrators will need to invoke applications that should not run under their current SELinux <a id="_idIndexMarker207" class="pcalibre calibre6 pcalibre1"/>user context but instead as the <strong class="source-inline">system_u</strong> SELinux user with the <strong class="source-inline">system_r</strong> SELinux role. SELinux policy administrators acknowledge this need, and allow a <em class="italic">very</em> limited set of domains to switch the SELinux user to a different user – perhaps contrary to the purpose of the immutability of SELinux users mentioned earlier. Yet, as there are cases where this is needed, SELinux needs to accommodate this. One of the applications allowed to switch the SELinux user is <strong class="source-inline">run_init</strong> (through its <strong class="source-inline">run_init_t</strong> domain).</p>
			<p class="calibre3">The <strong class="source-inline">run_init</strong> application is mainly (almost exclusively) used to start background system services on a Linux system. Using this application, the daemons do not run under the user's SELinux context but the system's, as required by SELinux policies.</p>
			<p class="calibre3">As this is only needed on systems where launching additional services is done through service scripts, distributions that use <strong class="source-inline">systemd</strong> do not require the use of <strong class="source-inline">run_init</strong>. <strong class="source-inline">systemd</strong> already runs with the <strong class="source-inline">system_r</strong> role and is responsible for starting additional services. As such, no role transition is needed. Other <strong class="source-inline">init</strong> systems, such as Gentoo's OpenRC, integrate <strong class="source-inline">run_init</strong> so that administrators do not generally need to invoke <strong class="source-inline">run_init</strong> manually.</p>
			<p class="calibre3">Most SELinux policies enable role-managed support for selective service management (for non <strong class="source-inline">systemd</strong> distributions). This allows users that do not have complete system administration rights to still manipulate a select number of services on a Linux system, allowed by the SELinux policy. These users are to be granted the <strong class="source-inline">system_r</strong> role, but once accomplished, they do not need to call <strong class="source-inline">run_init</strong> to manipulate specific services anymore. The transitions happen automatically and only for the services assigned to the user – other services cannot be launched by these users.</p>
			<p class="calibre3">This finalizes <a id="_idIndexMarker208" class="pcalibre calibre6 pcalibre1"/>our section on handling SELinux roles. We've learned how to manage SELinux roles and switching roles and contexts, as well as how to define the target role and type in the case of privilege escalation. In the last section of this chapter, we will look at how PAM is used to configure the SELinux context setup on the system.</p>
			<h1 id="_idParaDest-87" class="calibre5"><a id="_idTextAnchor088" class="pcalibre calibre6 pcalibre1"/>SELinux and PAM</h1>
			<p class="calibre3">With all <a id="_idIndexMarker209" class="pcalibre calibre6 pcalibre1"/>the information about SELinux users and roles, we have not touched upon how <a id="_idIndexMarker210" class="pcalibre calibre6 pcalibre1"/>exactly applications or services create and assign an SELinux context to a user. As mentioned earlier on, this is coordinated through the use of Linux's PAM services.</p>
			<h2 id="_idParaDest-88" class="calibre10"><a id="_idTextAnchor089" class="pcalibre calibre6 pcalibre1"/>Assigning contexts through PAM</h2>
			<p class="calibre3">End users <a id="_idIndexMarker211" class="pcalibre calibre6 pcalibre1"/>log in to a Linux system through either a login process (triggered through a <strong class="source-inline">getty</strong> process), a networked service (for example, the OpenSSH daemon), or through a graphical login manager (<strong class="source-inline">xdm</strong>, <strong class="source-inline">kdm</strong>, <strong class="source-inline">gdm</strong>, <strong class="source-inline">slim</strong>, and so on).</p>
			<p class="calibre3">These services are responsible for switching our effective user ID (upon successful authentication, of course) so that we are not active on the system as the <strong class="source-inline">root</strong> user. For SELinux systems, these processes also need to switch the SELinux user (and role) accordingly, as otherwise, the context will be inherited from the service, which is obviously wrong for any interactive session.</p>
			<p class="calibre3">In theory, all these applications can be made fully SELinux aware, linking with the SELinux user space libraries to get information about Linux mappings and SELinux users. Instead of converting all these applications, the developers decided to take the authentication route to the next level using the PAM services that Linux systems provide.</p>
			<p class="calibre3">PAM offers a very flexible interface for handling different authentication methods on Linux (and Unix) systems. All applications mentioned earlier use PAM for their authentication steps. To enable SELinux support for these applications, we need to update their PAM configuration files to include the <strong class="source-inline">pam_selinux.so</strong> library.</p>
			<p class="calibre3">The following code listing is an excerpt from CentOS's <strong class="source-inline">/etc/pam.d/remote</strong> file, limited to PAM's session service directives. It triggers the <strong class="source-inline">pam_selinux.so</strong> library code as part of the authentication process, as follows:</p>
			<p class="source-code">session	required	pam_selinux.so close</p>
			<p class="source-code">session	required	pam_loginuid.so</p>
			<p class="source-code">session	required	pam_selinux.so open</p>
			<p class="source-code">session	required	pam_namespace.so</p>
			<p class="source-code">session	optional	pam_keyinit.so force revoke</p>
			<p class="source-code">session	include	password-auth</p>
			<p class="source-code">session	include	postlogin</p>
			<p class="calibre3">The arguments <a id="_idIndexMarker212" class="pcalibre calibre6 pcalibre1"/>supported by the <strong class="source-inline">pam_selinux.so</strong> code are described in the <strong class="source-inline">pam_selinux</strong> manual page. In the preceding example, the <strong class="source-inline">close</strong> option clears the current context (if any), whereas the <strong class="source-inline">open</strong> option sets the context of the user. The <strong class="source-inline">pam_selinux</strong> module takes care of querying the SELinux configuration and finding the right mappings and context based on the service name used by the daemon.</p>
			<h2 id="_idParaDest-89" class="calibre10"><a id="_idTextAnchor090" class="pcalibre calibre6 pcalibre1"/>Prohibiting access during permissive mode</h2>
			<p class="calibre3">Having SELinux active and enforcing on a system improves its resilience against successful exploits <a id="_idIndexMarker213" class="pcalibre calibre6 pcalibre1"/>and other malicious activities, especially when the system is used as a shell server (or provides other interactive services) and the users are confined – meaning they are mapped to <strong class="source-inline">user_u</strong> or other confined SELinux users.</p>
			<p class="calibre3">Some administrators might want to temporarily switch the system to permissive mode. This could be to troubleshoot issues or to support some changes made on the system. When using permissive mode, it would be a good idea to ensure that the interactive services are not usable for regular users.</p>
			<p class="calibre3">With <strong class="source-inline">pam_sepermit</strong>, this can be enforced on the system. The PAM module will deny a set of defined users access to the system if the system is in permissive mode. By default, these users are mentioned in <strong class="source-inline">/etc/security/sepermit.conf</strong>, but a different file can be configured through the <strong class="source-inline">conf=</strong> option inside the PAM configuration itself.</p>
			<p class="calibre3">In the <strong class="source-inline">sepermit.conf</strong> file, there are three approaches to document which users should be denied access when the system is in permissive mode:</p>
			<ul class="calibre8">
				<li class="calibre9">Regular usernames</li>
				<li class="calibre9">Group names, prefixed with the <strong class="source-inline">@</strong> sign</li>
				<li class="calibre9">SELinux usernames, prefixed with the <strong class="source-inline">%</strong> sign</li>
			</ul>
			<p class="calibre3">Within this file, we list each user, group, or SELinux user on a single line. After each entry, we can (but don't have to) add one or two options:</p>
			<ul class="calibre8">
				<li class="calibre9"><strong class="source-inline">exclusive</strong> means that the system will allow the user to be active even when the system is in permissive mode, but only a single session can be active. When the user logs out, all active processes will be killed.</li>
				<li class="calibre9"><strong class="source-inline">ignore</strong> will return <strong class="source-inline">PAM_IGNORE</strong> as the return status if SELinux is in enforcing mode, and <strong class="source-inline">PAM_AUTH_ERR</strong> if SELinux is in permissive mode. This allows special constructs/branches for this user in PAM based on the permissive state of the system.</li>
			</ul>
			<p class="calibre3">To <a id="_idIndexMarker214" class="pcalibre calibre6 pcalibre1"/>enable <strong class="source-inline">pam_sepermit</strong>, it's sufficient to enable the module in the auth PAM service as follows:</p>
			<p class="source-code">auth	required	pam_sepermit.so</p>
			<p class="calibre3">Of course, don't forget to remove all active user sessions when switching to permissive mode, as any running session is otherwise left untouched.</p>
			<h2 id="_idParaDest-90" class="calibre10"><a id="_idTextAnchor091" class="pcalibre calibre6 pcalibre1"/>Polyinstantiating directories</h2>
			<p class="calibre3">The last PAM module we'll look at is <strong class="source-inline">pam_namespace.so</strong>. Before we dive into configuring this <a id="_idIndexMarker215" class="pcalibre calibre6 pcalibre1"/>module, let's first look at what polyinstantiation is about.</p>
			<p class="calibre3"><strong class="bold">Polyinstantiation</strong> is an <a id="_idIndexMarker216" class="pcalibre calibre6 pcalibre1"/>approach where, when a user logs in to a system, the user gets a view on filesystem resources specific to its session, while optionally hiding the resources of other users. This differs from regular access controls, where the other resources are still visible, but might just be inaccessible.</p>
			<p class="calibre3">This session-specific view, however, does not just use regular mounts. The module uses the Linux kernel namespace technology to force a (potentially more limited) view on the filesystem, isolated and specific to the user session. Other users have a different view on the filesystem.</p>
			<p class="calibre3">Let's use a common example. Assume that all users, except <strong class="source-inline">root</strong>, should not have access to the temporary files generated by other users. With standard access controls, these resources would still be visible (perhaps not readable, but their existence or the directories they reside in would be visible). Instead, with polyinstantiation, a user will only see their own <strong class="source-inline">/tmp</strong> and <strong class="source-inline">/var/tmp</strong> views.</p>
			<p class="calibre3">The following setting in <strong class="source-inline">/etc/security/namespace.conf</strong> will remap these two locations:</p>
			<p class="source-code">/tmp		/tmp/tmp-inst/		level	root</p>
			<p class="source-code">/var/tmp	/var/tmp/tmp-inst/	level	root</p>
			<p class="calibre3">On the real filesystem, those locations will be remapped to a subdirectory inside <strong class="source-inline">/tmp/tmp-inst</strong> and <strong class="source-inline">/var/tmp/tmp-inst</strong>. The end users do not know or see the remapped locations – for them, <strong class="source-inline">/tmp</strong> and <strong class="source-inline">/var/tmp</strong> are as they would expect.</p>
			<p class="calibre3">The format (and thus polyinstantiation) of the subdirectories created depends on the third option within the <strong class="source-inline">namespace.conf</strong> file. The supported options are as follows:</p>
			<ul class="calibre8">
				<li class="calibre9"><strong class="source-inline">user</strong>, which will create a subdirectory named after the user (such as <strong class="source-inline">lisa</strong>)</li>
				<li class="calibre9"><strong class="source-inline">level</strong>, which will create a subdirectory named after the user sensitivity level and username (such as <strong class="source-inline">system_u:object_r:tmp_t:s0-s0:c0.c1023_lisa</strong>)</li>
				<li class="calibre9"><strong class="source-inline">context</strong>, which will create a subdirectory named after the process context (including the sensitivity level) and username (such as <strong class="source-inline">system_u:object_r:user_tmp_t:s0_lisa</strong>)</li>
			</ul>
			<p class="calibre3">For <a id="_idIndexMarker217" class="pcalibre calibre6 pcalibre1"/>SELinux systems, the most common setting is <strong class="source-inline">level</strong>.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">In the default <strong class="source-inline">namespace.conf</strong> file, you might notice that this also has support for home directories. When enabled with the <strong class="source-inline">level</strong> or <strong class="source-inline">context</strong> method, this will ensure that users have a sensitivity-specific home directory set. For instance, if the system configuration forces the user to have a lower sensitivity when logged in through SSH than when the user logs in through the terminal, a different home directory view will be used.</p>
			<p class="calibre3">In the previous example, only the root user is exempt from these namespace changes. Additional users can be listed (comma-separated), or an explicit list of users can be given for which polyinstantiation needs to be enabled (if we prefix the user list with the <strong class="source-inline">~</strong> character). To allow the namespace changes to take place, the target locations need to be available on the system with the <strong class="source-inline">000</strong> permission:</p>
			<p class="source-code"># mkdir /tmp-inst &amp;&amp; chmod 000 /tmp-inst</p>
			<p class="calibre3">Next, enable <strong class="source-inline">pam_namespace.so</strong> in the PAM configuration files at the session service:</p>
			<p class="source-code">session	required	pam_namespace.so</p>
			<p class="calibre3">Finally, make sure that SELinux allows polyinstantiated directories. On CentOS, this is governed through the <strong class="source-inline">polyinstantiation_enabled</strong> SELinux boolean:</p>
			<p class="source-code"># setsebool polyinstantiation_enabled on</p>
			<p class="calibre3">Other distributions will have it through the <strong class="source-inline">allow_polyinstantiation</strong> SELinux boolean.</p>
			<p class="calibre3">With the <a id="_idIndexMarker218" class="pcalibre calibre6 pcalibre1"/>polyinstantiation support, we close off this final section of the chapter, where we learned how PAM is used to trigger SELinux context changes on the system.</p>
			<h1 id="_idParaDest-91" class="calibre5"><a id="_idTextAnchor092" class="pcalibre calibre6 pcalibre1"/>Summary</h1>
			<p class="calibre3">SELinux maps Linux users onto SELinux users and defines the roles a user can be assigned through the SELinux user definitions. We learned how to manage those mappings and SELinux users with the <strong class="source-inline">semanage</strong> application, and how to grant the right roles to the right people.</p>
			<p class="calibre3">We also saw how the same commands are used to grant the proper sensitivity to the user and how we can describe these levels in the <strong class="source-inline">setrans.conf</strong> file. We used the <strong class="source-inline">chcat</strong> tool to do most of the category-related management activities.</p>
			<p class="calibre3">After assigning roles to the users, we saw how to jump from one role to another using <strong class="source-inline">newrole</strong>, <strong class="source-inline">sudo</strong>, <strong class="source-inline">runcon</strong>, and <strong class="source-inline">run_init</strong>. We ended this chapter with important insights into how SELinux is integrated into the Linux authentication process and how to tune a Linux system further using a couple of SELinux-aware PAM modules.</p>
			<p class="calibre3">In the next chapter, we will learn to manage the labels on files and processes, and see how we can query the SELinux policy rules.</p>
			<h1 id="_idParaDest-92" class="calibre5"><a id="_idTextAnchor093" class="pcalibre calibre6 pcalibre1"/>Questions</h1>
			<ol class="calibre18">
				<li class="calibre9">Why can't we just add an SELinux role to a Linux account?</li>
				<li class="calibre9">Can Linux accounts be mapped to more than one SELinux user?</li>
				<li class="calibre9">Besides associating the valid SELinux roles, what other advantages does an SELinux user have?</li>
				<li class="calibre9">What purpose does PAM have when dealing with Linux accounts and SELinux mappings?</li>
			</ol>
		</div>
		<div class="calibre2">
			<div id="_idContainer015" class="calibre13">
			</div>
		</div>
	</div></body></html>