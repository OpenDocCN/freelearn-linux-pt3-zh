<html><head></head><body>
<div id="_idContainer182">
<h1 class="chapter-number" id="_idParaDest-131"><a id="_idTextAnchor154"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-132"><a id="_idTextAnchor155"/><span class="koboSpan" id="kobo.2.1">Eliminating All the SPOFs! </span><span class="koboSpan" id="kobo.2.2">An Exercise in Redundancy</span></h1>
<p><span class="koboSpan" id="kobo.3.1">It’s crucial to have redundancy</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.4.1"> in your architecture to ensure smooth operations. </span><span class="koboSpan" id="kobo.4.2">Eliminating </span><strong class="bold"><span class="koboSpan" id="kobo.5.1">Single Points of Failure</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.7.1">SPOFs</span></strong><span class="koboSpan" id="kobo.8.1">) is a common way to achieve this. </span><span class="koboSpan" id="kobo.8.2">Implementing </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">High-Availability</span></strong><span class="koboSpan" id="kobo.10.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.11.1">HA</span></strong><span class="koboSpan" id="kobo.12.1">) technology is one way to eliminate</span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.13.1"> SPOFs. </span><span class="koboSpan" id="kobo.13.2">HA technology is crucial because it helps businesses maintain operational continuity, enhance performance, improve reliability, facilitate </span><strong class="bold"><span class="koboSpan" id="kobo.14.1">Disaster Recovery</span></strong><span class="koboSpan" id="kobo.15.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.16.1">DR</span></strong><span class="koboSpan" id="kobo.17.1">), build customer trust, and comply with regulations. </span><span class="koboSpan" id="kobo.17.2">With HA </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.18.1">technology, minimizing downtime and ensuring continuous service availability is possible, contributing to overall success and competitiveness in today’s </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">technology-driven world.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.20.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.21.1">What about DR? </span><span class="koboSpan" id="kobo.21.2">We are not covering the failure of data centers in this chapter. </span><span class="koboSpan" id="kobo.21.3">That being said, the approach to implementing DR is very different than HA. </span><span class="koboSpan" id="kobo.21.4">When running in the cloud, look for services such as Oracle Full Stack Disaster Recovery Service that automate the DR process for the entire </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">tech stack.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">The recipes in this chapter will help you eliminate SPOFs in your environment. </span><span class="koboSpan" id="kobo.23.2">We’ll start with a general overview of what HA is, as well as availability, and then get into several examples of how you can add redundancy to your application. </span><span class="koboSpan" id="kobo.23.3">The four most common technologies that are used to help eliminated SPOFs in applications are HAProxy, Corosync, Pacemaker, and GlusterFS. </span><span class="koboSpan" id="kobo.23.4">Each of these provides a specific set of features to help make an application </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">highly available:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.25.1">HAProxy</span></strong><span class="koboSpan" id="kobo.26.1">: This is a load balancer, and allows</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.27.1"> you to balance web workloads </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">between servers</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.29.1">Corosync</span></strong><span class="koboSpan" id="kobo.30.1">: This is a communication system</span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.31.1"> that enables communication to help implement HA </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">within applications</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.33.1">Pacemaker</span></strong><span class="koboSpan" id="kobo.34.1">: Pacemaker is an open source resource</span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.35.1"> manager that is used to build small and </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">large clusters</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.37.1">GlusterFS</span></strong><span class="koboSpan" id="kobo.38.1">: This is a scalable network filesystem</span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.39.1"> that allows multiple nodes to read and write data to the same storage at the </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">same time</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.41.1">The following recipes will help you implement these common HA technologies. </span><span class="koboSpan" id="kobo.41.2">This includes everything from load-balancing applications and clustering application systems to clustered storage and </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">redundant networking:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.43.1">Getting 99.999% availability </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">and beyond</span></span></li>
<li><span class="koboSpan" id="kobo.45.1">Load balancing </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">a w</span><a id="_idTextAnchor156"/><span class="koboSpan" id="kobo.47.1">ebsite</span></span></li>
<li><span class="koboSpan" id="kobo.48.1">Making HAProxy highly available </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">with Keepalived</span></span></li>
<li><span class="koboSpan" id="kobo.50.1">HA clustering for al</span><a id="_idTextAnchor157"/><a id="_idTextAnchor158"/><span class="koboSpan" id="kobo.51.1">l with Corosync </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">and Pacemaker</span></span></li>
<li><span class="koboSpan" id="kobo.53.1">Sharing a filesystem across multiple machines – cluster </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">or distribute?</span></span></li>
<li><span class="koboSpan" id="kobo.55.1">Generating, configuring, and monitoring Ethernet traffic </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">over bond</span></span></li>
</ul>
<h1 id="_idParaDest-133"><a id="_idTextAnchor159"/><span class="koboSpan" id="kobo.57.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.58.1">For most of these recipes, you will need a pair of Oracle Linux 8 systems. </span><span class="koboSpan" id="kobo.58.2">As with most of these recipes, a VM on your desktop using a desktop virtualization product such as Oracle VirtualBox is recommended. </span><span class="koboSpan" id="kobo.58.3">A small VM is fine, with two cores, 2 GB RAM, and a few free gigabytes of disk space. </span><span class="koboSpan" id="kobo.58.4">You will also need some additional disks assigned to the VM, ideally at least five equally sized disks. </span><span class="koboSpan" id="kobo.58.5">Before you start, patch your system to the latest packages available. </span><span class="koboSpan" id="kobo.58.6">This only takes a few minutes and can save a ton of time when troubleshooting issues that are caused by </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">a bug.</span></span></p>
<p><span class="koboSpan" id="kobo.60.1">Many of the recipes in this book have their related configuration files available on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">at </span></span><a href="https://github.com/PacktPublishing/Oracle-Linux-Cookbook"><span class="No-Break"><span class="koboSpan" id="kobo.62.1">https://github.com/PacktPublishing/Oracle-Linux-Cookbook</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.63.1">.</span></span></p>
<h1 id="_idParaDest-134"><a id="_idTextAnchor160"/><span class="koboSpan" id="kobo.64.1">Getting 99.999% availability and beyond</span></h1>
<p><span class="koboSpan" id="kobo.65.1">This recipe will discuss the differences between DR and HA and how to architect HA solutions. </span><span class="koboSpan" id="kobo.65.2">Before we get into that, let’s refine the definition of a few </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">key terms:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.67.1">High availability</span></strong><span class="koboSpan" id="kobo.68.1">, or </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">HA</span></strong><span class="koboSpan" id="kobo.70.1">: This means protecting from the failure</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.71.1"> of a single component. </span><span class="koboSpan" id="kobo.71.2">Think of this as protecting against the failure of </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">a system.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.73.1">Disaster recovery</span></strong><span class="koboSpan" id="kobo.74.1">, or </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">DR</span></strong><span class="koboSpan" id="kobo.76.1">: This is the failure of the data center</span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.77.1"> or </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">cloud region.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.79.1">Availability nines</span></strong><span class="koboSpan" id="kobo.80.1">: When referring to </span><em class="italic"><span class="koboSpan" id="kobo.81.1">nines of availability</span></em><span class="koboSpan" id="kobo.82.1">, it is a way to quantify the uptime</span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.83.1"> or reliability of a system by specifying the number of nines</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.84.1"> in the uptime percentage. </span><span class="koboSpan" id="kobo.84.2">Each </span><em class="italic"><span class="koboSpan" id="kobo.85.1">nine</span></em><span class="koboSpan" id="kobo.86.1"> represents a decimal place in the </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">uptime percentage.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.88.1">Here’s a breakdown of the most commonly used </span><em class="italic"><span class="koboSpan" id="kobo.89.1">nines</span></em><span class="koboSpan" id="kobo.90.1"> and their corresponding uptime percentages, assuming </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">24x7x365 operations:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-6">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.92.1">Nines</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.93.1">Downtime </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.94.1">per Year</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.95.1">Downtime </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.96.1">per Month</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.97.1">99</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.98.1">3d 14h </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">56m 18s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.100.1">7h </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">14m 41s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.102.1">99.9</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.103.1">8h </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">41m 38s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.105.1">43m 28s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.106.1">99.99</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.107.1">52m 10s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.108.1">4m 21s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.109.1">99.999</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.110.1">5m 13s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.111.1">26s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.112.1">99.9999</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.113.1">31s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.114.1">2.6s</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.115.1">Table 6.1 – Nines downtime</span></p>
<p><span class="koboSpan" id="kobo.116.1">In the preceding table, each additional nine in the uptime percentage signifies a higher level of availability and a reduced tolerance for downtime. </span><span class="koboSpan" id="kobo.116.2">Achieving higher numbers of nines typically requires implementing redundant systems, failover mechanisms, and rigorous maintenance practices to minimize downtime and ensure continuous operation. </span><span class="koboSpan" id="kobo.116.3">In addition, when setting up a </span><strong class="bold"><span class="koboSpan" id="kobo.117.1">Service-Level Agreement</span></strong><span class="koboSpan" id="kobo.118.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.119.1">SLA</span></strong><span class="koboSpan" id="kobo.120.1">), you can also define the uptime during business hours and exclude</span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.121.1"> scheduled maintenance. </span><span class="koboSpan" id="kobo.121.2">As an example, using a working schedule of Monday through Friday with 12 working hours a day, and 10 holidays off per year, the matrix would look </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">very different!</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-3">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.123.1">Nines</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.124.1">Downtime </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.125.1">per Year</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.126.1">Downtime </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.127.1">per Month</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.128.1">99</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.129.1">1d 7h </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">2m 58s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.131.1">2h </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">35m 14s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.133.1">99.9</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.134.1">3h </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">6m 18s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.136.1">15m 31s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.137.1">99.99</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.138.1">18m 38s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.139.1">1m 33s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.140.1">99.999</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.141.1">1m 52s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.142.1">9s</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.143.1">99.9999</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.144.1">11s</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.145.1">1s</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.146.1">Table 6.2 – Business hours downtime</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.147.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.148.1">When setting SLAs with the business, carefully understand the differences between including maintenance windows and operational hours within </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">the SLA.</span></span></p>
<h2 id="_idParaDest-135"><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.150.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.151.1">When designing HA systems, there are several considerations that need to be taken into account to ensure the system is resilient and can handle failures. </span><span class="koboSpan" id="kobo.151.2">Here are some </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">key considerations:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.153.1">Redundancy</span></strong><span class="koboSpan" id="kobo.154.1">: Having redundancy in HA systems is essential. </span><span class="koboSpan" id="kobo.154.2">It requires replicating components</span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.155.1"> or whole systems to eliminate potential SPOFs. </span><span class="koboSpan" id="kobo.155.2">Redundancy can be implemented at different levels, such as hardware, software, and network infrastructure. </span><span class="koboSpan" id="kobo.155.3">To minimize the impact of localized failures, it’s crucial to distribute redundant components across different </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">physical locations.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.157.1">Failover and load balancing</span></strong><span class="koboSpan" id="kobo.158.1">: It is important for HA systems to be equipped with failover mechanisms that enable automatic switching</span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.159.1"> to a backup system whenever a failure occurs. </span><span class="koboSpan" id="kobo.159.2">One way to achieve this is through replicating data and services across multiple servers, coupled with the use of load-balancing techniques that ensure the even distribution of workload. </span><span class="koboSpan" id="kobo.159.3">With load balancing, traffic can be easily redirected to available servers in the event of a </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">server failure.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.161.1">Scalability</span></strong><span class="koboSpan" id="kobo.162.1">: When designing HA systems, it is important to ensure that they can handle increased workloads and scale effortlessly. </span><span class="koboSpan" id="kobo.162.2">This can be achieved through horizontal scaling, which entails adding more servers to distribute the load, or vertical scaling, which involves adding resources to existing servers. </span><span class="koboSpan" id="kobo.162.3">Additionally, the system should be capable of dynamically adjusting resource allocation based on demand to </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">prevent overloading.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.164.1">Data replication and backup</span></strong><span class="koboSpan" id="kobo.165.1">: Maintaining data integrity and availability is crucial for HA systems. </span><span class="koboSpan" id="kobo.165.2">To ensure that data can still be accessed in case of a system failure, it is essential to replicate data across multiple storage systems or databases. </span><span class="koboSpan" id="kobo.165.3">Additionally, performing regular backups is vital to safeguard against potential data loss </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">or corruption.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.167.1">Fault tolerance</span></strong><span class="koboSpan" id="kobo.168.1">: Systems used for highly available architectures should have fault tolerance, which means they must be able to function even if specific components or subsystems malfunction. </span><span class="koboSpan" id="kobo.168.2">Achieving this requires creating a system that can manage errors with ease, recover automatically, and ensure continuity </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">of service.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.170.1">Disaster recovery</span></strong><span class="koboSpan" id="kobo.171.1">: Having a DR plan is crucial for HA systems to effectively deal with catastrophic events such as natural disasters or widespread outages. </span><span class="koboSpan" id="kobo.171.2">This plan entails generating off-site backups, setting up secondary data centers, and relying on cloud-based services to guarantee business continuity, even amid </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">extreme situations.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.173.1">Documentation and testing</span></strong><span class="koboSpan" id="kobo.174.1">: It is crucial to document the system architecture, configurations, and procedures to effectively troubleshoot and maintain the HA system. </span><span class="koboSpan" id="kobo.174.2">Regular testing, such as failover tests, load testing, and DR drills, plays a significant role in identifying potential issues and ensuring the system operates as intended in </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">various scenarios.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.176.1">Cost and complexity</span></strong><span class="koboSpan" id="kobo.177.1">: Designing, implementing, and maintaining HA systems can be both complex and costly. </span><span class="koboSpan" id="kobo.177.2">It is important to carefully consider the available budget, as well as the expertise and resources required to effectively manage</span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.178.1"> and monitor </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">the system.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.180.1">By addressing these considerations, you can design a robust and resilient HA system that ensures HA, fault tolerance, and continuity of </span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">critical services.</span></span></p>
<h2 id="_idParaDest-136"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.182.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.183.1">As a rule, you should pick the right technology for the right subsystem </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">and application.</span></span></p>
<p><span class="koboSpan" id="kobo.185.1">When aiming to achieve HA</span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.186.1"> for a web application, the first step is to place a load balancer in front of the web servers. </span><span class="koboSpan" id="kobo.186.2">This enables scaling of the application while also offering some fault tolerance for these systems. </span><span class="koboSpan" id="kobo.186.3">However, attention should also be given to the data tier, which can be addressed by clustering the database or building a cluster capable of running the database, depending on the limitations of the </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">database technology.</span></span></p>
<p><span class="koboSpan" id="kobo.188.1">If you are utilizing a technology</span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.189.1"> such as Oracle Database, you have the option to establish a database-specific cluster known as </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">Oracle Real Application Clusters</span></strong><span class="koboSpan" id="kobo.191.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.192.1">Oracle RAC</span></strong><span class="koboSpan" id="kobo.193.1">). </span><span class="koboSpan" id="kobo.193.2">This cluster allows for both scalability and availability. </span><span class="koboSpan" id="kobo.193.3">With RAC, the database remains accessible for queries as long as one node is online. </span><span class="koboSpan" id="kobo.193.4">While other databases may utilize their own exclusive clustering technology (such as MySQL Cluster), you may opt to utilize generic cluster technologies such as Pacemaker for cluster management and Corosync for inter-cluster communications. </span><span class="koboSpan" id="kobo.193.5">This approach presents the advantage of enabling almost any technology to be made highly available in a </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">Linux environment.</span></span></p>
<p><span class="koboSpan" id="kobo.195.1">You can achieve HA in storage</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.196.1"> by implementing filesystems across the entire cluster. </span><span class="koboSpan" id="kobo.196.2">Gluster allows you to mount a filesystem across multiple servers, while at the same time replicating the storage across servers. </span><span class="koboSpan" id="kobo.196.3">This provides both scalability and reliability at the </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">filesystem level.</span></span></p>
<p><span class="koboSpan" id="kobo.198.1">Finally, the network</span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.199.1"> is a common point of failure, and using network bonding technologies can enable both HA as well as some scaling abilities. </span><span class="koboSpan" id="kobo.199.2">This works by combining at least two network ports into a single </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">virtual port.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.201.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.202.1">The best HA architectures mix these approaches to cover the entire </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">technology stack.</span></span></p>
<h1 id="_idParaDest-137"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.204.1">Load balancing a website</span></h1>
<p><span class="koboSpan" id="kobo.205.1">Nowadays, most applications</span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.206.1"> are web-based, whether it’s a traditional web interface or a RESTful API. </span><span class="koboSpan" id="kobo.206.2">This first tier is typically set up for HA using a load balancer. </span><span class="koboSpan" id="kobo.206.3">A load balancer is a system </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.207.1">that distributes incoming network traffic or workload across multiple servers or resources. </span><span class="koboSpan" id="kobo.207.2">Its main goal is to optimize resource utilization, improve performance, and ensure the reliability and availability of applications or services. </span><span class="koboSpan" id="kobo.207.3">When multiple servers are involved in serving a particular application or service, a load balancer acts as an intermediary between the client and the server pool. </span><span class="koboSpan" id="kobo.207.4">It receives incoming requests from clients and intelligently distributes them across the available servers based on various algorithms, such as round-robin, least connections, or </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">weighted distribution.</span></span></p>
<p><span class="koboSpan" id="kobo.209.1">The load balancer is responsible for ensuring the servers’ optimal health and performance by redirecting traffic from overloaded or problematic servers. </span><span class="koboSpan" id="kobo.209.2">This distribution of workloads helps to prevent any one server from getting overwhelmed, thus enhancing response time and overall system capacity </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">and scalability.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.211.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.212.1">While a load balancer can help distribute the workloads, the actual server load is based on other factors, so do not expect all servers to have the same utilization of CPU, RAM, networking, and </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.214.1">Load balancers </span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.215.1">not only distribute traffic but also offer advanced features, such as SSL termination, session persistence, caching, and content routing. </span><span class="koboSpan" id="kobo.215.2">They are extensively used in web applications, cloud-based services, and other environments that demand HA </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">and scalability.</span></span></p>
<p><span class="koboSpan" id="kobo.217.1">One of the most popular load balancers </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">is HAProxy.</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">HAProxy is a great open source load-balancer option. </span><span class="koboSpan" id="kobo.219.2">Standing for </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">High Availability Proxy</span></strong><span class="koboSpan" id="kobo.221.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.222.1">HAProxy</span></strong><span class="koboSpan" id="kobo.223.1"> is widely used due to its excellent performance</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.224.1"> and ability to improve the availability and scalability of applications. </span><span class="koboSpan" id="kobo.224.2">Operating at the application layer (Layer 7) of the OSI model, this software is able to make routing decisions based on specific application-level information, such as HTTP headers and cookies. </span><span class="koboSpan" id="kobo.224.3">Compared</span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.225.1"> to traditional network-level (Layer 4) load balancers, HAProxy allows for more advanced load-balancing and </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">traffic-routing capabilities.</span></span></p>
<p><span class="koboSpan" id="kobo.227.1">Some key features</span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.228.1"> and capabilities</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.229.1"> of HAProxy include </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.231.1">Load balancing</span></strong><span class="koboSpan" id="kobo.232.1">: With HAProxy, incoming traffic can be evenly distributed across multiple servers using various algorithms, such as round-robin, least connections, and source IP, </span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">among others.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.234.1">High availability</span></strong><span class="koboSpan" id="kobo.235.1">: One of the beneficial features of HAProxy is its ability to support active-passive failover setups. </span><span class="koboSpan" id="kobo.235.2">In the event the active server becomes unavailable, a standby server will take over. </span><span class="koboSpan" id="kobo.235.3">Additionally, it also has the capability to monitor the health of servers and make automatic adjustments to the load-balancing pool by adding or </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">removing servers.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.237.1">Proxying</span></strong><span class="koboSpan" id="kobo.238.1">: One of HAProxy’s primary functions is to act as a reverse proxy, which involves receiving client requests and directing them to the correct backend servers. </span><span class="koboSpan" id="kobo.238.2">Additionally, it can function as a forward proxy by intercepting client requests and directing them to </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">external servers.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.240.1">SSL/TLS termination</span></strong><span class="koboSpan" id="kobo.241.1">: With HAProxy, SSL/TLS encryption and decryption can be efficiently managed, taking the load off of the </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">backend servers.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.243.1">Session persistence</span></strong><span class="koboSpan" id="kobo.244.1">: HAProxy is capable of preserving session affinity by routing follow-up requests from a client to the same backend server, thus guaranteeing the proper operation of </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">session-based applications.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.246.1">Health checks and monitoring</span></strong><span class="koboSpan" id="kobo.247.1">: To guarantee the availability and optimal performance of backend servers, HAProxy conducts routine health checks. </span><span class="koboSpan" id="kobo.247.2">It has the ability to identify failed servers and promptly exclude them from the </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">load-balancing pool.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.249.1">Logging and statistics</span></strong><span class="koboSpan" id="kobo.250.1">: With HAProxy, administrators can effectively monitor and analyze traffic patterns, performance metrics, and error conditions. </span><span class="koboSpan" id="kobo.250.2">Its detailed logging</span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.251.1"> and statistics feature makes</span><a id="_idIndexMarker472"/> <span class="No-Break"><span class="koboSpan" id="kobo.252.1">this possible.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.253.1">HAProxy can be deployed</span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.254.1"> on various operating systems and is often used in high-traffic web</span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.255.1"> environments, cloud infrastructure, and containerized deployments. </span><span class="koboSpan" id="kobo.255.2">Its versatility and extensive feature set make it a powerful tool for managing and optimizing application traffic and open source-based </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">load balancers.</span></span></p>
<p><span class="koboSpan" id="kobo.257.1">For this recipe, we will put HAProxy on one system (as the load balancer) and then two identical web servers to balance </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">traffic to:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.259.1"><img alt="Figure 6.1 – HAProxy example diagram" src="image/B18349_06_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.260.1">Figure 6.1 – HAProxy example diagram</span></p>
<h2 id="_idParaDest-138"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.261.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.262.1">To get started, we first need three servers. </span><span class="koboSpan" id="kobo.262.2">For this exercise, we will call them </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">lb1</span></strong><span class="koboSpan" id="kobo.264.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">web1</span></strong><span class="koboSpan" id="kobo.266.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">web2</span></strong><span class="koboSpan" id="kobo.268.1">. </span><span class="koboSpan" id="kobo.268.2">They are identical systems, each with 8 GB RAM, 4 vCPUs, and 100 GB of drive space. </span><span class="koboSpan" id="kobo.268.3">The filesystems have 50 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">/</span></strong><span class="koboSpan" id="kobo.270.1">, 5 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">/home</span></strong><span class="koboSpan" id="kobo.272.1">, and 8 GB in swap. </span><span class="koboSpan" id="kobo.272.2">The remaining disk space is unallocated. </span><span class="koboSpan" id="kobo.272.3">You will also need the IP address for each host. </span><span class="koboSpan" id="kobo.272.4">In this example, the following IP addresses </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">were used:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-2">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.274.1">Host</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.275.1">IP</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.276.1">Web1</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">192.168.56.200</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.278.1">Web2</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">192.168.56.201</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.280.1">Lb1</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">192.168.56.202</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.282.1">Table 6.3 – HAProxy IP addresses</span></p>
<p><span class="koboSpan" id="kobo.283.1">Once the server is built, patch it to the current software with the </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.285.1">
dnf update -y</span></pre> <p><span class="koboSpan" id="kobo.286.1">Once the software is patched, reboot</span><a id="_idIndexMarker475"/> <span class="No-Break"><span class="koboSpan" id="kobo.287.1">the systems.</span></span></p>
<h3><span class="koboSpan" id="kobo.288.1">Web servers</span></h3>
<p><span class="koboSpan" id="kobo.289.1">For both web servers, we will install Apache, using</span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.290.1"> the following commands as the </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">root user:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.292.1">
dnf install httpd -y</span></pre> <p><span class="koboSpan" id="kobo.293.1">We next need to enable port </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">80</span></strong><span class="koboSpan" id="kobo.295.1"> to pass through the firewall, with the </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.297.1">
firewall-cmd --permanent --add-service=http; firewall-cmd --reload</span></pre> <p><span class="koboSpan" id="kobo.298.1">We then need to start the server and make it start on boot. </span><span class="koboSpan" id="kobo.298.2">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.299.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.300.1">
systemctl enable --now httpd</span></pre> <p><span class="koboSpan" id="kobo.301.1">We now need to put in a basic home page for </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">this server.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.303.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.304.1">Depending on your environment, you may need to edit the Apache config file in </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">/etc/httpd/conf/httpd.conf</span></strong><span class="koboSpan" id="kobo.306.1"> to specify your </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">servername</span></strong><span class="koboSpan" id="kobo.308.1">. </span><span class="koboSpan" id="kobo.308.2">In the config file, it will be a single entry on a single line, like </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">the following:</span></span></p>
<p class="callout"><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.310.1">ServerName server.m57.local:80</span></strong></span></p>
<p><span class="koboSpan" id="kobo.311.1">This needs to go into </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">/var/www/html/index.html</span></strong><span class="koboSpan" id="kobo.313.1">. </span><span class="koboSpan" id="kobo.313.2">The following is an example file. </span><span class="koboSpan" id="kobo.313.3">Adjust the text as needed</span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.314.1"> so each server is unique. </span><span class="koboSpan" id="kobo.314.2">This way, you can see what server is </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">being hit:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.316.1">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
&lt;h1&gt; Running on web1&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</span></pre> <p><span class="koboSpan" id="kobo.317.1">Next, point your browser to the system to </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">test it:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.319.1"><img alt="Figure 6.2 – Simple website" src="image/B18349_06_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.320.1">Figure 6.2 – Simple website</span></p>
<p><span class="koboSpan" id="kobo.321.1">Next, repeat the process on the other web server. </span><span class="koboSpan" id="kobo.321.2">Once that system is up, we will set up the </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">load balancer.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.323.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.324.1">If you are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">httpd</span></strong><span class="koboSpan" id="kobo.326.1"> (TLS/SSL) on your server, don’t forget to enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">https</span></strong><span class="koboSpan" id="kobo.328.1"> in your local firewalls </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">as well.</span></span></p>
<h3><span class="koboSpan" id="kobo.330.1">Load balancer</span></h3>
<p><span class="koboSpan" id="kobo.331.1">For the single load-balancer</span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.332.1"> system, we will need to install HAProxy. </span><span class="koboSpan" id="kobo.332.2">This is done using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">dnf</span></strong><span class="koboSpan" id="kobo.334.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">as root:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.336.1">
dnf install -y haproxy</span></pre> <p><span class="koboSpan" id="kobo.337.1">We next need to open up port </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">80</span></strong><span class="koboSpan" id="kobo.339.1"> in the firewall with the </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">following comman</span><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.341.1">d:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.342.1">
firewall-cmd --permanent --add-service=http; firewall-cmd --reload</span></pre> <p><span class="koboSpan" id="kobo.343.1">Next, we will need to edit the config file. </span><span class="koboSpan" id="kobo.343.2">The config file is located </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">/etc/haproxy/haproxy.cfg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.347.1">The config file has two main sections, </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">global</span></strong><span class="koboSpan" id="kobo.349.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">defaults</span></strong><span class="koboSpan" id="kobo.351.1">. </span><span class="koboSpan" id="kobo.351.2">There can only be a single </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">global</span></strong><span class="koboSpan" id="kobo.353.1"> section in the config file. </span><span class="koboSpan" id="kobo.353.2">This is where TLS/SSL config data, the logging configuration, and the user and group settings go for the user running </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">haproxy</span></strong><span class="koboSpan" id="kobo.355.1">. </span><span class="koboSpan" id="kobo.355.2">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">haproxy</span></strong><span class="koboSpan" id="kobo.357.1"> runs as the user haproxy with the group </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">haproxy</span></strong><span class="koboSpan" id="kobo.359.1">. </span><span class="koboSpan" id="kobo.359.2">For most use cases, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">global</span></strong><span class="koboSpan" id="kobo.361.1"> section should not need</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.362.1"> to be changed. </span><span class="koboSpan" id="kobo.362.2">An example is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.364.1"><img alt="Figure 6.3 – HAProxy global settings" src="image/B18349_06_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.365.1">Figure 6.3 – HAProxy global settings</span></p>
<p><span class="koboSpan" id="kobo.366.1">The next section, called the </span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">defaults</span></strong><span class="koboSpan" id="kobo.368.1"> section, is where you will make most of your edits. </span><span class="koboSpan" id="kobo.368.2">This is built using three subsections: </span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">frontend</span></strong><span class="koboSpan" id="kobo.370.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">backend</span></strong><span class="koboSpan" id="kobo.372.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">listen</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.376.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">frontend</span></strong><span class="koboSpan" id="kobo.378.1"> section listens</span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.379.1"> on all IP addresses and ports that are defined. </span><span class="koboSpan" id="kobo.379.2">This is what users will connect to. </span><span class="koboSpan" id="kobo.379.3">A HAProxy server can have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">frontend</span></strong><span class="koboSpan" id="kobo.381.1"> sections, though each one needs a unique name and </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">IP/port combination.</span></span></p>
<p><span class="koboSpan" id="kobo.383.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">backend</span></strong><span class="koboSpan" id="kobo.385.1"> section defines the servers being load balanced to, defining the load-balancing method as well as the servers and ports where traffic is being sent to. </span><span class="koboSpan" id="kobo.385.2">A HAProxy server can have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">backend</span></strong><span class="koboSpan" id="kobo.387.1"> sections, though each one needs a </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">unique name.</span></span></p>
<p><span class="koboSpan" id="kobo.389.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">listen</span></strong><span class="koboSpan" id="kobo.391.1"> section is used to define how you can monitor the load balancer, with the port, URI, and authentication information needed to monitor HAProxy. </span><span class="koboSpan" id="kobo.391.2">Normally, you will only have one </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">listen</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.393.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.394.1">For the same frontend, we will be listening on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">80</span></strong><span class="koboSpan" id="kobo.396.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">lb1</span></strong><span class="koboSpan" id="kobo.398.1"> system, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">www_app</span></strong><span class="koboSpan" id="kobo.400.1">, and will define this IP/port combination to use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">www_servers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1"> backend.</span></span></p>
<h4><span class="koboSpan" id="kobo.403.1">frontend</span></h4>
<p><span class="koboSpan" id="kobo.404.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">frontend</span></strong><span class="koboSpan" id="kobo.406.1"> section of the HAProxy configuration file </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.407.1">offers various options to manage incoming traffic behavior. </span><span class="koboSpan" id="kobo.407.2">These options can be used to control the traffic on a frontend. </span><span class="koboSpan" id="kobo.407.3">Here are some commonly used </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">frontend options:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">bind</span></strong><span class="koboSpan" id="kobo.410.1">: Defines the IP address and port on which the frontend will listen for incoming traffic. </span><span class="koboSpan" id="kobo.410.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">bind *:80</span></strong><span class="koboSpan" id="kobo.412.1"> listens on all IP addresses on </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">80</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">mode</span></strong><span class="koboSpan" id="kobo.417.1">: Specifies the mode of the frontend, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">http</span></strong><span class="koboSpan" id="kobo.419.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">tcp</span></strong><span class="koboSpan" id="kobo.421.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">ssl</span></strong><span class="koboSpan" id="kobo.423.1">. </span><span class="koboSpan" id="kobo.423.2">For HTTP traffic, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">mode http</span></strong><span class="koboSpan" id="kobo.425.1">. </span><span class="koboSpan" id="kobo.425.2">If you want to load balance a generic TCP port, use </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">mode tcp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">option</span></strong><span class="koboSpan" id="kobo.429.1">: Enables or disables specific options for the frontend. </span><span class="koboSpan" id="kobo.429.2">Some commonly used options are </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">as follows:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">option httplog</span></strong><span class="koboSpan" id="kobo.432.1">: Enables HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">request/response logging</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">option dontlognull</span></strong><span class="koboSpan" id="kobo.435.1">: Prevents logging of requests with missing or empty </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">user-agent strings</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">option forwardfor</span></strong><span class="koboSpan" id="kobo.438.1">: Adds the client’s IP address to the HTTP request headers when using HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.439.1">proxy mode</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">option http-server-close</span></strong><span class="koboSpan" id="kobo.441.1">: Forces the server connection to close after processing a request, rather than </span><span class="No-Break"><span class="koboSpan" id="kobo.442.1">using keep-alive</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">timeout</span></strong><span class="koboSpan" id="kobo.444.1">: Configures various timeouts for </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">the frontend:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">timeout client</span></strong><span class="koboSpan" id="kobo.447.1">: Sets the maximum allowed time for the client to establish a connection and </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">send data</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">timeout server</span></strong><span class="koboSpan" id="kobo.450.1">: Sets the maximum allowed time for the server to respond to </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">a request</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">timeout connect</span></strong><span class="koboSpan" id="kobo.453.1">: Sets the maximum time to wait for a connection to the </span><span class="No-Break"><span class="koboSpan" id="kobo.454.1">backend server</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">acl</span></strong><span class="koboSpan" id="kobo.456.1">: Defines rules for matching specific conditions. </span><span class="koboSpan" id="kobo.456.2">ACLs are used in conjunction with backend configurations to control traffic routing based on </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">various criteria.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">use_backend</span></strong><span class="koboSpan" id="kobo.459.1">: Specifies which backend to use for handling traffic that matches specific ACL conditions. </span><span class="koboSpan" id="kobo.459.2">It allows you to direct traffic to different backend servers based on </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">certain conditions.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">default_backend</span></strong><span class="koboSpan" id="kobo.462.1">: Defines the default backend to use if no ACL conditions match the </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">incoming traffic.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">redirect</span></strong><span class="koboSpan" id="kobo.465.1">: Performs a URL redirection for specific conditions. </span><span class="koboSpan" id="kobo.465.2">For example, you can use the </span><a href="https://example.com"><span class="koboSpan" id="kobo.466.1">https://example.com</span></a><span class="koboSpan" id="kobo.467.1"> redirect location to redirect HTTP traffic </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">to HTTPS.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">http-request</span></strong><span class="koboSpan" id="kobo.470.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">http-response</span></strong><span class="koboSpan" id="kobo.472.1">: These are used to add custom HTTP request/response headers or to perform specific actions based on HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">request/response data.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">capture</span></strong><span class="koboSpan" id="kobo.475.1">: Captures parts of the request or response headers and saves them </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">into variables.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.477.1">For the sample frontend, we will define the frontend as </span><strong class="source-inline"><span class="koboSpan" id="kobo.478.1">www_app</span></strong><span class="koboSpan" id="kobo.479.1"> binding to all IPs on the load-balancer system on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">80</span></strong><span class="koboSpan" id="kobo.481.1">. </span><span class="koboSpan" id="kobo.481.2">This looks</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.482.1"> like the </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.484.1"><img alt="Figure 6.4 – Example frontend" src="image/B18349_06_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.485.1">Figure 6.4 – Example frontend</span></p>
<h4><span class="koboSpan" id="kobo.486.1">backend</span></h4>
<p><span class="koboSpan" id="kobo.487.1">When using HAProxy, the backend </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.488.1">options play a crucial role in configuring the behavior of backend servers and the routing of traffic toward them. </span><span class="koboSpan" id="kobo.488.2">These options are specifically designated within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">backend</span></strong><span class="koboSpan" id="kobo.490.1"> section of the HAProxy configuration file. </span><span class="koboSpan" id="kobo.490.2">Here are some frequently utilized </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">backend options:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">mode</span></strong><span class="koboSpan" id="kobo.493.1">: Specifies the mode of the backend, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">http</span></strong><span class="koboSpan" id="kobo.495.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">tcp</span></strong><span class="koboSpan" id="kobo.497.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">ssl</span></strong><span class="koboSpan" id="kobo.499.1">. </span><span class="koboSpan" id="kobo.499.2">For HTTP traffic, use </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">http</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1"> mode.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">balance</span></strong><span class="koboSpan" id="kobo.503.1">: Defines the load-balancing algorithm to distribute traffic across backend servers. </span><span class="koboSpan" id="kobo.503.2">Common options include </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">the following:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">balance roundrobin</span></strong><span class="koboSpan" id="kobo.506.1">: Requests are distributed in a round-robin fashion to each server </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">in sequence</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">balance leastconn</span></strong><span class="koboSpan" id="kobo.509.1">: Traffic is sent to the server with the lowest number of </span><span class="No-Break"><span class="koboSpan" id="kobo.510.1">active connections</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">balance source</span></strong><span class="koboSpan" id="kobo.512.1">: Based on a hash of the client’s IP address, traffic is directed to a specific </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">server consistently</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">server</span></strong><span class="koboSpan" id="kobo.515.1">: Defines the backend servers</span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.516.1"> and their addresses, ports, and </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">optional parameters.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">timeout</span></strong><span class="koboSpan" id="kobo.519.1">: Configures various timeouts for </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">the backend:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">timeout server</span></strong><span class="koboSpan" id="kobo.522.1">: Sets the maximum allowed time for the server to respond to </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">a request</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">timeout tunnel</span></strong><span class="koboSpan" id="kobo.525.1">: Configures the maximum time allowed to establish a tunnel (used in </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">TCP mode)</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">http-request</span></strong><span class="koboSpan" id="kobo.528.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">http-response</span></strong><span class="koboSpan" id="kobo.530.1">: Similar to frontend options, these are used to add custom HTTP request/response headers or perform specific actions based on HTTP </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">request/response data.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">cookie</span></strong><span class="koboSpan" id="kobo.533.1">: Configures sticky session persistence using cookies. </span><span class="koboSpan" id="kobo.533.2">It allows the backend server to be selected based on a specific cookie value from </span><span class="No-Break"><span class="koboSpan" id="kobo.534.1">the client.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">check</span></strong><span class="koboSpan" id="kobo.536.1">: Enables health checks for backend servers to determine their availability. </span><span class="koboSpan" id="kobo.536.2">If a server fails the health check, HAProxy will stop sending traffic to it until </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">it recovers.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">option</span></strong><span class="koboSpan" id="kobo.539.1">: Enables or disables specific options for the backend. </span><span class="koboSpan" id="kobo.539.2">Some commonly used options include </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">the following:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">option httpchk</span></strong><span class="koboSpan" id="kobo.542.1">: Enables HTTP health checks instead of TCP </span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">health checks</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">option redispatch</span></strong><span class="koboSpan" id="kobo.545.1">: Allows HAProxy to reselect a server if the connection to the selected </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">server fails</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">errorfile</span></strong><span class="koboSpan" id="kobo.548.1">: Specifies a file to use as a custom error page for backend </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">server errors.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.550.1">In the sample backend, it is defined as </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">www_servers</span></strong><span class="koboSpan" id="kobo.552.1"> and will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">roundrobin</span></strong><span class="koboSpan" id="kobo.554.1"> load balancing against</span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.555.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">web1</span></strong><span class="koboSpan" id="kobo.557.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">web2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.559.1"> servers:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.560.1"><img alt="Figure 6.5 – HAProxy sample backend" src="image/B18349_06_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.561.1">Figure 6.5 – HAProxy sample backend</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.562.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.563.1">It is highly recommended to always use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">check</span></strong><span class="koboSpan" id="kobo.565.1"> option for your servers. </span><span class="koboSpan" id="kobo.565.2">If you do not run the checks, the system will still send traffic to </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">the server!</span></span></p>
<h4><span class="koboSpan" id="kobo.567.1">listen</span></h4>
<p><span class="koboSpan" id="kobo.568.1">In HAProxy, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">listen</span></strong><span class="koboSpan" id="kobo.570.1"> section is used to define a frontend</span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.571.1"> and backend configuration together in one block, making it a convenient way to combine both. </span><span class="koboSpan" id="kobo.571.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">listen</span></strong><span class="koboSpan" id="kobo.573.1"> section allows you to define options specific to the listening socket and how the incoming traffic is handled. </span><span class="koboSpan" id="kobo.573.2">The following are some commonly used options in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">listen</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.575.1"> section:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">bind</span></strong><span class="koboSpan" id="kobo.577.1">: Defines the IP address and port on which HAProxy will listen for incoming traffic. </span><span class="koboSpan" id="kobo.577.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">bind *:80</span></strong><span class="koboSpan" id="kobo.579.1"> listens on all IP addresses on </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">80</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">stats</span></strong><span class="koboSpan" id="kobo.584.1">: Enables the HAProxy statistics page for monitoring and </span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">managing HAProxy.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">stats enable</span></strong><span class="koboSpan" id="kobo.587.1">: Enables statistics monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">for HAProxy.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">stats uri</span></strong><span class="koboSpan" id="kobo.590.1">: Specifies the URI path for accessing the statistics page. </span><span class="koboSpan" id="kobo.590.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">stats uri /haproxy_stats</span></strong><span class="koboSpan" id="kobo.592.1"> sets the statistics page to be accessible </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">http://your-haproxy-ip/haproxy_stats</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.595.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">stats realm</span></strong><span class="koboSpan" id="kobo.597.1">: Sets the realm (authentication realm) for HTTP basic authentication when accessing the statistics page. </span><span class="koboSpan" id="kobo.597.2">This adds a layer of security to prevent </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">unauthorized access.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">stats auth</span></strong><span class="koboSpan" id="kobo.600.1">: Configures the username</span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.601.1"> and password for HTTP basic authentication when accessing the statistics page. </span><span class="koboSpan" id="kobo.601.2">The format is </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">stats </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">auth username:password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">stats hide-version</span></strong><span class="koboSpan" id="kobo.606.1">: Hides the HAProxy version number from the statistics page to </span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">enhance security.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">stats show-node</span></strong><span class="koboSpan" id="kobo.609.1">: Displays the server node names on the statistics page. </span><span class="koboSpan" id="kobo.609.2">This is useful when using dynamic </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">server templates.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">stats refresh</span></strong><span class="koboSpan" id="kobo.612.1">: Sets the interval (in milliseconds) for automatic refresh of the statistics page. </span><span class="koboSpan" id="kobo.612.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">stats refresh 10s</span></strong><span class="koboSpan" id="kobo.614.1"> refreshes the page every </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">10 seconds.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.616.1">stats admin</span></strong><span class="koboSpan" id="kobo.617.1">: Specifies the IP address and port for allowing administrative access to HAProxy statistics. </span><span class="koboSpan" id="kobo.617.2">It allows remote management of HAProxy using the statistics page. </span><span class="koboSpan" id="kobo.617.3">For example, stats admin if </span><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">localhost</span></strong><span class="koboSpan" id="kobo.619.1"> permits access only from the </span><span class="No-Break"><span class="koboSpan" id="kobo.620.1">local machine.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">stats maxconn</span></strong><span class="koboSpan" id="kobo.622.1">: Limits the number of connections allowed to the statistics page. </span><span class="koboSpan" id="kobo.622.2">It helps to prevent overload and potential </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">denial-of-service attacks.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">errorfile</span></strong><span class="koboSpan" id="kobo.625.1">: Specifies a file to use as a custom error page for </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">frontend errors.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.627.1">For the sample </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">listen</span></strong><span class="koboSpan" id="kobo.629.1"> section, we will define it as metrics, allowing admin access from </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">192.168.56.1</span></strong><span class="koboSpan" id="kobo.631.1">. </span><span class="koboSpan" id="kobo.631.2">The user will use the username as </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">admin</span></strong><span class="koboSpan" id="kobo.633.1"> and the password </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">passw0rd</span></strong><span class="koboSpan" id="kobo.635.1"> to log in. </span><span class="koboSpan" id="kobo.635.2">This is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.637.1"><img alt="Figure 6.6 – HAProxy listen sample" src="image/B18349_06_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.638.1">Figure 6.6 – HAProxy listen sample</span></p>
<p><span class="koboSpan" id="kobo.639.1">Since the status page is running on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">8080</span></strong><span class="koboSpan" id="kobo.641.1">, don’t forget to add the port to the firewall and reload the firewall. </span><span class="koboSpan" id="kobo.641.2">This can be done</span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.642.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">following </span><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.644.1">command;</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.645.1">
firewall-cmd --permanent --add-port=8080/tcp; firewall-cmd --reload</span></pre> <h2 id="_idParaDest-139"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.646.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.647.1">Now that we have our two web</span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.648.1"> servers, and the load balancer configured, we need to start the load balancer. </span><span class="koboSpan" id="kobo.648.2">This is done </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">systemctl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.652.1">Use the following to </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">start HAProxy:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.654.1">systemctl start haproxy</span></strong></pre></li> <li><span class="koboSpan" id="kobo.655.1">Use the following to check </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">the status:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.657.1">systemctl status haproxy</span></strong></pre></li> <li><span class="koboSpan" id="kobo.658.1">If you edit the config file, do not forget to reload HAProxy with the </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.660.1">systemctl reload haproxy</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.661.1">Now, point your browser to the load </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.662.1">balancer IP. </span><span class="koboSpan" id="kobo.662.2">You will get the web server page. </span><span class="koboSpan" id="kobo.662.3">This is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.664.1"><img alt="Figure 6.7 – Working HAProxy" src="image/B18349_06_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.665.1">Figure 6.7 – Working HAProxy</span></p>
<p><span class="koboSpan" id="kobo.666.1">Since the rule is </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">roundrobin</span></strong><span class="koboSpan" id="kobo.668.1">, and we configured</span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.669.1"> the timeout at one minute, wait a minute and then reload the page. </span><span class="koboSpan" id="kobo.669.2">You will see a </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">new server.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.671.1"><img alt="Figure 6.8 – Working load balancing" src="image/B18349_06_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.672.1">Figure 6.8 – Working load balancing</span></p>
<p><span class="koboSpan" id="kobo.673.1">As an admin, you will also want to check on the health of your resources. </span><span class="koboSpan" id="kobo.673.2">Point your browser to the stats URL, and enter the username and password configured. </span><span class="koboSpan" id="kobo.673.3">This will show the stats page. </span><span class="koboSpan" id="kobo.673.4">In the case of this example, the URL is </span><a href="http://lb1.m57.local:8080/stats"><span class="koboSpan" id="kobo.674.1">http://lb1.m57.local:8080/stats</span></a><span class="koboSpan" id="kobo.675.1">. </span><span class="koboSpan" id="kobo.675.2">You will see a sample</span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.676.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.678.1"><img alt=" Figure 6.9 – HAProxy status page" src="image/B18349_06_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.679.1"> Figure 6.9 – HAProxy status page</span></p>
<p><span class="koboSpan" id="kobo.680.1">On the sample page, you will see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">web1</span></strong><span class="koboSpan" id="kobo.682.1"> is offline. </span><span class="koboSpan" id="kobo.682.2">You can also</span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.683.1"> see how much traffic each frontend and backend rule has processed, and to </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">what servers.</span></span></p>
<h1 id="_idParaDest-140"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.685.1">Making HAProxy highly available with Keepalived</span></h1>
<p><span class="koboSpan" id="kobo.686.1">In the previous recipe, we used HAProxy</span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.687.1"> to give our web servers</span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.688.1"> some redundancy. </span><span class="koboSpan" id="kobo.688.2">The challenge with that solution is we now have a failure point in the load balancer itself. </span><span class="koboSpan" id="kobo.688.3">When architecting for HA, you need to cover all points of failure to make sure there is redundancy and that there is no SPOF. </span><span class="koboSpan" id="kobo.688.4">In this recipe, we will use Keepalived to add some HA to our configuration. </span><span class="koboSpan" id="kobo.688.5">Keepalived is a software application that is open source and designed for Linux-based systems. </span><span class="koboSpan" id="kobo.688.6">Its main function is to manage network load balancing and failover, ensuring the HA of web services. </span><span class="koboSpan" id="kobo.688.7">Keepalived</span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.689.1"> is often used alongside HAProxy. </span><span class="koboSpan" id="kobo.689.2">The software primarily uses the </span><strong class="bold"><span class="koboSpan" id="kobo.690.1">Virtual Router Redundancy Protocol</span></strong><span class="koboSpan" id="kobo.691.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.692.1">VRRP</span></strong><span class="koboSpan" id="kobo.693.1">) to achieve fault tolerance and evenly distribute the load. </span><span class="koboSpan" id="kobo.693.2">Keepalived uses the following features to provide </span><span class="No-Break"><span class="koboSpan" id="kobo.694.1">its redundancy:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.695.1">High availability</span></strong><span class="koboSpan" id="kobo.696.1">: With Keepalived, you can establish a cluster</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.697.1"> of backup servers that utilize a shared </span><strong class="bold"><span class="koboSpan" id="kobo.698.1">Virtual IP</span></strong><span class="koboSpan" id="kobo.699.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.700.1">VIP</span></strong><span class="koboSpan" id="kobo.701.1">) address. </span><span class="koboSpan" id="kobo.701.2">This setup ensures</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.702.1"> that even if the primary server experiences a failure, a secondary server will automatically take over and handle incoming traffic, resulting in </span><span class="No-Break"><span class="koboSpan" id="kobo.703.1">minimal downtime.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.704.1">VRRP</span></strong><span class="koboSpan" id="kobo.705.1">: VRRP is a commonly used protocol</span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.706.1"> that enables automatic router failover in IP networks. </span><span class="koboSpan" id="kobo.706.2">Keepalived utilizes VRRP to keep a VIP address operational, which can be assigned to any node within the cluster </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">as needed.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.708.1">Health checking</span></strong><span class="koboSpan" id="kobo.709.1">: The monitoring system of Keepalived regularly checks the health of active servers. </span><span class="koboSpan" id="kobo.709.2">If a server becomes unresponsive, Keepalived will remove it from the pool and redirect traffic to the </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">healthy servers.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.711.1">Notification mechanisms</span></strong><span class="koboSpan" id="kobo.712.1">: With Keepalived, it’s possible to set up notifications for failover events or when certain thresholds are exceeded. </span><span class="koboSpan" id="kobo.712.2">These notifications are useful</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.713.1"> for keeping an eye on the overall health of </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">the cluster.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.715.1">In a cluster, Keepalived designates</span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.716.1"> one node as the master</span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.717.1"> and the others as backups. </span><span class="koboSpan" id="kobo.717.2">The master node handles incoming traffic and responds to ARP requests for the VIP address, while the backups act as standby routers and monitor the master’s status. </span><span class="koboSpan" id="kobo.717.3">The nodes communicate using the VRRP protocol, with the master periodically sending VRRP advertisements to show its functioning. </span><span class="koboSpan" id="kobo.717.4">Often, a VIP is used to allow a single IP address for end user access. </span><span class="koboSpan" id="kobo.717.5">This normal operation is seen in the following figure, where we have Keepalived managing two </span><span class="No-Break"><span class="koboSpan" id="kobo.718.1">HAProxy systems.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.719.1"><img alt="Figure 6.10 – Keepalived normal operations" src="image/B18349_06_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.720.1">Figure 6.10 – Keepalived normal operations</span></p>
<p><span class="koboSpan" id="kobo.721.1">If the backups stop receiving</span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.722.1"> advertisements or detect any issues</span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.723.1"> with the master, one backup node will take over as the new master. </span><span class="koboSpan" id="kobo.723.2">Keepalived checks the servers’ health using mechanisms such as ICMP (ping) checks or Layer 4 checks (e.g., checking whether a specific port is open) and removes failed servers from the pool. </span><span class="koboSpan" id="kobo.723.3">The VRRP priority is adjusted to ensure a healthy backup server takes over. </span><span class="koboSpan" id="kobo.723.4">This is seen in the following figure, where the VIP that users connect to has migrated over to the second node, and that node is now using HAProxy to manage </span><span class="No-Break"><span class="koboSpan" id="kobo.724.1">the workload.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.725.1"><img alt="Figure 6.11 – Keepalived failed node" src="image/B18349_06_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.726.1">Figure 6.11 – Keepalived failed node</span></p>
<h2 id="_idParaDest-141"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.727.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.728.1">This recipe expands upon</span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.729.1"> the previous one, adding a second load-balancer</span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.730.1"> system and a VIP. </span><span class="koboSpan" id="kobo.730.2">You will need to build the second load balancer and acquire an additional IP address for the VIP. </span><span class="koboSpan" id="kobo.730.3">Your IPs should be similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.731.1">the following:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table004-1">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.732.1">Host</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.733.1">IP</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.734.1">web1</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">192.168.56.200</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.736.1">web2</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">192.168.56.201</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.738.1">lb1</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">192.168.56.202</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.740.1">lb2</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">192.168.56.203</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.742.1">vip</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">192.168.56.204</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.744.1">Table 6.4 – Keepalived IP addresses</span></p>
<h2 id="_idParaDest-142"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.745.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.746.1">Before you start configuring Keepalived, you need</span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.747.1"> to configure HAProxy on the second server. </span><span class="koboSpan" id="kobo.747.2">You can easily </span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.748.1">install HAProxy, open up the firewall ports, and copy over the config file from the </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">existing system.</span></span></p>
<p><span class="koboSpan" id="kobo.750.1">You can test this by simply pointing your browser to the second load balancer and seeing the </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">app server.</span></span></p>
<p><span class="koboSpan" id="kobo.752.1">Next, we will start to </span><span class="No-Break"><span class="koboSpan" id="kobo.753.1">configure Keepalived.</span></span></p>
<p><span class="koboSpan" id="kobo.754.1">For each load balancer, you will need to install Keepalived as the </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">root user:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.756.1">
dnf -y install keepalived</span></pre> <p><span class="koboSpan" id="kobo.757.1">Next, we will need to edit the Keepalived config file. </span><span class="koboSpan" id="kobo.757.2">This is found in </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">/etc/keepalived/keepalived.conf</span></strong><span class="koboSpan" id="kobo.759.1">. </span><span class="koboSpan" id="kobo.759.2">There are two major sections to edit, </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">global_defs</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.761.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">vrpp_instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.763.1">.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">global_defs</span></strong><span class="koboSpan" id="kobo.765.1"> is the global definition used by Keepalived. </span><span class="koboSpan" id="kobo.765.2">These settings are used by all </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">vrrp_instance</span></strong><span class="koboSpan" id="kobo.767.1"> types configured in </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">the system.</span></span></p>
<p><span class="koboSpan" id="kobo.769.1">There are several parameters that you will need </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">to update:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">notification_email</span></strong><span class="koboSpan" id="kobo.772.1">: This is a list of email addresses that will be emailed when there is </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">an event</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">notification_email_from_user</span></strong><span class="koboSpan" id="kobo.775.1">: This is the sending </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">email address</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">smtp_server</span></strong><span class="koboSpan" id="kobo.778.1">: This is the SMTP </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">relay server</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">router_id</span></strong><span class="koboSpan" id="kobo.781.1">: This is a unique name for this </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">Keepalived cluster</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.783.1">For the sample, this section looks like </span><span class="No-Break"><span class="koboSpan" id="kobo.784.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<span class="koboSpan" id="kobo.785.1"><img alt="Figure 6.12 – Keepalived globals" src="image/B18349_06_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.786.1">Figure 6.12 – Keepalived globals</span></p>
<p><span class="koboSpan" id="kobo.787.1">The next section is </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">vrrp_instance</span></strong><span class="koboSpan" id="kobo.789.1">. </span><span class="koboSpan" id="kobo.789.2">You can have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">vrrp_instance</span></strong><span class="koboSpan" id="kobo.791.1"> types in the cluster, each supporting </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">different VIPs.</span></span></p>
<p><span class="koboSpan" id="kobo.793.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">vrrp_instance</span></strong><span class="koboSpan" id="kobo.795.1">, you need to give each one</span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.796.1"> a unique name. </span><span class="koboSpan" id="kobo.796.2">Additionally, there are several parameters</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.797.1"> that will need to </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">be updated:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">state</span></strong><span class="koboSpan" id="kobo.800.1">: The state of the instance, usually master for the primary node and backup for the </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1">secondary node.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.802.1">interface</span></strong><span class="koboSpan" id="kobo.803.1">: The Ethernet interface used for this host in </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">the cluster.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">virtual_router_id</span></strong><span class="koboSpan" id="kobo.806.1">: A unique number for this instance. </span><span class="koboSpan" id="kobo.806.2">No other instances should use the </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">same ID.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">authentication</span></strong><span class="koboSpan" id="kobo.809.1">: This section defines how members </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">are authenticated:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.811.1">auth_type</span></strong><span class="koboSpan" id="kobo.812.1">: Normally sent to PASS, to allow nodes to authenticate as members </span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.813.1">of this instance. </span><span class="koboSpan" id="kobo.813.2">There is a second support type called </span><strong class="bold"><span class="koboSpan" id="kobo.814.1">Authentication Header</span></strong><span class="koboSpan" id="kobo.815.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.816.1">AH</span></strong><span class="koboSpan" id="kobo.817.1">), but it is not recommended </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">for use.</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.819.1">auth_pass</span></strong><span class="koboSpan" id="kobo.820.1">: The password for </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">the instance.</span></span></li></ul></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">virtual_ipaddress</span></strong><span class="koboSpan" id="kobo.823.1">: A list of VIPs managed by </span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">this instance.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.825.1">In our example, the section will look </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">as follows;</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer161">
<span class="koboSpan" id="kobo.827.1"><img alt="Figure 6.13 – Keepalived vrrp_instance" src="image/B18349_06_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.828.1">Figure 6.13 – Keepalived vrrp_instance</span></p>
<p><span class="koboSpan" id="kobo.829.1">Once the config file is built, copy it over</span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.830.1"> to the second load</span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.831.1"> balancer. </span><span class="koboSpan" id="kobo.831.2">Do not forget to change the state to </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">BACKUP</span></strong><span class="koboSpan" id="kobo.833.1"> on the second system, and also update the interface if it is different on </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">that system.</span></span></p>
<p><span class="koboSpan" id="kobo.835.1">Next, start Keepalived on both nodes with the following command as the </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">root user:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.837.1">
systemctl enable --now keepalived</span></pre> <p><span class="koboSpan" id="kobo.838.1">You can now point your browser to the VIP! </span><span class="koboSpan" id="kobo.838.2">This is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">following example.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<span class="koboSpan" id="kobo.840.1"><img alt="Figure 6.14 – Keepalived VIP in use" src="image/B18349_06_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.841.1">Figure 6.14 – Keepalived VIP in use</span></p>
<p><span class="koboSpan" id="kobo.842.1">You can check the status by looking at the journal entries for the daemon, using the </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.844.1">
journalctl -u keepalived</span></pre> <p><span class="koboSpan" id="kobo.845.1">This will show all the activity of the daemon. </span><span class="koboSpan" id="kobo.845.2">You should see </span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1">Sending gratuitous ARP</span></strong><span class="koboSpan" id="kobo.847.1"> messages, as this is the system</span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.848.1"> checking the health. </span><span class="koboSpan" id="kobo.848.2">You will also see messages about the state, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">Entering MASTER STATE</span></strong><span class="koboSpan" id="kobo.850.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.851.1">Entering BACKUP STATE</span></strong><span class="koboSpan" id="kobo.852.1">, as the system switches</span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.853.1"> between </span><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">MASTER</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.855.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">BACKUP</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">.</span></span></p>
<h1 id="_idParaDest-143"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.858.1">HA clustering for all with Corosync and Pacemaker</span></h1>
<p><span class="koboSpan" id="kobo.859.1">In the previous recipes, we addressed HA</span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.860.1"> by distributing traffic between</span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.861.1"> two active application</span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.862.1"> servers. </span><span class="koboSpan" id="kobo.862.2">However, this method is only effective for stateless applications</span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.863.1"> where the server or browser doesn’t contain specific user or session data. </span><span class="koboSpan" id="kobo.863.2">For applications that are not stateless or run on a complex server, a different approach to HA is necessary. </span><span class="koboSpan" id="kobo.863.3">The solution is to start and stop the application components on different servers, using the combination of Pacemaker and Corosync. </span><span class="koboSpan" id="kobo.863.4">These two open source software projects work together to provide HA clustering for Linux-based systems. </span><span class="koboSpan" id="kobo.863.5">They coordinate and manage multiple nodes in a cluster, ensuring that critical services remain available even during hardware or </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">software failures.</span></span></p>
<p><span class="koboSpan" id="kobo.865.1">Corosync serves as the communication layer for the HA cluster stack, allowing for dependable communication between nodes. </span><span class="koboSpan" id="kobo.865.2">It utilizes a membership and quorum system to monitor the cluster’s active nodes and guarantee that only one node operates as the primary (or master) at a given time. </span><span class="koboSpan" id="kobo.865.3">The messaging</span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.866.1"> layer is essential for sharing data regarding</span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.867.1"> the cluster’s state, node</span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.868.1"> status, and resource conditions. </span><span class="koboSpan" id="kobo.868.2">Corosync plays</span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.869.1"> a vital role in the cluster’s functionality, providing key features such as </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.871.1">Cluster communication</span></strong><span class="koboSpan" id="kobo.872.1">: Corosync enables nodes to exchange</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.873.1"> messages reliably and efficiently, allowing them to coordinate and synchronize </span><span class="No-Break"><span class="koboSpan" id="kobo.874.1">their actions.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.875.1">Membership and quorum</span></strong><span class="koboSpan" id="kobo.876.1">: Corosync is a tool that keeps track of active nodes in a cluster and uses a quorum algorithm to ensure that there are enough nodes available to make decisions. </span><span class="koboSpan" id="kobo.876.2">This helps avoid split-brain scenarios and makes sure that only one node is active. </span><span class="koboSpan" id="kobo.876.3">It’s crucial to avoid split-brain clusters because they can cause data inconsistencies, corruption, and service disruptions. </span><span class="koboSpan" id="kobo.876.4">A split-brain scenario occurs when nodes in a cluster lose communication with each other. </span><span class="koboSpan" id="kobo.876.5">As a result, each node thinks it’s the only active one in the cluster. </span><span class="koboSpan" id="kobo.876.6">This can happen because of network issues, communication failures, </span><span class="No-Break"><span class="koboSpan" id="kobo.877.1">or misconfigurations.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.878.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.879.1">When there is a split-brain scenario, several nodes within the cluster may begin running services or using shared resources on their own, thinking that they are the only active node. </span><span class="koboSpan" id="kobo.879.2">This can cause conflicts and data inconsistencies since each node operates independently without any coordination. </span><span class="koboSpan" id="kobo.879.3">When possible, use an odd number of nodes in a cluster, or enable some protection </span><span class="No-Break"><span class="koboSpan" id="kobo.880.1">using quorum.</span></span></p>
<p><span class="koboSpan" id="kobo.881.1">Pacemaker is a cluster resource manager that utilizes Corosync’s messaging and membership features to manage cluster resources and handle resource failover. </span><span class="koboSpan" id="kobo.881.2">It determines which node in the cluster should run specific services (resources) based on established policies and constraints. </span><span class="koboSpan" id="kobo.881.3">Pacemaker brings the following features to </span><span class="No-Break"><span class="koboSpan" id="kobo.882.1">the cluster:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.883.1">Resource management</span></strong><span class="koboSpan" id="kobo.884.1">: With Pacemaker, administrators</span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.885.1"> can set up resources that require strong availability, such as IP addresses, services, databases, </span><span class="No-Break"><span class="koboSpan" id="kobo.886.1">and applications</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.887.1">Resource monitoring</span></strong><span class="koboSpan" id="kobo.888.1">: Pacemaker continuously monitors the status of resources and nodes to detect failures or changes in </span><span class="No-Break"><span class="koboSpan" id="kobo.889.1">the cluster</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.890.1">Resource failover</span></strong><span class="koboSpan" id="kobo.891.1">: If a node fails or there are resource problems, Pacemaker will begin a failover process, transferring resources to functioning nodes to guarantee </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1">uninterrupted availability</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.893.1">Resource constraints</span></strong><span class="koboSpan" id="kobo.894.1">: Administrators can set constraints and rules for resource placement and failover, defining which nodes are preferred or prohibited for </span><span class="No-Break"><span class="koboSpan" id="kobo.895.1">specific resources</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.896.1">Colocation and order constraints</span></strong><span class="koboSpan" id="kobo.897.1">: Pacemaker allows defining relationships between resources, specifying which resources must run together on the same node or in a </span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">specific order</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.899.1">Cluster management</span></strong><span class="koboSpan" id="kobo.900.1">: Pacemaker provides various command-line utilities and graphical interfaces (such as Hawk) for managing</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.901.1"> and configuring </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">the cluster</span></span></li>
</ul>
<h2 id="_idParaDest-144"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.903.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.904.1">For this recipe, you will need</span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.905.1"> two VMs, each with at least two vCPUs, 8 GB of RAM, and 50 GB of disk</span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.906.1"> space. </span><span class="koboSpan" id="kobo.906.2">You should have Oracle</span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.907.1"> Linux 8 installed, and also a third IP address</span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.908.1"> for a floating VIP to be managed by the cluster. </span><span class="koboSpan" id="kobo.908.2">Both of the web servers will be patched to the latest software. </span><span class="koboSpan" id="kobo.908.3">For this example, the following IPs will </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">be used:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table005-1">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.910.1">Host</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.911.1">IP</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.912.1">Web1</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">192.168.56.200</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.914.1">Web2</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">192.168.56.201</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.916.1">vip</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.917.1">192.168.56.204</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.918.1">Table 6.5 – HA cluster IPs</span></p>
<p><span class="koboSpan" id="kobo.919.1">Before we start with the cluster, you will also need to set up an </span><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">httpd</span></strong><span class="koboSpan" id="kobo.921.1"> (Apache 2.4) server on each host. </span><span class="koboSpan" id="kobo.921.2">This is similar to other hosts set up in </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">other recipes.</span></span></p>
<p><span class="koboSpan" id="kobo.923.1">First, on both servers, as root, install the Apache </span><span class="No-Break"><span class="koboSpan" id="kobo.924.1">web server:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.925.1">
dnf -y install httpd</span></pre> <p><span class="koboSpan" id="kobo.926.1">We do need to enable the status</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.927.1"> page for Apache. </span><span class="koboSpan" id="kobo.927.2">This is one way the resource</span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.928.1"> will be checked. </span><span class="koboSpan" id="kobo.928.2">To do this, copy</span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.929.1"> the following lines</span><a id="_idIndexMarker534"/> <span class="No-Break"><span class="koboSpan" id="kobo.930.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">/etc/httpd/conf.d/status.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.932.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.933.1">
&lt;Location /server-status&gt;
   SetHandler server-status
   Order Deny,Allow
   Deny from all
   Allow from 127.0.0.1
&lt;/Location&gt;</span></pre> <p><span class="koboSpan" id="kobo.934.1">We also need a simple web page. </span><span class="koboSpan" id="kobo.934.2">For testing purposes, put the following into </span><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">/var/www/html/index.html</span></strong><span class="koboSpan" id="kobo.936.1"> on </span><span class="No-Break"><span class="koboSpan" id="kobo.937.1">both servers.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.938.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.939.1">When setting up an application such as a web server, putting your content directory (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">/var/www/html</span></strong><span class="koboSpan" id="kobo.941.1">) on</span><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.942.1"> a Gluster filesystem makes it easier to manage updating your content. </span><span class="koboSpan" id="kobo.942.2">This also works for other data that the application uses, such as temporary </span><span class="No-Break"><span class="koboSpan" id="kobo.943.1">state data.</span></span></p>
<p><span class="koboSpan" id="kobo.944.1">Next, on both servers, add port </span><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">80</span></strong><span class="koboSpan" id="kobo.946.1"> to the local firewall with the </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.948.1">
firewall-cmd --permanent --add-service=http; firewall-cmd --reload</span></pre> <p><span class="koboSpan" id="kobo.949.1">Now, for testing purposes, manually start the server on both nodes. </span><span class="koboSpan" id="kobo.949.2">Do not enable the service to automatically start. </span><span class="koboSpan" id="kobo.949.3">This will be done later when Pacemaker </span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">is configur</span><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.951.1">ed:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.952.1">
systemctl start httpd</span></pre> <p><span class="koboSpan" id="kobo.953.1">You should now</span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.954.1"> see a basic page</span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.955.1"> on both servers, as shown</span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.956.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.957.1">following</span></span><span class="No-Break"><a id="_idIndexMarker538"/></span><span class="No-Break"><span class="koboSpan" id="kobo.958.1"> screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<span class="koboSpan" id="kobo.959.1"><img alt="Figure 6.15 – httpd server test" src="image/B18349_06_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.960.1">Figure 6.15 – httpd server test</span></p>
<p><span class="koboSpan" id="kobo.961.1">You can also test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">server-status</span></strong><span class="koboSpan" id="kobo.963.1"> page using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">wget</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.965.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.966.1">
wget localhost4/server-status</span></pre> <p><span class="koboSpan" id="kobo.967.1">Sample output of a success is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.968.1">following screenshot.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<span class="koboSpan" id="kobo.969.1"><img alt="Figure 6.16 – Successful server-status" src="image/B18349_06_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.970.1">Figure 6.16 – Successful server-status</span></p>
<p><span class="koboSpan" id="kobo.971.1">You are now ready to install and configure Pacemaker </span><span class="No-Break"><span class="koboSpan" id="kobo.972.1">and Corosync.</span></span></p>
<h2 id="_idParaDest-145"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.973.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.974.1">Now that you have installed</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.975.1"> the Apache </span><strong class="source-inline"><span class="koboSpan" id="kobo.976.1">httpd</span></strong><span class="koboSpan" id="kobo.977.1"> server that we will cluster, let’s start by installing</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.978.1"> the software. </span><span class="koboSpan" id="kobo.978.2">First, we need</span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.979.1"> to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.980.1">addons</span></strong><span class="koboSpan" id="kobo.981.1"> repo. </span><span class="koboSpan" id="kobo.981.2">This is done</span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.982.1"> with the following commands on both servers </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">as root.</span></span></p>
<p><span class="koboSpan" id="kobo.984.1">First, on both nodes, enable the repo with the following commands </span><span class="No-Break"><span class="koboSpan" id="kobo.985.1">as root:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.986.1">
dnf config-manager --enable  ol8_addons</span></pre> <p><span class="koboSpan" id="kobo.987.1">Then, you will install </span><span class="No-Break"><span class="koboSpan" id="kobo.988.1">the software:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.989.1">
dnf install -y pacemaker pcs</span></pre> <p><span class="koboSpan" id="kobo.990.1">Once the installation of these packages is complete, a new user named </span><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">hacluster</span></strong><span class="koboSpan" id="kobo.992.1"> will be added to your system. </span><span class="koboSpan" id="kobo.992.2">Please note that remote login will be disabled for this user after installation. </span><span class="koboSpan" id="kobo.992.3">To carry out tasks such as synchronizing the configuration or starting services on other nodes, it is necessary to set the same password for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.993.1">hacluster</span></strong><span class="koboSpan" id="kobo.994.1"> user on both nodes. </span><span class="koboSpan" id="kobo.994.2">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">passwd</span></strong><span class="koboSpan" id="kobo.996.1"> command to set </span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">the password:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.998.1">
passwd hacluster</span></pre> <p><span class="koboSpan" id="kobo.999.1">Next, we need to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">pcs</span></strong><span class="koboSpan" id="kobo.1001.1"> service and </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">start it:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1003.1">
systemctl enable --now pcsd.service</span></pre> <p><span class="koboSpan" id="kobo.1004.1">Next, we need to open up the firewall for the cluster port. </span><span class="koboSpan" id="kobo.1004.2">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1006.1">
firewall-cmd --permanent --add-service=high-availability ; firewall-cmd --reload</span></pre> <p><span class="koboSpan" id="kobo.1007.1">Now we’re done with both nodes for a bit. </span><span class="koboSpan" id="kobo.1007.2">The next few commands can be done on either of the nodes, but note, you still should </span><span class="No-Break"><span class="koboSpan" id="kobo.1008.1">be root.</span></span></p>
<p><span class="koboSpan" id="kobo.1009.1">Next, we need to add both nodes to </span><span class="No-Break"><span class="koboSpan" id="kobo.1010.1">the cluster:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1011.1">
pcs host auth web1 web2 -u hacluster</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.1012.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1013.1">If your nodes are not resolvable in DNS or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.1015.1"> file, you can optionally add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">addr=$IPADDR</span></strong><span class="koboSpan" id="kobo.1017.1"> for each host after the hostname. </span><span class="koboSpan" id="kobo.1017.2">But it’s highly recommended to make sure all hosts are resolvable. </span><span class="koboSpan" id="kobo.1017.3">This option, if used, would look </span><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">as follows:</span></span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.1019.1">pcs host auth web1 addr=192.168.56.200 node2 addr=192.168.56.201 -</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1020.1">u hacluster</span></strong></span></p>
<p><span class="koboSpan" id="kobo.1021.1">Next, we will create </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">the cluster:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1023.1">
pcs cluster setup webapp web1 web2</span></pre> <p><span class="koboSpan" id="kobo.1024.1">Now, we can start </span><span class="No-Break"><span class="koboSpan" id="kobo.1025.1">the</span><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.1026.1"> cluster:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1027.1">
pcs cluster start --all</span></pre> <p><span class="koboSpan" id="kobo.1028.1">To verify that the cluster is running, we can check with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">pcs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1030.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1031.1">
pcs cluster status</span></pre> <p><span class="koboSpan" id="kobo.1032.1">A healthy new cluster</span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.1033.1"> should return</span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.1034.1"> a similar output</span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.1035.1"> as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1">following</span></span><span class="No-Break"><a id="_idIndexMarker546"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1037.1"> example:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<span class="koboSpan" id="kobo.1038.1"><img alt="Figure 6.17 – Cluster status" src="image/B18349_06_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1039.1">Figure 6.17 – Cluster status</span></p>
<p><span class="koboSpan" id="kobo.1040.1">In a cluster consisting</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.1041.1"> of only two nodes, the quorum operates differently</span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.1042.1"> than in clusters with more nodes. </span><span class="koboSpan" id="kobo.1042.2">In such</span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.1043.1"> a cluster, the quorum value is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">1</span></strong><span class="koboSpan" id="kobo.1045.1"> to ensure that the primary</span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.1046.1"> node is always considered in quorum. </span><span class="koboSpan" id="kobo.1046.2">If both nodes go offline due to a network outage, they compete to fence each other, and the first to succeed wins the quorum. </span><span class="koboSpan" id="kobo.1046.3">To increase the chances of a preferred node winning the quorum, the fencing agent can be configured to give it priority. </span><span class="koboSpan" id="kobo.1046.4">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1047.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1048.1">
pcs resource defaults update</span></pre> <p><span class="koboSpan" id="kobo.1049.1">The last step is to disable </span><strong class="bold"><span class="koboSpan" id="kobo.1050.1">STONITH</span></strong><span class="koboSpan" id="kobo.1051.1">, which stands for </span><strong class="bold"><span class="koboSpan" id="kobo.1052.1">Shoot The Other Node In The Head</span></strong><span class="koboSpan" id="kobo.1053.1">. </span><span class="koboSpan" id="kobo.1053.2">This is an advanced fencing tool that requires configuration</span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.1054.1"> specific to your environment. </span><span class="koboSpan" id="kobo.1054.2">If you want to experiment with this technology then check out the official Oracle docs here – </span><a href="https://docs.oracle.com/en/operating-systems/oracle-linux/8/availability/availability-ConfiguringFencingstonith.html#ol-pacemaker-stonith"><span class="No-Break"><span class="koboSpan" id="kobo.1055.1">https://docs.oracle.com/en/operating-systems/oracle-linux/8/availability/availability-ConfiguringFencingstonith.html#ol-pacemaker-stonith</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1056.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1057.1">
pcs property set stonith-enabled=false</span></pre> <p><span class="koboSpan" id="kobo.1058.1">To set up a cluster, we’ll need to create resources. </span><span class="koboSpan" id="kobo.1058.2">A resource agent name has two or three fields separated by a colon. </span><span class="koboSpan" id="kobo.1058.3">The first field is the resource class that indicates the standard followed by the resource agent</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.1059.1"> and helps Pacemaker locate the script. </span><span class="koboSpan" id="kobo.1059.2">For example, the IPaddr2 resource agent follows the </span><strong class="bold"><span class="koboSpan" id="kobo.1060.1">Open Cluster Framework</span></strong><span class="koboSpan" id="kobo.1061.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1062.1">OCF</span></strong><span class="koboSpan" id="kobo.1063.1">) standard. </span><span class="koboSpan" id="kobo.1063.2">The second field varies based on the standard used, and OCF resources use it for the OCF namespace. </span><span class="koboSpan" id="kobo.1063.3">The third field denotes the name of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1064.1">resource agent.</span></span></p>
<p><span class="koboSpan" id="kobo.1065.1">Meta-attributes and instance attributes are available for resources. </span><span class="koboSpan" id="kobo.1065.2">Meta-attributes are not resource-type dependent, while instance attributes are specific to each </span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">resource agent.</span></span></p>
<p><span class="koboSpan" id="kobo.1067.1">In a cluster, resource operations refer to the actions</span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.1068.1"> that can be taken</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.1069.1"> on a specific resource, such as starting, stopping, or monitoring it. </span><span class="koboSpan" id="kobo.1069.2">These operations</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.1070.1"> are identified by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">op</span></strong><span class="koboSpan" id="kobo.1072.1"> keyword. </span><span class="koboSpan" id="kobo.1072.2">To ensure</span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.1073.1"> the resource remains healthy, we will</span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.1074.1"> add a monitor operation with a 15-second interval. </span><span class="koboSpan" id="kobo.1074.2">The criteria for determining whether the resource is healthy depends on the resource agent being used. </span><span class="koboSpan" id="kobo.1074.3">This is also why we enabled the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1075.1">server-status</span></strong><span class="koboSpan" id="kobo.1076.1"> page on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">httpd</span></strong><span class="koboSpan" id="kobo.1078.1"> server, as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">httpd</span></strong><span class="koboSpan" id="kobo.1080.1"> agent uses that page to help determine the health of </span><span class="No-Break"><span class="koboSpan" id="kobo.1081.1">the system.</span></span></p>
<p><span class="koboSpan" id="kobo.1082.1">So, let’s add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1083.1">VIP address:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1084.1">
pcs resource create AppIP ocf:heartbeat:IPaddr2 ip=192.168.56.204 \
 cidr_netmask=24 op monitor interval=15s</span></pre> <p><span class="koboSpan" id="kobo.1085.1">Next up, we will add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">httpd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1087.1"> server:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1088.1">
pcs resource create AppWebServer ocf:heartbeat:apache \
configfile=/etc/httpd/conf/httpd.conf \
statusurl=http://127.0.0.1/server-status \
 op monitor interval=15s</span></pre> <p><span class="koboSpan" id="kobo.1089.1">Now that we have two resources, we also will need</span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.1090.1"> to tie them together as a group. </span><span class="koboSpan" id="kobo.1090.2">With most</span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.1091.1"> applications, multiple resources need to be on the same physical server at the same time. </span><span class="koboSpan" id="kobo.1091.2">This could be IP addresses, Tomcat servers, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">httpd</span></strong><span class="koboSpan" id="kobo.1093.1"> servers, and so on. </span><span class="koboSpan" id="kobo.1093.2">We are going to call this group </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">WebApp</span></strong><span class="koboSpan" id="kobo.1095.1"> and add both the VIP and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">https</span></strong><span class="koboSpan" id="kobo.1097.1"> servers to it. </span><span class="koboSpan" id="kobo.1097.2">Each resource is added individually, so two commands will need to </span><span class="No-Break"><span class="koboSpan" id="kobo.1098.1">be run:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1099.1">
pcs resource group add WebApp AppIP
pcs resource group add WebApp AppWebServer</span></pre> <p><span class="koboSpan" id="kobo.1100.1">Now, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">pcs status</span></strong><span class="koboSpan" id="kobo.1102.1"> command to check </span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">the configuration:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1104.1">
pcs status</span></pre> <p><span class="koboSpan" id="kobo.1105.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1106.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<span class="koboSpan" id="kobo.1107.1"><img alt="Figure 6.18 – pcs status" src="image/B18349_06_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1108.1">Figure 6.18 – pcs status</span></p>
<p><span class="koboSpan" id="kobo.1109.1">We can now see the cluster, with its resource group, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">WebApp</span></strong><span class="koboSpan" id="kobo.1111.1">, with both the </span><span class="No-Break"><span class="koboSpan" id="kobo.1112.1">server VIPs.</span></span></p>
<h2 id="_idParaDest-146"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.1113.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1114.1">Now that everything</span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.1115.1"> is configured, let’s start up the resources</span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.1116.1"> and manage</span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.1117.1"> them. </span><span class="koboSpan" id="kobo.1117.2">We can first start the entire cluster. </span><span class="koboSpan" id="kobo.1117.3">This will online</span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.1118.1"> all nodes in </span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">the cluster:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1120.1">
pcs cluster start --all</span></pre> <p><span class="koboSpan" id="kobo.1121.1">We can also set up the cluster to start on boot with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1122.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1123.1">
systemctl enable --now corosync
systemctl enable --now pacemaker</span></pre> <p><span class="koboSpan" id="kobo.1124.1">You will need to run both of these commands as root on </span><span class="No-Break"><span class="koboSpan" id="kobo.1125.1">both nodes.</span></span></p>
<p><span class="koboSpan" id="kobo.1126.1">Next up, let’s look at a few </span><span class="No-Break"><span class="koboSpan" id="kobo.1127.1">useful commands.</span></span></p>
<p><span class="koboSpan" id="kobo.1128.1">Sometimes a resource gets broken; maybe it was a bad config file, or maybe you started a resource outside of the cluster control, confusing the cluster. </span><span class="koboSpan" id="kobo.1128.2">Once you fix the issues, you will likely need to refresh the resource. </span><span class="koboSpan" id="kobo.1128.3">This will tell the cluster to forget about the failure and restart the service clear of </span><span class="No-Break"><span class="koboSpan" id="kobo.1129.1">any errors:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1130.1">
pcs resource refresh AppWebServer</span></pre> <p><span class="koboSpan" id="kobo.1131.1">You also can check the details</span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.1132.1"> of a resource, using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1133.1">config</span></strong><span class="koboSpan" id="kobo.1134.1"> option. </span><span class="koboSpan" id="kobo.1134.2">This is helpful </span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.1135.1">if you forget how the resource</span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.1136.1"> was configured. </span><span class="koboSpan" id="kobo.1136.2">An example is seen</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.1137.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<span class="koboSpan" id="kobo.1139.1"><img alt="Figure 6.19 – Resource configuration" src="image/B18349_06_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1140.1">Figure 6.19 – Resource configuration</span></p>
<p><span class="koboSpan" id="kobo.1141.1">Next, let’s move </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">WebApp</span></strong><span class="koboSpan" id="kobo.1143.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.1144.1">server </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">web2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1146.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1147.1">
pcs resource move WebApp web2</span></pre> <p><span class="koboSpan" id="kobo.1148.1">When you run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">move</span></strong><span class="koboSpan" id="kobo.1150.1">, you can also monitor the move by checking the constraints. </span><span class="koboSpan" id="kobo.1150.2">This is a little cleaner than using the  </span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">pcs </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1152.1">status</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1153.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1154.1">
pcs constraint</span></pre> <p><span class="koboSpan" id="kobo.1155.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1156.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<span class="koboSpan" id="kobo.1157.1"><img alt="Figure 6.20 – Cluster constraints" src="image/B18349_06_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1158.1">Figure 6.20 – Cluster constraints</span></p>
<p><span class="koboSpan" id="kobo.1159.1">The power</span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.1160.1"> of the Pacemaker/Corosync technology</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.1161.1"> is its flexibility. </span><span class="koboSpan" id="kobo.1161.2">You can cluster</span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.1162.1"> just about anything with it, making it a</span><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.1163.1"> powerful tool</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.1164.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.1165.1">the sysadmin.</span></span></p>
<h1 id="_idParaDest-147"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.1166.1">Sharing a filesystem across multiple machines – cluster 
or distribute?</span></h1>
<p><span class="koboSpan" id="kobo.1167.1">When you start using technologies</span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.1168.1"> such as load balancers and clustering</span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.1169.1"> software, you often end up in a situation where you need the same files on multiple servers. </span><span class="koboSpan" id="kobo.1169.2">While you could simply copy the files, what if you could mount the files on each of the servers, sharing the filesystem across the systems without the SPOF that an NFS server introduces? </span><span class="koboSpan" id="kobo.1169.3">One of t</span><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.1170.1">he easiest ways to do this is to </span><span class="No-Break"><span class="koboSpan" id="kobo.1171.1">use Gluster.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.1172.1">Gluster</span></strong><span class="koboSpan" id="kobo.1173.1">, also known as </span><strong class="bold"><span class="koboSpan" id="kobo.1174.1">GlusterFS</span></strong><span class="koboSpan" id="kobo.1175.1">, is an open source distributed filesystem that provides scalable and flexible</span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.1176.1"> storage for large volumes</span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.1177.1"> of data. </span><span class="koboSpan" id="kobo.1177.2">Initially developed by Gluster Inc., it is now maintained by the open source community. </span><span class="koboSpan" id="kobo.1177.3">Gluster uses a distributed architecture to create a single and unified filesystem that can span across multiple servers and storage devices. </span><span class="koboSpan" id="kobo.1177.4">This approach allows you to aggregate the storage capacity of multiple servers and present it as a single, well-structured filesystem to users and applications. </span><span class="koboSpan" id="kobo.1177.5">It has a wide range of applications, such as data storage, backup, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1">content delivery.</span></span></p>
<p><span class="koboSpan" id="kobo.1179.1">Key features and concepts of Gluster include </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1181.1">Scalability</span></strong><span class="koboSpan" id="kobo.1182.1">: Adding more storage servers to the cluster allows Gluster to easily accommodate growing data storage needs while </span><span class="No-Break"><span class="koboSpan" id="kobo.1183.1">scaling horizontally.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1184.1">Redundancy</span></strong><span class="koboSpan" id="kobo.1185.1">: Gluster ensures data availability by replicating data across multiple nodes for redundancy and </span><span class="No-Break"><span class="koboSpan" id="kobo.1186.1">fault tolerance.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1187.1">Flexibility</span></strong><span class="koboSpan" id="kobo.1188.1">: Gluster supports various storage options, including local disks, NAS, and cloud storage. </span><span class="koboSpan" id="kobo.1188.2">It can be customized to fit specific use cases </span><span class="No-Break"><span class="koboSpan" id="kobo.1189.1">and technologies.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1190.1">Filesystem abstraction</span></strong><span class="koboSpan" id="kobo.1191.1">: It provides users and applications with a standard filesystem interface, making integration into existing systems </span><span class="No-Break"><span class="koboSpan" id="kobo.1192.1">relatively easy.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1193.1">Data distribution</span></strong><span class="koboSpan" id="kobo.1194.1">: Data is distributed across the cluster in a way that improves both performance and reliability. </span><span class="koboSpan" id="kobo.1194.2">Data can be distributed evenly or based on </span><span class="No-Break"><span class="koboSpan" id="kobo.1195.1">specific criteria.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1196.1">Automatic healing</span></strong><span class="koboSpan" id="kobo.1197.1">: Gluster has a self-healing feature that automatically detects and repairs data inconsistencies or </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">corrupted files.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1199.1">Gluster is often used in environments</span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.1200.1"> where large-scale, distributed storage</span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.1201.1"> is required, such as web servers, cloud computing, big data analytics, and media streaming services. </span><span class="koboSpan" id="kobo.1201.2">It provides a cost-effective and flexible solution for managing data across a network of servers and </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">storage devices.</span></span></p>
<h2 id="_idParaDest-148"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.1203.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1204.1">For this recipe, you will need two Oracle Linux 8 systems, each with access to YUM repos. </span><span class="koboSpan" id="kobo.1204.2">For this exercise, we will call them </span><strong class="source-inline"><span class="koboSpan" id="kobo.1205.1">gluster1</span></strong><span class="koboSpan" id="kobo.1206.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1207.1">gluster2</span></strong><span class="koboSpan" id="kobo.1208.1">. </span><span class="koboSpan" id="kobo.1208.2">They are identical systems, each with 8 GB RAM, 4 vCPUs, and 100 GB of drive space. </span><span class="koboSpan" id="kobo.1208.3">The filesystems have 50 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1209.1">/</span></strong><span class="koboSpan" id="kobo.1210.1">, 5 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">/home</span></strong><span class="koboSpan" id="kobo.1212.1">, and 8 GB in swap. </span><span class="koboSpan" id="kobo.1212.2">The remaining disk space is unallocated. </span><span class="koboSpan" id="kobo.1212.3">Additionally, for this example, each node will have a 100 GB LUN used for storing </span><span class="No-Break"><span class="koboSpan" id="kobo.1213.1">Gluster data.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1214.1">Warning</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1215.1">Having at least three nodes in a cluster is highly recommended to avoid split-brain clusters. </span><span class="koboSpan" id="kobo.1215.2">Although a two-node cluster is possible, it poses a risk of corrupt data if the system ever splits its brain. </span><span class="koboSpan" id="kobo.1215.3">Split-brain clusters are undesirable in distributed computing environments because they can result in data inconsistency, corruption, and operational issues. </span><span class="koboSpan" id="kobo.1215.4">Split brain occurs when the nodes in a cluster lose connectivity or communication with each other, leading to the cluster’s division into multiple isolated nodes. </span><span class="koboSpan" id="kobo.1215.5">Each node thinks it is the active or primary cluster, resulting in the potential for conflicts and </span><span class="No-Break"><span class="koboSpan" id="kobo.1216.1">data discrepancies.</span></span></p>
<p><span class="koboSpan" id="kobo.1217.1">On each server, you will need</span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.1218.1"> to perform the following</span><a id="_idIndexMarker579"/> <span class="No-Break"><span class="koboSpan" id="kobo.1219.1">prep work:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1220.1">Create an XFS filesystem on the 100 GB LUN. </span><span class="koboSpan" id="kobo.1220.2">This space will be used to store the Gluster data, known as </span><strong class="bold"><span class="koboSpan" id="kobo.1221.1">bricks</span></strong><span class="koboSpan" id="kobo.1222.1">. </span><span class="koboSpan" id="kobo.1222.2">In the context of Gluster, a </span><em class="italic"><span class="koboSpan" id="kobo.1223.1">brick</span></em><span class="koboSpan" id="kobo.1224.1"> refers to a basic storage unit within the storage</span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.1225.1"> cluster. </span><span class="koboSpan" id="kobo.1225.2">A cluster is made up of multiple bricks, which are essentially directories on storage servers or devices where data is stored. </span><span class="koboSpan" id="kobo.1225.3">Each brick represents a portion of the overall storage capacity of </span><span class="No-Break"><span class="koboSpan" id="kobo.1226.1">the cluster.</span></span></li>
<li><span class="koboSpan" id="kobo.1227.1">Since we will be using Gluster to manage the storage, we will not be using LVM on the filesystem. </span><span class="koboSpan" id="kobo.1227.2">On these systems, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1228.1">/dev/sdb</span></strong><span class="koboSpan" id="kobo.1229.1"> is the 100 GB LUN. </span><span class="koboSpan" id="kobo.1229.2">The following commands are used to create and mount </span><span class="No-Break"><span class="koboSpan" id="kobo.1230.1">the filesystem:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1231.1">mkfs.xfs -f -i size=512 -L glusterfs /dev/sdb</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1232.1">mkdir -p /data/glusterfs/volumes/bricks</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1233.1">echo 'LABEL=glusterfs /data/glusterfs/volumes/bricks xfs defaults  0 0' |sudo tee -a /etc/fstab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1234.1">mount -a</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1235.1">When completed, check with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">df</span></strong><span class="koboSpan" id="kobo.1237.1"> command to verify that the filesystem is mounted, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1238.1">following example:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.1239.1"><img alt="Figure 6.21 – Bricks mounted" src="image/B18349_06_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1240.1">Figure 6.21 – Bricks mounted</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1241.1">Next, we need to make sure</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.1242.1"> that all the nodes are in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.1244.1"> file. </span><span class="koboSpan" id="kobo.1244.2">In this</span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.1245.1"> example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">gluster1</span></strong><span class="koboSpan" id="kobo.1247.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">gluster2</span></strong><span class="koboSpan" id="kobo.1249.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">gluster3</span></strong><span class="koboSpan" id="kobo.1251.1"> are in the</span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.1252.1"> file, using both the short name and the </span><strong class="bold"><span class="koboSpan" id="kobo.1253.1">Fully Qualified Doman Name</span></strong><span class="koboSpan" id="kobo.1254.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1255.1">FQDN</span></strong><span class="koboSpan" id="kobo.1256.1">). </span><span class="koboSpan" id="kobo.1256.2">This is seen in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">code snippet:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1258.1">[root@gluster3 ~]# more /etc/hosts</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1259.1">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1260.1">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1261.1">192.168.200.110 gluster1.m57.local    gluster1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1262.1">192.168.200.125 gluster2.m57.local    gluster2</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1263.1">[root@gluster3 ~]#</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1264.1">In order to install the software, we need to enable the Gluster repo. </span><span class="koboSpan" id="kobo.1264.2">Then, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">glusterfs</span></strong><span class="koboSpan" id="kobo.1266.1"> and Gluster server software can be installed and started. </span><span class="koboSpan" id="kobo.1266.2">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1267.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1268.1">dnf -y install oracle-gluster-release-el8</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1269.1">dnf -y config-manager --enable ol8_gluster_appstream ol8_baseos_latest ol8_appstream</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1270.1">dnf -y module enable glusterfs</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1271.1">dnf -y install @glusterfs/server</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1272.1">systemctl enable --now glusterd</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1273.1">Once running, you can verify that the Gluster daemon is running with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1274.1">systemctl status glusterd</span></strong><span class="koboSpan" id="kobo.1275.1"> command. </span><span class="koboSpan" id="kobo.1275.2">Verify that the service is active and running, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1276.1">following example:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.1277.1"><img alt="Figure 6.22 – Gluster daemon is running" src="image/B18349_06_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1278.1">Figure 6.22 – Gluster daemon is running</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1279.1">Next, let’s configure</span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.1280.1"> the firewall to allow the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">glusterfs</span></strong><span class="koboSpan" id="kobo.1282.1"> port with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">following</span></span><span class="No-Break"><a id="_idIndexMarker585"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1284.1"> commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1285.1">firewall-cmd --permanent --add-service=glusterfs</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1286.1">firewall-cmd --reload</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1287.1">Additionally, to improve security, let’s create a self-signed key, to encrypt the communication between </span><span class="No-Break"><span class="koboSpan" id="kobo.1288.1">the nodes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1289.1">openssl genrsa -out /etc/ssl/glusterfs.key 2048</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1290.1">openssl req -new -x509 -days 365 -key /etc/ssl/glusterfs.key -out /etc/ssl/glusterfs.pem</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1291.1">When generating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">.pem</span></strong><span class="koboSpan" id="kobo.1293.1"> file, since this is a self-signed certificate, you will need to enter your contact info into the certificate; however, it will work with </span><span class="No-Break"><span class="koboSpan" id="kobo.1294.1">the defaults!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1295.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1296.1">In this example, we are using a self-signed certificate. </span><span class="koboSpan" id="kobo.1296.2">In a secure production environment, you will want to consider using a commercially </span><span class="No-Break"><span class="koboSpan" id="kobo.1297.1">signed certificate.</span></span></p>
<p><span class="koboSpan" id="kobo.1298.1">We will use these files later to encrypt </span><span class="No-Break"><span class="koboSpan" id="kobo.1299.1">the communication.</span></span></p>
<h2 id="_idParaDest-149"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.1300.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1301.1">Now that all the prep work has been completed </span><a id="_idIndexMarker586"/><span class="koboSpan" id="kobo.1302.1">on each of the nodes, we will create the trusted</span><a id="_idIndexMarker587"/><span class="koboSpan" id="kobo.1303.1"> storage pools and encrypt the communications. </span><span class="koboSpan" id="kobo.1303.2">This will have everything ready to create volumes, where data is stored </span><span class="No-Break"><span class="koboSpan" id="kobo.1304.1">and shared.</span></span></p>
<p><span class="koboSpan" id="kobo.1305.1">A trusted storage pool in Gluster pertains to a setup where a cluster of Gluster servers, referred to as storage nodes or peers, have established trust</span><a id="_idIndexMarker588"/><span class="koboSpan" id="kobo.1306.1"> among themselves to work together within a storage cluster. </span><span class="koboSpan" id="kobo.1306.2">This trust is established through a trusted storage pool configuration that typically involves the </span><span class="No-Break"><span class="koboSpan" id="kobo.1307.1">following steps:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1308.1">Authentication</span></strong><span class="koboSpan" id="kobo.1309.1">: Various methods, such as SSH keys, certificates, or shared secrets, can be used to authenticate nodes in the trusted storage pool. </span><span class="koboSpan" id="kobo.1309.2">This ensures that only authorized servers are part of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1">storage cluster.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1311.1">Authorization</span></strong><span class="koboSpan" id="kobo.1312.1">: After nodes are authenticated, they authorize each other to access and manipulate specific data within the Gluster storage cluster. </span><span class="koboSpan" id="kobo.1312.2">The authorization settings determine which nodes have read and write access to particular volumes or bricks within </span><span class="No-Break"><span class="koboSpan" id="kobo.1313.1">the cluster.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1314.1">Communication</span></strong><span class="koboSpan" id="kobo.1315.1">: Members of the trusted storage pool communicate over a secure network to replicate data, synchronize metadata, and perform other cluster-related operations, ensuring that the storage cluster </span><span class="No-Break"><span class="koboSpan" id="kobo.1316.1">functions cohesively.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1317.1">Data integrity</span></strong><span class="koboSpan" id="kobo.1318.1">: Trusted storage pools ensure data integrity and redundancy via distributed replication across </span><span class="No-Break"><span class="koboSpan" id="kobo.1319.1">multiple nodes.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1320.1">Scalability</span></strong><span class="koboSpan" id="kobo.1321.1">: It is possible to add more storage nodes to the trusted pool, which enhances storage capacity and performance. </span><span class="koboSpan" id="kobo.1321.2">The trusted nature of the pool makes it easy for new nodes to join the cluster and contribute to </span><span class="No-Break"><span class="koboSpan" id="kobo.1322.1">its resources.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1323.1">In Gluster, a trusted storage pool </span><a id="_idIndexMarker589"/><span class="koboSpan" id="kobo.1324.1">is a crucial element as it lays the foundation</span><a id="_idIndexMarker590"/><span class="koboSpan" id="kobo.1325.1"> for the fault-tolerant and distributed nature of the filesystem. </span><span class="koboSpan" id="kobo.1325.2">It guarantees that all nodes within the cluster can work seamlessly and securely in collaboration with each other. </span><span class="koboSpan" id="kobo.1325.3">The following steps will walk you through how to create a GlusterFS on </span><span class="No-Break"><span class="koboSpan" id="kobo.1326.1">two hosts.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1327.1">To create the pool, we need to probe the other nodes in the cluster. </span><span class="koboSpan" id="kobo.1327.2">In this example, we will probe from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1328.1">gluster1</span></strong><span class="koboSpan" id="kobo.1329.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1330.1">gluster2</span></strong><span class="koboSpan" id="kobo.1331.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1332.1">gluster peer probe </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">gluster2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1335.1">[root@gluster1 etc]# gluster peer probe gluster2</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1336.1">peer probe: success</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1337.1">You can then use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">gluster pool list</span></strong><span class="koboSpan" id="kobo.1339.1"> command to see what nodes are peered with the node where you ran the command from; in the following example, the command was run </span><span class="No-Break"><span class="koboSpan" id="kobo.1340.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">gluster2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1342.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1343.1">[root@gluster2 etc]#  gluster pool list</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1344.1">UUID                                 Hostname        State</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1345.1">b13801f3-dcbd-487b-b3f3-2e95afa8b632                       </span></strong><strong class="bold"><span class="koboSpan" id="kobo.1346.1">  gluster1        Connected</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1347.1">bc003cd0-f733-4a25-85fb-40a7c387d667                         localhost       Connected</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1348.1">Here, it shows </span><strong class="source-inline"><span class="koboSpan" id="kobo.1349.1">gluster1</span></strong><span class="koboSpan" id="kobo.1350.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1351.1">localhost</span></strong><span class="koboSpan" id="kobo.1352.1"> connected as this was run on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1353.1">gluster2</span></strong><span class="koboSpan" id="kobo.1354.1">. </span><span class="koboSpan" id="kobo.1354.2">If you run the same command from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1355.1">gluster1</span></strong><span class="koboSpan" id="kobo.1356.1">, you will see </span><strong class="source-inline"><span class="koboSpan" id="kobo.1357.1">gluster2</span></strong><span class="koboSpan" id="kobo.1358.1"> as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1359.1">remote host:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1360.1">[root@gluster1 ~]# gluster pool list</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1361.1">UUID                                 Hostname        State</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1362.1">bc003cd0-f733-4a25-85fb-40a7c387d667                         gluster2        Connected</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1363.1">b13801f3-dcbd-487b-b3f3-2e95afa8b632             </span></strong><strong class="bold"><span class="koboSpan" id="kobo.1364.1">            localhost       Connected</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1365.1">Now that we have the cluster, let’s create a replicated volume. </span><span class="koboSpan" id="kobo.1365.2">This volume will re-write the bricks</span><a id="_idIndexMarker591"/><span class="koboSpan" id="kobo.1366.1"> across the cluster, enabling protection</span><a id="_idIndexMarker592"/><span class="koboSpan" id="kobo.1367.1"> against failed storage or a </span><span class="No-Break"><span class="koboSpan" id="kobo.1368.1">failed node.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1369.1">The following command will create </span><span class="No-Break"><span class="koboSpan" id="kobo.1370.1">the volume:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1371.1">gluster volume create data1 replica 2 gluster{1,2}:/data/glusterfs/volumes/bricks/data1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1372.1">Once the volume is created, we need to </span><span class="No-Break"><span class="koboSpan" id="kobo.1373.1">start it:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1374.1">gluster volume start data1</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1375.1">We now can mount it. </span><span class="koboSpan" id="kobo.1375.2">For now, we will use the Gluster native client, and mount it on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1376.1">/mnt</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1377.1">mount point:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1378.1">mount -t glusterfs gluster2:data1 /mnt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1379.1">We can now see the storage mounted using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1380.1">df</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1"> command:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.1382.1"><img alt="Figure 6.23 – data1 mounted on /mnt" src="image/B18349_06_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1383.1">Figure 6.23 – data1 mounted on /mnt</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1384.1">If you want to mount this on other nodes, you will need to repeat the command on each node, updating the node name as needed. </span><span class="koboSpan" id="kobo.1384.2">The following example shows mounting </span><span class="No-Break"><span class="koboSpan" id="kobo.1385.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1">gluster1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1387.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1388.1">mount -t glusterfs gluster1:data1 /mnt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1389.1">Next, we need to set up the encryption using the keys we previously created. </span><span class="koboSpan" id="kobo.1389.2">The first step is to take the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1390.1">.pem</span></strong><span class="koboSpan" id="kobo.1391.1"> files previously created and concatenate them into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">/etc/ssl/glusterfs.ca</span></strong><span class="koboSpan" id="kobo.1393.1"> file. </span><span class="koboSpan" id="kobo.1393.2">This file should be placed on all nodes of </span><span class="No-Break"><span class="koboSpan" id="kobo.1394.1">the cluster.</span></span></li>
<li><span class="koboSpan" id="kobo.1395.1">Now, we need to enable</span><a id="_idIndexMarker593"/><span class="koboSpan" id="kobo.1396.1"> the encryption. </span><span class="koboSpan" id="kobo.1396.2">This is done by touching</span><a id="_idIndexMarker594"/><span class="koboSpan" id="kobo.1397.1"> the secure-access file on each node using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1398.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1399.1">touch /var/lib/glusterd/secure-access</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1400.1">Now, for each volume, we will need to enable SSL for both the client and the server. </span><span class="koboSpan" id="kobo.1400.2">In the example command, we will enable this for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1401.1">data1</span></strong><span class="koboSpan" id="kobo.1402.1"> volume that was </span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1">just created:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1404.1">gluster volume set data1 client.ssl on</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1405.1">gluster volume set data1  server.ssl on</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1406.1">Now, </span><span class="No-Break"><span class="koboSpan" id="kobo.1407.1">restart </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1408.1">glusterd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1">:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1410.1">systemctl restart glusterd</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1411.1">Gluster communication is now encrypted for </span><span class="No-Break"><span class="koboSpan" id="kobo.1412.1">this volume.</span></span></p>
<h2 id="_idParaDest-150"><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.1413.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1414.1">There is more you can do with Gluster. </span><span class="koboSpan" id="kobo.1414.2">First, volumes have multiple options when you create them, each offering options for replication </span><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">and distribution:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1416.1">Distributed</span></strong><span class="koboSpan" id="kobo.1417.1">: When using distributed volumes, files are randomly distributed across the bricks in the volume. </span><span class="koboSpan" id="kobo.1417.2">This type of volume is useful when the need is to scale storage, and redundancy is not necessary or is already provided by other hardware or software layers. </span><span class="koboSpan" id="kobo.1417.3">However, it is important to note that disk or server failures can result in significant data loss, as the data is spread randomly across the bricks in the volume. </span><span class="koboSpan" id="kobo.1417.4">An example command to build a distributed volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1418.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1419.1">gluster volume create data1  gluster{1,2}:/data/glusterfs/volumes/bricks/data1</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.1420.1">Replicated</span></strong><span class="koboSpan" id="kobo.1421.1">: Files are copied across bricks for HA in replicated volumes. </span><span class="koboSpan" id="kobo.1421.2">An example command to build a replicated volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1423.1">gluster volume create data1 replica 2 gluster{1,2}:/data/glusterfs/volumes/bricks/data1</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.1424.1">Distributed replicated</span></strong><span class="koboSpan" id="kobo.1425.1">: Distributed files across replicated</span><a id="_idIndexMarker595"/><span class="koboSpan" id="kobo.1426.1"> bricks in the volume for improved read</span><a id="_idIndexMarker596"/><span class="koboSpan" id="kobo.1427.1"> performance, HA, and reliability. </span><span class="koboSpan" id="kobo.1427.2">When creating a distributed replicated volume, the number of nodes should be a multiple of the number of bricks. </span><span class="koboSpan" id="kobo.1427.3">An example command to build a distributed replicated volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1428.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1429.1">gluster volume create data1 replica 2 cluster{1,2,3,4}:/data/glusterfs/volumes/bricks/data1</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.1430.1">Dispersed</span></strong><span class="koboSpan" id="kobo.1431.1">: This volume type utilizes erasure codes to efficiently protect against disk or server failures. </span><span class="koboSpan" id="kobo.1431.2">It works by striping the encoded data of files across multiple bricks in the volume while adding redundancy to ensure reliability. </span><span class="koboSpan" id="kobo.1431.3">Dispersed volumes allow for customizable reliability levels with minimal space waste. </span><span class="koboSpan" id="kobo.1431.4">A dispersed volume must have at least three bricks. </span><span class="koboSpan" id="kobo.1431.5">An example command to build a dispersed volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1433.1">gluster volume create data1 disperse 3 redundancy 1 \ cluster{1,2,3}:/data/glusterfs/volumes/bricks/data1</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.1434.1">Distributed dispersed</span></strong><span class="koboSpan" id="kobo.1435.1">: Distributes data across dispersed bricks, providing the same benefits of distributed replicated volumes but using dispersed storage. </span><span class="koboSpan" id="kobo.1435.2">A dispersed volume must have at least six bricks. </span><span class="koboSpan" id="kobo.1435.3">An example command to build a distributed dispersed volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1436.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1437.1">gluster volume create data1 disperse 3 redundancy 1 \ cluster{1,2,3,4,5,6}:/data/glusterfs/volumes/bricks/data1</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.1438.1">When adding bricks to any volume, you can put more than one brick on a Gluster node. </span><span class="koboSpan" id="kobo.1438.2">Simply define the additional brick in the command. </span><span class="koboSpan" id="kobo.1438.3">In this example, a distributed dispersed volume is created, by putting two bricks on </span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1">each node:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1440.1">
gluster volume create data1 disperse 3 redundancy 1 \ cluster{1,2,3}:/data/glusterfs/volumes/bricks/data1 \ cluster{1,2,3}:/data/glusterfs/volumes/bricks/data2</span></pre> <p><span class="koboSpan" id="kobo.1441.1">Volumes can be stopped with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1442.1">gluster stop volume volumename</span></strong><span class="koboSpan" id="kobo.1443.1"> command. </span><span class="koboSpan" id="kobo.1443.2">An example to stop the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1444.1">data1</span></strong><span class="koboSpan" id="kobo.1445.1"> volume is </span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1447.1">
gluster stop volume data1</span></pre> <p><span class="koboSpan" id="kobo.1448.1">You can also add bricks to a volume</span><a id="_idIndexMarker597"/><span class="koboSpan" id="kobo.1449.1"> to grow it. </span><span class="koboSpan" id="kobo.1449.2">This can be done after a new node</span><a id="_idIndexMarker598"/><span class="koboSpan" id="kobo.1450.1"> is added to the cluster. </span><span class="koboSpan" id="kobo.1450.2">In the following example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">gluster3</span></strong><span class="koboSpan" id="kobo.1452.1"> was added to the cluster with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1453.1">gluster node probe gluster3</span></strong><span class="koboSpan" id="kobo.1454.1"> command first. </span><span class="koboSpan" id="kobo.1454.2">Then, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1455.1">data1</span></strong><span class="koboSpan" id="kobo.1456.1"> was grown with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1457.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1458.1">
gluster volume add-brick data1 gluster3:/data/glusterfs/volumes/bricks/data1</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.1459.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1460.1">When adding bricks to a volume, make sure you add the required number of bricks. </span><span class="koboSpan" id="kobo.1460.2">Volume types such as distributed replicated volumes will need more than a single </span><span class="No-Break"><span class="koboSpan" id="kobo.1461.1">brick added.</span></span></p>
<p><span class="koboSpan" id="kobo.1462.1">You can also check the status of all volumes with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1464.1">
gluster volume status</span></pre> <p><span class="koboSpan" id="kobo.1465.1">An example is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1466.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.1467.1"><img alt="Figure 6.24 – volume status" src="image/B18349_06_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1468.1">Figure 6.24 – volume status</span></p>
<p><span class="koboSpan" id="kobo.1469.1">You can see the summary</span><a id="_idIndexMarker599"/><span class="koboSpan" id="kobo.1470.1"> for a single volume by adding the volume </span><a id="_idIndexMarker600"/><span class="koboSpan" id="kobo.1471.1">name to the command. </span><span class="koboSpan" id="kobo.1471.2">You can also see more details by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">detail</span></strong><span class="koboSpan" id="kobo.1473.1"> option. </span><span class="koboSpan" id="kobo.1473.2">These can be combined, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1474.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.1475.1"><img alt="Figure 6.25 – Volume details" src="image/B18349_06_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1476.1">Figure 6.25 – Volume details</span></p>
<p><span class="koboSpan" id="kobo.1477.1">If you want to see performance information about a volume, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1478.1">top</span></strong><span class="koboSpan" id="kobo.1479.1"> option can be used. </span><span class="koboSpan" id="kobo.1479.2">This will show what bricks are being used for read/write activity as well as I/O throughput to each brick. </span><span class="koboSpan" id="kobo.1479.3">The basic command is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1480.1">gluster volume top volume_name option</span></strong><span class="koboSpan" id="kobo.1481.1">, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1">volume_name</span></strong><span class="koboSpan" id="kobo.1483.1"> being the name of the volume and the options being </span><span class="No-Break"><span class="koboSpan" id="kobo.1484.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1485.1">read</span></strong><span class="koboSpan" id="kobo.1486.1">: This shows the highest read calls for each brick, as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.1487.1">the counts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1488.1">write</span></strong><span class="koboSpan" id="kobo.1489.1">: This shows the highest write calls for each brick, as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.1490.1">the counts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1491.1">open</span></strong><span class="koboSpan" id="kobo.1492.1">: This shows what bricks have open </span><span class="No-Break"><span class="koboSpan" id="kobo.1493.1">file descriptors.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1494.1">opendir</span></strong><span class="koboSpan" id="kobo.1495.1">: This shows what bricks have open calls on each directory, as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.1496.1">the counts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">read-perf</span></strong><span class="koboSpan" id="kobo.1498.1">: This shows read-performance throughput by brick. </span><span class="koboSpan" id="kobo.1498.2">Run using the options </span><strong class="source-inline"><span class="koboSpan" id="kobo.1499.1">bs</span></strong><span class="koboSpan" id="kobo.1500.1"> (for block size) </span><strong class="source-inline"><span class="koboSpan" id="kobo.1501.1">1024</span></strong><span class="koboSpan" id="kobo.1502.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">count 1024</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1504.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1505.1">write-perf</span></strong><span class="koboSpan" id="kobo.1506.1">: This shows read-performance</span><a id="_idIndexMarker601"/><span class="koboSpan" id="kobo.1507.1"> throughput by brick. </span><span class="koboSpan" id="kobo.1507.2">Run</span><a id="_idIndexMarker602"/><span class="koboSpan" id="kobo.1508.1"> using  the options </span><strong class="source-inline"><span class="koboSpan" id="kobo.1509.1">bs</span></strong><span class="koboSpan" id="kobo.1510.1"> (for block size) </span><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">1024</span></strong><span class="koboSpan" id="kobo.1512.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">count 1024</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1514.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1515.1">Several examples are seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1516.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.1517.1"><img alt="Figure 6.26 – volume top examples" src="image/B18349_06_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1518.1">Figure 6.26 – volume top examples</span></p>
<p><span class="koboSpan" id="kobo.1519.1">Volumes can also be deleted. </span><span class="koboSpan" id="kobo.1519.2">This is done with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1520.1">gluster volume delete volume_name</span></strong><span class="koboSpan" id="kobo.1521.1"> command, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.1522.1">volume_name</span></strong><span class="koboSpan" id="kobo.1523.1"> is the volume being deleted. </span><span class="koboSpan" id="kobo.1523.2">As a note, when deleting volumes, don’t forget</span><a id="_idIndexMarker603"/><span class="koboSpan" id="kobo.1524.1"> to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1525.1">rm</span></strong><span class="koboSpan" id="kobo.1526.1"> command to delete</span><a id="_idIndexMarker604"/><span class="koboSpan" id="kobo.1527.1"> the bricks </span><span class="No-Break"><span class="koboSpan" id="kobo.1528.1">from storage.</span></span></p>
<h1 id="_idParaDest-151"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.1529.1">Generating, configuring, and monitoring Ethernet traffic over bond</span></h1>
<p><span class="koboSpan" id="kobo.1530.1">When using bare-metal servers as dedicated hosts or Linux systems that host virtual machines using the KVM hypervisor, the network</span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.1531.1"> can be a weak point. </span><span class="koboSpan" id="kobo.1531.2">Fortunately, this issue can be resolved by implementing</span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.1532.1"> Ethernet bonding, also known as network bonding, or </span><strong class="bold"><span class="koboSpan" id="kobo.1533.1">Network Interface Card</span></strong><span class="koboSpan" id="kobo.1534.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1535.1">NIC</span></strong><span class="koboSpan" id="kobo.1536.1">) bonding. </span><span class="koboSpan" id="kobo.1536.2">It is a technology in Linux that allows you to combine multiple NICs</span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.1537.1"> into a single logical interface. </span><span class="koboSpan" id="kobo.1537.2">This logical interface, known as a bond or bonded interface, provides increased network</span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.1538.1"> bandwidth, fault tolerance, and load balancing. </span><span class="koboSpan" id="kobo.1538.2">These are summarized </span><span class="No-Break"><span class="koboSpan" id="kobo.1539.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1540.1">Load balancing</span></strong><span class="koboSpan" id="kobo.1541.1">: Bonding distributes network traffic across </span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.1542.1">multiple NICs, increasing bandwidth. </span><span class="koboSpan" id="kobo.1542.2">Various algorithms, such as round-robin, active-backup, and XOR, can be used depending on </span><span class="No-Break"><span class="koboSpan" id="kobo.1543.1">specific requirements.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1544.1">Fault tolerance</span></strong><span class="koboSpan" id="kobo.1545.1">: In the event of an NIC or network link failure, Ethernet bonding</span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.1546.1"> can automatically switch traffic to another active NIC. </span><span class="koboSpan" id="kobo.1546.2">This provides redundancy and fault tolerance, ensuring network connectivity remains available even if one NIC </span><span class="No-Break"><span class="koboSpan" id="kobo.1547.1">becomes unavailable.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1548.1">Link aggregation</span></strong><span class="koboSpan" id="kobo.1549.1">: Bonding can be used to create </span><strong class="bold"><span class="koboSpan" id="kobo.1550.1">link aggregation groups</span></strong><span class="koboSpan" id="kobo.1551.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1552.1">LAGs</span></strong><span class="koboSpan" id="kobo.1553.1">) or NIC teams, which enhance bandwidth</span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.1554.1"> and redundancy </span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.1555.1">in </span><span class="No-Break"><span class="koboSpan" id="kobo.1556.1">HA setups.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1557.1">In this recipe, we will configure bonding, and then show some common tools that will allow you to both monitor and generate Ethernet traffic over </span><span class="No-Break"><span class="koboSpan" id="kobo.1558.1">the bond.</span></span></p>
<p><span class="koboSpan" id="kobo.1559.1">Additionally, there are a few technologies you need to be </span><span class="No-Break"><span class="koboSpan" id="kobo.1560.1">familiar with.</span></span></p>
<h3><span class="koboSpan" id="kobo.1561.1">MAC</span></h3>
<p><span class="koboSpan" id="kobo.1562.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.1563.1">Media Access Control</span></strong><span class="koboSpan" id="kobo.1564.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1565.1">MAC</span></strong><span class="koboSpan" id="kobo.1566.1">) address is a hardware identifier assigned to network interfaces such as Ethernet</span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.1567.1"> cards and Wi-Fi adapters for communication on a local network. </span><span class="koboSpan" id="kobo.1567.2">It is hardcoded into the network hardware during manufacturing and is used at the data link layer (Layer 2) of the OSI model. </span><span class="koboSpan" id="kobo.1567.3">One of the most important features of MAC addresses is that they must be unique. </span><span class="koboSpan" id="kobo.1567.4">Each MAC address is meant to be globally unique, and manufacturers bear the responsibility of ensuring that no two network interfaces have the same MAC address, though this can be a challenging task to accomplish in practice, especially in virtualized environments. </span><span class="koboSpan" id="kobo.1567.5">This can be an issue with networking, as duplicate MAC addresses on any network will cause issues. </span><span class="koboSpan" id="kobo.1567.6">Additionally, many of the bonding modes rely on MAC addresses to load </span><span class="No-Break"><span class="koboSpan" id="kobo.1568.1">balance traffic.</span></span></p>
<h3><span class="koboSpan" id="kobo.1569.1">Bonding modes</span></h3>
<p><span class="koboSpan" id="kobo.1570.1">Bonding modes refer to the various strategies </span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.1571.1">or algorithms used to determine how network traffic is distributed across the physical network interfaces that have been aggregated into a bonded interface using the Linux bonding driver. </span><span class="koboSpan" id="kobo.1571.2">These modes control the load-balancing and failover behavior of the bonded interface. </span><span class="koboSpan" id="kobo.1571.3">The choice of bonding mode depends on your specific network requirements and goals. </span><span class="koboSpan" id="kobo.1571.4">Here are some common</span><a id="_idIndexMarker615"/><span class="koboSpan" id="kobo.1572.1"> Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1">bonding modes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1">balance-rr</span></strong><span class="koboSpan" id="kobo.1575.1">: In this mode, outgoing network traffic is distributed evenly across the available network interfaces in a round-robin fashion. </span><span class="koboSpan" id="kobo.1575.2">It’s a simple load-balancing mode that provides improved outbound traffic performance but does not consider the state of the interfaces, which can lead to uneven inbound traffic distribution. </span><span class="koboSpan" id="kobo.1575.3">Occasionally, this mode does not work well with some </span><span class="No-Break"><span class="koboSpan" id="kobo.1576.1">switching systems.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">active-backup</span></strong><span class="koboSpan" id="kobo.1578.1">: A commonly used mode, which is often referred to as failover mode, this mode has a primary </span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.1579.1">interface, while the others remain on standby. </span><span class="koboSpan" id="kobo.1579.2">If the primary interface fails, the next available interface is automatically activated to ensure continuity. </span><span class="koboSpan" id="kobo.1579.3">This mode provides redundancy and is one of the easiest modes to get working in </span><span class="No-Break"><span class="koboSpan" id="kobo.1580.1">any environment.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">balance-xor</span></strong><span class="koboSpan" id="kobo.1582.1">: This mode utilizes a straightforward XOR operation to maintain a balance between the transmission and reception of data. </span><span class="koboSpan" id="kobo.1582.2">The process involves distributing traffic based on the MAC addresses of the source and destination. </span><span class="koboSpan" id="kobo.1582.3">This guarantees that packets between the same endpoints will always take the same path. </span><span class="koboSpan" id="kobo.1582.4">The primary purpose of this mode is to ensure fault tolerance. </span><span class="koboSpan" id="kobo.1582.5">Occasionally, this mode does not work well with some </span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">switching systems.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1584.1">balance-tlb</span></strong><span class="koboSpan" id="kobo.1585.1">: When operating in this mode, the outgoing traffic is distributed among all available interfaces based on their current load. </span><span class="koboSpan" id="kobo.1585.2">However, incoming traffic is not actively balanced, and it is only received by the active interface. </span><span class="koboSpan" id="kobo.1585.3">This mode is particularly</span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.1586.1"> useful when the switch does not support </span><strong class="bold"><span class="koboSpan" id="kobo.1587.1">Link Aggregation Control Protocol</span></strong><span class="koboSpan" id="kobo.1588.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1589.1">LACP</span></strong><span class="koboSpan" id="kobo.1590.1">). </span><span class="koboSpan" id="kobo.1590.2">Occasionally, this mode does not work well with some </span><span class="No-Break"><span class="koboSpan" id="kobo.1591.1">switching systems.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1592.1">balance-alb</span></strong><span class="koboSpan" id="kobo.1593.1">: This mode actively balances both incoming and outgoing traffic by considering the availability and load of each interface. </span><span class="koboSpan" id="kobo.1593.2">Occasionally, this mode does not work</span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.1594.1"> well with some </span><span class="No-Break"><span class="koboSpan" id="kobo.1595.1">switching systems.</span></span></li>
</ul>
<h3><span class="koboSpan" id="kobo.1596.1">LACP</span></h3>
<p><span class="koboSpan" id="kobo.1597.1">All of the preceding modes can operate</span><a id="_idIndexMarker619"/><span class="koboSpan" id="kobo.1598.1"> without any changes to the switches that the server is connected to. </span><span class="koboSpan" id="kobo.1598.2">However, there is another mode that is more commonly</span><a id="_idIndexMarker620"/><span class="koboSpan" id="kobo.1599.1"> used, called LACP. </span><span class="koboSpan" id="kobo.1599.2">LACP is the most complex mode used to aggregate multiple network</span><a id="_idIndexMarker621"/><span class="koboSpan" id="kobo.1600.1"> connections, usually Ethernet, into a single</span><a id="_idIndexMarker622"/><span class="koboSpan" id="kobo.1601.1"> high-bandwidth link. </span><span class="koboSpan" id="kobo.1601.2">This process is commonly known as link aggregation, NIC teaming, or bonding. </span><span class="koboSpan" id="kobo.1601.3">LACP is defined by the IEEE 802.3ad standard and is frequently used in enterprise and data center environments to enhance network performance, redundancy, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1">fault tolerance.</span></span></p>
<p><span class="koboSpan" id="kobo.1603.1">However, to utilize LACP, switches must be configured to use it. </span><span class="koboSpan" id="kobo.1603.2">As an administrator, it is essential to communicate your configuration requirements to ensure that the switch is configured in a compatible mode. </span><span class="koboSpan" id="kobo.1603.3">The configuration must match on both ends for LACP to work correctly. </span><span class="koboSpan" id="kobo.1603.4">Most enterprise-grade network switches and server NICs provide LACP support. </span><span class="koboSpan" id="kobo.1603.5">Key characteristics and features of LACP include </span><span class="No-Break"><span class="koboSpan" id="kobo.1604.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1605.1">Aggregated links</span></strong><span class="koboSpan" id="kobo.1606.1">: LACP enables the aggregation</span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.1607.1"> of multiple physical network</span><a id="_idIndexMarker624"/><span class="koboSpan" id="kobo.1608.1"> links into a single logical link, which appears as a single interface to </span><span class="No-Break"><span class="koboSpan" id="kobo.1609.1">network devices.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1610.1">Increased bandwidth</span></strong><span class="koboSpan" id="kobo.1611.1">: Aggregating multiple links with LACP can boost network bandwidth for bandwidth-intensive applications and server-to-switch connections. </span><span class="koboSpan" id="kobo.1611.2">However, each MAC-to-MAC connection is usually limited to the speed of a single member of the aggregated link. </span><span class="koboSpan" id="kobo.1611.3">If you have a host with two 1 Gb/s ports in the link, you will likely be unable to get more than 1 Gb/s of communication between the host and </span><span class="No-Break"><span class="koboSpan" id="kobo.1612.1">a client.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1613.1">Load balancing</span></strong><span class="koboSpan" id="kobo.1614.1">: LACP can distribute network traffic across aggregated links using various load-balancing algorithms, preventing network congestion on a single link while optimizing </span><span class="No-Break"><span class="koboSpan" id="kobo.1615.1">network utilization.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1616.1">Fault tolerance</span></strong><span class="koboSpan" id="kobo.1617.1">: In addition to providing increased bandwidth, LACP also offers redundancy and fault-tolerance capabilities. </span><span class="koboSpan" id="kobo.1617.2">If one physical link fails, LACP can automatically redirect traffic to the remaining active links, minimizing downtime and ensuring </span><span class="No-Break"><span class="koboSpan" id="kobo.1618.1">network availability.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1619.1">Dynamic protocol</span></strong><span class="koboSpan" id="kobo.1620.1">: LACP is a dynamic protocol that dynamically negotiates and establishes link aggregations between network devices using </span><span class="No-Break"><span class="koboSpan" id="kobo.1621.1">LACP frames.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1622.1">Modes</span></strong><span class="koboSpan" id="kobo.1623.1">: LACP supports two modes </span><span class="No-Break"><span class="koboSpan" id="kobo.1624.1">of operation:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1625.1">Active mode</span></strong><span class="koboSpan" id="kobo.1626.1">: In this mode, the device actively sends LACP frames to negotiate and establish </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">link aggregations.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1628.1">Passive mode</span></strong><span class="koboSpan" id="kobo.1629.1">: In passive mode, the device listens for LACP frames but does not actively send them. </span><span class="koboSpan" id="kobo.1629.2">It relies on the other end configured in active mode to initiate </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">the aggregation.</span></span></li></ul></li>
</ul>
<p><span class="koboSpan" id="kobo.1631.1">LACP is commonly used in scenarios</span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.1632.1"> where HA and network performance</span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.1633.1"> are critical, such as server-to-switch</span><a id="_idIndexMarker627"/><span class="koboSpan" id="kobo.1634.1"> connections, inter-switch links, and connections to </span><strong class="bold"><span class="koboSpan" id="kobo.1635.1">Storage Area Networks</span></strong><span class="koboSpan" id="kobo.1636.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1637.1">SANs</span></strong><span class="koboSpan" id="kobo.1638.1">). </span><span class="koboSpan" id="kobo.1638.2">It allows organizations to make efficient use of available network resources and improve </span><span class="No-Break"><span class="koboSpan" id="kobo.1639.1">network reliability.</span></span></p>
<h2 id="_idParaDest-152"><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.1640.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1641.1">For this recipe, you will need three Oracle Linux 8 systems, each with access to yum repos. </span><span class="koboSpan" id="kobo.1641.2">For this exercise, we will call them </span><strong class="source-inline"><span class="koboSpan" id="kobo.1642.1">networking</span></strong><span class="koboSpan" id="kobo.1643.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1644.1">client1</span></strong><span class="koboSpan" id="kobo.1645.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1646.1">client2</span></strong><span class="koboSpan" id="kobo.1647.1">. </span><span class="koboSpan" id="kobo.1647.2">They are mostly identical systems, each with 8 GB RAM, 4 vCPUs, and 100 GB of drive space. </span><span class="koboSpan" id="kobo.1647.3">The difference is that networking should have two network interfaces on the same network. </span><span class="koboSpan" id="kobo.1647.4">The filesystems have 50 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1648.1">/</span></strong><span class="koboSpan" id="kobo.1649.1">, 5 GB in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1650.1">/home</span></strong><span class="koboSpan" id="kobo.1651.1">, and 8 GB in swap. </span><span class="koboSpan" id="kobo.1651.2">The remaining disk space </span><span class="No-Break"><span class="koboSpan" id="kobo.1652.1">is unallocated.</span></span></p>
<h2 id="_idParaDest-153"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.1653.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1654.1">While this can be done from the GUI, this recipe will cover doing this from the command line. </span><span class="koboSpan" id="kobo.1654.2">As a note, when working on the main network connection to the server, you will want to be on the system console. </span><span class="koboSpan" id="kobo.1654.3">Doing this via a remote connection such as SSH can leave you in a situation where you lose access to the server. </span><span class="koboSpan" id="kobo.1654.4">Following are the steps to configure</span><a id="_idIndexMarker628"/><span class="koboSpan" id="kobo.1655.1"> a </span><span class="No-Break"><span class="koboSpan" id="kobo.1656.1">redundant connection.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1657.1">The first thing you will need to do is create the bond. </span><span class="koboSpan" id="kobo.1657.2">In this example, we will create it using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1658.1">balance-alb</span></strong><span class="koboSpan" id="kobo.1659.1"> mode to best balance both incoming and </span><span class="No-Break"><span class="koboSpan" id="kobo.1660.1">outgoing traf</span><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.1661.1">fic:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1662.1">nmcli connection add type bond con-name "Bond 0" ifname bond0 bond.options "mode=balance-alb"</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1663.1">Next, we will configure the bond to use DHCP. </span><span class="koboSpan" id="kobo.1663.2">On production servers, you would normally use a manually configured </span><span class="No-Break"><span class="koboSpan" id="kobo.1664.1">IP address:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1665.1">nmcli connection modify "Bond 0" ipv4.method auto</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1666.1">Add the adapters that will be members of the bond. </span><span class="koboSpan" id="kobo.1666.2">In this case, we will be using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1667.1">enp0s3</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1668.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1669.1">enp0s8</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1670.1">:</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1671.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1672.1">If you are adding a port into a bond that is already in use, you should delete that port now. </span><span class="koboSpan" id="kobo.1672.2">In this case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1673.1">enp0s3</span></strong><span class="koboSpan" id="kobo.1674.1"> was in use, so it was deleted with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1675.1">following command:</span></span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.1676.1">nmcli connection </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1677.1">del enp0s3</span></strong></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1678.1">nmcli connection add type ethernet slave-type bond con-name bond0-if1 ifname enp0s3 master bond0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1679.1">nmcli connection add type ethernet slave-type bond con-name bond0-if2 ifname enp0s8 master bond0</span></strong></pre> <ol>
<li value="4"><span class="koboSpan" id="kobo.1680.1">Now, we will start the connection and check </span><span class="No-Break"><span class="koboSpan" id="kobo.1681.1">the status:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1682.1">nmcli connection up "Bond 0"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1683.1">nmcli device</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1684.1">When completed, the output of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1685.1">nmcli device</span></strong><span class="koboSpan" id="kobo.1686.1"> command should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1687.1">the following:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.1688.1"><img alt="Figure 6.27 – nmcli device output with a working bind" src="image/B18349_06_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1689.1">Figure 6.27 – nmcli device output with a working bind</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1690.1">You can see </span><strong class="source-inline"><span class="koboSpan" id="kobo.1691.1">bond0</span></strong><span class="koboSpan" id="kobo.1692.1"> as the device, with members </span><strong class="source-inline"><span class="koboSpan" id="kobo.1693.1">enp0s3</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1694.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1695.1">enp0s8</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1697.1">When you look at the IP address, you will see that that is now on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1698.1">bond0</span></strong><span class="koboSpan" id="kobo.1699.1"> device. </span><span class="koboSpan" id="kobo.1699.2">This can be checked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1700.1">ifconfig bond0</span></strong><span class="koboSpan" id="kobo.1701.1"> command, with the output </span><span class="No-Break"><span class="koboSpan" id="kobo.1702.1">as follows:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.1703.1"><img alt="Figure 6.28 – Output from ifconfig bond0" src="image/B18349_06_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1704.1">Figure 6.28 – Output from ifconfig bond0</span></p>
<p><span class="koboSpan" id="kobo.1705.1">You can continue to use the system</span><a id="_idIndexMarker629"/><span class="koboSpan" id="kobo.1706.1"> normally now, but with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1707.1">bond0</span></strong><span class="koboSpan" id="kobo.1708.1"> being the </span><span class="No-Break"><span class="koboSpan" id="kobo.1709.1">network device.</span></span></p>
<h2 id="_idParaDest-154"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.1710.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1711.1">Now that we have a working</span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.1712.1"> bond, let’s look at the traffic going in and out. </span><span class="koboSpan" id="kobo.1712.2">To do this, we need to install the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1713.1">iptraf-ng</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1714.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1715.1">
dnf -y install iptraf-ng</span></pre> <p><span class="koboSpan" id="kobo.1716.1">This tool allows you to monitor Ethernet traffic on a server. </span><span class="koboSpan" id="kobo.1716.2">For this example, we will run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1717.1">iptraf-ng</span></strong><span class="koboSpan" id="kobo.1718.1"> command. </span><span class="koboSpan" id="kobo.1718.2">This will launch the program, and you will be on the main screen, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1719.1">following</span></span><span class="No-Break"><a id="_idIndexMarker631"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1720.1"> screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.1721.1"><img alt="Figure 6.29 – iptraf main menu" src="image/B18349_06_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1722.1">Figure 6.29 – iptraf main menu</span></p>
<p><span class="koboSpan" id="kobo.1723.1">From here, we will look at the </span><strong class="bold"><span class="koboSpan" id="kobo.1724.1">General interface statistics</span></strong><span class="koboSpan" id="kobo.1725.1"> by hitting the </span><em class="italic"><span class="koboSpan" id="kobo.1726.1">S</span></em><span class="koboSpan" id="kobo.1727.1"> key. </span><span class="koboSpan" id="kobo.1727.2">This will then show a real-time flow of traffic on </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">each interface:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.1729.1"><img alt="Figure 6.30 – General interface statistics" src="image/B18349_06_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1730.1">Figure 6.30 – General interface statistics</span></p>
<p><span class="koboSpan" id="kobo.1731.1">You can see that both in and out traffic is balanced between the two physical interfaces. </span><span class="koboSpan" id="kobo.1731.2">This is because the bond was built using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">balance-alb</span></strong><span class="koboSpan" id="kobo.1733.1"> mode. </span><span class="koboSpan" id="kobo.1733.2">To generate this traffic, a simple flood ping was used from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">client2</span></strong><span class="koboSpan" id="kobo.1735.1"> system. </span><span class="koboSpan" id="kobo.1735.2">This was done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1736.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1737.1">
ping -f 192.168.200.179</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.1738.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1739.1">Be careful using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1740.1">-f</span></strong><span class="koboSpan" id="kobo.1741.1"> option, as this will flood the network with traffic, and it is generally not acceptable to do so on production networks without coordinating with the network and security teams. </span><span class="koboSpan" id="kobo.1741.2">It can cause performance issues for systems using </span><span class="No-Break"><span class="koboSpan" id="kobo.1742.1">the network.</span></span></p>
<p><span class="koboSpan" id="kobo.1743.1">There is a better way to really stress the network, though. </span><span class="koboSpan" id="kobo.1743.2">That is to use a tool that will generate the maximum levels of packets the interface </span><span class="No-Break"><span class="koboSpan" id="kobo.1744.1">will support.</span></span></p>
<h3><span class="koboSpan" id="kobo.1745.1">iperf – network stress tool</span></h3>
<p><span class="koboSpan" id="kobo.1746.1">We will use a tool called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1747.1">iperf</span></strong><span class="koboSpan" id="kobo.1748.1">. </span><span class="koboSpan" id="kobo.1748.2">It will generate</span><a id="_idIndexMarker632"/><span class="koboSpan" id="kobo.1749.1"> the maximum amount of traffic that the interface can support. </span><span class="koboSpan" id="kobo.1749.2">To install </span><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">iperf</span></strong><span class="koboSpan" id="kobo.1751.1">, run the following command on </span><span class="No-Break"><span class="koboSpan" id="kobo.1752.1">all systems:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1753.1">
dnf –y install iperf3</span></pre> <p><span class="koboSpan" id="kobo.1754.1">We also will need to open up a TCP port for the system to use and reload the firewall. </span><span class="koboSpan" id="kobo.1754.2">Each instance of the server can only handle a single client connection. </span><span class="koboSpan" id="kobo.1754.3">We will add multiple ports to enable running multiple servers, each with a different port. </span><span class="koboSpan" id="kobo.1754.4">This is done with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1755.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1756.1">
firewall-cmd --permanent --add-port=8000-8010/tcp
firewall-cmd --reload</span></pre> <p><strong class="source-inline"><span class="koboSpan" id="kobo.1757.1">iperf</span></strong><span class="koboSpan" id="kobo.1758.1"> works using a client-server model. </span><span class="koboSpan" id="kobo.1758.2">In order to use it, we first need to start an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1759.1">iperf</span></strong><span class="koboSpan" id="kobo.1760.1"> server on the networking system. </span><span class="koboSpan" id="kobo.1760.2">With this example, we will set up the server to listen on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1761.1">8001</span></strong><span class="koboSpan" id="kobo.1762.1"> using TCP. </span><span class="koboSpan" id="kobo.1762.2">This is started with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1763.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1764.1">
[root@networking ~]# iperf3 -s -p 8001
-----------------------------------------------------------
Server listening on 8001
-----------------------------------------------------------</span></pre> <p><span class="koboSpan" id="kobo.1765.1">We will repeat the same command in a different window, running on port </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1766.1">8002</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1767.1"> instead:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1768.1">
[root@networking ~]# iperf3 -s -p 8002
-----------------------------------------------------------
Server listening on 8002
-----------------------------------------------------------</span></pre> <p><span class="koboSpan" id="kobo.1769.1">Now, with two servers running, we can run a test </span><span class="No-Break"><span class="koboSpan" id="kobo.1770.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1771.1">client1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1772.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1773.1">The test is run with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1774.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1775.1">
iperf -c 192.168.200.179 -p 8001</span></pre> <p><span class="koboSpan" id="kobo.1776.1">The test will kick off and for a few seconds</span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.1777.1"> run the maximum traffic possible, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1778.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.1779.1"><img alt="Figure 6.31 – iperf client output" src="image/B18349_06_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1780.1">Figure 6.31 – iperf client output</span></p>
<p><span class="koboSpan" id="kobo.1781.1">While the test runs, we can monitor the performance from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1782.1">iptraf</span></strong><span class="koboSpan" id="kobo.1783.1"> command, and we will see most of the traffic is hitting a single interface. </span><span class="koboSpan" id="kobo.1783.2">This is seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1784.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer180">
<span class="koboSpan" id="kobo.1785.1"><img alt="Figure 6.32 – Single-client traffic" src="image/B18349_06_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1786.1">Figure 6.32 – Single-client traffic</span></p>
<p><span class="koboSpan" id="kobo.1787.1">This traffic is all on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">enp0s8</span></strong><span class="koboSpan" id="kobo.1789.1"> interface. </span><span class="koboSpan" id="kobo.1789.2">This is because the load-balancing algorithm uses the MAC address of the client. </span><span class="koboSpan" id="kobo.1789.3">This limits the traffic to a single interface in </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">the bond.</span></span></p>
<p><span class="koboSpan" id="kobo.1791.1">Next up, can run a test from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">client1</span></strong><span class="koboSpan" id="kobo.1793.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1794.1">client2</span></strong><span class="koboSpan" id="kobo.1795.1"> simultaneously. </span><span class="koboSpan" id="kobo.1795.2">The difference is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">client2</span></strong><span class="koboSpan" id="kobo.1797.1"> will use port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">8002</span></strong><span class="koboSpan" id="kobo.1799.1">. </span><span class="koboSpan" id="kobo.1799.2">The results are seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer181">
<span class="koboSpan" id="kobo.1801.1"><img alt="Figure 6.33 – Test with two different clients" src="image/B18349_06_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1802.1">Figure 6.33 – Test with two different clients</span></p>
<p><span class="koboSpan" id="kobo.1803.1">Here, we can see that both interfaces are being used for heavy network loads. </span><span class="koboSpan" id="kobo.1803.2">This is happening because each client is using a different MAC address. </span><span class="koboSpan" id="kobo.1803.3">If a third client were used, we would then see it competing for traffic for one of the interfaces, potentially </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1">causing issues.</span></span></p>
<p><span class="koboSpan" id="kobo.1805.1">This is an important factor</span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.1806.1"> to consider when bonding in environments where heavy network performance is required from multiple clients. </span><span class="koboSpan" id="kobo.1806.2">When using bonds, and you have random performance latency issues, monitor the ports. </span><span class="koboSpan" id="kobo.1806.3">You might face some contention. </span><span class="koboSpan" id="kobo.1806.4">One way to address this is to add additional ports to the bond. </span><span class="koboSpan" id="kobo.1806.5">You can also upgrade the interfaces to units that can support </span><span class="No-Break"><span class="koboSpan" id="kobo.1807.1">more bandwidth.</span></span></p>
</div>
</body></html>