<html><head></head><body>
<div id="_idContainer015">
<h1 class="chapter-number" id="_idParaDest-25"><a id="_idTextAnchor031"/><span class="koboSpan" id="kobo.1.1">2</span></h1>
<h1 id="_idParaDest-26"><a id="_idTextAnchor032"/><span class="koboSpan" id="kobo.2.1">Baking Our First Poky-Based System</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Let’s get our hands dirty! </span><span class="koboSpan" id="kobo.3.2">In this chapter, we will understand the basic concepts involved in the Poky workflow. </span><span class="koboSpan" id="kobo.3.3">We will cover the steps to download, configure, and prepare the Poky build environment and bake something usable. </span><span class="koboSpan" id="kobo.3.4">The steps covered here are common for testing and development. </span><span class="koboSpan" id="kobo.3.5">They will give us some experience using Poky and a taste of </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">its capabilities.</span></span></p>
<h1 id="_idParaDest-27"><a id="_idTextAnchor033"/><span class="koboSpan" id="kobo.5.1">Preparing the build host system</span></h1>
<p><span class="koboSpan" id="kobo.6.1">This section describes how </span><a id="_idIndexMarker027"/><span class="koboSpan" id="kobo.7.1">to prepare Windows and Linux distribution host systems. </span><span class="koboSpan" id="kobo.7.2">Although we will describe the Windows steps, we will focus on using a Linux distribution </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">host system.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.9.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.10.1">The use of macOS as a host system is </span><a id="_idIndexMarker028"/><span class="koboSpan" id="kobo.11.1">possible. </span><span class="koboSpan" id="kobo.11.2">Still, it involves using the </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">CROss PlatformS</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.14.1">CROPS</span></strong><span class="koboSpan" id="kobo.15.1">) framework, which leverages Docker, allowing the use of foreign operating systems, including macOS. </span><span class="koboSpan" id="kobo.15.2">For more information, you can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.16.1">Setting Up to Use CROss PlatformS (CROPS)</span></em><span class="koboSpan" id="kobo.17.1"> section from the </span><em class="italic"><span class="koboSpan" id="kobo.18.1">Yocto Project Development Tasks </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.19.1">Manual</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.20.1"> (</span></span><a href="https://docs.yoctoproject.org/4.0.4/dev-manual/start.html#setting-up-to-use-cross-platforms-crops"><span class="No-Break"><span class="koboSpan" id="kobo.21.1">https://docs.yoctoproject.org/4.0.4/dev-manual/start.html#setting-up-to-use-cross-platforms-crops</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.22.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">Next, we will provide the necessary information to start the build host </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">system preparation.</span></span></p>
<h2 id="_idParaDest-28"><a id="_idTextAnchor034"/><span class="koboSpan" id="kobo.25.1">Using Windows Subsystem for Linux (WSLv2)</span></h2>
<p><span class="koboSpan" id="kobo.26.1">You can set up a Linux </span><a id="_idIndexMarker029"/><span class="koboSpan" id="kobo.27.1">distribution on Windows if you are a Windows user. </span><span class="koboSpan" id="kobo.27.2">WSLv2 is only </span><a id="_idIndexMarker030"/><span class="koboSpan" id="kobo.28.1">available for Windows 10+ builds greater than 18917. </span><span class="koboSpan" id="kobo.28.2">WSLv2 allows development using the Yocto Project. </span><span class="koboSpan" id="kobo.28.3">You can install the Linux distribution from the </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">Microsoft Store.</span></span></p>
<p><span class="koboSpan" id="kobo.30.1">Please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.31.1">Setting Up to Use Windows Subsystem For Linux</span></em><span class="koboSpan" id="kobo.32.1"> session (</span><a href="https://docs.yoctoproject.org/4.0.4/dev-manual/start.html#setting-up-to-use-windows-subsystem-for-linux-wslv2"><span class="koboSpan" id="kobo.33.1">https://docs.yoctoproject.org/4.0.4/dev-manual/start.html#setting-up-to-use-windows-subsystem-for-linux-wslv2</span></a><span class="koboSpan" id="kobo.34.1">) from the </span><em class="italic"><span class="koboSpan" id="kobo.35.1">Yocto Project Development Tasks Manual</span></em><span class="koboSpan" id="kobo.36.1"> (</span><a href="https://docs.yoctoproject.org/4.0.4/dev-manual/index.html"><span class="koboSpan" id="kobo.37.1">https://docs.yoctoproject.org/4.0.4/dev-manual/index.html</span></a><span class="koboSpan" id="kobo.38.1">). </span><span class="koboSpan" id="kobo.38.2">Once you have WSLv2 set up, you can follow the </span><a id="_idIndexMarker031"/><span class="koboSpan" id="kobo.39.1">next sections as if you were running on a native </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">Linux machine.</span></span></p>
<h2 id="_idParaDest-29"><a id="_idTextAnchor035"/><span class="koboSpan" id="kobo.41.1">Preparing a Linux-based system</span></h2>
<p><span class="koboSpan" id="kobo.42.1">The process needed to set up our host system depends on the Linux distribution we use. </span><span class="koboSpan" id="kobo.42.2">Poky has a set of </span><a id="_idIndexMarker032"/><span class="koboSpan" id="kobo.43.1">supported Linux distributions. </span><span class="koboSpan" id="kobo.43.2">Let’s suppose we are new to embedded Linux development. </span><span class="koboSpan" id="kobo.43.3">In that case, it is advisable to use one of the supported Linux distributions to avoid wasting time debugging issues related to the host </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">system support.</span></span></p>
<p><span class="koboSpan" id="kobo.45.1">If you use the current release of one of the following distributions, you should be good to start using the Yocto Project on </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">your machine:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.47.1">Ubuntu</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.48.1">Fedora</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.49.1">CentOS</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.50.1">AlmaLinux</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.51.1">Debian</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.52.1">OpenSUSE</span><a id="_idTextAnchor036"/><span class="koboSpan" id="kobo.53.1"> Leap</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.54.1">To confirm whether your version is supported, it is advisable to check the official documentation online in the </span><em class="italic"><span class="koboSpan" id="kobo.55.1">Required Packages for the Build Host</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.56.1">section (</span></span><a href="https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-packages-for-the-build-host"><span class="No-Break"><span class="koboSpan" id="kobo.57.1">https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-packages-for-the-build-host</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.58.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">If your preferred distribution is not in the preceding list, it doesn’t mean it is not possible to use Poky on it. </span><span class="koboSpan" id="kobo.59.2">Your host development system must meet some specific versions for Git, tar, Python, and GCC. </span><span class="koboSpan" id="kobo.59.3">Your Linux distributions should provide compatible versions of those base tools. </span><span class="koboSpan" id="kobo.59.4">However, there is a chance that your host development system does not meet all these requirements. </span><span class="koboSpan" id="kobo.59.5">In that case, you can resolve this by installing a </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">buildtools</span></strong><span class="koboSpan" id="kobo.61.1"> tarball that</span><a id="_idIndexMarker033"/><span class="koboSpan" id="kobo.62.1"> contains these tools, as detailed in </span><em class="italic"><span class="koboSpan" id="kobo.63.1">Required Git, tar, Python, and GCC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.64.1">Versions</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.65.1"> (</span></span><a href="https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-git-tar-python-and-gcc-versions"><span class="No-Break"><span class="koboSpan" id="kobo.66.1">https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-git-tar-python-and-gcc-versions</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.67.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.68.1">We must install a few packages on the host system. </span><span class="koboSpan" id="kobo.68.2">This book provides instructions for </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">Debian</span></strong><span class="koboSpan" id="kobo.70.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">Fedora</span></strong><span class="koboSpan" id="kobo.72.1">, our preferred distributions, which we will look at next. </span><span class="koboSpan" id="kobo.72.2">The set of packages for other supported </span><a id="_idIndexMarker034"/><span class="koboSpan" id="kobo.73.1">distributions can be found in the </span><em class="italic"><span class="koboSpan" id="kobo.74.1">Yocto Project Reference </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.75.1">Manual</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.76.1"> (</span></span><a href="https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-packages-for-the-build-host"><span class="No-Break"><span class="koboSpan" id="kobo.77.1">https://docs.yoctoproject.org/4.0.4/ref-manual/system-requirements.html#required-packages-for-the-build-host</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.78.1">).</span></span></p>
<h3><span class="koboSpan" id="kobo.79.1">Debian-based distribution</span></h3>
<p><span class="koboSpan" id="kobo.80.1">To install the necessary</span><a id="_idIndexMarker035"/><span class="koboSpan" id="kobo.81.1"> packages for a headless host system, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.83.1">
$ sudo apt install gawk wget git diffstat unzip texinfo gcc build-essential chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev pylint3 xterm python3-subunit mesa-common-dev zstd liblz4-tool</span></pre>
<h3><span class="koboSpan" id="kobo.84.1">Fedora</span></h3>
<p><span class="koboSpan" id="kobo.85.1">To install the needed packages for </span><a id="_idIndexMarker036"/><span class="koboSpan" id="kobo.86.1">a headless host system, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.88.1">
$ sudo dnf install gawk make wget tar bzip2 gzip python3 unzip perl patch diffutils diffstat git cpp gcc gcc-c++ glibc-devel texinfo chrpath ccache perl-Data-Dumper perl-Text-ParseWords perl-Thread-Queue perl-bignum socat python3-pexpect findutils which file cpio python python3-pip xz python3-GitPython python3-jinja2 SDL-devel xterm rpcgen mesa-libGL-devel perl-FindBin perl-File-Compare perl-File-Copy perl-locale</span><a id="_idTextAnchor037"/><a id="_idTextAnchor038"/><a id="_idTextAnchor039"/><span class="koboSpan" id="kobo.89.1"> zstd lz4</span></pre>
<h1 id="_idParaDest-30"><a id="_idTextAnchor040"/><span class="koboSpan" id="kobo.90.1">Downloading the Poky source code</span></h1>
<p><span class="koboSpan" id="kobo.91.1">After we have </span><a id="_idIndexMarker037"/><span class="koboSpan" id="kobo.92.1">installed the required packages on our development host system, we can download the current LTS version (at the time of writing) of Poky source code using Git, with the </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.94.1">$ git clone https://git.yoctoproject.org/poky -b kirkstone</span></strong></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.95.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.96.1">Learn more </span><a id="_idIndexMarker038"/><span class="koboSpan" id="kobo.97.1">about Git </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">at </span></span><a href="https://git-scm.com"><span class="No-Break"><span class="koboSpan" id="kobo.99.1">https://git-scm.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.100.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">After the download </span><a id="_idIndexMarker039"/><span class="koboSpan" id="kobo.102.1">process is complete, we should have the following contents inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">poky</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.104.1"> directory:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer009">
<span class="koboSpan" id="kobo.105.1"><img alt="Figure 2.1 – The content of the ﻿poky directory after downloading" src="image/Figure_2.1_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.106.1">Figure 2.1 – The content of the poky directory after downloading</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.107.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.108.1">The examples and code presented in this and subsequent chapters use the Yocto Project 4.0 release (codenamed </span><strong class="bold"><span class="koboSpan" id="kobo.109.1">Kirkstone</span></strong><span class="koboSpan" id="kobo.110.1">) as </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">a</span><a id="_idTextAnchor041"/><a id="_idTextAnchor042"/><span class="koboSpan" id="kobo.112.1"> reference.</span></span></p>
<h1 id="_idParaDest-31"><a id="_idTextAnchor043"/><span class="koboSpan" id="kobo.113.1">Preparing the build environment</span></h1>
<p><span class="koboSpan" id="kobo.114.1">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">poky</span></strong><span class="koboSpan" id="kobo.116.1"> directory exists</span><a id="_idIndexMarker040"/><span class="koboSpan" id="kobo.117.1"> a script named </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">oe-init-build-env</span></strong><span class="koboSpan" id="kobo.119.1">, which sets up the building environment. </span><span class="koboSpan" id="kobo.119.2">But first, the script must be run-sourced (not executed) </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.121.1">
$ source oe-init-build-env [build-directory]</span></pre>
<p><span class="koboSpan" id="kobo.122.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">[build-directory]</span></strong><span class="koboSpan" id="kobo.124.1"> is an optional parameter for the name of the directory where the environment is configured. </span><span class="koboSpan" id="kobo.124.2">If it is empty, it defaults to </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">build</span></strong><span class="koboSpan" id="kobo.126.1">. </span><span class="koboSpan" id="kobo.126.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">[build-directory]</span></strong><span class="koboSpan" id="kobo.128.1"> parameter is the place where we perform </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">the builds.</span></span></p>
<p><span class="koboSpan" id="kobo.130.1">The output from </span><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">source oe-init-build-env build</span></strong><span class="koboSpan" id="kobo.132.1"> displays some important configurations such as the file location, some project URLs, and some common targets, such as available images. </span><span class="koboSpan" id="kobo.132.2">The following figure shows an </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">output example:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer010">
<span class="koboSpan" id="kobo.134.1"><img alt="Figure 2.2 – Output of the source oe-init-build-env build command" src="image/Figure_2.2_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.135.1">Figure 2.2 – Output of the source oe-init-build-env build command</span></p>
<p><span class="koboSpan" id="kobo.136.1">It is very convenient to </span><a id="_idIndexMarker041"/><span class="koboSpan" id="kobo.137.1">use different build directories. </span><span class="koboSpan" id="kobo.137.2">We can work on separate projects in parallel or experimental setups without affecting our </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">other builds.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.139.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.140.1">Throughout the book, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">build</span></strong><span class="koboSpan" id="kobo.142.1"> as the build directory. </span><span class="koboSpan" id="kobo.142.2">When we need to point to a file inside the build directory, we will adopt the same convention – for </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">build/conf</span><a id="_idTextAnchor044"/><a id="_idTextAnchor045"/><span class="koboSpan" id="kobo.145.1">/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">.</span></span></p>
<h1 id="_idParaDest-32"><a id="_idTextAnchor046"/><span class="koboSpan" id="kobo.147.1">Knowing the local.conf file</span></h1>
<p><span class="koboSpan" id="kobo.148.1">When we initialize a build environment, it creates a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.150.1">. </span><span class="koboSpan" id="kobo.150.2">This config file is powerful, since it can configure almost every aspect of the build </span><a id="_idIndexMarker042"/><span class="koboSpan" id="kobo.151.1">process. </span><span class="koboSpan" id="kobo.151.2">We can set the target machine and the toolchain host architecture to be used for a custom cross-toolchain, optimize options for maximum build time reduction, and so on. </span><span class="koboSpan" id="kobo.151.3">The comments inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.153.1"> file are excellent documentation and a reference of the possible variables and their defaults. </span><span class="koboSpan" id="kobo.153.2">The minimal set of variables that we probably want to change from the default is </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.155.1">
MACHINE ??= "qemux86-64"</span></pre>
<p><span class="koboSpan" id="kobo.156.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">MACHINE</span></strong><span class="koboSpan" id="kobo.158.1"> variable is where we determine the target machine we wish to build. </span><span class="koboSpan" id="kobo.158.2">At the time of writing, Poky supports the following machines in its </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">reference BSP:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">beaglebone-yocto</span></strong><span class="koboSpan" id="kobo.161.1">: This is BeagleBone, which is the reference platform for </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">32-bit ARM</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">genericx86</span></strong><span class="koboSpan" id="kobo.164.1">: This is generic support for 32-bit </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">x86-based machines</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">genericx86-64:</span></strong><span class="koboSpan" id="kobo.167.1"> This is generic support for 64-bit </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">x86-based machines</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">edgerouter</span></strong><span class="koboSpan" id="kobo.170.1">: This is EdgeRouter Lite, which is the reference platform fo</span><a id="_idTextAnchor047"/><span class="koboSpan" id="kobo.171.1">r </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">64-bit MIPS</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.173.1">The machines are made available by a layer called </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">meta-yocto-bsp</span></strong><span class="koboSpan" id="kobo.175.1">. </span><span class="koboSpan" id="kobo.175.2">Besides these machines, OpenEmbedded Core, inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">meta</span></strong><span class="koboSpan" id="kobo.177.1"> directory, also provides support for the following Quick Emulation (</span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">QEMU) machines:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">qemuarm</span></strong><span class="koboSpan" id="kobo.180.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">ARMv7 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">qemuarmv5</span></strong><span class="koboSpan" id="kobo.183.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">ARMv5 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">qemuarm64</span></strong><span class="koboSpan" id="kobo.186.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">ARMv8 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">qemumips</span></strong><span class="koboSpan" id="kobo.189.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">MIPS emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">qemumips64</span></strong><span class="koboSpan" id="kobo.192.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">MIPS64 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">qemuppc</span></strong><span class="koboSpan" id="kobo.195.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">PowerPC emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">qemuppc64</span></strong><span class="koboSpan" id="kobo.198.1">: This is the QEMU PowerPC </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">64 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">qemux86-64</span></strong><span class="koboSpan" id="kobo.201.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">x86-64 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">qemux86</span></strong><span class="koboSpan" id="kobo.204.1">: This is the QEMU </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">x86 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">qemuriscv32</span></strong><span class="koboSpan" id="kobo.207.1">: This is the QEMU RISC-V </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">32 emulation</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">qemuriscv64</span></strong><span class="koboSpan" id="kobo.210.1">: This is the QEMU RISC-V </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">64 emulation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.212.1">Extra BSP layers</span><a id="_idIndexMarker043"/><span class="koboSpan" id="kobo.213.1"> available from several vendors provide support for other machines. </span><span class="koboSpan" id="kobo.213.2">The process of using an extra BSP layer is shown in </span><a href="B19361_11.xhtml#_idTextAnchor140"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.214.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.215.1">, </span><em class="italic"><span class="koboSpan" id="kobo.216.1">Exploring </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.217.1">External Layers</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.219.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.220.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">local.conf</span></strong><span class="koboSpan" id="kobo.222.1"> file is a convenient way to override several global default configurations throughout the Yocto Project’s tools. </span><span class="koboSpan" id="kobo.222.2">Essentially, we can change or set any variable – for example, adding additional packages to an image file. </span><span class="koboSpan" id="kobo.222.3">Changing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.224.1"> file is convenient; however, the source code management system usually does not track temporary changes in </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">this directory.</span></span></p>
<p><span class="koboSpan" id="kobo.226.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.228.1"> file can set several variables. </span><span class="koboSpan" id="kobo.228.2">It is worth taking some time and reading through the file comments that are generated to get a general idea of what variabl</span><a id="_idTextAnchor048"/><span class="koboSpan" id="kobo.229.1">es can </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">be set.</span></span></p>
<h1 id="_idParaDest-33"><a id="_idTextAnchor049"/><span class="koboSpan" id="kobo.231.1">Building a target image</span></h1>
<p><span class="koboSpan" id="kobo.232.1">Poky provides</span><a id="_idIndexMarker044"/><span class="koboSpan" id="kobo.233.1"> several predesigned image recipes we can use to build our binary image. </span><span class="koboSpan" id="kobo.233.2">We can check the list of available images by running the following command from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">poky</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.235.1"> directory:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.236.1">
$ ls meta*/recipes*/*images/*.bb</span></pre>
<p><span class="koboSpan" id="kobo.237.1">All the recipes provide images that are a set of unpacked and configured packages, generating a filesystem that we can use with hardware or one of the supported </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">QEMU machines.</span></span></p>
<p><span class="koboSpan" id="kobo.239.1">Next, we can see the list of most commonly </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">used images:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">core</span><a id="_idTextAnchor050"/><span class="koboSpan" id="kobo.242.1">-image-minimal</span></strong><span class="koboSpan" id="kobo.243.1">: This is a small image allowing a device to boot. </span><span class="koboSpan" id="kobo.243.2">It is handy for kernel and bootloader tests </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">and development.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">core-image-base</span></strong><span class="koboSpan" id="kobo.246.1">: This console-only image provides basic hardware support for the </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">target device.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">core-image-weston</span></strong><span class="koboSpan" id="kobo.249.1">: This image provides the Wayland protocol libraries and the reference </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">Weston compositor.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">core-image-x11</span></strong><span class="koboSpan" id="kobo.252.1">: This is a basic X11 image with </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">a terminal.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">core-image-sato</span></strong><span class="koboSpan" id="kobo.255.1">: This is an image with Sato support and a mobile environment for mobile devices that use X11. </span><span class="koboSpan" id="kobo.255.2">It provides applications such as a terminal, editor, file manager, media player, and </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">so on.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">core-image-full-cmdline</span></strong><span class="koboSpan" id="kobo.258.1">: A console-only image with more full-featured Linux system </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">functionality installed.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.260.1">There are other</span><a id="_idIndexMarker045"/><span class="koboSpan" id="kobo.261.1"> reference images available from the community. </span><span class="koboSpan" id="kobo.261.2">Several images support features, such as Real Time, </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">initramfs</span></strong><span class="koboSpan" id="kobo.263.1">, and MTD (flash tools). </span><span class="koboSpan" id="kobo.263.2">It is good to check the source code or the </span><em class="italic"><span class="koboSpan" id="kobo.264.1">Yocto Project Reference Manual</span></em><span class="koboSpan" id="kobo.265.1"> (</span><a href="https://docs.yoctoproject.org/4.0.4/ref-manual/index.html"><span class="koboSpan" id="kobo.266.1">https://docs.yoctoproject.org/4.0.4/ref-manual/index.html</span></a><span class="koboSpan" id="kobo.267.1">) for the complete and </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">updated list.</span></span></p>
<p><span class="koboSpan" id="kobo.269.1">The process of building an image for a target is straightforward. </span><span class="koboSpan" id="kobo.269.2">But first, we need to set up the build environment using </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">source oe-init-build-env [build-directory]</span></strong><span class="koboSpan" id="kobo.271.1"> before using BitBake. </span><span class="koboSpan" id="kobo.271.2">To build the image, we can use the template in the </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer011">
<span class="koboSpan" id="kobo.273.1"><img alt="Figure 2.3 – How to build a recipe using BitBake" src="image/Figure_2.3_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.274.1">Figure 2.3 – How to build a recipe using BitBake</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.275.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.276.1">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">MACHINE = "qemux86-64"</span></strong><span class="koboSpan" id="kobo.278.1"> in the following examples. </span><span class="koboSpan" id="kobo.278.2">You can set it in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.280.1"> accordingly.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">For example, to build </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">core-image-full-cmdline</span></strong><span class="koboSpan" id="kobo.283.1">, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.285.1">
$ bitbake core-image-full-cmdline</span></pre>
<p><span class="koboSpan" id="kobo.286.1">The Poky build </span><a id="_idIndexMarker046"/><span class="koboSpan" id="kobo.287.1">looks like the </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer012">
<span class="koboSpan" id="kobo.289.1"><img alt="Figure 2.4 – The result of bitbake core-ima﻿﻿ge-full-cmdline" src="image/Figure_2.4_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.290.1">Figure 2.4 – The result of bitbake core-ima</span><a id="_idTextAnchor051"/><a id="_idTextAnchor052"/><span class="koboSpan" id="kobo.291.1">ge-full-cmdline</span></p>
<h1 id="_idParaDest-34"><a id="_idTextAnchor053"/><span class="koboSpan" id="kobo.292.1">Running images in QEMU</span></h1>
<p><span class="koboSpan" id="kobo.293.1">We can use hardware </span><a id="_idIndexMarker047"/><span class="koboSpan" id="kobo.294.1">emulation to speed up the</span><a id="_idIndexMarker048"/><span class="koboSpan" id="kobo.295.1"> development process, as it enables a test run without involving any actual hardware. </span><span class="koboSpan" id="kobo.295.2">Fortunately, most projects have only a tiny portion that </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">is hardware-dependent.</span></span></p>
<p><span class="koboSpan" id="kobo.297.1">QEMU is a free, open source software package that performs hardware virtualization. </span><span class="koboSpan" id="kobo.297.2">QEMU-based machines allow testing and development without real hardware. </span><span class="koboSpan" id="kobo.297.3">ARMv5, ARMv7, ARMv8, MIPS, MIPS64, PowerPC, PowerPC 64, RISC-V 32, RISC-V 64, x86, and x86-64 emulations are currently supported. </span><span class="koboSpan" id="kobo.297.4">We will go into more detail about QEMU usage in </span><em class="italic"><span class="koboSpan" id="kobo.298.1">sw</span></em><span class="koboSpan" id="kobo.299.1">, </span><em class="italic"><span class="koboSpan" id="kobo.300.1">Speeding Up Product Development through Emulation – </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.301.1">QEMU</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.303.1">OpenEmbedded Core </span><a id="_idIndexMarker049"/><span class="koboSpan" id="kobo.304.1">provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">runqemu</span></strong><span class="koboSpan" id="kobo.306.1"> script tool, which is a wrapper to make use of QEMU easier. </span><span class="koboSpan" id="kobo.306.2">The way to run the script tool is </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">as</span></span><span class="No-Break"><a id="_idIndexMarker050"/></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1"> follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.309.1">
$ runqemu &lt;machine&gt; &lt;zimage&gt; &lt;filesystem&gt;</span></pre>
<p><span class="koboSpan" id="kobo.310.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">&lt;machine&gt;</span></strong><span class="koboSpan" id="kobo.312.1"> is the machine/architecture to be used as </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">qemux86-64</span></strong><span class="koboSpan" id="kobo.314.1">, or any other supported machine. </span><span class="koboSpan" id="kobo.314.2">Also, </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">&lt;zimage&gt;</span></strong><span class="koboSpan" id="kobo.316.1"> is the path to a kernel (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">bzImage-qemux86-64.bin</span></strong><span class="koboSpan" id="kobo.318.1">). </span><span class="koboSpan" id="kobo.318.2">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">&lt;filesystem&gt;</span></strong><span class="koboSpan" id="kobo.320.1"> is the path to an </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">ext4</span></strong><span class="koboSpan" id="kobo.322.1"> image (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">filesystem-qemux86-64.ext4</span></strong><span class="koboSpan" id="kobo.324.1">) or an NFS directory. </span><span class="koboSpan" id="kobo.324.2">All parameters in the preceding call to </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">runqemu</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.326.1">&lt;zimage&gt;</span></strong><span class="koboSpan" id="kobo.327.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">&lt;filesystem&gt;</span></strong><span class="koboSpan" id="kobo.329.1"> are optional. </span><span class="koboSpan" id="kobo.329.2">Just running </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">runqemu</span></strong><span class="koboSpan" id="kobo.331.1"> is sufficient to launch the image in the shell where the build environment is set, as it will automatically pick up the default settings from building </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">the environment.</span></span></p>
<p><span class="koboSpan" id="kobo.333.1">So, for example, if we run </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">runqemu qemux86-64 core-image-full-cmdline</span></strong><span class="koboSpan" id="kobo.335.1">, we can see something similar to that shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer013">
<span class="koboSpan" id="kobo.337.1"><img alt="Figure 2.5 – The QEMU screen during the Linux kernel boot" src="image/Figure_2.5_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.338.1">Figure 2.5 – The QEMU screen during the Linux kernel boot</span></p>
<p><span class="koboSpan" id="kobo.339.1">After finishing booting </span><a id="_idIndexMarker051"/><span class="koboSpan" id="kobo.340.1">Linux, you will see a login</span><a id="_idIndexMarker052"/><span class="koboSpan" id="kobo.341.1"> prompt, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.342.1">Figure 2</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.343.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer014">
<span class="koboSpan" id="kobo.345.1"><img alt="Figure 2.6 – The QEMU screen during user login" src="image/Figure_2.6_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.346.1">Figure 2.6 – The QEMU screen during user login</span></p>
<p><span class="koboSpan" id="kobo.347.1">We can log in to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">root</span></strong><span class="koboSpan" id="kobo.349.1"> account</span><a id="_idIndexMarker053"/><span class="koboSpan" id="kobo.350.1"> using an empty password. </span><span class="koboSpan" id="kobo.350.2">The system behaves as a regular machine, even when executed inside the QEMU. </span><span class="koboSpan" id="kobo.350.3">The process to deploy an image in real hardware varies, depending on the type of storage used, the bootloader, and so on. </span><span class="koboSpan" id="kobo.350.4">However, the </span><a id="_idIndexMarker054"/><span class="koboSpan" id="kobo.351.1">process of generating the image is the same. </span><span class="koboSpan" id="kobo.351.2">We explore how to build and run an image in real hardware in </span><a href="B19361_15.xhtml#_idTextAnchor182"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.352.1">Chapter 15</span></em></span></a><span class="koboSpan" id="kobo.353.1">, </span><em class="italic"><span class="koboSpan" id="kobo.354.1">Booting Our C</span><a id="_idTextAnchor054"/><span class="koboSpan" id="kobo.355.1">ustom </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.356.1">Embedded Linux</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">.</span></span></p>
<h1 id="_idParaDest-35"><a id="_idTextAnchor055"/><span class="koboSpan" id="kobo.358.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.359.1">In this chapter, we learned the steps needed to set up Poky and get our first image built. </span><span class="koboSpan" id="kobo.359.2">Then, we ran that image using </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">runqemu</span></strong><span class="koboSpan" id="kobo.361.1">, which gave us a good overview of the available capabilities. </span><span class="koboSpan" id="kobo.361.2">In the next chapter, we will introduce Toaster, a human-friendly interface for BitBake. </span><span class="koboSpan" id="kobo.361.3">We will use it to build an image and customize </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">it further.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer016">
</div>
</div>
</body></html>