# 前言

开源操作系统（如 Linux）的主要优势在于任何人都可以深入挖掘并揭示它们的内部工作原理。尽管软件开发领域取得了天文般的进步，但 Linux 内核仍然是最复杂的代码之一。开发者、程序员以及潜在的内核黑客们不断深入内核代码，并推动新功能的实现。像我这样的爱好者和技术爱好者也在尝试理解并解开其中的谜团。

作为其中的一名爱好者，我花了相当多的时间探索 Linux 存储堆栈的复杂性。从简单的硬盘驱动器到复杂的网络存储系统，Linux 是世界上许多最复杂存储技术的核心。过去几年中，我有机会参与 Linux 和多个存储技术的工作，这激发了我对这一领域的兴趣。本书便是这一探索的成果。我尝试揭开 Linux 存储堆栈的各个层次，展示它们是如何协同工作的。我的目标是与那些与我一样对这一话题充满兴趣的人分享我所学到的知识。

本书提供了 Linux 存储堆栈的深入概述，并且具有强烈的概念性内容。它涵盖了堆栈中的所有主要组件，并详细分析了存储子系统及其架构、虚拟文件系统层、不同的文件系统及其实现差异、块层、多队列和设备映射框架、调度以及物理层。它还涵盖了与存储性能分析、调优和故障排除相关的各种主题。

我相信任何希望扩展对 Linux 及其存储领域理解的人都会发现本书既有信息量又实用。

# 本书适合人群

本书的主要目标读者是 Linux 系统和存储管理员、工程师、Linux 专业人士、整个 Linux 社区以及任何希望扩大对 Linux 了解的人。在任何环境中工作时，深入理解你所使用的技术至关重要。我相信本书将帮助你更好地理解 Linux 内部工作，提供必要的知识，并增强你对这一主题的兴趣。

# 本书内容

*第一章*，*从哪里开始——虚拟文件系统*，介绍了 Linux 内核中的**虚拟文件系统**（**VFS**）。本章将解释 VFS 在 I/O 堆栈中的关键作用，并提供对 VFS 的深刻概念理解，因为它是 Linux 中 I/O 请求的起点。

*第二章*，*解释 VFS 中的数据结构*，介绍了内核中 VFS 使用的各种数据结构。本章将解释内核如何使用结构体，如 inode、目录项和文件对象来存储文件元数据、目录和打开的文件。此外，还将介绍超级块结构如何使内核记录文件系统特性，最后将讲解内核中的页面缓存机制。

*第三章*，*探索 VFS 下的实际文件系统*，介绍了 Linux 中的文件系统概念。本章将解释 Linux 中最流行的块存储文件系统——扩展文件系统。此外，还将详细讨论诸如日志记录和写时复制等重要的文件系统概念。本章还将探讨文件和块 I/O 之间的差异，并深入研究网络文件系统。最后，将介绍用户空间文件系统的概念。

*第四章*，*理解块层、块设备和数据结构*，介绍了内核中的块层。本章将解释块设备的概念及其与字符设备的区别，并涵盖块层中的主要数据结构。

*第五章*，*理解块层、多队列和设备映射*，介绍了内核中的设备映射框架和多队列块 I/O 排队机制。本章将解释多队列框架如何提高现代存储设备的 I/O 操作性能。此外，还将讲解设备映射在实现如 LVM 等功能时所起的基础性作用。

*第六章*，*理解块层中的 I/O 处理与调度*，讨论了内核中不同的 I/O 处理机制和 I/O 调度程序。本章将讨论合并、合并写入和插入等操作在块层中的处理方式。还将详细解释 Linux 内核支持的不同 I/O 调度程序，以及它们在操作逻辑上的差异。

*第七章*，*SCSI 子系统*，重点介绍了 Linux 中的 SCSI 子系统及其多层架构。本章将解释多层 SCSI 架构、SCSI 设备寻址机制以及 SCSI 层中的主要数据结构。

*第八章*，*物理介质布局的说明*，讨论了当前可用的不同存储介质及其架构差异。传统的机械硬盘、固态硬盘和新的 NVMe 接口进行了比较。

*第九章*，*分析物理存储性能*，涵盖了存储子系统的性能分析和特性。本章将介绍可用于评估物理存储性能的不同指标。接下来，将讨论可用于衡量存储性能的不同工具和机制。

*第十章*，*分析文件系统和块层*，重点介绍了用于分析块层和文件系统性能的技术。本章将解释不同类型的文件系统 I/O 以及可能影响应用程序 I/O 请求的因素。接下来，将介绍不同的工具和跟踪机制，例如伯克利数据包过滤器编译器集，用于识别每个层次的潜在瓶颈。

*第十一章*，*调整 I/O 堆栈*，讨论了一些针对应用程序需求调整底层存储层的推荐实践。讨论了可用于在每个层次调整性能的不同选项。

# 为了最大化本书的学习效果

本书的主要目标是理解 Linux 内核及其主要子系统的内部工作原理。因此，为了最大限度地从本书中获益，您需要对操作系统概念（特别是 Linux）有一定的了解。最重要的是，要以耐心、好奇心和学习的态度来接触这些话题。

| **书中涉及的软件/硬件** | **操作系统要求** |
| --- | --- |
|  | Linux |

安装特定软件包的命令包含在每章的技术要求部分。

# 下载示例代码文件

我们有来自我们丰富书籍和视频目录的代码包，可在 [`github.com/PacktPublishing/`](https://github.com/PacktPublishing/) 获取。快去看看吧！

# 下载彩色图片

我们还提供了一个 PDF 文件，其中包含本书中使用的截图和图表的彩色图片。您可以在这里下载：[`packt.link/Uz9ge`](https://packt.link/Uz9ge)

# 使用的约定

本书中使用了许多文本约定。

`文中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 账号。示例：“如果我们查看 `/dev` 中的 `sd*` 设备，注意到文件类型显示为 `b`，表示块设备。”

代码块如下所示：

```
struct block_device {
        sector_t                bd_start_sect;
        sector_t                bd_nr_sectors;
        struct disk_stats __percpu *bd_stats;
        unsigned long           bd_stamp;
        bool                    bd_read_only;
        dev_t                   bd_dev;
        atomic_t                bd_openers;
        struct inode *          bd_inode;
[……..]
```

当我们希望引起您对代码块中特定部分的注意时，相关的行或项目将以粗体显示：

```
struct block_device {
        sector_t                bd_start_sect;
        sector_t                bd_nr_sectors;
        struct disk_stats __percpu *bd_stats;
        unsigned long           bd_stamp;
        bool                    bd_read_only;
        dev_t                   bd_dev;
        atomic_t                bd_openers;
        struct inode *          bd_inode;
[……..]
```

任何命令行输入或输出均如下所示：

```
[root@linuxbox ~]# find / -inum 67118958 -exec ls -l {} \;
-rw-r--r-- 1 root root 220 Jun 15 22:30 /etc/hosts
[root@linuxbox ~]#
```

**粗体**：表示新术语、重要词汇或屏幕上显示的文字。例如，菜单或对话框中的文字通常为**粗体**。例如：“在目录的情况下，inode 中的**type**字段是一个**目录**。”

小贴士或重要提示

以这样的形式呈现。

# 联系我们

我们随时欢迎读者的反馈。

`customercare@packtpub.com` 并在邮件主题中注明书名。

**勘误**：尽管我们已尽力确保内容的准确性，但错误仍然可能发生。如果你在本书中发现错误，我们将非常感谢你报告给我们。请访问 [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata) 并填写表格。

`copyright@packt.com` 并附上相关资料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专业知识，并且有兴趣写书或为书籍做贡献，请访问 [authors.packtpub.com](http://authors.packtpub.com)。

# 分享你的想法

阅读完*《Linux 存储栈的架构与设计》*后，我们非常希望听到你的想法！请点击此处直接前往亚马逊的本书评论页面并分享你的反馈。

你的评论对我们以及技术社区都非常重要，能帮助我们确保提供高质量的内容。

# 下载本书的免费 PDF 副本

感谢购买本书！

你是否喜欢随时随地阅读，但又无法随身携带纸质书籍？

你的电子书购买与所选设备不兼容吗？

别担心，现在每本 Packt 书籍，你都可以免费获得该书的无 DRM PDF 版本。

随时随地，任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制并粘贴代码到你的应用中。

优惠不止这些，你还可以每天收到独家折扣、新闻简报以及精彩的免费内容。

按照以下简单步骤获取优惠：

1.  扫描二维码或访问下面的链接

![](img/B19430_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781837639960`](https://packt.link/free-ebook/9781837639960)

1.  提交你的购买凭证

1.  就这样！我们会直接将你的免费 PDF 和其他福利发送到你的邮箱。

# 第一部分：深入虚拟文件系统

本部分详细介绍了**虚拟文件系统**（**VFS**）层及其下面的实际文件系统。你将了解 VFS，它的主要数据结构，扩展文件系统家族，以及与 Linux 中不同文件系统相关的主要概念。

本部分包含以下章节：

+   *第一章*，*一切从这里开始 – 虚拟文件系统*

+   *第二章*，*解释 VFS 中的数据结构*

+   *第三章*，*探索 VFS 下的实际文件系统*
