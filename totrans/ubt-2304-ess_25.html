<html><head></head><body>
<div class="_idGenObjectStyleOverride-1" id="_idContainer340">
<p class="Chapter-Title" id="_idParaDest-234" lang="en-US"><span class="ChapterMarker"><span class="koboSpan" id="kobo.1.1">26. </span></span><a id="_idTextAnchor400"/><span class="koboSpan" id="kobo.2.1">Creating KVM Virtual Machines with </span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.3.1">virt-install and </span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.4.1">virsh</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.5.1">In the previous chapters, we explored the creation of KVM guest operating systems on an Ubuntu host using Cockpit and the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.6.1">virt-manager</span></span><span class="koboSpan" id="kobo.7.1"> graphical tool. </span><span class="koboSpan" id="kobo.7.2">This chapter will focus on creating KVM-based virtual machines using the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.8.1">virt-install </span></span><span class="koboSpan" id="kobo.9.1">and </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.10.1">virsh</span></span><span class="koboSpan" id="kobo.11.1"> command-line tools. </span><span class="koboSpan" id="kobo.11.2">These tools provide all the capabilities of the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.12.1">virt-manager</span></span><span class="koboSpan" id="kobo.13.1"> and Cockpit options with the added advantage of being used within scripts to automate virtual machine creation. </span><span class="koboSpan" id="kobo.13.2">In addition, the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.14.1">virsh</span></span><span class="koboSpan" id="kobo.15.1"> command allows virtual machines to be created based on a specification contained within a configuration file.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.16.1">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.17.1">virt-install</span></span><span class="koboSpan" id="kobo.18.1"> tool is supplied to allow new virtual machines to be created by providing a list of command-line options. </span><span class="koboSpan" id="kobo.18.2">This chapter assumes that the necessary KVM tools are installed. </span><span class="koboSpan" id="kobo.18.3">Read the chapter </span><a href="KVM_Installation.xhtml#_idTextAnchor369"><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.19.1">“Installing KVM Virtualization on Ubuntu 23.04”</span></span></a><span class="My-Italic _idGenCharOverride-1"> </span><span class="koboSpan" id="kobo.20.1">for details on these requirements.</span></p>
<p class="Heading-1-1" id="_idParaDest-235" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.21.1">26.1 </span></span><a id="_idTextAnchor401"/><span class="koboSpan" id="kobo.22.1">Running virt-install to build a KVM Guest System </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.23.1">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.24.1">virt-install</span></span><span class="koboSpan" id="kobo.25.1"> utility accepts a wide range of command-line arguments that provide configuration information related to the virtual machine being created. </span><span class="koboSpan" id="kobo.25.2">Some command-line options are mandatory (expressly, name, memory, and disk storage must be provided), while others are optional. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.26.1">At a minimum, a </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.27.1">virt-install</span></span><span class="koboSpan" id="kobo.28.1"> command will typically need the following arguments:</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-3"><span class="koboSpan" id="kobo.29.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.30.1">--name</span></span><span class="koboSpan" id="kobo.31.1"> - The name to be assigned to the virtual machine.</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-3"><span class="koboSpan" id="kobo.32.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.33.1">--memory</span></span><span class="koboSpan" id="kobo.34.1"> - The amount of memory allocated to the virtual machine.</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-3"><span class="koboSpan" id="kobo.35.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.36.1">--disk</span></span><span class="koboSpan" id="kobo.37.1"> - The name and location of an image file for storage for the virtual machine. </span><span class="koboSpan" id="kobo.37.2">This file will be created by </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.38.1">virt-install</span></span><span class="koboSpan" id="kobo.39.1"> during the virtual machine creation unless the --import option is specified to indicate an existing image file is to be used.</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-3"><span class="koboSpan" id="kobo.40.1">•</span></span><span class="koboSpan" id="kobo.41.1">-</span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.42.1">-cdrom</span></span><span class="koboSpan" id="kobo.43.1"> or </span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.44.1">--location</span></span><span class="koboSpan" id="kobo.45.1"> - Specifies the local path or the URL of a remote ISO image containing the installation media for the guest operating system.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.46.1">A summary of all the arguments available for use when using </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.47.1">virt-install</span></span><span class="koboSpan" id="kobo.48.1"> can be found in the man page:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.49.1">$ man virt-install</span></p>
<p class="Heading-1-1" id="_idParaDest-236" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.50.1">26.2 </span></span><a id="_idTextAnchor402"/><span class="koboSpan" id="kobo.51.1">An Example Ubuntu virt-install Command </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.52.1">With reference to the above command-line argument list, we can now look at an example command-line construct using the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.53.1">virt-install</span></span><span class="koboSpan" id="kobo.54.1"> tool. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.55.1">Note that to display the virtual machine and complete the installation, a </span><a id="_idIndexMarker610"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.56.1">virt-viewer</span></span><span class="koboSpan" id="kobo.57.1"> instance must be connected to the virtual machine after the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.58.1">virt-install</span></span><span class="koboSpan" id="kobo.59.1"> utility starts it. </span><span class="koboSpan" id="kobo.59.2">By default, </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.60.1">virt-install</span></span><span class="koboSpan" id="kobo.61.1"> will attempt to launch </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.62.1">virt-viewer</span></span><span class="koboSpan" id="kobo.63.1"> automatically once the virtual machine starts running. </span><span class="koboSpan" id="kobo.63.2">However, if </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.64.1">virt-viewer</span></span><span class="koboSpan" id="kobo.65.1"> is unavailable, </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.66.1">virt-install</span></span><span class="koboSpan" id="kobo.67.1"> will wait until a </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.68.1">virt-viewer</span></span><span class="koboSpan" id="kobo.69.1"> connection is established. </span><span class="koboSpan" id="kobo.69.2">For example, the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.70.1">virt-viewer</span></span><span class="koboSpan" id="kobo.71.1"> session may be running locally on the host system if it has a graphical desktop, or a connection may be established from a remote client as outlined in the chapter entitled </span><a href="KVM_virt-manager.xhtml#_idTextAnchor389"><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.72.1">“Creating KVM Virtual Machines on Ubuntu 23.04 using virt-manager”</span></span></a><span class="koboSpan" id="kobo.73.1">.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.74.1">The following command creates a new KVM virtual machine configured to run a Ubuntu guest using KVM para-virtualization. </span><span class="koboSpan" id="kobo.74.2">It creates a new 10GB disk image, assigns 2048MB of RAM to the virtual machine, and configures a virtual CD device for the installation media ISO image: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.75.1"># virt-install --name demo_vm_guest --memory 2048 --disk path=/tmp/demo_vm_guest.img,size=10 --network network=default --cdrom /home/demo/iso/ubuntu-23.04-desktop-amd64.iso</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.76.1">As the creation process runs, the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.77.1">virt-install</span></span><span class="koboSpan" id="kobo.78.1"> command will display status updates of the creation progress:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.79.1">Starting install...</span></p>
<p class="Code"><span class="koboSpan" id="kobo.80.1">Allocating 'demo_vm_guest.img'                                |  10 GB  00:00:01     </span></p>
<p class="Code"><span class="koboSpan" id="kobo.81.1">Running graphical console command: virt-viewer --connect qemu:///system --wait demo_vm_guest</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.82.1">Once the guest system has been created, the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.83.1">virt-viewer</span></span><span class="koboSpan" id="kobo.84.1"> screen will appear containing the guest operating system installer loaded from the specified installation media: </span></p>
<p class="My-Basic-Paragraph ParaOverride-1" lang="en-US"><span class="koboSpan" id="kobo.85.1"><img alt="" class="_idGenObjectAttribute-1" src="image/ubuntu_virt-install_running.jpg"/></span></p>
<p class="Figure-Caption" lang="en-US"><span class="FigureCaptionMarker"><span class="koboSpan" id="kobo.86.1">Figure 26-1</span></span><a id="_idTextAnchor403"/></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.87.1">From this point, follow the standard installation procedure for the guest operating system. </span></p>
<p class="Heading-1-1" id="_idParaDest-237" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.88.1">26.3 </span></span><a id="_idTextAnchor404"/><span class="koboSpan" id="kobo.89.1">Starting and Stopping a Virtual Machine from the Command-Line</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.90.1">Having created the virtual machine from the command line, it stands to reason that you may also need to start it from the command line in the future. </span><span class="koboSpan" id="kobo.90.2">This can be achieved using the </span><a id="_idIndexMarker611"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.91.1">virsh</span></span><span class="koboSpan" id="kobo.92.1"> command-line utility, referencing the name assigned to the virtual machine during creation. </span><span class="koboSpan" id="kobo.92.2">For example</span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.93.1">:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.94.1"># virsh start demo_vm_guest</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.95.1">Similarly, the virtual machine may be sent a shutdown signal as follows</span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.96.1">:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.97.1"># virsh shutdown demo_vm_guest</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.98.1">Suppose the virtual machine fails to respond to the shutdown signal and does not begin a graceful shutdown. </span><span class="koboSpan" id="kobo.98.2">In that case, the virtual machine may be destroyed (with the attendant risks of data loss) using the destroy directive</span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.99.1">:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.100.1"># virsh destroy demo_vm_guest</span></p>
<p class="Heading-1-1" id="_idParaDest-238" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.101.1">26.4 </span></span><a id="_idTextAnchor405"/><span class="koboSpan" id="kobo.102.1">Creating a Virtual Machine from a Configuration File</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.103.1">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.104.1">virsh creat</span></span><span class="koboSpan" id="kobo.105.1">e command can take as an argument the name of a configuration file on which to base the creation of a new virtual machine. </span><span class="koboSpan" id="kobo.105.2">The configuration file uses XML format. </span><span class="koboSpan" id="kobo.105.3">The easiest way to create a configuration file is to dump out the configuration of an existing virtual machine and modify it for the new one. </span><span class="koboSpan" id="kobo.105.4">This can be achieved using the </span><a id="_idIndexMarker615"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.106.1">virsh dumpxml</span></span><span class="koboSpan" id="kobo.107.1"> command. </span><span class="koboSpan" id="kobo.107.2">For example, the following command outputs the configuration data for a virtual machine domain named </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.108.1">demo_vm_guest</span></span><span class="koboSpan" id="kobo.109.1"> to a file named </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.110.1">demo_vm_guest.xml</span></span><span class="koboSpan" id="kobo.111.1">:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.112.1"># virsh dumpxml demo_vm_guest &gt; demo_vm_guest.xml</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.113.1">Once the file has been generated, load it into an editor to review and change the settings for the new virtual machine.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.114.1">At the very least, the &lt;name&gt;, &lt;uuid&gt;, and image file path &lt;source file&gt; must be changed to avoid conflict with the virtual machine from which the configuration was taken. </span><span class="koboSpan" id="kobo.114.2">In the case of the UUID, this line can be deleted from the file.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.115.1">The virtualization type, memory allocation, and number of CPUs, to name but a few options, may also be changed if required. </span><span class="koboSpan" id="kobo.115.2">Once the file has been modified, the new virtual machine may be created as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.116.1"># virsh create demo_vm_guest.xml</span></p>
<p class="Heading-1-1" id="_idParaDest-239" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.117.1">26.5 </span></span><a id="_idTextAnchor406"/><span class="koboSpan" id="kobo.118.1">Summary</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.119.1">KVM provides the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.120.1">virt-install</span></span><span class="koboSpan" id="kobo.121.1"> and </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.122.1">virsh</span></span><span class="koboSpan" id="kobo.123.1"> command-line tools as a quick and efficient alternative to using the Cockpit and </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.124.1">virt-manager</span></span><span class="koboSpan" id="kobo.125.1"> tools to create and manage virtual machine instances. </span><span class="koboSpan" id="kobo.125.2">These tools have the advantage that they can be used from within scripts to automate the creation and management of virtual machines. </span><span class="koboSpan" id="kobo.125.3">The </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.126.1">virsh</span></span><span class="koboSpan" id="kobo.127.1"> command also includes the option to create VM instances from XML-based configuration files.</span></p>
</div>
</body></html>