14. Ubuntu 23.04 防火墙基础

防火墙是保护单个计算机系统或计算机网络免受外部攻击（通常来自互联网连接）的重要组成部分。任何直接连接到互联网的计算机都应该运行防火墙，以防止恶意活动。同样，任何内部网络也必须在它与外部互联网连接之间配置某种形式的防火墙。

Ubuntu 提供了强大的防火墙技术，名为内置的 iptables。关于如何配置 iptables，可以写成整本书，实际上也已经有很多书籍讨论这一话题。如果你想了解 iptables，推荐以下资源：

[`www.linuxtopia.org/Linux_Firewall_iptables/index.html`](https://www.linuxtopia.org/Linux_Firewall_iptables/index.html)

本章将介绍一些防火墙、TCP/IP 端口和服务的基本概念。Ubuntu 上的防火墙配置将在“Ubuntu 22.04 防火墙配置与 firewalld”和 “使用 gufw 和 ufw 配置 Ubuntu 防火墙”章节中进行讨论。

14.1 了解端口和服务

目前使用的主要网络通信协议是 TCP/IP。这是互联网使用的协议，因此它已经取代了许多曾经流行的局域网（LAN）协议。

TCP/IP 定义了总共 65,535 个端口，其中 1023 个被视为知名端口。需要理解的是，这些端口不是物理端口（即网络电缆连接的地方），而是每个网络连接上的虚拟端口，应用程序和服务可以通过这些端口在 TCP/IP 网络连接中进行通信。实际上，流行的网络客户端和服务使用的端口数量仅占知名端口组中的一个更小子集。

操作系统可以提供多个不同的 TCP/IP 服务。该章节末尾的表格提供了这些服务的完整列表。常见的服务包括用于运行安全 Web 服务器的 HTTPS，用于文件传输的 FTP，用于提供安全远程登录访问和文件传输的 SSH，以及用于传输电子邮件消息的 SMTP。每个服务都会分配到一个标准的 TCP/IP 端口。例如，HTTPS 分配给端口 443，而 SSH 通信则发生在端口 22 上。

14.2 安全化端口和服务

保护服务器的一个重要部分是定义角色，并根据这些角色确定应该启用哪些服务和端口。例如，一个仅作为 Web 服务器的服务器应该只运行 HTTPS 服务（可能还包括 SSH 以进行远程管理访问）。所有其他服务应该禁用，并且最好从操作系统中完全移除（这样可以增加攻击者重新启用服务的难度）。

系统安全化涉及从操作系统中删除任何不必要的服务，并确保通过防火墙屏蔽与非必要服务相关的端口。定义哪些端口可以访问以及在什么情况下可以访问的规则是通过 iptables 确定的。

许多操作系统默认安装并激活了多个服务。在安装新操作系统之前，必须仔细规划安装过程。这项规划包括决定哪些服务是不需要的，以及识别哪些服务在默认情况下已经安装并启用。新操作系统的部署不应匆忙进行。系统上可用的服务和开放端口越少，攻击者的攻击面和机会也就越小。

14.3 Ubuntu 服务与 iptables 规则

默认情况下，刚安装的 Ubuntu 系统没有定义任何 iptables 规则来限制端口访问。可以在终端窗口中执行以下命令来查看当前的 iptables 设置：

# iptables -L

链 INPUT（策略：ACCEPT）

目标 协议 选项 源 目的地

链 FORWARD（策略：ACCEPT）

目标 协议 选项 源 目的地

链 OUTPUT（策略：ACCEPT）

目标 协议 选项 源 目的地

如上面的输出所示，目前没有定义任何规则。虽然这看起来像是一个不安全的配置，但需要记住，刚安装的 Ubuntu 系统默认也没有运行太多服务，这使得端口对潜在攻击者来说是无用的。例如，在新安装的 Ubuntu 系统上访问 Web 服务器是不可能的，因为默认情况下没有安装或运行任何 Web 服务器服务。一旦系统上的服务开始激活，就需要通过定义 iptables 规则来建立防火墙策略。

定义 iptables 规则有几种方法，包括使用命令行工具和配置文件。例如，要阻止从 IP 地址 192.168.2.76 访问端口 25（用于 SMTP 邮件传输协议），可以在终端窗口中输入以下命令：

# iptables -A INPUT -s 192.168.2.76 -p tcp --destination-port 25 -j DROP

如果我们现在检查当前的规则，我们会看到以下规则已列出：

# iptables -L

链 INPUT（策略：ACCEPT）

目标 协议 选项 源 目的地

DROP tcp -- 192.168.2.76 anywhere tcp dpt:smtp

链 FORWARD（策略：ACCEPT）

目标 协议 选项 源 目的地

链 OUTPUT（策略：ACCEPT）

目标 协议 选项 源 目的地

该规则随后可以按如下方式删除：

# iptables -D INPUT -s 192.168.2.76 -p tcp --destination-port 25 -j DROP

鉴于 iptables 的复杂性，开发了几种用户友好的配置工具来简化规则创建过程。一个这样的工具是 firewall-cmd 命令行工具，相关内容将在“Ubuntu 22.04 使用 firewalld 配置防火墙”一章中讲解。

14.4 知名端口与服务

在深入讨论更复杂的防火墙规则之前，首先值得花时间概述一下 Ubuntu 系统可以提供的一些关键服务及其对应的端口号：

| 端口 | 分配 | 描述 |
| --- | --- | --- |
| 20 | FTP | 文件传输协议（数据）- 文件传输协议提供了一个在网络连接的计算机系统之间传输特定文件的机制。传输通常使用 ftp 客户端执行。大多数现代网页浏览器也可以浏览并下载远程 FTP 服务器上的文件。FTP 使用 TCP（而不是 UDP）来传输文件，TCP 被认为是一种高度可靠的传输机制。FTP 不加密数据，因此不被视为安全的文件传输协议。建议使用安全复制协议（SCP）和安全文件传输协议（SFTP）来代替 FTP。 |
| 21 | FTP | 文件传输（控制）- 传统上，FTP 有两个分配的端口（端口 20 和端口 21）。端口 20 最初被认为是数据传输端口，而端口 21 则被分配用于通信控制信息。然而，在现代实现中，端口 20 很少使用，所有通信都发生在端口 21 上。 |
| 22 | SSH | 安全外壳 - 安全外壳提供了一个安全的、加密的远程登录会话，可以通过 TCP/IP 网络访问主机。远程访问的原始机制是 Telnet 协议。然而，由于 Telnet 以明文传输数据，因此强烈建议使用安全外壳，它会加密所有通信，包括登录和密码凭证。SSH 还提供了一个机制，通过安全复制协议（SCP）可以安全地传输文件，并且还是安全文件传输协议（SFTP）的基础。SSH 还取代了 rsh 和 rlogin 客户端。 |
| 23 | Telnet | Telnet - Telnet 是一个终端仿真协议，可以通过 TCP/IP 连接登录到远程系统。访问是基于文本的，允许用户在远程主机上输入命令提示符，远程主机显示的文本将在本地 Telnet 客户端上显示。Telnet 既不加密密码，也不加密客户端和服务器之间传输的文本。因此，强烈建议避免使用 Telnet。大多数现代系统会关闭端口 23，并禁用 Telnet 服务，以防止其使用。应该使用 SSH 来代替 Telnet。 |
| 25 | SMTP | 简单邮件传输协议 - SMTP 定义了电子邮件消息从一个网络主机发送到另一个网络主机的机制。SMTP 是一种简单的协议，要求接收主机的邮件服务始终可用。通常，接收主机会将传入的邮件存储在一个排队队列中，供收件人通过 POP3 或 IMAP 协议访问。此外，SMTP 使用 TCP 传输协议来确保消息的无误传递。 |
| 53 | DNS | 域名系统 - TCP/IP 网络中用于将主机名和完全限定域名（FQDN）转换为 IP 地址的服务。 |
| 69 | TFTP | 简单文件传输协议 - TFTP 是文件传输协议（FTP）的精简版。它的命令集减少，且不支持身份验证。TFTP 的最显著特点是它使用 UDP 进行数据传输。这导致了高速传输，但也因此缺乏数据可靠性。TFTP 通常用于无盘工作站的网络启动。 |
| 80 | HTTP | 超文本传输协议 - HTTP 用于从 Web 服务器将文本、图形和多媒体内容下载到 Web 浏览器。它定义了浏览器与服务器之间的命令和控制机制，规定了客户端请求和服务器响应。HTTP 基于 TCP 传输协议，因此是一种面向连接的协议。 |
| 110 | POP3 | 邮局协议 - POP3 协议是一种从服务器存储和检索传入电子邮件的机制。在大多数企业环境中，传入邮件会存储在电子邮件服务器上，然后在用户检查邮件时下载到运行在用户桌面或笔记本上的电子邮件客户端。然而，POP3 会将所有新邮件下载到客户端，并不允许用户选择下载哪些邮件、查看邮件头或仅下载邮件的部分内容。因此，IMAP 协议正在逐渐取代 POP3 的使用。 |
| 119 | NNTP | 网络新闻传输协议 - 负责向 Usenet 新闻服务器（即托管在远程服务器上的新闻组和讨论论坛）发布和检索消息的协议。NNTP 在 OSI 协议栈的应用层上运行，并使用 TCP 来确保无误地检索和传输消息。 |
| 123 | NTP | 网络时间协议 - 一种设计用来将计算机时钟与外部时间源同步的协议。通过此协议，操作系统或应用程序可以从远程 NTP 服务器请求当前时间。远程 NTP 服务器通常基于核时钟提供的时间。NTP 对确保网络中所有系统设置为相同、准确的时间非常重要。尤其在安全场景中，当例如文件在客户端或服务器上的访问或修改时间出现争议时，NTP 的作用尤为关键。 |
| 143 | IMAP4 | 互联网邮件访问协议，第 4 版 - IMAP4 是一种先进且安全的电子邮件检索协议。IMAP 类似于 POP3，允许用户访问存储在电子邮件服务器上的邮件。然而，IMAP 包含许多附加功能，例如选择性下载邮件、查看邮件头、搜索邮件以及仅下载邮件的部分内容。此外，IMAP4 使用身份验证，并完全支持 Kerberos 认证。 |
| 161 | SNMP | 简单网络管理协议 - 提供了一种机制，允许网络管理员收集有关网络设备（如集线器、桥接器、路由器和交换机）的信息。SNMP 协议使运行在网络设备上的代理能够将其状态传递给中央管理者，并反过来允许管理者将新的配置参数发送给设备代理。代理还可以进一步配置，以在发生某些事件（称为陷阱）时通知管理者。SNMP 使用 UDP 来发送和接收数据。 |
| 443 | HTTPS | 超文本传输协议安全 - 标准的 HTTP（不安全）协议以明文传输数据（即没有加密，且任何可能拦截流量的人都能看到）。虽然这对于大多数网页浏览目的来说是可以接受的，但当需要从浏览器向 Web 服务器传输机密信息，如信用卡详细信息时，这构成了严重的安全风险。HTTPS 通过使用安全套接层（SSL）来解决这一问题，通过加密的数据在客户端和服务器之间传输。 |
| 2049 | NFS | 网络文件系统 - 最初由 Sun Microsystems 开发，随后广泛应用于整个行业，NFS 允许通过网络让远程系统上的文件系统像本地磁盘驱动器一样被另一系统访问。NFS 广泛应用于基于 UNIX 和 LINUX 的系统。微软 Windows 的后续版本也可以访问基于 UNIX 和 LINUX 系统上的 NFS 共享文件系统。 |

表 14-1

14.5 总结

新安装的 Ubuntu 系统通常被认为是安全的，因为系统端口上没有运行服务。然而，一旦系统开始配置以供使用，就需要确保通过实施防火墙来保护系统。在配置防火墙时，理解各种端口和对应服务非常重要。

有多种防火墙选项，其中最基本的是命令行配置 iptables 防火墙接口。通过 firewalld 可以获得更直观和高级的选项，下一章将介绍这些选项。
