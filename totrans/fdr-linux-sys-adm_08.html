<html><head></head><body>
<div id="_idContainer118" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-57"><a id="_idTextAnchor121" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-58" class="calibre5"><a id="_idTextAnchor122" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.2.1">Optimizing Storage Usage</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">In the previous chapter, during the installation of the OS, we mentioned the importance of the local storage configuration. </span><span class="kobospan" id="kobo.3.2">Local storage resource optimization is vital to the well-being of the system. </span><span class="kobospan" id="kobo.3.3">It is time to review basic storage management concepts that help with optimization, such as the format, filesystem, and sizing, as well as management tools such as logical volumes </span><span><span class="kobospan" id="kobo.4.1">and Stratis.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we’re going to cover the following </span><span><span class="kobospan" id="kobo.6.1">main topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.7.1">Understanding file formats </span><span><span class="kobospan" id="kobo.8.1">and filesystems</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.9.1">Optimizing storage </span><span><span class="kobospan" id="kobo.10.1">space size</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.11.1">Deep diving into Logical </span><span><span class="kobospan" id="kobo.12.1">Volume Manager</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.13.1">Discovering </span><span><span class="kobospan" id="kobo.14.1">Stratis storage</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.15.1">Let’s </span><span><span class="kobospan" id="kobo.16.1">get started!</span></span></p>
<h1 id="_idParaDest-59" class="calibre5"><a id="_idTextAnchor123" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.17.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.18.1">To perform some of the configurations included in this chapter, you require free local storage space, if possible, on a local disk independent of the operating system. </span><span class="kobospan" id="kobo.18.2">No matter how large it is, this should do the job. </span><span class="kobospan" id="kobo.18.3">In case of not having extra space, some configurations can be done in local free space on the same disk where the operating system was installed, although it is </span><span><span class="kobospan" id="kobo.19.1">not recommended.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.20.1">This will be mentioned when some configuration needs to be performed on a disk independent of the operating system or an </span><span><span class="kobospan" id="kobo.21.1">alternate disk.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.22.1">The following table shows the storage arrangement in the </span><span><span class="kobospan" id="kobo.23.1">test setup:</span></span></p>
<table class="no-table-style" id="table001-2">
<colgroup class="calibre10">
<col class="calibre11"/>
<col class="calibre11"/>
<col class="calibre11"/>
</colgroup>
<tbody class="calibre12">
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.24.1">Device</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.25.1">Size</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.26.1">Used as:</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.27.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.28.1">dev/vda</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.29.1">50 GiB</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.30.1">OS</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.31.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.32.1">dev/vdb</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.33.1">50 GiB</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.34.1">Btrfs, Stratis</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.35.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.36.1">dev/vdc</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.37.1">10 GiB</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.38.1">Stratis</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.39.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.40.1">dev/vdd</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.41.1">20 GiB</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.42.1">Stratis</span></span></p>
</td>
</tr>
</tbody>
</table>
<h1 id="_idParaDest-60" class="calibre5"><a id="_idTextAnchor124" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.43.1">Understanding file formats and filesystems</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.44.1">A </span><strong class="bold"><span class="kobospan" id="kobo.45.1">filesystem</span></strong><span class="kobospan" id="kobo.46.1"> allows the</span><a id="_idIndexMarker245" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.47.1"> operating system to find the data it stores on its local disk. </span><span class="kobospan" id="kobo.47.2">These</span><a id="_idIndexMarker246" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.48.1"> basic addressable storage units</span><a id="_idIndexMarker247" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.49.1"> make a </span><strong class="bold"><span class="kobospan" id="kobo.50.1">block</span></strong><span class="kobospan" id="kobo.51.1"> (usually about 4,096 bytes in size). </span><span class="kobospan" id="kobo.51.2">To find the contents of files, among the large number of available storage blocks, it uses </span><a id="_idIndexMarker248" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.52.1">inodes. </span><span class="kobospan" id="kobo.52.2">An </span><strong class="bold"><span class="kobospan" id="kobo.53.1">inode</span></strong><span class="kobospan" id="kobo.54.1"> contains information about a file in a particular formatted storage block, such as its size, location, access rules (i.e., who can read, write, or execute the file), and </span><span><span class="kobospan" id="kobo.55.1">much more.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.56.1">Starting with Fedora Linux 33, the default filesystem format on Workstation Edition is </span><strong class="bold"><span class="kobospan" id="kobo.57.1">Btrfs</span></strong><span class="kobospan" id="kobo.58.1">. </span><span class="kobospan" id="kobo.58.2">Unlike</span><a id="_idIndexMarker249" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.59.1"> other distributions that still use </span><strong class="source-inline"><span class="kobospan" id="kobo.60.1">xfs</span></strong><span class="kobospan" id="kobo.61.1"> or even </span><strong class="source-inline"><span class="kobospan" id="kobo.62.1">ext4</span></strong><span class="kobospan" id="kobo.63.1">, Btrfs is a </span><strong class="bold"><span class="kobospan" id="kobo.64.1">copy-on-write</span></strong><span class="kobospan" id="kobo.65.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.66.1">COW</span></strong><span class="kobospan" id="kobo.67.1">) filesystem for </span><a id="_idIndexMarker250" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.68.1">Linux that implements many </span><span><span class="kobospan" id="kobo.69.1">advanced features.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.70.1">In a COW filesystem, once modified, a file is not written back to the same block on disk; it’s more like a redirect. </span><span class="kobospan" id="kobo.70.2">This is for the preservation of the original data and to ensure writing the new data to unoccupied inodes. </span><span class="kobospan" id="kobo.70.3">This allows for references to the old versions of the file for easy </span><a id="_idIndexMarker251" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.71.1">access as in a </span><strong class="bold"><span class="kobospan" id="kobo.72.1">snapshot</span></strong><span class="kobospan" id="kobo.73.1">, keeping a snapshot of the state of the system at a given moment </span><span><span class="kobospan" id="kobo.74.1">in time.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.75.1">The downside of this is that this behavior could lead to file fragmentation faster than in other filesystems, although, for regular desktop usage, it is unlikely to make </span><span><span class="kobospan" id="kobo.76.1">a difference.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.77.1">To make the modified file appear in the filesystem, all directory entries that contain a reference to it get updated as well, in a recursive way. </span><span class="kobospan" id="kobo.77.2">And because a directory is itself a file pointer with an inode (since it indicates the files inside it), any file modification also creates a new inode for the directory, and this happens through the filesystem to the root directory (</span><strong class="source-inline"><span class="kobospan" id="kobo.78.1">/</span></strong><span class="kobospan" id="kobo.79.1">). </span><span class="kobospan" id="kobo.79.2">So, as long as a reference to the old directories remain and is not modified, the entire filesystem could still refer to a previous state, as in </span><span><span class="kobospan" id="kobo.80.1">a snapshot.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.81.1">Besides cheap and fast snapshots, Btrfs includes other features such as error detection, fault tolerance, recovery, transparent compression, and integrated volume management, and provides multiple device storage pooling, RAID-like functionality, and checksumming </span><a id="_idIndexMarker252" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.82.1">of </span><a id="_idIndexMarker253" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.83.1">data and metadata, all with </span><span><span class="kobospan" id="kobo.84.1">easy-to-use administration.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.85.1">Let’s create a test Btrfs filesystem to show </span><span><span class="kobospan" id="kobo.86.1">its capabilities.</span></span></p>
<h2 id="_idParaDest-61" class="calibre7"><a id="_idTextAnchor125" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.87.1">Creating a Btrfs filesystem</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.88.1">For the development</span><a id="_idIndexMarker254" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.89.1"> of this example, use an alternative local disk to the OS installed. </span><span class="kobospan" id="kobo.89.2">This introduces you to the capabilities of the Btrfs filesystem from scratch. </span><span class="kobospan" id="kobo.89.3">Follow </span><span><span class="kobospan" id="kobo.90.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.91.1">Storage administration requires superuser access, so switch to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.92.1">root</span></strong><span class="kobospan" id="kobo.93.1"> user using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.94.1">sudo</span></strong><span class="kobospan" id="kobo.95.1"> command and create the </span><strong class="source-inline1"><span class="kobospan" id="kobo.96.1">/btrfs</span></strong><span class="kobospan" id="kobo.97.1"> directory that will host </span><span><span class="kobospan" id="kobo.98.1">the filesystem:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.99.1">[user@workstation ~]$ sudo -i</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.100.1">[sudo] password for user: [</span></strong><strong class="bold1"><span class="kobospan1" id="kobo.101.1">password]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.102.1">[user@workstation ~]$ mkdir /btrfs</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.103.1">Identify the device to use. </span><span class="kobospan" id="kobo.103.2">Ensure that the test storage device is not in use. </span><span class="kobospan" id="kobo.103.3">Formatting implies total destruction of </span><span><span class="kobospan" id="kobo.104.1">the data.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.105.1">Several commands provide information about the use of storage devices. </span><span class="kobospan" id="kobo.105.2">A recommendation is to use more than one command to verify them. </span><span class="kobospan" id="kobo.105.3">These recommendations include </span><span><span class="kobospan" id="kobo.106.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.107.1">(</span><span><strong class="source-inline1"><span class="kobospan" id="kobo.108.1">s</span></strong></span><span><span class="kobospan" id="kobo.109.1">)</span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.110.1">fdisk -l</span></strong></span></li>
<li class="calibre14"><span><strong class="source-inline1"><span class="kobospan" id="kobo.111.1">parted -l</span></strong></span></li>
<li class="calibre14"><span><strong class="source-inline1"><span class="kobospan" id="kobo.112.1">cat /proc/partitions</span></strong></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.113.1">ls -</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.114.1">l /dev/disk/by-path</span></strong></span></li>
<li class="calibre14"><span><strong class="source-inline1"><span class="kobospan" id="kobo.115.1">lsblk -p</span></strong></span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer100">
<span class="kobospan" id="kobo.116.1"><img alt="Figure 4.1 – Identifying storage device" src="image/B19121_04_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.117.1">Figure 4.1 – Identifying storage device</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.118.1">In our example, the</span><a id="_idIndexMarker255" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.119.1"> storage device that is not in use is </span><strong class="source-inline"><span class="kobospan" id="kobo.120.1">/dev/vdb</span></strong><span class="kobospan" id="kobo.121.1">, since it shows that it does not contain any partition. </span><span class="kobospan" id="kobo.121.2">Still, it should be managed </span><a id="_idIndexMarker256" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.122.1">by </span><strong class="bold"><span class="kobospan" id="kobo.123.1">Logical Volume Manager</span></strong><span class="kobospan" id="kobo.124.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.125.1">LVM</span></strong><span class="kobospan" id="kobo.126.1">). </span><span class="kobospan" id="kobo.126.2">Run the following command to display the devices managed </span><span><span class="kobospan" id="kobo.127.1">by LVM:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.128.1">pvs -a</span></strong></pre> <div class="calibre2">
<div class="img---figure" id="_idContainer101">
<span class="kobospan" id="kobo.129.1"><img alt="Figure 4.2 – Discarding LVM on the storage device" src="image/B19121_04_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.130.1">Figure 4.2 – Discarding LVM on the storage device</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.131.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.132.1">In case of using a partition, you need to confirm that the partition is not in use by another filesystem and does not have a directory mounted. </span><span class="kobospan" id="kobo.132.2">Use the following basic commands: </span><strong class="bold"><span class="kobospan" id="kobo.133.1">fdisk</span></strong><span class="kobospan" id="kobo.134.1">, </span><strong class="bold"><span class="kobospan" id="kobo.135.1">parted</span></strong><span class="kobospan" id="kobo.136.1">, </span><strong class="bold"><span class="kobospan" id="kobo.137.1">mount</span></strong><span class="kobospan" id="kobo.138.1">, </span><strong class="bold"><span class="kobospan" id="kobo.139.1">df</span></strong><span class="kobospan" id="kobo.140.1">, </span><strong class="bold"><span class="kobospan" id="kobo.141.1">lsblk</span></strong><span class="kobospan" id="kobo.142.1">, </span><span><span class="kobospan" id="kobo.143.1">and </span></span><span><strong class="bold"><span class="kobospan" id="kobo.144.1">blkid</span></strong></span><span><span class="kobospan" id="kobo.145.1">.</span></span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.146.1">Create a</span><a id="_idIndexMarker257" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.147.1"> storage pool. </span><span class="kobospan" id="kobo.147.2">With Btrfs, it is not necessary to create physical partitions on the storage device. </span><span class="kobospan" id="kobo.147.3">Create a storage pool and then create subvolumes. </span><span class="kobospan" id="kobo.147.4">These subvolumes can have quotas and snapshots since these resizable partitions can share blocks </span><span><span class="kobospan" id="kobo.148.1">of data.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.149.1">Run the </span><strong class="source-inline"><span class="kobospan" id="kobo.150.1">mkfs.btrfs</span></strong><span class="kobospan" id="kobo.151.1"> command to format </span><strong class="source-inline"><span class="kobospan" id="kobo.152.1">/dev/vdb</span></strong> <span><span class="kobospan" id="kobo.153.1">as </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.154.1">Btrfs</span></strong></span><span><span class="kobospan" id="kobo.155.1">:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.156.1">mkfs.btrfs -L testbtrfs /dev/vdb</span></strong></pre> <div class="calibre2">
<div class="img---figure" id="_idContainer102">
<span class="kobospan" id="kobo.157.1"><img alt="Figure 4.3 – Creating ﻿a Btrfs storage pool" src="image/B19121_04_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.158.1">Figure 4.3 – Creating a Btrfs storage pool</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.159.1">Mount the </span><a id="_idIndexMarker258" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.160.1">storage device on the directory where subvolumes should be created. </span><span class="kobospan" id="kobo.160.2">Use the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.161.1">mount</span></strong></span><span><span class="kobospan" id="kobo.162.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.163.1">[root@workstation ~]# mount /dev/vdb /btrfs</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.164.1">With the Btrfs filesystem mounted, let’s analyze the usage of its </span><span><span class="kobospan" id="kobo.165.1">storage space.</span></span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.166.1">To show the structure of a filesystem, run </span><span><span class="kobospan" id="kobo.167.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.168.1">[root@workstation ~]# btrfs filesystem show /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.169.1">Label: 'testbtrfs'  uuid: def9423d-8684-487f-bd11-4829937752b6</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.170.1">Total devices 1 FS bytes used 144.00KiB</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.171.1">devid    1 size 50.00GiB used 1.56GiB path /dev/vdb</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.172.1">To measure the available space on the filesystem, run </span><span><span class="kobospan" id="kobo.173.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.174.1">[root@workstation ~]# btrfs filesystem df /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.175.1">Data, single: total=1.00GiB, used=0.00B</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.176.1">System, DUP: total=32.00MiB, used=16.00KiB</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.177.1">Metadata, DUP: total=256.00MiB, used=128.00KiB</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.178.1">GlobalReserve, single: total=3.50MiB, used=0.00B</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.179.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.180.1">The following section will explain in detail the meaning of the </span><span><span class="kobospan" id="kobo.181.1">command output.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.182.1">In Btrfs, a subvolume is similar to a filesystem contained in the host. </span><span class="kobospan" id="kobo.182.2">A Btrfs filesystem contains a single subvolume, but extra subvolumes could exist. </span><span class="kobospan" id="kobo.182.3">The subvolumes appear as directories within the mounted Btrfs filesystem. </span><span class="kobospan" id="kobo.182.4">A subvolume could access it like any other user-accessible directory, or it could mount as a </span><span><span class="kobospan" id="kobo.183.1">separate filesystem.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.184.1">Btrfs separates each volume. </span><span class="kobospan" id="kobo.184.2">By default, the Btrfs filesystem contains a subvolume. </span><span class="kobospan" id="kobo.184.3">This is set as the top-level subvolume and is mounted even if not specified. </span><span class="kobospan" id="kobo.184.4">Subvolumes, as they're being created, could</span><a id="_idIndexMarker259" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.185.1"> nest into each other. </span><span class="kobospan" id="kobo.185.2">But not the top-level subvolume. </span><span class="kobospan" id="kobo.185.3">So each of them has a mountable root and could contain more than one tree of files. </span><span class="kobospan" id="kobo.185.4">This sets a relative location for each subvolume and the mount point of the </span><span><span class="kobospan" id="kobo.186.1">main subvolume.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.187.1">A </span><strong class="bold"><span class="kobospan" id="kobo.188.1">Btrfs subvolume</span></strong><span class="kobospan" id="kobo.189.1"> is considered more like </span><span><span class="kobospan" id="kobo.190.1">a namespace.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.191.1">Some basic layouts exist </span><a id="_idIndexMarker260" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.192.1">for subvolumes (including snapshots), and they include </span><span><span class="kobospan" id="kobo.193.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.194.1">Flat – Subvolumes are children of the </span><span><span class="kobospan" id="kobo.195.1">top level</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.196.1">Nested – Subvolumes are located anywhere in the file hierarchy, below other subvolumes, not the </span><span><span class="kobospan" id="kobo.197.1">top-level subvolume</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.198.1">Mixed – The two basic schemes could be mixed, for example, the base structure follows a flat layout, with certain parts of the filesystem placed in </span><span><span class="kobospan" id="kobo.199.1">nested subvolumes</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.200.1">Let’s create </span><span><span class="kobospan" id="kobo.201.1">a subvolume:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.202.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.203.1">btrfs subvolume create</span></strong><span class="kobospan" id="kobo.204.1"> command to create the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.205.1">test</span></strong></span><span><span class="kobospan" id="kobo.206.1"> subvolume:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.207.1">[root@workstation ~]# btrfs subvolume create /btrfs/test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.208.1">Create subvolume '/btrfs/test'</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.209.1">Review the subvolume information with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.210.1">btrfs </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.211.1">subvolume</span></strong></span><span><span class="kobospan" id="kobo.212.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.213.1">[root@workstation ~]# btrfs subvolume show /btrfs/test</span></strong></pre></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer103">
<span class="kobospan" id="kobo.214.1"><img alt="Figure 4.4 – Subvolume information" src="image/B19121_04_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.215.1">Figure 4.4 – Subvolume information</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.216.1">Create</span><a id="_idIndexMarker261" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.217.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.218.1">/test</span></strong><span class="kobospan" id="kobo.219.1"> directory and mount the subvolume </span><span><span class="kobospan" id="kobo.220.1">on it:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.221.1">[root@workstation ~]# mkdir /test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.222.1">[root@workstation ~]# mount -o bind /btrfs/test /test</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.223.1">In this example, the subvolume doesn’t have an allocated space, so it can use all the available space in </span><span><span class="kobospan" id="kobo.224.1">the pool.</span></span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.225.1">Verify the used space of </span><span><span class="kobospan" id="kobo.226.1">the pool:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.227.1">[root@workstation ~]# btrfs filesystem du /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.228.1">     Total   Exclusive  Set shared  Filename</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.229.1">     0.00B       0.00B           -  /btrfs/test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.230.1">     0.00B       0.00B       0.00B  /btrfs</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.231.1">To get more</span><a id="_idIndexMarker262" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.232.1"> details on space usage, run the </span><span><span class="kobospan" id="kobo.233.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.234.1">btrfs filesystem usage /btrfs</span></strong></pre> <div class="calibre2">
<div class="img---figure" id="_idContainer104">
<span class="kobospan" id="kobo.235.1"><img alt="Figure 4.5 – Storage space used by Btrfs pool" src="image/B19121_04_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.236.1">Figure 4.5 – Storage space used by Btrfs pool</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.237.1">Let’s create an empty file of 1 GB to observe the change in the </span><span><span class="kobospan" id="kobo.238.1">allocated usage.</span></span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.239.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.240.1">dd</span></strong><span class="kobospan" id="kobo.241.1"> command to create an empty 1 GB file in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.242.1">/</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.243.1">test</span></strong></span><span><span class="kobospan" id="kobo.244.1"> directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.245.1">[root@workstation ~]# </span></strong><strong class="bold1"><span class="kobospan1" id="kobo.246.1">dd if=/dev/zero of=/test/example \</span></strong><span class="kobospan1" id="kobo.247.1">
&gt; </span><strong class="bold1"><span class="kobospan1" id="kobo.248.1">bs=1M count=1024</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.249.1">Verify the change of the allocated space in </span><span><span class="kobospan" id="kobo.250.1">the pool:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.251.1">[root@workstation ~]# btrfs filesystem du /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.252.1">[root@workstation ~]# btrfs filesystem usage /btrfs</span></strong></pre></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer105">
<span class="kobospan" id="kobo.253.1"><img alt="Figure 4.6 – Change in storage space used by the Btrfs pool" src="image/B19121_04_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.254.1">Figure 4.6 – Change in storage space used by the Btrfs pool</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.255.1">This is the end of the</span><a id="_idIndexMarker263" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.256.1"> example. </span><span class="kobospan" id="kobo.256.2">We started by identifying a free-of-use storage device to format it as </span><strong class="source-inline"><span class="kobospan" id="kobo.257.1">Btrfs</span></strong><span class="kobospan" id="kobo.258.1">, created a storage pool on it, created a subvolume, and mounted it in a filesystem and analyzed the storage space usage </span><span><span class="kobospan" id="kobo.259.1">in detail.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.260.1">In the next </span><a id="_idIndexMarker264" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.261.1">section, we will continue revisiting the basic concepts of storage administration in </span><span><span class="kobospan" id="kobo.262.1">Fedora Linux.</span></span></p>
<h1 id="_idParaDest-62" class="calibre5"><a id="_idTextAnchor126" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.263.1">Optimizing storage space size</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.264.1">In the previous</span><a id="_idIndexMarker265" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.265.1"> section, we reviewed some of the features of the Btrfs filesystem. </span><span class="kobospan" id="kobo.265.2">Now it is time to learn how to optimize this used storage space in </span><span><span class="kobospan" id="kobo.266.1">more detail.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.267.1">Btrfs reserves some raw storage at its lowest level because the volume needs to contain file data or volume metadata. </span><span class="kobospan" id="kobo.267.2">For that, it allocates pieces of raw storage for use by the filesystem. </span><span class="kobospan" id="kobo.267.3">A piece of storage gets </span><a id="_idIndexMarker266" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.268.1">referred to as a </span><strong class="bold"><span class="kobospan" id="kobo.269.1">chunk</span></strong><span class="kobospan" id="kobo.270.1">. </span><span class="kobospan" id="kobo.270.2">Its main function is to contain file data or volume metadata to replicate on the same volume or another </span><span><span class="kobospan" id="kobo.271.1">similar device.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.272.1"> Storage space gets allocated to the chunks, and the space is used by the blocks. </span><span class="kobospan" id="kobo.272.2">A chunk with no blocks used is unallocated; a chunk with one or more blocks used is allocated. </span><span class="kobospan" id="kobo.272.3">All chunks can get allocated even if not all the space </span><span><span class="kobospan" id="kobo.273.1">is used.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.274.1">Btrfs uses </span><strong class="bold"><span class="kobospan" id="kobo.275.1">delayed allocation</span></strong><span class="kobospan" id="kobo.276.1"> to enable</span><a id="_idIndexMarker267" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.277.1"> better disk allocation. </span><span class="kobospan" id="kobo.277.2">Btrfs only allocates disk space when the system needs to get rid of dirty pages, so in the end, you get much larger allocations and much larger chunks of sequential data, which makes data </span><span><span class="kobospan" id="kobo.278.1">reading faster.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.279.1">Btrfs allocates space on its disks by assigning chunks of 1 GB for data and 256 MB chunks for metadata. </span><span class="kobospan" id="kobo.279.2">This implies that a chunk has a specific profile associated with it: once allocated a chunk for data or metadata, that space is only usable for one or the other. </span><span class="kobospan" id="kobo.279.3">So, Btrfs has different allocation profiles for metadata </span><span><span class="kobospan" id="kobo.280.1">and data.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.281.1">This division of metadata and data might get confusing: a filesystem might show 10 GB of data but only 2 GB free. </span><span class="kobospan" id="kobo.281.2">Common operating system commands, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.282.1">df</span></strong><span class="kobospan" id="kobo.283.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.284.1">du</span></strong><span class="kobospan" id="kobo.285.1">, do not show the full information about space usage and chunk allocation in Btrfs. </span><span class="kobospan" id="kobo.285.2">For this reason, Btrfs incorporates its own commands that show the used space and </span><span><span class="kobospan" id="kobo.286.1">allocated chunks.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.287.1">Using the filesystem created in the previous section, let’s take a closer look at storage space usage and chunk allocation. </span><span class="kobospan" id="kobo.287.2">Use the </span><strong class="source-inline"><span class="kobospan" id="kobo.288.1">btrfs filesystem df</span></strong><span class="kobospan" id="kobo.289.1"> command to display the </span><strong class="source-inline"><span class="kobospan" id="kobo.290.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.291.1">btrfs</span></strong></span><span><span class="kobospan" id="kobo.292.1"> information:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.293.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.294.1">btrfs filesystem df /btrfs</span></strong><span class="kobospan1" id="kobo.295.1">
Data, single: total=1.00GiB, used=1.00GiB
System, DUP: total=8.00MiB, used=16.00KiB
Metadata, DUP: total=256.00MiB, used=1.17MiB
GlobalReserve, single: total=3.50MiB, used=16.00KiB</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.296.1">Observe </span><span><span class="kobospan" id="kobo.297.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.298.1">Data</span></strong><span class="kobospan" id="kobo.299.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.300.1">System</span></strong><span class="kobospan" id="kobo.301.1">, and </span><strong class="source-inline1"><span class="kobospan" id="kobo.302.1">Metadata</span></strong><span class="kobospan" id="kobo.303.1"> are separate block </span><span><span class="kobospan" id="kobo.304.1">group types:</span></span><ul class="calibre17"><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.305.1">single</span></strong><span class="kobospan" id="kobo.306.1"> is the allocation profile, defined at </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.307.1">mkfs</span></strong></span><span><span class="kobospan" id="kobo.308.1"> time.</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.309.1">DUP</span></strong><span class="kobospan" id="kobo.310.1"> means </span><em class="italic"><span class="kobospan" id="kobo.311.1">duplicate</span></em><span class="kobospan" id="kobo.312.1">. </span><span class="kobospan" id="kobo.312.2">It guarantees the existence of two copies on the same disk. </span><span class="kobospan" id="kobo.312.3">This mode protects against data or metadata corruption but not against </span><span><span class="kobospan" id="kobo.313.1">disk failure.</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.314.1">total</span></strong><span class="kobospan" id="kobo.315.1"> is the sum of space reserved for all allocation profiles of the given type, that is, all </span><strong class="source-inline1"><span class="kobospan" id="kobo.316.1">Data</span></strong><span class="kobospan" id="kobo.317.1">/</span><strong class="source-inline1"><span class="kobospan" id="kobo.318.1">single</span></strong><span class="kobospan" id="kobo.319.1">. </span><span class="kobospan" id="kobo.319.2">Note that </span><em class="italic"><span class="kobospan" id="kobo.320.1">it’s not the total size of </span></em><span><em class="italic"><span class="kobospan" id="kobo.321.1">the filesystem</span></em></span><span><span class="kobospan" id="kobo.322.1">.</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.323.1">used</span></strong><span class="kobospan" id="kobo.324.1"> is the sum of the used space of the data, that is, file extents, and </span><span><span class="kobospan" id="kobo.325.1">metadata blocks.</span></span></li></ul></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.326.1">GlobalReserve</span></strong><span class="kobospan" id="kobo.327.1"> is artificial and internal </span><span><span class="kobospan" id="kobo.328.1">emergency space:</span></span><ul class="calibre17"><li class="calibre14"><span class="kobospan" id="kobo.329.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.330.1">GlobalReserve</span></strong><span class="kobospan" id="kobo.331.1"> space is part of the metadata used. </span><span class="kobospan" id="kobo.331.2">It is used when the filesystem metadata gets exhausted. </span><span class="kobospan" id="kobo.331.3">While it is not allocated, it appears as unused </span><span><span class="kobospan" id="kobo.332.1">metadata space.</span></span></li></ul></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.333.1">From here, you </span><a id="_idIndexMarker268" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.334.1">could add other storage devices to the </span><strong class="source-inline"><span class="kobospan" id="kobo.335.1">/btrfs</span></strong><span class="kobospan" id="kobo.336.1"> filesystem to make it a single partition that spans all the devices you add. </span><span class="kobospan" id="kobo.336.2">For this, follow </span><span><span class="kobospan" id="kobo.337.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.338.1">Format the extra devices as </span><strong class="source-inline1"><span class="kobospan" id="kobo.339.1">Btrfs</span></strong><span class="kobospan" id="kobo.340.1"> with the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.341.1">mkfs.btrfs</span></strong></span><span><span class="kobospan" id="kobo.342.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.343.1">mkfs.btrfs /dev/vdc /dev/vdd</span></strong><span class="kobospan1" id="kobo.344.1">...</span></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.345.1">Add devices to the </span><span><span class="kobospan" id="kobo.346.1">mounted device:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.347.1">btrfs device add /dev/vdc /dev/vdd</span></strong><span class="kobospan1" id="kobo.348.1">...
</span><span class="kobospan1" id="kobo.348.2">Performing full device TRIM /dev/vdc (10.00GiB) ...
</span><span class="kobospan1" id="kobo.348.3">Performing full device TRIM /dev/vdd (20.00GiB) ...</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.349.1">If we rerun the </span><strong class="source-inline"><span class="kobospan" id="kobo.350.1">btrfs filesystem df</span></strong><span class="kobospan" id="kobo.351.1"> command, the output shows </span><span><span class="kobospan" id="kobo.352.1">no change:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.353.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.354.1">btrfs filesystem df /btrfs</span></strong><span class="kobospan1" id="kobo.355.1">
Data, single: total=1.00GiB, used=1.00GiB
System, DUP: total=8.00MiB, used=16.00KiB
Metadata, DUP: total=256.00MiB, used=1.17MiB
GlobalReserve, single: total=3.50MiB, used=0.00B</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.356.1">This is because the disks that are added are neither allocated for data nor metadata. </span><span class="kobospan" id="kobo.356.2">Using the </span><strong class="source-inline"><span class="kobospan" id="kobo.357.1">btrfs filesystem show</span></strong><span class="kobospan" id="kobo.358.1"> command, the following </span><span><span class="kobospan" id="kobo.359.1">output shows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.360.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.361.1">btrfs filesystem show /btrfs</span></strong><span class="kobospan1" id="kobo.362.1">
Label: 'testbtrfs'  uuid: 6c8ccaad-f9a0-4957-919e-8d87e02078e3
Total devices 3 FS bytes used 1.00GiB
devid    1 size 50.00GiB used 1.52GiB path /dev/vdb
devid    2 size 10.00GiB used 0.00B path /dev/vdc
devid    3 size 20.00GiB used 0.00B path /dev/vdd</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.363.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.364.1">size</span></strong><span class="kobospan" id="kobo.365.1"> value</span><a id="_idIndexMarker269" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.366.1"> is the size of each disk, and the </span><strong class="source-inline"><span class="kobospan" id="kobo.367.1">used</span></strong><span class="kobospan" id="kobo.368.1"> value is the size of the chunks allocated on that disk. </span><span class="kobospan" id="kobo.368.2">So, the new filesystem size is 80 GB, but no chunks from the new devices are allocated, leaving 79 GB of free space to allocate. </span><span class="kobospan" id="kobo.368.3">Use the usual </span><strong class="source-inline"><span class="kobospan" id="kobo.369.1">df</span></strong><span class="kobospan" id="kobo.370.1"> command to </span><span><span class="kobospan" id="kobo.371.1">show this:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.372.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.373.1">df -h /btrfs</span></strong><span class="kobospan1" id="kobo.374.1">
Filesystem      Size  Used Avail Use% Mounted on
/dev/vdb         80G  1.1G   79G   2% /btrfs</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.375.1">Btrfs could redistribute space and reclaim any wasted space. </span><span class="kobospan" id="kobo.375.2">If you add a disk, you can run the </span><strong class="source-inline"><span class="kobospan" id="kobo.376.1">balance</span></strong><span class="kobospan" id="kobo.377.1"> command to make sure everything gets spread across </span><span><span class="kobospan" id="kobo.378.1">the disks.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.379.1">It is very useful to balance any </span><strong class="source-inline"><span class="kobospan" id="kobo.380.1">Btrfs</span></strong><span class="kobospan" id="kobo.381.1"> volume subject to updates and to prevent the allocation of every chunk in the volume. </span><span class="kobospan" id="kobo.381.2">It is usually enough to balance chunks that are 50% or </span><span><span class="kobospan" id="kobo.382.1">70% used.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.383.1">To auto-balance the mounted </span><strong class="source-inline"><span class="kobospan" id="kobo.384.1">/btrfs</span></strong><span class="kobospan" id="kobo.385.1"> filesystem, run the </span><strong class="source-inline"><span class="kobospan" id="kobo.386.1">btrfs filesystem </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.387.1">balance</span></strong></span><span><span class="kobospan" id="kobo.388.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.389.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.390.1">btrfs filesystem balance /btrfs</span></strong><span class="kobospan1" id="kobo.391.1">
Done, had to relocate 3 out of 3 chunks</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.392.1">By re-running the </span><strong class="source-inline"><span class="kobospan" id="kobo.393.1">btrfs filesystem df</span></strong><span class="kobospan" id="kobo.394.1"> command, it shows the new distribution of chunks in </span><span><span class="kobospan" id="kobo.395.1">the filesystem:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.396.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.397.1">btrfs filesystem df /btrfs</span></strong><span class="kobospan1" id="kobo.398.1">
Data, single: total=1.00GiB, used=1.00GiB
</span><strong class="bold1"><span class="kobospan1" id="kobo.399.1">System, DUP: total=32.00MiB, used=16.00KiB</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.400.1">Metadata, DUP: total=256.00MiB, used=1.16MiB</span></strong><span class="kobospan1" id="kobo.401.1">
GlobalReserve, single: total=3.50MiB, used=0.00B</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.402.1">When adding a device, it is generally a good idea to run a balance on </span><span><span class="kobospan" id="kobo.403.1">the filesystem.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.404.1">Btrfs itself doesn’t perform periodic rebalancing on filesystems and might experience problems with disk space management. </span><span class="kobospan" id="kobo.404.2">If left unattended, these error messages could make it impossible to rebalance the partitions or devices on </span><span><span class="kobospan" id="kobo.405.1">the filesystem.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.406.1">The issue usually occurs when there is the right pattern of disk I/O and file sizes. </span><span class="kobospan" id="kobo.406.2">This causes inefficient use of disk space and prevents new writes to the disk, generating </span><strong class="source-inline"><span class="kobospan" id="kobo.407.1">No space left on </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.408.1">device</span></strong></span><span><span class="kobospan" id="kobo.409.1"> errors.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.410.1">To prevent this, run a long space allocation check now and then, usually based on the work cycle of our system. </span><span class="kobospan" id="kobo.410.2">The simplest way to explain this period of time could involve a </span><em class="italic"><span class="kobospan" id="kobo.411.1">cash cut</span></em><span class="kobospan" id="kobo.412.1"> for some businesses. </span><span class="kobospan" id="kobo.412.2">For example: if the business does the cash cut every 30th day of the month, we have a window of time one day before and one day after that date, which leaves </span><a id="_idIndexMarker270" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.413.1">us with 28 or 29 </span><em class="italic"><span class="kobospan" id="kobo.414.1">productive</span></em><span class="kobospan" id="kobo.415.1"> days in which the system cannot change. </span><span class="kobospan" id="kobo.415.2">On both dates, we could check the allocated space to confirm that everything </span><span><span class="kobospan" id="kobo.416.1">is OK.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.417.1">Let’s see how to perform this space </span><span><span class="kobospan" id="kobo.418.1">allocation check.</span></span></p>
<h2 id="_idParaDest-63" class="calibre7"><a id="_idTextAnchor127" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.419.1">Space allocation check</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.420.1">Btrfs allocates</span><a id="_idIndexMarker271" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.421.1"> chunks as large as 1/10 of the partition size, up to a maximum of 1 GB. </span><span class="kobospan" id="kobo.421.2">Ideally, at least one chunk must remain unallocated for use during the </span><span><span class="kobospan" id="kobo.422.1">rebalance operation.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.423.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.424.1">It is not necessary to run a rebalance if Btrfs has not allocated a significant part of the filesystem. </span><span class="kobospan" id="kobo.424.2">A significant part of the filesystem is greater than 80% of the size or the entire filesystem size minus </span><span><span class="kobospan" id="kobo.425.1">2 GB.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.426.1">To determine whether a rebalance would free up space, compare the amount of space allocated to the data with the amount of space used by the data. </span><span class="kobospan" id="kobo.426.2">If the difference between these is greater than the largest chunk size, then a rebalance would probably free up </span><span><span class="kobospan" id="kobo.427.1">some space.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.428.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.429.1">btrfs filesystem usage</span></strong><span class="kobospan" id="kobo.430.1"> command </span><a id="_idIndexMarker272" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.431.1">provides the information needed to find </span><span><span class="kobospan" id="kobo.432.1">both values:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer106">
<span class="kobospan" id="kobo.433.1"><img alt="Figure 4.7 – The Btrfs filesystem usage output" src="image/B19121_04_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.434.1">Figure 4.7 – The Btrfs filesystem usage output</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.435.1">Let’s create an extra file to better exemplify </span><span><span class="kobospan" id="kobo.436.1">the check:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.437.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.438.1">dd if=/dev/zero \</span></strong><span class="kobospan1" id="kobo.439.1">
&gt; </span><strong class="bold1"><span class="kobospan1" id="kobo.440.1">of=/btrfs/test/example2 bs=1M count=49152</span></strong><span class="kobospan1" id="kobo.441.1">
49152+0 records in
49152+0 records out
51539607552 bytes (52 GB, 48 GiB) copied, 70.17 s, 734 MB/s</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.442.1">Now that we have </span><a id="_idIndexMarker273" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.443.1">a filesystem with 49 GB used, let’s see how they </span><span><span class="kobospan" id="kobo.444.1">got allocated:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.445.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.446.1">btrfs filesystem df /btrfs</span></strong><span class="kobospan1" id="kobo.447.1">
Data, single: total=50.00GiB, used=48.45GiB
System, DUP: total=32.00MiB, used=16.00KiB
Metadata, DUP: total=256.00MiB, used=54.98MiB
GlobalReserve, single: total=53.69MiB, used=16.00KiB
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.448.1">btrfs filesystem show /btrfs</span></strong><span class="kobospan1" id="kobo.449.1">
Label: 'testbtrfs'  uuid: 6c8ccaad-f9a0-4957-919e-8d87e02078e3
Total devices 3 FS bytes used 48.51GiB
devid    1 size 50.00GiB used 34.56GiB path /dev/vdb
devid    2 size 10.00GiB used 3.00GiB path /dev/vdc
devid    3 size 20.00GiB used 13.00GiB path /dev/vdd</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.450.1">Use the </span><strong class="source-inline"><span class="kobospan" id="kobo.451.1">btrfs filesystem usage</span></strong><span class="kobospan" id="kobo.452.1"> command with the </span><strong class="source-inline"><span class="kobospan" id="kobo.453.1">–b</span></strong><span class="kobospan" id="kobo.454.1"> (bytes) parameter to calculate whether rebalancing </span><span><span class="kobospan" id="kobo.455.1">is necessary:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer107">
<span class="kobospan" id="kobo.456.1"><img alt="Figure 4.8 – The Btrfs filesystem usage output" src="image/B19121_04_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.457.1">Figure 4.8 – The Btrfs filesystem usage output</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.458.1">From the output, highlight</span><a id="_idIndexMarker274" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.459.1"> the size of the device, the allocation on the device, and the size and usage of </span><span><span class="kobospan" id="kobo.460.1">the data:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.461.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.462.1">btrfs filesystem usage -b /btrfs</span></strong><span class="kobospan1" id="kobo.463.1">
Overall:
    Device size:          85899345920
    Device allocated:          54291070976
    Device unallocated:     31608274944
    Device missing:          0
... </span><span class="kobospan1" id="kobo.463.2">output omitted...
</span><span class="kobospan1" id="kobo.463.3">Data,single: Size:53687091200, Used:52613349376 (98.00%)
... </span><span class="kobospan1" id="kobo.463.4">output omitted...</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.464.1">With this information, follow these steps to perform </span><span><span class="kobospan" id="kobo.465.1">the calculation:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.466.1">The device size is </span><strong class="source-inline1"><span class="kobospan" id="kobo.467.1">85899345920</span></strong><span class="kobospan" id="kobo.468.1">. </span><span><span class="kobospan" id="kobo.469.1">Calculate 80%:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.470.1">
85899345920 * 0.80 = 68719476736</span></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.471.1">The device size is </span><strong class="source-inline1"><span class="kobospan" id="kobo.472.1">85899345920</span></strong><span class="kobospan" id="kobo.473.1">. </span><span class="kobospan" id="kobo.473.2">Subtract 2 </span><span><span class="kobospan" id="kobo.474.1">GB (</span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.475.1">2147483648</span></strong></span><span><span class="kobospan" id="kobo.476.1">):</span></span><pre class="source-code"><span class="kobospan1" id="kobo.477.1">
85899345920 - 2147483648 = </span><strong class="bold1"><span class="kobospan1" id="kobo.478.1">83751862272</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.479.1">Compare both results. </span><span class="kobospan" id="kobo.479.2">Take the highest amount (</span><strong class="source-inline1"><span class="kobospan" id="kobo.480.1">83751862272</span></strong><span class="kobospan" id="kobo.481.1">) to compare against the amount allocated on </span><span><span class="kobospan" id="kobo.482.1">the device:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.483.1">
54291070976 </span><strong class="bold1"><span class="kobospan1" id="kobo.484.1">&lt; 83751862272</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.485.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.486.1">If the device allocation is smaller than the calculated condition, then this part of the check is negative, and there should be no need to run a rebalance on this filesystem. </span><span class="kobospan" id="kobo.486.2">But a data storage efficiency check must be performed to confirm that a rebalance is </span><span><span class="kobospan" id="kobo.487.1">not necessary.</span></span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.488.1">Estimate the</span><a id="_idIndexMarker275" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.489.1"> difference between the space allocated and the </span><span><span class="kobospan" id="kobo.490.1">space used:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.491.1">
53687091200 - 52613349376 = </span><strong class="bold1"><span class="kobospan1" id="kobo.492.1">1073741824</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.493.1">Calculate the </span><span><span class="kobospan" id="kobo.494.1">chunk size:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.495.1">
85899345920*0.10 = </span><strong class="bold1"><span class="kobospan1" id="kobo.496.1">8589934592</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.497.1">Compare </span><span><span class="kobospan" id="kobo.498.1">both results:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.499.1">8589934592 &gt;</span></strong><span class="kobospan1" id="kobo.500.1"> 1073741824</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.501.1">If the chunk size is greater than the difference, then the check is also negative. </span><span class="kobospan" id="kobo.501.2">Rebalancing is </span><span><span class="kobospan" id="kobo.502.1">not necessary.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.503.1">Rebalancing is only necessary if the device allocation is greater than 80% of the device size (or the device size minus 2 GB) and the space allocated and used is greater than the </span><span><span class="kobospan" id="kobo.504.1">chunk size.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.505.1">Remember, </span><em class="italic"><span class="kobospan" id="kobo.506.1">both conditions must not meet</span></em><span class="kobospan" id="kobo.507.1">. </span><span class="kobospan" id="kobo.507.2">If the first check is negative, it is necessary to run the second check to confirm that rebalancing is </span><span><span class="kobospan" id="kobo.508.1">not required.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.509.1">Fedora Linux</span><a id="_idIndexMarker276" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.510.1"> provides a tool to help us get a detailed report of the Btrfs filesystem’s usage. </span><span class="kobospan" id="kobo.510.2">Let’s see how to </span><span><span class="kobospan" id="kobo.511.1">use it.</span></span></p>
<h2 id="_idParaDest-64" class="calibre7"><a id="_idTextAnchor128" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.512.1">Using the btrfs-usage-report command</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.513.1">The primary</span><a id="_idIndexMarker277" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.514.1"> purpose of the </span><strong class="source-inline"><span class="kobospan" id="kobo.515.1">python-btrfs</span></strong><span class="kobospan" id="kobo.516.1"> module</span><a id="_idIndexMarker278" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.517.1"> is to inspect Btrfs filesystems, acting as a wrapper around low-level kernel calls and Btrfs data structures. </span><span class="kobospan" id="kobo.517.2">This module includes the </span><strong class="source-inline"><span class="kobospan" id="kobo.518.1">btrfs-usage-report</span></strong><span class="kobospan" id="kobo.519.1"> tool to show a report of the Btrfs </span><span><span class="kobospan" id="kobo.520.1">filesystem usage.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.521.1">To install the tool, install the </span><strong class="source-inline"><span class="kobospan" id="kobo.522.1">python3-btrfs</span></strong><span class="kobospan" id="kobo.523.1"> package with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.524.1">dnf</span></strong></span><span><span class="kobospan" id="kobo.525.1"> command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.526.1">
[root@workstation ~]# </span><strong class="bold1"><span class="kobospan1" id="kobo.527.1">dnf install python3-btrfs</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.528.1">Run the </span><strong class="source-inline"><span class="kobospan" id="kobo.529.1">btrfs-usage-report</span></strong><span class="kobospan" id="kobo.530.1"> command to get the report of the filesystem mounted on </span><strong class="source-inline"><span class="kobospan" id="kobo.531.1">/btrfs</span></strong><span class="kobospan" id="kobo.532.1">. </span><span class="kobospan" id="kobo.532.2">The report is complete, as shown in </span><span><em class="italic"><span class="kobospan" id="kobo.533.1">Figure 4</span></em></span><span><em class="italic"><span class="kobospan" id="kobo.534.1">.9</span></em></span><span><span class="kobospan" id="kobo.535.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.536.1">At the beginning, it shows </span><span><span class="kobospan" id="kobo.537.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.538.1">The </span><span><span class="kobospan" id="kobo.539.1">filesystem ID</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.540.1">The physical </span><span><span class="kobospan" id="kobo.541.1">space used</span></span></li>
<li class="calibre14"><span><span class="kobospan" id="kobo.542.1">The profiles</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.543.1">It also shows an estimate of the virtual space available and how much raw disk is allocated per </span><span><span class="kobospan" id="kobo.544.1">chunk type:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer108">
<span class="kobospan" id="kobo.545.1"><img alt="Figure 4.9 – The Btrfs-usage-report output" src="image/B19121_04_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.546.1">Figure 4.9 – The Btrfs-usage-report output</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.547.1">The last</span><a id="_idIndexMarker279" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.548.1"> part of</span><a id="_idIndexMarker280" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.549.1"> the report adds detailed information about storage </span><span><span class="kobospan" id="kobo.550.1">space allocation:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer109">
<span class="kobospan" id="kobo.551.1"><img alt="Figure 4.10 – The Btrfs-usage-report output" src="image/B19121_04_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.552.1">Figure 4.10 – The Btrfs-usage-report output</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.553.1">Besides checking </span><a id="_idIndexMarker281" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.554.1">the allocated space</span><a id="_idIndexMarker282" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.555.1"> and the efficiency of the data storage check, this tool helps optimize the storage space used on </span><span><span class="kobospan" id="kobo.556.1">our workstation.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.557.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.558.1">Get the complete output of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.559.1">btrfs-usage-report</span></strong><span class="kobospan" id="kobo.560.1"> command from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.561.1">/btrfs</span></strong><span class="kobospan" id="kobo.562.1"> filesystem of our GitHub repository </span><span><span class="kobospan" id="kobo.563.1">at </span></span><a href="https://github.com/PacktPublishing/Fedora-Linux-System-Administration/blob/main/chapter4/btrfs-usage-report_btrfs.txt" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.564.1">https://github.com/PacktPublishing/Fedora-Linux-System-Administration/blob/main/chapter4/btrfs-usage-report_btrfs.txt</span></span></a><span><span class="kobospan" id="kobo.565.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.566.1">Despite all these advanced features, the use of Brtfs as a filesystem is not the default in distributions other than Fedora Linux or OpenSUSE. </span><span class="kobospan" id="kobo.566.2">Generally, most distributions prefer to use LVM with </span><strong class="source-inline"><span class="kobospan" id="kobo.567.1">ext4</span></strong><span class="kobospan" id="kobo.568.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.569.1">xfs</span></strong><span class="kobospan" id="kobo.570.1"> as the</span><a id="_idIndexMarker283" class="pcalibre1 calibre6 pcalibre"/> <span><span class="kobospan" id="kobo.571.1">filesystem</span></span><span><a id="_idIndexMarker284" class="pcalibre1 calibre6 pcalibre"/></span><span><span class="kobospan" id="kobo.572.1"> format.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.573.1">Let’s see how different the Brtfs filesystem is </span><span><span class="kobospan" id="kobo.574.1">from LVM.</span></span></p>
<h1 id="_idParaDest-65" class="calibre5"><a id="_idTextAnchor129" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.575.1">Deep diving into Logical Volume Manager</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.576.1">Despite basic </span><a id="_idIndexMarker285" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.577.1">differences between Btrfs and LVM, they have a lot </span><span><span class="kobospan" id="kobo.578.1">in common:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.579.1">They focus on protecting against </span><span><span class="kobospan" id="kobo.580.1">filesystem corruption</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.581.1">They support single - or </span><span><span class="kobospan" id="kobo.582.1">multiple-device setup</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.583.1">They can create </span><span><span class="kobospan" id="kobo.584.1">quick snapshots</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.585.1">Several tools exist to help manage them in graphic or command - </span><span><span class="kobospan" id="kobo.586.1">line form</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.587.1">LVM sits on a layer before the filesystem, so it supports any filesystem. </span><span class="kobospan" id="kobo.587.2">LVM converts </span><em class="italic"><span class="kobospan" id="kobo.588.1">any</span></em><span class="kobospan" id="kobo.589.1"> device or partition into a physical device (</span><strong class="source-inline"><span class="kobospan" id="kobo.590.1">pv</span></strong><span class="kobospan" id="kobo.591.1">) that is dynamically manageable. </span><span class="kobospan" id="kobo.591.2">Physical devices get placed in volume groups (</span><strong class="source-inline"><span class="kobospan" id="kobo.592.1">vg</span></strong><span class="kobospan" id="kobo.593.1">), enabling the creation of logical </span><span><span class="kobospan" id="kobo.594.1">volumes (</span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.595.1">lv</span></strong></span><span><span class="kobospan" id="kobo.596.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.597.1">This is how an LVM structure gets </span><span><span class="kobospan" id="kobo.598.1">created sequentially:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.599.1">It creates physical devices with the available devices, using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.600.1">pvcreate [device1] [device2] ...</span></strong> <span><span class="kobospan" id="kobo.601.1">command.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.602.1">It joins the physical devices, creating the volume group, using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.603.1">vgcreate [vg_name] [pv1] [pv2] ...</span></strong> <span><span class="kobospan" id="kobo.604.1">command.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.605.1">It creates the logical volume with the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.606.1">lvcreate</span></strong></span><span><span class="kobospan" id="kobo.607.1"> command.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.608.1">To remove each layer from the LVM structure, run similar commands in </span><span><span class="kobospan" id="kobo.609.1">reverse order:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.610.1">To delete the logical volume, use the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.611.1">lvremove</span></strong></span><span><span class="kobospan" id="kobo.612.1"> command.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.613.1">Remove the volume group with the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.614.1">vgremove</span></strong></span><span><span class="kobospan" id="kobo.615.1"> command.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.616.1">Remove the physical devices with the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.617.1">pvremove</span></strong></span><span><span class="kobospan" id="kobo.618.1"> command.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.619.1">The following figure shows the LVM creation and </span><span><span class="kobospan" id="kobo.620.1">removal sequence:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer110">
<span class="kobospan" id="kobo.621.1"><img alt="Figure 4.11 – LVM creation and removal sequence and commands" src="image/B19121_04_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.622.1">Figure 4.11 – LVM creation and removal sequence and commands</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.623.1">Physical devices could be added or removed to grow or reduce a volume group. </span><span class="kobospan" id="kobo.623.2">In the same way, a logical </span><a id="_idIndexMarker286" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.624.1">volume could be extended or reduced but requires data verification before running it. </span><span class="kobospan" id="kobo.624.2">In the case of </span><strong class="source-inline"><span class="kobospan" id="kobo.625.1">xfs</span></strong><span class="kobospan" id="kobo.626.1"> filesystems on LVM, there is no logical </span><span><span class="kobospan" id="kobo.627.1">volume reduction.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.628.1">LVM takes a set of block devices and presents the system with a new block device (</span><strong class="source-inline"><span class="kobospan" id="kobo.629.1">lv</span></strong><span class="kobospan" id="kobo.630.1">) with a fixed mapping to </span><span><span class="kobospan" id="kobo.631.1">physical blocks.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.632.1">A Btrfs subvolume is different from an LVM logical volume, in the structure and behavior. </span><span class="kobospan" id="kobo.632.2">A </span><strong class="source-inline"><span class="kobospan" id="kobo.633.1">Btrfs</span></strong><span class="kobospan" id="kobo.634.1"> volume is a mountable filesystem tree, not a </span><span><span class="kobospan" id="kobo.635.1">block device.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.636.1">The following figure shows the </span><span><span class="kobospan" id="kobo.637.1">basic structures:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer111">
<span class="kobospan" id="kobo.638.1"><img alt="Figure 4.12 – Btrfs subvolumes layouts" src="image/B19121_04_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.639.1">Figure 4.12 – Btrfs subvolumes layouts</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.640.1">The typical </span><a id="_idIndexMarker287" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.641.1">Btrfs snapshot structure uses the </span><span><span class="kobospan" id="kobo.642.1">flat scheme.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.643.1">Let’s compare the snapshots of the Brtfs filesystem </span><span><span class="kobospan" id="kobo.644.1">and LVM.</span></span></p>
<h2 id="_idParaDest-66" class="calibre7"><a id="_idTextAnchor130" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.645.1">Differences between snapshots</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.646.1">LVM supports</span><a id="_idIndexMarker288" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.647.1"> read-only and read-write snapshots. </span><span class="kobospan" id="kobo.647.2">This eases the creation of consistent backups of active filesystems, with a defined size on the source volume group of the logical volume or an external source. </span><span class="kobospan" id="kobo.647.3">This allows snapshots to belong to a thin provisioned pool when the target LV is a thin LV, which doesn’t consume fixed-size chunks of the </span><span><span class="kobospan" id="kobo.648.1">source volume.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.649.1">Creating snapshots on LVM is similar to creating a logical volume. </span><span class="kobospan" id="kobo.649.2">Specify the snapshot name and the targeted LV, adding the following parameters to the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.650.1">lvcreate</span></strong></span><span><span class="kobospan" id="kobo.651.1"> command:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.652.1">lvcreate -s -n snapshot_name -L snapshot_size target_lv disk</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.653.1">After taking the snapshot, all modifications made on the target LV will be stored in the new snapshot LV, but the old data remains in the </span><span><span class="kobospan" id="kobo.654.1">source LV.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.655.1">As needed, use the snapshot LV to roll back some changes in the source LV, mounting it in the affected directory instead of the original LV. </span><span class="kobospan" id="kobo.655.2">Use the usual </span><strong class="source-inline"><span class="kobospan" id="kobo.656.1">mount</span></strong><span class="kobospan" id="kobo.657.1"> and </span><span><strong class="source-inline"><span class="kobospan" id="kobo.658.1">unmount</span></strong></span><span><span class="kobospan" id="kobo.659.1"> commands.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.660.1">Remove the snapshot as an LV with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.661.1">lvremove</span></strong></span><span><span class="kobospan" id="kobo.662.1"> command:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.663.1">lvremove /dev/vg_name/snapshot_name</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.664.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.665.1">It is possible to deactivate the logical volume before deleting it. </span><span class="kobospan" id="kobo.665.2">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.666.1">lvchange -an</span></strong><span class="kobospan" id="kobo.667.1"> command. </span><span class="kobospan" id="kobo.667.2">It will </span><em class="italic"><span class="kobospan" id="kobo.668.1">not</span></em><span class="kobospan" id="kobo.669.1"> show the prompt verifying whether you want to delete an active </span><span><span class="kobospan" id="kobo.670.1">logical volume.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.671.1">Snapshots in</span><a id="_idIndexMarker289" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.672.1"> Btrfs are </span><strong class="bold"><span class="kobospan" id="kobo.673.1">COW clones</span></strong><span class="kobospan" id="kobo.674.1"> of a </span><a id="_idIndexMarker290" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.675.1">complete subvolume. </span><span class="kobospan" id="kobo.675.2">They look similar to a new subvolume that contains the data of the cloned subvolume, but any changes in one do not affect the other. </span><span class="kobospan" id="kobo.675.3">The space consumed increases as the original subvolume and the snapshot </span><span><span class="kobospan" id="kobo.676.1">grow apart.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.677.1">Create a snapshot using the </span><strong class="source-inline"><span class="kobospan" id="kobo.678.1">btrfs subvolume</span></strong><span class="kobospan" id="kobo.679.1"> command stating that it is a snapshot. </span><span class="kobospan" id="kobo.679.2">Observe the following steps to create a snapshot on our </span><strong class="source-inline"><span class="kobospan" id="kobo.680.1">/btrfs</span></strong><span class="kobospan" id="kobo.681.1"> filesystem from the </span><em class="italic"><span class="kobospan" id="kobo.682.1">Creating a Btrfs </span></em><span><em class="italic"><span class="kobospan" id="kobo.683.1">filesystem</span></em></span><span><span class="kobospan" id="kobo.684.1"> section:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.685.1">List the subvolumes of the filesystem mounted </span><span><span class="kobospan" id="kobo.686.1">on </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.687.1">/btrfs</span></strong></span><span><span class="kobospan" id="kobo.688.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.689.1">[root@workstation ~]# btrfs subvolume list /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.690.1">ID 256 gen 72 top level 5 path test</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.691.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.692.1">The top-level subvolume with </span><strong class="source-inline1"><span class="kobospan" id="kobo.693.1">Btrfs</span></strong><span class="kobospan" id="kobo.694.1"> ID </span><strong class="source-inline1"><span class="kobospan" id="kobo.695.1">5</span></strong><span class="kobospan" id="kobo.696.1"> is the root of the volume. </span><span class="kobospan" id="kobo.696.2">All subvolumes mount </span><span><span class="kobospan" id="kobo.697.1">below it.</span></span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.698.1">Create a snapshot of the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.699.1">test</span></strong></span><span><span class="kobospan" id="kobo.700.1"> subvolume:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.701.1">[root@workstation ~]# btrfs subvolume snapshot \</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.702.1">&gt; /btrfs/test /btrfs/test_snapshot</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.703.1">Create a snapshot of '/btrfs/test' in '/btrfs/test_snapshot'</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.704.1">Listing the subvolumes again displays </span><span><span class="kobospan" id="kobo.705.1">the snapshot:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.706.1">[root@workstation ~]# btrfs subvolume list /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.707.1">ID 256 gen 76 top level 5 path test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.708.1">ID 257 gen 76 top level 5 path test_snapshot</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.709.1">[root@workstation ~]# ls /btrfs/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.710.1">test  test_snapshot</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.711.1">Inspect the directories to verify that they contain the </span><span><span class="kobospan" id="kobo.712.1">same data:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.713.1">[root@workstation ~]# tree /btrfs/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.714.1">/btrfs/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.715.1">├── test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.716.1">│   └── </span></strong><strong class="bold1"><span class="kobospan1" id="kobo.717.1">example</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.718.1">└── test_snapshot</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.719.1">    └── example</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.720.1">3 directories, 2 files</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.721.1">With COW, each</span><a id="_idIndexMarker291" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.722.1"> subvolume could change without changes in one affecting </span><span><span class="kobospan" id="kobo.723.1">the other.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.724.1">The differences between Btrfs and LVM </span><span><span class="kobospan" id="kobo.725.1">are remarkable:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.726.1">A Btrfs subvolume holds the capacity of the filesystem to which it belongs. </span><span class="kobospan" id="kobo.726.2">A logical volume in LVM contains a capacity, which is a space reservation of the volume group it </span><span><span class="kobospan" id="kobo.727.1">belongs to.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.728.1">A Btrfs snapshot is a full-fledged subvolume, and once created there is no "original" and "snapshot." </span><span class="kobospan" id="kobo.728.2">On LVM, a snapshot depends on the logical volume from the one that it </span><span><span class="kobospan" id="kobo.729.1">came from.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.730.1">For example, it is not possible to resize a logical volume or move its data with the </span><strong class="source-inline"><span class="kobospan" id="kobo.731.1">pvmove</span></strong><span class="kobospan" id="kobo.732.1"> command (from one physical volume to another) while having active </span><a id="_idIndexMarker292" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.733.1">snapshots of that </span><span><span class="kobospan" id="kobo.734.1">logical volume.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.735.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.736.1">For more information about the LVM commands and their Btrfs equivalents, refer to the Fedora wiki article </span><span><span class="kobospan" id="kobo.737.1">at </span></span><a href="https://fedoraproject.org/wiki/User:Chrismurphy/lvm2btrfs" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.738.1">https://fedoraproject.org/wiki/User:Chrismurphy/lvm2btrfs</span></span></a><span><span class="kobospan" id="kobo.739.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.740.1">Let’s now learn about Fedora’s latest approach to storage management, </span><span><span class="kobospan" id="kobo.741.1">Stratis storage.</span></span></p>
<h1 id="_idParaDest-67" class="calibre5"><a id="_idTextAnchor131" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.742.1">Discovering Stratis storage</span></h1>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.743.1">Stratis</span></strong><span class="kobospan" id="kobo.744.1"> is a command-line</span><a id="_idIndexMarker293" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.745.1"> tool designed to simplify storage management. </span><span class="kobospan" id="kobo.745.2">It uses a hybrid approach with both user-space and kernel components, based on existing block device managers, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.746.1">device mapper</span></strong><span class="kobospan" id="kobo.747.1">, and existing filesystems such </span><span><span class="kobospan" id="kobo.748.1">as </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.749.1">XFS</span></strong></span><span><span class="kobospan" id="kobo.750.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.751.1">Here’s what you can do </span><span><span class="kobospan" id="kobo.752.1">with Stratis:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.753.1">Create, modify, and destroy </span><span><span class="kobospan" id="kobo.754.1">storage pools</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.755.1">Allocate and detach filesystems from </span><span><span class="kobospan" id="kobo.756.1">storage pools</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.757.1">Encrypt and decrypt </span><span><span class="kobospan" id="kobo.758.1">filesystem data</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.759.1">Stratis storage brings together common storage management tools and automates them for ease of use. </span><span class="kobospan" id="kobo.759.2">Here are some things </span><span><span class="kobospan" id="kobo.760.1">it uses:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.761.1">device-mapper</span></strong><span class="kobospan" id="kobo.762.1"> – A framework for logical to physical mapping of </span><span><span class="kobospan" id="kobo.763.1">data blocks</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.764.1">LUKS</span></strong><span class="kobospan" id="kobo.765.1"> – An on-disk format for encryption that can securely manage </span><span><span class="kobospan" id="kobo.766.1">multiple passwords</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.767.1">XFS</span></strong><span class="kobospan" id="kobo.768.1"> – A scalable, journaling, and </span><span><span class="kobospan" id="kobo.769.1">performant filesystem</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.770.1">Clevis</span></strong><span class="kobospan" id="kobo.771.1"> – A framework for </span><span><span class="kobospan" id="kobo.772.1">automated decryption</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.773.1">Here are the </span><span><span class="kobospan" id="kobo.774.1">Stratis components:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.775.1">Blockdev</span></strong><span class="kobospan" id="kobo.776.1"> – Block devices, either a disk or </span><span><span class="kobospan" id="kobo.777.1">a partition.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.778.1">Pool</span></strong><span class="kobospan" id="kobo.779.1"> – Consists of one or more block devices. </span><span class="kobospan" id="kobo.779.2">A pool has a fixed total size, which represents the sum of all the block devices present </span><span><span class="kobospan" id="kobo.780.1">in it.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.781.1">Filesystem</span></strong><span class="kobospan" id="kobo.782.1"> – Filesystems don’t have a fixed total size, thinly provisioned. </span><span class="kobospan" id="kobo.782.2">The real size of the filesystem grows with the data stored in it. </span><span class="kobospan" id="kobo.782.3">The thin volume and the filesystem increase automatically. </span><span class="kobospan" id="kobo.782.4">Each pool could contain one or more filesystems, formatted </span><span><span class="kobospan" id="kobo.783.1">with XFS.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.784.1">The following</span><a id="_idIndexMarker294" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.785.1"> diagram shows the layout of the components in the </span><span><span class="kobospan" id="kobo.786.1">Stratis pool:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer112">
<span class="kobospan" id="kobo.787.1"><img alt="Figure 4.13 – Stratis storage components" src="image/B19121_04_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.788.1">Figure 4.13 – Stratis storage components</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.789.1">Let’s create a Stratis test pool to show </span><span><span class="kobospan" id="kobo.790.1">its capabilities.</span></span></p>
<h2 id="_idParaDest-68" class="calibre7"><a id="_idTextAnchor132" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.791.1">Creating a Stratis pool</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.792.1">For this</span><a id="_idIndexMarker295" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.793.1"> practice </span><a id="_idIndexMarker296" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.794.1">example, reuse the disks used in the </span><em class="italic"><span class="kobospan" id="kobo.795.1">Btrfs</span></em><span class="kobospan" id="kobo.796.1"> section in </span><span><span class="kobospan" id="kobo.797.1">this chapter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.798.1">Follow </span><span><span class="kobospan" id="kobo.799.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.800.1">Unmount the </span><strong class="source-inline1"><span class="kobospan" id="kobo.801.1">Btrfs</span></strong><span class="kobospan" id="kobo.802.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.803.1">/test</span></strong><span class="kobospan" id="kobo.804.1"> filesystem and remove the </span><strong class="source-inline1"><span class="kobospan" id="kobo.805.1">/</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.806.1">btrfs</span></strong></span><span><span class="kobospan" id="kobo.807.1"> directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.808.1">[root@workstation ~]# umount /btrfs/test</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.809.1">[root@workstation ~]# umount /btrfs</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.810.1">[root@workstation ~]# rm -rf /btrfs</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.811.1">Removes the </span><strong class="source-inline1"><span class="kobospan" id="kobo.812.1">Btrfs</span></strong><span class="kobospan" id="kobo.813.1"> filesystem from the storage devices using the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.814.1">wipefs</span></strong></span><span><span class="kobospan" id="kobo.815.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.816.1">[root@workstation ~]# wipefs /dev/vdb --all –f</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.817.1">[root@workstation ~]# wipefs /dev/vdc --all -f</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.818.1">[root@workstation ~]# wipefs /dev/vdd --all -f</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.819.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.820.1">--all</span></strong><span class="kobospan" id="kobo.821.1"> parameter deletes all </span><span><span class="kobospan" id="kobo.822.1">available signatures.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.823.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.824.1">-f</span></strong><span class="kobospan" id="kobo.825.1"> parameter forces erasure even if the filesystem </span><span><span class="kobospan" id="kobo.826.1">is mounted.</span></span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.827.1">Install Stratis using the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.828.1">dnf</span></strong></span><span><span class="kobospan" id="kobo.829.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.830.1">[root@workstation ~]# dnf install stratis-cli stratisd</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.831.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.832.1">systemctl</span></strong><span class="kobospan" id="kobo.833.1"> command to enable the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.834.1">stratisd</span></strong></span><span><span class="kobospan" id="kobo.835.1"> service:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.836.1">[root@workstation ~]# systemctl enable --now stratisd</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.837.1">With the </span><strong class="source-inline1"><span class="kobospan" id="kobo.838.1">fdisk</span></strong><span class="kobospan" id="kobo.839.1"> command, verify the size of </span><span><span class="kobospan" id="kobo.840.1">the disk:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer113">
<span class="kobospan" id="kobo.841.1"><img alt="Figure 4.14 – Checking the disk size" src="image/B19121_04_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.842.1">Figure 4.14 – Checking the disk size</span></p>
<ol class="calibre13">
<li value="6" class="calibre14"><span class="kobospan" id="kobo.843.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.844.1">stratis pool create</span></strong><span class="kobospan" id="kobo.845.1"> command</span><a id="_idIndexMarker297" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.846.1"> to create</span><a id="_idIndexMarker298" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.847.1"> the pool test on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.848.1">/</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.849.1">dev/vdb</span></strong></span><span><span class="kobospan" id="kobo.850.1"> device:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.851.1">[root@workstation ~]# stratis pool create test /dev/vdb</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.852.1">List the Stratis pool using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.853.1">stratis pool </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.854.1">list</span></strong></span><span><span class="kobospan" id="kobo.855.1"> command:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer114">
<span class="kobospan" id="kobo.856.1"><img alt="Figure 4.15 – Stratis pool list" src="image/B19121_04_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.857.1">Figure 4.15 – Stratis pool list</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.858.1">The following table lists the fields of the </span><strong class="source-inline"><span class="kobospan" id="kobo.859.1">stratis pool </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.860.1">list</span></strong></span><span><span class="kobospan" id="kobo.861.1"> output:</span></span></p>
<table class="no-table-style" id="table002">
<colgroup class="calibre10">
<col class="calibre11"/>
<col class="calibre11"/>
</colgroup>
<tbody class="calibre12">
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.862.1">Field</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.863.1">Description</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.864.1">Name</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.865.1">The name of </span><span><span class="kobospan" id="kobo.866.1">the pool</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.867.1">Total/Used/Free</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.868.1">The physical usage statistics for </span><span><span class="kobospan" id="kobo.869.1">the pool</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.870.1">Properties</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.871.1">Boolean-valued properties that the pool may have. </span><span class="kobospan" id="kobo.871.2">Each property has a two-letter code in camel case. </span><span class="kobospan" id="kobo.871.3">If the pool does not have the property, add a </span><strong class="source-inline"><span class="kobospan" id="kobo.872.1">~</span></strong><span class="kobospan" id="kobo.873.1"> symbol, which stands for </span><em class="italic"><span class="kobospan" id="kobo.874.1">negation</span></em><span class="kobospan" id="kobo.875.1">, to the </span><span><span class="kobospan" id="kobo.876.1">property code.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.877.1">If the engine has experienced an error in obtaining the property, add a </span><strong class="source-inline"><span class="kobospan" id="kobo.878.1">?</span></strong><span class="kobospan" id="kobo.879.1"> symbol, which stands for </span><em class="italic"><span class="kobospan" id="kobo.880.1">unknown</span></em><span class="kobospan" id="kobo.881.1">, to the </span><span><span class="kobospan" id="kobo.882.1">property code.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.883.1">The property codes are </span><span><span class="kobospan" id="kobo.884.1">as follows:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.885.1">Ca</span></strong><span class="kobospan" id="kobo.886.1"> - Indicates that the pool has </span><span><span class="kobospan" id="kobo.887.1">a cache</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.888.1">Cr</span></strong><span class="kobospan" id="kobo.889.1"> - Indicates </span><span><span class="kobospan" id="kobo.890.1">encrypted pool</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.891.1">Op</span></strong><span class="kobospan" id="kobo.892.1"> - indicates that the pool </span><span><span class="kobospan" id="kobo.893.1">allows over-provisioning</span></span></li>
</ul>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.894.1">UUID</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.895.1">U</span></span><span class="kobospan" id="kobo.896.1">niversally </span><span lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.897.1">U</span></span><span class="kobospan" id="kobo.898.1">nique </span><span lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.899.1">ID</span></span><span class="kobospan" id="kobo.900.1">entifier of </span><span><span class="kobospan" id="kobo.901.1">the pool</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.902.1">Alerts</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.903.1">Anything unusual or urgent information about the pool that the user needs </span><span><span class="kobospan" id="kobo.904.1">information on.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="calibre3"><span class="kobospan" id="kobo.905.1">Let’s now</span><a id="_idIndexMarker299" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.906.1"> add</span><a id="_idIndexMarker300" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.907.1"> another device to the pool to see how the available space in the </span><span><span class="kobospan" id="kobo.908.1">pool increases:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.909.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.910.1">stratis pool add-data</span></strong><span class="kobospan" id="kobo.911.1"> command to add the </span><strong class="source-inline1"><span class="kobospan" id="kobo.912.1">/dev/vdc</span></strong><span class="kobospan" id="kobo.913.1"> device to the Stratis pool and list the pool again to observe </span><span><span class="kobospan" id="kobo.914.1">the change:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer115">
<span class="kobospan" id="kobo.915.1"><img alt="Figure 4.16 – Stratis pool list" src="image/B19121_04_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.916.1">Figure 4.16 – Stratis pool list</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.917.1">Now let’s create a filesystem to show the differences from a </span><span><span class="kobospan" id="kobo.918.1">common filesystem.</span></span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.919.1">Create the filesystem data using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.920.1">stratis filesystem </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.921.1">create</span></strong></span><span><span class="kobospan" id="kobo.922.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.923.1">[root@workstation ~]# stratis filesystem create test data</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.924.1">List the</span><a id="_idIndexMarker301" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.925.1"> filesystems in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.926.1">test</span></strong><span class="kobospan" id="kobo.927.1"> pool to observe their </span><a id="_idIndexMarker302" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.928.1">properties. </span><span class="kobospan" id="kobo.928.2">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.929.1">stratis filesystem </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.930.1">list</span></strong></span><span><span class="kobospan" id="kobo.931.1"> command:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer116">
<span class="kobospan" id="kobo.932.1"><img alt="Figure 4.17 – Stratis filesystem list" src="image/B19121_04_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.933.1">Figure 4.17 – Stratis filesystem list</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.934.1">Note that the total size of the filesystem is 1 TiB, even though the sum of the actual available disk space is </span><span><span class="kobospan" id="kobo.935.1">60 GiB:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.936.1">[root@workstation ~]# stratis filesystem list test</span></strong><span class="kobospan1" id="kobo.937.1">
Pool   Filesystem   </span><strong class="bold1"><span class="kobospan1" id="kobo.938.1">Total / Used / Free</span></strong><span class="kobospan1" id="kobo.939.1">
test   data         </span><strong class="bold1"><span class="kobospan1" id="kobo.940.1">1 TiB / 546 MiB / 1023.47 GiB</span></strong><span class="kobospan1" id="kobo.941.1">
...output omitted...</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.942.1">As mentioned, the filesystem gets created on a thinly provisioned 1 TiB block device by design. </span><span class="kobospan" id="kobo.942.2">Stratis handles the allocation of blocks from the pool and resizes the </span><strong class="source-inline"><span class="kobospan" id="kobo.943.1">XFS</span></strong><span class="kobospan" id="kobo.944.1"> filesystem on demand during </span><span><span class="kobospan" id="kobo.945.1">its lifetime.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.946.1">Stratis also facilitates the creation of snapshots of filesystems. </span><span class="kobospan" id="kobo.946.2">A Stratis snapshot is a thinly provisioned real-time read/write copy of the </span><span><span class="kobospan" id="kobo.947.1">source filesystem.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.948.1">Let’s see how to </span><span><span class="kobospan" id="kobo.949.1">create snapshots.</span></span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.950.1">Use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.951.1">stratis filesystem snapshot</span></strong><span class="kobospan" id="kobo.952.1"> command to create the snapshot, and</span><a id="_idIndexMarker303" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.953.1"> then list the filesystems of </span><span><span class="kobospan" id="kobo.954.1">the pool:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer117">
<span class="kobospan" id="kobo.955.1"><img alt="Figure 4.18 – Stratis filesystem list" src="image/B19121_04_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.956.1">Figure 4.18 – Stratis filesystem list</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.957.1">The filesystems and their snapshots could mount in the traditional way in the operating system. </span><span class="kobospan" id="kobo.957.2">Use the </span><strong class="source-inline"><span class="kobospan" id="kobo.958.1">mount</span></strong><span class="kobospan" id="kobo.959.1"> command and, to keep them mounted permanently, configure an entry in the </span><strong class="source-inline"><span class="kobospan" id="kobo.960.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.961.1">etc/fstab</span></strong></span><span><span class="kobospan" id="kobo.962.1"> file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.963.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.964.1">For more information about Stratis, refer to the Stratis documentation </span><span><span class="kobospan" id="kobo.965.1">at </span></span><a href="https://stratis-storage.github.io/howto/" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.966.1">https://stratis-storage.github.io/howto/</span></span></a><span><span class="kobospan" id="kobo.967.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.968.1">This concludes our review of storage basics. </span><span class="kobospan" id="kobo.968.2">In the following chapters, we will review some other </span><a id="_idIndexMarker304" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.969.1">fundamental concepts, such as networking </span><a id="_idIndexMarker305" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.970.1">and the use of applications, along with applying system administration of </span><span><span class="kobospan" id="kobo.971.1">Linux systems.</span></span></p>
<h1 id="_idParaDest-69" class="calibre5"><a id="_idTextAnchor133" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.972.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.973.1">This chapter consisted of reviewing the basic concepts of storage management and focused on the Btrfs filesystem, performing practical examples to understand its use and main features, identifying storage devices, formatting storage devices, creating pools, and </span><span><span class="kobospan" id="kobo.974.1">mounting filesystems.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.975.1">We clarified some items that assist in optimizing the allocation of storage space and learned the main differences between Btrfs subvolumes </span><span><span class="kobospan" id="kobo.976.1">and LVM.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.977.1">As a bonus, we discussed the Fedora Project’s new approach to storage management with Stratis, the intention of which is to ease </span><span><span class="kobospan" id="kobo.978.1">storage management.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.979.1">In the next chapter, we will cover the fundamental concepts and configurations of network connections and how to </span><span><span class="kobospan" id="kobo.980.1">optimize them.</span></span></p>
<h1 id="_idParaDest-70" class="calibre5"><a id="_idTextAnchor134" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.981.1">Further reading</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.982.1">To learn more about the topics that were covered in the chapter, please visit the </span><span><span class="kobospan" id="kobo.983.1">following links:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.984.1">Fedora Wiki – </span></em><span><em class="italic"><span class="kobospan" id="kobo.985.1">Btrfs</span></em></span><span><span class="kobospan" id="kobo.986.1">: </span></span><a href="https://fedoraproject.org/wiki/Btrfs" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.987.1">https://fedoraproject.org/wiki/Btrfs</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.988.1">Btrfs </span></em><span><em class="italic"><span class="kobospan" id="kobo.989.1">documentation</span></em></span><span><span class="kobospan" id="kobo.990.1">: </span></span><a href="https://btrfs.readthedocs.io/en/latest/" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.991.1">https://btrfs.readthedocs.io/en/latest/</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.992.1">Choose between Btrfs and </span></em><span><em class="italic"><span class="kobospan" id="kobo.993.1">LVM-ext4</span></em></span><span><span class="kobospan" id="kobo.994.1">: </span></span><a href="https://fedoramagazine.org/choose-between-btrfs-and-lvm-ext4/" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.995.1">https://fedoramagazine.org/choose-between-btrfs-and-lvm-ext4/</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.996.1">Getting started with Stratis – up and </span></em><span><em class="italic"><span class="kobospan" id="kobo.997.1">running</span></em></span><span><span class="kobospan" id="kobo.998.1">: </span></span><a href="https://fedoramagazine.org/getting-started-with-stratis-up-and-running/" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.999.1">https://fedoramagazine.org/getting-started-with-stratis-up-and-running/</span></span></a></li>
<li class="calibre14"><em class="italic"><span class="kobospan" id="kobo.1000.1">Stratis </span></em><span><em class="italic"><span class="kobospan" id="kobo.1001.1">storage</span></em></span><span><span class="kobospan" id="kobo.1002.1">: </span></span><a href="https://stratis-storage.github.io/" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.1003.1">https://stratis-storage.github.io/</span></span></a></li>
</ul>
</div>
</body></html>