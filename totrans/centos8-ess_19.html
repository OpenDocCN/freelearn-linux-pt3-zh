<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer197" class="_idGenObjectStyleOverride-1">&#13;
			<p id="_idParaDest-199" class="Chapter-Title"><span class="ChapterMarker">21. </span><a id="_idTextAnchor263"/>Creating KVM Virtual Machines using Cockpit and virt-manager</p>&#13;
			<p class="My-Basic-Paragraph">KVM-based virtual machines can easily be configured on CentOS 8 using either the <a id="_idIndexMarker480"/><span class="My-Italic _idGenCharOverride-1">virt-install</span> command-line tool, the <span class="My-Italic _idGenCharOverride-1">virt-manager</span> GUI tool or the Virtual Machines module of the Cockpit web console. For the purposes of this chapter we will use Cockpit and the <span class="My-Italic _idGenCharOverride-1">virt-manager</span> tool to install a Fedora distribution as a KVM guest on a CentOS 8 host. Before proceeding, however, it is important to note that <a id="_idIndexMarker481"/><span class="My-Italic _idGenCharOverride-1">virt-manager</span> is now deprecated in CentOS 8 with the intention that it will be fully replaced by the Cockpit module in the future. As of CentOS 8, however, <span class="My-Italic _idGenCharOverride-1">virt-manager</span> is still available and includes features not yet integrated into the Cockpit virtual machine module. </p>&#13;
			<p class="My-Basic-Paragraph">The command-line approach to virtual machine creation will be covered in the next chapter entitled <a href="../Text/KVM_Create_VM_Command-line.xhtml#_idTextAnchor278"><span class="My-Italic _idGenCharOverride-1">“Creating KVM Virtual Machines with virt-install and virsh”</span></a>.  </p>&#13;
			<p id="_idParaDest-200" class="Heading-1-1"><span class="Heading11Marker">21.1 </span><a id="_idTextAnchor264"/>Installing the <a id="_idIndexMarker482"/>Cockpit Virtual Machines Module</p>&#13;
			<p class="My-Basic-Paragraph">By default, the virtual machines module is not included in a standard Cockpit installation. Assuming that Cockpit is installed and configured, the virtual machines module may be installed as follows:</p>&#13;
			<p class="Code"># dnf install cockpit-machines</p>&#13;
			<p class="My-Basic-Paragraph">Once installed, the Virtual Machines option (marked A in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor265"><span class="My-Italic _idGenCharOverride-1">Figure 21-1</span></a>) will appear in the navigation panel next time you log into the Cockpit interface:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-1" src="Images/centos_8_cockpit_virtual_machines.png" alt="" width="1448" height="670"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-1</span><a id="_idTextAnchor265"/></p>&#13;
			<p id="_idParaDest-201" class="Heading-1-1"><span class="Heading11Marker">21.2 </span><a id="_idTextAnchor266"/>Creating a Virtual Machine in Cockpit</p>&#13;
			<p class="My-Basic-Paragraph"><a id="_idIndexMarker483"/><a id="_idIndexMarker484"/>To create a virtual machine in Cockpit, simply click on the <span class="My-Italic _idGenCharOverride-1">Create VM</span> button marked B in <a href="../Text/KVM_Create_VM_Command-line.xhtml#_idTextAnchor281"><span class="My-Italic _idGenCharOverride-1">Figure 22-1</span></a> to display the creation dialog. </p>&#13;
			<p class="My-Basic-Paragraph">Within the dialog, enter a name for the machine and choose whether the installation media is in the form of an ISO accessible via a URL or a local filesystem path. Ideally, also select the vendor and operating system type information for the guest. While not essential, this will aid the system in optimizing the virtual machine for the guest.</p>&#13;
			<p class="My-Basic-Paragraph">Also specify the size of the virtual disk drive to be used for the operating system installation and the amount of memory to be allocated to the virtual machine:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-2" src="Images/centos_8_cockpit_create_virtual_machine.png" alt="" width="1098" height="710"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-2</span><a id="_idTextAnchor267"/></p>&#13;
			<p class="My-Basic-Paragraph">For this example, leave the<span class="My-Italic _idGenCharOverride-1"> Immediately Start VM</span> option unselected and, once the new virtual machine has been configured, click on the <span class="My-Italic _idGenCharOverride-1">Create</span> button to build the virtual machine. After the creation process is complete, the new VM will appear in Cockpit as shown in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor268"><span class="My-Italic _idGenCharOverride-1">Figure 21-3</span></a>:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-3" src="Images/centos_8_cockpit_vm_ready_to_install.png" alt="" width="1305" height="608"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-3</span><a id="_idTextAnchor268"/></p>&#13;
			<p class="My-Basic-Paragraph">As described in <a href="../Text/Virtualization_Overview.xhtml#_idTextAnchor248"><span class="My-Italic _idGenCharOverride-1">“An Overview of Virtualization Techniques”</span></a>, KVM provides virtual machines with a number of options in terms of network configuration. To view and change the network settings of a virtual machine, click on the Networks tab as shown  in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor269"><span class="My-Italic _idGenCharOverride-1">Figure 21-4</span></a> followed by the Edit button located next to the network entry:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-4" src="Images/centos_8_cockpit_vm_network_configuration.png" alt="" width="1777" height="441"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-4</span><a id="_idTextAnchor269"/></p>&#13;
			<p class="My-Basic-Paragraph">In the resulting dialog, the Network Type menu may be used to change the type of network connection, for example from virtual network (NAT) to direct connection (MacVTap).</p>&#13;
			<p id="_idParaDest-202" class="Heading-1-1"><span class="Heading11Marker">21.3 </span><a id="_idTextAnchor270"/>Starting the Installation</p>&#13;
			<p class="My-Basic-Paragraph">To start the new virtual machine and begin installing the guest operating system from the designated installation media, click on the <span class="My-Italic _idGenCharOverride-1">Install</span> button highlighted in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor268"><span class="My-Italic _idGenCharOverride-1">Figure 21-3</span></a> above. Cockpit will start the virtual machine and switch to the Consoles view where the guest OS screen will appear:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-5" src="Images/rhel_8_cockpit_vm_console.png" alt="" width="906" height="674"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-5</span></p>&#13;
			<p class="My-Basic-Paragraph">If the installation fails, check the message to see if it reads as follows:</p>&#13;
			<p class="Code">Could not open ‘&lt;path to iso image&gt;’: Permission denied</p>&#13;
			<p class="Code">Domain installation does not appear to have been successful.</p>&#13;
			<p class="My-Basic-Paragraph">This usually occurs because the QEMU emulator runs as a user named qemu which does not have access to the directory in which the ISO installation image is located. To resolve this issue, change directory to the location of the ISO image file and add the qemu user to the access control list (ACL) of the parent directory as follows:</p>&#13;
			<p class="Code"># cd /path/to/iso/directory</p>&#13;
			<p class="Code"># setfacl --modify u:qemu:x ..</p>&#13;
			<p class="My-Basic-Paragraph">After making this change, check the setting as follows:</p>&#13;
			<p class="Code"># getfacl ..</p>&#13;
			<p class="Code"># file: ..</p>&#13;
			<p class="Code"># owner: demo</p>&#13;
			<p class="Code"># group: demo</p>&#13;
			<p class="Code">user::rwx</p>&#13;
			<p class="Code"><span class="My-Bold _idGenCharOverride-2">user:qemu:--x</span></p>&#13;
			<p class="Code">group::---</p>&#13;
			<p class="Code">mask::--x</p>&#13;
			<p class="Code">other::---</p>&#13;
			<p class="My-Basic-Paragraph">Once these changes have been made, click on the Install button once again to complete the installation.</p>&#13;
			<p class="My-Basic-Paragraph">To complete the installation, interact with the screen in the Consoles view just as you would if you were installing the operating system on physical hardware.</p>&#13;
			<p class="My-Basic-Paragraph">It is also possible to connect with and display the graphical console for the VM from outside the Cockpit browser session using the <a id="_idIndexMarker485"/><a id="_idIndexMarker486"/><a id="_idIndexMarker487"/><span class="My-Italic _idGenCharOverride-1">virt-viewer</span> tool. To install <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> on a CentOS 8 system, run the following command:</p>&#13;
			<p class="Code"># dnf install virt-viewer</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> tool is also available for Windows systems and can be downloaded from the following URL:</p>&#13;
			<p class="My-Basic-Paragraph"><a href="https://virt-manager.org/download/"><span class="Hyperlink _idGenCharOverride-1">https://virt-manager.org/download/</span></a></p>&#13;
			<p class="My-Basic-Paragraph">To connect with a virtual machine running on the local host, simply run <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> and select the virtual machine to which you wish to connect from the resulting dialog:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-6" src="Images/rhel_8_virt-viewer-select_vm.png" alt="" width="289" height="238"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-6</span></p>&#13;
			<p class="My-Basic-Paragraph">Alternatively, it is also possible to specify the virtual machine name and bypass the selection dialog, for example:</p>&#13;
			<p class="Code"># virt-viewer myFedoraGuest</p>&#13;
			<p class="My-Basic-Paragraph">To connect a <a id="_idIndexMarker488"/><span class="My-Italic _idGenCharOverride-1">virt-viewer</span> instance to a virtual machine running on a remote host using SSH, the following command can be used:</p>&#13;
			<p class="Code">$ virt-viewer --connect qemu+ssh://&lt;user&gt;@&lt;host&gt;/system &lt;guest name&gt;</p>&#13;
			<p class="My-Basic-Paragraph">For example:</p>&#13;
			<p class="Code">$ virt-viewer --connect qemu+ssh://root@192.168.1.122/system MyFedoraGuest</p>&#13;
			<p class="My-Basic-Paragraph">When using this technique it is important to note that you will be prompted twice for the user password before the connection will be fully established.</p>&#13;
			<p class="My-Basic-Paragraph">Once the virtual machine has been created, the Cockpit interface can be used to monitor the machine and perform tasks such as rebooting, shutting down or deleting the guest system. An option is also included on the <span class="My-Italic _idGenCharOverride-1">Disks </span>panel to add additional disks to the virtual machine configuration.</p>&#13;
			<p id="_idParaDest-203" class="Heading-1-1"><span class="Heading11Marker">21.4 </span><a id="_idTextAnchor271"/>Creating a Virtual Machine using <a id="_idIndexMarker489"/><a id="_idIndexMarker490"/>virt-manager</p>&#13;
			<p class="My-Basic-Paragraph">With the caveat that <span class="My-Italic _idGenCharOverride-1">virt-manager</span> is now deprecated and will be removed once the Virtual Machines Cockpit extension is fully implemented, the remainder of this chapter will explore the use of this tool to create new virtual machines.</p>&#13;
			<p id="_idParaDest-204" class="Heading-1-1"><span class="Heading11Marker">21.5 </span><a id="_idTextAnchor272"/>Starting the Virtual Machine Manager</p>&#13;
			<p class="My-Basic-Paragraph">Begin by launching Virtual Machine Manager from the command-line in a terminal window by running <span class="My-Italic _idGenCharOverride-1">virt-manager</span>. Once loaded, the virtual machine manager will prompt for the password of the currently active user prior to displaying the following screen:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-7" src="Images/rhel_8_virt-manager_main.png" alt="" width="548" height="178"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-7</span></p>&#13;
			<p class="My-Basic-Paragraph">The main screen lists the current virtual machines running on the system. At this point there should only be one, the hypervisor running on the host system. By default the manager should be connected to the host. If it is not, connect to the host system by right-clicking on the entry in the list and selecting <span class="My-Italic _idGenCharOverride-1">Connect</span> from the popup menu. </p>&#13;
			<p class="My-Basic-Paragraph">To create a new virtual system, click on the new virtual machine button (the far left button on the toolbar) or right-click on the hypervisor entry and select <span class="My-Italic _idGenCharOverride-1">New</span> from the resulting menu to display the first screen of the New VM wizard. In the Name field enter a suitably descriptive name for the virtual system. On this screen, also select the location of the media from which the guest operating system will be installed. This can either be a CD or DVD drive, an ISO image file accessible to the local host, a network install using HTTP, FTP, NFS or PXE or the disk image from an existing virtual machine: </p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-8" src="Images/rhel_8_virt-manager_create_vm.png" alt="" width="448" height="448"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-8</span></p>&#13;
			<p id="_idParaDest-205" class="Heading-1-1"><span class="Heading11Marker">21.6 </span><a id="_idTextAnchor273"/>Configuring the KVM Virtual System </p>&#13;
			<p class="My-Basic-Paragraph">Clicking <span class="My-Italic _idGenCharOverride-1">Forward</span> will display a screen seeking additional information about the installation process. The screen displayed and information required will depend on selections made in the preceding screen. For example, if a CD, DVD or ISO was selected, this screen will ask for the specific location of the ISO file or physical media device. This screen also attempts to identify the type and version of the guest operating system to be installed (for example the Windows version or Linux distribution) based on the installation media specified. If it is unable to do so, uncheck the <span class="My-Italic _idGenCharOverride-1">Automatically detect from installation media / source</span> option, type in the first few character of the operating system name and select an option from the list of possible matches: </p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-9" src="Images/rhel_8_virt-manager_select_os.png" alt="" width="458" height="448"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-9</span></p>&#13;
			<p class="My-Basic-Paragraph">Once these settings are complete, click the <span class="My-Italic _idGenCharOverride-1">Forward</span> button to configure CPU and memory settings. The optimal settings will depend on the number of CPUs and amount of physical memory present in the host together with the requirements of other applications and virtual machines that will run in parallel with the new virtual machine: </p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-10" src="Images/rhel_virt-manager_new_vm_memory.png" alt="" width="448" height="448"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-10</span></p>&#13;
			<p class="My-Basic-Paragraph">The last item to configure before creating the virtual machine is the storage space for the guest operating system and corresponding user data. This takes the form of a virtual disk image or pre-existing storage. A virtual disk drive is essentially an image file located on the file system of the host computer which is seen by the virtual machine as a physical disk drive. </p>&#13;
			<p class="My-Basic-Paragraph">Options are available to create an image disk of a specified size, select a pre-existing volume or to create a storage volume of a specified format (raw, vmdk, ISO etc). Unless you have a specific need to use a particular format (for example you might need to use vmdk to migrate to a VMware based virtualization environment at a later date) or need to use a dedicated disk or partition, it is generally adequate to simply specify a size on this screen: </p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-11" src="Images/rhel_8_virt-manager_vm_storage.png" alt="" width="449" height="448"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-11</span></p>&#13;
			<p class="My-Basic-Paragraph">Once these settings are configured, click the <span class="My-Italic _idGenCharOverride-1">Forward</span> button once more. The final screen displays a summary of the configuration. Review the information displayed. Advanced options are also available to change the virtual network configuration for the guest as shown in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor274"><span class="My-Italic _idGenCharOverride-1">Figure 21-12</span></a>:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-12" src="Images/centos_8_cockpit_vm_network_macvtap.png" alt="" width="737" height="784"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-12</span><a id="_idTextAnchor274"/></p>&#13;
			<p id="_idParaDest-206" class="Heading-1-1"><span class="Heading11Marker">21.7 </span><a id="_idTextAnchor275"/>Starting the KVM Virtual Machine </p>&#13;
			<p class="My-Basic-Paragraph">Click on the <span class="My-Italic _idGenCharOverride-1">Finish</span> button to begin the creation process. The virtualization manager will create the disk and configure the virtual machine before starting the guest system. The new virtual machine will appear in the main <a id="_idIndexMarker491"/><span class="My-Italic _idGenCharOverride-1">virt-manager</span> window with the status set to <span class="My-Italic _idGenCharOverride-1">Running</span> as illustrated in <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor276"><span class="My-Italic _idGenCharOverride-1">Figure 21-13</span></a>:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-13" src="Images/rhel_8_virt-manager_vm_running.png" alt="" width="550" height="236"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-13</span><a id="_idTextAnchor276"/></p>&#13;
			<p class="My-Basic-Paragraph">By default, the console for the virtual machine should appear in the virtual machine viewer window. To view the console of the running machine at any future time, ensure that it is selected in the virtual machine list and select the <span class="My-Italic _idGenCharOverride-1">Open</span> button from the toolbar. The virtual machine viewer should be ready for the installation process to begin:</p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-14" src="Images/rhel_8_virt-manager_viewer.png" alt="" width="1023" height="798"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 21-14</span></p>&#13;
			<p class="My-Basic-Paragraph">From this point on, simply follow the operating system installation instructions to install the guest OS in the KVM virtual machine. </p>&#13;
			<p id="_idParaDest-207" class="Heading-1-1"><span class="Heading11Marker">21.8 </span><a id="_idTextAnchor277"/>Summary</p>&#13;
			<p class="My-Basic-Paragraph">This chapter has outlined two different ways to create new KVM-based virtual machines on a CentOS 8 host system. The first option covered involves the use of the Cockpit web-based interface to create and manage virtual machines. This has the advantage of not requiring access to a desktop environment running on the host system. An alternative option is to use the <span class="My-Italic _idGenCharOverride-1">virt-manager</span> graphical tool. Though deprecated in CentOS 8 and likely to be removed in later releases, <span class="My-Italic _idGenCharOverride-1">virt-manager</span> currently provides options not currently available in the Cockpit Virtual Machines extension. At the point that <span class="My-Italic _idGenCharOverride-1">virt-manager</span> is removed it is expected that Cockpit will provide equal or better functionality.</p>&#13;
			<p class="My-Basic-Paragraph">With these basics covered, the next chapter will cover the creation of virtual machines from the command-line.</p>&#13;
		</div>&#13;
</div>



  </body></html>