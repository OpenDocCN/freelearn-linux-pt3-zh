35. 添加和管理 Ubuntu 交换空间

维护 Ubuntu 系统性能的一个重要部分是确保有足够的交换空间，以满足系统的内存需求。因此，本章的目标是提供 Ubuntu 交换管理的概述。

35.1 什么是交换空间？

计算机系统有有限的物理内存，供操作系统使用。当操作系统开始接近可用内存的上限时，它通过将内存页面写入磁盘来释放空间。当操作系统需要这些页面时，它们会被重新读取到内存中。为此任务分配的磁盘区域称为交换空间。

35.2 Ubuntu 推荐的交换空间

Ubuntu 推荐的交换空间取决于多个因素，包括系统的内存大小、对内存的工作负载以及系统是否需要支持休眠。当前的 Ubuntu 交换空间指南如下：

| 安装的 RAM 大小 | 推荐的交换空间大小 | 如果启用休眠，推荐的交换空间大小 |
| --- | --- | --- |
| 1GB | 1GB | 2GB |
| 2GB | 1GB | 3GB |
| 3GB | 2GB | 5GB |
| 4GB | 2GB | 6GB |
| 5GB | 2GB | 7GB |
| 6GB | 2GB | 8GB |
| 8GB | 3GB | 11GB |
| 12GB | 3GB | 15GB |
| 16GB | 4GB | 32GB |
| 24GB | 5GB | 48GB |

表 35-1

对于内存配置超过 24GB 的系统，请参考以下网页获取交换空间指南：

[`help.ubuntu.com/community/SwapFaq`](https://help.ubuntu.com/community/SwapFaq)

当系统进入休眠状态时，当前的系统状态会写入硬盘，主机关闭电源。随后，当机器重新开机时，系统的状态会从硬盘恢复。这与挂起不同，挂起时系统状态存储在 RAM 中，机器进入睡眠状态，此时系统 RAM 保持供电，而其他设备则关闭。

35.3 确认当前交换空间使用情况

可以通过多种方式识别 Ubuntu 系统当前使用的交换空间。一个选项是输出 /proc/swaps 文件：

# cat /proc/swaps

文件名 类型 大小 已用 优先级

/swap.img 文件 3778556 836928 -2

另外，可以使用 swapon 命令：

# swapon

名称 类型 大小 已用 优先级

/swap.img 文件 3.6G 817.3M -2

要查看与系统总可用内存相比的交换空间大小，可以使用 free 命令：

# free

总计 已用 空闲 共享 缓冲/缓存 可用

Mem: 3779672 2554028 451216 809132 1839908 1225644

交换: 3778556 836928 2941628

35.4 向 Ubuntu 系统添加交换文件

可以通过创建一个文件并将其指定为交换空间来向系统添加额外的交换空间。首先使用 dd 命令创建交换文件。可以通过调整 count= 变量来更改文件的大小。例如，以下命令行创建一个 2.0 GB 的文件：

# dd if=/dev/zero of=/newswap bs=1024 count=2000000

2000000+0 条记录输入

2000000+0 记录已输出

2048000000 字节（2.0 GB，1.9 GiB）已复制，耗时 3.62697 秒，速度 565 MB/s

在将文件转换为交换文件之前，确保该文件已经设置了安全的权限非常重要：

# chmod 0600 /newswap

一旦创建了合适的文件，就需要使用 mkswap 命令将其转换为交换文件：

# mkswap /newswap

设置交换空间版本 1，大小 = 1.9 GiB（2047995904 字节）

无标签，UUID=4ffc238d-7fde-4367-bd98-c5c46407e535

在创建并配置交换文件后，可以使用 swapon 工具将其实时添加到系统中：

# swapon /newswap

重新运行 swapon 现在应该报告新文件已经作为交换空间使用：

# swapon

名称 类型 大小 已用 优先级

/swap.img 文件 3.6G 832.5M -2

/newswap 文件 1.9G 0B -3

可以使用 swapoff 工具动态移除交换空间，方法如下：

# swapoff /newswap

最后，修改 /etc/fstab 文件，在系统启动时自动添加新的交换空间，通过添加以下行：

/newswap swap swap 默认 0 0

35.5 将交换空间添加为分区

作为指定文件为交换空间的替代方案，也可以将整个磁盘分区指定为交换空间。实现此目的的步骤与添加交换文件大致相同。然而，在将分区分配给交换空间之前，请确保相应文件系统上的任何现有数据已备份或不再需要，并且文件系统已被卸载。

假设在磁盘驱动器上存在一个分区，表示为 /dev/sdb1，例如，第一步是使用 mkswap 工具将其转换为交换分区：

# mkswap /dev/sdb1

mkswap: /dev/sdb1: 警告：正在擦除旧的 xfs 签名。

设置交换空间版本 1，大小 = 8 GiB（8587833344 字节）

无标签，UUID=a899c8ec-c410-4569-ba18-ddea03370c7f

接下来，将新分区添加到系统交换空间并验证其确实已被添加：

# swapon /dev/sdb1

# swapon

名称 类型 大小 已用 优先级

/swap.img 文件 3.6G 832.5M -2

/dev/sdb1 分区 8G 0B -3

再次，/etc/fstab 文件可能会被修改，在启动时自动添加交换分区，方法如下：

/dev/sdb1 swap swap 默认 0 0

35.6 向 Ubuntu LVM 交换卷添加空间

在使用逻辑卷管理（LVM）的系统中，如果交换空间配置为逻辑卷，除了通过文件或磁盘分区添加交换空间外，还可以扩展用于交换空间的逻辑卷。

第一步是使用 lvdisplay 工具识别当前可用的交换空间量以及用于交换空间的卷组和逻辑卷（有关 LVM 的更多信息，请参见标题为“将新磁盘添加到 Ubuntu 23.04 卷组和逻辑卷”的章节）：

# lvdisplay

.

.

--- 逻辑卷 ---

LV 路径 /dev/ubuntu-vg/swap_1

LV 名称 swap_1

VG 名称 ubuntu-vg

LV UUID nJPip0-Q6dx-Mfe3-4Aao-gWAa-swDk-7ZiPdP

LV 写访问权限 读/写

LV 创建主机，时间 ubuntu，2020-01-13 13:16:18 -0500

LV 状态 可用

# 打开 2

LV 大小 5.00 GiB

当前逻辑扩展块 1280

段 1

分配继承

预读扇区 自动

- 当前设置为 256

块设备 253:1

显然，交换位于一个名为 swap_1 的逻辑卷上，且该逻辑卷是名为 ubuntu-vg 的卷组的一部分。下一步是验证卷组中是否有可分配给交换卷的可用空间：

# vgs

VG #PV #LV #SN 属性 大小 空闲空间

ubuntu-vg 2 3 0 wz--n- 197.66g <22.00g

如果可用空间足够满足额外的交换需求，则关闭交换并扩展交换逻辑卷，以便使用尽可能多的可用空间来满足系统的交换需求：

# lvextend -L+8GB /dev/ubuntu-vg/swap_1

逻辑卷 ubuntu_vg/swap_1 成功调整大小。

接下来，重新格式化交换卷并重新启用交换：

# mkswap /dev/ubuntu-vg/swap_1

mkswap: /dev/ubuntu-vg/swap_1: 警告：正在擦除旧的交换签名。

正在设置交换空间版本 1，大小 = 12 GiB（12754874368 字节）

无标签，UUID=241a4818-e51c-4b8c-9bc9-1697fc2ce26e

# swapon /dev/ubuntu-vg/swap_1

修改完成后，检查交换空间是否已增加：

# swapon

名称 类型 大小 已使用 优先级

/dev/dm-1 分区 12G 0B -2

35.7 将交换空间添加到卷组

在上一节中，我们扩展了交换逻辑卷以使用已经在卷组中可用的空间。如果卷组中没有可用空间，则需要先添加空间才能扩展交换。

首先检查卷组的状态：

# vgs

VG #PV #LV #SN 属性 大小 空闲空间

ubuntu-vg 1 2 0 wz--n- <73.75g 0

上述输出表示卷组内没有可用空间。然而，假设我们有一个要求，需要在系统上添加 8 GB 的交换空间。显然，这将需要向卷组中添加更多空间。为了本例的目的，假设有一个大小为 8 GB 且由 /dev/sdb 表示的磁盘可用于添加到卷组。第一步是将此分区转换为物理卷：

# pvcreate /dev/sdb

物理卷 "/dev/sdb" 创建成功。

如果创建失败并出现类似于 “设备 /dev/sdb 被过滤器排除” 的消息，可能需要在创建物理卷之前擦除磁盘：

# wipefs -a /dev/sdb

/dev/sdb: 在偏移量 0x00000200（gpt）处擦除了 8 字节：45 46 49 20 50 41 52 54

/dev/sdb: 在偏移量 0x1fffffe00（gpt）处擦除了 8 字节：45 46 49 20 50 41 52 54

/dev/sdb: 在偏移量 0x000001fe（PMBR）处擦除了 2 字节：55 aa

/dev/sdb: 调用 ioctl 重新读取分区表：成功

接下来，卷组需要扩展以使用此额外的物理卷：

# vgextend ubuntu-vg /dev/sdb

卷组 "ubuntu-vg" 扩展成功

此时，vgs 命令应报告将 10 GB 空间添加到卷组：

# vgs

VG #PV #LV #SN 属性 大小 空闲空间

ubuntu-vg 2 2 0 wz--n- 83.74g <10.00g

现在，既然附加的空间已经可用，交换逻辑卷可以扩展以利用这些空间。首先，使用 `swapoff` 工具关闭交换：

# swapoff /dev/ubuntu-vg/swap_1

接下来，扩展逻辑卷以使用新空间：

# lvextend -L+9.7GB /dev/ubuntu-vg/swap_1

将大小四舍五入至物理扩展的边界：9.70 GiB。

逻辑卷 ubuntu-vg/swap_1 的大小从 980.00 MiB（245 个扩展）变更为 10.66 GiB（2729 个扩展）。

逻辑卷 ubuntu-vg/swap_1 成功调整大小。

在逻辑卷上重新创建交换：

# mkswap /dev/ubuntu-vg/swap_1

mkswap: /dev/ubuntu-vg/swap_1: 警告：正在清除旧的交换签名。

设置交换空间版本 1，大小 = 10.7 GiB（11446251520 字节）

无标签，UUID=447fb9e5-5473-4f2c-96f8-839b1457d3ed

接下来，重新启用交换：

# swapon /dev/ubuntu-vg/swap_1

最后，使用 `swapon` 命令验证交换空间是否已成功添加到系统：

# swapon

NAME TYPE SIZE USED PRIO

/dev/dm-1 分区 10.7G 0B -2

35.8 总结

交换空间是几乎所有操作系统中不可或缺的组成部分，特别是在内存资源紧张的情况下。通过将部分内存交换到磁盘，系统能够继续运行，并满足其上运行的进程和应用程序的需求。

Ubuntu 提供了一套指南，推荐根据系统中安装的 RAM 大小分配磁盘交换空间。在这些建议不足的情况下，可以向系统添加额外的交换空间，通常不需要重启。正如本章所述，交换空间可以以文件、磁盘或磁盘分区的形式添加，或者通过扩展已配置为交换空间的现有逻辑卷来实现。
