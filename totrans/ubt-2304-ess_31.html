<html><head></head><body>
<div class="_idGenObjectStyleOverride-1" id="_idContainer378">
<p class="Chapter-Title" id="_idParaDest-286" lang="en-US"><span class="ChapterMarker"><span class="koboSpan" id="kobo.1.1">32. </span></span><a id="_idTextAnchor477"/><span class="koboSpan" id="kobo.2.1">Configuring an Ubuntu 23.04 </span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.3.1">Postfix </span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.4.1">Email Server</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.5.1">Along with acting as a web server, email is one of the primary uses of an Ubuntu system, particularly in business environments. </span><span class="koboSpan" id="kobo.5.2">Given the importance and popularity of email, it is surprising to some people to find out how complex the email structure is on a Linux system. </span><span class="koboSpan" id="kobo.5.3">This complexity can often be overwhelming to the Ubuntu newcomer. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.6.1">The good news is that much of the complexity is there to allow experienced email administrators to implement complicated configurations for large-scale enterprise installations. </span><span class="koboSpan" id="kobo.6.2">However, for most Linux administrators, setting up a basic email system is relatively straightforward so that users can send and receive electronic mail. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.7.1">This chapter of Ubuntu Essentials will explain the basics of Linux-based email configuration and step through configuring a basic email environment. </span><span class="koboSpan" id="kobo.7.2">To provide the essentials, we will leave the complexities of the email system for more advanced books on the subject. </span></p>
<p class="Heading-1-1" id="_idParaDest-287" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.8.1">32.1 </span></span><a id="_idTextAnchor478"/><span class="koboSpan" id="kobo.9.1">The Structure of the Email System </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.10.1">Several components make up a complete email system. </span><span class="koboSpan" id="kobo.10.2">Below is a brief description of each one: </span></p>
<p class="Heading-1-1-1" id="_idParaDest-288" lang="en-US"><span class="Heading111Marker"><span class="koboSpan" id="kobo.11.1">32.1.1 </span></span><a id="_idTextAnchor479"/><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.12.1">Mail User Agent </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.13.1">The typical user will likely be most familiar with this part of the system. </span><span class="koboSpan" id="kobo.13.2">The Mail User Agent (</span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.14.1">MUA), or mail client, is the application that is used to write, send and read email messages. </span><span class="koboSpan" id="kobo.14.2">Anyone who has written and sent a message on any computer has used a Mail User Agent of one type or another. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.15.1">Typical Graphical MUAs on Linux are Evolution, Thunderbird, and </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.16.1">KMail. </span><span class="koboSpan" id="kobo.16.2">For those who prefer a text-based mail client, there are also the more traditional Pine and </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.17.1">mail</span></span><span class="koboSpan" id="kobo.18.1"> tools. </span></p>
<p class="Heading-1-1-1" id="_idParaDest-289" lang="en-US"><span class="Heading111Marker"><span class="koboSpan" id="kobo.19.1">32.1.2 </span></span><a id="_idTextAnchor480"/><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.20.1">Mail Transfer Agent </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.21.1">The Mail Transfer Agent (</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.22.1">MTA) is the part of the email system that transfers email messages from one computer to another (either on the same local network or over the internet to a remote system). </span><span class="koboSpan" id="kobo.22.2">Once configured correctly, most users will only directly interact with their chosen MTA if they wish to re-configure it. </span><span class="koboSpan" id="kobo.22.3">Many MTA choices are available for Linux, including </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.23.1">Sendmail, Postfix, </span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.24.1">Fetchmail, Qmail, and </span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.25.1">Exim. </span></p>
<p class="Heading-1-1-1" id="_idParaDest-290" lang="en-US"><span class="Heading111Marker"><span class="koboSpan" id="kobo.26.1">32.1.3 </span></span><a id="_idTextAnchor481"/><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.27.1">Mail Delivery Agent </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.28.1">Another part of the infrastructure typically hidden from the user, the Mail Delivery Agent (</span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.29.1">MDA), sits in the background and performs filtering of the email messages between the Mail Transfer Agent and the mail client (MUA). </span><span class="koboSpan" id="kobo.29.2">The most popular form of MDA is a spam filter to remove all unwanted email messages from the system before they reach the inbox of the user’s mail client (MUA). </span><span class="koboSpan" id="kobo.29.3">Popular MDAs are Spamassassin and Procmail. </span><span class="koboSpan" id="kobo.29.4">It is important to note that some Mail User Agent applications (such as Evolution, Thunderbird, and KMail) include their own MDA filtering. </span><span class="koboSpan" id="kobo.29.5">Others, such as Pine and Basla, do not. </span><span class="koboSpan" id="kobo.29.6">This can be a source of confusion for the Linux beginner. </span></p>
<p class="Heading-1-1-1" id="_idParaDest-291" lang="en-US"><span class="Heading111Marker"><span class="koboSpan" id="kobo.30.1">32.1.4 </span></span><a id="_idTextAnchor482"/><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.31.1">SMTP </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.32.1">SMTP is an acronym for </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.33.1">Simple Mail Transport Protocol. </span><span class="koboSpan" id="kobo.33.2">The email systems use this protocol to transfer mail messages from one server to another. </span><span class="koboSpan" id="kobo.33.3">This protocol is the communication language that the MTAs use to talk to each other and transfer messages back and forth.</span></p>
<p class="Heading-1-1-1" id="_idParaDest-292" lang="en-US"><span class="Heading111Marker"><span class="koboSpan" id="kobo.34.1">32.1.5 </span></span><a id="_idTextAnchor483"/><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.35.1">SMTP Relay</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.36.1">SMTP Relay is a protocol that allows an external SMTP server to send emails instead of hosting a local SMTP server. </span><span class="koboSpan" id="kobo.36.2">This will typically involve using a service such as Mailjet, SendGrid, or MailGun. </span><span class="koboSpan" id="kobo.36.3">These services avoid configuring and maintaining your own SMTP server and often provide additional benefits such as analytics. </span></p>
<p class="Heading-1-1" id="_idParaDest-293" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.37.1">32.2 </span></span><a id="_idTextAnchor484"/><span class="koboSpan" id="kobo.38.1">Configuring an Ubuntu Email Server </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.39.1">Many systems use the Sendmail MTA to transfer email messages; on many Linux distributions, this is the default Mail Transfer Agent. </span><span class="koboSpan" id="kobo.39.2">Unfortunately, Sendmail is a complex system that can be difficult for beginners and experienced users to understand and configure. </span><span class="koboSpan" id="kobo.39.3">It is also falling from favor because it is considered slower at processing email messages than many of the more recent MTAs available. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.40.1">Many system administrators are now using </span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.41.1">Postfix or </span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.42.1">Qmail to handle email. </span><span class="koboSpan" id="kobo.42.2">Both are faster and easier to configure than </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.43.1">Sendmail. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.44.1">For this chapter, therefore, we will look at Postfix as an MTA because of its simplicity and popularity. </span><span class="koboSpan" id="kobo.44.2">However, if you prefer to use Sendmail, many books specialize in the subject and will do the subject much more justice than we can in this chapter. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.45.1">As a first step, this chapter will cover configuring an Ubuntu system to act as a full email server. </span><span class="koboSpan" id="kobo.45.2">Later in the chapter, the steps to use an SMTP Relay service will also be covered.</span></p>
<p class="Heading-1-1" id="_idParaDest-294" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.46.1">32.3 </span></span><a id="_idTextAnchor485"/><span class="koboSpan" id="kobo.47.1">Postfix Pre-Installation Steps </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.48.1">The first step before installing Postfix is to ensure that Sendmail is not already running on your system. </span><span class="koboSpan" id="kobo.48.2">You can check for this using the following command: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.49.1"># systemctl status sendmail</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.50.1">If sendmail is not installed, the tool will display a message similar to the following:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.51.1">Unit sendmail.service could not be found.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.52.1">If sendmail is running on your system, it is necessary to stop it before installing and configuring Postfix. </span><span class="koboSpan" id="kobo.52.2">To stop sendmail, run the following command: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.53.1"># systemctl stop sendmail</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.54.1">The next step is to ensure that sendmail does not get restarted automatically when the system is rebooted:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.55.1"># systemctl disable  sendmail </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.56.1">Sendmail is now switched off and configured to not auto-start when the system is booted. </span><span class="koboSpan" id="kobo.56.2">Optionally, to altogether remove sendmail from the system, run the following command:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.57.1"># apt remove sendmail</span></p>
<p class="Heading-1-1" id="_idParaDest-295" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.58.1">32.4 </span></span><a id="_idTextAnchor486"/><span class="koboSpan" id="kobo.59.1">Firewall/Router Configuration</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.60.1">Since sending and receiving email messages involves network connections, the firewall must be configured to allow SMTP traffic. </span><span class="koboSpan" id="kobo.60.2">If firewalld is active, use the </span><a id="_idIndexMarker742"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.61.1">firewall-cmd</span></span><span class="koboSpan" id="kobo.62.1"> tool will as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.63.1"># firewall-cmd --permanent --add-service=smtp</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.64.1">Alternatively, if ufw is enabled, configure it to allow SMTP traffic using the following command:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.65.1"># ufw allow Postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.66.1">It will also be essential to configure any other firewall or router between the server and the internet to allow connections on ports 25, 143, and 587 and, if necessary, to configure port forwarding for those ports to the corresponding ports on the email server.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.67.1">With these initial steps completed, we can now install Postfix.</span></p>
<p class="Heading-1-1" id="_idParaDest-296" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.68.1">32.5 </span></span><a id="_idTextAnchor487"/><span class="koboSpan" id="kobo.69.1">Installing </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.70.1">Postfix on Ubuntu</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.71.1">By default, the Ubuntu installation process installs postfix for most configurations. </span><span class="koboSpan" id="kobo.71.2">To verify if postfix is already installed, use the following </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.72.1">apt</span></span><span class="koboSpan" id="kobo.73.1"> command: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.74.1"># apt -qq list postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.75.1">If </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.76.1">apt</span></span><span class="koboSpan" id="kobo.77.1"> reports that postfix is not installed, it may be installed as follows: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.78.1"># apt install postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.79.1">The </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.80.1">apt</span></span><span class="koboSpan" id="kobo.81.1"> tool will download and install postfix and configure a special postfix user in the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.82.1">/etc/passwd</span></span><span class="koboSpan" id="kobo.83.1"> file.</span></p>
<p class="Heading-1-1" id="_idParaDest-297" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.84.1">32.6 </span></span><a id="_idTextAnchor488"/><span class="koboSpan" id="kobo.85.1">Configuring </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.86.1">Postfix </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.87.1">The main configuration settings for postfix are located in the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.88.1">/etc/postfix/main.cf</span></span><span class="koboSpan" id="kobo.89.1"> file. </span><span class="koboSpan" id="kobo.89.2">The </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.90.1">/etc/postfix</span></span><span class="koboSpan" id="kobo.91.1"> directory contains a template file named </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.92.1">main.cf.proto</span></span><span class="koboSpan" id="kobo.93.1"> that you can use as the basis for your mail system configuration. </span><span class="koboSpan" id="kobo.93.2">Many resources on the internet provide detailed information on postfix, so this section will focus on the basic options required to get email up and running. </span><span class="koboSpan" id="kobo.93.3">Even though the apt installation set up some basic configuration options, it tends to miss some settings and guess incorrectly for others, so carefully review the </span><a id="_idIndexMarker745"/><a id="_idIndexMarker746"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.94.1">main.cf </span></span><span class="koboSpan" id="kobo.95.1">file.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.96.1">The key options in the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.97.1">main.cf</span></span><span class="koboSpan" id="kobo.98.1"> file are as follows: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.99.1">myhostname = mta1.domain.com</span></p>
<p class="Code"><span class="koboSpan" id="kobo.100.1">mydomain = domain.com</span></p>
<p class="Code"><span class="koboSpan" id="kobo.101.1">myorigin = $mydomain</span></p>
<p class="Code"><span class="koboSpan" id="kobo.102.1">mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain</span></p>
<p class="Code"><span class="koboSpan" id="kobo.103.1">inet_interfaces = $myhostname</span></p>
<p class="Code"><span class="koboSpan" id="kobo.104.1">mynetworks = subnet</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.105.1">Other settings will have either been set up for you by the installation process or are only needed if you are feeling adventurous and want to configure a more sophisticated email system. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.106.1">The format of myhostname is host.domain.extension. </span><span class="koboSpan" id="kobo.106.2">If, for example, your Linux system is named MyLinuxHost and your internet domain is MyDomain.com you would set the myhostname option as follows: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.107.1">myhostname = mylinuxhost.mydomain.com</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.108.1">The mydomain setting is just the domain part of the above setting. </span><span class="koboSpan" id="kobo.108.2">For example: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.109.1">mydomain = mydomain.com</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.110.1">The myorigin setting defines the name of the domain from which the output email appears to come from when it arrives in the recipient’s inbox and should be set to your domain name:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.111.1">myorigin = $mydomain</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.112.1">One of the most crucial parameters, mydestination relates to incoming messages and declares the domains for which this server is the final delivery destination. </span><span class="koboSpan" id="kobo.112.2">Any incoming email messages addressed to a domain name, not on this list will be considered a relay request which, subject to the mynetworks setting (outlined below), will typically result in a delivery failure.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.113.1">The inet_interfaces setting defines the network interfaces on the system via which postfix is permitted to receive email and is generally set to all:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.114.1">inet_interfaces = all</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.115.1">The mynetworks setting defines which external systems are trusted to use the server as an SMTP relay. </span><span class="koboSpan" id="kobo.115.2">Possible values for this setting are as follows:</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-4"><span class="koboSpan" id="kobo.116.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.117.1">host</span></span><span class="koboSpan" id="kobo.118.1"> - Only the local system is trusted. </span><span class="koboSpan" id="kobo.118.2">Attempts by all external clients to use the server as a relay will be rejected.</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-4"><span class="koboSpan" id="kobo.119.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.120.1">subnet</span></span><span class="koboSpan" id="kobo.121.1"> - Only systems on the same network subnet can use the server as a relay. </span><span class="koboSpan" id="kobo.121.2">If, for example, the server has an IP address of 192.168.1.29, a client system with an IP address of 192.168.1.30 could use the server as a relay.</span></p>
<p class="Bullet-List" lang="en-US"><span class="_idGenBNMarker-4"><span class="koboSpan" id="kobo.122.1">•</span></span><span class="My-Bold _idGenCharOverride-1"><span class="koboSpan" id="kobo.123.1">class</span></span><span class="koboSpan" id="kobo.124.1"> - Any systems within the same IP address class (A, B, and C) may use the server as a relay.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.125.1">Trusted IP addresses may be defined manually by specifying subnets, address ranges, or referencing pattern files. </span><span class="koboSpan" id="kobo.125.2">The following example declares the local host and the subnet 192.168.0.0 as trusted IP addresses:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.126.1">mynetworks = 192.168.0.0/24, 127.0.0.0/8</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.127.1">For this example, set the property to subnet so that any other systems on the same local network as the server can send email via SMTP relay. </span><span class="koboSpan" id="kobo.127.2">In contrast, external systems are prevented from doing so:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.128.1">mynetworks = subnet</span></p>
<p class="Heading-1-1" id="_idParaDest-298" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.129.1">32.7 </span></span><a id="_idTextAnchor489"/><span class="koboSpan" id="kobo.130.1">Configuring </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.131.1">DNS MX Records</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.132.1">When you register and configure your domain name with a registrar, several default values will have been configured in the DNS settings. </span><span class="koboSpan" id="kobo.132.2">One of these is the so-called </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.133.1">Mail Exchanger (</span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.134.1">MX) record. </span><span class="koboSpan" id="kobo.134.2">This record defines where emails addressed to your domain should be sent and is usually set by default to a mail server provided by your registrar. </span><span class="koboSpan" id="kobo.134.3">If you are hosting your own mail server, the MX record should be set to your domain or the IP address of your mail server. </span><span class="koboSpan" id="kobo.134.4">The steps to make this change will depend on your domain registrar but generally involves editing the DNS information for the domain and either adding or editing an existing MX record so that it points to your email server. </span></p>
<p class="Heading-1-1" id="_idParaDest-299" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.135.1">32.8 </span></span><a id="_idTextAnchor490"/><span class="koboSpan" id="kobo.136.1">Starting </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.137.1">Postfix on an Ubuntu System</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.138.1">Once the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.139.1">/etc/postfix/main.cf</span></span><span class="koboSpan" id="kobo.140.1"> file is configured with the correct settings, it is now time to start up postfix. </span><span class="koboSpan" id="kobo.140.2">This can be achieved from the command line as follows: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.141.1"># systemctl start postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.142.1">If postfix was already running, make sure the configuration changes are loaded using the following command:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.143.1"># systemctl reload postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.144.1">To configure postfix to start automatically at system startup, run the following command: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.145.1"># systemctl enable postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.146.1">The postfix process should now start up. </span><span class="koboSpan" id="kobo.146.2">The best way to verify everything works is to check your mail log. </span><span class="koboSpan" id="kobo.146.3">This is typically in the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.147.1">/var/log/maillog</span></span><span class="koboSpan" id="kobo.148.1"> file and should now contain an entry resembling the following output: </span></p>
<p class="Code"><span class="koboSpan" id="kobo.149.1">Mar 25 11:21:48 demo-server postfix/postfix-script[5377]: starting the Postfix mail system</span></p>
<p class="Code"><span class="koboSpan" id="kobo.150.1">Mar 25 11:21:48 demo-server postfix/master[5379]: daemon started -- version 3.3.1, configuration /etc/postfix </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.151.1">As long as no error messages have been logged, you have successfully installed and started postfix and are ready to test the postfix configuration. </span></p>
<p class="Heading-1-1" id="_idParaDest-300" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.152.1">32.9 </span></span><a id="_idTextAnchor491"/><span class="koboSpan" id="kobo.153.1">Testing </span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.154.1">Postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.155.1">An easy way to test the postfix configuration is to send email messages between local users on the system. </span><span class="koboSpan" id="kobo.155.2">To perform a quick test, use the mail tool as follows (where name and mydomain are replaced by the name of a user on the system and your domain name, respectively):</span></p>
<p class="Code"><span class="koboSpan" id="kobo.156.1"># mail name@mydomain.com</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.157.1">When prompted, enter a subject for the email message and then type the message body text. </span><span class="koboSpan" id="kobo.157.2">To send the email message, press Ctrl-D. </span><span class="koboSpan" id="kobo.157.3">For example:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.158.1"># mail demo@mydomain.com</span></p>
<p class="Code"><span class="koboSpan" id="kobo.159.1">Subject: Test email message</span></p>
<p class="Code"><span class="koboSpan" id="kobo.160.1">This is a test message.</span></p>
<p class="Code"><span class="koboSpan" id="kobo.161.1">EOT</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.162.1">If the mail tool is not available, it can be installed as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.163.1"># apt install mailutils</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.164.1">Rerun the mail command, this time as the other user, and verify that the message was sent and received:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.165.1">$ mail</span></p>
<p class="Code"><span class="koboSpan" id="kobo.166.1">"/var/mail/demo": 1 message 1 new</span></p>
<p class="Code"><span class="koboSpan" id="kobo.167.1">&gt;N   1 demo               Wed Apr 15 15:30  13/475   Test email message</span></p>
<p class="Code"><span class="koboSpan" id="kobo.168.1">?</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.169.1">Check the log file </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.170.1">(</span><span class="CharOverride-2"><span class="koboSpan" id="kobo.171.1">/var/log/maillog</span></span><span class="koboSpan" id="kobo.172.1">) for errors if the message does not appear. </span><span class="koboSpan" id="kobo.172.2">Successful mail delivery will appear in the log file as follows:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.173.1">Mar 25 13:41:37 demo-server postfix/pickup[7153]: 94FAF61E8F4A: uid=0 from=&lt;root&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.174.1">Mar 25 13:41:37 demo-server postfix/cleanup[7498]: 94FAF61E8F4A: message-id=&lt;20190325174137.94FAF61E8F4A@demo-server.mydomain.com&gt;</span></p>
<p class="Code"><span class="koboSpan" id="kobo.175.1">Mar 25 13:41:37 demo-server postfix/qmgr[7154]: 94FAF61E8F4A: from=&lt;root@mydomain.com&gt;, size=450, nrcpt=1 (queue active)</span></p>
<p class="Code"><span class="koboSpan" id="kobo.176.1">Mar 25 13:41:37 demo-server postfix/local[7500]: 94FAF61E8F4A: to=&lt;neil@mydomain.com&gt;, relay=local, delay=0.12, delays=0.09/0.01/0/0.02, dsn=2.0.0, status=sent (delivered to mailbox)</span></p>
<p class="Code"><span class="koboSpan" id="kobo.177.1">Mar 25 13:41:37 demo-server postfix/qmgr[7154]: 94FAF61E8F4A: removed</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.178.1">Once the local email is working, try sending an email to an external address (such as a GMail account). </span><span class="koboSpan" id="kobo.178.2">Also, test that incoming mail works by sending an email from an external account to a user on your domain. </span><span class="koboSpan" id="kobo.178.3">In each case, check the  </span><span class="My-Italic CharOverride-1"><span class="koboSpan" id="kobo.179.1">/var/log/mail.log</span></span><span class="koboSpan" id="kobo.180.1"> file for explanations of any errors.</span></p>
<p class="Heading-1-1" id="_idParaDest-301" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.181.1">32.10 </span></span><a id="_idTextAnchor492"/><span class="koboSpan" id="kobo.182.1">Sending Mail via an </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.183.1">SMTP Relay Server</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.184.1">An SMTP Relay service is an alternative to configuring a mail server to handle outgoing email messages. </span><span class="koboSpan" id="kobo.184.2">As previously discussed, several services are available, most of which can be found by performing a web search for “SMTP Relay Service”. </span><span class="koboSpan" id="kobo.184.3">Most of these services will require you to verify your domain in some way and will provide MX records with which to update your DNS settings. </span><span class="koboSpan" id="kobo.184.4">You will also be provided with a username and password, which must be added to the postfix configuration. </span><span class="koboSpan" id="kobo.184.5">The remainder of this section assumes that postfix is installed on your system and that all of the initial steps required by your chosen SMTP Relay provider have been completed. </span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.185.1">Begin by editing the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.186.1">/etc/postfix/main.cf</span></span><span class="koboSpan" id="kobo.187.1"> file and configure the myhostname parameter with your domain name:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.188.1">myhostname = mydomain.com</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.189.1">Next, create a new file in </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.190.1">/etc/postfix</span></span><span class="koboSpan" id="kobo.191.1"> named </span><a id="_idIndexMarker754"/><a id="_idIndexMarker755"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.192.1">sasl_passwd</span></span><span class="koboSpan" id="kobo.193.1"> and add a line containing the mail server host provided by the relay service and the user name and password. </span><span class="koboSpan" id="kobo.193.2">For example:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.194.1">[smtp.myprovider.com]:587 neil@mydomain.com:mypassword</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.195.1">Note that port 587 has also been specified in the above entry. </span><span class="koboSpan" id="kobo.195.2">Without this setting, postfix will default to using port 25, which is blocked by default by most SMTP relay service providers.</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.196.1">With the password file created, use the </span><a id="_idIndexMarker756"/><a id="_idIndexMarker757"/><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.197.1">postmap</span></span><span class="koboSpan" id="kobo.198.1"> utility to generate the hash database containing the mail credentials:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.199.1"># postmap /etc/postfix/sasl_passwd</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.200.1">Before proceeding, take some additional steps to secure your postfix credentials:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.201.1"># chown root:root /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db</span></p>
<p class="Code"><span class="koboSpan" id="kobo.202.1"># chmod 0600 /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.203.1">Edit the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.204.1">main.cf </span></span><span class="koboSpan" id="kobo.205.1">file once again and add an entry to specify the relay server:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.206.1">relayhost = [smtp.myprovider.com]:587</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.207.1">Remaining within the </span><span class="My-Italic _idGenCharOverride-1"><span class="koboSpan" id="kobo.208.1">main.cf </span></span><span class="koboSpan" id="kobo.209.1">file, add the following lines to configure the authentication settings for the SMTP server:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.210.1">smtp_use_tls = yes</span></p>
<p class="Code"><span class="koboSpan" id="kobo.211.1">smtp_sasl_auth_enable = yes</span></p>
<p class="Code"><span class="koboSpan" id="kobo.212.1">smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd</span></p>
<p class="Code"><span class="koboSpan" id="kobo.213.1">smtp_tls_CAfile = /etc/ssl/certs/ca-bundle.crt</span></p>
<p class="Code"><span class="koboSpan" id="kobo.214.1">smtp_sasl_security_options = noanonymous</span></p>
<p class="Code"><span class="koboSpan" id="kobo.215.1">smtp_sasl_tls_security_options = noanonymous</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.216.1">Finally, restart the postfix service:</span></p>
<p class="Code"><span class="koboSpan" id="kobo.217.1"># systemctl restart postfix</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.218.1">Once the service has restarted, try sending and receiving mail using either the mail tool or your preferred mail client.</span></p>
<p class="Heading-1-1" id="_idParaDest-302" lang="en-US"><span class="Heading11Marker"><span class="koboSpan" id="kobo.219.1">32.11 </span></span><a id="_idTextAnchor493"/><span class="koboSpan" id="kobo.220.1">Summary</span></p>
<p class="My-Basic-Paragraph" lang="en-US"><span class="koboSpan" id="kobo.221.1">A complete, end-to-end email system consists of a Mail User Agent (MUA), Mail Transfer Agent (MTA), Mail Delivery Agent (MDA), and the SMTP protocol. </span><span class="koboSpan" id="kobo.221.2">Ubuntu provides several options in terms of MTA solutions, one of the more popular being Postfix. </span><span class="koboSpan" id="kobo.221.3">This chapter has outlined how to install, configure and test postfix on an Ubuntu system to act as a mail server and send and receive email using a third-party SMTP relay server.</span></p>
</div>
</body></html>