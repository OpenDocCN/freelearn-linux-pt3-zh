<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer200" class="_idGenObjectStyleOverride-1">&#13;
			<p id="_idParaDest-208" class="Chapter-Title"><span class="ChapterMarker">22. </span><a id="_idTextAnchor278"/>Creating KVM Virtual Machines with virt-install and virsh</p>&#13;
			<p class="My-Basic-Paragraph">In the previous chapter we explored the creation of KVM guest operating systems on a CentOS 8 host using Cockpit and the <span class="My-Italic _idGenCharOverride-1">virt-manager</span> graphical tool. In this chapter we will turn our attention to the creation of KVM-based virtual machines using the <span class="My-Italic _idGenCharOverride-1">virt-install</span> and <span class="My-Italic _idGenCharOverride-1">virsh</span> command-line tools. These tools provide all the capabilities of the <span class="My-Italic _idGenCharOverride-1">virt-manager</span> and Cockpit options with the added advantage that they can be used within scripts to automate virtual machine creation. In addition, the <span class="My-Italic _idGenCharOverride-1">virsh</span> command allows virtual machines to be created based on a specification contained within a configuration file.</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">virt-install</span> tool is supplied to allow new virtual machines to be created by providing a list of command-line options. This chapter assumes that the necessary KVM tools are installed. For details on these requirements read the chapter entitled <a href="../Text/KVM_Installation.xhtml#_idTextAnchor257"><span class="My-Italic _idGenCharOverride-1">“Installing KVM Virtualization on CentOS 8”</span></a>.</p>&#13;
			<p id="_idParaDest-209" class="Heading-1-1"><span class="Heading11Marker">22.1 </span><a id="_idTextAnchor279"/>Running virt-install to build a KVM Guest System </p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">virt-install</span> utility accepts a wide range of command-line arguments that are used to provide configuration information related to the virtual machine being created. Some of these command-line options are mandatory (specifically name, memory and disk storage must be provided) while others are optional. </p>&#13;
			<p class="My-Basic-Paragraph">At a minimum, a <span class="My-Italic _idGenCharOverride-1">virt-install </span>command will typically need the following arguments:</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-3">•</span><span class="My-Bold _idGenCharOverride-1">--name</span> - The name to be assigned to the virtual machine.</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-3">•</span><span class="My-Bold _idGenCharOverride-1">--memory</span> - The amount of memory to be allocated to the virtual machine.</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-3">•</span><span class="My-Bold _idGenCharOverride-1">--disk</span> - The name and location of an image file to be used as storage for the virtual machine. This file will be created by <span class="My-Italic _idGenCharOverride-1">virt-install</span> during the virtual machine creation unless the <span class="My-Bold _idGenCharOverride-1">--import</span> option is specified to indicate an existing image file is to be used.</p>&#13;
			<p class="Bullet-List"><span class="_idGenBNMarker-3">•</span><span class="My-Bold _idGenCharOverride-1">--cdrom</span> or <span class="My-Bold _idGenCharOverride-1">--location</span> - Specifies the local path or the URL of a remote ISO image containing the installation media for the guest operating system.</p>&#13;
			<p class="My-Basic-Paragraph">A summary of all the arguments available for use when using <span class="My-Italic _idGenCharOverride-1">virt-install</span> can be found in the man page:</p>&#13;
			<p class="Code">$ man virt-install</p>&#13;
			<p id="_idParaDest-210" class="Heading-1-1"><span class="Heading11Marker">22.2 </span><a id="_idTextAnchor280"/>An Example CentOS 8 virt-install Command </p>&#13;
			<p class="My-Basic-Paragraph">With reference to the above command-line argument list, we can now look at an example command-line construct using the <span class="My-Italic _idGenCharOverride-1">virt-install</span> tool. </p>&#13;
			<p class="My-Basic-Paragraph">Note that in order to be able to display the virtual machine and complete the installation, a <span class="My-Italic _idGenCharOverride-1">virt-viewer </span>instance will need to be connected to the virtual machine after it is started by the <span class="My-Italic _idGenCharOverride-1">virt-install</span> utility. By default, <span class="My-Italic _idGenCharOverride-1">virt-install </span>will attempt to launch <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> automatically once the virtual machine starts running. If <span class="My-Italic _idGenCharOverride-1">virt-viewer </span>is not available, <span class="My-Italic _idGenCharOverride-1">virt-install</span> will wait until a<span class="My-Italic _idGenCharOverride-1"> virt-viewer</span> connection is established. The <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> session may be running locally on the host system if it has a graphical desktop, or a connection may be established from a remote client as outlined in the chapter entitled <a href="../Text/KVM_Create_VM.xhtml#_idTextAnchor263"><span class="My-Italic _idGenCharOverride-1">“Creating KVM Virtual Machines using Cockpit and virt-manager”</span></a><span class="My-Italic _idGenCharOverride-1">.</span></p>&#13;
			<p class="My-Basic-Paragraph">The following command creates a new KVM virtual machine configured to run Fedora 29 using KVM para-virtualization. It creates a new 10GB disk image, assigns 1024MB of RAM to the virtual machine and configures a virtual CD device for the installation media ISO image: </p>&#13;
			<p class="Code"># virt-install --name MyFedora --memory 1024 --disk path=/tmp/myFedora.img, size=10 --network network=default --os-variant fedora29 --cdrom /tmp/Fedora-Server-dvd-x86_64-29-1.2.iso</p>&#13;
			<p class="My-Basic-Paragraph">As the creation process runs, the <span class="My-Italic _idGenCharOverride-1">virt-install</span> command will display status updates of the creation progress:</p>&#13;
			<p class="Code">Starting install...</p>&#13;
			<p class="Code">Allocating ‘MyFedora.img’                                |  10 GB  00:00:01     </p>&#13;
			<p class="Code">Domain installation still in progress. Waiting for installation to complete.</p>&#13;
			<p class="My-Basic-Paragraph">Once the guest system has been created, the <span class="My-Italic _idGenCharOverride-1">virt-viewer</span> screen will appear containing the operating system installer loaded from the specified installation media: </p>&#13;
			<p class="My-Basic-Paragraph ParaOverride-1"><img class="_idGenObjectAttribute-1" src="Images/rhel_8_virt-install_viewer.png" alt="" width="657" height="583"/></p>&#13;
			<p class="Figure-Caption"><span class="FigureCaptionMarker">Figure 22-1</span><a id="_idTextAnchor281"/></p>&#13;
			<p class="My-Basic-Paragraph">From this point, follow the standard installation procedure for the guest operating system. </p>&#13;
			<p id="_idParaDest-211" class="Heading-1-1"><span class="Heading11Marker">22.3 </span><a id="_idTextAnchor282"/>Starting and Stopping a Virtual Machine from the Command-Line</p>&#13;
			<p class="My-Basic-Paragraph">Having created the virtual machine from the command-line it stands to reason that you may also need to start it from the command-line in the future. This can be achieved using the virsh command-line utility, referencing the name assigned to the virtual machine during the creation process. For example:</p>&#13;
			<p class="Code"># virsh start MyFedora</p>&#13;
			<p class="My-Basic-Paragraph">Similarly, the virtual machine may be sent a shutdown signal as follows:</p>&#13;
			<p class="Code"># virsh shutdown MyFedora</p>&#13;
			<p class="My-Basic-Paragraph">If the virtual machine fails to respond to the shutdown signal and does not begin a graceful shutdown the virtual machine may be destroyed (with the attendant risks of data loss) using the destroy directive:</p>&#13;
			<p class="Code"># virsh destroy MyFedora</p>&#13;
			<p id="_idParaDest-212" class="Heading-1-1"><span class="Heading11Marker">22.4 </span><a id="_idTextAnchor283"/>Creating a Virtual Machine from a Configuration File</p>&#13;
			<p class="My-Basic-Paragraph">The <span class="My-Italic _idGenCharOverride-1">virsh create</span> command can take as an argument the name of a configuration file on which to base the creation of a new virtual machine. The configuration file uses XML format. Arguably the easiest way to create a configuration file is to dump out the configuration of an existing virtual machine and modify it for the new one. This can be achieved using the <span class="My-Italic _idGenCharOverride-1">virsh dumpxml</span> command. The following command outputs the configuration data for a virtual machine domain named MyFedora to a file named <span class="My-Italic _idGenCharOverride-1">MyFedora.xml</span>:</p>&#13;
			<p class="Code"># virsh dumpxml MyFedora &gt; MyFedora.xml</p>&#13;
			<p class="My-Basic-Paragraph">Once the file has been generated, load it into an editor to review and change the settings for the new virtual machine.</p>&#13;
			<p class="My-Basic-Paragraph">At the very least, the &lt;name&gt;, &lt;uuid&gt; and image file path &lt;source file&gt; must be changed in order to avoid conflict with the virtual machine from which the configuration was taken. In the case of the UUID, this line can simply be deleted from the file.</p>&#13;
			<p class="My-Basic-Paragraph">The virtualization type, memory allocation and number of CPUs to name but a few options may also be changed if required. Once the file has been modified, the new virtual machine may be created as follows:</p>&#13;
			<p class="Code"># virsh create MyFedora.xml</p>&#13;
			<p id="_idParaDest-213" class="Heading-1-1"><span class="Heading11Marker">22.5 </span><a id="_idTextAnchor284"/>Summary</p>&#13;
			<p class="My-Basic-Paragraph">KVM provides the <span class="My-Italic _idGenCharOverride-1">virt-install </span>and <span class="My-Italic _idGenCharOverride-1">virsh</span> command-line tools as a quick and efficient alternative to using the Cockpit and <span class="My-Italic _idGenCharOverride-1">virt-manager</span> tools to create and manage virtual machine instances. These tools have the advantage that they can be used from within scripts to automate the creation and management of virtual machines. The <span class="My-Italic _idGenCharOverride-1">virsh</span> command also includes the option to create VM instances from XML-based configuration files.</p>&#13;
		</div>&#13;
</div>



  </body></html>