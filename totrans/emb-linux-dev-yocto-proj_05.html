<html><head></head><body>
<div id="_idContainer048">
<h1 class="chapter-number" id="_idParaDest-49"><a id="_idTextAnchor077"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-50"><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.2.1">Grasping the BitBake Tool</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapter, we learned about metadata, metadata collection concepts, and the importance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">In this chapter, we will examine metadata more deeply, understand how recipes depend on each other, and see how BitBake deals </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">with dependencies.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In addition, we will cover a massive list of tasks, from downloading source code to generating images and other artifacts. </span><span class="koboSpan" id="kobo.7.2">Some examples of these tasks are storing the source code in the directory used for the build, patching, configuring, compiling, installing, and generating packages, and determining how the packages fit into the generated images, which we will introduce in </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">this chapter.</span></span></p>
<h1 id="_idParaDest-51"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.9.1">Parsing metadata</span></h1>
<p><span class="koboSpan" id="kobo.10.1">Usually, our projects include </span><a id="_idIndexMarker091"/><span class="koboSpan" id="kobo.11.1">multiple layers that provide different metadata to fulfill specific needs. </span><span class="koboSpan" id="kobo.11.2">For example, when we initialize a build directory, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">source oe-init-build-env build</span></strong><span class="koboSpan" id="kobo.13.1">, a set of files is generated </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<span class="koboSpan" id="kobo.15.1"><img alt="Figure 5.1 – A list of files created with source oe-init-build-env build" src="image/Figure_5.01_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.16.1">Figure 5.1 – A list of files created with source oe-init-build-env build</span></p>
<p><span class="koboSpan" id="kobo.17.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.18.1">build/conf/templateconf.cfg</span></strong><span class="koboSpan" id="kobo.19.1"> file points to the directory used as the template to create the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.20.1">build/conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.21.1"> directory.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.22.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.23.1">A user can provide a different template directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.24.1">TEMPLATECONF</span></strong><span class="koboSpan" id="kobo.25.1"> environment variable – for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.26.1">TEMPLATECONF=/some/dir source </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.27.1">oe-init-build-env build</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.29.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.30.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.31.1"> file is the placeholder for the local configurations. </span><span class="koboSpan" id="kobo.31.2">We used this file in </span><a href="B19361_02.xhtml#_idTextAnchor031"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.32.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.33.1">, </span><em class="italic"><span class="koboSpan" id="kobo.34.1">Baking Our First Poky-Based System</span></em><span class="koboSpan" id="kobo.35.1">, and we will use it </span><a id="_idIndexMarker092"/><span class="koboSpan" id="kobo.36.1">throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">this book.</span></span></p>
<p><span class="koboSpan" id="kobo.38.1">BitBake uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.39.1">build/conf/bblayers.conf</span></strong><span class="koboSpan" id="kobo.40.1"> file to list the layers considered in the build environment. </span><span class="koboSpan" id="kobo.40.2">An example is </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer035">
<span class="koboSpan" id="kobo.42.1"><img alt="Figure 5.2 – The build/conf/bblayer.conf content after ﻿the source oe-init-build-env build" src="image/Figure_5.02_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.43.1">Figure 5.2 – The build/conf/bblayer.conf content after the source oe-init-build-env build</span></p>
<p><span class="koboSpan" id="kobo.44.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.45.1">BBLAYERS</span></strong><span class="koboSpan" id="kobo.46.1"> variable, on line 8, is a space-delimited list of layer directories. </span><span class="koboSpan" id="kobo.46.2">BitBake parses each layer to load its content to the metadata collection. </span><span class="koboSpan" id="kobo.46.3">There are three major categories that the metadata used by BitBake can be classified into. </span><span class="koboSpan" id="kobo.46.4">They are listed </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.48.1">Configuration (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.50.1">conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.51.1"> files)</span></span></li>
<li><span class="koboSpan" id="kobo.52.1">Classes (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">bbclass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.55.1"> files)</span></span></li>
<li><span class="koboSpan" id="kobo.56.1">Recipes (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">.bb</span></strong><span class="koboSpan" id="kobo.58.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.59.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">bbappend</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.61.1"> files)</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.62.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.63.1">The order of the listed layers in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">BBLAYERS</span></strong><span class="koboSpan" id="kobo.65.1"> variable is followed from left to right by BitBake when parsing the metadata. </span><span class="koboSpan" id="kobo.65.2">Therefore, if your layer needs to be parsed first, have it listed in the right place in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">BBLAYERS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.67.1"> variable.</span></span></p>
<p><span class="koboSpan" id="kobo.68.1">After parsing all </span><a id="_idIndexMarker093"/><span class="koboSpan" id="kobo.69.1">the layers in use, BitBake starts to parse the metadata. </span><span class="koboSpan" id="kobo.69.2">The first parsed metadata in BitBake is configuration metadata, identified by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">.conf</span></strong><span class="koboSpan" id="kobo.71.1"> file extension. </span><span class="koboSpan" id="kobo.71.2">This metadata is global and, therefore, affects all executed recipes </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">and tasks.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.73.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.74.1">One typical example of the configuration file is the machine file, which has a list of settings that describes </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">the hardware.</span></span></p>
<p><span class="koboSpan" id="kobo.76.1">BitBake first loads </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">meta/conf/bitbake.conf</span></strong><span class="koboSpan" id="kobo.78.1"> from one of the paths included in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">BBPATH</span></strong><span class="koboSpan" id="kobo.80.1"> list. </span><span class="koboSpan" id="kobo.80.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">meta/conf/bitbake.conf</span></strong><span class="koboSpan" id="kobo.82.1"> file uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">include</span></strong><span class="koboSpan" id="kobo.84.1"> directives to pull in metadata, such as architecture-specific metadata, machine configuration files, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.86.1"> file. </span><span class="koboSpan" id="kobo.86.2">One significant restriction of BitBake configuration files (</span><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">.conf</span></strong><span class="koboSpan" id="kobo.88.1">) is that only variable definitions and </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">include</span></strong><span class="koboSpan" id="kobo.90.1"> directives </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">are allowed.</span></span></p>
<p><span class="koboSpan" id="kobo.92.1">BitBake’s classes (</span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">.bbclass</span></strong><span class="koboSpan" id="kobo.94.1">) are a rudimentary inheritance mechanism in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">classes/</span></strong><span class="koboSpan" id="kobo.96.1"> directories. </span><span class="koboSpan" id="kobo.96.2">When an </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">inherit</span></strong><span class="koboSpan" id="kobo.98.1"> directive appears during parsing, BitBake immediately parses the linked class. </span><span class="koboSpan" id="kobo.98.2">The class content is searched based on the order of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">BBPATH</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.100.1">variable list.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">BBFILES</span></strong><span class="koboSpan" id="kobo.103.1"> variable is a space-separated list of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">.bb</span></strong><span class="koboSpan" id="kobo.105.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">.bbappend</span></strong><span class="koboSpan" id="kobo.107.1"> files and can use wildcards. </span><span class="koboSpan" id="kobo.107.2">It is required in every layer inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">conf/layer.conf</span></strong><span class="koboSpan" id="kobo.109.1">, so BitBake knows where to look </span><a id="_idIndexMarker094"/><span class="koboSpan" id="kobo.110.1">for recipes. </span><span class="koboSpan" id="kobo.110.2">A BitBake recipe (</span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">.bb</span></strong><span class="koboSpan" id="kobo.112.1">) is a logical unit </span><a id="_idIndexMarker095"/><span class="koboSpan" id="kobo.113.1">of tasks to be executed; typically, it refers to </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">a package.</span></span></p>
<h1 id="_idParaDest-52"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.115.1">Dependencies</span></h1>
<p><span class="koboSpan" id="kobo.116.1">From the BitBake </span><a id="_idIndexMarker096"/><span class="koboSpan" id="kobo.117.1">point of view, there are three different </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">dependency types:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.119.1">Build time</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.120.1">Execution </span></span><span class="No-Break"><a id="_idIndexMarker097"/></span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">time</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.122.1">Tasks</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.123.1">An application that needs some other package, such as a library, has a build dependency for a successful compilation. </span><span class="koboSpan" id="kobo.123.2">Build </span><a id="_idIndexMarker098"/><span class="koboSpan" id="kobo.124.1">dependencies include compilers. </span><span class="koboSpan" id="kobo.124.2">libraries, and native build tools (such as </span><strong class="bold"><span class="koboSpan" id="kobo.125.1">CMake</span></strong><span class="koboSpan" id="kobo.126.1">). </span><span class="koboSpan" id="kobo.126.2">In addition, a build dependency has an execution dependency whenever </span><a id="_idIndexMarker099"/><span class="koboSpan" id="kobo.127.1">an application is needed only during execution time. </span><span class="koboSpan" id="kobo.127.2">Runtime dependencies include fonts, icons, dynamically opened libraries, and </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">language interpreters.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.129.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.130.1">The convention inside Poky is to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">-native</span></strong><span class="koboSpan" id="kobo.132.1"> suffixes for recipe names. </span><span class="koboSpan" id="kobo.132.2">This is because those tools are aimed to be run during the build process, in the host building system, and are not deployed into </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">the target.</span></span></p>
<p><span class="koboSpan" id="kobo.134.1">The task dependencies create order in the chaos of task execution – for example, to compile a package, the source code needs to be downloaded. </span><span class="koboSpan" id="kobo.134.2">Under the hood, all the dependencies are task dependencies. </span><span class="koboSpan" id="kobo.134.3">This means that when package </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">B</span></strong><span class="koboSpan" id="kobo.136.1"> has a build-time dependency on package </span><strong class="source-inline"><span class="koboSpan" id="kobo.137.1">A</span></strong><span class="koboSpan" id="kobo.138.1">, the tasks from package </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">A</span></strong><span class="koboSpan" id="kobo.140.1"> need to be completed before package </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">B</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.142.1"> starts.</span></span></p>
<p><span class="koboSpan" id="kobo.143.1">Metadata expresses all the dependencies. </span><span class="koboSpan" id="kobo.143.2">OpenEmbedded Core provides a vast set of classes to handle the default task dependencies commonly used – for example, a recipe can express a build-time dependency with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">DEPENDS</span></strong><span class="koboSpan" id="kobo.145.1"> variable and an execution-time dependence with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">RDEPENDS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.147.1"> variable.</span></span></p>
<p><span class="koboSpan" id="kobo.148.1">Knowing the recipe dependencies chain, BitBake can sort all the recipes for the build in a feasible order. </span><span class="koboSpan" id="kobo.148.2">BitBake organizes tasks in the </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">following ways:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.150.1">Recipe tasks </span><a id="_idIndexMarker100"/><span class="koboSpan" id="kobo.151.1">that do not have a dependency relation are built </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">in parallel</span></span></li>
<li><span class="koboSpan" id="kobo.153.1">Dependent recipes are built in serial order and sorted in a way that satisfies </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">the dependencies</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.155.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.156.1">Every recipe included in the runtime dependencies is added to the build list. </span><span class="koboSpan" id="kobo.156.2">This sounds obvious, but even though they have no role during the build, they need to be ready for use so that the resulting binary packages are installable. </span><span class="koboSpan" id="kobo.156.3">This will be required when building images or </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">populating feeds.</span></span></p>
<h1 id="_idParaDest-53"><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.158.1">Preferring and providing recipes</span></h1>
<p><span class="koboSpan" id="kobo.159.1">Dependency is a relation between two things; one side can only be fulfilled if the other side exists. </span><span class="koboSpan" id="kobo.159.2">However, a dependency only specifies that some functionality or characteristic is </span><a id="_idIndexMarker101"/><span class="koboSpan" id="kobo.160.1">needed to be fulfilled, not precisely how it must </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">be fulfilled.</span></span></p>
<p><span class="koboSpan" id="kobo.162.1">For example, when a recipe depends on </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">A</span></strong><span class="koboSpan" id="kobo.164.1">, the first thought is that it depends on a recipe called </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">A</span></strong><span class="koboSpan" id="kobo.166.1">. </span><span class="koboSpan" id="kobo.166.2">However, there are two possible ways to satisfy the dependency requirement </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">A</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.170.1">A recipe </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">A</span></strong></span></li>
<li><span class="koboSpan" id="kobo.173.1">A recipe that provides a functionality or characteristic </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">A</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.176.1">For a recipe to communicate to BitBake that it can fulfill a functionality or characteristic requirement, it must use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">PROVIDES</span></strong><span class="koboSpan" id="kobo.178.1"> keyword. </span><span class="koboSpan" id="kobo.178.2">A subtle consequence is that two or more recipes can </span><a id="_idIndexMarker102"/><span class="koboSpan" id="kobo.179.1">deliver the same functionality or characteristic. </span><span class="koboSpan" id="kobo.179.2">We </span><a id="_idIndexMarker103"/><span class="koboSpan" id="kobo.180.1">must inform BitBake which recipe should fulfill that requirement using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">PREFERRED_PROVIDER</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.182.1"> keyword.</span></span></p>
<p><span class="koboSpan" id="kobo.183.1">So, if a recipe called </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">foo_1.0.bb</span></strong><span class="koboSpan" id="kobo.185.1"> depends on </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">bar</span></strong><span class="koboSpan" id="kobo.187.1">, BitBake lists all recipes providing </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">bar</span></strong><span class="koboSpan" id="kobo.189.1">. </span><span class="koboSpan" id="kobo.189.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">bar</span></strong><span class="koboSpan" id="kobo.191.1"> dependency can be satisfied by </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.193.1">A recipe with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">bar_&lt;version&gt;.bb</span></strong><span class="koboSpan" id="kobo.195.1"> format because every recipe provides itself </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">by default</span></span></li>
<li><span class="koboSpan" id="kobo.197.1">A recipe where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">PROVIDES</span></strong><span class="koboSpan" id="kobo.199.1"> variable </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">includes </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">bar</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.202.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">virtual/kernel</span></strong><span class="koboSpan" id="kobo.204.1"> provider is a clear example of this mechanism. </span><span class="koboSpan" id="kobo.204.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">virtual/</span></strong><span class="koboSpan" id="kobo.206.1"> namespace is the convention </span><a id="_idIndexMarker104"/><span class="koboSpan" id="kobo.207.1">adopted when we have a set of commonly </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">overridden providers.</span></span></p>
<p><span class="koboSpan" id="kobo.209.1">All recipes that require the kernel to be built can add </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">virtual/kernel</span></strong><span class="koboSpan" id="kobo.211.1"> to the dependency list (</span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">DEPENDS</span></strong><span class="koboSpan" id="kobo.213.1">), and BitBake satisfies the dependency. </span><span class="koboSpan" id="kobo.213.2">When we have more than one recipe with an alternative provider, we must choose one to be used – for example, </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer036">
<span class="koboSpan" id="kobo.215.1"><img alt="Figure 5.3 – An example of how to set a preferred provider for virtual/kernel" src="image/Figure_5.03_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.216.1">Figure 5.3 – An example of how to set a preferred provider for virtual/kernel</span></p>
<p><span class="koboSpan" id="kobo.217.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">virtual/kernel</span></strong><span class="koboSpan" id="kobo.219.1"> provider is commonly set in the machine definition file, as it can vary from </span><a id="_idIndexMarker105"/><span class="koboSpan" id="kobo.220.1">machine to machine. </span><span class="koboSpan" id="kobo.220.2">We will see how to create a machine definition file in </span><a href="B19361_12.xhtml#_idTextAnchor147"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.221.1">Chapter 12</span></em></span></a><span class="koboSpan" id="kobo.222.1">, </span><em class="italic"><span class="koboSpan" id="kobo.223.1">Creating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.224.1">Custom Layers</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.226.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.227.1">BitBake raises an error when </span><a id="_idIndexMarker106"/><span class="koboSpan" id="kobo.228.1">a dependency cannot be satisfied due to a </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">missing provider.</span></span></p>
<p><span class="koboSpan" id="kobo.230.1">When BitBake has </span><a id="_idIndexMarker107"/><span class="koboSpan" id="kobo.231.1">two providers with different versions, it uses the </span><a id="_idIndexMarker108"/><span class="koboSpan" id="kobo.232.1">highest version by default. </span><span class="koboSpan" id="kobo.232.2">However, we can force BitBake to use a different version by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">PREFERRED_VERSION</span></strong><span class="koboSpan" id="kobo.234.1">. </span><span class="koboSpan" id="kobo.234.2">This is common in BSPs, such as bootloaders, where vendors may use specific versions for </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">a board.</span></span></p>
<p><span class="koboSpan" id="kobo.236.1">We can avoid using a development or an unreliable recipe version, by default, lowering the version preference by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">DEFAULT_PREFERENCE</span></strong><span class="koboSpan" id="kobo.238.1"> keyword in a recipe file, </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer037">
<span class="koboSpan" id="kobo.240.1"><img alt="Figure 5.4 – How to lower the version preference in a recipe" src="image/Figure_5.04_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.241.1">Figure 5.4 – How to lower the version preference in a recipe</span></p>
<p><span class="koboSpan" id="kobo.242.1">So, even if the version is higher, the recipe is not choosen without </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">PREFERRED_VERSION</span></strong><span class="koboSpan" id="kobo.244.1"> being explicitly set to </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">use it.</span></span></p>
<h1 id="_idParaDest-54"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.246.1">Fetching the source code</span></h1>
<p><span class="koboSpan" id="kobo.247.1">When we </span><a id="_idIndexMarker109"/><span class="koboSpan" id="kobo.248.1">download the Poky source code, we download the metadata collection and the BitBake tool. </span><span class="koboSpan" id="kobo.248.2">One of the main features supported by BitBake is additional source </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">code fetching.</span></span></p>
<p><span class="koboSpan" id="kobo.250.1">The ability of fetching external source code is as modular and flexible as possible. </span><span class="koboSpan" id="kobo.250.2">For example, every Linux-based system includes the Linux kernel and several other utilities that form the </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">root</span></strong><span class="koboSpan" id="kobo.252.1"> filesystem, such as OpenSSH </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">or BusyBox.</span></span></p>
<p><span class="koboSpan" id="kobo.254.1">The OpenSSH source code is available from its upstream website as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">tar.gz</span></strong><span class="koboSpan" id="kobo.256.1"> file hosted on an HTTP server, while the Linux kernel release is in a Git repository. </span><span class="koboSpan" id="kobo.256.2">Therefore, BitBake can easily fetch those two different instances of </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">source code.</span></span></p>
<p><span class="koboSpan" id="kobo.258.1">BitBake offers support for many different fetcher modules that allow the retrieval of tarball files and several other SCM systems, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.260.1">Amazon </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">AWS S3</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.262.1">Android repo</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.263.1">Azure Storage</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.264.1">Bazaar</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.265.1">ClearCase</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.266.1">CVS</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.267.1">FTP</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.268.1">Git</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.269.1">Git Annex</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.270.1">Git submodules</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.271.1">HTTP(S)</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.272.1">Mercurial</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.273.1">NPM</span></span></li>
<li><span class="koboSpan" id="kobo.274.1">NPMSW (</span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">npm </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">shrinkwrap</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.277.1"> implementation)</span></span></li>
<li><span class="koboSpan" id="kobo.278.1">openSUSE Build </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">Service client</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.280.1">Perforce</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.281.1">Rust Crate</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.282.1">SFTP</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.283.1">SSH</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.284.1">Subversion</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.285.1">The mechanism used </span><a id="_idIndexMarker110"/><span class="koboSpan" id="kobo.286.1">by BitBake to fetch the source code is internally called a fetcher backend, which </span><a id="_idIndexMarker111"/><span class="koboSpan" id="kobo.287.1">is configurable to align a user’s requirements and optimize fetching the </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">source code.</span></span></p>
<h2 id="_idParaDest-55"><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.289.1">Remote file downloads</span></h2>
<p><span class="koboSpan" id="kobo.290.1">BitBake supports several </span><a id="_idIndexMarker112"/><span class="koboSpan" id="kobo.291.1">methods for remote file downloads. </span><span class="koboSpan" id="kobo.291.2">The </span><a id="_idIndexMarker113"/><span class="koboSpan" id="kobo.292.1">most commonly used are </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">http://</span></strong><span class="koboSpan" id="kobo.294.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">https://</span></strong><span class="koboSpan" id="kobo.296.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">git://</span></strong><span class="koboSpan" id="kobo.298.1">. </span><span class="koboSpan" id="kobo.298.2">We won’t cover the internal details of how BitBake handles remote file downloads and will instead focus on its </span><span class="No-Break"><span class="koboSpan" id="kobo.299.1">visible effects.</span></span></p>
<p><span class="koboSpan" id="kobo.300.1">When BitBake executes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">do_fetch</span></strong><span class="koboSpan" id="kobo.302.1"> task in a recipe, it checks the </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">SRC_URI</span></strong><span class="koboSpan" id="kobo.304.1"> contents. </span><span class="koboSpan" id="kobo.304.2">Let’s look at, for example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">pm-utils</span></strong><span class="koboSpan" id="kobo.306.1"> recipe (available at </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">meta/recipes-bsp/pm-utils/pm-utils_1.4.1.bb</span></strong><span class="koboSpan" id="kobo.308.1">). </span><span class="koboSpan" id="kobo.308.2">The processed variables are shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer038">
<span class="koboSpan" id="kobo.310.1"><img alt="Figure 5.5 – ﻿﻿SRC_URI for the pm-utils_1.4.1.bb recipe ﻿" src="image/Figure_5.05_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.311.1">Figure 5.5 – SRC_URI for the pm-utils_1.4.1.bb recipe </span></p>
<p><span class="koboSpan" id="kobo.312.1">BitBake expands the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">PV</span></strong><span class="koboSpan" id="kobo.314.1"> variable to the package version (</span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">1.4.1</span></strong><span class="koboSpan" id="kobo.316.1"> in this example is taken from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">pm-utils_1.4.1.bb</span></strong><span class="koboSpan" id="kobo.318.1"> recipe filename) to download the file from </span><a href="http://pm-utils.freedesktop.org/releases/pm-utils-1.4.1.tar.gz"><span class="koboSpan" id="kobo.319.1">http://pm-utils.freedesktop.org/releases/pm-utils-1.4.1.tar.gz</span></a><span class="koboSpan" id="kobo.320.1">, and then saves it as </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">DL_DIR</span></strong><span class="koboSpan" id="kobo.322.1">, which points to the download </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">storage directory.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">After the download is complete, BitBake compares the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">sha256sum</span></strong><span class="koboSpan" id="kobo.326.1"> value of the downloaded file </span><a id="_idIndexMarker114"/><span class="koboSpan" id="kobo.327.1">with the value from the recipe. </span><span class="koboSpan" id="kobo.327.2">If the value </span><a id="_idIndexMarker115"/><span class="koboSpan" id="kobo.328.1">matches, it creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">${DL_DIR}/pm-utils-1.4.1.tar.gz.done</span></strong><span class="koboSpan" id="kobo.330.1"> file to mark the file as successfully downloaded and checked, allowing BitBake to </span><span class="No-Break"><span class="koboSpan" id="kobo.331.1">reuse it.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.332.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.333.1">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">DL_DIR</span></strong><span class="koboSpan" id="kobo.335.1"> variable points to </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">build/downloads</span></strong><span class="koboSpan" id="kobo.337.1">. </span><span class="koboSpan" id="kobo.337.2">You can override this by adding to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">build/conf/local.conf</span></strong><span class="koboSpan" id="kobo.339.1"> file the following line – </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">DL_DIR = "/my/download-cache"</span></strong><span class="koboSpan" id="kobo.341.1">. </span><span class="koboSpan" id="kobo.341.2">Using this, we can share the same download cache among several build directories, thus saving download time </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">and bandwidth.</span></span></p>
<h2 id="_idParaDest-56"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.343.1">Git repositories</span></h2>
<p><span class="koboSpan" id="kobo.344.1">One of the most commonly </span><a id="_idIndexMarker116"/><span class="koboSpan" id="kobo.345.1">used source control management systems is Git. </span><span class="koboSpan" id="kobo.345.2">BitBake</span><a id="_idIndexMarker117"/><span class="koboSpan" id="kobo.346.1"> has solid support for Git, and the Git backend is used when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">do_fetch</span></strong><span class="koboSpan" id="kobo.348.1"> task is run and finds a </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">git://</span></strong><span class="koboSpan" id="kobo.350.1"> URL at the beginning of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">SRC_URI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1"> variable.</span></span></p>
<p><span class="koboSpan" id="kobo.353.1">The default way for BitBake’s Git backend to handle the repositories is to clone the repository in </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">${DL_DIR}/git2/&lt;git URL&gt;</span></strong><span class="koboSpan" id="kobo.355.1"> – for example, check the following quote from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">lz4_1.9.4.bb</span></strong><span class="koboSpan" id="kobo.357.1"> recipe found in </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">meta/recipes-support/lz4/lz4_1.9.4.bb</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.359.1">inside Poky:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer039">
<span class="koboSpan" id="kobo.360.1"><img alt="Figure 5.6 – Source code download configuration for the lz4_1.9.4.bb recipe" src="image/Figure_5.06_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.361.1">Figure 5.6 – Source code download configuration for the lz4_1.9.4.bb recipe</span></p>
<p><span class="koboSpan" id="kobo.362.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">lz4.git</span></strong><span class="koboSpan" id="kobo.364.1"> repository is cloned in </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">${DL_DIR}/git2/ github.com.lz4.lz4.git</span></strong><span class="koboSpan" id="kobo.366.1">. </span><span class="koboSpan" id="kobo.366.2">This directory name avoids conflicts between possible Git repositories with the same </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">project name.</span></span></p>
<p><span class="koboSpan" id="kobo.368.1">There are two cases where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">SRCREV</span></strong><span class="koboSpan" id="kobo.370.1"> variable has an impact. </span><span class="koboSpan" id="kobo.370.2">They are </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">do_fetch</span></strong><span class="koboSpan" id="kobo.373.1">: This task uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">SRCREV</span></strong><span class="koboSpan" id="kobo.375.1"> variable to ensure the repository has the required </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">Git revision</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">do_unpack</span></strong><span class="koboSpan" id="kobo.378.1">: This task uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">SRCREV</span></strong><span class="koboSpan" id="kobo.380.1"> to set up the working directory with the necessary </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">source revision</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.382.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.383.1">We need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">branch=&lt;branch name&gt;</span></strong><span class="koboSpan" id="kobo.385.1"> parameter as follows – </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">SRC_URI = "git://myserver/myrepo.git;branch=mybranch"</span></strong><span class="koboSpan" id="kobo.387.1"> – to specify the branch that contains the revision we want to use. </span><span class="koboSpan" id="kobo.387.2">In cases when the hash used points to a tag that is not available on a branch, we need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">nobranch=1</span></strong><span class="koboSpan" id="kobo.389.1"> option as follows – </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">SRC_URI = "</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">git://myserver/myrepo.git;nobranch=1"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.393.1">The remote file and the Git repository </span><a id="_idIndexMarker118"/><span class="koboSpan" id="kobo.394.1">are the most commonly used fetch backends </span><a id="_idIndexMarker119"/><span class="koboSpan" id="kobo.395.1">of BitBake. </span><span class="koboSpan" id="kobo.395.2">The other source code management-supported systems vary in their implementations, but the general ideas and concepts are </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">the same.</span></span></p>
<h1 id="_idParaDest-57"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.397.1">Optimizing the source code download</span></h1>
<p><span class="koboSpan" id="kobo.398.1">To improve the </span><a id="_idIndexMarker120"/><span class="koboSpan" id="kobo.399.1">robustness of source code download, Poky provides a mirror mechanism that can provide </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.401.1">A centrally preferred server </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">for download</span></span></li>
<li><span class="koboSpan" id="kobo.403.1">A set of </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">fallback servers</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.405.1">To provide this robust download mechanism, BitBake follows defined logic steps. </span><span class="koboSpan" id="kobo.405.2">During the build, the first BitBake step is to search for the source code within the local download directory (specified by </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">DL_DIR</span></strong><span class="koboSpan" id="kobo.407.1">). </span><span class="koboSpan" id="kobo.407.2">If this fails, the next step is to try the locations defined by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">PREMIRRORS</span></strong><span class="koboSpan" id="kobo.409.1"> variable. </span><span class="koboSpan" id="kobo.409.2">Finally, BitBake searches the locations specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">MIRRORS</span></strong><span class="koboSpan" id="kobo.411.1"> variable in a failure case. </span><span class="koboSpan" id="kobo.411.2">In summary, these steps are </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">as follows:</span></span></p>
<ol>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">DL_DIR</span></strong><span class="koboSpan" id="kobo.414.1">: Look for the download on the </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">host machine.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">MIRRORS</span></strong><span class="koboSpan" id="kobo.417.1">: Search for the download in a list </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">of mirrors.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">PREMIRRORS</span></strong><span class="koboSpan" id="kobo.420.1">: This is used to reduce the download from external servers and is usually used inside companies to reduce or forbid </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">internet use.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.422.1">For example, when configuring a local server, </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">https://mylocalserver</span></strong><span class="koboSpan" id="kobo.424.1">, as </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">PREMIRROR</span></strong><span class="koboSpan" id="kobo.426.1">, we can add the following code to a global configuration file, such </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer040">
<span class="koboSpan" id="kobo.430.1"><img alt="Figure 5.7 – An example of the PREMIRRORS configuration" src="image/Figure_5.07_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.431.1">Figure 5.7 – An example of the PREMIRRORS configuration</span></p>
<p><span class="koboSpan" id="kobo.432.1">The preceding </span><a id="_idIndexMarker121"/><span class="koboSpan" id="kobo.433.1">code prepends the </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">PREMIRRORS</span></strong><span class="koboSpan" id="kobo.435.1"> variable to change and instructs the build system to intercept any download requests. </span><span class="koboSpan" id="kobo.435.2">It redirects them to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">https://mylocalserver</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.437.1">source’s mirror.</span></span></p>
<p><span class="koboSpan" id="kobo.438.1">This use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">PREMIRRORS</span></strong><span class="koboSpan" id="kobo.440.1"> is so common that there is a class to help its configuration. </span><span class="koboSpan" id="kobo.440.2">To make it easier, we inherit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">own-mirror</span></strong><span class="koboSpan" id="kobo.442.1"> class and then set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">SOURCE_MIRROR_URL</span></strong><span class="koboSpan" id="kobo.444.1"> variable to </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">https://mylocalserver</span></strong><span class="koboSpan" id="kobo.446.1"> in any global configuration file, such </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer041">
<span class="koboSpan" id="kobo.450.1"><img alt="Figure 5.8 – How to configure own-mirror" src="image/Figure_5.08_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.451.1">Figure 5.8 – How to configure own-mirror</span></p>
<p><span class="koboSpan" id="kobo.452.1">If the desired component is unavailable in the source mirror, BitBake falls back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">MIRRORS</span></strong><span class="koboSpan" id="kobo.454.1"> variable. </span><span class="koboSpan" id="kobo.454.2">An </span><a id="_idIndexMarker122"/><span class="koboSpan" id="kobo.455.1">example of the content of this variable is shown in the following figure. </span><span class="koboSpan" id="kobo.455.2">It shows some servers used in </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">mirrors.bbclass</span></strong><span class="koboSpan" id="kobo.457.1">, inherited by default </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">in Poky:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer042">
<span class="koboSpan" id="kobo.459.1"><img alt="Figure 5.9 – An example of how to use the MIRRORS variable" src="image/Figure_5.09_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.460.1">Figure 5.9 – An example of how to use the MIRRORS variable</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.461.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.462.1">Let’s suppose the goal is to have a shareable download cache. </span><span class="koboSpan" id="kobo.462.2">In that case, it is advisable to enable the tarball generation for the SCM backends (for example, Git) in the download folder with </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">BB_GENERATE_MIRROR_TARBALLS = "1"</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.464.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">.</span></span></p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.467.1">Disabling network access</span></h2>
<p><span class="koboSpan" id="kobo.468.1">Sometimes, we </span><a id="_idIndexMarker123"/><span class="koboSpan" id="kobo.469.1">need to ensure that we don’t connect </span><a id="_idIndexMarker124"/><span class="koboSpan" id="kobo.470.1">to the internet during the build process. </span><span class="koboSpan" id="kobo.470.2">There are several valid reasons for this, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">the following:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.472.1">Policy</span></strong><span class="koboSpan" id="kobo.473.1">: Our company </span><a id="_idIndexMarker125"/><span class="koboSpan" id="kobo.474.1">does not allow the inclusion of external sources in a product without proper legal validation </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">and review.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.476.1">Network cost</span></strong><span class="koboSpan" id="kobo.477.1">: When we are on the road using mobile broadband, the cost of data may be too high because the data to download may </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">be extensive.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.479.1">Download and build decoupling</span></strong><span class="koboSpan" id="kobo.480.1">: This setup is typical in continuous integration environments, where a job is responsible for downloading all the required source code. </span><span class="koboSpan" id="kobo.480.2">In contrast, the build jobs have internet access disabled. </span><span class="koboSpan" id="kobo.480.3">The decoupling between downloading and building ensures that no source code is downloaded in duplication and that we have cached all the necessary </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">source code.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.482.1">Lack of network access</span></strong><span class="koboSpan" id="kobo.483.1">: Sometimes, we do not have access to </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">a network.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.485.1">To disable the network connection, we need to add the following code in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">build/conf/local.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.487.1"> file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer043">
<span class="koboSpan" id="kobo.488.1"><img alt="Figure 5.10 – How to disable network access during the build" src="image/Figure_5.10_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.489.1">Figure 5.10 – How to disable network access during the build</span></p>
<h1 id="_idParaDest-59"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.490.1">Understanding BitBake’s tasks</span></h1>
<p><span class="koboSpan" id="kobo.491.1">BitBake uses execution </span><a id="_idIndexMarker126"/><span class="koboSpan" id="kobo.492.1">units, which are, in essence, a set of clustered instructions that run in sequence. </span><span class="koboSpan" id="kobo.492.2">These units are known as </span><strong class="bold"><span class="koboSpan" id="kobo.493.1">tasks</span></strong><span class="koboSpan" id="kobo.494.1">. </span><span class="koboSpan" id="kobo.494.2">During every recipe’s build, BitBake, schedules, executes, and checks </span><a id="_idIndexMarker127"/><span class="koboSpan" id="kobo.495.1">many tasks provided by classes to form the framework we use to build a recipe. </span><span class="koboSpan" id="kobo.495.2">Therefore, it is essential to understand some of these, as we often use, extend, implement, or replace them ourselves when writing </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">a recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.497.1">When we run the following command, BitBake runs a set of </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">scheduled tasks:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer044">
<span class="koboSpan" id="kobo.499.1"><img alt="Figure 5.11 – How to run all tasks for a recipe" src="image/Figure_5.11_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.500.1">Figure 5.11 – How to run all tasks for a recipe</span></p>
<p><span class="koboSpan" id="kobo.501.1">When we wish to run a specific task, we can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<span class="koboSpan" id="kobo.503.1"><img alt="Figure 5.12  – How to run a particular task for a recipe" src="image/Figure_5.12_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.504.1">Figure 5.12  – How to run a particular task for a recipe</span></p>
<p><span class="koboSpan" id="kobo.505.1">To list the tasks </span><a id="_idIndexMarker128"/><span class="koboSpan" id="kobo.506.1">defined for a recipe, we can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer046">
<span class="koboSpan" id="kobo.508.1"><img alt="Figure 5.13  – How to list all tasks for a recipe" src="image/Figure_5.13_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.509.1">Figure 5.13  – How to list all tasks for a recipe</span></p>
<p><span class="koboSpan" id="kobo.510.1">The output of </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">listtasks</span></strong><span class="koboSpan" id="kobo.512.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">wget</span></strong><span class="koboSpan" id="kobo.514.1"> recipe is </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer047">
<span class="koboSpan" id="kobo.516.1"><img alt="Figure 5.14 – The list of tasks for the wget recipe" src="image/Figure_5.14_B19361.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.517.1">Figure 5.14 – The list of tasks for the wget recipe</span></p>
<p><span class="koboSpan" id="kobo.518.1">We will briefly describe the most commonly used </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">tasks here:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">do_fetch</span></strong><span class="koboSpan" id="kobo.521.1">: The first step when building a recipe is fetching the required source using the fetching backends </span><a id="_idIndexMarker129"/><span class="koboSpan" id="kobo.522.1">feature, which we discussed previously in this chapter. </span><span class="koboSpan" id="kobo.522.2">It is essential to note that fetching a source or a file does not mean it is a </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">remote source.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">do_unpack</span></strong><span class="koboSpan" id="kobo.525.1">: The subsequent natural task after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">do_fetch</span></strong><span class="koboSpan" id="kobo.527.1"> task is </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">do_unpack</span></strong><span class="koboSpan" id="kobo.529.1">. </span><span class="koboSpan" id="kobo.529.2">This is responsible for unpacking source code or checking out the requested revision or branch in case the referenced source uses an </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">SCM system.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">do_patch</span></strong><span class="koboSpan" id="kobo.532.1">: Once the source code is properly unpacked, BitBake initiates adapting the source code. </span><span class="koboSpan" id="kobo.532.2">Every file fetched by </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">do_fetch</span></strong><span class="koboSpan" id="kobo.534.1">, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">.patch</span></strong><span class="koboSpan" id="kobo.536.1"> extension, is assumed to be a patch to be applied. </span><span class="koboSpan" id="kobo.536.2">This task applies the list of patches needed. </span><span class="koboSpan" id="kobo.536.3">The final modified source code will be used to build </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">the package.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">do_configure</span></strong><span class="koboSpan" id="kobo.539.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">do_compile</span></strong><span class="koboSpan" id="kobo.541.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">do_install</span></strong><span class="koboSpan" id="kobo.543.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">do_configure</span></strong><span class="koboSpan" id="kobo.545.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">do_compile</span></strong><span class="koboSpan" id="kobo.547.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">do_install</span></strong><span class="koboSpan" id="kobo.549.1"> tasks are performed in this order. </span><span class="koboSpan" id="kobo.549.2">It is important to note that the environment variables defined in the tasks are different from one task to another. </span><span class="koboSpan" id="kobo.549.3">Poky provides a rich collection of predefined tasks in the classes, which we ought to use when possible – for example, when a recipe inherits the </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">autotools</span></strong><span class="koboSpan" id="kobo.551.1"> class, it provides a known implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">do_configure</span></strong><span class="koboSpan" id="kobo.553.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">do_compile</span></strong><span class="koboSpan" id="kobo.555.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">do_install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.557.1"> tasks.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">do_package</span></strong><span class="koboSpan" id="kobo.559.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">do_package</span></strong><span class="koboSpan" id="kobo.561.1"> task splits the files installed by the recipe into logical components, such </span><a id="_idIndexMarker130"/><span class="koboSpan" id="kobo.562.1">as debugging symbols, documentation, and libraries. </span><span class="koboSpan" id="kobo.562.2">We will cover packaging details in more depth in </span><a href="B19361_07.xhtml#_idTextAnchor097"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.563.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.564.1">,</span><em class="italic"><span class="koboSpan" id="kobo.565.1"> Assimilating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.566.1">Package Support</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.567.1">.</span></span></li>
</ul>
<h1 id="_idParaDest-60"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.568.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.569.1">In this chapter, we learned how recipes depend on each other and how Poky deals with dependencies. </span><span class="koboSpan" id="kobo.569.2">We understood how a download is configured and how to optimize it. </span><span class="koboSpan" id="kobo.569.3">In addition, we got a better view of the tasks managed by BitBake to download all the required source code and use it to build and </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">generate packages.</span></span></p>
<p><span class="koboSpan" id="kobo.571.1">In the next chapter, we will see the contents of the build directory after complete image generation and learn how BitBake uses it in the baking process, including the contents of the temporary build directory and its </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">generated files.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer049">
</div>
</div>
</body></html>