- en: '*Chapter 3*: Managing User Logins'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '*第3章*：管理用户登录'
- en: When we log in to an SELinux-enabled system, we receive an SELinux context to
    work in. This context contains an SELinux user, an SELinux role, a domain, and
    optionally, a sensitivity range. As the SELinux user defines the roles and types
    that can be accessed, managing user logins and SELinux users is the first step
    in configuring end users on the system.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们登录到启用SELinux的系统时，我们会收到一个SELinux上下文来工作。这个上下文包含了一个SELinux用户、一个SELinux角色、一个域，并且可选地包含一个敏感性范围。由于SELinux用户定义了可以访问的角色和类型，因此管理用户登录和SELinux用户是系统中配置终端用户的第一步。
- en: To enable properly configured users, we will learn to define users that have
    sufficient rights to do their jobs, ranging from regular users with strict SELinux
    protections to fully privileged administrative users with few SELinux protections.
    We will create and assign categories and sensitivities, as well as assign roles
    to users and use various tools to switch roles. At the end of the chapter, we
    will see how SELinux integrates with the Linux authentication process.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 为了启用正确配置的用户，我们将学习定义具有足够权限执行其工作职责的用户，从具有严格SELinux保护的普通用户到具有少量SELinux保护的完全特权的管理员用户。我们将创建并分配类别和敏感性，同时为用户分配角色，并使用各种工具切换角色。在本章的最后，我们将看到SELinux如何与Linux认证过程集成。
- en: 'In this chapter, we''re going to cover the following main topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将讨论以下主要内容：
- en: User-oriented SELinux contexts
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 面向用户的SELinux上下文
- en: SELinux users and roles
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SELinux用户和角色
- en: Handling SELinux roles
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 处理SELinux角色
- en: SELinux and PAM
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SELinux与PAM
- en: Technical requirements
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'Check out the following video to see the Code in Action: [https://bit.ly/3jbASmr](https://bit.ly/3jbASmr)'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 查看以下视频，观看代码实际操作：[https://bit.ly/3jbASmr](https://bit.ly/3jbASmr)
- en: User-oriented SELinux contexts
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 面向用户的SELinux上下文
- en: 'Once logged in to a system, our user will run inside a certain context. This
    user context defines the rights and privileges that we, as a user, have on the
    system. The command to obtain current user information, `id`, also supports displaying
    the current SELinux context information:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦登录到系统，我们的用户将在某个特定上下文中运行。此用户上下文定义了我们作为用户在系统上的权限和特权。获取当前用户信息的命令`id`，也支持显示当前的SELinux上下文信息：
- en: '[PRE0]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: On SELinux systems with a targeted policy type, chances are very high that all
    users are logged in as `unconfined_u` (the first part of the context). On more
    restricted systems, the user can be `user_u` (regular restricted users), `staff_u`
    (operators), `sysadm_u` (system administrators), or any of the other SELinux users.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在具有目标策略类型的SELinux系统上，所有用户的登录上下文通常都是`unconfined_u`（上下文的第一部分）。在更为受限的系统中，用户可以是`user_u`（普通受限用户）、`staff_u`（操作员）、`sysadm_u`（系统管理员）或其他任何SELinux用户。
- en: The SELinux user defines the roles that the user can switch to. SELinux roles
    themselves define the application domains that the user can use. By default, a
    fixed number of SELinux users are available on the system, but administrators
    can create additional SELinux users. It is also the administrator's task to assign
    Linux logins to SELinux users.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: SELinux用户定义了用户可以切换到的角色。SELinux角色本身定义了用户可以使用的应用域。默认情况下，系统上提供固定数量的SELinux用户，但管理员可以创建额外的SELinux用户。管理员的任务还包括将Linux登录名分配给SELinux用户。
- en: SELinux roles, on the other hand, cannot be created through administrative commands,
    as SELinux roles are part of the SELinux policy. For this, the SELinux policy
    needs to be enhanced with additional rules that create the role. We will touch
    upon that in [*Chapter 15*](B16276_15_Final_VK.xhtml#_idTextAnchor373), *Using
    the Reference Policy*.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，SELinux角色不能通过管理员命令创建，因为SELinux角色是SELinux策略的一部分。为此，SELinux策略需要通过额外的规则进行扩展，以创建角色。我们将在[*第15章*](B16276_15_Final_VK.xhtml#_idTextAnchor373)中讨论这个内容，*使用参考策略*。
- en: 'To view the currently available roles, use `seinfo`:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看当前可用的角色，请使用`seinfo`：
- en: '[PRE1]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: SELinux roles can be coarse-grained (such as `sysadm_r`) or more functionality-oriented
    (such as `dbadm_r`). Custom SELinux roles can even be very fine-grained, only
    granting the ability to transition into limited domains.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: SELinux角色可以是粗粒度的（如`sysadm_r`）或更具功能导向的（如`dbadm_r`）。自定义的SELinux角色甚至可以非常细粒度，仅授予切换到受限领域的能力。
- en: Let's see how to create and manage SELinux users.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看如何创建和管理SELinux用户。
- en: SELinux users and roles
  id: totrans-20
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: SELinux用户和角色
- en: In SELinux-enabled environments, the login binary calls the `libselinux` API
    to establish the initial mapping between SELinux users and local users. Then,
    after finding the right SELinux user, the system looks up the role and domain
    that the user should be in and sets that as the user's context.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在启用SELinux的环境中，登录二进制文件调用`libselinux` API来建立SELinux用户和本地用户之间的初始映射。然后，在找到正确的SELinux用户后，系统查找该用户应属于的角色和域，并将其设置为用户的上下文。
- en: Listing SELinux user mappings
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出SELinux用户映射
- en: When logged in to the system, we can use `id -Z` to obtain the current SELinux
    context. For many users, this context will be defined by the unconfined user (`unconfined_u`),
    regardless of their username. If not that, it will generally be a context based
    on one of `sysadm_u`, `staff_u`, or `user_u`. This is because most Linux distributions
    will only provide a limited set of SELinux users by default, aligned with the
    SELinux roles that they support.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 登录系统后，我们可以使用`id -Z`来获取当前的SELinux上下文。对于许多用户而言，无论用户名是什么，该上下文将由未受限制的用户（`unconfined_u`）定义。如果不是这样，它通常是基于`sysadm_u`、`staff_u`或`user_u`中的一个上下文。这是因为大多数Linux发行版默认仅提供有限的一组SELinux用户，与它们支持的SELinux角色对齐。
- en: 'During login, the service process through which the login is handled will check
    a local definition file to find the appropriate mapping between the Linux account
    and the SELinux user. Let''s look at the existing login mappings using `semanage
    login -l`. The following output is the default output on a CentOS system:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 在登录过程中，处理登录的服务进程将检查本地定义文件，以查找Linux账户与SELinux用户之间的适当映射。让我们通过`semanage login -l`查看现有的登录映射。以下输出是CentOS系统的默认输出：
- en: '[PRE2]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'The output of the command shows one login mapping per line. Each mapping consists
    of the following:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 命令的输出显示每行一个登录映射。每个映射包含以下内容：
- en: The `Login Name` for which the mapping is applicable (that is, the username)
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Login Name`适用的映射（即用户名）'
- en: The `SELinux User` to which the login is mapped
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 映射到的`SELinux用户`
- en: The `MLS/MCS Range` to which the login is mapped
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 登录映射到的`MLS/MCS范围`
- en: The `Service` for which the mapping applies (this is used for local customizations,
    which we will tackle in the *Customizing logins for services* section)
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 映射适用的`Service`（用于本地定制，我们将在*自定义服务登录*部分中讨论）
- en: 'The login name can contain a few special values that do not map directly to
    a single Linux account:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 登录名可以包含一些特殊值，这些值不会直接映射到单一的Linux账户：
- en: '`__default__` is a catch-all rule. If none of the other rules match, then the
    users are mapped to the SELinux user identified through this line. In the given
    example, all users are mapped to the `unconfined_u` SELinux user, meaning regular
    Linux users are hardly confined in their actions. When this isn''t meant to happen,
    administrators usually map regular logins to restricted SELinux users, while administrative
    logins are mapped to the `staff_u` or `sysadm_u` SELinux users.'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`__default__`是一个通配规则。如果其他规则都不匹配，则用户将映射到此行标识的SELinux用户。在给定的示例中，所有用户都映射到`unconfined_u`
    SELinux用户，这意味着普通的Linux用户几乎不受任何限制。当这不是预期的行为时，管理员通常会将普通登录映射到受限的SELinux用户，而将管理员登录映射到`staff_u`或`sysadm_u`
    SELinux用户。'
- en: Login names starting with `%` will map to groups. This allows administrators
    to map a group of people directly to an SELinux user rather than having to manage
    the mappings individually.
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以`%`开头的登录名将映射到组。这允许管理员将一组人员直接映射到SELinux用户，而不必单独管理每个映射。
- en: When both an individual user mapping and group mapping match, then the individual
    user mapping takes precedence. When multiple group definitions exist, then SELinux
    will use the first matching group mapping (in the order listed in the underlying
    `seusers` configuration file).
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 当个人用户映射和组映射都匹配时，个人用户映射优先。存在多个组定义时，SELinux将使用第一个匹配的组映射（按基础`seusers`配置文件中列出的顺序）。
- en: Important note
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: System processes (non-interactively logged-in Linux accounts) are mapped to
    the `system_u` SELinux user. This SELinux user should never be assigned to end
    user logins.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 系统进程（非交互式登录的Linux账户）被映射到`system_u` SELinux用户。这个SELinux用户永远不应分配给最终用户的登录。
- en: In the case of an MLS- or MCS-enabled system, the mapping contains information
    about the user's allowed sensitivity range (MLS/MCS range). This way, we can map
    multiple users to the same restricted SELinux user, while differentiating between
    these users through the allowed sensitivities. For instance, one user might only
    be allowed to access low-sensitivity areas (`s0`), whereas another user might
    also have access to higher sensitivities (for example, `s1`) or different categories.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在启用了MLS或MCS的系统中，映射包含有关用户允许的敏感度范围（MLS/MCS范围）的信息。通过这种方式，我们可以将多个用户映射到相同的受限SELinux用户，同时通过允许的敏感度区分这些用户。例如，一个用户可能只允许访问低敏感度区域（`s0`），而另一个用户则可能还可以访问更高的敏感度（例如，`s1`）或不同的类别。
- en: Mapping logins to SELinux users
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将登录映射到SELinux用户
- en: Let's use a few examples to show how we make these mappings work. For more intricate
    details on this, see the *SELinux and PAM* section. We'll assume we have a Linux
    user called `lisa`, and we want her account to be mapped to the `staff_u` SELinux
    user, whereas all other users in the `users` group are mapped to the `user_u`
    SELinux user.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过几个示例来展示如何使这些映射工作。有关更复杂的细节，请参阅*SELinux和PAM*部分。我们假设有一个名为`lisa`的Linux用户，并且我们希望她的账户映射到`staff_u`
    SELinux用户，而所有其他属于`users`组的用户都映射到`user_u` SELinux用户。
- en: 'We can accomplish this through the `semanage login` command, using the `-a`
    (add) option:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过`semanage login`命令来完成这一操作，使用`-a`（添加）选项：
- en: '[PRE3]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'The `-s` parameter assigns the SELinux user to the given login, whereas the
    `-r` parameter handles the sensitivity (and categories) for that user. For instance,
    let''s modify (using `-m` instead of `-a`) the recently created group-based definition
    by mapping to the `staff_u` user instead, and limiting these users to the `s0-s0`
    sensitivity range and categories `c0` to `c4`:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '`-s`参数将SELinux用户分配给给定的登录，而`-r`参数则处理该用户的敏感度（和类别）。例如，让我们使用`-m`（而不是`-a`）修改最近创建的基于组的定义，将其映射到`staff_u`用户，并限制这些用户的敏感度范围为`s0-s0`，类别为`c0`到`c4`：'
- en: '[PRE4]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The sensitivity range of a login mapping may not exceed the range assigned to
    the SELinux user. For example, if the `staff_u` SELinux user itself is only granted
    access to `s0-s0:c0.c3`, then the previous command will fail as it is trying to
    assign a broader access range. We'll discuss how to define SELinux users and their
    range in the *Creating SELinux users* section.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 登录映射的敏感度范围不能超过分配给SELinux用户的范围。例如，如果`staff_u` SELinux用户仅被授予`s0-s0:c0.c3`的访问权限，则之前的命令将失败，因为它试图分配一个更广泛的访问范围。我们将在*创建SELinux用户*部分讨论如何定义SELinux用户及其范围。
- en: The `semanage login` command updates the `seusers` file located inside `/etc/selinux/targeted`.
    If multiple group mappings are defined, then the order of mappings within this
    file defines which mapping applies to a given user. Users that belong to multiple
    mapped groups will be assigned an SELinux user based on the first match.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: '`semanage login`命令更新位于`/etc/selinux/targeted`中的`seusers`文件。如果定义了多个组映射，则该文件中映射的顺序决定了哪个映射适用于给定用户。属于多个映射组的用户将根据第一个匹配的映射分配SELinux用户。'
- en: 'While it is possible to update the order of the entries in the `seusers` file,
    this is not recommended. Every time `semanage login` modifies the `seusers` file,
    it will reorder the mappings. Instead, when a user belongs to multiple mapped
    groups, we advise you to create an individual (user-based) mapping. This is also
    shown whenever we create a group mapping for a group that contains users for which
    active mappings already exist:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然可以更新`seusers`文件中条目的顺序，但不建议这样做。每次`semanage login`修改`seusers`文件时，它都会重新排序映射。相反，当用户属于多个映射组时，我们建议您创建一个单独的（基于用户的）映射。当我们为包含已有活动映射的用户的组创建组映射时，这也会显示出来：
- en: '[PRE5]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The changes take effect when a new login occurs, so we should force a logout
    for these users. The following command kills all the processes of the `lisa` user,
    forcing a logout for that user:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 更改在新登录时生效，因此我们应强制注销这些用户。以下命令会终止`lisa`用户的所有进程，强制该用户注销：
- en: '[PRE6]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Also, when we modify a user''s settings, we should also reset the contexts
    of that user''s home directory (while that user is not logged in). To accomplish
    this, use `restorecon` as follows:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，当我们修改用户设置时，还应重置该用户主目录的上下文（在该用户未登录时）。为此，请使用`restorecon`，如下所示：
- en: '[PRE7]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: The `-F` option in the preceding command forces a reset, while `-R` does this
    recursively.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 上述命令中的`-F`选项会强制重置，而`-R`则会递归地执行此操作。
- en: Important note
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 重要说明
- en: Running the `restorecon -RF` command will also reset file contexts that the
    user has manually set using tools such as `chcon`. We recommend defining SELinux
    user mappings up front, or recursively changing only the SELinux user of the files
    using `chcon -R -u`. The `chcon` application and file contexts are discussed in
    the next chapter.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 运行 `restorecon -RF` 命令也会重置用户通过 `chcon` 等工具手动设置的文件上下文。我们建议事先定义 SELinux 用户映射，或者仅通过
    `chcon -R -u` 递归地更改文件的 SELinux 用户。`chcon` 应用程序和文件上下文将在下一章中讨论。
- en: 'To remove a login mapping, use the `-d` (delete) option. Don''t forget to run
    the `restorecon` command afterward:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 要删除登录映射，使用 `-d`（删除）选项。别忘了在之后运行 `restorecon` 命令：
- en: '[PRE8]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Don't forget to force a user logout again if this user is active on the system.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 如果该用户在系统中处于活动状态，别忘了强制用户注销。
- en: Customizing logins for services
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为服务自定义登录
- en: When login mappings are added using `semanage login`, they apply to all services.
    There is no option in `semanage` to allow customizing the mappings based on the
    service. However, that does not mean it is not possible.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 当通过 `semanage login` 添加登录映射时，它们适用于所有服务。`semanage` 中没有选项可以根据服务自定义映射。然而，这并不意味着不可能实现。
- en: 'The SELinux user space tools and libraries will consult the following two configuration
    files to know what the mappings are:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: SELinux 用户空间工具和库将查阅以下两个配置文件，以了解映射是什么：
- en: The `/etc/selinux/targeted/seusers` file contains the standard, service-agnostic
    mappings. This file is managed by `semanage login` and should not be updated through
    any other means.
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`/etc/selinux/targeted/seusers` 文件包含标准的、与服务无关的映射。该文件由 `semanage login` 管理，不应通过其他方式更新。'
- en: The `/etc/selinux/targeted/logins` directory contains customized mappings, one
    file per Linux account. So, the custom mapping for the root user will be in `/etc/selinux/targeted/logins/root`.
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`/etc/selinux/targeted/logins` 目录包含自定义映射，每个文件对应一个 Linux 账户。因此，root 用户的自定义映射将位于
    `/etc/selinux/targeted/logins/root`。'
- en: Inside the files for customized mappings, administrators can define, per service,
    a different SELinux user to map to. The services are the **Pluggable Authentication
    Modules** (**PAM**) services through which a user can log in, and more information
    on this can be found in the *SELinux and PAM* section.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 在自定义映射的文件中，管理员可以为每个服务定义一个不同的 SELinux 用户进行映射。这些服务是用户可以登录的 **可插拔认证模块** (**PAM**)
    服务，更多信息可以在 *SELinux 和 PAM* 部分找到。
- en: 'For instance, to have the `root` user – when logged in through SSH – be mapped
    to the `user_u` SELinux user rather than their default `unconfined_u` user, the
    `root` file would need to contain the following:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，要使 `root` 用户在通过 SSH 登录时映射到 `user_u` SELinux 用户，而不是默认的 `unconfined_u` 用户，需要在
    `root` 文件中包含以下内容：
- en: '[PRE9]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'When querying the current mapping, `semanage login` will show this customization
    as follows:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 查询当前映射时，`semanage login` 将显示如下自定义内容：
- en: '[PRE10]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Of course, this customization does not need to be so drastic. It can also be
    used to limit the user''s default MLS/MCS range. For instance, to limit the categories
    to `c0.c8` (rather than the default `c0.c1023` range) you would use the following:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，这种自定义不需要如此剧烈。它也可以用来限制用户的默认 MLS/MCS 范围。例如，要将类别限制为 `c0.c8`（而不是默认的 `c0.c1023`
    范围），可以使用以下命令：
- en: '[PRE11]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Such customizations allow us to flexibly change the access control policies
    based on the PAM service used.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 这样的自定义允许我们根据所使用的 PAM 服务灵活地更改访问控制策略。
- en: Creating SELinux users
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建 SELinux 用户
- en: By default, only a small number of SELinux users are available for mapping to
    logins. If we want more control over the Linux accounts and their mappings, we
    need to create additional SELinux users.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，只有少数 SELinux 用户可以映射到登录。如果我们希望对 Linux 账户及其映射进行更多控制，就需要创建额外的 SELinux 用户。
- en: 'First, list the currently known SELinux users using the `semanage user -l`
    command, as follows:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，使用 `semanage user -l` 命令列出当前已知的 SELinux 用户，如下所示：
- en: '[PRE12]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Next, create a new SELinux user with `semanage user`, using the `-a` (add)
    option. We need to give SELinux additional information about this SELinux user,
    such as the following:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，使用 `semanage user` 创建一个新的 SELinux 用户，使用 `-a`（添加）选项。我们需要为 SELinux 提供有关此 SELinux
    用户的附加信息，例如以下内容：
- en: The default sensitivity (using the `-L` option) for the SELinux user. This is
    the sensitivity that the user starts with.
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SELinux 用户的默认敏感度（使用 `-L` 选项）。这是用户开始时的敏感度。
- en: The security clearance (using the `-r` option) applicable to the SELinux user.
    This range cannot be extended when defining login mappings. It is, however, possible
    to give a user a more limited range, as long as it is bounded by the current range.
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SELinux 用户适用的安全权限（使用 `-r` 选项）。在定义登录映射时，无法扩展此范围。然而，可以为用户提供更有限的范围，只要它在当前范围内即可。
- en: The allowed role or roles (using the `-R` option) for the SELinux user.
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许的角色或角色组（使用 `-R` 选项）适用于 SELinux 用户。
- en: Tip
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 提示
- en: The labeling prefix shown in the previous example is used to dynamically create
    SELinux policies with specific prefixes, such as `<prefix>_home_t` for user's
    home files. Most distributions leave this to the default *user* setting, and changing
    it is done through the (undocumented) `-P` parameter to `semanage user`.
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 前面示例中显示的标签前缀用于动态创建具有特定前缀的 SELinux 策略，例如 `<prefix>_home_t` 用于用户的主文件。大多数发行版将其留给默认的
    *user* 设置，若要更改，则通过（未记录的）`-P` 参数来执行 `semanage user`。
- en: 'In the following example, we''re configuring the SELinux user `finance_u`:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 在下面的示例中，我们正在配置 SELinux 用户 `finance_u`：
- en: '[PRE13]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: When the command creates the SELinux user, its information becomes part of the
    SELinux policy. From this point onward, administrators can map Linux accounts
    to this SELinux user.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 当命令创建 SELinux 用户时，其信息将成为 SELinux 策略的一部分。从此时起，管理员可以将 Linux 账户映射到该 SELinux 用户。
- en: Important note
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: SELinux roles are enabled through the SELinux user that a Linux account is mapped
    to. When an administrator wants to allow additional existing roles to a Linux
    account, the administrator either updates existing SELinux mappings to include
    the new role(s) or creates a new SELinux user that has access to the new role(s)
    and then maps this SELinux user to the Linux account.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: SELinux 角色是通过映射到 Linux 账户的 SELinux 用户来启用的。当管理员希望允许将额外的现有角色添加到 Linux 账户时，管理员可以更新现有的
    SELinux 映射以包含新角色，或者创建一个具有新角色访问权限的 SELinux 用户，然后将该 SELinux 用户映射到 Linux 账户。
- en: 'Just like with login mappings, `semanage user` also accepts the `-m` option
    to modify an existing entry, or `-d` to delete one. For instance, the following
    command deletes the `finance_u` SELinux user:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 与登录映射类似，`semanage user` 还接受 `-m` 选项来修改现有条目，或使用 `-d` 来删除条目。例如，以下命令删除 `finance_u`
    SELinux 用户：
- en: '[PRE14]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Separate SELinux users enhance the audit information since SELinux users generally
    do not change during a user's session, whereas the effective Linux user ID can.
    If the user creates files or other resources, these resources also inherit the
    SELinux user part in their security context.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 单独的 SELinux 用户有助于增强审计信息，因为 SELinux 用户在用户会话期间通常不会发生变化，而有效的 Linux 用户 ID 则可能会发生变化。如果用户创建文件或其他资源，这些资源也会在其安全上下文中继承
    SELinux 用户部分。
- en: Listing accessible domains
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出可访问的域
- en: 'When creating SELinux users, one of the parameters that needs to be provided
    is the role or roles for an SELinux user. Most of the roles are self-explanatory:
    the `dbadm_r` role is for DBAs, whereas the `webadm_r` role is for web application
    infrastructure administrators. If a role is not clear, or an administrator is
    not certain which accesses are part of a given role, the administrator can still
    query the SELinux policy for more information.'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建 SELinux 用户时，需要提供的参数之一是 SELinux 用户的角色或角色组。大多数角色是显而易见的：`dbadm_r` 角色适用于数据库管理员，而
    `webadm_r` 角色适用于 Web 应用程序基础设施管理员。如果某个角色不明确，或者管理员不确定某个角色包含哪些访问权限，管理员仍然可以查询 SELinux
    策略以获取更多信息。
- en: Informational note
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 信息提示
- en: This book will mostly focus on the command-line utilities used to query and
    interact with the active SELinux policy. In [*Chapter 13*](B16276_13_Final_VK.xhtml#_idTextAnchor330),
    *Analyzing Policy Behavior*, we will also cover the graphical utility `apol`.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 本书将主要关注用于查询和交互式操作活动 SELinux 策略的命令行工具。在[*第 13 章*](B16276_13_Final_VK.xhtml#_idTextAnchor330)《分析策略行为》中，我们还将介绍图形化工具
    `apol`。
- en: 'As documented earlier, roles define which domains are accessible for the users
    associated with the role. We saw that `seinfo` can show us the available roles,
    but it can do more. It can list the domains accessible for a role as well, using
    the `-x` option:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，角色定义了与该角色关联的用户可以访问的域。我们看到 `seinfo` 可以显示可用的角色，但它还可以做更多事情。它还可以列出某个角色可访问的域，使用
    `-x` 选项：
- en: '[PRE15]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: In this example, users running with the `dbadm_r` role as part of their security
    context will be able to transition to, for instance, the `qmail_inject_t` (the
    domain used to read email messages and pass those on to the `qmail` queue) and
    `user_mail_t` (the domain used for generic email-sending command-line applications)
    domains.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，运行`dbadm_r`角色作为其安全上下文的一部分的用户将能够过渡到例如`qmail_inject_t`（用于读取电子邮件消息并将其传递到`qmail`队列的域）和`user_mail_t`（用于通用电子邮件发送命令行应用程序的域）域。
- en: The information provided through the **dominated roles** is usually not of concern
    to the administrators. Role dominance, although supported in SELinux core, is
    not used by Linux distribution policies. It signifies the inheritance of (other)
    roles, but it will always just show the queried role.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 通过**主导角色**提供的信息通常不会引起管理员的关注。角色继承虽然在SELinux核心中得到了支持，但在Linux发行版的策略中并未使用。它意味着（其他）角色的继承，但它始终只会显示查询的角色。
- en: Managing categories
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 管理类别
- en: Sensitivity labels and their associated categories are identified through numeric
    values, which is great for computers but not that obvious for users. Luckily,
    the SELinux utilities support translating the levels and categories to human-readable
    values, even though they are still stored as numbers. As a result, almost all
    tools that can show contexts will show them translated rather than presented as
    numerical values.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 敏感度标签及其关联的类别通过数字值进行标识，这对计算机来说非常方便，但对用户来说却不那么直观。幸运的是，SELinux工具支持将这些级别和类别翻译成人类可读的值，尽管它们仍然以数字形式存储。因此，几乎所有能够显示上下文的工具都会显示翻译后的内容，而不是以数字值呈现。
- en: The translations are managed through the `setrans.conf` file, located in `/etc/selinux/targeted`.
    Inside this file, we can name specific values (for example, `s0:c102`) or ranges
    (such as `s0-s0:c1.c127`) with a string that is much easier for administrators
    to use. However, for translations to be performed, **mcstransd** – the MCS translation
    daemon – needs to be running.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 翻译通过`setrans.conf`文件进行管理，该文件位于`/etc/selinux/targeted`。在这个文件中，我们可以用更易于管理员使用的字符串来命名特定的值（例如，`s0:c102`）或范围（如`s0-s0:c1.c127`）。但是，为了进行翻译，**mcstransd**——MCS翻译守护进程——需要保持运行。
- en: 'Consider our example of the `finance_u` SELinux user who was allowed access
    to the `c0.c127` category range. Two of the categories within that range are `c102`,
    which we will tag as `Contracts`, and `c103`, which we will tag as `Salaries`.
    The `c1.c127` range will be labeled as `FinanceData`. The following diagram shows
    the relationship between these various categories:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑我们的例子，`finance_u` SELinux用户被允许访问`c0.c127`类别范围。该范围内的两个类别是`c102`，我们将其标记为`Contracts`，以及`c103`，我们将其标记为`Salaries`。`c1.c127`范围将被标记为`FinanceData`。下图展示了这些不同类别之间的关系：
- en: '![Figure 3.1 – Relationship of the example categories and category range ](img/B16276_03_001.jpg)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.1 – 示例类别和类别范围的关系](img/B16276_03_001.jpg)'
- en: Figure 3.1 – Relationship of the example categories and category range
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.1 – 示例类别和类别范围的关系
- en: 'To accomplish this, the following should be placed in the `setrans.conf` file:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 为了实现这一点，应该在`setrans.conf`文件中添加以下内容：
- en: '[PRE16]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: After editing the `setrans.conf` file, the `mcstransd` application needs to
    be restarted.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 编辑完`setrans.conf`文件后，需要重新启动`mcstransd`应用程序。
- en: These translations are handled by the SELinux utilities, which connect to the
    `mcstransd` daemon through the `.setrans-unix` socket located in `/var/run/setrans`
    to query the `setrans.conf` file. If the daemon is not running or the communication
    with the daemon fails, the numeric sensitivity and category values are displayed.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 这些翻译由SELinux工具处理，工具通过位于`/var/run/setrans`的`.setrans-unix`套接字连接到`mcstransd`守护进程，从而查询`setrans.conf`文件。如果守护进程未运行或与守护进程的通信失败，将显示数字敏感度和类别值。
- en: 'For instance, with the daemon running, the output of `id -Z` is now as follows:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，在守护进程运行时，`id -Z`的输出现在如下所示：
- en: '[PRE17]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'We can view the available sensitivities and their human-readable counterparts
    using the `chcat` tool. The following example displays the translations after
    adding the finance-related ones:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用`chcat`工具查看可用的敏感度及其对应的人类可读值。以下示例展示了添加与金融相关的翻译后的结果：
- en: '[PRE18]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'The same `chcat` utility can be used to assign categories to users. For instance,
    to grant the `Salaries` category to the `lisa` Linux user, we''d use the following
    command:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 相同的`chcat`工具也可以用来为用户分配类别。例如，要为`lisa` Linux用户授予`Salaries`类别，我们可以使用以下命令：
- en: '[PRE19]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The previous command grants the `Salaries` category (`c103`) to the Linux user
    `lisa`. The user mapping is immediately updated with this information. Again,
    we need to make sure that the `lisa` user is logged out for the changes to take
    effect.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 上述命令为 Linux 用户`lisa`授予了`Salaries`类别（`c103`）。用户映射立即更新了这一信息。同样，我们需要确保`lisa`用户已经退出，以便更改生效。
- en: With this, we end our section on managing SELinux users and logins. We've learned
    how to align users with SELinux users so that they log in to the system with the
    correct context. In the next section, we will look at the SELinux roles and how
    to apply those to SELinux users.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这一点，我们结束了关于管理 SELinux 用户和登录的章节。我们已经学习了如何将用户与 SELinux 用户对齐，以便他们可以使用正确的上下文登录系统。在下一章节中，我们将介绍
    SELinux 角色以及如何将这些角色应用到 SELinux 用户上。
- en: Handling SELinux roles
  id: totrans-115
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 处理 SELinux 角色
- en: We saw how SELinux users define the role(s) that a user can hold. But how does
    SELinux enforce which role a user logs in through? And when logged in, how can
    a user switch their active role?
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经看到 SELinux 用户定义了一个用户可以拥有的角色。但是 SELinux 是如何强制执行用户通过哪个角色登录的呢？而且当用户登录后，如何切换他们的活动角色？
- en: Defining allowed SELinux contexts
  id: totrans-117
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 定义允许的 SELinux 上下文
- en: To select the context assigned to a successfully authenticated user, SELinux
    introduces the notion of a default context. Based on the context of the service
    through which a user logs in (or through which the user executes commands), the
    system selects the right user context.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 为了选择成功认证的用户分配的上下文，SELinux 引入了默认上下文的概念。根据用户登录时的服务上下文（或用户执行命令时的服务上下文），系统会选择正确的用户上下文。
- en: Inside the `/etc/selinux/targeted/contexts` directory, a file called `default_contexts`
    exists. Each line in this file starts with the SELinux context information of
    the parent process and is then followed by an ordered list of all the contexts
    that could be picked based on the user's allowed SELinux role(s).
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在`/etc/selinux/targeted/contexts`目录下，存在一个名为`default_contexts`的文件。文件中的每一行以父进程的
    SELinux 上下文信息开始，接着是一个有序列表，列出了基于用户允许的 SELinux 角色可以选择的所有上下文。
- en: 'Consider the following line of code for the `sshd_t` context:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下`sshd_t`上下文的代码行：
- en: '[PRE20]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: This line of code mentions that when a user logs in through a process running
    in the `sshd_t` domain, the listed roles are checked against the roles of the
    user. The user will transition to the first context listed that matches the roles
    the user can use.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 这行代码提到，当一个用户通过在`sshd_t`域中运行的进程登录时，所列出的角色会与该用户的角色进行匹配。用户将过渡到第一个匹配其可以使用的角色的上下文。
- en: For instance, assume we are mapped to an SELinux user that has access to both
    the `staff_r` and `sysadm_r` roles. In that case, we will log in as `staff_r:staff_t`
    since that is the first match.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设我们映射到一个 SELinux 用户，该用户可以访问`staff_r`和`sysadm_r`两个角色。在这种情况下，我们将作为`staff_r:staff_t`登录，因为这是第一个匹配的角色。
- en: However, like the `seusers` file for the Linux account mappings, the `default_contexts`
    file is a default file that can be overruled through specific customizations.
    These customizations are stored in the `/etc/selinux/targeted/contexts/users`
    subdirectory. These files are named after the SELinux user for which they take
    effect. This allows us to assign different contexts for particular SELinux users
    even if they share the same roles with other SELinux users. Because SELinux checks
    the entries per line, we do not need to copy the entire content of the `default_contexts`
    file. Only the configuration lines that we want to see a different configuration
    for need to be listed; SELinux will automatically use the `default_contexts` file
    for the rest.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，就像用于 Linux 账户映射的`seusers`文件一样，`default_contexts`文件是一个默认文件，可以通过特定的自定义设置进行覆盖。这些自定义设置存储在`/etc/selinux/targeted/contexts/users`子目录中。这些文件以
    SELinux 用户的名称命名，并且只有针对该用户有效。这使得我们能够为特定的 SELinux 用户分配不同的上下文，即使他们与其他 SELinux 用户共享相同的角色。由于
    SELinux 会逐行检查条目，我们不需要复制整个`default_contexts`文件的内容。只需列出我们希望看到不同配置的配置行；SELinux 会自动使用其余部分的`default_contexts`文件。
- en: 'Let''s modify the default contexts so that the `staff_u` SELinux user logs
    in with the `sysadm_r` role (and with the `sysadm_t` type) when logged in through
    SSH. To do so, use the `sshd_t` line, modify it, and save the result as `/etc/selinux/targeted/contexts/users/staff_u`:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们修改默认上下文，以便`staff_u` SELinux 用户在通过 SSH 登录时，能够以`sysadm_r`角色（并使用`sysadm_t`类型）登录。为此，使用`sshd_t`行，修改它，并将结果保存为`/etc/selinux/targeted/contexts/users/staff_u`：
- en: '[PRE21]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Specifically, for the SSH daemon, we also need to enable the `ssh_sysadm_login`
    boolean, which is a special precaution SELinux policy developers have made to
    prevent users from immediately logging in with highly privileged accounts:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 特别地，对于SSH守护进程，我们还需要启用`ssh_sysadm_login`布尔值，这是SELinux策略开发者为防止用户立即使用高权限账户登录所做的特别防范措施：
- en: '[PRE22]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: With these settings in place, we've set `sysadm_r:sysadm_t:s0` as the only possible
    context, ensuring that the target context is `staff_u:sysadm_r:sysadm_t`.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在这些设置下，我们已将`sysadm_r:sysadm_t:s0`设置为唯一可能的上下文，确保目标上下文为`staff_u:sysadm_r:sysadm_t`。
- en: Validating contexts with getseuser
  id: totrans-130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用getseuser验证上下文
- en: 'To validate whether our change succeeded, we can ask SELinux what the result
    of a context choice will be without having to parse the files ourselves. We can
    accomplish this through the `getseuser` command, which takes two arguments: the
    Linux user account and the context of the process that switches the user context.'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 为了验证我们的更改是否成功，我们可以询问SELinux该上下文选择的结果，而无需自己解析文件。我们可以通过`getseuser`命令实现这一点，该命令接受两个参数：Linux用户账户和切换用户上下文的进程的上下文。
- en: Important note
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: The `getseuser` command is a helper utility offered by the SELinux user space
    project, but is not made available on all distributions. You will find it on Debian
    and Gentoo, but not on CentOS or other Red Hat Enterprise Linux-derived distributions.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: '`getseuser`命令是由SELinux用户空间项目提供的辅助工具，但并非所有发行版都提供此工具。你可以在Debian和Gentoo上找到它，但在CentOS或其他Red
    Hat Enterprise Linux衍生发行版上找不到。'
- en: 'Here''s an example that checks what the context would be for the `sven` user
    when they log in through a process running in the `sshd_t` domain:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是一个示例，检查当`sshd_t`域中运行的进程登录时，`sven`用户的上下文会是什么：
- en: '[PRE23]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: One of the advantages of the `getseuser` command is that it asks the SELinux
    code what the context should be, which not only looks through the `default_contexts`
    and customized files, but also checks whether the target context can be reached
    or not, and that there are no other constraints that prohibit the change to this
    context.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: '`getseuser`命令的一个优点是，它询问SELinux代码上下文应该是什么，这不仅查看`default_contexts`和自定义文件，还检查目标上下文是否可以访问，并且没有其他限制阻止切换到此上下文。'
- en: Switching roles with newrole
  id: totrans-137
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用新角色切换角色
- en: After having successfully authenticated and logged in, users will be assigned
    the context through the configuration mentioned in the *SELinux users and roles*
    section. If the SELinux user has access to multiple roles, however, then the Linux
    user can use the `newrole` application to transition from one role to another.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 用户在成功认证并登录后，将通过*SELinux用户和角色*部分中提到的配置分配上下文。然而，如果SELinux用户可以访问多个角色，则Linux用户可以使用`newrole`应用程序从一个角色切换到另一个角色。
- en: 'Consider an SELinux system without unconfined domains and where we are, by
    default, logged in as the `staff_r` role. To perform administrative tasks, we
    need to switch to the `sysadm_r` administrative role, which we can do with the
    `newrole` command. This command only works when working through a secure terminal
    listed in `/etc/securetty`:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑一个没有未限制域的SELinux系统，并且我们默认以`staff_r`角色登录。为了执行管理任务，我们需要切换到`sysadm_r`管理角色，可以通过`newrole`命令完成。此命令仅在通过`/etc/securetty`列出的安全终端工作时有效：
- en: '[PRE24]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Notice how the SELinux user remains constant but the role and domain have changed.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 注意SELinux用户保持不变，但角色和域已经发生了变化。
- en: 'The `newrole` command can also be used to transition to a specific sensitivity,
    as follows:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '`newrole`命令也可以用于切换到特定的敏感度，示例如下：'
- en: '[PRE25]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: When we *switch* to another role or sensitivity, what we actually do is create
    a new session (with a new shell) that has this new role or sensitivity. The command
    does not change the context of the current session, nor does it exit from the
    current session.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们*切换*到另一个角色或敏感度时，我们实际上是创建了一个具有新角色或敏感度的新会话（新shell）。该命令不会改变当前会话的上下文，也不会退出当前会话。
- en: We can return from our assigned role and go back to the first session by exiting
    (through `exit`, `logout`, or *Ctrl* + *D*).
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过退出（使用`exit`、`logout`或*Ctrl* + *D*）返回到我们分配的角色并回到第一个会话。
- en: Managing role access through sudo
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 通过sudo管理角色访问
- en: 'Most administrators use `sudo` for privilege delegation: allowing users to
    run certain commands in a more privileged context than the user is otherwise allowed.
    The `sudo` application is also capable of switching SELinux roles and types.'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数管理员使用`sudo`进行特权委派：允许用户在比平常更高的权限上下文中运行某些命令。`sudo`应用还能够切换 SELinux 角色和类型。
- en: 'We can pass the target role and type to `sudo` directly. For instance, we can
    tell `sudo` to switch to the administrative role when we edit a PostgreSQL configuration
    file:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以直接将目标角色和类型传递给`sudo`。例如，当我们编辑 PostgreSQL 配置文件时，我们可以告诉`sudo`切换到管理角色：
- en: '[PRE26]'
  id: totrans-149
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'However, we can also configure `sudo` through the `/etc/sudoers` file to allow
    users to run commands within a certain role and/or type, or get a shell within
    a certain context. Consider a user that has access to both the `user_r` and `dbadm_r`
    roles (with the `dbadm_r` role being a role designated for database administrators).
    Within the `sudoers` file, the following line allows the `myuser` user to run
    any command through `sudo,` which, when triggered, will run with the `dbadm_r`
    role and within the `dbadm_t` domain:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，我们也可以通过`/etc/sudoers`文件配置`sudo`，允许用户在特定角色和/或类型下运行命令，或者在特定上下文中获得一个 shell。考虑一个同时具有`user_r`和`dbadm_r`角色的用户（`dbadm_r`角色是为数据库管理员指定的角色）。在`sudoers`文件中，以下行允许`myuser`用户通过`sudo`运行任何命令，触发时将以`dbadm_r`角色和`dbadm_t`域运行：
- en: '[PRE27]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Often, administrators will prefer `sudo` over `newrole` as the latter does not
    change the effective user ID, which is often required for end users when they
    want to invoke a more privileged command (concerning the root user or a service-specific
    runtime account) anyway. The `sudo` application also has great logging capabilities,
    and we can even have commands switching roles without requiring the end user to
    explicitly mention the target role and type. Sadly, it does not support changing
    sensitivities.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 管理员通常更倾向于使用`sudo`而不是`newrole`，因为后者不会更改有效的用户 ID，这通常是最终用户在调用更高权限命令时所需要的（无论是针对
    root 用户还是特定服务的运行时帐户）。`sudo`应用还具有出色的日志记录功能，我们甚至可以让命令切换角色，而无需最终用户明确指定目标角色和类型。遗憾的是，它不支持更改敏感度。
- en: Reaching other domains using runcon
  id: totrans-153
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 runcon 访问其他域
- en: Another application that can switch roles and sensitivities is the `runcon`
    application. The `runcon` command is available for all users and is used to launch
    a specific command as a different role, type, and/or sensitivity. It even supports
    changing the SELinux user – assuming the SELinux policy lets you.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个可以切换角色和敏感度的应用是`runcon`应用。`runcon`命令对所有用户可用，用于以不同的角色、类型和/或敏感度启动特定的命令。它甚至支持更改
    SELinux 用户——前提是 SELinux 策略允许。
- en: The `runcon` command does not have its own domain – it runs in the context of
    the user executing the command. As such, the privileges of the user domain itself
    govern the ability to change the role, type, sensitivity, or even SELinux user.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '`runcon`命令没有自己的域——它在执行该命令的用户的上下文中运行。因此，用户域本身的权限决定了是否能够更改角色、类型、敏感度，甚至是 SELinux
    用户。'
- en: 'Most of the time, we will use `runcon` to launch applications with a particular
    category. This allows us to take advantage of the MCS approach in SELinux without
    requiring applications to be MCS-enabled:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数情况下，我们会使用`runcon`来启动具有特定类别的应用程序。这使我们能够利用 SELinux 中的 MCS 方法，而无需要求应用程序启用 MCS：
- en: '[PRE28]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: For instance, in the previous example, we run a shell session with the `Salaries`
    category (prohibiting it from accessing resources that do not have the same or
    fewer categories set).
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，在前面的示例中，我们运行一个带有`Salaries`类别的 shell 会话（禁止其访问没有设置相同或更少类别的资源）。
- en: Switching to the system role
  id: totrans-159
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 切换到系统角色
- en: Sometimes, administrators will need to invoke applications that should not run
    under their current SELinux user context but instead as the `system_u` SELinux
    user with the `system_r` SELinux role. SELinux policy administrators acknowledge
    this need, and allow a *very* limited set of domains to switch the SELinux user
    to a different user – perhaps contrary to the purpose of the immutability of SELinux
    users mentioned earlier. Yet, as there are cases where this is needed, SELinux
    needs to accommodate this. One of the applications allowed to switch the SELinux
    user is `run_init` (through its `run_init_t` domain).
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 有时，管理员需要调用一些应用程序，这些应用程序不应该在当前的 SELinux 用户上下文下运行，而是应该作为 `system_u` SELinux 用户，并拥有
    `system_r` SELinux 角色。SELinux 策略管理员已经认识到这一需求，并允许一个*非常*有限的领域切换 SELinux 用户到不同的用户——这可能与之前提到的
    SELinux 用户不可变性的目的相违背。然而，既然有时候确实需要这样做，SELinux 必须适应这一点。允许切换 SELinux 用户的应用程序之一是 `run_init`（通过其
    `run_init_t` 域）。
- en: The `run_init` application is mainly (almost exclusively) used to start background
    system services on a Linux system. Using this application, the daemons do not
    run under the user's SELinux context but the system's, as required by SELinux
    policies.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: '`run_init` 应用程序主要（几乎是唯一）用于在 Linux 系统上启动后台系统服务。通过使用此应用程序，守护进程不再以用户的 SELinux
    上下文运行，而是以系统的上下文运行，这符合 SELinux 策略的要求。'
- en: As this is only needed on systems where launching additional services is done
    through service scripts, distributions that use `systemd` do not require the use
    of `run_init`. `systemd` already runs with the `system_r` role and is responsible
    for starting additional services. As such, no role transition is needed. Other
    `init` systems, such as Gentoo's OpenRC, integrate `run_init` so that administrators
    do not generally need to invoke `run_init` manually.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 由于这一需求仅在通过服务脚本启动附加服务的系统上出现，使用 `systemd` 的发行版不需要使用 `run_init`。`systemd` 已经以 `system_r`
    角色运行，并负责启动附加服务。因此，不需要角色转换。其他 `init` 系统，如 Gentoo 的 OpenRC，集成了 `run_init`，使得管理员通常不需要手动调用
    `run_init`。
- en: Most SELinux policies enable role-managed support for selective service management
    (for non `systemd` distributions). This allows users that do not have complete
    system administration rights to still manipulate a select number of services on
    a Linux system, allowed by the SELinux policy. These users are to be granted the
    `system_r` role, but once accomplished, they do not need to call `run_init` to
    manipulate specific services anymore. The transitions happen automatically and
    only for the services assigned to the user – other services cannot be launched
    by these users.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数 SELinux 策略启用基于角色的支持来进行选择性服务管理（针对非 `systemd` 发行版）。这使得没有完整系统管理权限的用户，仍然能够在
    Linux 系统上操作由 SELinux 策略允许的某些服务。这些用户将被授予 `system_r` 角色，但一旦完成，他们就不需要再调用 `run_init`
    来操作特定的服务了。转换会自动发生，并且仅限于分配给该用户的服务——其他服务无法由这些用户启动。
- en: This finalizes our section on handling SELinux roles. We've learned how to manage
    SELinux roles and switching roles and contexts, as well as how to define the target
    role and type in the case of privilege escalation. In the last section of this
    chapter, we will look at how PAM is used to configure the SELinux context setup
    on the system.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 本节结束了我们关于处理 SELinux 角色的部分。我们已经学习了如何管理 SELinux 角色、切换角色和上下文，以及在特权提升情况下如何定义目标角色和类型。在本章的最后部分，我们将探讨
    PAM 如何用于配置系统上的 SELinux 上下文设置。
- en: SELinux and PAM
  id: totrans-165
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: SELinux 和 PAM
- en: With all the information about SELinux users and roles, we have not touched
    upon how exactly applications or services create and assign an SELinux context
    to a user. As mentioned earlier on, this is coordinated through the use of Linux's
    PAM services.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然我们讨论了 SELinux 用户和角色的所有信息，但我们并没有涉及应用程序或服务如何创建并分配 SELinux 上下文给用户。正如之前提到的，这一过程是通过
    Linux 的 PAM 服务来协调的。
- en: Assigning contexts through PAM
  id: totrans-167
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 通过 PAM 分配上下文
- en: End users log in to a Linux system through either a login process (triggered
    through a `getty` process), a networked service (for example, the OpenSSH daemon),
    or through a graphical login manager (`xdm`, `kdm`, `gdm`, `slim`, and so on).
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 最终用户通过登录过程（通过 `getty` 进程触发）、网络服务（例如 OpenSSH 守护进程）或图形登录管理器（如 `xdm`、`kdm`、`gdm`、`slim`
    等）登录到 Linux 系统。
- en: These services are responsible for switching our effective user ID (upon successful
    authentication, of course) so that we are not active on the system as the `root`
    user. For SELinux systems, these processes also need to switch the SELinux user
    (and role) accordingly, as otherwise, the context will be inherited from the service,
    which is obviously wrong for any interactive session.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 这些服务负责切换我们的有效用户 ID（当然是在身份验证成功后），以确保我们不会作为 `root` 用户在系统上活动。对于 SELinux 系统，这些进程还需要相应地切换
    SELinux 用户（和角色），否则上下文将从服务继承，这对任何交互式会话显然是错误的。
- en: In theory, all these applications can be made fully SELinux aware, linking with
    the SELinux user space libraries to get information about Linux mappings and SELinux
    users. Instead of converting all these applications, the developers decided to
    take the authentication route to the next level using the PAM services that Linux
    systems provide.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 理论上，所有这些应用程序都可以完全支持 SELinux，与 SELinux 用户空间库链接，以获取有关 Linux 映射和 SELinux 用户的信息。开发人员没有选择将所有这些应用程序转换为
    SELinux 支持，而是决定通过 Linux 系统提供的 PAM 服务将身份验证提升到一个新水平。
- en: PAM offers a very flexible interface for handling different authentication methods
    on Linux (and Unix) systems. All applications mentioned earlier use PAM for their
    authentication steps. To enable SELinux support for these applications, we need
    to update their PAM configuration files to include the `pam_selinux.so` library.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: PAM 为处理 Linux（和 Unix）系统上的不同身份验证方法提供了一个非常灵活的接口。前面提到的所有应用程序都使用 PAM 来执行其身份验证步骤。为了使这些应用程序支持
    SELinux，我们需要更新它们的 PAM 配置文件，以包含 `pam_selinux.so` 库。
- en: 'The following code listing is an excerpt from CentOS''s `/etc/pam.d/remote`
    file, limited to PAM''s session service directives. It triggers the `pam_selinux.so`
    library code as part of the authentication process, as follows:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码列表摘自 CentOS 的 `/etc/pam.d/remote` 文件，限制为 PAM 会话服务指令。它在身份验证过程中触发 `pam_selinux.so`
    库代码，具体如下：
- en: '[PRE29]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: The arguments supported by the `pam_selinux.so` code are described in the `pam_selinux`
    manual page. In the preceding example, the `close` option clears the current context
    (if any), whereas the `open` option sets the context of the user. The `pam_selinux`
    module takes care of querying the SELinux configuration and finding the right
    mappings and context based on the service name used by the daemon.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: '`pam_selinux.so` 代码支持的参数在 `pam_selinux` 手册页中有描述。在前面的示例中，`close` 选项会清除当前上下文（如果有的话），而
    `open` 选项则设置用户的上下文。`pam_selinux` 模块负责查询 SELinux 配置，并根据守护进程使用的服务名称找到正确的映射和上下文。'
- en: Prohibiting access during permissive mode
  id: totrans-175
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在宽容模式下禁止访问
- en: Having SELinux active and enforcing on a system improves its resilience against
    successful exploits and other malicious activities, especially when the system
    is used as a shell server (or provides other interactive services) and the users
    are confined – meaning they are mapped to `user_u` or other confined SELinux users.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 在系统上启用并强制执行 SELinux 可以提高其抵御成功利用和其他恶意活动的能力，特别是当系统用作外壳服务器（或提供其他交互式服务）并且用户受到限制——即被映射到
    `user_u` 或其他受限 SELinux 用户时。
- en: Some administrators might want to temporarily switch the system to permissive
    mode. This could be to troubleshoot issues or to support some changes made on
    the system. When using permissive mode, it would be a good idea to ensure that
    the interactive services are not usable for regular users.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 一些管理员可能希望暂时将系统切换到宽容模式。这可能是为了排查问题或支持系统上进行的某些更改。使用宽容模式时，确保互动服务对普通用户不可用是一个好主意。
- en: With `pam_sepermit`, this can be enforced on the system. The PAM module will
    deny a set of defined users access to the system if the system is in permissive
    mode. By default, these users are mentioned in `/etc/security/sepermit.conf`,
    but a different file can be configured through the `conf=` option inside the PAM
    configuration itself.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `pam_sepermit`，可以在系统上强制执行这一点。PAM 模块将在系统处于宽容模式时拒绝一组已定义用户的访问。默认情况下，这些用户会在 `/etc/security/sepermit.conf`
    中列出，但也可以通过 PAM 配置中的 `conf=` 选项配置使用其他文件。
- en: 'In the `sepermit.conf` file, there are three approaches to document which users
    should be denied access when the system is in permissive mode:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `sepermit.conf` 文件中，有三种方法可以记录哪些用户在系统处于宽容模式时应被拒绝访问：
- en: Regular usernames
  id: totrans-180
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 常规用户名
- en: Group names, prefixed with the `@` sign
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 组名，以 `@` 符号为前缀
- en: SELinux usernames, prefixed with the `%` sign
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SELinux 用户名，以 `%` 符号为前缀
- en: 'Within this file, we list each user, group, or SELinux user on a single line.
    After each entry, we can (but don''t have to) add one or two options:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个文件中，我们将每个用户、组或 SELinux 用户列在一行中。在每个条目后，我们可以（但不必）添加一两个选项：
- en: '`exclusive` means that the system will allow the user to be active even when
    the system is in permissive mode, but only a single session can be active. When
    the user logs out, all active processes will be killed.'
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`exclusive` 意味着即使系统处于宽松模式，系统仍会允许用户处于活动状态，但只能有一个会话处于活动状态。当用户注销时，所有活动进程将被终止。'
- en: '`ignore` will return `PAM_IGNORE` as the return status if SELinux is in enforcing
    mode, and `PAM_AUTH_ERR` if SELinux is in permissive mode. This allows special
    constructs/branches for this user in PAM based on the permissive state of the
    system.'
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ignore` 会在 SELinux 处于强制模式时返回 `PAM_IGNORE` 作为返回状态，在 SELinux 处于宽松模式时返回 `PAM_AUTH_ERR`。这允许根据系统的宽松状态为该用户在
    PAM 中构建特殊的结构/分支。'
- en: 'To enable `pam_sepermit`, it''s sufficient to enable the module in the auth
    PAM service as follows:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用 `pam_sepermit`，只需在身份验证 PAM 服务中启用该模块，如下所示：
- en: '[PRE30]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Of course, don't forget to remove all active user sessions when switching to
    permissive mode, as any running session is otherwise left untouched.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，切换到宽松模式时不要忘记移除所有活动的用户会话，因为任何正在运行的会话将保持不变。
- en: Polyinstantiating directories
  id: totrans-189
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 多实例化目录
- en: The last PAM module we'll look at is `pam_namespace.so`. Before we dive into
    configuring this module, let's first look at what polyinstantiation is about.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将要查看的最后一个 PAM 模块是 `pam_namespace.so`。在深入配置这个模块之前，我们首先来看一下什么是多实例化（polyinstantiation）。
- en: '**Polyinstantiation** is an approach where, when a user logs in to a system,
    the user gets a view on filesystem resources specific to its session, while optionally
    hiding the resources of other users. This differs from regular access controls,
    where the other resources are still visible, but might just be inaccessible.'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: '**多实例化（Polyinstantiation）** 是一种方法，当用户登录到系统时，用户将获得特定于其会话的文件系统资源视图，同时可选择隐藏其他用户的资源。这不同于常规的访问控制，在常规访问控制中，其他资源仍然可见，但可能不可访问。'
- en: This session-specific view, however, does not just use regular mounts. The module
    uses the Linux kernel namespace technology to force a (potentially more limited)
    view on the filesystem, isolated and specific to the user session. Other users
    have a different view on the filesystem.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这种会话特定的视图不仅仅使用常规挂载。该模块使用 Linux 内核的命名空间技术，强制为文件系统提供一个（可能更加有限的）视图，该视图是针对用户会话的，并且是隔离的。其他用户会看到不同的文件系统视图。
- en: Let's use a common example. Assume that all users, except `root`, should not
    have access to the temporary files generated by other users. With standard access
    controls, these resources would still be visible (perhaps not readable, but their
    existence or the directories they reside in would be visible). Instead, with polyinstantiation,
    a user will only see their own `/tmp` and `/var/tmp` views.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们举一个常见的例子。假设所有用户（除了 `root`）都不应该访问其他用户生成的临时文件。使用标准访问控制，这些资源仍然可见（可能不可读，但它们的存在或所在目录会可见）。相反，使用多实例化后，用户只会看到自己的
    `/tmp` 和 `/var/tmp` 视图。
- en: 'The following setting in `/etc/security/namespace.conf` will remap these two
    locations:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: '`/etc/security/namespace.conf` 中的以下设置将重新映射这两个位置：'
- en: '[PRE31]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: On the real filesystem, those locations will be remapped to a subdirectory inside
    `/tmp/tmp-inst` and `/var/tmp/tmp-inst`. The end users do not know or see the
    remapped locations – for them, `/tmp` and `/var/tmp` are as they would expect.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 在真实的文件系统上，这些位置将被重新映射到 `/tmp/tmp-inst` 和 `/var/tmp/tmp-inst` 中的子目录。最终用户无法知道或看到这些重新映射的位置——对他们来说，`/tmp`
    和 `/var/tmp` 就像他们预期的那样。
- en: 'The format (and thus polyinstantiation) of the subdirectories created depends
    on the third option within the `namespace.conf` file. The supported options are
    as follows:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 创建的子目录的格式（以及多实例化）取决于 `namespace.conf` 文件中的第三个选项。支持的选项如下：
- en: '`user`, which will create a subdirectory named after the user (such as `lisa`)'
  id: totrans-198
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`user`，它将创建一个以用户名称命名的子目录（如 `lisa`）'
- en: '`level`, which will create a subdirectory named after the user sensitivity
    level and username (such as `system_u:object_r:tmp_t:s0-s0:c0.c1023_lisa`)'
  id: totrans-199
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`level`，它将创建一个以用户敏感度级别和用户名命名的子目录（如 `system_u:object_r:tmp_t:s0-s0:c0.c1023_lisa`）'
- en: '`context`, which will create a subdirectory named after the process context
    (including the sensitivity level) and username (such as `system_u:object_r:user_tmp_t:s0_lisa`)'
  id: totrans-200
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`context`，它将创建一个以进程上下文（包括敏感度级别）和用户名命名的子目录（如 `system_u:object_r:user_tmp_t:s0_lisa`）'
- en: For SELinux systems, the most common setting is `level`.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 SELinux 系统，最常见的设置是 `level`。
- en: Tip
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 提示
- en: In the default `namespace.conf` file, you might notice that this also has support
    for home directories. When enabled with the `level` or `context` method, this
    will ensure that users have a sensitivity-specific home directory set. For instance,
    if the system configuration forces the user to have a lower sensitivity when logged
    in through SSH than when the user logs in through the terminal, a different home
    directory view will be used.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 在默认的`namespace.conf`文件中，您可能会注意到它也支持用户的家目录。启用`level`或`context`方法后，它将确保用户具有特定敏感性的家目录。例如，如果系统配置要求用户通过SSH登录时拥有较低的敏感性，而通过终端登录时拥有较高的敏感性，则会使用不同的家目录视图。
- en: 'In the previous example, only the root user is exempt from these namespace
    changes. Additional users can be listed (comma-separated), or an explicit list
    of users can be given for which polyinstantiation needs to be enabled (if we prefix
    the user list with the `~` character). To allow the namespace changes to take
    place, the target locations need to be available on the system with the `000`
    permission:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的示例中，只有root用户被排除在这些命名空间更改之外。可以列出其他用户（用逗号分隔），或者为需要启用多实例化的用户提供显式用户列表（如果我们在用户列表前加上`~`字符）。为了使命名空间更改生效，目标位置需要在系统上以`000`权限可用：
- en: '[PRE32]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'Next, enable `pam_namespace.so` in the PAM configuration files at the session
    service:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在会话服务的PAM配置文件中启用`pam_namespace.so`：
- en: '[PRE33]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Finally, make sure that SELinux allows polyinstantiated directories. On CentOS,
    this is governed through the `polyinstantiation_enabled` SELinux boolean:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，确保SELinux允许多实例化目录。在CentOS上，这是通过`polyinstantiation_enabled` SELinux布尔值来管理的：
- en: '[PRE34]'
  id: totrans-209
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Other distributions will have it through the `allow_polyinstantiation` SELinux
    boolean.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 其他发行版会通过`allow_polyinstantiation` SELinux布尔值来支持它。
- en: With the polyinstantiation support, we close off this final section of the chapter,
    where we learned how PAM is used to trigger SELinux context changes on the system.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 通过多实例支持，我们结束了本章的最后一节，学习了PAM如何触发系统上的SELinux上下文变化。
- en: Summary
  id: totrans-212
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: SELinux maps Linux users onto SELinux users and defines the roles a user can
    be assigned through the SELinux user definitions. We learned how to manage those
    mappings and SELinux users with the `semanage` application, and how to grant the
    right roles to the right people.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: SELinux将Linux用户映射到SELinux用户，并通过SELinux用户定义定义用户可以分配的角色。我们学习了如何使用`semanage`应用程序管理这些映射和SELinux用户，以及如何为合适的人授予正确的角色。
- en: We also saw how the same commands are used to grant the proper sensitivity to
    the user and how we can describe these levels in the `setrans.conf` file. We used
    the `chcat` tool to do most of the category-related management activities.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还看到如何使用相同的命令为用户授予适当的敏感性，并且如何在`setrans.conf`文件中描述这些级别。我们使用`chcat`工具执行了大多数与类别相关的管理活动。
- en: After assigning roles to the users, we saw how to jump from one role to another
    using `newrole`, `sudo`, `runcon`, and `run_init`. We ended this chapter with
    important insights into how SELinux is integrated into the Linux authentication
    process and how to tune a Linux system further using a couple of SELinux-aware
    PAM modules.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 在为用户分配角色后，我们看到如何使用`newrole`、`sudo`、`runcon`和`run_init`在不同角色之间切换。本章最后，我们深入了解了SELinux如何集成到Linux认证过程，并如何通过几个SELinux感知的PAM模块进一步调整Linux系统。
- en: In the next chapter, we will learn to manage the labels on files and processes,
    and see how we can query the SELinux policy rules.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将学习如何管理文件和进程上的标签，并了解如何查询SELinux策略规则。
- en: Questions
  id: totrans-217
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 问题
- en: Why can't we just add an SELinux role to a Linux account?
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为什么我们不能直接将SELinux角色添加到Linux账户？
- en: Can Linux accounts be mapped to more than one SELinux user?
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Linux账户能否映射到多个SELinux用户？
- en: Besides associating the valid SELinux roles, what other advantages does an SELinux
    user have?
  id: totrans-220
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 除了关联有效的SELinux角色外，SELinux用户还有哪些其他优势？
- en: What purpose does PAM have when dealing with Linux accounts and SELinux mappings?
  id: totrans-221
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: PAM在处理Linux账户和SELinux映射时的作用是什么？
