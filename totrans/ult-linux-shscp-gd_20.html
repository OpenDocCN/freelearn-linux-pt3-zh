<html><head></head><body>
  <div id="_idContainer393" class="Basic-Text-Frame">
    <h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">20</span></h1>
    <h1 id="_idParaDest-409" class="chapterTitle"><span class="koboSpan" id="kobo.2.1">Shell Script Security</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.3.1">Thus far, we haven’t talked a whole lot about shell scripting security. </span><span class="koboSpan" id="kobo.3.2">Frankly, it’s because it’s one of those things that you might never have to worry about. </span><span class="koboSpan" id="kobo.3.3">I mean, a lot of times you’ll just be writing scripts for your own use, that you’ll just be running from your home directory on your own local machine. </span><span class="koboSpan" id="kobo.3.4">Even if you’re an administrator who needs to create scripts that perform some sort of administrative task, you might only need to either run them on from your own home directory or share them with other </span><em class="italic"><span class="koboSpan" id="kobo.4.1">trusted</span></em><span class="koboSpan" id="kobo.5.1"> administrators who just run them from their own home directories. </span><span class="koboSpan" id="kobo.5.2">In these cases, shell scripting security isn’t necessarily a huge deal.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.6.1">However, you may at times need to share your script with other users or administrators that you don’t fully trust. </span><span class="koboSpan" id="kobo.6.2">In these cases, shell scripting security is </span><em class="italic"><span class="koboSpan" id="kobo.7.1">extremely important</span></em><span class="koboSpan" id="kobo.8.1">, and should be a major part of your scripting focus. </span><span class="koboSpan" id="kobo.8.2">For example, you might have some sort of administrative script that you need to place into a directory that administrators with only limited permissions can access. </span><span class="koboSpan" id="kobo.8.3">In those cases, you also need to ensure that nobody can modify it, and that only certain designated administrators can execute it. </span><span class="koboSpan" id="kobo.8.4">You’ll also want to design the script in a way that will prevent bad actors from using it to perform command injection attacks.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.9.1">Topics in this chapter include:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.10.1">Controlling Access to Your Scripts</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.11.1">Understanding SUID and SGID Considerations</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.12.1">Avoiding Sensitive Data Leakage</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.13.1">Understanding Command Injection with </span><code class="inlineCode"><span class="koboSpan" id="kobo.14.1">eval</span></code></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.15.1">Understanding Path Security</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.16.1">If you’re ready, let’s get going.</span></p>
    <h1 id="_idParaDest-410" class="heading 1"><span class="koboSpan" id="kobo.17.1">Technical Requirements</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.18.1">I’ll mainly be working with Fedora Server and Ubuntu Server virtual machines. </span><span class="koboSpan" id="kobo.18.2">But, the techniques that I’ll show you should work on just about any Linux distro. </span><span class="koboSpan" id="kobo.18.3">I’ll also be showing you some things on a FreeBSD 14 virtual machine, and an OpenIndiana virtual machine.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.19.1">As always, you can grab the scripts by doing:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.20.1">git clone https://github.com/PacktPublishing/The-Ultimate-Linux-Shell-Scripting-Guide.git
</span></code></pre>
    <h1 id="_idParaDest-411" class="heading 1"><span class="koboSpan" id="kobo.21.1">Controlling Access to Your Scripts</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.22.1">A lot of the scripts that you create might be just for yourself or your co-workers. </span><span class="koboSpan" id="kobo.22.2">Or, they might be </span><a id="_idIndexMarker1189"/><span class="koboSpan" id="kobo.23.1">for general distribution to the public. </span><span class="koboSpan" id="kobo.23.2">In all of these cases, you might not need to worry about having any kind of access control on your scripts.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.24.1">But, there might also be times when you need to create scripts that only certain people can access. </span><span class="koboSpan" id="kobo.24.2">The methods that you can use for this include:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.25.1">Assigning </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">sudo</span></code><span class="koboSpan" id="kobo.27.1"> privileges</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.28.1">Assigning an Access Control List</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.29.1">Obfuscating plain-text scripts</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.30.1">We’ll begin by looking using </span><code class="inlineCode"><span class="koboSpan" id="kobo.31.1">sudo</span></code><span class="koboSpan" id="kobo.32.1">.</span></p>
    <h2 id="_idParaDest-412" class="heading 2"><span class="koboSpan" id="kobo.33.1">Assigning sudo Privileges</span></h2>
    <p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">sudo</span></code><span class="koboSpan" id="kobo.35.1"> is a handy </span><a id="_idIndexMarker1190"/><span class="koboSpan" id="kobo.36.1">security feature that is installed by default </span><a id="_idIndexMarker1191"/><span class="koboSpan" id="kobo.37.1">on macOS, OpenIndiana and most Linux distros. </span><span class="koboSpan" id="kobo.37.2">It’s also available for installation on most BSD-type distros and any Linux distros on which it isn’t installed by default. </span><span class="koboSpan" id="kobo.37.3">The most common way to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">sudo</span></code><span class="koboSpan" id="kobo.39.1"> is to allow non-privileged users to run programs with root user privileges. </span><span class="koboSpan" id="kobo.39.2">(You can also use </span><code class="inlineCode"><span class="koboSpan" id="kobo.40.1">sudo</span></code><span class="koboSpan" id="kobo.41.1"> to allow users to run programs with the privileges of other non-root users, such as a database user. </span><span class="koboSpan" id="kobo.41.2">I’m not going to go into all that now though, because I’m trying to keep things simple.)</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.42.1">Now, here’s what makes </span><code class="inlineCode"><span class="koboSpan" id="kobo.43.1">sudo</span></code><span class="koboSpan" id="kobo.44.1"> so cool. </span><span class="koboSpan" id="kobo.44.2">Let’s say that you want a particular user to run one particular </span><a id="_idIndexMarker1192"/><span class="koboSpan" id="kobo.45.1">program with root user privileges. </span><span class="koboSpan" id="kobo.45.2">With </span><code class="inlineCode"><span class="koboSpan" id="kobo.46.1">sudo</span></code><span class="koboSpan" id="kobo.47.1">, you don’t have to give that user the root user password. </span><span class="koboSpan" id="kobo.47.2">Instead, just configure </span><a id="_idIndexMarker1193"/><span class="koboSpan" id="kobo.48.1">the user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.49.1">sudo</span></code><span class="koboSpan" id="kobo.50.1"> privileges for the program, and then let the user enter his or her own password whenever he or she needs to run the program. </span><span class="koboSpan" id="kobo.50.2">Let’s look at how that works.</span></p>
    <h3 id="_idParaDest-413" class="heading 3"><span class="koboSpan" id="kobo.51.1">Hands-on Lab ­– Configuring sudo</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.52.1">In this lab, you’ll </span><a id="_idIndexMarker1194"/><span class="koboSpan" id="kobo.53.1">create a simple script, and configure </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">sudo</span></code><span class="koboSpan" id="kobo.55.1"> so that only designated users can run it.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.56.1">Create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">sudo_demo1.sh</span></code><span class="koboSpan" id="kobo.58.1"> script, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.59.1">#!/bin/bash
echo "This is a demo of sudo privileges."
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.60.1">Copy the script to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.61.1">/usr/local/sbin/</span></code><span class="koboSpan" id="kobo.62.1"> directory:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.63.1">donnie@ubuntu2404:~$ sudo cp sudo_demo1.sh /usr/local/sbin/
donnie@ubuntu2404:~$ ls -l /usr/local/sbin/sudo_demo1.sh
-rw-r--r-- 1 root root 55 Jul  6 19:24 /usr/local/sbin/sudo_demo1.sh
donnie@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.64.1">As you see, copying this script to </span><code class="inlineCode"><span class="koboSpan" id="kobo.65.1">/user/local/sbin/</span></code><span class="koboSpan" id="kobo.66.1"> caused the ownership of the file to automatically change to the root user.</span></p>
    <ol>
      <li class="numberedList" value="3"><span class="koboSpan" id="kobo.67.1">Set permissions on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">sudo_demo1.sh</span></code><span class="koboSpan" id="kobo.69.1"> file so that only the root user can access it:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.70.1">donnie@ubuntu2404:~$ cd /usr/local/sbin/
donnie@ubuntu2404:/usr/local/sbin$ sudo chmod 700 sudo_demo1.sh
donnie@ubuntu2404:/usr/local/sbin$ ls -l sudo_demo1.sh
-rwx------ 1 root root 55 Jul  6 19:24 sudo_demo1.sh
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.71.1">Note how in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">chmod 700</span></code><span class="koboSpan" id="kobo.73.1"> command, the 7 assigns read, write, and execute privileges </span><a id="_idIndexMarker1195"/><span class="koboSpan" id="kobo.74.1">to the root user. </span><span class="koboSpan" id="kobo.74.2">The two 0s remove all privileges from the </span><em class="italic"><span class="koboSpan" id="kobo.75.1">group</span></em><span class="koboSpan" id="kobo.76.1"> and from </span><em class="italic"><span class="koboSpan" id="kobo.77.1">others</span></em><span class="koboSpan" id="kobo.78.1">. </span><span class="koboSpan" id="kobo.78.2">But, how do we obtain the value of 7 in the </span><em class="italic"><span class="koboSpan" id="kobo.79.1">user</span></em><span class="koboSpan" id="kobo.80.1"> position? </span><span class="koboSpan" id="kobo.80.2">Here’s the breakdown on how it works:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.81.1"> The </span><em class="italic"><span class="koboSpan" id="kobo.82.1">read</span></em><span class="koboSpan" id="kobo.83.1"> permission has a value of 4.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.84.1"> The </span><em class="italic"><span class="koboSpan" id="kobo.85.1">write</span></em><span class="koboSpan" id="kobo.86.1"> permission has a value of 2.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.87.1"> The </span><em class="italic"><span class="koboSpan" id="kobo.88.1">execute</span></em><span class="koboSpan" id="kobo.89.1"> permission has a value of 1.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.90.1">In this case, we want the user to have full read, write, and execute permissions. </span><span class="koboSpan" id="kobo.90.2">Adding the values of all three of those permissions gives us a value of 7. </span></p>
      <p class="normal"><span class="koboSpan" id="kobo.91.1">(I know that this is a rather cursory explanation, but for now, please bear with me.)</span></p>
    </div>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.92.1">Create a non-privileged user account for Horatio.</span></li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.93.1"> On Debian/Ubuntu, do:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.94.1">sudo adduser horatio
</span></code></pre>
    <p class="normal one"><span class="koboSpan" id="kobo.95.1"> On Fedora and other Red Hat-type distros:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.96.1">sudo useradd horatio
sudo passwd horatio
</span></code></pre>
    <ol>
      <li class="numberedList" value="5"><span class="koboSpan" id="kobo.97.1">Begin configuring </span><code class="inlineCode"><span class="koboSpan" id="kobo.98.1">sudo</span></code><span class="koboSpan" id="kobo.99.1"> by entering:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.100.1">sudo visudo
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.101.1">This command will open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.102.1">/etc/sudoers</span></code><span class="koboSpan" id="kobo.103.1"> file in either </span><code class="inlineCode"><span class="koboSpan" id="kobo.104.1">nano</span></code><span class="koboSpan" id="kobo.105.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.106.1">vi</span></code><span class="koboSpan" id="kobo.107.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.108.1">vim</span></code><span class="koboSpan" id="kobo.109.1">, depending </span><a id="_idIndexMarker1196"/><span class="koboSpan" id="kobo.110.1">upon which operating system you’re working with. </span><span class="koboSpan" id="kobo.110.2">Beyond that, the directions are the same.</span></p>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.111.1">Scroll down until you see this line:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.112.1">root    ALL=(ALL:ALL) ALL
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.113.1">Directly below that line, place this line:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.114.1">horatio ALL=(ALL:ALL) /usr/local/sbin/sudo_demo1.sh
</span></code></pre>
    <p class="normal one"><span class="koboSpan" id="kobo.115.1">Save the file as you would with a normal text editor.</span></p>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.116.1">I know that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.117.1">ALL=(ALL:ALL)</span></code><span class="koboSpan" id="kobo.118.1"> thing looks confusing, but it’s really quite simple. </span><span class="koboSpan" id="kobo.118.2">Here’s the TL;DR of what it means:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.119.1">ON_HOSTS=(AS_USER:AS_GROUP_MEMBER) ALLOWED_COMMANDS</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.120.1">Now, here’s the more specific breakdown:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.121.1">The first </span><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">ALL</span></code><span class="koboSpan" id="kobo.123.1"> means that the specified user can run this command on all machines on the local network. </span><span class="koboSpan" id="kobo.123.2">Optionally, you can replace this </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">ALL</span></code><span class="koboSpan" id="kobo.125.1"> with the hostname of a particular machine or groups of machines on which you want this user to be able to run this command.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.126.1">The second </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">ALL</span></code><span class="koboSpan" id="kobo.128.1"> means that the specified user can run this command as all users, including the root user.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.129.1">The third </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">ALL</span></code><span class="koboSpan" id="kobo.131.1"> means that Horatio can run this command as a member of all groups, including the root user’s group. </span><span class="koboSpan" id="kobo.131.2">(Note that this is optional. </span><span class="koboSpan" id="kobo.131.3">You can also just omit the group, and set this to </span><code class="inlineCode"><span class="koboSpan" id="kobo.132.1">ALL=(ALL)</span></code><span class="koboSpan" id="kobo.133.1">.)</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.134.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.135.1">root</span></code><span class="koboSpan" id="kobo.136.1"> line, the final </span><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">ALL</span></code><span class="koboSpan" id="kobo.138.1"> means that the root user can run all privileged commands. </span><span class="koboSpan" id="kobo.138.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.139.1">horatio</span></code><span class="koboSpan" id="kobo.140.1"> line, the final </span><code class="inlineCode"><span class="koboSpan" id="kobo.141.1">ALL</span></code><span class="koboSpan" id="kobo.142.1"> is replaced by the specific command that we want to allow Horatio to run.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.143.1">Open another </span><a id="_idIndexMarker1197"/><span class="koboSpan" id="kobo.144.1">terminal window on your host machine, and log into the virtual machine with Horatio’s account.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.145.1">Have Horatio test this by first trying to run the script without </span><code class="inlineCode"><span class="koboSpan" id="kobo.146.1">sudo</span></code><span class="koboSpan" id="kobo.147.1">, and then with </span><code class="inlineCode"><span class="koboSpan" id="kobo.148.1">sudo</span></code><span class="koboSpan" id="kobo.149.1">, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.150.1">horatio@ubuntu2404:~$ sudo_demo1.sh
-bash: /usr/local/sbin/sudo_demo1.sh: Permission denied
horatio@ubuntu2404:~$ sudo sudo_demo1.sh
[sudo] password for horatio:
This is a demo of sudo privileges.
</span><span class="koboSpan" id="kobo.150.2">horatio@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.151.1">You see that Horatio can run the script with his </span><code class="inlineCode"><span class="koboSpan" id="kobo.152.1">sudo</span></code><span class="koboSpan" id="kobo.153.1"> privileges.</span></p>
    <ol>
      <li class="numberedList" value="9"><span class="koboSpan" id="kobo.154.1">Have Horatio attempt to view the script’s source code, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.155.1">horatio@ubuntu2404:~$ cd /usr/local/sbin
horatio@ubuntu2404:/usr/local/sbin$ less sudo_demo1.sh
sudo_demo1.sh: Permission denied
horatio@ubuntu2404:/usr/local/sbin$ sudo less sudo_demo1.sh
Sorry, user horatio is not allowed to execute '/usr/bin/less sudo_demo1.sh' as root on ubuntu2404.
</span><span class="koboSpan" id="kobo.155.2">horatio@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.156.1">Horatio can’t view or edit the source code, because he doesn’t have the proper </span><code class="inlineCode"><span class="koboSpan" id="kobo.157.1">sudo</span></code><span class="koboSpan" id="kobo.158.1"> privileges </span><a id="_idIndexMarker1198"/><span class="koboSpan" id="kobo.159.1">for that. </span><span class="koboSpan" id="kobo.159.2">He has </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">sudo</span></code><span class="koboSpan" id="kobo.161.1"> privileges to do one thing, and one thing only, as the root user, which is just to execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.162.1">sudo_demo1.sh</span></code><span class="koboSpan" id="kobo.163.1"> script.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.164.1">That does it for our introduction to the mysteries of </span><code class="inlineCode"><span class="koboSpan" id="kobo.165.1">sudo</span></code><span class="koboSpan" id="kobo.166.1">. </span><span class="koboSpan" id="kobo.166.2">Let’s move on to our next method of controlling access to scripts.</span></p>
    <h2 id="_idParaDest-414" class="heading 2"><span class="koboSpan" id="kobo.167.1">Using an Access Control List</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.168.1">If you’ve ever been a Windows administrator, you likely know that the NTFS filesystem on Windows </span><a id="_idIndexMarker1199"/><span class="koboSpan" id="kobo.169.1">allows you to grant really fine-grained permissions settings on files and directories. </span><span class="koboSpan" id="kobo.169.2">Sadly, the filesystems on Linux, Unix, and </span><a id="_idIndexMarker1200"/><span class="koboSpan" id="kobo.170.1">Unix-like systems don’t have such fine-grained access control built into them. </span><span class="koboSpan" id="kobo.170.2">But, we can make up for that deficiency somewhat </span><a id="_idIndexMarker1201"/><span class="koboSpan" id="kobo.171.1">by using an </span><strong class="keyWord"><span class="koboSpan" id="kobo.172.1">Access Control List</span></strong><span class="koboSpan" id="kobo.173.1">, or </span><strong class="keyWord"><span class="koboSpan" id="kobo.174.1">ACL</span></strong><span class="koboSpan" id="kobo.175.1">. </span><span class="koboSpan" id="kobo.175.2">Let’s look at how to do that in this hands-on lab.</span></p>
    <h3 id="_idParaDest-415" class="heading 3"><span class="koboSpan" id="kobo.176.1">Hands-on Lab – Setting an ACL for Horatio on Linux</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.177.1">In this lab, we’ll create another script for which only Horatio will have permission to run. </span><span class="koboSpan" id="kobo.177.2">To keep </span><a id="_idIndexMarker1202"/><span class="koboSpan" id="kobo.178.1">things simple, just use the </span><a id="_idIndexMarker1203"/><span class="koboSpan" id="kobo.179.1">same virtual machine that you used for the previous lab, so that you won’t have to create another user account.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.180.1">You’ll find everything you need for setting up ACLs already installed on your Fedora virtual machine. </span><span class="koboSpan" id="kobo.180.2">If you’re using a Debian/Ubuntu type of machine, you might have to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.181.1">acl</span></code><span class="koboSpan" id="kobo.182.1"> package by doing:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.183.1">sudo apt install acl
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.184.1">Log into your own normal user account, and create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.185.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.186.1"> script, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.187.1">#!/bin/bash
echo "This is a demo of ACLs."
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.188.1">Copy the script to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">/usr/local/sbin/</span></code><span class="koboSpan" id="kobo.190.1"> directory, and note how the ownership automatically changes to the root user:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.191.1">donnie@ubuntu2404:~$ vim acl_demo.sh
donnie@ubuntu2404:~$ sudo cp acl_demo.sh /usr/local/sbin/
[sudo] password for donnie:
donnie@ubuntu2404:~$ cd /usr/local/sbin/
donnie@ubuntu2404:/usr/local/sbin$ ls -l acl_demo.sh
-rw-r--r-- 1 root root 44 Jul 24 20:56 acl_demo.sh
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.192.1">In order for an ACL to work, you’ll need to remove all permissions from group and others, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.193.1">donnie@ubuntu2404:/usr/local/sbin$ sudo chmod 700 acl_demo.sh
donnie@ubuntu2404:/usr/local/sbin$ ls -l acl_demo.sh
-rwx------ 1 root root 44 Jul 24 20:56 acl_demo.sh
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.194.1">This is </span><a id="_idIndexMarker1204"/><span class="koboSpan" id="kobo.195.1">because the </span><a id="_idIndexMarker1205"/><span class="koboSpan" id="kobo.196.1">whole point of using an ACL is to prevent everyone who hasn’t been set up with an ACL from accessing the file.</span></p>
    <ol>
      <li class="numberedList" value="5"><span class="koboSpan" id="kobo.197.1">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.198.1">getfacl</span></code><span class="koboSpan" id="kobo.199.1"> to verify that no ACL has been set:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.200.1">donnie@ubuntu2404:/usr/local/sbin$ getfacl acl_demo.sh
# file: acl_demo.sh
# owner: root
# group: root
user::rwx
group::---
other::---
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.201.1">In another terminal window, log into Horatio’s account, and try to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.202.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.203.1"> script, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.204.1">horatio@ubuntu2404:~$ acl_demo.sh
-bash: /usr/local/sbin/acl_demo.sh: Permission denied
horatio@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.205.1">You see that Horatio has been denied.</span></p>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.206.1">Go back to your own terminal window. </span><span class="koboSpan" id="kobo.206.2">Create an ACL so that Horatio will have read and execute permissions on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.207.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.208.1"> script, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.209.1">donnie@ubuntu2404:/usr/local/sbin$ sudo setfacl -m u:horatio:rx acl_demo.sh
donnie@ubuntu2404:/usr/local/sbin$ ls -l acl_demo.sh
-rwxr-x---+ 1 root root 44 Jul 24 20:56 acl_demo.sh
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.210.1">Here’s </span><a id="_idIndexMarker1206"/><span class="koboSpan" id="kobo.211.1">the breakdown </span><a id="_idIndexMarker1207"/><span class="koboSpan" id="kobo.212.1">of the command:</span></p>
    <ul>
      <li class="bulletList level 2"><code class="inlineCode"><span class="koboSpan" id="kobo.213.1">-m</span></code><span class="koboSpan" id="kobo.214.1">: This means to modify the existing ACL. </span><span class="koboSpan" id="kobo.214.2">It will also create an ACL if one hasn’t been created yet.</span></li>
      <li class="bulletList level 2"><code class="inlineCode"><span class="koboSpan" id="kobo.215.1">u:horatio</span></code><span class="koboSpan" id="kobo.216.1">: This means that we’re creating an ACL for user </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">horatio</span></code><span class="koboSpan" id="kobo.218.1">.</span></li>
      <li class="bulletList level 2"><code class="inlineCode"><span class="koboSpan" id="kobo.219.1">rx</span></code><span class="koboSpan" id="kobo.220.1">: This means that we’re granting the read and execute permissions for this file to the specified user.</span></li>
      <li class="bulletList level 2"><span class="koboSpan" id="kobo.221.1">Note the </span><code class="inlineCode"><span class="koboSpan" id="kobo.222.1">+</span></code><span class="koboSpan" id="kobo.223.1"> at the end of the permissions settings for this file. </span><span class="koboSpan" id="kobo.223.2">This indicates that an ACL has been created.</span></li>
    </ul>
    <ol>
      <li class="numberedList" value="8"><span class="koboSpan" id="kobo.224.1">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.225.1">getfacl</span></code><span class="koboSpan" id="kobo.226.1"> to verify that the ACL was created properly:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.227.1"> donnie@ubuntu2404:/usr/local/sbin$ getfacl acl_demo.sh
# file: acl_demo.sh
# owner: root
# group: root
user::rwx
user:horatio:r-x
group::---
mask::r-x
other::---
donnie@ubuntu2404:/usr/local/sbin$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.228.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">user:horatio:r-x</span></code><span class="koboSpan" id="kobo.230.1"> line indicates that the ACL has been created for Horatio.</span></p>
    <ol>
      <li class="numberedList" value="9"><span class="koboSpan" id="kobo.231.1">Go back to Horatio’s terminal window, and have him try to run the script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.232.1">horatio@ubuntu2404:~$ acl_demo.sh
This is a demo of ACLs.
</span><span class="koboSpan" id="kobo.232.2">horatio@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.233.1">This time, Horatio has achieved coolness.</span></p>
    <ol>
      <li class="numberedList" value="10"><span class="koboSpan" id="kobo.234.1">There is one downside to using an ACL instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.235.1">sudo</span></code><span class="koboSpan" id="kobo.236.1">. </span><span class="koboSpan" id="kobo.236.2">That is, </span><code class="inlineCode"><span class="koboSpan" id="kobo.237.1">sudo</span></code><span class="koboSpan" id="kobo.238.1"> automatically assumes that a user needs to read a shell script in order to execute it. </span><span class="koboSpan" id="kobo.238.2">So, </span><code class="inlineCode"><span class="koboSpan" id="kobo.239.1">sudo</span></code><span class="koboSpan" id="kobo.240.1"> allows a user to execute the script without explicitly setting the read permission for that user. </span><span class="koboSpan" id="kobo.240.2">This means that the user won’t be able to </span><a id="_idIndexMarker1208"/><span class="koboSpan" id="kobo.241.1">use any utility </span><a id="_idIndexMarker1209"/><span class="koboSpan" id="kobo.242.1">such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.243.1">cat</span></code><span class="koboSpan" id="kobo.244.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.245.1">less</span></code><span class="koboSpan" id="kobo.246.1"> to view the contents of the script file. </span><span class="koboSpan" id="kobo.246.2">When using an ACL, the read permission and the execute permission both have to be explicitly set on the script to allow someone to run it. </span><span class="koboSpan" id="kobo.246.3">So, when using an ACL, you won’t be able to prevent the user from viewing the contents of the file. </span><span class="koboSpan" id="kobo.246.4">You can prove that by having Horatio view the file, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.247.1">horatio@ubuntu2404:~$ cat /usr/local/sbin/acl_demo.sh
#!/bin/bash
echo "This is a demo of ACLs."
</span><span class="koboSpan" id="kobo.247.2">horatio@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.248.1">The bottom line here is that if you want to prevent users from viewing the contents of your scripts, set them up with the appropriate </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">sudo</span></code><span class="koboSpan" id="kobo.250.1"> privileges instead of using an ACL. </span><span class="koboSpan" id="kobo.250.2">On the other hand, if you don’t mind that users can view the script’s source code, then using an ACL is definitely an option.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.251.1">Space doesn’t allow for me to present more than just a cursory coverage of permissions settings, </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">sudo</span></code><span class="koboSpan" id="kobo.253.1">, and ACLs in this chapter. </span><span class="koboSpan" id="kobo.253.2">If you need more information about them, I have entire chapters devoted to each of these topics in my </span><em class="italic"><span class="koboSpan" id="kobo.254.1">Mastering Linux Security and Hardening</span></em><span class="koboSpan" id="kobo.255.1"> book.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.256.1">That’s does it for </span><code class="inlineCode"><span class="koboSpan" id="kobo.257.1">sudo</span></code><span class="koboSpan" id="kobo.258.1"> and ACLs</span><a id="_idIndexMarker1210"/><span class="koboSpan" id="kobo.259.1"> on</span><a id="_idIndexMarker1211"/><span class="koboSpan" id="kobo.260.1"> Linux. </span><span class="koboSpan" id="kobo.260.2">Let’s now see how to do it on FreeBSD 14.</span></p>
    <h3 id="_idParaDest-416" class="heading 3"><span class="koboSpan" id="kobo.261.1">Hands-on Lab – Setting an ACL for Horatio on FreeBSD 14</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.262.1">You’ll </span><a id="_idIndexMarker1212"/><span class="koboSpan" id="kobo.263.1">find everything you </span><a id="_idIndexMarker1213"/><span class="koboSpan" id="kobo.264.1">need for creating ACLs already installed on FreeBSD 14. </span><span class="koboSpan" id="kobo.264.2">Let’s begin.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.265.1">Create Horatio’s user account by doing:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.266.1">donnie@freebsd14:~ $ sudo adduser
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.267.1">The FreeBSD </span><code class="inlineCode"><span class="koboSpan" id="kobo.268.1">adduser</span></code><span class="koboSpan" id="kobo.269.1"> command is interactive, similar to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.270.1">adduser</span></code><span class="koboSpan" id="kobo.271.1"> command on Debian and Ubuntu. </span><span class="koboSpan" id="kobo.271.2">After you invoke it, you’ll just need to enter Horatio’s information, as prompted. </span><span class="koboSpan" id="kobo.271.3">Here’s what it looks like:</span></p>
    <figure class="mediaobject"><span class="koboSpan" id="kobo.272.1"><img src="../Images/B21693_20_01.png" alt="B21693_20_1"/></span></figure>
    <p class="packt_figref"><span class="koboSpan" id="kobo.273.1">Figure 20.1: Adding a user account to FreeBSD</span></p>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.274.1">In case you’re wondering about the </span><strong class="screenText"><span class="koboSpan" id="kobo.275.1">Full Name</span></strong><span class="koboSpan" id="kobo.276.1"> field, it’s just that Horatio really is a black cat who’s been visiting me lately.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="2"><span class="koboSpan" id="kobo.277.1">Use the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.279.1"> script that you used for the Linux lab. </span><span class="koboSpan" id="kobo.279.2">Copy it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.280.1">/usr/local/sbin/</span></code><span class="koboSpan" id="kobo.281.1"> directory, and verify that ownership has changed to the root user:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.282.1">donnie@freebsd14:~ $ sudo cp acl_demo.sh /usr/local/sbin/
Password:
donnie@freebsd14:~ $ cd /usr/local/sbin/
donnie@freebsd14:/usr/local/sbin $ ls -l acl_demo.sh
-rw-r--r--  1 root wheel 44 Jul 29 15:42 acl_demo.sh
donnie@freebsd14:/usr/local/sbin $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.283.1">Apply </span><a id="_idIndexMarker1214"/><span class="koboSpan" id="kobo.284.1">the 700 permissions setting to </span><code class="inlineCode"><span class="koboSpan" id="kobo.285.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.286.1">. </span><span class="koboSpan" id="kobo.286.2">This will mean that the root </span><a id="_idIndexMarker1215"/><span class="koboSpan" id="kobo.287.1">user will have read, write, and execute permissions, and that </span><em class="italic"><span class="koboSpan" id="kobo.288.1">group</span></em><span class="koboSpan" id="kobo.289.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.290.1">others</span></em><span class="koboSpan" id="kobo.291.1"> have no permissions.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.292.1">donnie@freebsd14:/usr/local/sbin $ sudo chmod 700 acl_demo.sh
donnie@freebsd14:/usr/local/sbin $ ls -l acl_demo.sh
-rwx------  1 root wheel 44 Jul 29 15:42 acl_demo.sh
donnie@freebsd14:/usr/local/sbin $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.293.1">In another terminal window, log into Horatio’s user account on the FreeBSD machine. </span><span class="koboSpan" id="kobo.293.2">Then, have him attempt to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.295.1"> script.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.296.1">horatio@freebsd14:~ $ acl_demo.sh
-sh: acl_demo.sh: Permission denied
horatio@freebsd14:~ $ sudo acl_demo.sh
Password:
horatio is not in the sudoers file.
</span><span class="koboSpan" id="kobo.296.2">This incident has been reported to the administrator.
</span><span class="koboSpan" id="kobo.296.3">horatio@freebsd14:~ $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.297.1">Go back to your own terminal window, and set the ACL for Horatio, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.298.1">donnie@freebsd14:/usr/local/sbin $ sudo setfacl -m u:horatio:rx:allow acl_demo.sh
Password:
donnie@freebsd14:/usr/local/sbin $
</span></code></pre>
        <div class="note one">
          <p class="normal"><span class="koboSpan" id="kobo.299.1">Note that </span><a id="_idIndexMarker1216"/><span class="koboSpan" id="kobo.300.1">the command is slightly different this time, because Linux uses the </span><strong class="keyWord"><span class="koboSpan" id="kobo.301.1">Network Filesystem version 4</span></strong><span class="koboSpan" id="kobo.302.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.303.1">NFSv4</span></strong><span class="koboSpan" id="kobo.304.1">) style of ACLs, and FreeBSD uses the POSIX style of ACLs. </span><span class="koboSpan" id="kobo.304.2">It’s not a big difference, though. </span><span class="koboSpan" id="kobo.304.3">It’s just that with FreeBSD, you have to add </span><code class="inlineCode"><span class="koboSpan" id="kobo.305.1">allow</span></code><span class="koboSpan" id="kobo.306.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.307.1">setfacl</span></code><span class="koboSpan" id="kobo.308.1"> command.</span></p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.309.1">Verify </span><a id="_idIndexMarker1217"/><span class="koboSpan" id="kobo.310.1">that the ACL has been properly set:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.311.1">donnie@freebsd14:/usr/local/sbin $ getfacl acl_demo.sh
# file: acl_demo.sh
# owner: root
# group: wheel
      user:horatio:r-x-----------:-------:allow
            owner@:rwxp--aARWcCos:-------:allow
            group@:------a-R-c--s:-------:allow
         everyone@:------a-R-c--s:-------:allow
donnie@freebsd14:/usr/local/sbin $
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.312.1">You </span><a id="_idIndexMarker1218"/><span class="koboSpan" id="kobo.313.1">see that indeed, Horatio does have read and execute permissions for this script.</span></p>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.314.1">Go back to Horatio’s terminal, and have him try to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.315.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.316.1"> command:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.317.1">horatio@freebsd14:~ $ acl_demo.sh
This is a demo of ACLs.
</span><span class="koboSpan" id="kobo.317.2">horatio@freebsd14:~ $
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.318.1">It works, which </span><a id="_idIndexMarker1219"/><span class="koboSpan" id="kobo.319.1">means </span><a id="_idIndexMarker1220"/><span class="koboSpan" id="kobo.320.1">that Horatio has now achieved coolness on FreeBSD.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.321.1">Next, let’s give this a try on OpenIndiana.</span></p>
    <h3 id="_idParaDest-417" class="heading 3"><span class="koboSpan" id="kobo.322.1">Hands-on Lab – Setting an ACL for Horatio on OpenIndiana</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.323.1">Doing this on OpenIndiana will be considerably different, because it doesn’t use </span><code class="inlineCode"><span class="koboSpan" id="kobo.324.1">setfacl</span></code><span class="koboSpan" id="kobo.325.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.326.1">getfacl</span></code><span class="koboSpan" id="kobo.327.1"> to manage ACLs. </span><span class="koboSpan" id="kobo.327.2">Instead, it uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.328.1">chmod</span></code><span class="koboSpan" id="kobo.329.1"> for managing both normal permissions </span><a id="_idIndexMarker1221"/><span class="koboSpan" id="kobo.330.1">settings and ACLs. </span><span class="koboSpan" id="kobo.330.2">You’ll </span><a id="_idIndexMarker1222"/><span class="koboSpan" id="kobo.331.1">once again use the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.332.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.333.1"> script that you used for the previous labs.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.334.1">Create Horatio’s user account, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.335.1">donnie@openindiana:~$ sudo useradd -m horatio
donnie@openindiana:~$ sudo passwd horatio
donnie@openindiana:~$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.336.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.337.1">-m</span></code><span class="koboSpan" id="kobo.338.1"> option tells </span><code class="inlineCode"><span class="koboSpan" id="kobo.339.1">useradd</span></code><span class="koboSpan" id="kobo.340.1"> to create the new user’s home directory. </span><span class="koboSpan" id="kobo.340.2">On the OpenIndiana version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.341.1">useradd</span></code><span class="koboSpan" id="kobo.342.1">, this is normally the only option switch that you’ll need.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="2"><span class="koboSpan" id="kobo.343.1">There’s no </span><code class="inlineCode"><span class="koboSpan" id="kobo.344.1">/usr/local/</span></code><span class="koboSpan" id="kobo.345.1"> directory on OpenIndiana, so just copy the </span><code class="inlineCode"><span class="koboSpan" id="kobo.346.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.347.1"> script to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.348.1">/usr/sbin/</span></code><span class="koboSpan" id="kobo.349.1"> directory, instead. </span><span class="koboSpan" id="kobo.349.2">Then, verify that the ownership has changed to the root user.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.350.1">donnie@openindiana:~$ sudo cp acl_demo.sh /usr/sbin/
donnie@openindiana:~$ cd /usr/sbin/
donnie@openindiana:/usr/sbin$ ls -l acl_demo.sh
-rw-r--r--   1 root     root          44 Jul 29 16:14 acl_demo.sh
donnie@openindiana:/usr/sbin$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.351.1">Change the permissions setting of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.352.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.353.1"> file to 700, as you did in the previous labs:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.354.1">donnie@openindiana:/usr/sbin$ sudo chmod 700 acl_demo.sh
donnie@openindiana:/usr/sbin$ ls -l acl_demo.sh
-rwx------   1 root     root          44 Jul 29 16:14 acl_demo.sh
donnie@openindiana:/usr/sbin$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.355.1">In another terminal window, log into Horatio’s account. </span><span class="koboSpan" id="kobo.355.2">Have him try to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.356.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.357.1"> script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.358.1">horatio@openindiana:~$ acl_demo.sh
-bash: /usr/sbin/acl_demo.sh: Permission denied
horatio@openindiana:~$ sudo acl_demo.sh
Password:
horatio is not in the sudoers file.
</span><span class="koboSpan" id="kobo.358.2">This incident has been reported to the administrator.
</span><span class="koboSpan" id="kobo.358.3">horatio@openindiana:~$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.359.1">Now, apply </span><a id="_idIndexMarker1223"/><span class="koboSpan" id="kobo.360.1">an ACL for Horatio, granting him both read and execute privileges </span><a id="_idIndexMarker1224"/><span class="koboSpan" id="kobo.361.1">for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.362.1">acl_demo.sh</span></code><span class="koboSpan" id="kobo.363.1"> script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.364.1">donnie@openindiana:/usr/sbin$ sudo chmod A+user:horatio:rx:allow acl_demo.sh
Password:
donnie@openindiana:/usr/sbin$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.365.1">Note how instead of using </span><code class="inlineCode"><span class="koboSpan" id="kobo.366.1">setfacl -m u:horatio</span></code><span class="koboSpan" id="kobo.367.1">, OpenIndiana uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.368.1">chmod A+user:horatio</span></code><span class="koboSpan" id="kobo.369.1">. </span><span class="koboSpan" id="kobo.369.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">A+</span></code><span class="koboSpan" id="kobo.371.1"> in this case just means that we’re adding an ACL.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.372.1">Go back to Horatio’s terminal, and have him try to run the script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.373.1">horatio@openindiana:~$ acl_demo.sh
This is a demo of ACLs.
</span><span class="koboSpan" id="kobo.373.2">horatio@openindiana:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.374.1">Yes, indeed. </span><span class="koboSpan" id="kobo.374.2">Even on OpenIndiana, Horatio has achieved coolness.</span></p>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.375.1">If you need to learn about OpenIndiana administration, you’ll find that the official documentation at the OpenIndiana website is rather lacking. </span><span class="koboSpan" id="kobo.375.2">Fortunately, OpenIndiana is a fork of Oracle’s Solaris operating system, which means that you can use the official Solaris documentation, instead. </span><span class="koboSpan" id="kobo.375.3">(I’ve placed a link to the relevant page in the </span><em class="italic"><span class="koboSpan" id="kobo.376.1">Further Reading</span></em><span class="koboSpan" id="kobo.377.1"> section.)</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.378.1">I think that that </span><a id="_idIndexMarker1225"/><span class="koboSpan" id="kobo.379.1">about</span><a id="_idIndexMarker1226"/><span class="koboSpan" id="kobo.380.1"> covers it for ACLs. </span><span class="koboSpan" id="kobo.380.2">Let’s move on to another way to control access to your scripts.</span></p>
    <h2 id="_idParaDest-418" class="heading 2"><span class="koboSpan" id="kobo.381.1">Obfuscating Plain-Text Scripts</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.382.1">You can also hide the contents of your shell scripts and prevent anyone from tampering with them </span><a id="_idIndexMarker1227"/><span class="koboSpan" id="kobo.383.1">by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">shc</span></code><span class="koboSpan" id="kobo.385.1"> utility to convert your scripts </span><a id="_idIndexMarker1228"/><span class="koboSpan" id="kobo.386.1">into obfuscated executable binary files. </span><span class="koboSpan" id="kobo.386.2">And, you can do some things with </span><code class="inlineCode"><span class="koboSpan" id="kobo.387.1">shc</span></code><span class="koboSpan" id="kobo.388.1"> that you can’t do with either </span><code class="inlineCode"><span class="koboSpan" id="kobo.389.1">sudo</span></code><span class="koboSpan" id="kobo.390.1"> or ACLs. </span><span class="koboSpan" id="kobo.390.2">Specifically, </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">shc</span></code><span class="koboSpan" id="kobo.392.1"> allows you to:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.393.1">Create an executable file that can run on only one machine.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.394.1">Set expiration dates for the executable files.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.395.1">Create executable files that can’t be traced with debugging utilities such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.396.1">strace</span></code><span class="koboSpan" id="kobo.397.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.398.1">truss</span></code><span class="koboSpan" id="kobo.399.1">. </span><span class="koboSpan" id="kobo.399.2">(I’ll explain those in just a bit.)</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.400.1">Let’s begin by installing </span><code class="inlineCode"><span class="koboSpan" id="kobo.401.1">shc</span></code><span class="koboSpan" id="kobo.402.1">.</span></p>
    <h3 id="_idParaDest-419" class="heading 3"><span class="koboSpan" id="kobo.403.1">Installing shc</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.404.1">It’s easy </span><a id="_idIndexMarker1229"/><span class="koboSpan" id="kobo.405.1">to install on Linux, FreeBSD, and macOS. </span><span class="koboSpan" id="kobo.405.2">Here’s </span><a id="_idIndexMarker1230"/><span class="koboSpan" id="kobo.406.1">how it’s done:</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.407.1">On Fedora:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.408.1">sudo dnf install shc gcc
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.409.1">On Debian/Ubuntu:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.410.1">sudo apt install shc gcc
</span></code></pre>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.411.1">Note that on Linux, you also need to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.412.1">gcc</span></code><span class="koboSpan" id="kobo.413.1"> package so that you will have a C compiler that will work with </span><code class="inlineCode"><span class="koboSpan" id="kobo.414.1">shc</span></code><span class="koboSpan" id="kobo.415.1">. </span><span class="koboSpan" id="kobo.415.2">On FreeBSD, the C compiler gets installed as part of the operating system.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.416.1">On FreeBSD:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.417.1">sudo pkg install shc
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.418.1">On macOS</span><a id="_idIndexMarker1231"/><span class="koboSpan" id="kobo.419.1"> with </span><a id="_idIndexMarker1232"/><span class="koboSpan" id="kobo.420.1">Homebrew installed:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.421.1">brew install shc
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.422.1">Sadly, </span><code class="inlineCode"><span class="koboSpan" id="kobo.423.1">shc</span></code><span class="koboSpan" id="kobo.424.1"> isn’t available for OpenIndiana.</span></p>
    <h3 id="_idParaDest-420" class="heading 3"><span class="koboSpan" id="kobo.425.1">Hands-on Lab – Using shc</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.426.1">For this lab, you’ll create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.427.1">supersecret.sh</span></code><span class="koboSpan" id="kobo.428.1"> script on your Fedora virtual machine. </span><span class="koboSpan" id="kobo.428.2">Also, go ahead </span><a id="_idIndexMarker1233"/><span class="koboSpan" id="kobo.429.1">and boot up your Debian/Ubuntu virtual machine, so that you </span><a id="_idIndexMarker1234"/><span class="koboSpan" id="kobo.430.1">can test your compiled scripts on it.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.431.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.432.1">shc</span></code><span class="koboSpan" id="kobo.433.1"> is simple. </span><span class="koboSpan" id="kobo.433.2">To demo, let’s create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.434.1">supersecret.sh</span></code><span class="koboSpan" id="kobo.435.1"> script, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.436.1">#!/bin/bash
cat &lt;&lt; secret
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.436.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.436.3">secret
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.437.1">This is just a simple </span><em class="italic"><span class="koboSpan" id="kobo.438.1">here document</span></em><span class="koboSpan" id="kobo.439.1"> that prints out a message, which looks like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.440.1">donnie@fedora:~$ ./supersecret.sh
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.440.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.440.3">donnie@fedora:~$
</span></code></pre>
    <ol>
      <li class="numberedList" value="2"><span class="koboSpan" id="kobo.441.1">The next step is to convert the shell script into an obfuscated binary file, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.442.1">donnie@fedora:~$ shc -f supersecret.sh -o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.443.1">As you see, I’m using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">-f</span></code><span class="koboSpan" id="kobo.445.1"> option to point to the shell script that I want to obfuscate, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.446.1">-o</span></code><span class="koboSpan" id="kobo.447.1"> option to save the obfuscated binary file with the specified filename. </span><span class="koboSpan" id="kobo.447.2">This operation also creates a C language source file, as you see here:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.448.1">donnie@fedora:~$ ls -l supersecret*
-rwxrwxr-x. </span><span class="koboSpan" id="kobo.448.2">1 donnie donnie 15984 Jul  1 16:55 supersecret
-rwxr--r--. </span><span class="koboSpan" id="kobo.448.3">1 donnie donnie   149 Jul  1 16:47 supersecret.sh
-rw-r--r--. </span><span class="koboSpan" id="kobo.448.4">1 donnie donnie 18485 Jul  1 16:55 supersecret.sh.x.c
donnie@fedora:~$
</span></code></pre>
    <p class="normal one"><code class="inlineCode"><span class="koboSpan" id="kobo.449.1">shc</span></code><span class="koboSpan" id="kobo.450.1"> works by first creating this C source code file, and then by calling a C compiler </span><a id="_idIndexMarker1235"/><span class="koboSpan" id="kobo.451.1">to compile the C source code into the binary file. </span><span class="koboSpan" id="kobo.451.2">You can </span><a id="_idIndexMarker1236"/><span class="koboSpan" id="kobo.452.1">prove that this works by trying to open the binary file with </span><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">cat</span></code><span class="koboSpan" id="kobo.454.1">, like so:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.455.1">donnie@fedora:~$ cat supersecret
@@@@@@</span><span class="koboSpan" id="kobo.456.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.457.1">@@@@</span><span class="koboSpan" id="kobo.458.1"><img src="../Images/unicode_01_001.png" alt=""/></span>
<span class="koboSpan" id="kobo.459.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.460.1">
@@a
   a
      @ @dd</span><span class="koboSpan" id="kobo.461.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.462.1">-</span><span class="koboSpan" id="kobo.463.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.464.1">=@</span><span class="koboSpan" id="kobo.465.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.466.1">=@</span><span class="koboSpan" id="kobo.467.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.468.1">&gt;&gt;@</span><span class="koboSpan" id="kobo.469.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.470.1">88@8@@xx@x@DDS</span><span class="koboSpan" id="kobo.471.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.472.1">td88@8@@P</span><span class="koboSpan" id="kobo.473.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.474.1">td` ` @` @llQ</span><span class="koboSpan" id="kobo.475.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.476.1">tdR</span><span class="koboSpan" id="kobo.477.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.478.1">td</span><span class="koboSpan" id="kobo.479.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.480.1">-</span><span class="koboSpan" id="kobo.481.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.482.1">=@</span><span class="koboSpan" id="kobo.483.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.484.1">/lib64/ld-linux-x86-64.so.20GNU</span><span class="koboSpan" id="kobo.485.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.486.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.487.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.488.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.489.1">GNUu[</span><span class="koboSpan" id="kobo.490.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.491.1">C</span><span class="koboSpan" id="kobo.492.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.493.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.494.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.495.1">@W</span><span class="koboSpan" id="kobo.496.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.497.1">{</span><span class="koboSpan" id="kobo.498.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.499.1">g</span><span class="koboSpan" id="kobo.500.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.501.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.502.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.503.1">GNU0</span><span class="koboSpan" id="kobo.504.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.505.1">@</span><span class="koboSpan" id="kobo.506.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.507.1">ĉ</span><span class="koboSpan" id="kobo.508.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.509.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.510.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.511.1">kĹ</span><span class="koboSpan" id="kobo.512.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.513.1">@9</span><span class="koboSpan" id="kobo.514.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.515.1">J&lt;5Q</span><span class="koboSpan" id="kobo.516.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.517.1">.u n</span><span class="koboSpan" id="kobo.518.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.519.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.520.1">`X</span><span class="koboSpan" id="kobo.521.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.522.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.523.1">C{</span><span class="koboSpan" id="kobo.524.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.525.1">!D</span><span class="koboSpan" id="kobo.526.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.527.1">!D</span><span class="koboSpan" id="kobo.528.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.529.1">Dg Dmallocgetpidstat__libc_start_mainfprintfputenvmemsetstrlenstrdupgetenvmemcmpsprintfexecvpstderrmemcpyato llstrerror__errno_locationexit__isoc99_sscanffwritecalloctime__environlibc.so.6GLIBC_2.7GLIBC_2.14GLIBC_2.33GLIBC_2.34GLIB</span><span class="koboSpan" id="kobo.530.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.531.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.532.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.533.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.534.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.535.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.536.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.537.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.538.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.539.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.540.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.541.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.542.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.543.1">u</span><span class="koboSpan" id="kobo.544.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.545.1">iart__</span><span class="koboSpan" id="kobo.546.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.547.1">ii</span><span class="koboSpan" id="kobo.548.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.549.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.550.1">?@</span><span class="koboSpan" id="kobo.551.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.552.1">?@
. </span><span class="koboSpan" id="kobo.552.2">. </span><span class="koboSpan" id="kobo.552.3">.
</span><span class="koboSpan" id="kobo.552.4">donnie@fedora:~$
</span></code></pre>
    <p class="normal one"><span class="koboSpan" id="kobo.553.1">If you can read that, then you’re better than I am.</span></p>
    <ol>
      <li class="numberedList" value="3"><span class="koboSpan" id="kobo.554.1">Try running this new </span><code class="inlineCode"><span class="koboSpan" id="kobo.555.1">supersecret</span></code><span class="koboSpan" id="kobo.556.1"> binary, and you’ll see that it works just like the script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.557.1">donnie@fedora:~$ ./supersecret
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.557.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.557.3">donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.558.1">Okay, let’s be real. </span><span class="koboSpan" id="kobo.558.2">You’re not going to obfuscate a simple script that does nothing but print out a message. </span><span class="koboSpan" id="kobo.558.3">I mean, anyone who can execute this binary file can still see the message. </span><span class="koboSpan" id="kobo.558.4">So, let’s just say that your script contains a lot of additional code or data that you want to hide from everyone, including even the authorized users of the script. </span><span class="koboSpan" id="kobo.558.5">You also want to ensure that nobody can modify your scripts. </span><span class="koboSpan" id="kobo.558.6">In cases like that, </span><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">shc</span></code><span class="koboSpan" id="kobo.560.1"> is definitely a useful tool.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.561.1">By default, </span><code class="inlineCode"><span class="koboSpan" id="kobo.562.1">shc</span></code><span class="koboSpan" id="kobo.563.1"> creates binary files that will only run on the machine on which </span><a id="_idIndexMarker1237"/><span class="koboSpan" id="kobo.564.1">they were created. </span><span class="koboSpan" id="kobo.564.2">For example, let’s see what happens </span><a id="_idIndexMarker1238"/><span class="koboSpan" id="kobo.565.1">when I transfer the </span><code class="inlineCode"><span class="koboSpan" id="kobo.566.1">supersecret</span></code><span class="koboSpan" id="kobo.567.1"> binary that I created on this Fedora machine to an Ubuntu machine:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.568.1">donnie@ubuntu2404:~$ ./supersecret
./supersecret: 3(</span><span class="koboSpan" id="kobo.569.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.570.1">i</span><span class="koboSpan" id="kobo.571.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.572.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.573.1">'(</span><span class="koboSpan" id="kobo.574.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.575.1">qX5</span><span class="koboSpan" id="kobo.576.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.577.1">@</span><span class="koboSpan" id="kobo.578.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.579.1">ӣ</span><span class="koboSpan" id="kobo.580.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.581.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.582.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.583.1">ZBhas expired!
</span><span class="koboSpan" id="kobo.583.2">Please contact your provider jahidulhamid@yahoo.com
donnie@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.584.1">That’s definitely a handy security feature, because it allows you to control where your program can be run. </span><span class="koboSpan" id="kobo.584.2">So, if a malicious hacker were to somehow find your program and download it, he or she wouldn’t be able to run it. </span><span class="koboSpan" id="kobo.584.3">The only catch is that we see the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.585.1">Please contact your provider. </span><span class="koboSpan" id="kobo.585.2">. </span><span class="koboSpan" id="kobo.585.3">.</span></code><span class="koboSpan" id="kobo.586.1"> message that’s built into </span><code class="inlineCode"><span class="koboSpan" id="kobo.587.1">shc</span></code><span class="koboSpan" id="kobo.588.1">.</span></p>
    <ol>
      <li class="numberedList" value="5"><span class="koboSpan" id="kobo.589.1">The default </span><code class="inlineCode"><span class="koboSpan" id="kobo.590.1">Please contact your provider. </span><span class="koboSpan" id="kobo.590.2">. </span><span class="koboSpan" id="kobo.590.3">.</span></code><span class="koboSpan" id="kobo.591.1"> message doesn’t mean anything to us, because it provides us with a bogus contact address. </span><span class="koboSpan" id="kobo.591.2">On the Fedora machine, fix that by adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.592.1">-m</span></code><span class="koboSpan" id="kobo.593.1"> option and a custom message, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.594.1">donnie@fedora:~$ shc -f supersecret.sh -m "You cannot run this program on this machine." </span><span class="koboSpan" id="kobo.594.2">-o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.595.1">Transfer the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">supersecret</span></code><span class="koboSpan" id="kobo.597.1"> binary file to the Debian/Ubuntu machine, and try to run it. </span><span class="koboSpan" id="kobo.597.2">You should now see your custom message, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.598.1">donnie@ubuntu2404:~$ ./supersecret
./supersecret: </span><span class="koboSpan" id="kobo.599.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.600.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.601.1">]b+    </span><span class="koboSpan" id="kobo.602.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.603.1">!</span><span class="koboSpan" id="kobo.604.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.605.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.606.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.607.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.608.1">(</span><span class="koboSpan" id="kobo.609.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.610.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.611.1">TR</span><span class="koboSpan" id="kobo.612.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.613.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.614.1">0#50</span><span class="koboSpan" id="kobo.615.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.616.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.617.1">fo_</span><span class="koboSpan" id="kobo.618.1"><img src="../Images/unicode_01_001.png" alt=""/></span><span class="koboSpan" id="kobo.619.1">7has expired!
</span><span class="koboSpan" id="kobo.619.2">You cannot run this program on this machine.
</span><span class="koboSpan" id="kobo.619.3">donnie@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.620.1">Of course, you could also add your own contact address, if you really wanted to.</span></p>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.621.1">Sometimes though, you might want to create binary files that will run on any machine that’s running the same operating system as the machine on which </span><a id="_idIndexMarker1239"/><span class="koboSpan" id="kobo.622.1">you created them. </span><span class="koboSpan" id="kobo.622.2">To do that, just relax the security a bit with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.623.1">-r</span></code><span class="koboSpan" id="kobo.624.1"> option, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.625.1">donnie@fedora:~$ shc -rf supersecret.sh -o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.626.1">When I transfer </span><a id="_idIndexMarker1240"/><span class="koboSpan" id="kobo.627.1">this new binary file to my Ubuntu machine, it will run just fine, as you see here:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.628.1">donnie@ubuntu2404:~$ ./supersecret
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.628.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.628.3">donnie@ubuntu2404:~$
</span></code></pre>
    <ol>
      <li class="numberedList" value="8"><span class="koboSpan" id="kobo.629.1">Also, understand that </span><code class="inlineCode"><span class="koboSpan" id="kobo.630.1">shc</span></code><span class="koboSpan" id="kobo.631.1"> creates binary files that can run on only one type of operating system. </span><span class="koboSpan" id="kobo.631.2">To see how that works, let’s transfer the binary that I created on my Fedora machine to a FreeBSD machine. </span><span class="koboSpan" id="kobo.631.3">Here’s what happens when I try to run it:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.632.1">donnie@freebsd14:~ $ ./supersecret
ELF binary type "0" not known.
</span><span class="koboSpan" id="kobo.632.2">-sh: ./supersecret: Exec format error
donnie@freebsd14:~ $
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.633.1">But, if you transfer the original script to the FreeBSD machine and then run </span><code class="inlineCode"><span class="koboSpan" id="kobo.634.1">shc</span></code><span class="koboSpan" id="kobo.635.1"> on it, you’ll get a binary that will run on FreeBSD.</span></p>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.636.1">The good news here is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.637.1">shc</span></code><span class="koboSpan" id="kobo.638.1"> works exactly the same on FreeBSD as it does on Linux. </span><span class="koboSpan" id="kobo.638.2">So, you won’t even have to modify your </span><code class="inlineCode"><span class="koboSpan" id="kobo.639.1">shc</span></code><span class="koboSpan" id="kobo.640.1"> commands.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="9"><span class="koboSpan" id="kobo.641.1">The next </span><code class="inlineCode"><span class="koboSpan" id="kobo.642.1">shc</span></code><span class="koboSpan" id="kobo.643.1"> option I’ll cover is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.644.1">-e</span></code><span class="koboSpan" id="kobo.645.1"> option, which allows you to set an expiration date on your program. </span><span class="koboSpan" id="kobo.645.2">Just specify the expiration date in the day-month-year (dd/mm/yyyy) format, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.646.1">donnie@fedora:~$ shc -e 02/07/2024 -rf supersecret.sh -m "This binary file has expired. </span><span class="koboSpan" id="kobo.646.2">Contact me at donnie@any.net if you really need to run it." </span><span class="koboSpan" id="kobo.646.3">-o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.647.1">I’m doing </span><a id="_idIndexMarker1241"/><span class="koboSpan" id="kobo.648.1">this on 1 July 2024, so I’ll have to come back tomorrow </span><a id="_idIndexMarker1242"/><span class="koboSpan" id="kobo.649.1">to see if this actually works. </span><span class="koboSpan" id="kobo.649.2">So bye for now, I’ll see you tomorrow.</span></p>
    <ol>
      <li class="numberedList" value="10"><span class="koboSpan" id="kobo.650.1">Okay, it’s now 2 July 2024, and I’m back. </span><span class="koboSpan" id="kobo.650.2">Let’s see if this </span><code class="inlineCode"><span class="koboSpan" id="kobo.651.1">supersecret</span></code><span class="koboSpan" id="kobo.652.1"> binary file still works:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.653.1">donnie@fedora:~$ ./supersecret
./supersecret: has expired!
</span><span class="koboSpan" id="kobo.653.2">This binary file has expired. </span><span class="koboSpan" id="kobo.653.3">Contact me at donnie@any.net if you really need to run it.
</span><span class="koboSpan" id="kobo.653.4">donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.654.1">Cool, the expiration</span><a id="_idIndexMarker1243"/><span class="koboSpan" id="kobo.655.1"> date </span><a id="_idIndexMarker1244"/><span class="koboSpan" id="kobo.656.1">option works just fine.</span></p>
    <div class="note">
      <p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.657.1">Remember</span></strong><span class="koboSpan" id="kobo.658.1">: Even when you obfuscate your scripts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.659.1">shc</span></code><span class="koboSpan" id="kobo.660.1">, you’ll still need to use either </span><code class="inlineCode"><span class="koboSpan" id="kobo.661.1">sudo</span></code><span class="koboSpan" id="kobo.662.1"> or an ACL to control who can execute them on a particular machine.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.663.1">Now, let’s see about making our executables untraceable.</span></p>
    <h3 id="_idParaDest-421" class="heading 3"><span class="koboSpan" id="kobo.664.1">Hands-on Lab – Creating Untraceable Executables</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.665.1">As you’ll see in the next chapter, we have several tracing tools available to help programmers </span><a id="_idIndexMarker1245"/><span class="koboSpan" id="kobo.666.1">debug programs. </span><span class="koboSpan" id="kobo.666.2">These </span><a id="_idIndexMarker1246"/><span class="koboSpan" id="kobo.667.1">tools include </span><code class="inlineCode"><span class="koboSpan" id="kobo.668.1">strace</span></code><span class="koboSpan" id="kobo.669.1"> for Linux systems, </span><code class="inlineCode"><span class="koboSpan" id="kobo.670.1">truss</span></code><span class="koboSpan" id="kobo.671.1"> for FreeBSD, and either </span><code class="inlineCode"><span class="koboSpan" id="kobo.672.1">dtrace</span></code><span class="koboSpan" id="kobo.673.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.674.1">dtruss</span></code><span class="koboSpan" id="kobo.675.1"> for macOS. </span><span class="koboSpan" id="kobo.675.2">For Linux, there’s also </span><code class="inlineCode"><span class="koboSpan" id="kobo.676.1">ltrace</span></code><span class="koboSpan" id="kobo.677.1">, which can trace calls to programming libraries.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.678.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.679.1">strace</span></code><span class="koboSpan" id="kobo.680.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">dtrace</span></code><span class="koboSpan" id="kobo.682.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">truss</span></code><span class="koboSpan" id="kobo.684.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.685.1">dtruss</span></code><span class="koboSpan" id="kobo.686.1"> utilities can trace the </span><strong class="keyWord"><span class="koboSpan" id="kobo.687.1">system calls</span></strong><span class="koboSpan" id="kobo.688.1"> that a program makes. </span><span class="koboSpan" id="kobo.688.2">The easiest way to explain system calls is that they’re the mechanism that programs use to communicate with the operating system kernel.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.689.1">The problem for us is that either a malicious actor or an unauthorized non-malicious actor could </span><a id="_idIndexMarker1247"/><span class="koboSpan" id="kobo.690.1">also use the information </span><a id="_idIndexMarker1248"/><span class="koboSpan" id="kobo.691.1">that these utilities provide to reverse engineer one of your compiled scripts. </span><span class="koboSpan" id="kobo.691.2">This could allow these unauthorized parties to see secrets that you don’t want them to see.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.692.1">What information would we not want unauthorized people to see? </span><span class="koboSpan" id="kobo.692.2">Here are two examples:</span></p>
      <p class="normal"> <strong class="keyWord"><span class="koboSpan" id="kobo.693.1">The names and locations of sensitive files that your program accesses</span></strong><span class="koboSpan" id="kobo.694.1">: These files could reveal secrets to unauthorized actors.</span></p>
      <p class="normal"> <strong class="keyWord"><span class="koboSpan" id="kobo.695.1">Embedded passwords</span></strong><span class="koboSpan" id="kobo.696.1">: Even </span><a id="_idIndexMarker1249"/><span class="koboSpan" id="kobo.697.1">if you encrypt passwords, using </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">strace</span></code><span class="koboSpan" id="kobo.699.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.700.1">truss</span></code><span class="koboSpan" id="kobo.701.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.702.1">dtrace</span></code><span class="koboSpan" id="kobo.703.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.704.1">dtruss</span></code><span class="koboSpan" id="kobo.705.1"> on your compiled binary file will reveal the plain-text passwords. </span><span class="koboSpan" id="kobo.705.2">(You’ll soon see that in the </span><em class="italic"><span class="koboSpan" id="kobo.706.1">Avoiding Sensitive Data Leakage</span></em><span class="koboSpan" id="kobo.707.1"> section.)</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.708.1">Needless to say, either of these cases can represent a serious security problem. </span><span class="koboSpan" id="kobo.708.2">So to be sure, just get into the habit of making your </span><code class="inlineCode"><span class="koboSpan" id="kobo.709.1">shc</span></code><span class="koboSpan" id="kobo.710.1"> binaries untraceable, as I’m about to show you in this section.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.711.1">Here’s how it works:</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.712.1">On the Fedora machine, install </span><code class="inlineCode"><span class="koboSpan" id="kobo.713.1">strace</span></code><span class="koboSpan" id="kobo.714.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.715.1">ltrace</span></code><span class="koboSpan" id="kobo.716.1">, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.717.1">donnie@fedora:~$ sudo dnf install strace ltrace
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.718.1">On the Fedora machine, create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.719.1">supersecret</span></code><span class="koboSpan" id="kobo.720.1"> binary without either the expiration date or the custom message.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.721.1">donnie@fedora:~$ shc -f supersecret.sh -o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.722.1">Create a file that contains </span><code class="inlineCode"><span class="koboSpan" id="kobo.723.1">strace</span></code><span class="koboSpan" id="kobo.724.1"> data about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.725.1">supersecret</span></code><span class="koboSpan" id="kobo.726.1"> binary, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.727.1">donnie@fedora:~$ strace ./supersecret 2&gt; supersecret1_trace.txt
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.727.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.727.3">donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.728.1">Note that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">strace</span></code><span class="koboSpan" id="kobo.730.1"> output gets sent to </span><code class="inlineCode"><span class="koboSpan" id="kobo.731.1">stderr</span></code><span class="koboSpan" id="kobo.732.1">, which is why you have to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">2&gt;</span></code><span class="koboSpan" id="kobo.734.1"> redirector.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.735.1">Open </span><a id="_idIndexMarker1250"/><span class="koboSpan" id="kobo.736.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">supersecret1_trace.txt</span></code><span class="koboSpan" id="kobo.738.1"> file in less. </span><span class="koboSpan" id="kobo.738.2">What you’ll see is a jumbled up mess that </span><a id="_idIndexMarker1251"/><span class="koboSpan" id="kobo.739.1">looks something like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.740.1">execve("./supersecret", ["./supersecret"], 0x7ffd6152bd00 /* 58 vars */) = 0
brk(NULL)                               = 0x14345000
arch_prctl(0x3001 /* ARCH_??? </span><span class="koboSpan" id="kobo.740.2">*/, 0x7ffe27faa7c0) = -1 EINVAL (Invalid argument)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
. </span><span class="koboSpan" id="kobo.740.3">. </span><span class="koboSpan" id="kobo.740.4">.
</span><span class="koboSpan" id="kobo.740.5">. </span><span class="koboSpan" id="kobo.740.6">. </span><span class="koboSpan" id="kobo.740.7">.
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.741.1">For the most part, you would need to be a C language kernel programmer to understand what’s going on with this. </span><span class="koboSpan" id="kobo.741.2">However, as we’ll soon see, you might be able to glean some really important information if you know how to look for it.</span></p>
    <ol>
      <li class="numberedList" value="5"><span class="koboSpan" id="kobo.742.1">Count how many lines are in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">supersecret1_trace.txt</span></code><span class="koboSpan" id="kobo.744.1"> file, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.745.1">donnie@fedora:~$ wc -l supersecret1_trace.txt
297 supersecret1_trace.txt
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.746.1">So, there are 297 lines of output in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.747.1">supersecret1_trace.txt</span></code><span class="koboSpan" id="kobo.748.1"> file.</span></p>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.749.1">Note that for all of these examples, you might get a different number of output lines on your own machines.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.750.1">Perform </span><a id="_idIndexMarker1252"/><span class="koboSpan" id="kobo.751.1">an </span><code class="inlineCode"><span class="koboSpan" id="kobo.752.1">ltrace</span></code><span class="koboSpan" id="kobo.753.1"> operation </span><a id="_idIndexMarker1253"/><span class="koboSpan" id="kobo.754.1">on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.755.1">supersecret</span></code><span class="koboSpan" id="kobo.756.1"> binary, saving the output to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.757.1">supersecret1_ltrace.txt</span></code><span class="koboSpan" id="kobo.758.1"> file. </span><span class="koboSpan" id="kobo.758.2">Then, count the number of lines in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">supersecret1_ltrace.txt</span></code><span class="koboSpan" id="kobo.760.1"> file, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.761.1">donnie@fedora:~$ ltrace ./supersecret 2&gt; supersecret1_ltrace.txt
This document contains secrets that could impact the entire world!
</span><span class="koboSpan" id="kobo.761.2">Please don't let it fall into the wrong hands.
</span><span class="koboSpan" id="kobo.761.3">donnie@fedora:~$ wc -l supersecret1_ltrace.txt
7270 supersecret1_ltrace.txt
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.762.1">You see that there are 7270 lines in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">supersecret1_ltrace</span></code><span class="koboSpan" id="kobo.764.1"> file.</span></p>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.765.1">Create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.766.1">supersecret</span></code><span class="koboSpan" id="kobo.767.1"> binary. </span><span class="koboSpan" id="kobo.767.2">This time though, use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.768.1">-U</span></code><span class="koboSpan" id="kobo.769.1"> option to make this binary untraceable.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.770.1">donnie@fedora:~$ shc -Uf supersecret.sh -o supersecret
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.771.1">You won’t have to delete the original binary before you do this, because this new command will overwrite the original binary.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="8"><span class="koboSpan" id="kobo.772.1">Run </span><code class="inlineCode"><span class="koboSpan" id="kobo.773.1">strace</span></code><span class="koboSpan" id="kobo.774.1"> on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.775.1">supersecret</span></code><span class="koboSpan" id="kobo.776.1"> binary again, saving the output to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.777.1">supersecret2_tract.txt</span></code><span class="koboSpan" id="kobo.778.1"> file.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.779.1">donnie@fedora:~$ strace ./supersecret 2&gt; supersecret2_trace.txt
Killed
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.780.1">This time, </span><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">strace</span></code><span class="koboSpan" id="kobo.782.1"> was prevented from doing its job.</span></p>
    <ol>
      <li class="numberedList" value="9"><span class="koboSpan" id="kobo.783.1">Even with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.784.1">-U</span></code><span class="koboSpan" id="kobo.785.1"> option, you’ll still get some output sent to the output file. </span><span class="koboSpan" id="kobo.785.2">However, it will be much less than you got without the </span><code class="inlineCode"><span class="koboSpan" id="kobo.786.1">-U</span></code><span class="koboSpan" id="kobo.787.1">. </span><span class="koboSpan" id="kobo.787.2">Verify that by counting the lines in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.788.1">supersecret2_trace.txt</span></code><span class="koboSpan" id="kobo.789.1"> file.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.790.1">donnie@fedora:~$ wc -l supersecret2_trace.txt
34 supersecret2_trace.txt
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.791.1">This time, there are only 34 lines of output, which is way less than the 297 lines that </span><a id="_idIndexMarker1254"/><span class="koboSpan" id="kobo.792.1">we had </span><a id="_idIndexMarker1255"/><span class="koboSpan" id="kobo.793.1">without the </span><code class="inlineCode"><span class="koboSpan" id="kobo.794.1">-U</span></code><span class="koboSpan" id="kobo.795.1"> switch. </span><span class="koboSpan" id="kobo.795.2">So, this is further proof that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.796.1">-U</span></code><span class="koboSpan" id="kobo.797.1"> option prevents an </span><code class="inlineCode"><span class="koboSpan" id="kobo.798.1">strace</span></code><span class="koboSpan" id="kobo.799.1"> operation from being successful.</span></p>
    <ol>
      <li class="numberedList" value="10"><span class="koboSpan" id="kobo.800.1">Now, do an </span><code class="inlineCode"><span class="koboSpan" id="kobo.801.1">ltrace</span></code><span class="koboSpan" id="kobo.802.1"> on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.803.1">supersecret</span></code><span class="koboSpan" id="kobo.804.1"> binary, and save the output to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.805.1">supersecret2_ltrace.txt</span></code><span class="koboSpan" id="kobo.806.1"> file:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.807.1">donnie@fedora:~$ ltrace ./supersecret 2&gt; supersecret2_ltrace.txt
donnie@fedora:~$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.808.1">Count the lines in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.809.1">supersecret2_ltrace.txt</span></code><span class="koboSpan" id="kobo.810.1"> file:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.811.1">donnie@fedora:~$ wc -l supersecret2_ltrace.txt
4 supersecret2_ltrace.txt
donnie@fedora:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.812.1">Wow! </span><span class="koboSpan" id="kobo.812.2">There are only four lines in the output file this time. </span><span class="koboSpan" id="kobo.812.3">That’s a far cry from the 7270 lines that we had without the </span><code class="inlineCode"><span class="koboSpan" id="kobo.813.1">-U</span></code><span class="koboSpan" id="kobo.814.1"> option.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.815.1">On FreeBSD, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.816.1">shc</span></code><span class="koboSpan" id="kobo.817.1"> commands to create the obfuscated binary files are identical to what you’ve seen on Linux. </span><span class="koboSpan" id="kobo.817.2">But, to perform system call tracing on FreeBSD binaries, use </span><code class="inlineCode"><span class="koboSpan" id="kobo.818.1">truss</span></code><span class="koboSpan" id="kobo.819.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.820.1">strace</span></code><span class="koboSpan" id="kobo.821.1">, like so:</span></p>
      <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.822.1">donnie@freebsd14:~ $ truss ./supersecret 2&gt; supersecret1.truss.txt
</span></code></pre>
      <p class="normal"><span class="koboSpan" id="kobo.823.1">As far as I’ve been able to tell, there’s no FreeBSD equivalent to the Linux </span><code class="inlineCode"><span class="koboSpan" id="kobo.824.1">ltrace</span></code><span class="koboSpan" id="kobo.825.1"> command.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.826.1">On macOS, you have the </span><code class="inlineCode"><span class="koboSpan" id="kobo.827.1">dtrace</span></code><span class="koboSpan" id="kobo.828.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.829.1">dtruss</span></code><span class="koboSpan" id="kobo.830.1"> commands. </span><span class="koboSpan" id="kobo.830.2">But to use them, you’ll have </span><a id="_idIndexMarker1256"/><span class="koboSpan" id="kobo.831.1">to boot your machine into </span><strong class="screenText"><span class="koboSpan" id="kobo.832.1">Recovery</span></strong><span class="koboSpan" id="kobo.833.1"> mode and disable the </span><strong class="keyWord"><span class="koboSpan" id="kobo.834.1">System Integrity Protection</span></strong><span class="koboSpan" id="kobo.835.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.836.1">SIP</span></strong><span class="koboSpan" id="kobo.837.1">). </span><span class="koboSpan" id="kobo.837.2">I don’t recommend doing that unless you absolutely, positively have to.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.838.1">You’ll </span><a id="_idIndexMarker1257"/><span class="koboSpan" id="kobo.839.1">also see that </span><code class="inlineCode"><span class="koboSpan" id="kobo.840.1">dtrace</span></code><span class="koboSpan" id="kobo.841.1"> is available </span><a id="_idIndexMarker1258"/><span class="koboSpan" id="kobo.842.1">on OpenIndiana. </span><span class="koboSpan" id="kobo.842.2">But, since </span><code class="inlineCode"><span class="koboSpan" id="kobo.843.1">shc</span></code><span class="koboSpan" id="kobo.844.1"> isn’t available on OpenIndiana, I won’t bother to cover it.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.845.1">Next, let’s see if we can decrypt this script.</span></p>
    <h3 id="_idParaDest-422" class="heading 3"><span class="koboSpan" id="kobo.846.1">Decrypting shc Binaries</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.847.1">Many years ago, when I showed </span><code class="inlineCode"><span class="koboSpan" id="kobo.848.1">shc</span></code><span class="koboSpan" id="kobo.849.1"> to the students in my first shell scripting class, it was somewhat </span><a id="_idIndexMarker1259"/><span class="koboSpan" id="kobo.850.1">easy to crack the </span><code class="inlineCode"><span class="koboSpan" id="kobo.851.1">shc</span></code><span class="koboSpan" id="kobo.852.1"> algorithm in order to convert </span><a id="_idIndexMarker1260"/><span class="koboSpan" id="kobo.853.1">a binary file back to the original shell script. </span><span class="koboSpan" id="kobo.853.2">So at that time, </span><code class="inlineCode"><span class="koboSpan" id="kobo.854.1">shc</span></code><span class="koboSpan" id="kobo.855.1"> wasn’t a very secure option. </span><span class="koboSpan" id="kobo.855.2">Now, due to </span><code class="inlineCode"><span class="koboSpan" id="kobo.856.1">shc</span></code><span class="koboSpan" id="kobo.857.1"> developers taking advantage of improvements in modern operating system kernels, it’s a lot harder to crack </span><code class="inlineCode"><span class="koboSpan" id="kobo.858.1">shc</span></code><span class="koboSpan" id="kobo.859.1">. </span><span class="koboSpan" id="kobo.859.2">But, there are a couple of utilities that are </span><em class="italic"><span class="koboSpan" id="kobo.860.1">supposed</span></em><span class="koboSpan" id="kobo.861.1"> to crack </span><code class="inlineCode"><span class="koboSpan" id="kobo.862.1">shc</span></code><span class="koboSpan" id="kobo.863.1">, or at least that’s what their developers say.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.864.1">This might be a bit of a spoiler, but I’ll share it anyway.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.865.1">As you’ll soon see, the binaries that </span><code class="inlineCode"><span class="koboSpan" id="kobo.866.1">shc</span></code><span class="koboSpan" id="kobo.867.1"> creates are currently safe from this type of cracking attack. </span><span class="koboSpan" id="kobo.867.2">But, there’s always the possibility that someone could come up with better cracking tools in the future. </span><span class="koboSpan" id="kobo.867.3">So, think of this section as a framework for performing your own tests on any cracking tools that might come out in the future.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.868.1">Let’s take a quick look at these utilities, shall we?</span></p>
    <h4 class="heading 4"><span class="koboSpan" id="kobo.869.1">Hands-on Lab: Testing UnSHc</span></h4>
    <p class="normal"><span class="koboSpan" id="kobo.870.1">This lab </span><a id="_idIndexMarker1261"/><span class="koboSpan" id="kobo.871.1">will familiarize you with the UnSHc utility. </span><span class="koboSpan" id="kobo.871.2">I’m using </span><a id="_idIndexMarker1262"/><span class="koboSpan" id="kobo.872.1">a Fedora Server virtual machine, but you can use either another Linux virtual machine or a FreeBSD virtual machine if you desire.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.873.1">Download UnSHc from Github by doing:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.874.1">donnie@fedora-server:~$ git clone https://github.com/yanncam/UnSHc.git
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.875.1">Once it’s downloaded, which only takes a few seconds, </span><code class="inlineCode"><span class="koboSpan" id="kobo.876.1">cd</span></code><span class="koboSpan" id="kobo.877.1"> into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">UnSHc/latest/</span></code><span class="koboSpan" id="kobo.879.1"> directory, and copy the </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">unshc.sh</span></code><span class="koboSpan" id="kobo.881.1"> script to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.882.1">/usr/local/bin/</span></code><span class="koboSpan" id="kobo.883.1"> directory:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.884.1">donnie@fedora-server:~$ cd UnSHc/latest/
donnie@fedora-server:~/UnSHc/latest$ ls
unshc.sh
donnie@fedora-server:~/UnSHc/latest$ sudo cp unshc.sh /usr/local/bin/
donnie@fedora-server:~/UnSHc/latest$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.885.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.886.1">UnSHc/sample/</span></code><span class="koboSpan" id="kobo.887.1"> directory, you’ll see an example shell script, along with </span><a id="_idIndexMarker1263"/><span class="koboSpan" id="kobo.888.1">the corresponding C source code file </span><a id="_idIndexMarker1264"/><span class="koboSpan" id="kobo.889.1">and compiled binary file.</span></li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.890.1">Note that this C source code file and binary file were both generated by a very old version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.891.1">shc</span></code><span class="koboSpan" id="kobo.892.1">. </span><span class="koboSpan" id="kobo.892.2">(The reason why I mention this will become apparent in just a moment.)</span></p>
    </div>
    <p class="normal one"><span class="koboSpan" id="kobo.893.1">Copy the binary file, which is </span><code class="inlineCode"><span class="koboSpan" id="kobo.894.1">test.sh.x</span></code><span class="koboSpan" id="kobo.895.1">, to your home directory:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.896.1">donnie@fedora-server:~/UnSHc/sample$ ls
test.sh  test.sh.x  test.sh.x.c
donnie@fedora-server:~/UnSHc/sample$ cp test.sh.x ~
donnie@fedora-server:~/UnSHc/sample$ cd
donnie@fedora-server:~$
</span></code></pre>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.897.1">Attempt to decrypt the </span><code class="inlineCode"><span class="koboSpan" id="kobo.898.1">test.sh.x</span></code><span class="koboSpan" id="kobo.899.1"> file, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.900.1">donnie@fedora-server:~$ unshc.sh test.sh.x
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.901.1">The output should look something like this:</span></p>
    <figure class="mediaobject"><span class="koboSpan" id="kobo.902.1"><img src="../Images/B21693_20_02.png" alt="B21693_20_2"/></span></figure>
    <p class="packt_figref"><span class="koboSpan" id="kobo.903.1">Figure 20.2: Using UnSHc</span></p>
    <ol>
      <li class="numberedList" value="5"><span class="koboSpan" id="kobo.904.1">Verify </span><a id="_idIndexMarker1265"/><span class="koboSpan" id="kobo.905.1">that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.906.1">test.sh.x</span></code><span class="koboSpan" id="kobo.907.1"> binary file actually </span><a id="_idIndexMarker1266"/><span class="koboSpan" id="kobo.908.1">did get decrypted, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.909.1">donnie@fedora-server:~$ ls -l test*
-rw-r--r--. </span><span class="koboSpan" id="kobo.909.2">1 donnie donnie   193 Jul  5 14:04 test.sh
-rw-r--r--. </span><span class="koboSpan" id="kobo.909.3">1 donnie donnie 11440 Jul  5 14:01 test.sh.x
donnie@fedora-server:~$ cat test.sh
#!/bin/bash
# This script is very critical !
</span><span class="koboSpan" id="kobo.909.4">echo "I'm a super critical and private script !"
</span><span class="koboSpan" id="kobo.909.5">PASSWORDROOT="SuPeRrOoTpAsSwOrD"';
myService --user=root --password=$PASSWORDROOT &gt; /dev/null 2&gt;&amp;1
donnie@fedora-server:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.910.1">Okay, so that works just fine.</span></p>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.911.1">Next, try to </span><a id="_idIndexMarker1267"/><span class="koboSpan" id="kobo.912.1">decrypt a binary file that you </span><a id="_idIndexMarker1268"/><span class="koboSpan" id="kobo.913.1">created with the current version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.914.1">shc</span></code><span class="koboSpan" id="kobo.915.1">. </span><span class="koboSpan" id="kobo.915.2">(You can use the binary file that you created in the </span><em class="italic"><span class="koboSpan" id="kobo.916.1">Using shc</span></em><span class="koboSpan" id="kobo.917.1"> lab, or you can create a new one.) Do it like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.918.1">donnie@fedora-server:~$ unshc.sh supersecret
. </span><span class="koboSpan" id="kobo.918.2">. </span><span class="koboSpan" id="kobo.918.3">.
</span><span class="koboSpan" id="kobo.918.4">. </span><span class="koboSpan" id="kobo.918.5">. </span><span class="koboSpan" id="kobo.918.6">.
</span><span class="koboSpan" id="kobo.918.7">UnSHc is used to decrypt script encrypted with SHc
Original idea from Luiz Octavio Duarte (LOD)
Updated and modernized by Yann CAM
- SHc   : [http://www.datsi.fi.upm.es/~frosal/]
- UnSHc : [https://www.asafety.fr/unshc-the-shc-decrypter/]
------------------------------
[*] Input file name to decrypt [supersecret]
[-] Unable to define arc4() call address...
</span><span class="koboSpan" id="kobo.918.8">donnie@fedora-server:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.919.1">As you see this time, the operation failed. </span><span class="koboSpan" id="kobo.919.2">So, the binary didn’t get decrypted, and the original shell script was not reconstructed.</span></p>
    <ol>
      <li class="numberedList" value="7"><span class="koboSpan" id="kobo.920.1">To see why the operation failed this time, go into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.921.1">UnSHc/</span></code><span class="koboSpan" id="kobo.922.1"> directory and open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.923.1">README.md</span></code><span class="koboSpan" id="kobo.924.1"> file. </span><span class="koboSpan" id="kobo.924.2">Close to the top of the file, you’ll see this paragraph:</span></li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.925.1">**Due to the many problems since </span><code class="inlineCode"><span class="koboSpan" id="kobo.926.1">shc</span></code><span class="koboSpan" id="kobo.927.1"> 4.0.3, there seems to be a need for clarification. </span><span class="koboSpan" id="kobo.927.2">In </span><code class="inlineCode"><span class="koboSpan" id="kobo.928.1">shc</span></code><span class="koboSpan" id="kobo.929.1"> 4.0.3 many structural changes have been incorporated, so that </span><code class="inlineCode"><span class="koboSpan" id="kobo.930.1">shc</span></code><span class="koboSpan" id="kobo.931.1"> now makes use of various security mechanisms provided by the linux-kernel itself. </span><span class="koboSpan" id="kobo.931.2">Therefore, it is now almost impossible to extract the original shell script at all with current UnSHc version, if the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.932.1">shc</span></code><span class="koboSpan" id="kobo.933.1"> version was used. </span><span class="koboSpan" id="kobo.933.2">This requires a more in-depth approach, which means that a modified </span><code class="inlineCode"><span class="koboSpan" id="kobo.934.1">bash</span></code><span class="koboSpan" id="kobo.935.1"> or a modified linux-kernel is needed to bypass the security measures.**</span></p>
    <p class="normal one"><span class="koboSpan" id="kobo.936.1">So you see that the current version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">shc</span></code><span class="koboSpan" id="kobo.938.1"> is much more secure than the older versions.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.939.1">I also tested UnSHc on a FreeBSD machine, and got the same results. </span><span class="koboSpan" id="kobo.939.2">That tells me that the security enhancements that prevent you from successfully using UnSHc are also in the current FreeBSD kernel.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.940.1">Also, I tested another </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">shc</span></code><span class="koboSpan" id="kobo.942.1"> cracker that’s called </span><code class="inlineCode"><span class="koboSpan" id="kobo.943.1">deshc-deb</span></code><span class="koboSpan" id="kobo.944.1">. </span><span class="koboSpan" id="kobo.944.2">If you’d like to play with it, you can download it by doing:</span></p>
      <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.945.1">git clone https://github.com/Rem01Gaming/deshc-deb.git
</span></code></pre>
      <p class="normal"><span class="koboSpan" id="kobo.946.1">(Spoiler alert: </span><code class="inlineCode"><span class="koboSpan" id="kobo.947.1">deshc-deb</span></code><span class="koboSpan" id="kobo.948.1"> doesn’t work either.)</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.949.1">Okay, I know, that was a lot of work to show you that something doesn’t work. </span><span class="koboSpan" id="kobo.949.2">But, I figured that </span><a id="_idIndexMarker1269"/><span class="koboSpan" id="kobo.950.1">you might want to see for yourself, instead </span><a id="_idIndexMarker1270"/><span class="koboSpan" id="kobo.951.1">of just accepting my say-so for it. </span><span class="koboSpan" id="kobo.951.2">Seriously though, the bottom line is that </span><code class="inlineCode"><span class="koboSpan" id="kobo.952.1">shc</span></code><span class="koboSpan" id="kobo.953.1"> is a good, secure way to obfuscate your scripts, in case you really need to do that. </span><span class="koboSpan" id="kobo.953.2">And, due to improvements in the Linux and FreeBSD kernels, the current decrypting utilities no longer work. </span><span class="koboSpan" id="kobo.953.3">However, you still need to take precautions to avoid sensitive data leakage, as you’ll see a bit later in the </span><em class="italic"><span class="koboSpan" id="kobo.954.1">Avoiding Sensitive Data Leakage</span></em><span class="koboSpan" id="kobo.955.1"> section. </span><span class="koboSpan" id="kobo.955.2">Next though, let’s look at a pair of permissions setting that could get you into trouble.</span></p>
    <h1 id="_idParaDest-423" class="heading 1"><span class="koboSpan" id="kobo.956.1">Understanding SUID and SGID Considerations</span></h1>
    <p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.957.1">SUID</span></strong><span class="koboSpan" id="kobo.958.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.959.1">SGID</span></strong><span class="koboSpan" id="kobo.960.1">, which stand for </span><strong class="keyWord"><span class="koboSpan" id="kobo.961.1">Set User Identity</span></strong><span class="koboSpan" id="kobo.962.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.963.1">Set Group Identity</span></strong><span class="koboSpan" id="kobo.964.1">, are permissions </span><a id="_idIndexMarker1271"/><span class="koboSpan" id="kobo.965.1">settings that you can place on executable files. </span><span class="koboSpan" id="kobo.965.2">These two </span><a id="_idIndexMarker1272"/><span class="koboSpan" id="kobo.966.1">permissions settings are not only handy, but are also mandatory on certain executable files that deal with certain functions of Linux, Unix, and Unix-like operating systems. </span><span class="koboSpan" id="kobo.966.2">However, if you set SUID or SGID on programs that you create yourself, you could be opening your system up to all kinds of security problems. </span><span class="koboSpan" id="kobo.966.3">Before I explain why that is, I need to explain what SUID and SGID actually do and why they’re needed.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.967.1">First, let’s go into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.968.1">/bin/</span></code><span class="koboSpan" id="kobo.969.1"> directory, and look at the permissions settings for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.970.1">rm</span></code><span class="koboSpan" id="kobo.971.1"> executable, like so:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.972.1">donnie@fedora:/bin$ ls -l rm
-rwxr-xr-x. </span><span class="koboSpan" id="kobo.972.2">1 root root 61976 Jan 17 19:00 rm
donnie@fedora:/bin$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.973.1">Here’s the breakdown of what you’re seeing:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.974.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.975.1">root root</span></code><span class="koboSpan" id="kobo.976.1"> portion of this output indicates that this file belongs to the root user, and is associated with the root user’s group.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.977.1">The permissions settings are at the beginning of the line, and are divided into three sections. </span><span class="koboSpan" id="kobo.977.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.978.1">rwx</span></code><span class="koboSpan" id="kobo.979.1"> settings are for the </span><em class="italic"><span class="koboSpan" id="kobo.980.1">user</span></em><span class="koboSpan" id="kobo.981.1"> of the file, which in this case is </span><a id="_idIndexMarker1273"/><span class="koboSpan" id="kobo.982.1">the root user. </span><span class="koboSpan" id="kobo.982.2">(In the Linux/Unix world, we refer to the </span><em class="italic"><span class="koboSpan" id="kobo.983.1">owner</span></em><span class="koboSpan" id="kobo.984.1"> of the file as the file’s </span><em class="italic"><span class="koboSpan" id="kobo.985.1">user</span></em><span class="koboSpan" id="kobo.986.1">.) The </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">rwx</span></code><span class="koboSpan" id="kobo.988.1"> here means </span><a id="_idIndexMarker1274"/><span class="koboSpan" id="kobo.989.1">that the root user has read, write, and executable permissions for this file.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.990.1">The next group of settings, which is </span><code class="inlineCode"><span class="koboSpan" id="kobo.991.1">r-x</span></code><span class="koboSpan" id="kobo.992.1">, is for the </span><em class="italic"><span class="koboSpan" id="kobo.993.1">group</span></em><span class="koboSpan" id="kobo.994.1">, which in this case is for the root group. </span><span class="koboSpan" id="kobo.994.2">This means that members of this group, which in this case consists of only the root user, have read and executable permissions for this file.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.995.1">Finally, we have the third group of settings, which again is </span><code class="inlineCode"><span class="koboSpan" id="kobo.996.1">r-x</span></code><span class="koboSpan" id="kobo.997.1">. </span><span class="koboSpan" id="kobo.997.2">This group of settings is for </span><em class="italic"><span class="koboSpan" id="kobo.998.1">others</span></em><span class="koboSpan" id="kobo.999.1">. </span><span class="koboSpan" id="kobo.999.2">This means that anyone who isn’t the root user or a member of the root group can invoke the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1000.1">rm</span></code><span class="koboSpan" id="kobo.1001.1"> command, even though the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1002.1">rm</span></code><span class="koboSpan" id="kobo.1003.1"> executable belongs to the root user. </span><span class="koboSpan" id="kobo.1003.2">The catch with this is that a normal, unprivileged user can only use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1004.1">rm</span></code><span class="koboSpan" id="kobo.1005.1"> to remove files and directories with permissions settings that allow the normal user to do so. </span><span class="koboSpan" id="kobo.1005.2">(Normally, this would mean that the normal user can only remove his or her own files and directories.) Removing any other files and directories with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1006.1">rm</span></code><span class="koboSpan" id="kobo.1007.1"> requires root privileges.</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.1008.1">Now, there are times when a normal user who doesn’t have either root or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1009.1">sudo</span></code><span class="koboSpan" id="kobo.1010.1"> privileges needs to do something that requires root privileges. </span><span class="koboSpan" id="kobo.1010.2">The most common task of this sort is when a normal user needs to change his or her own password. </span><span class="koboSpan" id="kobo.1010.3">Changing a password requires modifying the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1011.1">/etc/shadow</span></code><span class="koboSpan" id="kobo.1012.1"> file on Linux and OpenIndiana systems, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1013.1">/etc/master.passwd</span></code><span class="koboSpan" id="kobo.1014.1"> file on FreeBSD and most other BSD-type systems. </span><span class="koboSpan" id="kobo.1014.2">But, look at the permissions settings of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1015.1">shadow</span></code><span class="koboSpan" id="kobo.1016.1"> file on my Fedora workstation:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1017.1">donnie@fedora:/etc$ ls -l shadow
----------. </span><span class="koboSpan" id="kobo.1017.2">1 root root 1072 May 10 17:33 shadow
donnie@fedora:/etc$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1018.1">Okay, this looks very strange, because there are no permissions of any kind on this file for anybody. </span><span class="koboSpan" id="kobo.1018.2">In reality, the root user does have read and write permissions on this file. </span><span class="koboSpan" id="kobo.1018.3">It’s just that Red Hat-type operating systems, such as Fedora, use another mechanism to grant those permissions to the root user. </span><span class="koboSpan" id="kobo.1018.4">(I don’t want to go into what that mechanism is, because it’s beyond the scope of our present topic.)</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1019.1">More typical is what you see on this Debian machine:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1020.1">donnie@debian12:/etc$ ls -l shadow
-rw-r-----. </span><span class="koboSpan" id="kobo.1020.2">1 root shadow 1178 Mar 23 13:13 shadow
donnie@debian12:/etc$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1021.1">Here, we see </span><a id="_idIndexMarker1275"/><span class="koboSpan" id="kobo.1022.1">that only the root user has read and write permissions, and that the shadow group only has read permissions. </span><span class="koboSpan" id="kobo.1022.2">Either way though, a normal user </span><a id="_idIndexMarker1276"/><span class="koboSpan" id="kobo.1023.1">who needs to change his or her own password needs to modify this file, without invoking root or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1024.1">sudo</span></code><span class="koboSpan" id="kobo.1025.1"> privileges. </span><span class="koboSpan" id="kobo.1025.2">How can that be accomplished? </span><span class="koboSpan" id="kobo.1025.3">Well, with SUID, of course.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1026.1">Adding the SUID permission to an executable file allows any normal user to execute that file with the same privileges as that file’s user. </span><span class="koboSpan" id="kobo.1026.2">For example, look at the permissions settings on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1027.1">passwd</span></code><span class="koboSpan" id="kobo.1028.1"> executable:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1029.1">donnie@fedora:/bin$ ls -l passwd
-rwsr-xr-x. </span><span class="koboSpan" id="kobo.1029.2">1 root root 32416 Jul 19  2023 passwd
donnie@fedora:/bin$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1030.1">This time, we see </span><code class="inlineCode"><span class="koboSpan" id="kobo.1031.1">rws</span></code><span class="koboSpan" id="kobo.1032.1"> as the permissions setting for the </span><em class="italic"><span class="koboSpan" id="kobo.1033.1">user</span></em><span class="koboSpan" id="kobo.1034.1">, which again in this case is the root user. </span><span class="koboSpan" id="kobo.1034.2">The lower-case </span><code class="inlineCode"><span class="koboSpan" id="kobo.1035.1">s</span></code><span class="koboSpan" id="kobo.1036.1"> here means that the executable permission is set for the root user, and that the SUID permission is also set. </span><span class="koboSpan" id="kobo.1036.2">In the third permissions group, you see </span><code class="inlineCode"><span class="koboSpan" id="kobo.1037.1">r-x</span></code><span class="koboSpan" id="kobo.1038.1">, which means that normal, unprivileged users can run this program. </span><span class="koboSpan" id="kobo.1038.2">The SUID permission is what allows the normal user to change his or her own password, which requires modifying either the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1039.1">/etc/shadow</span></code><span class="koboSpan" id="kobo.1040.1"> file or the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1041.1">/etc/master.passwd</span></code><span class="koboSpan" id="kobo.1042.1"> file. </span><span class="koboSpan" id="kobo.1042.2">So now, let’s see if this works for Frank, who has no root or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1043.1">sudo</span></code><span class="koboSpan" id="kobo.1044.1"> privileges:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1045.1">frank@debian12:~$ passwd
Changing password for frank.
</span><span class="koboSpan" id="kobo.1045.2">Current password:
New password:
Retype new password:
passwd: password updated successfully
frank@debian12:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1046.1">Indeed it does, thanks to the SUID setting on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1047.1">passwd</span></code><span class="koboSpan" id="kobo.1048.1"> executable.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1049.1">I should point out that the SUID setting on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1050.1">passwd</span></code><span class="koboSpan" id="kobo.1051.1"> executable only works if a user is setting his or her own password. </span><span class="koboSpan" id="kobo.1051.2">To set anyone else’s password, a user would still need to have the proper </span><code class="inlineCode"><span class="koboSpan" id="kobo.1052.1">sudo</span></code><span class="koboSpan" id="kobo.1053.1"> privileges. </span><span class="koboSpan" id="kobo.1053.2">(And no, I don’t know how the operating system developers can make SUID work selectively like that.)</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1054.1">The SGID </span><a id="_idIndexMarker1277"/><span class="koboSpan" id="kobo.1055.1">setting on executable files works the same way, except for </span><a id="_idIndexMarker1278"/><span class="koboSpan" id="kobo.1056.1">groups. </span><span class="koboSpan" id="kobo.1056.2">For example, look at the settings for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1057.1">write</span></code><span class="koboSpan" id="kobo.1058.1"> executable:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1059.1">donnie@fedora:/bin$ ls -l write
-rwxr-sr-x. </span><span class="koboSpan" id="kobo.1059.2">1 root tty 24288 Apr  7 20:00 write
donnie@fedora:/bin$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1060.1">In this case, you see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1061.1">s</span></code><span class="koboSpan" id="kobo.1062.1"> setting in the </span><em class="italic"><span class="koboSpan" id="kobo.1063.1">group</span></em><span class="koboSpan" id="kobo.1064.1"> permissions, which means that any user who executes this program has the same privileges as the associated group. </span><span class="koboSpan" id="kobo.1064.2">In this case, we’re talking about the tty group, which is a system group that allows its members to send output to the terminal. </span><span class="koboSpan" id="kobo.1064.3">The SGID permission here allows a normal user to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1065.1">write</span></code><span class="koboSpan" id="kobo.1066.1"> to send messages to another user who’s logged into another terminal, like so:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1067.1">donnie@fedora-server:~$ write frank
The server is shutting down in five minutes.
</span><span class="koboSpan" id="kobo.1067.2">donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1068.1">After entering the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1069.1">write frank</span></code><span class="koboSpan" id="kobo.1070.1"> command, I hit </span><strong class="screenText"><span class="koboSpan" id="kobo.1071.1">Enter</span></strong><span class="koboSpan" id="kobo.1072.1">. </span><span class="koboSpan" id="kobo.1072.2">I then entered the message and hit </span><em class="keystroke"><span class="koboSpan" id="kobo.1073.1">Ctrl</span></em><span class="koboSpan" id="kobo.1074.1">-</span><em class="keystroke"><span class="koboSpan" id="kobo.1075.1">d</span></em><span class="koboSpan" id="kobo.1076.1"> to actually send the message. </span><span class="koboSpan" id="kobo.1076.2">Thanks to the SGID setting on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1077.1">write</span></code><span class="koboSpan" id="kobo.1078.1">, I was able to make that message show up on Frank’s terminal, as you see here:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1079.1">frank@fedora-server:~$
Message from donnie@fedora-server on pts/1 at 17:01 ...
</span><span class="koboSpan" id="kobo.1079.2">The server is shutting down in five minutes.
</span><span class="koboSpan" id="kobo.1079.3">EOF
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1080.1">So, what does all this have to do with shell scripting? </span><span class="koboSpan" id="kobo.1080.2">Well, it’s just that even though SUID and SGID are mandatory on certain executable files that are part of the operating system, they can be a security hazard if you set them on executable files that you create. </span><span class="koboSpan" id="kobo.1080.3">By doing so, you can inadvertently allow normal users to do things that they shouldn’t be allowed to do, and you can also allow intruders to invoke malicious code that could affect the entire system.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1081.1">So, the general </span><a id="_idIndexMarker1279"/><span class="koboSpan" id="kobo.1082.1">rule is to never, but </span><em class="italic"><span class="koboSpan" id="kobo.1083.1">never</span></em><span class="koboSpan" id="kobo.1084.1">, set either SUID or SGID </span><a id="_idIndexMarker1280"/><span class="koboSpan" id="kobo.1085.1">on programs of your own creation, unless you really know what you’re doing and can avoid the security problems.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1086.1">By the way, here’s how to set the SUID permission on files:</span></p>
    </div>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1087.1">donnie@fedora-server:~$ ls -l newscript.sh 
-rwxr--r--. </span><span class="koboSpan" id="kobo.1087.2">1 donnie donnie 0 Jun 25 17:13 newscript.shdonnie@fedora-server:~$ chmod u+s newscript.sh 
donnie@fedora-server:~$ ls -l newscript.sh 
-rwsr--r--. </span><span class="koboSpan" id="kobo.1087.3">1 donnie donnie 0 Jun 25 17:13 newscript.sh
donnie@fedora-server:~$
</span></code></pre>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1088.1">Setting SGID looks like this:</span></p>
    </div>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1089.1">donnie@fedora-server:~$ ls -l newscript2.sh 
-rw-r--r--. </span><span class="koboSpan" id="kobo.1089.2">1 donnie donnie 0 Jun 25 17:15 newscript2.sh
donnie@fedora-server:~$ chmod g+s newscript2.sh 
donnie@fedora-server:~$ ls -l newscript2.sh 
-rw-r-Sr--. </span><span class="koboSpan" id="kobo.1089.3">1 donnie donnie 0 Jun 25 17:15 newscript2.sh
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1090.1">But, for shell scripters, there’s a bit of good news. </span><span class="koboSpan" id="kobo.1090.2">That is, if you set either SUID or SGID on a shell script, it will have no effect at all. </span><span class="koboSpan" id="kobo.1090.3">This is because the kernels of Linux, Unix, and Unix-like operating systems contain code that cause the operating system to ignore SUID and SGID settings on any executable script file that contains a shebang line. </span><span class="koboSpan" id="kobo.1090.4">So, contrary to what you might see in other shell scripting tutorials, setting either of these dangerous permissions on your scripts isn’t a problem, because they will have absolutely zero effect. </span><span class="koboSpan" id="kobo.1090.5">However, they </span><em class="italic"><span class="koboSpan" id="kobo.1091.1">might</span></em><span class="koboSpan" id="kobo.1092.1"> have an effect on any binary files that you create with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1093.1">shc</span></code><span class="koboSpan" id="kobo.1094.1">, so watch out for them.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1095.1">Unfortunately, I haven’t been able to extensively test the effects of SUID and SGID permissions on the binary files that you create with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1096.1">shc</span></code><span class="koboSpan" id="kobo.1097.1">. </span><span class="koboSpan" id="kobo.1097.2">So, just be aware that you don’t want to see either of these permissions settings on those binary files.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1098.1">I should also </span><a id="_idIndexMarker1281"/><span class="koboSpan" id="kobo.1099.1">mention that it is possible to mount filesystem partitions with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1100.1">nosuid</span></code><span class="koboSpan" id="kobo.1101.1"> option, which would cause the SUID and </span><a id="_idIndexMarker1282"/><span class="koboSpan" id="kobo.1102.1">SGID permissions to be completely ignored on any files that are within that partition. </span><span class="koboSpan" id="kobo.1102.2">In fact, many modern Linux and Unix distros already mount certain important partitions, such as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1103.1">/tmp/</span></code><span class="koboSpan" id="kobo.1104.1"> filesystem, with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1105.1">nosuid</span></code><span class="koboSpan" id="kobo.1106.1"> option by default. </span><span class="koboSpan" id="kobo.1106.2">Unfortunately, showing you how to set this option on your own partitions is beyond the scope of this book. </span><span class="koboSpan" id="kobo.1106.3">In fact, I really can’t, because the procedure differs for the various Linux and Unix distros, as well as for the various filesystem formats that they use. </span><span class="koboSpan" id="kobo.1106.4">If you need to know how to set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1107.1">nosuid</span></code><span class="koboSpan" id="kobo.1108.1"> option, your best bet is to consult the documentation</span><a id="_idIndexMarker1283"/><span class="koboSpan" id="kobo.1109.1"> for your</span><a id="_idIndexMarker1284"/><span class="koboSpan" id="kobo.1110.1"> particular distro.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1111.1">Okay, let’s talk about data leakage.</span></p>
    <h1 id="_idParaDest-424" class="heading 1"><span class="koboSpan" id="kobo.1112.1">Avoiding Sensitive Data Leakage</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.1113.1">As a systems administrator, there’s a very good chance that you’ll eventually have to deal with </span><a id="_idIndexMarker1285"/><span class="koboSpan" id="kobo.1114.1">some sort of sensitive data, such as passwords, financial information, or customer information. </span><span class="koboSpan" id="kobo.1114.2">You’ll always want to ensure that your scripts don’t inadvertently cause any sensitive data to leak out to any unauthorized people. </span><span class="koboSpan" id="kobo.1114.3">Let’s look at some ways that that could happen, and how to prevent it.</span></p>
    <h2 id="_idParaDest-425" class="heading 2"><span class="koboSpan" id="kobo.1115.1">Securing Temporary Files</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1116.1">At some </span><a id="_idIndexMarker1286"/><span class="koboSpan" id="kobo.1117.1">point, you might need to create </span><a id="_idIndexMarker1287"/><span class="koboSpan" id="kobo.1118.1">scripts that store some sort of ephemeral data in a temporary file. </span><span class="koboSpan" id="kobo.1118.2">Reasons that you might need to do this include:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.1119.1">Processing a large amount of data without using excessive system memory.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.1120.1">Storing the intermediate results of some sort of complex operation.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.1121.1">Storing temporary data for logging debugging information.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.1122.1">Allowing different processes or scripts to communicate with each other.</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.1123.1">Since the</span><code class="inlineCode"><span class="koboSpan" id="kobo.1124.1"> /tmp/</span></code><span class="koboSpan" id="kobo.1125.1"> directory is the most common place to store temporary files, let’s begin this topic with and explanation of it.</span></p>
    <h3 id="_idParaDest-426" class="heading 3"><span class="koboSpan" id="kobo.1126.1">Understanding the /tmp/ Directory</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1127.1">As I just said, the most common place to store temporary files is in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1128.1">/tmp/</span></code><span class="koboSpan" id="kobo.1129.1"> directory. </span><span class="koboSpan" id="kobo.1129.2">The good </span><a id="_idIndexMarker1288"/><span class="koboSpan" id="kobo.1130.1">part about this directory is that it is world-readable </span><a id="_idIndexMarker1289"/><span class="koboSpan" id="kobo.1131.1">and world-writable, as you see here:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1132.1">donnie@fedora-server:~$ ls -ld /tmp
drwxrwxrwt. </span><span class="koboSpan" id="kobo.1132.2">17 root root 340 Jun 27 14:27 /tmp
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1133.1">This is good, because it provides a common, well-known place that different scripts and processes can access. </span><span class="koboSpan" id="kobo.1133.2">Indeed, this directory isn’t just used by your shell scripts. </span><span class="koboSpan" id="kobo.1133.3">It’s also used by various operating system processes. </span><span class="koboSpan" id="kobo.1133.4">Here on the Fedora virtual machine, you see that it’s storing temporary data from various </span><code class="inlineCode"><span class="koboSpan" id="kobo.1134.1">systemd</span></code><span class="koboSpan" id="kobo.1135.1"> processes:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1136.1">donnie@fedora-server:/tmp$ ls -l
total 0
drwx------. </span><span class="koboSpan" id="kobo.1136.2">3 root root 60 Jun 27 13:44 systemd-private-d241f12536d0464393f30d8552359053-chronyd.service-RKt6x4
drwx------. </span><span class="koboSpan" id="kobo.1136.3">3 root root 60 Jun 27 13:44 systemd-private-d241f12536d0464393f30d8552359053-dbus-broker.service-plcC5i
drwx------. </span><span class="koboSpan" id="kobo.1136.4">3 root root 60 Jun 27 13:45 systemd-private-d241f12536d0464393f30d8552359053-httpd.service-SB6D6A
. </span><span class="koboSpan" id="kobo.1136.5">. </span><span class="koboSpan" id="kobo.1136.6">.
</span><span class="koboSpan" id="kobo.1136.7">. </span><span class="koboSpan" id="kobo.1136.8">. </span><span class="koboSpan" id="kobo.1136.9">.
</span><span class="koboSpan" id="kobo.1136.10">drwx------. </span><span class="koboSpan" id="kobo.1136.11">3 root root 60 Jun 27 13:44 systemd-private-d241f12536d0464393f30d8552359053-systemd-resolved.service-uBl3YB
donnie@fedora-server:/tmp$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1137.1">As you see here, every file or directory that gets created in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1138.1">/tmp/</span></code><span class="koboSpan" id="kobo.1139.1"> is set with restrictive permissions, so that only the </span><em class="italic"><span class="koboSpan" id="kobo.1140.1">user</span></em><span class="koboSpan" id="kobo.1141.1"> of those files or directories can access them. </span><span class="koboSpan" id="kobo.1141.2">Also, take another look at the permissions settings for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1142.1">/tmp/</span></code><span class="koboSpan" id="kobo.1143.1"> directory itself:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1144.1">drwxrwxrwt. </span><span class="koboSpan" id="kobo.1144.2">17 root root 340 Jun 27 14:27 /tmp
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1145.1">At the end of the permissions string, you see a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1146.1">t</span></code><span class="koboSpan" id="kobo.1147.1"> in place of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1148.1">x</span></code><span class="koboSpan" id="kobo.1149.1">. </span><span class="koboSpan" id="kobo.1149.2">This means that the executable permission is set for </span><em class="italic"><span class="koboSpan" id="kobo.1150.1">others</span></em><span class="koboSpan" id="kobo.1151.1">, so in that sense it does the same job as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1152.1">x</span></code><span class="koboSpan" id="kobo.1153.1">. </span><span class="koboSpan" id="kobo.1153.2">So, anybody can enter that directory. </span><span class="koboSpan" id="kobo.1153.3">But, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1154.1">t</span></code><span class="koboSpan" id="kobo.1155.1">, which is known as the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1156.1">sticky bit</span></strong><span class="koboSpan" id="kobo.1157.1">, also </span><a id="_idIndexMarker1290"/><span class="koboSpan" id="kobo.1158.1">makes it so that different users can’t delete each other’s files or directories, unless they have root privileges. </span><span class="koboSpan" id="kobo.1158.2">(This would be true even if the files and directories were set with world-writable permissions.)</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1159.1">I know that this is a rather cursory explanation of the sticky bit, but a fuller explanation is beyond the scope of this book. </span><span class="koboSpan" id="kobo.1159.2">You’ll find a lot more about it in my </span><em class="italic"><span class="koboSpan" id="kobo.1160.1">Mastering Linux Security and Hardening</span></em><span class="koboSpan" id="kobo.1161.1"> Book.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1162.1">Okay, now </span><a id="_idIndexMarker1291"/><span class="koboSpan" id="kobo.1163.1">that you understand the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1164.1">/tmp/</span></code><span class="koboSpan" id="kobo.1165.1"> directory, let’s </span><a id="_idIndexMarker1292"/><span class="koboSpan" id="kobo.1166.1">look at how you can create scripts that will create temporary files. </span><span class="koboSpan" id="kobo.1166.2">Understand though, that there are two ways to do it. </span><span class="koboSpan" id="kobo.1166.3">First there’s the wrong way, and then there’s the right way.</span></p>
    <h3 id="_idParaDest-427" class="heading 3"><span class="koboSpan" id="kobo.1167.1">The Wrong Way to Create Temporary Files</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1168.1">So now, let’s say that you really need to write a script that creates temporary files. </span><span class="koboSpan" id="kobo.1168.2">How would </span><a id="_idIndexMarker1293"/><span class="koboSpan" id="kobo.1169.1">you do it, and how would it be a security concern? </span><span class="koboSpan" id="kobo.1169.2">Well, before I show you the right way to create temporary files, let me show you the wrong way, in this </span><code class="inlineCode"><span class="koboSpan" id="kobo.1170.1">tmp_file1.sh</span></code><span class="koboSpan" id="kobo.1171.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1172.1">#!/bin/bash
echo "This temporary file contains sensitive data." </span><span class="koboSpan" id="kobo.1172.2">&gt; /tmp/donnie_temp
cat /tmp/donnie_temp
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1173.1">Run this script, and you’ll see this in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1174.1">/tmp/</span></code><span class="koboSpan" id="kobo.1175.1"> directory:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1176.1">donnie@fedora-server:~$ ls -l /tmp/donnie_temp
-rw-r--r--. </span><span class="koboSpan" id="kobo.1176.2">1 donnie donnie 45 Jun 27 16:02 /tmp/donnie_temp
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1177.1">You see that the read permission is set for the </span><em class="italic"><span class="koboSpan" id="kobo.1178.1">user</span></em><span class="koboSpan" id="kobo.1179.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1180.1">group</span></em><span class="koboSpan" id="kobo.1181.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.1182.1">others</span></em><span class="koboSpan" id="kobo.1183.1">. </span><span class="koboSpan" id="kobo.1183.2">The write permission is only set for the </span><em class="italic"><span class="koboSpan" id="kobo.1184.1">user</span></em><span class="koboSpan" id="kobo.1185.1">. </span><span class="koboSpan" id="kobo.1185.2">So, I’m the only person who can write to this file, but every unprivileged user who’s logged into the server can read it. </span><span class="koboSpan" id="kobo.1185.3">That’s not what you want if you’re really dealing with sensitive data. </span><span class="koboSpan" id="kobo.1185.4">The other problem is that this script is using a predictable </span><a id="_idIndexMarker1294"/><span class="koboSpan" id="kobo.1186.1">naming convention for the temporary file, which makes it easy for attackers to perform </span><strong class="keyWord"><span class="koboSpan" id="kobo.1187.1">sym link attacks</span></strong><span class="koboSpan" id="kobo.1188.1">.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1189.1">Trying to explain how </span><strong class="keyWord"><span class="koboSpan" id="kobo.1190.1">sym link attacks</span></strong><span class="koboSpan" id="kobo.1191.1"> work is way beyond the scope of this book. </span><span class="koboSpan" id="kobo.1191.2">For now, let’s just say that they can cause bad things to happen, such as:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1192.1"> Leakage of sensitive data.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1193.1"> Injection of false data.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1194.1"> Denial of service attacks.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1195.1">If you want to learn more about sym link attacks, check out the references in the </span><em class="italic"><span class="koboSpan" id="kobo.1196.1">Further Reading</span></em><span class="koboSpan" id="kobo.1197.1"> section.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1198.1">Also, bear in mind that security threats don’t always come from unauthorized intruders. </span><span class="koboSpan" id="kobo.1198.2">Authorized system users who can easily access the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1199.1">/tmp/</span></code><span class="koboSpan" id="kobo.1200.1"> directory can also be threats.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1201.1">Now that </span><a id="_idIndexMarker1295"/><span class="koboSpan" id="kobo.1202.1">you’ve seen the wrong way to do business, let’s look at the right way.</span></p>
    <h3 id="_idParaDest-428" class="heading 3"><span class="koboSpan" id="kobo.1203.1">The Right Way to Create Temporary Files</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1204.1">The absolute best way to create temporary files is to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1205.1">mktemp</span></code><span class="koboSpan" id="kobo.1206.1"> utility. </span><span class="koboSpan" id="kobo.1206.2">Here’s how it works from the command-line:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1207.1">donnie@fedora-server:~$ mktemp
/tmp/tmp.StfRN1YkBB
donnie@fedora-server:~$ ls -l /tmp/tmp.StfRN1YkBB
-rw-------. </span><span class="koboSpan" id="kobo.1207.2">1 donnie donnie 0 Jun 27 16:50 /tmp/tmp.StfRN1YkBB
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1208.1">This is cool, because it solves both of the problems that we had in the previous demo. </span><span class="koboSpan" id="kobo.1208.2">First, it automatically sets restrictive permissions on the files that it creates, so that nobody but the person who created them can access them. </span><span class="koboSpan" id="kobo.1208.3">Secondly, it creates files with random filenames, which makes the files safe from sym link attacks. </span><span class="koboSpan" id="kobo.1208.4">Let’s see how this works in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1209.1">tmp_file2.sh</span></code><span class="koboSpan" id="kobo.1210.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1211.1">#!/bin/bash
temp_file=$(mktemp)
echo "This file contains sensitive data." </span><span class="koboSpan" id="kobo.1211.2">&gt; "$temp_file"
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1212.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1213.1">temp_file=$(mktemp)</span></code><span class="koboSpan" id="kobo.1214.1"> line, I’m using command substitution to assign the output of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1215.1">mktemp</span></code><span class="koboSpan" id="kobo.1216.1"> command to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1217.1">temp_file</span></code><span class="koboSpan" id="kobo.1218.1"> variable. </span><span class="koboSpan" id="kobo.1218.2">Since </span><code class="inlineCode"><span class="koboSpan" id="kobo.1219.1">mktemp</span></code><span class="koboSpan" id="kobo.1220.1"> creates files with random filenames, the name of the temporary file will be different every time you run the script. </span><span class="koboSpan" id="kobo.1220.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1221.1">echo</span></code><span class="koboSpan" id="kobo.1222.1"> line is just sending some output into the temporary file. </span><span class="koboSpan" id="kobo.1222.2">Anyway, let’s see what we </span><a id="_idIndexMarker1296"/><span class="koboSpan" id="kobo.1223.1">have when we run this script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1224.1">donnie@fedora-server:~$ ./tmp_file2.sh
donnie@fedora-server:~$ cat /tmp/tmp.sggCBdUd1M
This file contains sensitive data.
</span><span class="koboSpan" id="kobo.1224.2">donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1225.1">As we’ve already noted above, the file is set with restrictive permissions, so that only I can access it:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1226.1">donnie@fedora-server:~$ ls -l /tmp/tmp.sggCBdUd1M
-rw-------. </span><span class="koboSpan" id="kobo.1226.2">1 donnie donnie 35 Jun 27 17:00 /tmp/tmp.sggCBdUd1M
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1227.1">Okay, this is all cool, and it looks good. </span><span class="koboSpan" id="kobo.1227.2">But, we still don’t have a way to automatically delete our temporary files when we no longer need them. </span><span class="koboSpan" id="kobo.1227.3">I mean, even though they’re all set with restrictive permissions, you still don’t want them hanging around when they’re no longer needed. </span><span class="koboSpan" id="kobo.1227.4">Now, you might be tempted to just put an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1228.1">rm</span></code><span class="koboSpan" id="kobo.1229.1"> command at the end of the script, as you see here in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1230.1">tmp_file3.sh</span></code><span class="koboSpan" id="kobo.1231.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1232.1">#!/bin/bash
temp_file=$(mktemp)
echo "This file contains sensitive data." </span><span class="koboSpan" id="kobo.1232.2">&gt; "$temp_file"
rm "$temp_file"
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1233.1">Sure, that works in a simple script like this one. </span><span class="koboSpan" id="kobo.1233.2">But, if you’re creating a complex script that could possibly exit without running to completion, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1234.1">rm</span></code><span class="koboSpan" id="kobo.1235.1"> command might not get invoked. </span><span class="koboSpan" id="kobo.1235.2">So, your best bet is to use a </span><strong class="keyWord"><span class="koboSpan" id="kobo.1236.1">trap</span></strong><span class="koboSpan" id="kobo.1237.1"> that will delete the temporary file, even if the script exits prematurely. </span><span class="koboSpan" id="kobo.1237.2">Here’s how that works, in the the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1238.1">tmp_file4.sh</span></code><span class="koboSpan" id="kobo.1239.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1240.1">#!/bin/bash
trap 'rm -f "$temp_file"' EXIT
temp_file=$(mktemp)
echo "This file contains sensitive data." </span><span class="koboSpan" id="kobo.1240.2">&gt; "$temp_file"
ls -l /tmp/tmp*
cat "$temp_file"
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1241.1">When you execute a script, it always opens in a new child shell. </span><span class="koboSpan" id="kobo.1241.2">When the script has either run to </span><a id="_idIndexMarker1297"/><span class="koboSpan" id="kobo.1242.1">completion or has exited prematurely, the child shell closes. </span><span class="koboSpan" id="kobo.1242.2">The second line in this script, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1243.1">trap</span></code><span class="koboSpan" id="kobo.1244.1"> line, specifies a command to run when that child shell closes. </span><span class="koboSpan" id="kobo.1244.2">In this case, we want the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1245.1">rm -f</span></code><span class="koboSpan" id="kobo.1246.1"> command to run. </span><span class="koboSpan" id="kobo.1246.2">(The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1247.1">-f</span></code><span class="koboSpan" id="kobo.1248.1"> switch forces the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1249.1">rm</span></code><span class="koboSpan" id="kobo.1250.1"> command to delete files without prompting the user.) After the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1251.1">echo</span></code><span class="koboSpan" id="kobo.1252.1"> line, which sends some text into the temporary file, I’ve added two lines that will prove that the temporary file really does get created. </span><span class="koboSpan" id="kobo.1252.2">Anyway, here’s what happens when I run the script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1253.1">donnie@fedora-server:~$ ./tmp_file4.sh
-rw-------. </span><span class="koboSpan" id="kobo.1253.2">1 donnie donnie 35 Jun 28 15:07 /tmp/tmp.6t5Qqx5WqZ
This file contains sensitive data.
</span><span class="koboSpan" id="kobo.1253.3">donnie@fedora-server:~$ ls -l /tmp/tmp*
ls: cannot access '/tmp/tmp*': No such file or directory
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1254.1">So, when I ran the script, it showed me the file and then showed me its contents, as I had hoped it would. </span><span class="koboSpan" id="kobo.1254.2">But when I ran the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1255.1">ls -l /tmp/tmp*</span></code><span class="koboSpan" id="kobo.1256.1"> command afterwards, it showed that no </span><code class="inlineCode"><span class="koboSpan" id="kobo.1257.1">tmp</span></code><span class="koboSpan" id="kobo.1258.1"> file exists. </span><span class="koboSpan" id="kobo.1258.2">This proves that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1259.1">trap</span></code><span class="koboSpan" id="kobo.1260.1"> command in the script really did delete the temporary file.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1261.1">As good as all this looks, there’s still one more modification that I’d like to show you in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1262.1">tmp_file5.sh</span></code><span class="koboSpan" id="kobo.1263.1"> script, as you see here:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1264.1">#!/bin/bash
trap 'rm -f "$temp_file"' EXIT
temp_file=$(mktemp) || exit 1
echo "This file contains sensitive data." </span><span class="koboSpan" id="kobo.1264.2">&gt; "$temp_file"
ls -l /tmp/tmp*
cat "$temp_file"
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1265.1">The only thing I did here was to add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1266.1">|| exit 1</span></code><span class="koboSpan" id="kobo.1267.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">temp_file</span></code><span class="koboSpan" id="kobo.1269.1"> line. </span><span class="koboSpan" id="kobo.1269.2">This makes it so that if for </span><a id="_idIndexMarker1298"/><span class="koboSpan" id="kobo.1270.1">some weird reason the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1271.1">mktemp</span></code><span class="koboSpan" id="kobo.1272.1"> command can’t create the temporary file, the script will exit gracefully with exit code 1. </span><span class="koboSpan" id="kobo.1272.2">In reality, it might not be needed here, because it’s almost a sure bet that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1273.1">mktemp</span></code><span class="koboSpan" id="kobo.1274.1"> will be able to create the temporary file. </span><span class="koboSpan" id="kobo.1274.2">But, it’s considered good programming practice to provide a graceful exit mechanism, and it certainly doesn’t hurt anything to have it.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1275.1">Note that you can also create temporary directories in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1276.1">/tmp/</span></code><span class="koboSpan" id="kobo.1277.1"> directory by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1278.1">mktemp</span></code><span class="koboSpan" id="kobo.1279.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1280.1">-d</span></code><span class="koboSpan" id="kobo.1281.1"> option switch.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1282.1">Okay, you now know how to work with temporary files in a secure manner. </span><span class="koboSpan" id="kobo.1282.2">Now, let’s move on to</span><a id="_idIndexMarker1299"/><span class="koboSpan" id="kobo.1283.1"> something else that can be a bit of a bugaboo. </span><span class="koboSpan" id="kobo.1283.2">That is, how to securely use passwords in scripts.</span></p>
    <h2 id="_idParaDest-429" class="heading 2"><span class="koboSpan" id="kobo.1284.1">Using Passwords in Shell Scripts</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1285.1">The information </span><a id="_idIndexMarker1300"/><span class="koboSpan" id="kobo.1286.1">in this section can help you out with two </span><a id="_idIndexMarker1301"/><span class="koboSpan" id="kobo.1287.1">different scenarios:</span></p>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.1288.1">You need </span><a id="_idIndexMarker1302"/><span class="koboSpan" id="kobo.1289.1">to create a script that a certain administrator or group of administrators will use, and place it where they can all access it. </span><span class="koboSpan" id="kobo.1289.2">These administrators all have limited privileges, and what they need to do requires the password to some remote server. </span><span class="koboSpan" id="kobo.1289.3">But, you don’t want them to know that password, because you don’t want to allow them to actually log into that server. </span><span class="koboSpan" id="kobo.1289.4">All you want them to do is just one specific job, such as copying files to that server.</span></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.1290.1">You need to create a script for your own use that requires a password to a remote server. </span><span class="koboSpan" id="kobo.1290.2">You want to set the script up to automatically run at a regularly scheduled time, as either a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1291.1">cron</span></code><span class="koboSpan" id="kobo.1292.1"> job or as a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1293.1">systemd</span></code><span class="koboSpan" id="kobo.1294.1"> timer job. </span><span class="koboSpan" id="kobo.1294.2">If the script has to prompt you for a password, the job will be interrupted and won’t run to completion.</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.1295.1">In both cases, you’ll need to embed a password into your script. </span><span class="koboSpan" id="kobo.1295.2">But, there’s a danger that your </span><a id="_idIndexMarker1303"/><span class="koboSpan" id="kobo.1296.1">password might leak out to</span><a id="_idIndexMarker1304"/><span class="koboSpan" id="kobo.1297.1"> unauthorized parties. </span><span class="koboSpan" id="kobo.1297.2">Naturally, you’ll want to prevent that. </span><span class="koboSpan" id="kobo.1297.3">So, let’s see how.</span></p>
    <h3 id="_idParaDest-430" class="heading 3"><span class="koboSpan" id="kobo.1298.1">Hands-on Lab – Encrypting Passwords</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1299.1">For this scenario, I’ll show you a solution that I borrowed from the </span><em class="italic"><span class="koboSpan" id="kobo.1300.1">How-to Geek</span></em><span class="koboSpan" id="kobo.1301.1"> website. </span><span class="koboSpan" id="kobo.1301.2">It’s a </span><a id="_idIndexMarker1305"/><span class="koboSpan" id="kobo.1302.1">good solution as far as it goes, but it’s only a partial solution, as you’ll soon see. </span><span class="koboSpan" id="kobo.1302.2">First though, let’s encrypt a password and create a script that uses it. </span><span class="koboSpan" id="kobo.1302.3">Then, I’ll show you the complete solution.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1303.1">I’ve placed the link to the original </span><em class="italic"><span class="koboSpan" id="kobo.1304.1">How-to Geek</span></em><span class="koboSpan" id="kobo.1305.1"> article in the </span><em class="italic"><span class="koboSpan" id="kobo.1306.1">Further Reading</span></em><span class="koboSpan" id="kobo.1307.1"> section. </span><span class="koboSpan" id="kobo.1307.2">Also, to avoid re-inventing the proverbial wheel, I won’t repeat the extensive explanations that the author of this article has already provided.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.1308.1">To begin, you’ll need a system with both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1309.1">openssl</span></code><span class="koboSpan" id="kobo.1310.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1311.1">sshpass</span></code><span class="koboSpan" id="kobo.1312.1"> packages installed. </span><span class="koboSpan" id="kobo.1312.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1313.1">openssl</span></code><span class="koboSpan" id="kobo.1314.1"> package is normally installed on pretty much every Linux, Unix, or Unix-like operating system, so you won’t have to worry about that. </span><span class="koboSpan" id="kobo.1314.2">You’ll only need to worry about installing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1315.1">sshpass</span></code><span class="koboSpan" id="kobo.1316.1">.</span></li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.1317.1">You’ll use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1318.1">openssl</span></code><span class="koboSpan" id="kobo.1319.1"> to encrypt your password, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1320.1">sshpass</span></code><span class="koboSpan" id="kobo.1321.1"> to automatically pass your password to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1322.1">ssh</span></code><span class="koboSpan" id="kobo.1323.1"> client.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1324.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1325.1">sshpass</span></code><span class="koboSpan" id="kobo.1326.1"> package is in the normal repositories for Fedora, Debian/Ubuntu, and FreeBSD. </span><span class="koboSpan" id="kobo.1326.2">The package name is the same in all cases, so just use your normal package manager to install it.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1327.1">Just for fun, I’ll be using the FreeBSD virtual machine for this lab, but you can use either of your Linux virtual machines if you desire. </span><span class="koboSpan" id="kobo.1327.2">(The procedure will be the same, regardless.)</span></p>
    </div>
    <ol>
      <li class="numberedList" value="2"><span class="koboSpan" id="kobo.1328.1">Create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1329.1">.secret_vault.txt</span></code><span class="koboSpan" id="kobo.1330.1"> file that contains the encrypted password for the </span><a id="_idIndexMarker1306"/><span class="koboSpan" id="kobo.1331.1">remote server that you want to access, like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1332.1">donnie@freebsd14:~ $ echo 'Chicken&amp;&amp;Lips' | openssl enc -aes-256-cbc -md sha512
-a -pbkdf2 -iter 100000 -salt -pass pass:'Turkey&amp;&amp;Lips' &gt; .secret_vault.txt
donnie@freebsd14:~ $
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.1333.1">In this command, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1334.1">Chicken&amp;&amp;Lips</span></code><span class="koboSpan" id="kobo.1335.1"> is the password for the remote server that you want to access, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1336.1">Turkey&amp;&amp;Lips</span></code><span class="koboSpan" id="kobo.1337.1"> is the password that you’ll need to decrypt the password. </span><span class="koboSpan" id="kobo.1337.2">(Why you need this decryption password will become clear in a few moments.) </span><code class="inlineCode"><span class="koboSpan" id="kobo.1338.1">Chicken&amp;&amp;Lips</span></code><span class="koboSpan" id="kobo.1339.1"> is the password that you’ll encrypt.</span></p>
    <ol>
      <li class="numberedList" value="3"><span class="koboSpan" id="kobo.1340.1">Use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1341.1">chmod 600 .secret_vault.txt</span></code><span class="koboSpan" id="kobo.1342.1"> command to set the read and write permissions for yourself, and to remove all permissions from everyone else:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1343.1">donnie@freebsd14:~ $ ls -l .secret_vault.txt
-rw-r--r--  1 donnie donnie 45 Jul 31 16:31 .secret_vault.txt
donnie@freebsd14:~ $ chmod 600 .secret_vault.txt
donnie@freebsd14:~ $ ls -l .secret_vault.txt
-rw-------  1 donnie donnie 45 Jul 31 16:31 .secret_vault.txt
donnie@freebsd14:~ $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1344.1">Look in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1345.1">.secret_vault.txt</span></code><span class="koboSpan" id="kobo.1346.1"> file, and you’ll see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1347.1">sha512</span></code><span class="koboSpan" id="kobo.1348.1"> hash value of your remote </span><a id="_idIndexMarker1307"/><span class="koboSpan" id="kobo.1349.1">server password:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1350.1">donnie@freebsd14:~ $ cat .secret_vault.txt
U2FsdGVkX18eeWfcaGbr0/4Fd70vTC3vIjVgymXwfCM=
donnie@freebsd14:~ $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1351.1">Create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1352.1">go-remote.sh</span></code><span class="koboSpan" id="kobo.1353.1"> script, using your own information for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1354.1">Remote_User</span></code><span class="koboSpan" id="kobo.1355.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1356.1">Remote_Password</span></code><span class="koboSpan" id="kobo.1357.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1358.1">Remote_Server</span></code><span class="koboSpan" id="kobo.1359.1">:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1360.1">#!/bin/bash
# name of the remote account
Remote_User=horatio
# password for the remote account
Remote_Password=$(openssl enc -aes-256-cbc -md sha512 -a -d -pbkdf2 -iter 100000 -salt -pass pass:'Turkey&amp;&amp;Lips' &lt; .secret_vault.txt)
# remote computer
Remote_Server=192.168.0.20
   
# connect to the remote computer and put a timestamp in a file called script.log
sshpass -p $Remote_Password ssh -T $Remote_User@$Remote_Server &lt;&lt; _remote_commands
echo $USER "-" $(date) &gt;&gt; /home/$Remote_User/script.log
_remote_commands
</span></code></pre>
      </li>
    </ol>
    <div class="note one">
      <p class="normal"><span class="koboSpan" id="kobo.1361.1">As you’ll see</span><a id="_idIndexMarker1308"/><span class="koboSpan" id="kobo.1362.1"> explained in the original </span><em class="italic"><span class="koboSpan" id="kobo.1363.1">How-to Geek</span></em><span class="koboSpan" id="kobo.1364.1"> article, the password for decrypting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1365.1">Remote_Password</span></code><span class="koboSpan" id="kobo.1366.1"> has to be in the script, in plain-text. </span><span class="koboSpan" id="kobo.1366.2">The author of the article doesn’t consider this a problem, because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1367.1">.secret_vault.txt</span></code><span class="koboSpan" id="kobo.1368.1"> file is a so-called hidden file that’s in your own home directory, and because the permissions on it are set so that only the file owner can access it. </span><span class="koboSpan" id="kobo.1368.2">However, that explanation only makes sense if the plain-text script is in a location that nobody else can access. </span><span class="koboSpan" id="kobo.1368.3">(I’ll explain more about that in just a bit.)</span></p>
    </div>
    <p class="normal one"><span class="koboSpan" id="kobo.1369.1">Instead of hard-coding the information for the remote user, remote server, and remote server password into the body of the script, I’m assigning the values for this information to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1370.1">Remote_User</span></code><span class="koboSpan" id="kobo.1371.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1372.1">Remote_Password</span></code><span class="koboSpan" id="kobo.1373.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1374.1">Remote_Server</span></code><span class="koboSpan" id="kobo.1375.1"> variables. </span><span class="koboSpan" id="kobo.1375.2">To obtain the decrypted password that I need to assign to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1376.1">Remote_Password</span></code><span class="koboSpan" id="kobo.1377.1"> variable, I’m using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1378.1">stdin</span></code><span class="koboSpan" id="kobo.1379.1"> (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1380.1">&lt;</span></code><span class="koboSpan" id="kobo.1381.1">) redirector to read the password hash from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1382.1">.secret_vault.txt</span></code><span class="koboSpan" id="kobo.1383.1"> file into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1384.1">openssl</span></code><span class="koboSpan" id="kobo.1385.1"> command. </span></p>
    <p class="normal one"><span class="koboSpan" id="kobo.1386.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1387.1">sshpass -p</span></code><span class="koboSpan" id="kobo.1388.1"> command passes Horatio’s password, from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1389.1">Remote_Password</span></code><span class="koboSpan" id="kobo.1390.1"> variable, to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1391.1">ssh</span></code><span class="koboSpan" id="kobo.1392.1"> client. </span><span class="koboSpan" id="kobo.1392.2">Since we don’t need for Horatio to open a remote terminal, we’ll disable that with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1393.1">-T</span></code><span class="koboSpan" id="kobo.1394.1"> option for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1395.1">ssh</span></code><span class="koboSpan" id="kobo.1396.1">. </span><span class="koboSpan" id="kobo.1396.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1397.1">_remote_commands</span></code> <em class="italic"><span class="koboSpan" id="kobo.1398.1">here document</span></em><span class="koboSpan" id="kobo.1399.1"> contains a single command that will be executed on the remote server. </span><span class="koboSpan" id="kobo.1399.2">That is, it will create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1400.1">script.log</span></code><span class="koboSpan" id="kobo.1401.1"> file that contains a timestamp in Horatio’s home directory.</span></p>
    <ol>
      <li class="numberedList" value="6"><span class="koboSpan" id="kobo.1402.1">In order for </span><a id="_idIndexMarker1309"/><span class="koboSpan" id="kobo.1403.1">this script to work, you’ll need to have Horatio’s public SSH key for the remote server in your </span><code class="inlineCode"><span class="koboSpan" id="kobo.1404.1">.ssh/known_hosts</span></code><span class="koboSpan" id="kobo.1405.1"> file. </span><span class="koboSpan" id="kobo.1405.2">So, before you try to run the script, have Horatio log into the remote server in the normal manner, and then have him log back out, like so:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1406.1">donnie@freebsd14:~ ssh horatio@192.168.0.20
. </span><span class="koboSpan" id="kobo.1406.2">. </span><span class="koboSpan" id="kobo.1406.3">.
</span><span class="koboSpan" id="kobo.1406.4">. </span><span class="koboSpan" id="kobo.1406.5">. </span><span class="koboSpan" id="kobo.1406.6">.
</span><span class="koboSpan" id="kobo.1406.7">horatio@ubuntu2404:~$ exit
donnie@freebsd14:~
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1407.1">Execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1408.1">go-remote.sh</span></code><span class="koboSpan" id="kobo.1409.1"> script. </span><span class="koboSpan" id="kobo.1409.2">You should see the login information from the remote server come up momentarily, and then be returned to the command prompt of your local machine.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1410.1">Log into Horatio’s account on the remote server. </span><span class="koboSpan" id="kobo.1410.2">You should see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1411.1">script.log</span></code><span class="koboSpan" id="kobo.1412.1"> file that contains a timestamp. </span><span class="koboSpan" id="kobo.1412.2">It should look something like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1413.1">horatio@ubuntu2404:~$ ls -l script.log
-rw-rw-r-- 1 horatio horatio 38 Jul 31 21:34 script.log
horatio@ubuntu2404:~$ cat script.log
donnie - Wed Jul 31 17:34:44 EDT 2024
horatio@ubuntu2404:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.1414.1">If you see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1415.1">script.log</span></code><span class="koboSpan" id="kobo.1416.1"> file in Horatio’s home directory, you have achieved coolness. </span><span class="koboSpan" id="kobo.1416.2">But, is this </span><a id="_idIndexMarker1310"/><span class="koboSpan" id="kobo.1417.1">really a complete solution? </span><span class="koboSpan" id="kobo.1417.2">Well, no. </span><span class="koboSpan" id="kobo.1417.3">Let’s look at some potential problems that the author of this </span><em class="italic"><span class="koboSpan" id="kobo.1418.1">How-to Geek</span></em><span class="koboSpan" id="kobo.1419.1"> article doesn’t address.</span></p>
    <h4 class="heading 4"><span class="koboSpan" id="kobo.1420.1">Understanding the Problems with this Solution</span></h4>
    <p class="normal"><span class="koboSpan" id="kobo.1421.1">Again I ask, is the solution that I’ve just presented a good one? </span><span class="koboSpan" id="kobo.1421.2">Well, that depends upon a few factors. </span><span class="koboSpan" id="kobo.1421.3">I mean, if you have the script and the hashed password in your own home directory where </span><a id="_idIndexMarker1311"/><span class="koboSpan" id="kobo.1422.1">only you can access it, it might be okay. </span><span class="koboSpan" id="kobo.1422.2">But, here’s an important consideration. </span><span class="koboSpan" id="kobo.1422.3">Some operating systems, such as FreeBSD and older implementations of Linux, have users’ home directories open to other users by default. </span><span class="koboSpan" id="kobo.1422.4">Anyone who can get into your home directory can read the encryption password in your plain-text script, and see the name of the file that contains the encrypted password. </span><span class="koboSpan" id="kobo.1422.5">In fact, let’s take a look at that.</span></p>
    <h5 class="heading 5"><span class="koboSpan" id="kobo.1423.1">Home Directory Permissions on FreeBSD</span></h5>
    <p class="normal"><span class="koboSpan" id="kobo.1424.1">Here’s </span><a id="_idIndexMarker1312"/><span class="koboSpan" id="kobo.1425.1">how it looks on FreeBSD:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1426.1">donnie@freebsd14:~ $ cd ..
</span><span class="koboSpan" id="kobo.1426.2">donnie@freebsd14:/home $ ls -l
total 17
drwxr-xr-x  9 donnie  donnie  68 Jul 31 17:52 donnie
drwxr-xr-x  2 horatio horatio 10 Jul 30 17:38 horatio
donnie@freebsd14:/home $ cd horatio/
donnie@freebsd14:/home/horatio $ ls
donnie@freebsd14:/home/horatio $ ls -a
.        </span><span class="koboSpan" id="kobo.1426.3">.cshrc        .login_conf    .mailrc        .sh_history
..        </span><span class="koboSpan" id="kobo.1426.4">.login        .mail_aliases    .profile    .shrc
donnie@freebsd14:/home/horatio $
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1427.1">As you see, by default, FreeBSD sets the read and execute permissions for </span><em class="italic"><span class="koboSpan" id="kobo.1428.1">others</span></em><span class="koboSpan" id="kobo.1429.1"> on users’ home directories. </span><span class="koboSpan" id="kobo.1429.2">In this case, it means that Horatio can see what’s in my directory, and I can see what’s in his directory, without having to use any kind of administrative privileges. </span><span class="koboSpan" id="kobo.1429.3">Fortunately, I can easily fix that for myself, like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1430.1">donnie@freebsd14:/home $ chmod 700 donnie/
donnie@freebsd14:/home $ ls -ld donnie/
drwx------  9 donnie donnie 68 Jul 31 18:01 donnie/
donnie@freebsd14:/home $
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1431.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1432.1">chmod 700</span></code><span class="koboSpan" id="kobo.1433.1"> command preserves the read, write, and execute permissions that I have for myself, and removes all permissions for everyone else. </span><span class="koboSpan" id="kobo.1433.2">To ensure that any future users have this restrictive permissions settings on their FreeBSD home directories, create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1434.1">/etc/adduser.conf</span></code><span class="koboSpan" id="kobo.1435.1"> file with that setting, like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1436.1">donnie@freebsd14:~ $ sudo adduser -C
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1437.1">This is an interactive utility that prompts you for a lot of information. </span><span class="koboSpan" id="kobo.1437.2">Accept the defaults </span><a id="_idIndexMarker1313"/><span class="koboSpan" id="kobo.1438.1">for everything except for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">Home directory permissions (Leave empty for default):</span></code><span class="koboSpan" id="kobo.1440.1"> line. </span><span class="koboSpan" id="kobo.1440.2">For it, enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">700</span></code><span class="koboSpan" id="kobo.1442.1"> as the value. </span><span class="koboSpan" id="kobo.1442.2">Test your setup by creating another user account. </span><span class="koboSpan" id="kobo.1442.3">You should see that the new user will have restrictive permissions set on his or her home directory, as you see here for the account that I just created for Vicky:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1443.1">donnie@freebsd14:/home $ ls -ld vicky/
drwx------  2 vicky vicky 9 Jul 31 18:04 vicky/
donnie@freebsd14:/home $
</span></code></pre>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1444.1">Also, keep in mind that when you install FreeBSD, the user account that the installer creates for you will have the more open permissions settings for your home directory. </span><span class="koboSpan" id="kobo.1444.2">So, after you complete the installation, be sure to set your home directory permissions to the more restrictive value. </span><span class="koboSpan" id="kobo.1444.3">Then, run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1445.1">sudo adduser -C</span></code><span class="koboSpan" id="kobo.1446.1"> command to create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1447.1">/etc/adduser.conf</span></code><span class="koboSpan" id="kobo.1448.1"> file, as I’ve just shown you.</span></p>
    </div>
    <h5 class="heading 5"><span class="koboSpan" id="kobo.1449.1">Home Directories on Linux</span></h5>
    <p class="normal"><span class="koboSpan" id="kobo.1450.1">Home directory permissions on Linux aren’t as much of a problem, because many modern Linux </span><a id="_idIndexMarker1314"/><span class="koboSpan" id="kobo.1451.1">distros create home directories with restrictive permissions by default. </span><span class="koboSpan" id="kobo.1451.2">For example, here’s how they look on any Red Hat-type system, such as Fedora, and on Debian 12:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1452.1">donnie@fedora:/home$ ls -l
total 0
drwx------. </span><span class="koboSpan" id="kobo.1452.2">1 donnie donnie 25094 Jul 31 13:46 donnie
donnie@fedora:/home$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1453.1">And, here’s how they look on Ubuntu 22.04 and newer:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1454.1">donnie@ubuntu2404:/home$ ls -l
total 12
drwxr-x--- 13 donnie  donnie  4096 Jul 31 22:22 donnie
drwxr-x---  3 horatio horatio 4096 Jul 31 21:34 horatio
drwxr-x---  2 vicky   vicky   4096 Jul  6 19:05 vicky
donnie@ubuntu2404:/home$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1455.1">The only difference with Ubuntu is that it has read and execute permissions for the user’s </span><a id="_idIndexMarker1315"/><span class="koboSpan" id="kobo.1456.1">private group, where the Red Hat distros and Debian don’t. </span><span class="koboSpan" id="kobo.1456.2">That’s okay because either way, nobody can access the home directories except for their respective owners.</span></p>
    <h5 class="heading 5"><span class="koboSpan" id="kobo.1457.1">Home Directories on Other Linux or Unix Distros</span></h5>
    <p class="normal"><span class="koboSpan" id="kobo.1458.1">Other Linux or Unix distros might have other ways of doing business with their users’ home </span><a id="_idIndexMarker1316"/><span class="koboSpan" id="kobo.1459.1">directories. </span><span class="koboSpan" id="kobo.1459.2">If you work with any of them, be sure to check the home directory permissions settings, and make any necessary changes.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1460.1">Okay, that does it for home directory permissions. </span><span class="koboSpan" id="kobo.1460.2">But, what if you need to place a script somewhere else where other administrators can access it? </span><span class="koboSpan" id="kobo.1460.3">Let’s see what we can </span><a id="_idIndexMarker1317"/><span class="koboSpan" id="kobo.1461.1">do about that.</span></p>
    <h4 class="heading 4"><span class="koboSpan" id="kobo.1462.1">Hands-on Lab: Making an Untraceable Binary</span></h4>
    <p class="normal"><span class="koboSpan" id="kobo.1463.1">If other administrators need to access a script that requires an embedded password, you might </span><a id="_idIndexMarker1318"/><span class="koboSpan" id="kobo.1464.1">have to place both it and the encrypted password file into some other directory, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1465.1">/usr/local/bin/</span></code><span class="koboSpan" id="kobo.1466.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1467.1">/usr/local/sbin/</span></code><span class="koboSpan" id="kobo.1468.1">. </span><span class="koboSpan" id="kobo.1468.2">In those cases, you’ll want to ensure that nobody can read or modify the script, and that nobody can trace it. </span><span class="koboSpan" id="kobo.1468.3">That’s because anyone who can read your script, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1469.1">go-remote.sh</span></code><span class="koboSpan" id="kobo.1470.1"> script in this case, can see the password that you need to decrypt the remote server password, as well as the name of the file that contains the remote server password. </span><span class="koboSpan" id="kobo.1470.2">And of course, anyone who can edit this file can add extra commands to do possibly nasty things on the remote server.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1471.1">Fortunately, you can easily solve this problem by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1472.1">shc</span></code><span class="koboSpan" id="kobo.1473.1"> to turn your scripts into executable binary files, as I showed you a few pages back in the </span><em class="italic"><span class="koboSpan" id="kobo.1474.1">Controlling Access to Your Scripts</span></em><span class="koboSpan" id="kobo.1475.1"> section. </span><span class="koboSpan" id="kobo.1475.2">But, when you do this, you absolutely </span><em class="italic"><span class="koboSpan" id="kobo.1476.1">must</span></em><span class="koboSpan" id="kobo.1477.1"> use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1478.1">shc</span></code><span class="koboSpan" id="kobo.1479.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1480.1">-U</span></code><span class="koboSpan" id="kobo.1481.1"> option to make the binary untraceable.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1482.1">If you don’t make your binary files untraceable, anyone who can access the files can use debugging utilities such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1483.1">strace</span></code><span class="koboSpan" id="kobo.1484.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1485.1">truss</span></code><span class="koboSpan" id="kobo.1486.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1487.1">dtrace</span></code><span class="koboSpan" id="kobo.1488.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1489.1">dtruss</span></code><span class="koboSpan" id="kobo.1490.1"> to obtain the plain-text password, even if it has been encrypted with the strongest algorithm known to mankind.</span></p>
    </div>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.1491.1">To demonstrate, go back </span><a id="_idIndexMarker1319"/><span class="koboSpan" id="kobo.1492.1">to the same virtual machine that you used to create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1493.1">go-remote.sh</span></code><span class="koboSpan" id="kobo.1494.1"> script. </span><span class="koboSpan" id="kobo.1494.2">Turn the script into an executable binary, using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1495.1">shc</span></code><span class="koboSpan" id="kobo.1496.1"> without the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1497.1">-U</span></code><span class="koboSpan" id="kobo.1498.1"> option:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1499.1">donnie@freebsd14:~ $ shc -f go-remote.sh -o go-remote
donnie@freebsd14:~ $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1500.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1501.1">truss</span></code><span class="koboSpan" id="kobo.1502.1"> on FreeBSD or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1503.1">strace</span></code><span class="koboSpan" id="kobo.1504.1"> on Linux, create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1505.1">trace1.txt</span></code><span class="koboSpan" id="kobo.1506.1"> trace file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">go-remote</span></code><span class="koboSpan" id="kobo.1508.1"> executable.</span></li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.1509.1">On FreeBSD:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1510.1">donnie@freebsd14:~ $ truss ./go-remote 2&gt; trace1.txt
</span></code></pre>
    <p class="normal one"><span class="koboSpan" id="kobo.1511.1">On Linux:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1512.1">donnie@fedora-server:~$ strace ./go-remote 2&gt; trace1.txt
</span></code></pre>
    <ol>
      <li class="numberedList" value="3"><span class="koboSpan" id="kobo.1513.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1514.1">trace1.txt</span></code><span class="koboSpan" id="kobo.1515.1"> file, and scroll down until you see Horatio’s password for the remote server. </span><span class="koboSpan" id="kobo.1515.2">In my own file, it was on line 191, and it looks like this:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1516.1">read(3,"Chicken&amp;&amp;Lips\n",4096)                   = 14 (0xe)
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.1517.1">Yes indeed, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1518.1">Chicken&amp;&amp;Lips</span></code><span class="koboSpan" id="kobo.1519.1"> really is Horatio’s password for the remote server.</span></p>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.1520.1">Re-create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1521.1">go-remote</span></code><span class="koboSpan" id="kobo.1522.1"> binary, using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1523.1">-U</span></code><span class="koboSpan" id="kobo.1524.1"> option to make it untraceable:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1525.1">donnie@freebsd14:~ $ shc -Uf go-remote.sh -o go-remote
donnie@freebsd14:~ $
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1526.1">Repeat </span><em class="italic"><span class="koboSpan" id="kobo.1527.1">Step 2</span></em><span class="koboSpan" id="kobo.1528.1">, except this time save the output to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1529.1">trace2.txt</span></code><span class="koboSpan" id="kobo.1530.1"> file:</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1531.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1532.1">trace2.txt</span></code><span class="koboSpan" id="kobo.1533.1"> file and search for Horatio’s password. </span><span class="koboSpan" id="kobo.1533.2">(Spoiler alert: This time, you won’t find it.)</span><div class="note">
          <p class="normal"><span class="koboSpan" id="kobo.1534.1">Now, after all this, I need to let you in on a little secret. </span><span class="koboSpan" id="kobo.1534.2">That is, that neither Horatio’s username nor the address of the remote server shows up in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1535.1">truss</span></code><span class="koboSpan" id="kobo.1536.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1537.1">strace</span></code><span class="koboSpan" id="kobo.1538.1"> output. </span><span class="koboSpan" id="kobo.1538.2">So, anyone who were to trace your binaries will have the password, but no username or server address. </span><span class="koboSpan" id="kobo.1538.3">But, don’t think that you’re all good because of this. </span><span class="koboSpan" id="kobo.1538.4">Remember, you need to think like a malicious hacker. </span><span class="koboSpan" id="kobo.1538.5">Any malicious hacker worth his or her salt would already have used other means to map the servers on your network, and would have found a way to enumerate a list of possible usernames. </span><span class="koboSpan" id="kobo.1538.6">So, even though this procedure only gives hackers one piece of the puzzle, it’s still an important piece that can be combined with the other pieces.</span></p>
        </div>
      </li>
    </ol>
    <p class="normal"><span class="koboSpan" id="kobo.1539.1">All right, I think we’re </span><a id="_idIndexMarker1320"/><span class="koboSpan" id="kobo.1540.1">about through with this topic. </span><span class="koboSpan" id="kobo.1540.2">Let’s now take a quick look at secure coding practices.</span></p>
    <h1 id="_idParaDest-431" class="heading 1"><span class="koboSpan" id="kobo.1541.1">Understanding Command Injection with eval</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.1542.1">Another major problem with shell script security involves scripts that accept input from untrusted users </span><a id="_idIndexMarker1321"/><span class="koboSpan" id="kobo.1543.1">or untrusted sources. </span><span class="koboSpan" id="kobo.1543.2">If the script is coded incorrectly, an attacker could use it to inject malicious commands as the script’s input. </span><span class="koboSpan" id="kobo.1543.3">Before we look at examples of that, let’s look the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1544.1">eval</span></code><span class="koboSpan" id="kobo.1545.1"> command, which facilitates passing data or commands into a script.</span></p>
    <h2 id="_idParaDest-432" class="heading 2"><span class="koboSpan" id="kobo.1546.1">Using eval on the Command-line</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1547.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1548.1">eval</span></code><span class="koboSpan" id="kobo.1549.1"> command is </span><a id="_idIndexMarker1322"/><span class="koboSpan" id="kobo.1550.1">a shell builtin that’s available on most shells. </span><span class="koboSpan" id="kobo.1550.2">It’s very handy when used properly, but dangerous when used improperly. </span><span class="koboSpan" id="kobo.1550.3">Before we get into that, let’s look at how </span><code class="inlineCode"><span class="koboSpan" id="kobo.1551.1">eval</span></code><span class="koboSpan" id="kobo.1552.1"> works on the command-line.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1553.1">Okay, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1554.1">eval</span></code><span class="koboSpan" id="kobo.1555.1"> is one of those commands that can be really complex to fully understand. </span><span class="koboSpan" id="kobo.1555.2">So, to keep things simple, I’ll be presenting some rather simplistic </span><code class="inlineCode"><span class="koboSpan" id="kobo.1556.1">eval</span></code><span class="koboSpan" id="kobo.1557.1"> demos in this section. </span><span class="koboSpan" id="kobo.1557.2">Even though they’ll demonstrate things that you’ll never do in real life, they’ll serve the purpose of demonstrating the concepts.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1558.1">For anyone who would like to see more in-depth coverage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1559.1">eval</span></code><span class="koboSpan" id="kobo.1560.1">, I’ll drop some links into the </span><em class="italic"><span class="koboSpan" id="kobo.1561.1">Further Reading</span></em><span class="koboSpan" id="kobo.1562.1"> section.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1563.1">The best way to think of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1564.1">eval</span></code><span class="koboSpan" id="kobo.1565.1"> is that you can use it to dynamically process commands that the shell would normally treat as meaningless text strings. </span><span class="koboSpan" id="kobo.1565.2">For example, let’s say that we </span><a id="_idIndexMarker1323"/><span class="koboSpan" id="kobo.1566.1">want to find the date from three weeks ago. </span><span class="koboSpan" id="kobo.1566.2">We would use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1567.1">date</span></code><span class="koboSpan" id="kobo.1568.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1569.1">--date=</span></code><span class="koboSpan" id="kobo.1570.1"> option, like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1571.1">donnie@fedora-server:~$ date
Wed Aug  7 02:48:23 PM EDT 2024
donnie@fedora-server:~$ date --date="3 weeks ago"
Wed Jul 17 02:48:25 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1572.1">As you see, I just used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1573.1">"3 weeks ago"</span></code><span class="koboSpan" id="kobo.1574.1"> text string as the argument for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1575.1">--date</span></code><span class="koboSpan" id="kobo.1576.1"> option, which works just fine. </span><span class="koboSpan" id="kobo.1576.2">Now, let’s assign this date command to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1577.1">threeweeksago</span></code><span class="koboSpan" id="kobo.1578.1"> variable and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1579.1">echo</span></code><span class="koboSpan" id="kobo.1580.1"> back the results, like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1581.1">donnie@fedora-server:~$ threeweeksago='date --date="3 weeks ago"'
donnie@fedora-server:~$ echo $threeweeksago
date --date="3 weeks ago"
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1582.1">As you see, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1583.1">echo</span></code><span class="koboSpan" id="kobo.1584.1"> command just returned the text string that I assigned to the variable. </span><span class="koboSpan" id="kobo.1584.2">For some real magic, watch what happens when I replace </span><code class="inlineCode"><span class="koboSpan" id="kobo.1585.1">echo</span></code><span class="koboSpan" id="kobo.1586.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1587.1">eval</span></code><span class="koboSpan" id="kobo.1588.1">:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1589.1">donnie@fedora-server:~$ eval $threeweeksago
Thu Jul 18 04:02:14 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1590.1">Now, let’s wait a few minutes and run this again.</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1591.1">donnie@fedora-server:~$ eval $threeweeksago
Thu Jul 18 04:05:10 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1592.1">Look carefully, and you’ll see that the second </span><code class="inlineCode"><span class="koboSpan" id="kobo.1593.1">eval</span></code><span class="koboSpan" id="kobo.1594.1"> command has updated the time value. </span><span class="koboSpan" id="kobo.1594.2">This sort of thing can be handy in scripting, because it allows you to assign a command to a variable, and then use that variable throughout the rest of the script. </span><span class="koboSpan" id="kobo.1594.3">This allows you to </span><a id="_idIndexMarker1324"/><span class="koboSpan" id="kobo.1595.1">execute the command in various parts of the script, without having to type out the entire command multiple times. </span><span class="koboSpan" id="kobo.1595.2">But, as I’ve already mentioned, there’s both a safe way and a </span><a id="_idIndexMarker1325"/><span class="koboSpan" id="kobo.1596.1">dangerous way to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1597.1">eval</span></code><span class="koboSpan" id="kobo.1598.1">. </span><span class="koboSpan" id="kobo.1598.2">Let’s first look at the safe way.</span></p>
    <h2 id="_idParaDest-433" class="heading 2"><span class="koboSpan" id="kobo.1599.1">Using eval Safely</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1600.1">Let’s take </span><a id="_idIndexMarker1326"/><span class="koboSpan" id="kobo.1601.1">a look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1602.1">eval-test1.sh</span></code><span class="koboSpan" id="kobo.1603.1"> script to see a simple example of safe </span><code class="inlineCode"><span class="koboSpan" id="kobo.1604.1">eval</span></code><span class="koboSpan" id="kobo.1605.1"> usage:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1606.1">#!/bin/bash
threeweeksago='date --date="3 weeks ago"'
eval $threeweeksago
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1607.1">Running the script looks like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1608.1">donnie@fedora-server:~$ ./eval-test1.sh
Thu Jul 18 04:19:25 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1609.1">The reason this is safe is because we’re feeding </span><code class="inlineCode"><span class="koboSpan" id="kobo.1610.1">eval</span></code><span class="koboSpan" id="kobo.1611.1"> a text string that comes from within the script itself. </span><span class="koboSpan" id="kobo.1611.2">As long as you have the permissions on this script locked down so that nobody can modify it, it’s perfectly sane and safe. </span><span class="koboSpan" id="kobo.1611.3">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1612.1">eval</span></code><span class="koboSpan" id="kobo.1613.1"> in this way makes it impossible for attackers to insert their own malicious commands.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1614.1">Of course, this script is rather pointless, because it doesn’t do anything at all useful. </span><span class="koboSpan" id="kobo.1614.2">So, let’s look at a more practical example in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1615.1">eval-test2.sh</span></code><span class="koboSpan" id="kobo.1616.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1617.1">#!/bin/bash
desiredDate='date --date="1 month ago"'
datestamp=$(eval "$desiredDate")
echo "I'm creating a report with the $datestamp timestamp in the filename." </span><span class="koboSpan" id="kobo.1617.2">&gt; 
somefile_"$datestamp".txt
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1618.1">Here, I’m using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1619.1">eval</span></code><span class="koboSpan" id="kobo.1620.1"> within a command substitution construct to create the value for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1621.1">datestamp</span></code><span class="koboSpan" id="kobo.1622.1"> variable. </span><span class="koboSpan" id="kobo.1622.2">I’ll use then use this </span><code class="inlineCode"><span class="koboSpan" id="kobo.1623.1">datestamp</span></code><span class="koboSpan" id="kobo.1624.1"> variable to insert a datestamp into both the text file, and the name of the text file. </span><span class="koboSpan" id="kobo.1624.2">Here’s how it looks when I run the script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1625.1">donnie@fedora-server:~$ ./eval-test2.sh
donnie@fedora-server:~$ ls -l somefile_Thu*
-rw-r--r--. </span><span class="koboSpan" id="kobo.1625.2">1 donnie donnie 90 Aug  8 16:42 'somefile_Thu Jul 18 04:42:31 PM EDT 2024.txt'
donnie@fedora-server:~$ cat "somefile_Thu Jul 18 04:42:31 PM EDT 2024.txt"
I'm creating a report with the Thu Jul 18 04:42:31 PM EDT 2024 timestamp in the filename.
</span><span class="koboSpan" id="kobo.1625.3">donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1626.1">As you see, it works just fine. </span><span class="koboSpan" id="kobo.1626.2">And, if I were to run this command a few moments later, I would see </span><a id="_idIndexMarker1327"/><span class="koboSpan" id="kobo.1627.1">a new file with a new timestamp. </span><span class="koboSpan" id="kobo.1627.2">And of course, if I were to decide to change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1628.1">--date</span></code><span class="koboSpan" id="kobo.1629.1"> value to something else, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1630.1">"1 month ago"</span></code><span class="koboSpan" id="kobo.1631.1">, I would only have to make the change in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1632.1">desiredDate=</span></code><span class="koboSpan" id="kobo.1633.1"> line, instead of having to change it multiple times throughout the script.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1634.1">So, now that I’ve shown you the safe way to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1635.1">eval</span></code><span class="koboSpan" id="kobo.1636.1">, let’s look at the dangerous way.</span></p>
    <h2 id="_idParaDest-434" class="heading 2"><span class="koboSpan" id="kobo.1637.1">Using eval Dangerously</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1638.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1639.1">eval-test3.sh</span></code><span class="koboSpan" id="kobo.1640.1"> script shows a very simple example of what you </span><em class="italic"><span class="koboSpan" id="kobo.1641.1">never</span></em><span class="koboSpan" id="kobo.1642.1"> want to do:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1643.1">#!/bin/bash
eval $1
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1644.1">Yeah, I know </span><a id="_idIndexMarker1328"/><span class="koboSpan" id="kobo.1645.1">what you’re thinking. </span><span class="koboSpan" id="kobo.1645.2">Nobody would ever create such a simplistic script that uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1646.1">eval</span></code><span class="koboSpan" id="kobo.1647.1"> in this manner. </span><span class="koboSpan" id="kobo.1647.2">That’s okay though, because it serves the purpose of demonstrating the concept. </span><span class="koboSpan" id="kobo.1647.3">Let’s try it out to see what happens.</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1648.1">donnie@fedora-server:~$ ./eval-test3.sh 'date --date="1 day ago"'
Wed Aug  7 05:14:48 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1649.1">As you see, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1650.1">date</span></code><span class="koboSpan" id="kobo.1651.1"> command gets passed into </span><code class="inlineCode"><span class="koboSpan" id="kobo.1652.1">eval</span></code><span class="koboSpan" id="kobo.1653.1"> as positional parameter </span><code class="inlineCode"><span class="koboSpan" id="kobo.1654.1">$1</span></code><span class="koboSpan" id="kobo.1655.1">. </span><span class="koboSpan" id="kobo.1655.2">This seems safe enough, but is it really? </span><span class="koboSpan" id="kobo.1655.3">The key here is that anyone who runs this script can insert any command that he or she wants to run. </span><span class="koboSpan" id="kobo.1655.4">For example, let’s say that this script is in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1656.1">/usr/local/bin/</span></code><span class="koboSpan" id="kobo.1657.1"> directory. </span><span class="koboSpan" id="kobo.1657.2">The permissions are set so that nobody can modify it, but also so that every non-privileged user can execute it. </span><span class="koboSpan" id="kobo.1657.3">So, what could a malicious hacker accomplish with this? </span><span class="koboSpan" id="kobo.1657.4">Let’s see.</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1658.1">donnie@fedora-server:~$ eval-test3.sh 'cat /etc/passwd'
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
. </span><span class="koboSpan" id="kobo.1658.2">. </span><span class="koboSpan" id="kobo.1658.3">.
</span><span class="koboSpan" id="kobo.1658.4">. </span><span class="koboSpan" id="kobo.1658.5">. </span><span class="koboSpan" id="kobo.1658.6">.
</span><span class="koboSpan" id="kobo.1658.7">charlie:x:1009:1009::/home/charlie:/usr/bin/zsh
horatio:x:1010:1010::/home/horatio:/bin/bash
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1659.1">This particular </span><a id="_idIndexMarker1329"/><span class="koboSpan" id="kobo.1660.1">example might not seem like a big deal, because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1661.1">passwd</span></code><span class="koboSpan" id="kobo.1662.1"> file is world-readable anyway. </span><span class="koboSpan" id="kobo.1662.2">But then, it could be a big deal under certain circumstances. </span><span class="koboSpan" id="kobo.1662.3">For example, let’s say that you’re running a web server, and you have a shell script set up as a CGI script.</span></p>
    <div class="note">
      <p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1663.1">CGI</span></strong><span class="koboSpan" id="kobo.1664.1"> stands for </span><strong class="keyWord"><span class="koboSpan" id="kobo.1665.1">Common Gateway Interface</span></strong><span class="koboSpan" id="kobo.1666.1">. </span><span class="koboSpan" id="kobo.1666.2">You can create CGI scripts from various </span><a id="_idIndexMarker1330"/><span class="koboSpan" id="kobo.1667.1">programming languages, including shell scripting. </span><span class="koboSpan" id="kobo.1667.2">These CGI scripts can perform various functions on web servers, such as counting users, or even serving out content.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1668.1">A full explanation of setting up web servers and how to hack them is way beyond the scope of this book. </span><span class="koboSpan" id="kobo.1668.2">For now, let’s just say that there are some clever hackers out there who can find and exploit poorly designed CGI scripts on web servers. </span><span class="koboSpan" id="kobo.1668.3">That’s especially true if the web server security isn’t set up properly.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1669.1">A malicious hacker who hasn’t been able to log into the web server wouldn’t be able to view the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1670.1">passwd</span></code><span class="koboSpan" id="kobo.1671.1"> file. </span><span class="koboSpan" id="kobo.1671.2">But, if he or she were to find that this poorly-designed script is performing some sort of CGI function, he or she might be able to view the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1672.1">passwd</span></code><span class="koboSpan" id="kobo.1673.1"> file to enumerate the server’s users. </span><span class="koboSpan" id="kobo.1673.2">(But then, maybe not. </span><span class="koboSpan" id="kobo.1673.3">Proper web server security measures might prevent this from happening, even if the script is insecure.)</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1674.1">For another example that might be more probable, let’s say that you’ve placed the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1675.1">eval-test3.sh</span></code><span class="koboSpan" id="kobo.1676.1"> script in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1677.1">/usr/local/sbin/</span></code><span class="koboSpan" id="kobo.1678.1"> directory, and have it set up so that only the root user has executable permissions, like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1679.1">donnie@fedora-server:/usr/local/sbin$ ls -l eval-test3.sh
-rwx------. </span><span class="koboSpan" id="kobo.1679.2">1 root root 21 Aug  8 17:20 eval-test3.sh
donnie@fedora-server:/usr/local/sbin$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1680.1">You then </span><a id="_idIndexMarker1331"/><span class="koboSpan" id="kobo.1681.1">invoke the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1682.1">sudo visudo</span></code><span class="koboSpan" id="kobo.1683.1"> command to set up Charlie so that he has root privileges to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1684.1">eval-test3.sh</span></code><span class="koboSpan" id="kobo.1685.1"> script, but nothing else. </span><span class="koboSpan" id="kobo.1685.2">Here’s the line that does that:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1686.1">charlie ALL=(ALL)       /usr/local/sbin/eval-test3.sh
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1687.1">Let’s see how that works.</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1688.1">charlie@fedora-server:~$ eval-test3.sh 'cat /etc/passwd'
bash: /usr/local/sbin/eval-test3.sh: Permission denied
charlie@fedora-server:~$ sudo eval-test3.sh 'cat /etc/passwd'
[sudo] password for charlie:
root:x:0:0:root:/root:/bin/bash
. </span><span class="koboSpan" id="kobo.1688.2">. </span><span class="koboSpan" id="kobo.1688.3">.
</span><span class="koboSpan" id="kobo.1688.4">. </span><span class="koboSpan" id="kobo.1688.5">. </span><span class="koboSpan" id="kobo.1688.6">.
</span><span class="koboSpan" id="kobo.1688.7">charlie:x:1009:1009::/home/charlie:/usr/bin/zsh
horatio:x:1010:1010::/home/horatio:/bin/bash
charlie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1689.1">Charlie didn’t do any harm this time, but what about next time? </span><span class="koboSpan" id="kobo.1689.2">Let’s see:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1690.1">charlie@fedora-server:~$ sudo eval-test3.sh 'systemctl stop httpd'
charlie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1691.1">This time, Charlie did some real damage. </span><span class="koboSpan" id="kobo.1691.2">He shut down the web server, causing a Denial-of-Service attack. </span><span class="koboSpan" id="kobo.1691.3">Ordinarily, Charlie wouldn’t have the power to do this. </span><span class="koboSpan" id="kobo.1691.4">But, because he has </span><code class="inlineCode"><span class="koboSpan" id="kobo.1692.1">sudo</span></code><span class="koboSpan" id="kobo.1693.1"> privileges to run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1694.1">eval-test3.sh</span></code><span class="koboSpan" id="kobo.1695.1"> script, and that script contains the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1696.1">eval $1</span></code><span class="koboSpan" id="kobo.1697.1"> line, Charlie can now run any command he wants to run, including system administrative commands.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1698.1">As I said at the beginning of this section, I’ve tried to keep the explanation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1699.1">eval</span></code><span class="koboSpan" id="kobo.1700.1"> simple. </span><span class="koboSpan" id="kobo.1700.2">To see more complex and somewhat more realistic </span><code class="inlineCode"><span class="koboSpan" id="kobo.1701.1">eval</span></code><span class="koboSpan" id="kobo.1702.1"> scenarios, I would like to draw your attention to two really good articles that I’ve found. </span><span class="koboSpan" id="kobo.1702.2">The first one is on Medium.com, and is the absolute best write-up I’ve found that covers a real-world way to exploit poorly-written scripts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1703.1">eval</span></code><span class="koboSpan" id="kobo.1704.1">:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1705.1">The perils of Bash eval:</span></p>
      <p class="normal"><a href="https://medium.com/dot-debug/the-perils-of-bash-eval-cc5f9e309cae"><span class="url"><span class="koboSpan" id="kobo.1706.1">https://medium.com/dot-debug/the-perils-of-bash-eval-cc5f9e309cae</span></span></a></p>
      <p class="normal"><span class="koboSpan" id="kobo.1707.1">The second </span><a id="_idIndexMarker1332"/><span class="koboSpan" id="kobo.1708.1">one, at the Earthly.dev site, shows how to perform a </span><strong class="keyWord"><span class="koboSpan" id="kobo.1709.1">reverse shell attack</span></strong><span class="koboSpan" id="kobo.1710.1"> with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1711.1">eval</span></code><span class="koboSpan" id="kobo.1712.1"> script. </span><span class="koboSpan" id="kobo.1712.2">(If you don’t know what a reverse shell attack is, you’ll find the explanation in the article.) Anyway, you can find it here:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1713.1">Bash eval: Understanding and (Safely) Using the Power of Dynamic Code Evaluation: </span><a href="https://earthly.dev/blog/safely-using-bash-eval/"><span class="url"><span class="koboSpan" id="kobo.1714.1">https://earthly.dev/blog/safely-using-bash-eval/</span></span></a></p>
      <p class="normal"><span class="koboSpan" id="kobo.1715.1">Also, there has been at least one instance of a real-life shell script vulnerability that involved an incorrect usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1716.1">eval</span></code><span class="koboSpan" id="kobo.1717.1">. </span><span class="koboSpan" id="kobo.1717.2">This involved the installation script for Gradle, which is an automated build tool for software development. </span><span class="koboSpan" id="kobo.1717.3">You can read about it here:</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1718.1">CVE-2021-32751:</span></p>
      <p class="normal"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-32751"><span class="url"><span class="koboSpan" id="kobo.1719.1">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-32751</span></span></a></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1720.1">Now that you understand the dangers of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1721.1">eval</span></code><span class="koboSpan" id="kobo.1722.1">, let’s consider whether or not we even have to use it.</span></p>
    <h2 id="_idParaDest-435" class="heading 2"><span class="koboSpan" id="kobo.1723.1">Using Alternatives to eval</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1724.1">Many times, you’ll be able to use a safe alternative to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1725.1">eval</span></code><span class="koboSpan" id="kobo.1726.1">. </span><span class="koboSpan" id="kobo.1726.2">Let’s look at a few examples.</span></p>
    <h3 id="_idParaDest-436" class="heading 3"><span class="koboSpan" id="kobo.1727.1">Using Command Substitution</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1728.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1729.1">eval-test1.sh</span></code><span class="koboSpan" id="kobo.1730.1"> script that I showed you at the beginning of this section, you could have </span><a id="_idIndexMarker1333"/><span class="koboSpan" id="kobo.1731.1">replaced </span><code class="inlineCode"><span class="koboSpan" id="kobo.1732.1">eval</span></code><span class="koboSpan" id="kobo.1733.1"> with a command substitution construct. </span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1734.1">Here’s how it looks in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1735.1">eval-test1-alternative.sh</span></code><span class="koboSpan" id="kobo.1736.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1737.1">#!/bin/bash
threeweeksago=$(date --date="3 weeks ago")
echo $threeweeksago
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1738.1">Run the script, and you’ll see that it behaves exactly the same as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1739.1">eval</span></code><span class="koboSpan" id="kobo.1740.1"> version:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1741.1">donnie@fedora-server:~$ ./eval-test1-alternative.sh
Mon Jul 22 04:36:14 PM EDT 2024
donnie@fedora-server:~$ ./eval-test1-alternative.sh
Mon Jul 22 04:37:23 PM EDT 2024
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1742.1">Granted, it doesn’t really matter in this case, because the script doesn’t accept external input. </span><span class="koboSpan" id="kobo.1742.2">So, it’s perfectly safe to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1743.1">eval</span></code><span class="koboSpan" id="kobo.1744.1"> with it. </span><span class="koboSpan" id="kobo.1744.2">But, if you create a script that does accept external input and you have the choice between using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1745.1">eval</span></code><span class="koboSpan" id="kobo.1746.1"> and using command substitution, your best bet is to go with command substitution.</span></p>
    <div class="note">
      <p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1747.1">Remember</span></strong><span class="koboSpan" id="kobo.1748.1">: Always go with the safest option for your scripts.</span></p>
    </div>
    <h3 id="_idParaDest-437" class="heading 3"><span class="koboSpan" id="kobo.1749.1">Evaluating if eval is Necessary</span></h3>
    <p class="normal"><span class="koboSpan" id="kobo.1750.1">In some </span><a id="_idIndexMarker1334"/><span class="koboSpan" id="kobo.1751.1">cases, using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1752.1">eval</span></code><span class="koboSpan" id="kobo.1753.1"> doesn’t even do anything that we can’t do without it. </span><span class="koboSpan" id="kobo.1753.2">For example, look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1754.1">eval-test4.sh</span></code><span class="koboSpan" id="kobo.1755.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1756.1">#!/bin/bash
a=$1
eval echo $(( a + 1 ))
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1757.1">When you run this script, you’ll pass in a number as positional parameter </span><code class="inlineCode"><span class="koboSpan" id="kobo.1758.1">$1</span></code><span class="koboSpan" id="kobo.1759.1">. </span><span class="koboSpan" id="kobo.1759.2">The arithmetic operator in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1760.1">eval</span></code><span class="koboSpan" id="kobo.1761.1"> line will increment the number by 1, and display the result. </span><span class="koboSpan" id="kobo.1761.2">Here’s how that looks:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1762.1">donnie@fedora-server:~$ ./eval-test4.sh 36
37
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1763.1">Now, let’s remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1764.1">eval</span></code><span class="koboSpan" id="kobo.1765.1"> command, so that the script looks like this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1766.1">#!/bin/bash
a=$1
echo $(( a + 1 ))
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1767.1">Running </span><a id="_idIndexMarker1335"/><span class="koboSpan" id="kobo.1768.1">the script without </span><code class="inlineCode"><span class="koboSpan" id="kobo.1769.1">eval</span></code><span class="koboSpan" id="kobo.1770.1"> gives us this:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1771.1">donnie@fedora-server:~$ ./eval-test4.sh 36
37
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1772.1">The output is identical to what it was when we used </span><code class="inlineCode"><span class="koboSpan" id="kobo.1773.1">eval</span></code><span class="koboSpan" id="kobo.1774.1">, which tells me that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1775.1">eval</span></code><span class="koboSpan" id="kobo.1776.1"> isn’t even needed here. </span><span class="koboSpan" id="kobo.1776.2">So, the only thing that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1777.1">eval</span></code><span class="koboSpan" id="kobo.1778.1"> does here is to add an attack vector that we definitely don’t need.</span></p>
    <div class="note">
      <p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1779.1">Remember</span></strong><span class="koboSpan" id="kobo.1780.1">: Don’t use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1781.1">eval</span></code><span class="koboSpan" id="kobo.1782.1"> when it isn’t necessary.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1783.1">A similar scenario involves assigning a command to a variable, as we see here in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1784.1">eval-test5.sh</span></code><span class="koboSpan" id="kobo.1785.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1786.1">#!/bin/bash
checkWebserver="systemctl status httpd"
eval $checkWebserver
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1787.1">Running this script will indeed show us the status of the web server service:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1788.1">donnie@fedora-server:~$ ./eval-test5.sh
● httpd.service - The Apache HTTP Server
. </span><span class="koboSpan" id="kobo.1788.2">. </span><span class="koboSpan" id="kobo.1788.3">.
</span><span class="koboSpan" id="kobo.1788.4">. </span><span class="koboSpan" id="kobo.1788.5">. </span><span class="koboSpan" id="kobo.1788.6">.
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1789.1">As before, we can accomplish the same thing without using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1790.1">eval</span></code><span class="koboSpan" id="kobo.1791.1"> at all, as you see here in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1792.1">eval-test6.sh</span></code><span class="koboSpan" id="kobo.1793.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1794.1">#!/bin/bash
checkWebserver="systemctl status httpd"
$checkWebserver
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1795.1">Run this script, and </span><a id="_idIndexMarker1336"/><span class="koboSpan" id="kobo.1796.1">the results will be identical to what they were when you used </span><code class="inlineCode"><span class="koboSpan" id="kobo.1797.1">eval</span></code><span class="koboSpan" id="kobo.1798.1">. </span><span class="koboSpan" id="kobo.1798.2">So again, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1799.1">eval</span></code><span class="koboSpan" id="kobo.1800.1"> isn’t needed.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1801.1">Another example of this is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1802.1">value5.sh</span></code><span class="koboSpan" id="kobo.1803.1"> script that I showed you in </span><em class="italic"><span class="koboSpan" id="kobo.1804.1">Chapter 10—Understanding Functions</span></em><span class="koboSpan" id="kobo.1805.1">. </span><span class="koboSpan" id="kobo.1805.2">To refresh your memory, here’s what it looks like:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1806.1">#!/bin/bash
valuepass() {
        local __internalvar=$1
        local myresult='Shell scripting is cool!'
        </span><span class="koboSpan" id="kobo.1806.2">eval $__internalvar="'$myresult'"
}
valuepass result
echo $result
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1807.1">I’ve already explained this in </span><em class="italic"><span class="koboSpan" id="kobo.1808.1">Chapter 10</span></em><span class="koboSpan" id="kobo.1809.1">, so for now I’ll just say that I’m using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1810.1">eval</span></code><span class="koboSpan" id="kobo.1811.1"> here as a mechanism to help pass values in and out of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1812.1">valuepass</span></code><span class="koboSpan" id="kobo.1813.1"> function. </span><span class="koboSpan" id="kobo.1813.2">But, if you refer back to </span><em class="italic"><span class="koboSpan" id="kobo.1814.1">Chapter 10</span></em><span class="koboSpan" id="kobo.1815.1">, you’ll see that this is only one of several methods that I showed you for passing values in and out of a function. </span><span class="koboSpan" id="kobo.1815.2">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1816.1">eval</span></code><span class="koboSpan" id="kobo.1817.1"> here is perfectly safe, since this script is only passing values internally. </span><span class="koboSpan" id="kobo.1817.2">But, if you ever need to create a function that accepts external values from either the script’s user or an </span><a id="_idIndexMarker1337"/><span class="koboSpan" id="kobo.1818.1">external text file, you’ll want to use one of the alternative methods.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1819.1">I think that covers it for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1820.1">eval</span></code><span class="koboSpan" id="kobo.1821.1">. </span><span class="koboSpan" id="kobo.1821.2">Let’s look at one last possible coding problem, and then move on to the next chapter.</span></p>
    <h1 id="_idParaDest-438" class="heading 1"><span class="koboSpan" id="kobo.1822.1">Understanding Path Security</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.1823.1">The possibility—however </span><a id="_idIndexMarker1338"/><span class="koboSpan" id="kobo.1824.1">remote it may be—exists that someone could plant a trojaned version of some system utility on your system, and then manipulate a user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1825.1">PATH</span></code><span class="koboSpan" id="kobo.1826.1"> setting so that the trojaned utility would be invoked, instead of the real one. </span><span class="koboSpan" id="kobo.1826.2">The trojaned utility could do a variety of nasty things, such as exfiltrating sensitive data or performing a ransomware attack by encrypting important files. </span><span class="koboSpan" id="kobo.1826.3">Before I show you a script, let’s see how this looks on the command-line. </span><span class="koboSpan" id="kobo.1826.4">Let’s begin by showing you where the executable file for the normal </span><code class="inlineCode"><span class="koboSpan" id="kobo.1827.1">ls</span></code><span class="koboSpan" id="kobo.1828.1"> command is located:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1829.1">donnie@fedora-server:~$ which ls
alias ls='ls --color=auto'
    /usr/bin/ls
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1830.1">We see that it’s located in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1831.1">/usr/bin/</span></code><span class="koboSpan" id="kobo.1832.1"> directory, as it should be. </span><span class="koboSpan" id="kobo.1832.2">Now, let’s create a bogus </span><code class="inlineCode"><span class="koboSpan" id="kobo.1833.1">ls</span></code><span class="koboSpan" id="kobo.1834.1">, in the </span><a id="_idIndexMarker1339"/><span class="koboSpan" id="kobo.1835.1">form of a script, and place it into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1836.1">/tmp/</span></code><span class="koboSpan" id="kobo.1837.1"> directory. </span><span class="koboSpan" id="kobo.1837.2">Here’s the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1838.1">ls</span></code><span class="koboSpan" id="kobo.1839.1"> script:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1840.1">#!/bin/bash
echo "This is a trojaned ls file. </span><span class="koboSpan" id="kobo.1840.2">This command does something nasty."
</span><span class="koboSpan" id="kobo.1840.3">/usr/bin/ls
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1841.1">Of course, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1842.1">echo</span></code><span class="koboSpan" id="kobo.1843.1"> command is harmless, but a real malicious hacker would replace that with something that isn’t harmless. </span><span class="koboSpan" id="kobo.1843.2">After running the malicious command, the script will then invoke the normal </span><code class="inlineCode"><span class="koboSpan" id="kobo.1844.1">ls</span></code><span class="koboSpan" id="kobo.1845.1"> command.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1846.1">Next, let’s manipulate the user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1847.1">PATH</span></code><span class="koboSpan" id="kobo.1848.1"> setting so that this script will get invoked instead of the real </span><code class="inlineCode"><span class="koboSpan" id="kobo.1849.1">ls</span></code><span class="koboSpan" id="kobo.1850.1">.</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1851.1">donnie@fedora-server:~$ PATH=/tmp:$PATH
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1852.1">Finally, we’ll invoke </span><code class="inlineCode"><span class="koboSpan" id="kobo.1853.1">ls</span></code><span class="koboSpan" id="kobo.1854.1">:</span></p>
    <pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1855.1">donnie@fedora-server:~$ ls
This is a trojaned ls file. </span><span class="koboSpan" id="kobo.1855.2">This command does something nasty.
 </span><span class="koboSpan" id="kobo.1855.3">04:26:53             Jul
 18                 link.txt
. </span><span class="koboSpan" id="kobo.1855.4">. </span><span class="koboSpan" id="kobo.1855.5">.
</span><span class="koboSpan" id="kobo.1855.6">. </span><span class="koboSpan" id="kobo.1855.7">. </span><span class="koboSpan" id="kobo.1855.8">.
 </span><span class="koboSpan" id="kobo.1855.9">ip_addresses.csv         variables.txt
 ipaddress_list_2024-06-03.txt
donnie@fedora-server:~$
</span></code></pre>
    <p class="normal"><span class="koboSpan" id="kobo.1856.1">This time, the bogus </span><code class="inlineCode"><span class="koboSpan" id="kobo.1857.1">ls</span></code><span class="koboSpan" id="kobo.1858.1"> was invoked, because the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1859.1">/tmp/</span></code><span class="koboSpan" id="kobo.1860.1"> directory is the first directory in the user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1861.1">PATH</span></code><span class="koboSpan" id="kobo.1862.1"> setting.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1863.1">By default, the shell scripts that you create will use your normal </span><code class="inlineCode"><span class="koboSpan" id="kobo.1864.1">PATH</span></code><span class="koboSpan" id="kobo.1865.1"> settings to find the utilities and programs that the script invokes. </span><span class="koboSpan" id="kobo.1865.2">For example, when you want to invoke the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1866.1">ls</span></code><span class="koboSpan" id="kobo.1867.1"> command in </span><a id="_idIndexMarker1340"/><span class="koboSpan" id="kobo.1868.1">a script, just add a line that says </span><code class="inlineCode"><span class="koboSpan" id="kobo.1869.1">ls</span></code><span class="koboSpan" id="kobo.1870.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1871.1">/usr/bin/ls</span></code><span class="koboSpan" id="kobo.1872.1">. </span><span class="koboSpan" id="kobo.1872.2">By doing that though, any attacker who can manipulate a user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1873.1">PATH</span></code><span class="koboSpan" id="kobo.1874.1"> setting could cause the script to run a bogus, trojaned program. </span><span class="koboSpan" id="kobo.1874.2">There are three things you can do to prevent that.</span></p>
    <ul>
      <li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1875.1">Method 1</span></strong><span class="koboSpan" id="kobo.1876.1">: Make the script unreadable and untraceable, as I showed you in the first portion of this chapter. </span><span class="koboSpan" id="kobo.1876.2">That way, attackers won’t be able to see which utilities that the script is invoking, which means that they won’t know which utilities to replace with a trojaned version.</span></li>
      <li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1877.1">Method 2</span></strong><span class="koboSpan" id="kobo.1878.1">: Explicitly set a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1879.1">PATH</span></code><span class="koboSpan" id="kobo.1880.1"> at the top of the script. </span><span class="koboSpan" id="kobo.1880.2">Here’s how that would look, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1881.1">path-test1.sh</span></code><span class="koboSpan" id="kobo.1882.1"> script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1883.1">#!/bin/bash
PATH=/bin:/sbin:/usr/local/bin:/usr/local/sbin
ls -l
</span></code></pre>
      </li>
      <li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1884.1">Method 3</span></strong><span class="koboSpan" id="kobo.1885.1">: Use the entire path to every command that you place in the script. </span><span class="koboSpan" id="kobo.1885.2">So, for example, when you want to invoke </span><code class="inlineCode"><span class="koboSpan" id="kobo.1886.1">awk</span></code><span class="koboSpan" id="kobo.1887.1">, have the line say </span><code class="inlineCode"><span class="koboSpan" id="kobo.1888.1">/bin/awk</span></code><span class="koboSpan" id="kobo.1889.1"> instead of just </span><code class="inlineCode"><span class="koboSpan" id="kobo.1890.1">awk</span></code><span class="koboSpan" id="kobo.1891.1">.</span></li>
    </ul>
    <p class="normal"><span class="koboSpan" id="kobo.1892.1">One problem with the third method is that it could make your scripts less portable. </span><span class="koboSpan" id="kobo.1892.2">That’s because some operating systems, such as FreeBSD, might have the executable files for certain utilities stored in directories that are different from what you’re used to. </span><span class="koboSpan" id="kobo.1892.3">For example, FreeBSD has the executable files for many of its utilities in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1893.1">/usr/local/bin/</span></code><span class="koboSpan" id="kobo.1894.1"> directory, instead of in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1895.1">/usr/bin/</span></code><span class="koboSpan" id="kobo.1896.1"> as we’re used to seeing on Linux operating systems. </span><span class="koboSpan" id="kobo.1896.2">So, if you want to ensure that your scripts will run on as many operating systems as possible, your best bet is to forget about Method 3. </span><span class="koboSpan" id="kobo.1896.3">Using Method 2 will be much easier and just as effective.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1897.1">And now, you’re</span><a id="_idIndexMarker1341"/><span class="koboSpan" id="kobo.1898.1"> wondering how an attacker could possibly manipulate someone’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">PATH</span></code><span class="koboSpan" id="kobo.1900.1"> setting like this. </span><span class="koboSpan" id="kobo.1900.2">Well, I can think of two possible scenarios.</span></p>
    <h2 id="_idParaDest-439" class="heading 2"><span class="koboSpan" id="kobo.1901.1">Attack Scenario 1: Compromising the User’s Account</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1902.1">One way that an attacker can manipulate a user’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1903.1">PATH</span></code><span class="koboSpan" id="kobo.1904.1"> setting is to first gain access to the user’s </span><a id="_idIndexMarker1342"/><span class="koboSpan" id="kobo.1905.1">account. </span><span class="koboSpan" id="kobo.1905.2">If the attacker has already accomplished that, then it’s game over anyway and path security would be the least of the user’s problems. </span><span class="koboSpan" id="kobo.1905.3">So, your best bet would be to ensure that users’ accounts are </span><a id="_idIndexMarker1343"/><span class="koboSpan" id="kobo.1906.1">configured securely, to prevent anyone from breaking in.</span></p>
    <h2 id="_idParaDest-440" class="heading 2"><span class="koboSpan" id="kobo.1907.1">Attack Scenario 2: Social Engineering</span></h2>
    <p class="normal"><span class="koboSpan" id="kobo.1908.1">An attacker </span><a id="_idIndexMarker1344"/><span class="koboSpan" id="kobo.1909.1">could also possibly use social engineering to trick a user into running a program that would alter the user’s shell configuration files.</span></p>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1910.1">In the world of cybersecurity, </span><strong class="keyWord"><span class="koboSpan" id="kobo.1911.1">social engineering</span></strong><span class="koboSpan" id="kobo.1912.1"> can take many forms. </span><span class="koboSpan" id="kobo.1912.2">For example, it can come by </span><a id="_idIndexMarker1345"/><span class="koboSpan" id="kobo.1913.1">way of a scam email with a link to a malicious file, or it could come by way of a face-to-face encounter. </span><span class="koboSpan" id="kobo.1913.2">In any case, the goal is to convince the victim to perform some sort of action that could cause a breach of security.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1914.1">For this scenario, I’m using the Fedora Server virtual machine.</span></p>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.1915.1">First, let’s look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1916.1">harmless-program.sh</span></code><span class="koboSpan" id="kobo.1917.1"> script:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1918.1">#!/bin/bash
echo "This program is harmless."
</span><span class="koboSpan" id="kobo.1918.2">echo "Trust me!"
</span><span class="koboSpan" id="kobo.1918.3">echo "PATH=/tmp:$PATH" &gt;&gt; /home/"$USER"/.bashrc
echo "export PATH" &gt;&gt; /home/"$USER"/.bashrc
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1919.1">Run the script, and note that it places an extra </span><code class="inlineCode"><span class="koboSpan" id="kobo.1920.1">PATH</span></code><span class="koboSpan" id="kobo.1921.1"> directive at the end of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1922.1">.bashrc</span></code><span class="koboSpan" id="kobo.1923.1"> file. </span><span class="koboSpan" id="kobo.1923.2">This extra directive overrides the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1924.1">PATH</span></code><span class="koboSpan" id="kobo.1925.1"> directive that’s at the top of the file. </span><span class="koboSpan" id="kobo.1925.2">This new setting won’t take effect right away, but it will the next time that the user either logs into the system or opens another terminal window.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1926.1">Log out and then log back in again. </span><span class="koboSpan" id="kobo.1926.2">Prepare to be amazed at what happens when you try to do a directory listing:
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1927.1">donnie@fedora-server:~$ ls
You've just been pwned!
</span><span class="koboSpan" id="kobo.1927.2">You really should learn to protect yourself
against social engineering attacks.
 </span><span class="koboSpan" id="kobo.1927.3">acl_demo.sh             link.txt
. </span><span class="koboSpan" id="kobo.1927.4">. </span><span class="koboSpan" id="kobo.1927.5">.
</span><span class="koboSpan" id="kobo.1927.6">. </span><span class="koboSpan" id="kobo.1927.7">. </span><span class="koboSpan" id="kobo.1927.8">.
</span><span class="koboSpan" id="kobo.1927.9">ipaddress_count.sh         user_activity_original.sh
 ip_addresses.csv         user_agent.tsv
 ipaddress_list_2024-06-03.txt     variables.txt
donnie@fedora-server:~$
</span></code></pre>
      </li>
    </ol>
    <p class="normal one"><span class="koboSpan" id="kobo.1928.1">Of course, in real life the script would have done something a bit more nasty. </span><span class="koboSpan" id="kobo.1928.2">Also, distributing this sort of malicious program as a script would be a bit obvious.</span></p>
    <ol>
      <li class="numberedList" value="4"><span class="koboSpan" id="kobo.1929.1">So, let’s </span><a id="_idIndexMarker1346"/><span class="koboSpan" id="kobo.1930.1">use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1931.1">shc</span></code><span class="koboSpan" id="kobo.1932.1"> to convert this to an untraceable executable binary. </span><span class="koboSpan" id="kobo.1932.2">Also, use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1933.1">-r</span></code><span class="koboSpan" id="kobo.1934.1"> option so that the binary will execute on other Linux machines.
        </span><pre class="programlisting gen"><code class="hljs-con"><span class="koboSpan" id="kobo.1935.1">donnie@fedora-server:~$ shc -rUf harmless-program.sh -o harmless-program
donnie@fedora-server:~$
</span></code></pre>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1936.1">Before you try to execute the binary, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1937.1">.bashrc</span></code><span class="koboSpan" id="kobo.1938.1"> file in your text editor, and delete the two lines that were added by the script.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1939.1">Log out and then log back in.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1940.1">Execute the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1941.1">harmless-program</span></code><span class="koboSpan" id="kobo.1942.1"> binary.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1943.1">Log out and then log back in. </span><span class="koboSpan" id="kobo.1943.2">Then, execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1944.1">ls</span></code><span class="koboSpan" id="kobo.1945.1"> command. </span><span class="koboSpan" id="kobo.1945.2">You should see the same results that you saw in Step 3.</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1946.1">Finally, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1947.1">.bashrc</span></code><span class="koboSpan" id="kobo.1948.1"> file in your text editor and delete the two lines that were added by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1949.1">harmless-program</span></code><span class="koboSpan" id="kobo.1950.1"> program.</span></li>
    </ol>
    <div class="note">
      <p class="normal"><span class="koboSpan" id="kobo.1951.1">If you do a web search for articles related to shell scripting security, you’ll find several that talk about path security attacks. </span><span class="koboSpan" id="kobo.1951.2">Curiously though, I’ve never seen a single one that explains how someone might execute such an attack.</span></p>
      <p class="normal"><span class="koboSpan" id="kobo.1952.1">Also, this scenario provides a prime example of why all personnel who use a computer should learn to recognize and avoid social engineering attacks.</span></p>
    </div>
    <p class="normal"><span class="koboSpan" id="kobo.1953.1">Okay, I think </span><a id="_idIndexMarker1347"/><span class="koboSpan" id="kobo.1954.1">that this about covers things for this topic. </span><span class="koboSpan" id="kobo.1954.2">So, let’s wrap up and move on.</span></p>
    <h1 id="_idParaDest-441" class="heading 1"><span class="koboSpan" id="kobo.1955.1">Summary</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.1956.1">In this chapter, we covered topics that are important to a security-conscious Linux or Unix administrator. </span><span class="koboSpan" id="kobo.1956.2">We began with a discussion of how to control access to your important scripts, and showed various methods of doing so. </span><span class="koboSpan" id="kobo.1956.3">Next, we looked at considerations about the SUID and SGID permissions settings, and then we looked at a few different ways to prevent your scripts from leaking sensitive data. </span><span class="koboSpan" id="kobo.1956.4">We then looked at how using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1957.1">eval</span></code><span class="koboSpan" id="kobo.1958.1"> command in scripts can be quite dangerous, and wrapped up with a discussion of path security.</span></p>
    <p class="normal"><span class="koboSpan" id="kobo.1959.1">In the next chapter, we’ll talk about debugging buggy scripts. </span><span class="koboSpan" id="kobo.1959.2">I’ll see you there.</span></p>
    <h1 id="_idParaDest-442" class="heading 1"><span class="koboSpan" id="kobo.1960.1">Questions</span></h1>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.1961.1">Which of the following is true about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1962.1">eval</span></code><span class="koboSpan" id="kobo.1963.1"> command?</span><ol>
          <li class="alphabeticList level 2" value="1"><span class="koboSpan" id="kobo.1964.1">It’s always safe to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1965.1">eval</span></code><span class="koboSpan" id="kobo.1966.1"> in your scripts.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1967.1">It’s always dangerous to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1968.1">eval</span></code><span class="koboSpan" id="kobo.1969.1"> in your scripts.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1970.1">It’s only safe to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1971.1">eval</span></code><span class="koboSpan" id="kobo.1972.1"> in your scripts if it only takes input from and external source.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1973.1">It’s only safe to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1974.1">eval</span></code><span class="koboSpan" id="kobo.1975.1"> in your scripts if it only takes input from within your script.</span></li>
        </ol>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1976.1">Which two of the following statements are true about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1977.1">/tmp/</span></code><span class="koboSpan" id="kobo.1978.1"> directory? </span><span class="koboSpan" id="kobo.1978.2">(Choose two.)</span><ol>
          <li class="alphabeticList level 2" value="1"><span class="koboSpan" id="kobo.1979.1">It’s completely secure, because only administrative users can enter it.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1980.1">Anybody can create files in it.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1981.1">Anybody can read files that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1982.1">mktemp</span></code><span class="koboSpan" id="kobo.1983.1"> creates in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1984.1">/tmp/</span></code><span class="koboSpan" id="kobo.1985.1"> directory.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1986.1">Any files that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1987.1">mktemp</span></code><span class="koboSpan" id="kobo.1988.1"> creates in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1989.1">/tmp/</span></code><span class="koboSpan" id="kobo.1990.1"> directory can only be read by the user who created them.</span></li>
        </ol>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.1991.1">How would you prevent an attacker from obtaining information from a binary that you’ve created with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1992.1">shc</span></code><span class="koboSpan" id="kobo.1993.1">?</span><ol>
          <li class="alphabeticList level 2" value="1"><span class="koboSpan" id="kobo.1994.1">It’s never possible to obtain information from an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1995.1">shc</span></code><span class="koboSpan" id="kobo.1996.1"> binary.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.1997.1">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">shc</span></code><span class="koboSpan" id="kobo.1999.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2000.1">-U</span></code><span class="koboSpan" id="kobo.2001.1"> option.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2002.1">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2003.1">shc</span></code><span class="koboSpan" id="kobo.2004.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2005.1">-u</span></code><span class="koboSpan" id="kobo.2006.1"> option.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2007.1">There’s nothing you can do to prevent this.</span></li>
        </ol>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2008.1">Before you set an Access Control List on a file, what must you do to that file?</span><ol>
          <li class="alphabeticList level 2" value="1"><span class="koboSpan" id="kobo.2009.1">Remove all permissions from </span><em class="italic"><span class="koboSpan" id="kobo.2010.1">group</span></em><span class="koboSpan" id="kobo.2011.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.2012.1">others</span></em><span class="koboSpan" id="kobo.2013.1">.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2014.1">There’s nothing that you need to do.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2015.1">Ensure that </span><em class="italic"><span class="koboSpan" id="kobo.2016.1">user</span></em><span class="koboSpan" id="kobo.2017.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2018.1">group</span></em><span class="koboSpan" id="kobo.2019.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.2020.1">others</span></em><span class="koboSpan" id="kobo.2021.1"> all have read, write, and execute permissions.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2022.1">Change ownership of the file to the root user.</span></li>
        </ol>
      </li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2023.1">What’s the best way to ensure that any temporary files that your script creates in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2024.1">/tmp/</span></code><span class="koboSpan" id="kobo.2025.1"> directory always get deleted?</span><ol>
          <li class="alphabeticList level 2" value="1"><span class="koboSpan" id="kobo.2026.1">After you run the script, go into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2027.1">/tmp/</span></code><span class="koboSpan" id="kobo.2028.1"> directory and delete the temporary files yourself.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2029.1">Automatically delete the files with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2030.1">rm</span></code><span class="koboSpan" id="kobo.2031.1"> command at the end of the script.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2032.1">Automatically delete the files with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2033.1">trap</span></code><span class="koboSpan" id="kobo.2034.1"> command at the beginning of the script.</span></li>
          <li class="alphabeticList level 2"><span class="koboSpan" id="kobo.2035.1">No action is needed, because your script will always automatically delete its temporary files.</span></li>
        </ol>
      </li>
    </ol>
    <h1 id="_idParaDest-443" class="heading 1"><span class="koboSpan" id="kobo.2036.1">Further Reading</span></h1>
    <ul>
      <li class="bulletList"><span class="koboSpan" id="kobo.2037.1">Setting and Displaying ACLs on ZFS File in Compact Format—Oracle Solaris ZFS Administration Guide: </span><a href="https://docs.oracle.com/cd/E23823_01/html/819-5461/gbchf.html#scrolltoc"><span class="url"><span class="koboSpan" id="kobo.2038.1">https://docs.oracle.com/cd/E23823_01/html/819-5461/gbchf.html#scrolltoc</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2039.1">Shell Scripts and Security: </span><a href="https://stackoverflow.com/questions/8935162/shell-scripts-and-security"><span class="url"><span class="koboSpan" id="kobo.2040.1">https://stackoverflow.com/questions/8935162/shell-scripts-and-security</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2041.1">Shell Script Security: </span><a href="https://developer.apple.com/library/archive/documentation/OpenSource/Conceptual/ShellScripting/ShellScriptSecurity/ShellScriptSecurity.html"><span class="url"><span class="koboSpan" id="kobo.2042.1">https://developer.apple.com/library/archive/documentation/OpenSource/Conceptual/ShellScripting/ShellScriptSecurity/ShellScriptSecurity.html</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2043.1">How to Securely Work with Temporary Files in Linux Shell Scripting: </span><a href="https://youtu.be/zxswimoojh4?si=ERfbJ04U2LJzQE60"><span class="url"><span class="koboSpan" id="kobo.2044.1">https://youtu.be/zxswimoojh4?si=ERfbJ04U2LJzQE60</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2045.1">Why is SUID disabled for shell scripts but not for binaries?: </span><a href="https://security.stackexchange.com/questions/194166/why-is-suid-disabled-for-shell-scripts-but-not-for-binaries "><span class="url"><span class="koboSpan" id="kobo.2046.1">https://security.stackexchange.com/questions/194166/why-is-suid-disabled-for-shell-scripts-but-not-for-binaries</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2047.1">Dangers of SUID shell scripts: </span><a href="https://www.drdobbs.com/dangers-of-suid-shell-scripts/199101190"><span class="url"><span class="koboSpan" id="kobo.2048.1">https://www.drdobbs.com/dangers-of-suid-shell-scripts/199101190</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2049.1">Using the trap builtin to catch interrupts for graceful event handling in the shell: </span><a href="https://www.shellscript.sh/trap.html"><span class="url"><span class="koboSpan" id="kobo.2050.1">https://www.shellscript.sh/trap.html</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2051.1">Reverse Engineering Tools in Linux—strings, nm, ltrace, strace, LD_PRELOAD: </span><a href="https://www.thegeekstuff.com/2012/03/reverse-engineering-tools/"><span class="url"><span class="koboSpan" id="kobo.2052.1">https://www.thegeekstuff.com/2012/03/reverse-engineering-tools/</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2053.1">Reverse Engineering with strace: </span><a href="https://function61.com/blog/2017/reverse-engineering-with-strace/"><span class="url"><span class="koboSpan" id="kobo.2054.1">https://function61.com/blog/2017/reverse-engineering-with-strace/</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2055.1">How to Use Encrypted Passwords in Bash Scripts: </span><a href="https://www.howtogeek.com/734838/how-to-use-encrypted-passwords-in-bash-scripts/"><span class="url"><span class="koboSpan" id="kobo.2056.1">https://www.howtogeek.com/734838/how-to-use-encrypted-passwords-in-bash-scripts/</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2057.1">Beginners Guide for eval Command on Linux: </span><a href="https://linuxtldr.com/eval-command/"><span class="url"><span class="koboSpan" id="kobo.2058.1">https://linuxtldr.com/eval-command/</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2059.1">How to Use eval in Linux Bash Scripts: </span><a href="https://www.howtogeek.com/818088/bash-eval/"><span class="url"><span class="koboSpan" id="kobo.2060.1">https://www.howtogeek.com/818088/bash-eval/</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2061.1">Eval Command and Security Issues: </span><a href="http://mywiki.wooledge.org/BashFAQ/048"><span class="url"><span class="koboSpan" id="kobo.2062.1">http://mywiki.wooledge.org/BashFAQ/048</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2063.1">Code Injection: </span><a href="https://owasp.org/www-community/attacks/Code_Injection"><span class="url"><span class="koboSpan" id="kobo.2064.1">https://owasp.org/www-community/attacks/Code_Injection</span></span></a></li>
      <li class="bulletList"><span class="koboSpan" id="kobo.2065.1">Securing Shell Scripts: </span><a href="https://www.admin-magazine.com/Archive/2021/64/Best-practices-for-secure-script-programming"><span class="url"><span class="koboSpan" id="kobo.2066.1">https://www.admin-magazine.com/Archive/2021/64/Best-practices-for-secure-script-programming</span></span></a></li>
    </ul>
    <h1 id="_idParaDest-444" class="heading 1"><span class="koboSpan" id="kobo.2067.1">Answers</span></h1>
    <ol>
      <li class="numberedList" value="1"><span class="koboSpan" id="kobo.2068.1">d</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2069.1">b and d</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2070.1">b</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2071.1">a</span></li>
      <li class="numberedList"><span class="koboSpan" id="kobo.2072.1">c</span></li>
    </ol>
    <h1 id="_idParaDest-445" class="heading 1"><span class="koboSpan" id="kobo.2073.1">Join our community on Discord!</span></h1>
    <p class="normal"><span class="koboSpan" id="kobo.2074.1">Read this book alongside other users, Linux experts, and the author himself. </span></p>
    <p class="normal"><span class="koboSpan" id="kobo.2075.1">Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more. </span><span class="koboSpan" id="kobo.2075.2">Scan the QR code or visit the link to join the community.</span></p>
    <p class="normal"><a href="https://packt.link/SecNet"><span class="url"><span class="koboSpan" id="kobo.2076.1">https://packt.link/SecNet</span></span></a></p>
    <p class="normal"><span class="koboSpan" id="kobo.2077.1"><img src="../Images/QR_Code10596186092701843.png" alt=""/></span></p>
  </div>
</body></html>