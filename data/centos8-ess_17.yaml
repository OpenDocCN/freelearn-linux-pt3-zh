- en: 19\. An Overview of Virtualization Techniques
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
  zh: 19. 虚拟化技术概述
- en: Virtualization is generically defined as the ability to run multiple operating
    systems simultaneously on a single computer system. While not necessarily a new
    concept, Virtualization has come to prominence in recent years because it provides
    a way to fully utilize the CPU and resource capacity of a server system while
    providing stability (in that if one virtualized guest system crashes, the host
    and any other guest systems continue to run).
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟化通常定义为在单个计算机系统上同时运行多个操作系统的能力。虽然这并不一定是一个新概念，但由于它能够充分利用服务器系统的CPU和资源容量，同时提供稳定性（即，如果某个虚拟化的客户系统崩溃，主机和任何其他客户系统仍然继续运行），虚拟化在近年来得到了广泛关注。
- en: Virtualization is also useful in terms of trying out different operating systems
    without having to configure dual boot environments. For example, you can run Windows
    in a virtual machine without having to re-partition the disk, shut down CentOS
    8 and then boot from Windows. You simply start up a virtualized version of Windows
    as a guest operating system. Similarly, virtualization allows you to run other
    Linux distributions from within a CentOS 8 system, providing concurrent access
    to both operating systems.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟化在尝试不同操作系统时也非常有用，无需配置双重启动环境。例如，你可以在虚拟机中运行Windows，而无需重新分区磁盘、关闭CentOS 8并从Windows启动。你只需启动一个虚拟化版本的Windows作为客户操作系统。类似地，虚拟化允许你在CentOS
    8系统中运行其他Linux发行版，从而实现两个操作系统的并行访问。
- en: When deciding on the best approach to implementing virtualization it is important
    to have a clear understanding of the different virtualization solutions that are
    currently available. The purpose of this chapter, therefore, is to describe in
    general terms the virtualization techniques in common use today.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在决定实施虚拟化的最佳方法时，清楚了解当前可用的不同虚拟化解决方案是非常重要的。因此，本章的目的是概述今天常用的虚拟化技术。
- en: 19.1 Guest Operating System Virtualization
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 19.1 客户操作系统虚拟化
- en: Guest OS virtualization, also referred to as application-based virtualization,
    is perhaps the easiest concept to understand. In this scenario the physical host
    computer system runs a standard unmodified operating system such as Windows, Linux,
    UNIX or macOS. Running on this operating system is a virtualization application
    which executes in much the same way as any other application such as a word processor
    or spreadsheet would run on the system. It is within this virtualization application
    that one or more virtual machines are created to run the guest operating systems
    on the host computer.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 客户操作系统虚拟化，也称为基于应用程序的虚拟化，可能是最容易理解的概念。在这种情况下，物理主机计算机系统运行标准的未修改操作系统，如Windows、Linux、UNIX或macOS。在这个操作系统上运行的是一个虚拟化应用程序，它的运行方式与任何其他应用程序（如文字处理器或电子表格）类似。正是在这个虚拟化应用程序中创建一个或多个虚拟机，以便在主机计算机上运行客户操作系统。
- en: The virtualization application is responsible for starting, stopping and managing
    each virtual machine and essentially controlling access to physical hardware resources
    on behalf of the individual virtual machines. The virtualization application also
    engages in a process known as binary rewriting which involves scanning the instruction
    stream of the executing guest system and replacing any privileged instructions
    with safe emulations. This has the effect of making the guest system think it
    is running directly on the system hardware, rather than in a virtual machine within
    an application.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟化应用程序负责启动、停止和管理每个虚拟机，实质上代表各个虚拟机控制对物理硬件资源的访问。虚拟化应用程序还参与一种被称为二进制重写的过程，这个过程包括扫描执行中的客户操作系统的指令流，并将任何特权指令替换为安全的仿真指令。这样做的效果是使客户操作系统认为它是直接在系统硬件上运行，而不是在应用程序中的虚拟机内运行。
- en: 'The following figure provides an illustration of guest OS based virtualization:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图示例展示了基于客户操作系统的虚拟化：
- en: '![](img/guest_os_virtualization.png)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![](img/guest_os_virtualization.png)'
- en: Figure 19-1
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 图 19-1
- en: As outlined in the above diagram, the guest operating systems operate in virtual
    machines within the virtualization application which, in turn, runs on top of
    the host operating system in the same way as any other application. Clearly, the
    multiple layers of abstraction between the guest operating systems and the underlying
    host hardware are not conducive to high levels of virtual machine performance.
    This technique does, however, have the advantage that no changes are necessary
    to either host or guest operating systems and no special CPU hardware virtualization
    support is required.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 如上图所示，来宾操作系统在虚拟化应用程序中的虚拟机内运行，而虚拟化应用程序则像其他应用程序一样运行在宿主操作系统之上。显然，来宾操作系统与底层宿主硬件之间的多层抽象不利于虚拟机的高性能。然而，这种技术的优点是，宿主操作系统和来宾操作系统都无需进行任何更改，并且不需要特殊的CPU硬件虚拟化支持。
- en: 19.2 Hypervisor Virtualization
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 19.2 虚拟机监控程序虚拟化
- en: In hypervisor virtualization, the task of a hypervisor is to handle resource
    and memory allocation for the virtual machines in addition to providing interfaces
    for higher level administration and monitoring tools. Hypervisor based solutions
    are categorized as being either Type-1 or Type-2\.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在虚拟机监控程序虚拟化中，虚拟机监控程序的任务除了处理虚拟机的资源和内存分配外，还提供更高层次的管理和监控工具接口。基于虚拟机监控程序的解决方案分为类型1和类型2两种\。
- en: 'Type-2 hypervisors (sometimes referred to as hosted hypervisors) are installed
    as software applications that run on top of the host operating system, providing
    virtualization capabilities by coordinating access to resources such as the CPU,
    memory and network for guest virtual machines. [Figure 19-2](../Text/Virtualization_Overview.xhtml#_idTextAnchor251)
    illustrates the typical architecture of a system using Type-2 hypervisor virtualization:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 类型2虚拟机监控程序（有时称为托管虚拟机监控程序）作为软件应用程序安装在宿主操作系统之上，通过协调对资源（如CPU、内存和网络）的访问，为来宾虚拟机提供虚拟化功能。[图
    19-2](../Text/Virtualization_Overview.xhtml#_idTextAnchor251)展示了使用类型2虚拟机监控程序虚拟化的系统的典型架构：
- en: '![](img/type-2_hypervisor_virtualization.png)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
  zh: '![](img/type-2_hypervisor_virtualization.png)'
- en: Figure 19-2
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 图 19-2
- en: To understand how Type-1 hypervisors work, it helps to understand a little about
    Intel x86 processor architecture. The x86 family of CPUs provides a range of protection
    levels known as rings in which code can execute. Ring 0 has the highest level
    privilege and it is in this ring that the operating system kernel normally runs.
    Code executing in ring 0 is said to be running in system space, kernel mode or
    supervisor mode. All other code such as applications running on the operating
    system operate in less privileged rings, typically ring 3.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 要理解类型1虚拟机监控程序的工作原理，首先需要了解一些关于Intel x86处理器架构的知识。x86系列CPU提供了一系列保护级别，称为环（rings），代码可以在其中执行。环0具有最高的特权级，操作系统内核通常在该环中运行。在环0中执行的代码被称为在系统空间、内核模式或监控模式下运行。所有其他代码，如在操作系统上运行的应用程序，通常在较低特权的环中运行，通常是环3。
- en: 'In contrast to Type-2 hypervisors, Type-1 hypervisors (also referred to as
    metal or native hypervisors) run directly on the hardware of the host system in
    ring 0\. Clearly, with the hypervisor occupying ring 0 of the CPU, the kernels
    for any guest operating systems running on the system must run in less privileged
    CPU rings. Unfortunately, most operating system kernels are written explicitly
    to run in ring 0 for the simple reason that they need to perform tasks that are
    only available in that ring, such as the ability to execute privileged CPU instructions
    and directly manipulate memory. A number of different solutions to this problem
    have been devised in recent years, each of which is described below:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 与类型2虚拟机监控程序（hypervisor）相比，类型1虚拟机监控程序（也称为金属虚拟机监控程序或原生虚拟机监控程序）直接运行在宿主系统的硬件上，并且在环0中运行。显然，由于虚拟机监控程序占用了CPU的环0，任何在该系统上运行的来宾操作系统的内核必须在更低权限的CPU环中运行。不幸的是，大多数操作系统内核都是显式编写为在环0中运行，原因很简单：它们需要执行仅在该环中可用的任务，例如执行特权CPU指令和直接操作内存的能力。近年来，针对这个问题已经设计了许多不同的解决方案，下面将逐一介绍：
- en: 19.2.1 Paravirtualization
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 19.2.1 半虚拟化
- en: Under paravirtualization, the kernel of the guest operating system is modified
    specifically to run on the hypervisor. This typically involves replacing any privileged
    operations that will only run in ring 0 of the CPU with calls to the hypervisor
    (known as hypercalls). The hypervisor, in turn, performs the task on behalf of
    the guest kernel. This typically limits support to open source operating systems
    such as Linux which may be freely altered and proprietary operating systems where
    the owners have agreed to make the necessary code modifications to target a specific
    hypervisor. These issues notwithstanding, the ability of the guest kernel to communicate
    directly with the hypervisor results in greater performance levels compared to
    other virtualization approaches.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在半虚拟化下，来宾操作系统的内核被专门修改以便在虚拟机监控器上运行。这通常涉及将只能在 CPU 的环 0 中运行的特权操作替换为对虚拟机监控器的调用（称为超级调用）。虚拟机监控器则代表来宾内核执行该任务。通常，这种方式将支持限制为可以自由修改的开源操作系统，如
    Linux，以及那些所有者同意对其进行必要代码修改以支持特定虚拟机监控器的专有操作系统。尽管存在这些问题，来宾内核能够直接与虚拟机监控器通信，这使得性能相比其他虚拟化方法更为优越。
- en: 19.2.2 Full Virtualization
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 19.2.2 完全虚拟化
- en: Full virtualization provides support for unmodified guest operating systems.
    The term unmodified refers to operating system kernels which have not been altered
    to run on a hypervisor and therefore still execute privileged operations as though
    running in ring 0 of the CPU. In this scenario, the hypervisor provides CPU emulation
    to handle and modify privileged and protected CPU operations made by unmodified
    guest operating system kernels. Unfortunately this emulation process requires
    both time and system resources to operate resulting in inferior performance levels
    when compared to those provided by paravirtualization.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 完全虚拟化支持未修改的来宾操作系统。未修改是指操作系统内核没有被修改以便在虚拟机监控器上运行，因此仍然执行特权操作，就像在 CPU 的环 0 中运行一样。在这种情况下，虚拟机监控器提供
    CPU 仿真来处理和修改未修改的来宾操作系统内核所发出的特权和保护 CPU 操作。不幸的是，这一仿真过程需要时间和系统资源，因此与半虚拟化相比，性能较差。
- en: 19.2.3 Hardware Virtualization
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 19.2.3 硬件虚拟化
- en: Hardware virtualization leverages virtualization features built into the latest
    generations of CPUs from both Intel and AMD. These technologies, known as Intel
    VT and AMD-V respectively, provide extensions necessary to run unmodified guest
    virtual machines without the overheads inherent in full virtualization CPU emulation.
    In very simplistic terms these new processors provide an additional privilege
    mode (referred to as ring -1) above ring 0 in which the hypervisor can operate,
    thereby leaving ring 0 available for unmodified guest operating systems.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 硬件虚拟化利用了英特尔和 AMD 最新一代 CPU 中内置的虚拟化功能。这些技术，分别称为 Intel VT 和 AMD-V，提供了必要的扩展，使得在没有完全虚拟化
    CPU 仿真开销的情况下能够运行未修改的来宾虚拟机。简单来说，这些新处理器提供了一个比环 0 更高的特权模式（称为环 -1），虚拟机监控器可以在其中运行，从而将环
    0 留给未修改的来宾操作系统。
- en: 'The following figure illustrates the Type-1 hypervisor approach to virtualization:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 下图展示了 Type-1 虚拟机监控器的虚拟化方法：
- en: '![](img/type-1_hypervisor_virtualization.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![](img/type-1_hypervisor_virtualization.png)'
- en: Figure 19-3
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 图 19-3
- en: As outlined in the above illustration, in addition to the virtual machines,
    an administrative operating system and/or management console also runs on top
    of the hypervisor allowing the virtual machines to be managed by a system administrator.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 如上图所示，除了虚拟机外，还运行着一个管理操作系统和/或管理控制台，这些都在虚拟机监控器上运行，从而允许系统管理员对虚拟机进行管理。
- en: 19.3 Virtual Machine Networking
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 19.3 虚拟机网络
- en: Virtual machines will invariably need to be connected to a network to be of
    any practical use. One option is for the guest to be connected to a virtual network
    running within the operating system of the host computer. In this configuration
    any virtual machines on the virtual network can see each other but access to the
    external network is provided by Network Address Translation (NAT). When using
    the virtual network and NAT, each virtual machine is represented on the external
    network (the network to which the host is connected) using the IP address of the
    host system. This is the default behavior for KVM virtualization on CentOS 8 and
    generally requires no additional configuration. Typically, a single virtual network
    is created by default, represented by the name default and the device virbr0.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟机通常需要连接到网络才能发挥实际作用。一种选择是将客户机连接到运行在宿主机操作系统中的虚拟网络。在这种配置下，虚拟网络上的任何虚拟机都可以相互访问，但外部网络的访问是通过网络地址转换（NAT）提供的。在使用虚拟网络和NAT时，每个虚拟机在外部网络（宿主机所连接的网络）上都会通过宿主机的IP地址进行表示。这是CentOS
    8上KVM虚拟化的默认行为，通常无需额外配置。通常，默认会创建一个虚拟网络，名称为default，设备为virbr0。
- en: In order for guests to appear as individual and independent systems on the external
    network (i.e. with their own IP addresses), they must be configured to share a
    physical network interface on the host. The quickest way to achieve this is to
    configure the virtual machine to use the “direct connection” network configuration
    option (also referred to as the MacVTap) which will provide the guest system with
    an IP address on the same network as the host. Unfortunately, while this gives
    the virtual machine access to other systems on the network, it is not possible
    to establish a connection between the guest and the host when using the MacVTap
    driver.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使客户机在外部网络上作为独立的系统出现（即拥有自己的IP地址），它们必须配置为共享宿主机上的物理网络接口。实现这一目标的最快方法是将虚拟机配置为使用“直接连接”网络配置选项（也称为MacVTap），这样将为客户系统分配与宿主机相同网络中的IP地址。不幸的是，虽然这可以使虚拟机访问网络上的其他系统，但在使用MacVTap驱动时，无法建立客户机与宿主机之间的连接。
- en: A better option is to configure a network bridge interface on the host system
    to which the guests can connect. This provides the guest with an IP address on
    the external network while also allowing the guest and host to communicate, a
    topic which is covered in the chapter entitled [“Creating a CentOS 8 KVM Networked
    Bridge Interface”](../Text/KVM_Network_Bridge.xhtml#_idTextAnchor285).
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 更好的选择是配置一个网络桥接接口，在宿主系统上供客户机连接。这为客户机提供外部网络上的IP地址，同时也允许客户机与宿主机进行通信，相关内容将在章节[“创建CentOS
    8 KVM网络桥接接口”](../Text/KVM_Network_Bridge.xhtml#_idTextAnchor285)中进行讲解。
- en: 19.4 Summary
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 19.4 总结
- en: Virtualization is defined as the ability to run multiple guest operating systems
    within a single host operating system. A number of approaches to virtualization
    have been developed including guest operating system and hypervisor virtualization.
    Hypervisor virtualization falls into two categories known as Type-1 and Type-2\.
    Type-2 virtualization solutions are categorized as para-virtualization, full virtualization
    and hardware virtualization, the latter making use of special virtualization features
    of some Intel and AMD processor models.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟化被定义为在单一宿主操作系统内运行多个客户操作系统的能力。已经开发出多种虚拟化方法，包括客户操作系统虚拟化和虚拟机管理程序（Hypervisor）虚拟化。虚拟机管理程序虚拟化分为两类：Type-1和Type-2。Type-2虚拟化解决方案包括准虚拟化、完全虚拟化和硬件虚拟化，后者利用了一些Intel和AMD处理器型号的特殊虚拟化特性。
- en: Virtual machine guest operating systems have a number of options in terms of
    networking including NAT, direct connection (MacVTap) and network bridge configurations.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟机客户操作系统在网络配置方面有多个选项，包括 NAT、直接连接（MacVTap）和网络桥接配置。
